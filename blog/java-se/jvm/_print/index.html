<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.83.1"><link rel=canonical type=text/html href=/blog/java-se/jvm/><link rel=alternate type=application/rss+xml href=/blog/java-se/jvm/index.xml><meta name=ROBOTS content="INDEX, FOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>JVM | 蚂蚁背大象</title><meta property="og:title" content="JVM"><meta property="og:description" content="蚂蚁背大象博客"><meta property="og:type" content="website"><meta property="og:url" content="/blog/java-se/jvm/"><meta property="og:site_name" content="蚂蚁背大象"><meta itemprop=name content="JVM"><meta itemprop=description content="蚂蚁背大象博客"><meta name=twitter:card content="summary"><meta name=twitter:title content="JVM"><meta name=twitter:description content="蚂蚁背大象博客"><link rel=preload href=/scss/main.min.e09cb23c7dff3bf1285aa0294bcdc4ac8194fb3425a99c621e31e7b871315685.css as=style><link href=/scss/main.min.e09cb23c7dff3bf1285aa0294bcdc4ac8194fb3425a99c621e31e7b871315685.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css></head><body class="td-section td-blog"><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 321.39 78.54"><title id="title19">DUBBO LOGO</title><path class="cls-1" d="M68.46 50.38c0 14.06 11.39 22.11 25.45 22.11s25.45-8.05 25.45-22.11V7.25H68.46zm21.24-28h8.6V31H89.7zm0 22.25h8.6v8.6H89.7zM33.24 7.25H4.06v64H33.24c10.95.0 19.3-7.18 23.29-17.15a45.12 45.12.0 002.38-14.87A45.12 45.12.0 0056.53 24.4C52.84 14.62 44.19 7.25 33.24 7.25zm.43 14.63H30.34a3.44 3.44.0 00-3.44 3.44V53.23a3.44 3.44.0 003.44 3.44h3.33v4.63h-8.3a6.87 6.87.0 01-6.87-6.87V24.12a6.87 6.87.0 016.87-6.87h8.3zM285.51 6.06c-17.05.0-30.88 10.28-30.88 33.21s13.83 33.21 30.88 33.21 30.88-10.28 30.88-33.21S302.56 6.06 285.51 6.06zm7.59 48.36a6.87 6.87.0 01-6.87 6.87h-8.3V56.67h3.33a3.44 3.44.0 003.44-3.44V25.31a3.44 3.44.0 00-3.44-3.44h-3.33V17.25h8.3a6.87 6.87.0 016.87 6.87zm-53.4-17.56A17.39 17.39.0 00227.31 7.25H195.1v64h32.21a19.44 19.44.0 0012.38-34.44zM211.63 61.29h-6.08l18.68-44h6.08zM177 36.85A17.39 17.39.0 00164.65 7.25H132.43v64h32.21A19.44 19.44.0 00177 36.85zM149 61.29h-6.08l18.68-44h6.08z" style="fill:#fff;fill-opacity:1"/></svg></span><span class="text-uppercase font-weight-bold">蚂蚁背大象</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/about/><span>Home</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/blog/><span class=active>Java</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/spring/><span>Spring</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/middlewares/><span>Middleware</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/><span>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/other/><span>Others</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community/><span>Community</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002 站内搜索…" aria-label=站内搜索… autocomplete=off></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/blog/java-se/jvm/>Return to the regular view of this page</a>.</p></div><h1 class=title>JVM</h1><ul><li><a href=#pg-5403800fd8c918305a83ec0b4b5167fa>一个Java对象占用多大内存</a></li><li><a href=#pg-4c1264369eedd6914b7fdb12381831cc>Linux下Java开发者必须知道的那些Java命令</a></li><li><a href=#pg-cb18f003d6859689eb753e7771bf507f>深入理解Java对象头Mark Word</a></li><li><a href=#pg-7f0cbabc2a77ca6361b159ad79384cf5>类加载器和双亲委派模型</a></li><li><a href=#pg-9025dfd573d9433c3e79d78a3af06901>Java中的引用</a></li><li><a href=#pg-a0c18569317eab7b1bbd8cc1fb6047c0>JVM垃圾收集器</a></li><li><a href=#pg-307e78a13440aea85a53342138104377>类的加载</a></li><li><a href=#pg-b0fc15264e85102271d7c36b7d538658>JVM的内存模型</a></li><li><a href=#pg-6d17d91bf7dff2fe0b0cfcf7f21b42c5>JVM常用的命令</a></li><li><a href=#pg-3762f7c58e742ae639a434348a7a083f>Java GC日志图解</a></li><li><a href=#pg-0f2e1c3513283b37e05912623fa733a1>JVM参数</a></li></ul><div class=content></div></div><div class=td-content><h1 id=pg-5403800fd8c918305a83ec0b4b5167fa>一个Java对象占用多大内存</h1><div class="td-byline mb-4"><time datetime=2022-06-02 class=text-muted>2022-06-02</time></div><p>平时开发中很少会有人去想：一个Java对象占用多大内存，今天就来探究一下到底我们平时创建的对象占用了多大的内存。在Java中对象分为两种：基本类型、引用类型。我们从这两种类型入手来分析。</p><blockquote><p>Tips: JDK版本为17</p></blockquote><h3 id=1-基本类型>1. 基本类型</h3><p>Java中有8种基本类型，占用的内存空间如下：</p><table><thead><tr><th>类型</th><th>占用空间(byte)</th></tr></thead><tbody><tr><td>boolean</td><td>1</td></tr><tr><td>byte</td><td>1</td></tr><tr><td>short</td><td>2</td></tr><tr><td>char</td><td>2</td></tr><tr><td>int</td><td>4</td></tr><tr><td>float</td><td>4</td></tr><tr><td>long</td><td>8</td></tr><tr><td>double</td><td>8</td></tr></tbody></table><p><strong>Java中的基本类型数据是在栈上面分配还是栈上面?</strong></p><p>回答上面一个问题之前首先要明确这个变量定义在哪？平时定义基本变量有三种情况：</p><ol><li>定义类的静态变量</li><li>定义类的成员变量</li><li>定义方法体内变量</li></ol><p>上面三种情况分配在不同的位置：</p><table><thead><tr><th>变量位置</th><th>分配位置</th></tr></thead><tbody><tr><td>定义类的静态变量</td><td>堆上分配</td></tr><tr><td>定义类的成员变量</td><td>堆上分配</td></tr><tr><td>定义方法体内变量</td><td>栈上分配</td></tr></tbody></table><blockquote><p>Tips: jdk17 字符串常量池和静态变量仍然在堆当中；运行时常量池、类型信息、常量、字段、方法被移动都了元空间中</p></blockquote><h3 id=2-引用类型>2. 引用类型</h3><p>下面来分析一下引用类型对象的大小。</p><h4 id=21-java对象模型>2.1 Java对象模型</h4><p>Java对象模型分为三个部分：<strong>对象头、对象实际数据、对齐填充区</strong></p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/blog/javase/jvmJava-object-model.png alt=Java-object-model></p><p>对象头中又包含了很多，这个后续文章分析。</p><p><strong>对象头又包含了三部分：MarkWord、对象元数据指针、数组对象长度：</strong></p><ol><li>MarkWord：用于存储对象运行时的数据，好比 HashCode、锁状态标志、GC分代年龄等。<strong>这部分在 64 位操作系统下占 8 字节，32 位操作系统下占 4 字节。</strong></li><li>对象元数据指针：对象指向它的类元数据的指针，虚拟机通过这个指针来确定这个对象是哪一个类的实例。这部分就涉及到指针压缩的概念，<strong>在开启指针压缩的状况下占 4 字节，未开启状况下占 8 字节。</strong></li><li>数组长度：这部分只有是数组对象才有，<strong>若是是非数组对象就没这部分。这部分占 4 字节。所以Java中对象的最大值就是int类型的最大值</strong></li></ol><p>对象实际数据就是存储对象各个字段中的信息</p><p>对齐填充：Java 对象的大小默认是按照 8 字节对齐，也就是说 Java 对象的大小必须是 8 字节的倍数。若是算到最后不够 8 字节的话，那么就会进行对齐填充。</p><h3 id=3-对象大小查看神器>3. 对象大小查看神器</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;dependency&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;groupId&gt;</span>org.openjdk.jol<span style=color:#204a87;font-weight:700>&lt;/groupId&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;artifactId&gt;</span>jol-core<span style=color:#204a87;font-weight:700>&lt;/artifactId&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;version&gt;</span>0.9<span style=color:#204a87;font-weight:700>&lt;/version&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/dependency&gt;</span>
</code></pre></div><p>jol工具是查看对象大小的神器</p><h4 id=31-指针压缩开启-对象只包含基础数据类型>3.1 指针压缩开启-对象只包含基础数据类型</h4><p>对象类：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ObjectBase</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>//这个对象大小应该是: 8+4+4+8+1+7=32
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>测试验证代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Test1</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>ClassLayout</span> <span style=color:#000>layout</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ClassLayout</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ObjectBase</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>layout</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toPrintable</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>测试结果：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/blog/javase/jvmimage-20220603141125996.png alt=image-20220603141125996></p><p>结果和上面的预测一样，有7byte的填充。</p><h4 id=32-指针压缩开启-对象包含基础数据和引用对象>3.2 指针压缩开启-对象包含基础数据和引用对象</h4><p>对象类：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ObjectBase</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>//这个对象大小应该是: 8+4+4+8+1+4+3=32
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>RefObject</span> <span style=color:#000>refObject</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>RefObject</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>short</span> <span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div><p>测试验证代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Test1</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>ClassLayout</span> <span style=color:#000>layout</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ClassLayout</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ObjectBase</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>layout</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toPrintable</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>测试结果：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/blog/javase/jvmimage-20220603141956973.png alt=image-20220603141956973></p><h4 id=33-指针压缩开启-数组对象>3.3 指针压缩开启-数组对象</h4><p>测试代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Test1</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//ClassLayout layout = ClassLayout.parseClass(ObjectBase.class);
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>ClassLayout</span> <span style=color:#000>layout</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ClassLayout</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ObjectBase</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>]);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>layout</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toPrintable</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>测试结果：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/blog/javase/jvmimage-20220603143249267.png alt=image-20220603143249267></p><h4 id=34-指针压缩关闭>3.4 指针压缩关闭</h4><p>以3.1的代码作为测试代码，增加 <strong><code>-XX:-UseCompressedOops</code></strong> 参数，测试结果为：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/blog/javase/jvmimage-20220603155554452.png alt=image-20220603155554452></p><p>JDK17的情况下竟然没效果。看一下JDK11</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/blog/javase/jvmimage-20220603155652365.png alt=image-20220603155652365></p><p>jdk11和预想的一样。</p><h3 id=4-总结>4. 总结</h3><p>ava对象大小主要由三部分注册：对象头、对象实际数据、填充对齐字段大小三部分组成。而对象头的大小相对固定，在开启了指针压缩的情况下对象头的大小最小12，最大16字节，然后实际数据大小取决于Java对象的成员变量多少。最好就是需要多少的对齐字节。默认的情况下Java对象大小都是8的整数倍。</p><blockquote><p>我是蚂蚁背大象，文章对你有帮助点赞关注我，文章有不正确的地方请您斧正留言评论~谢谢！</p></blockquote><p>参考文档：</p><ul><li><a href=https://docs.oracle.com/en/java/javase/17/docs/specs/man/java.html>https://docs.oracle.com/en/java/javase/17/docs/specs/man/java.html</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-4c1264369eedd6914b7fdb12381831cc>Linux下Java开发者必须知道的那些Java命令</h1><div class="td-byline mb-4"><time datetime=2022-01-27 class=text-muted>2022-01-27</time></div><p>Linux环境下和Window环境或者说有可视化界面环境最大的缺点是所有的数据呈现都要靠命令来实现没有图形界面工具，今天来结合实际生产过程中的场景来聊一聊Linux下Java开发者必须知道的那些命令。</p><h3 id=1-环境准备>1. 环境准备</h3><ul><li>运行环境：Ubuntu 20.04.3 LTS (运行在windows上面的子系统)</li><li>JDK版本： openjdk version &ldquo;11.0.13&rdquo; 2021-10-19</li><li>Spring Boot版本：2.6.3</li></ul><p>在 <a href=https://start.spring.io/>Spring初始化官网</a> 生成一个SpringBoot项目然后打包成jar包再上述环境中运行启动起来</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/java/jvm/%E5%88%9B%E5%BB%BAspring%E8%BF%90%E8%A1%8Cjar%E5%8C%85.gif alt=创建spring运行jar包></p><p>这样就已经运行起来了，环境已经准备好了。</p><h3 id=2-获取运行jar包的pid>2. 获取运行Jar包的PID</h3><p><strong>场景</strong>：在已经运行的项目，PID。</p><p><strong>命令</strong>：<strong><code>ps -ef 或者 jps</code></strong></p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/java/jvm/image-20220127152430825.png alt=image-20220127152430825></p><p>通过Linux的ps命令或者java的jps命令获取。</p><h3 id=3-获取启动项目配置的参数>3. 获取启动项目配置的参数</h3><p><strong>场景</strong>：在已经运行的项目，我们想知道配置的参数有哪些。</p><p><strong>命令</strong>：<strong><code>jinfo -flags &lt;pid></code></strong></p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/java/jvm/image-20220127152739983.png alt=image-20220127152739983></p><blockquote><p>Tips: <strong>jinfo</strong> 还有其他的用法</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>Usage:
    jinfo &lt;option&gt; &lt;pid&gt;
       <span style=color:#ce5c00;font-weight:700>(</span>to connect to a running process<span style=color:#ce5c00;font-weight:700>)</span>

where &lt;option&gt; is one of:
    -flag &lt;name&gt;         to print the value of the named VM flag
    -flag <span style=color:#ce5c00;font-weight:700>[</span>+<span style=color:#000;font-weight:700>|</span>-<span style=color:#ce5c00;font-weight:700>]</span>&lt;name&gt;    to <span style=color:#204a87>enable</span> or disable the named VM flag
    -flag &lt;name&gt;<span style=color:#ce5c00;font-weight:700>=</span>&lt;value&gt; to <span style=color:#204a87>set</span> the named VM flag to the given value
    -flags               to print VM flags
    -sysprops            to print Java system properties
    &lt;no option&gt;          to print both VM flags and system properties
    -? <span style=color:#000;font-weight:700>|</span> -h <span style=color:#000;font-weight:700>|</span> --help <span style=color:#000;font-weight:700>|</span> -help to print this <span style=color:#204a87>help</span> message
</code></pre></div><ul><li>查看某个或者设置某个参数的值</li></ul></blockquote><h3 id=4-查看项目堆的使用情况>4. 查看项目堆的使用情况</h3><p><strong>场景</strong>：运行过程中，有时候需要查看项目堆内存的使用情况</p><p><strong>命令</strong>：<strong><code>jhsdb jmap --heap --pid &lt;pid></code></strong></p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/java/jvm/image-20220127162154475.png alt=image-20220127162154475></p><h3 id=5-查看线程状态>5. 查看线程状态</h3><p><strong>场景</strong>：在运行过程中有时候会需要参看某一个线程的状态</p><p><strong>命令</strong>：<strong><code>jstack -l &lt;pid></code></strong></p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/java/jvm/image-20220127164738845.png alt=image-20220127164738845></p><h3 id=6-查看某一个线程cpu的使用率>6. 查看某一个线程CPU的使用率</h3><p><strong>场景</strong>：在排查问题的时候会出现CPU的使用率很高的情况，这个时候回我们想要知道是哪个Java线程占用了CPU.</p><p><strong>命令</strong>：<strong><code>1. jstack -l &lt;pid></code></strong></p><p>​ <strong><code>2. top -H -p &lt;pid></code></strong></p><p>首先根据命令里获取Java所有线程的信息，然后选择你需要的线程例如下图：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/java/jvm/image-20220127165614424.png alt=image-20220127165614424></p><p>我选择了mxsm_0这个线程，那么我们怎么使用第二个命令。看一下上图标号为2的数据，<strong><code>nid=0xa43</code></strong> 将其转换成十进制就是 <strong><code>2627</code></strong></p><p>然后使用命令 top -H -p 2627：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/java/jvm/image-20220127170026843.png alt=image-20220127170026843></p><p>标记处的数据和上面的计算出来的是一样的。</p><blockquote><p>Tips: 查看线程CPU使用率的需要结合Linux命令使用，虽然使用频率比较少但是对于排除线程使用率来说真的好用。</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-cb18f003d6859689eb753e7771bf507f>深入理解Java对象头Mark Word</h1><div class="td-byline mb-4"><time datetime=2020-05-07 class=text-muted>2020-05-07</time></div><blockquote><p>下面是基于JDK13 64位</p></blockquote><p>网上对于Java对象头Mark Word有很多的资料，但是大多数都是32系统的，jdk7甚至1.6的版本。通过对网上资料的查找根据自己的一些代码下面来深入理解一下Java对象头Mark Word的组成。</p><h3 id=1-对象头的参看神器>1 对象头的参看神器</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;dependency&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;groupId&gt;</span>org.openjdk.jol<span style=color:#204a87;font-weight:700>&lt;/groupId&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;artifactId&gt;</span>jol-core<span style=color:#204a87;font-weight:700>&lt;/artifactId&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;version&gt;</span>0.14<span style=color:#204a87;font-weight:700>&lt;/version&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/dependency&gt;</span>
</code></pre></div><p>通过使用对象头查看神器来小试牛刀一下代码如下：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>com.github.mxsm</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.openjdk.jol.info.ClassLayout</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>HeaderView</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>HeaderView</span> <span style=color:#000>headerView</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HeaderView</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassLayout</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>headerView</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>toPrintable</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div><p>通过运行的结果如下：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>com.github.mxsm.HeaderView object internals:
 OFFSET  SIZE   TYPE DESCRIPTION                               VALUE
      <span style=color:#0000cf;font-weight:700>0</span>     <span style=color:#0000cf;font-weight:700>4</span>        <span style=color:#ce5c00;font-weight:700>(</span>object header<span style=color:#ce5c00;font-weight:700>)</span>                           <span style=color:#0000cf;font-weight:700>01</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>00000001</span> <span style=color:#0000cf;font-weight:700>00000000</span> <span style=color:#0000cf;font-weight:700>00000000</span> 00000000<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span>1<span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#0000cf;font-weight:700>4</span>     <span style=color:#0000cf;font-weight:700>4</span>        <span style=color:#ce5c00;font-weight:700>(</span>object header<span style=color:#ce5c00;font-weight:700>)</span>                           <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>00000000</span> <span style=color:#0000cf;font-weight:700>00000000</span> <span style=color:#0000cf;font-weight:700>00000000</span> 00000000<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span>0<span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#0000cf;font-weight:700>8</span>     <span style=color:#0000cf;font-weight:700>4</span>        <span style=color:#ce5c00;font-weight:700>(</span>object header<span style=color:#ce5c00;font-weight:700>)</span>                           <span style=color:#0000cf;font-weight:700>54</span> c3 <span style=color:#0000cf;font-weight:700>00</span> f8 <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>01010100</span> <span style=color:#0000cf;font-weight:700>11000011</span> <span style=color:#0000cf;font-weight:700>00000000</span> 11111000<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span>-134167724<span style=color:#ce5c00;font-weight:700>)</span>
     <span style=color:#0000cf;font-weight:700>12</span>     <span style=color:#0000cf;font-weight:700>4</span>        <span style=color:#ce5c00;font-weight:700>(</span>loss due to the next object alignment<span style=color:#ce5c00;font-weight:700>)</span>
Instance size: <span style=color:#0000cf;font-weight:700>16</span> bytes
Space losses: <span style=color:#0000cf;font-weight:700>0</span> bytes internal + <span style=color:#0000cf;font-weight:700>4</span> bytes <span style=color:#000>external</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>4</span> bytes total
</code></pre></div><p>通过发现在正常不设置任何参数的情况下，对象头的长度为12个字节。</p><p>增加一个JVM参数（取消对象指针压缩，默认情况下JDK是开启的）：</p><pre><code>-XX:-UseCompressedOops
</code></pre><p>运行的结果：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>com.github.mxsm.HeaderView object internals:
 OFFSET  SIZE   TYPE DESCRIPTION                               VALUE
      <span style=color:#0000cf;font-weight:700>0</span>     <span style=color:#0000cf;font-weight:700>4</span>        <span style=color:#ce5c00;font-weight:700>(</span>object header<span style=color:#ce5c00;font-weight:700>)</span>                           <span style=color:#0000cf;font-weight:700>01</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>00000001</span> <span style=color:#0000cf;font-weight:700>00000000</span> <span style=color:#0000cf;font-weight:700>00000000</span> 00000000<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span>1<span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#0000cf;font-weight:700>4</span>     <span style=color:#0000cf;font-weight:700>4</span>        <span style=color:#ce5c00;font-weight:700>(</span>object header<span style=color:#ce5c00;font-weight:700>)</span>                           <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>00000000</span> <span style=color:#0000cf;font-weight:700>00000000</span> <span style=color:#0000cf;font-weight:700>00000000</span> 00000000<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span>0<span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#0000cf;font-weight:700>8</span>     <span style=color:#0000cf;font-weight:700>4</span>        <span style=color:#ce5c00;font-weight:700>(</span>object header<span style=color:#ce5c00;font-weight:700>)</span>                           <span style=color:#0000cf;font-weight:700>08</span> <span style=color:#0000cf;font-weight:700>17</span> 2e 1c <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>00001000</span> <span style=color:#0000cf;font-weight:700>00010111</span> <span style=color:#0000cf;font-weight:700>00101110</span> 00011100<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span>472782600<span style=color:#ce5c00;font-weight:700>)</span>
     <span style=color:#0000cf;font-weight:700>12</span>     <span style=color:#0000cf;font-weight:700>4</span>        <span style=color:#ce5c00;font-weight:700>(</span>object header<span style=color:#ce5c00;font-weight:700>)</span>                           <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>00000000</span> <span style=color:#0000cf;font-weight:700>00000000</span> <span style=color:#0000cf;font-weight:700>00000000</span> 00000000<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span>0<span style=color:#ce5c00;font-weight:700>)</span>
Instance size: <span style=color:#0000cf;font-weight:700>16</span> bytes
Space losses: <span style=color:#0000cf;font-weight:700>0</span> bytes internal + <span style=color:#0000cf;font-weight:700>0</span> bytes <span style=color:#000>external</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span> bytes total
</code></pre></div><p>所以在不开启对象指针压缩的情况下对象头的长度为16个字节。</p><h3 id=2-对象头的组成>2 对象头的组成</h3><ul><li><h4 id=mark-word标记字段>Mark Word(标记字段)</h4></li><li><h4 id=klass-pointer类型指针>klass pointer(类型指针)</h4></li><li><h4 id=array-length数组长度>array length(数组长度)</h4></li></ul><p><strong>普通对象</strong>：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//开启了指针压缩
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>|--------------------------------------------------------------|</span>
<span style=color:#ce5c00;font-weight:700>|</span>                     <span style=color:#000>Object</span> <span style=color:#000>Header</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>96</span> <span style=color:#000>bits</span><span style=color:#ce5c00;font-weight:700>)</span>                  <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|------------------------------------|-------------------------|</span>
<span style=color:#ce5c00;font-weight:700>|</span>        <span style=color:#000>Mark</span> <span style=color:#000>Word</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>64</span> <span style=color:#000>bits</span><span style=color:#ce5c00;font-weight:700>)</span>         <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>Klass</span> <span style=color:#000>Word</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>32</span> <span style=color:#000>bits</span><span style=color:#ce5c00;font-weight:700>)</span>    <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|------------------------------------|-------------------------|</span>
 <span style=color:#8f5902;font-style:italic>//没有开启指针压缩    
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>|--------------------------------------------------------------|</span>
<span style=color:#ce5c00;font-weight:700>|</span>                     <span style=color:#000>Object</span> <span style=color:#000>Header</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>128</span> <span style=color:#000>bits</span><span style=color:#ce5c00;font-weight:700>)</span>                 <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|------------------------------------|-------------------------|</span>
<span style=color:#ce5c00;font-weight:700>|</span>        <span style=color:#000>Mark</span> <span style=color:#000>Word</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>64</span> <span style=color:#000>bits</span><span style=color:#ce5c00;font-weight:700>)</span>         <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>Klass</span> <span style=color:#000>Word</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>64</span> <span style=color:#000>bits</span><span style=color:#ce5c00;font-weight:700>)</span>    <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|------------------------------------|-------------------------|</span>    
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>HeaderView</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//-XX:+UseCompressedOops
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//-XX:-UseCompressedOops
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Header</span> <span style=color:#000>headerView</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Header</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassLayout</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>headerView</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>toPrintable</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>    
</code></pre></div><p>-XX:+UseCompressedOops 指针压缩开启运行结果</p><pre><code>com.github.mxsm.Header object internals:
 OFFSET  SIZE   TYPE DESCRIPTION                               VALUE
      0     4        (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)
      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)
      8     4        (object header)                           92 c3 00 f8 (10010010 11000011 00000000 11111000) (-134167662)
     12     4        (loss due to the next object alignment)
Instance size: 16 bytes
Space losses: 0 bytes internal + 4 bytes external = 4 bytes total
</code></pre><p>-XX:+UseCompressedOops 指针压缩关闭运行结果</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>com.github.mxsm.Header object internals:
 OFFSET  SIZE   TYPE DESCRIPTION                               VALUE
      <span style=color:#0000cf;font-weight:700>0</span>     <span style=color:#0000cf;font-weight:700>4</span>        <span style=color:#ce5c00;font-weight:700>(</span>object header<span style=color:#ce5c00;font-weight:700>)</span>                           <span style=color:#0000cf;font-weight:700>01</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>00000001</span> <span style=color:#0000cf;font-weight:700>00000000</span> <span style=color:#0000cf;font-weight:700>00000000</span> 00000000<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span>1<span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#0000cf;font-weight:700>4</span>     <span style=color:#0000cf;font-weight:700>4</span>        <span style=color:#ce5c00;font-weight:700>(</span>object header<span style=color:#ce5c00;font-weight:700>)</span>                           <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>00000000</span> <span style=color:#0000cf;font-weight:700>00000000</span> <span style=color:#0000cf;font-weight:700>00000000</span> 00000000<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span>0<span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#0000cf;font-weight:700>8</span>     <span style=color:#0000cf;font-weight:700>4</span>        <span style=color:#ce5c00;font-weight:700>(</span>object header<span style=color:#ce5c00;font-weight:700>)</span>                           d0 1b 3b 1c <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>11010000</span> <span style=color:#0000cf;font-weight:700>00011011</span> <span style=color:#0000cf;font-weight:700>00111011</span> 00011100<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span>473635792<span style=color:#ce5c00;font-weight:700>)</span>
     <span style=color:#0000cf;font-weight:700>12</span>     <span style=color:#0000cf;font-weight:700>4</span>        <span style=color:#ce5c00;font-weight:700>(</span>object header<span style=color:#ce5c00;font-weight:700>)</span>                           <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>00000000</span> <span style=color:#0000cf;font-weight:700>00000000</span> <span style=color:#0000cf;font-weight:700>00000000</span> 00000000<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span>0<span style=color:#ce5c00;font-weight:700>)</span>
Instance size: <span style=color:#0000cf;font-weight:700>16</span> bytes
Space losses: <span style=color:#0000cf;font-weight:700>0</span> bytes internal + <span style=color:#0000cf;font-weight:700>0</span> bytes <span style=color:#000>external</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span> bytes total
</code></pre></div><p><strong>数组对象</strong>：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//开启指针压缩
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>|----------------------------------------------------------------------------------|</span>
<span style=color:#ce5c00;font-weight:700>|</span>                                 <span style=color:#000>Object</span> <span style=color:#000>Header</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>128</span> <span style=color:#000>bits</span><span style=color:#ce5c00;font-weight:700>)</span>                         <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|--------------------------------|-----------------------|-------------------------|</span>
<span style=color:#ce5c00;font-weight:700>|</span>        <span style=color:#000>Mark</span> <span style=color:#000>Word</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>64bits</span><span style=color:#ce5c00;font-weight:700>)</span>       <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>Klass</span> <span style=color:#000>Word</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>32bits</span><span style=color:#ce5c00;font-weight:700>)</span>    <span style=color:#ce5c00;font-weight:700>|</span>  <span style=color:#000>array</span> <span style=color:#000>length</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>32bits</span><span style=color:#ce5c00;font-weight:700>)</span>   <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|--------------------------------|-----------------------|-------------------------|</span>

<span style=color:#8f5902;font-style:italic>//没有开启指针压缩
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>|----------------------------------------------------------------------------------|</span>
<span style=color:#ce5c00;font-weight:700>|</span>                                 <span style=color:#000>Object</span> <span style=color:#000>Header</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>160</span> <span style=color:#000>bits</span><span style=color:#ce5c00;font-weight:700>)</span>                         <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|--------------------------------|-----------------------|-------------------------|</span>
<span style=color:#ce5c00;font-weight:700>|</span>        <span style=color:#000>Mark</span> <span style=color:#000>Word</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>64bits</span><span style=color:#ce5c00;font-weight:700>)</span>       <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>Klass</span> <span style=color:#000>Word</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>64bits</span><span style=color:#ce5c00;font-weight:700>)</span>    <span style=color:#ce5c00;font-weight:700>|</span>  <span style=color:#000>array</span> <span style=color:#000>length</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>32bits</span><span style=color:#ce5c00;font-weight:700>)</span>   <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|--------------------------------|-----------------------|-------------------------|</span>

 <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>HeaderView</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Header</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>headerView</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Header</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>100</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassLayout</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>headerView</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>toPrintable</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>-XX:+UseCompressedOops 指针压缩开启运行结果：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#ce5c00;font-weight:700>[</span>Lcom.github.mxsm.Header<span style=color:#000;font-weight:700>;</span> object internals:
 OFFSET  SIZE                     TYPE DESCRIPTION                               VALUE
      <span style=color:#0000cf;font-weight:700>0</span>     <span style=color:#0000cf;font-weight:700>4</span>                          <span style=color:#ce5c00;font-weight:700>(</span>object header<span style=color:#ce5c00;font-weight:700>)</span>                           <span style=color:#0000cf;font-weight:700>01</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>00000001</span> <span style=color:#0000cf;font-weight:700>00000000</span> <span style=color:#0000cf;font-weight:700>00000000</span> 00000000<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span>1<span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#0000cf;font-weight:700>4</span>     <span style=color:#0000cf;font-weight:700>4</span>                          <span style=color:#ce5c00;font-weight:700>(</span>object header<span style=color:#ce5c00;font-weight:700>)</span>                           <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>00000000</span> <span style=color:#0000cf;font-weight:700>00000000</span> <span style=color:#0000cf;font-weight:700>00000000</span> 00000000<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span>0<span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#0000cf;font-weight:700>8</span>     <span style=color:#0000cf;font-weight:700>4</span>                          <span style=color:#ce5c00;font-weight:700>(</span>object header<span style=color:#ce5c00;font-weight:700>)</span>                           <span style=color:#0000cf;font-weight:700>05</span> c4 <span style=color:#0000cf;font-weight:700>00</span> f8 <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>00000101</span> <span style=color:#0000cf;font-weight:700>11000100</span> <span style=color:#0000cf;font-weight:700>00000000</span> 11111000<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span>-134167547<span style=color:#ce5c00;font-weight:700>)</span>
     <span style=color:#0000cf;font-weight:700>12</span>     <span style=color:#0000cf;font-weight:700>4</span>                          <span style=color:#ce5c00;font-weight:700>(</span>object header<span style=color:#ce5c00;font-weight:700>)</span>                           <span style=color:#0000cf;font-weight:700>64</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>01100100</span> <span style=color:#0000cf;font-weight:700>00000000</span> <span style=color:#0000cf;font-weight:700>00000000</span> 00000000<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span>100<span style=color:#ce5c00;font-weight:700>)</span>
     <span style=color:#0000cf;font-weight:700>16</span>   <span style=color:#0000cf;font-weight:700>400</span>   com.github.mxsm.Header Header<span style=color:#000;font-weight:700>;</span>.&lt;elements&gt;                        N/A
Instance size: <span style=color:#0000cf;font-weight:700>416</span> bytes
Space losses: <span style=color:#0000cf;font-weight:700>0</span> bytes internal + <span style=color:#0000cf;font-weight:700>0</span> bytes <span style=color:#000>external</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span> bytes total
</code></pre></div><p>-XX:-UseCompressedOops 指针压缩关闭运行结果：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#ce5c00;font-weight:700>[</span>Lcom.github.mxsm.Header<span style=color:#000;font-weight:700>;</span> object internals:
 OFFSET  SIZE                     TYPE DESCRIPTION                               VALUE
      <span style=color:#0000cf;font-weight:700>0</span>     <span style=color:#0000cf;font-weight:700>4</span>                          <span style=color:#ce5c00;font-weight:700>(</span>object header<span style=color:#ce5c00;font-weight:700>)</span>                           <span style=color:#0000cf;font-weight:700>01</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>00000001</span> <span style=color:#0000cf;font-weight:700>00000000</span> <span style=color:#0000cf;font-weight:700>00000000</span> 00000000<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span>1<span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#0000cf;font-weight:700>4</span>     <span style=color:#0000cf;font-weight:700>4</span>                          <span style=color:#ce5c00;font-weight:700>(</span>object header<span style=color:#ce5c00;font-weight:700>)</span>                           <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>00000000</span> <span style=color:#0000cf;font-weight:700>00000000</span> <span style=color:#0000cf;font-weight:700>00000000</span> 00000000<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span>0<span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#0000cf;font-weight:700>8</span>     <span style=color:#0000cf;font-weight:700>4</span>                          <span style=color:#ce5c00;font-weight:700>(</span>object header<span style=color:#ce5c00;font-weight:700>)</span>                           b0 1d ab 1c <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10110000</span> <span style=color:#0000cf;font-weight:700>00011101</span> <span style=color:#0000cf;font-weight:700>10101011</span> 00011100<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span>480976304<span style=color:#ce5c00;font-weight:700>)</span>
     <span style=color:#0000cf;font-weight:700>12</span>     <span style=color:#0000cf;font-weight:700>4</span>                          <span style=color:#ce5c00;font-weight:700>(</span>object header<span style=color:#ce5c00;font-weight:700>)</span>                           <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>00000000</span> <span style=color:#0000cf;font-weight:700>00000000</span> <span style=color:#0000cf;font-weight:700>00000000</span> 00000000<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span>0<span style=color:#ce5c00;font-weight:700>)</span>
     <span style=color:#0000cf;font-weight:700>16</span>     <span style=color:#0000cf;font-weight:700>4</span>                          <span style=color:#ce5c00;font-weight:700>(</span>object header<span style=color:#ce5c00;font-weight:700>)</span>                           <span style=color:#0000cf;font-weight:700>64</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#0000cf;font-weight:700>00</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>01100100</span> <span style=color:#0000cf;font-weight:700>00000000</span> <span style=color:#0000cf;font-weight:700>00000000</span> 00000000<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span>100<span style=color:#ce5c00;font-weight:700>)</span>
     <span style=color:#0000cf;font-weight:700>20</span>     <span style=color:#0000cf;font-weight:700>4</span>                          <span style=color:#ce5c00;font-weight:700>(</span>alignment/padding gap<span style=color:#ce5c00;font-weight:700>)</span>                  
     <span style=color:#0000cf;font-weight:700>24</span>   <span style=color:#0000cf;font-weight:700>800</span>   com.github.mxsm.Header Header<span style=color:#000;font-weight:700>;</span>.&lt;elements&gt;                        N/A
Instance size: <span style=color:#0000cf;font-weight:700>824</span> bytes
Space losses: <span style=color:#0000cf;font-weight:700>4</span> bytes internal + <span style=color:#0000cf;font-weight:700>0</span> bytes <span style=color:#000>external</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>4</span> bytes total
</code></pre></div><h3 id=3-mark-word>3 Mark Word</h3><p>标记字段每个字段表示什么，我们可以从JVM的源码着手分析，下面来看一下在 <a href=https://github.com/openjdk/jdk/blob/jdk-13-ga/src/hotspot/share/oops/arrayKlass.hpp>OpenJDK中markOop.hpp</a> JDK源码的文件注释，注释说明了位图的表示：</p><blockquote><p>说明:在OpenJDK中发现15版本已经没有markOop.hpp文件存在了。</p></blockquote><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:#8f5902;font-style:italic>//  64 bits:
</span><span style=color:#8f5902;font-style:italic>//  --------
</span><span style=color:#8f5902;font-style:italic>//  unused:25 hash:31 --&gt;| unused:1   age:4    biased_lock:1 lock:2 (normal object)
</span><span style=color:#8f5902;font-style:italic>//  JavaThread*:54 epoch:2 unused:1   age:4    biased_lock:1 lock:2 (biased object)
</span><span style=color:#8f5902;font-style:italic>//  PromotedObject*:61 ---------------------&gt;| promo_bits:3 -----&gt;| (CMS promoted object)
</span><span style=color:#8f5902;font-style:italic>//  size:64 -----------------------------------------------------&gt;| (CMS free block)
</span><span style=color:#8f5902;font-style:italic>//  
</span><span style=color:#8f5902;font-style:italic>//  使用COOPs指针压缩技术
</span><span style=color:#8f5902;font-style:italic>//  unused:25 hash:31 --&gt;| cms_free:1 age:4    biased_lock:1 lock:2 (COOPs &amp;&amp; normal object)
</span><span style=color:#8f5902;font-style:italic>//  JavaThread*:54 epoch:2 cms_free:1 age:4    biased_lock:1 lock:2 (COOPs &amp;&amp; biased object)
</span><span style=color:#8f5902;font-style:italic>//  narrowOop:32 unused:24 cms_free:1 unused:4 promo_bits:3 -----&gt;| (COOPs &amp;&amp; CMS promoted object)
</span><span style=color:#8f5902;font-style:italic>//  unused:21 size:35 --&gt;| cms_free:1 unused:7 ------------------&gt;| (COOPs &amp;&amp; CMS free block)
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#8f5902;font-style:italic>//    [JavaThread* | epoch | age | 1 | 01]       lock is biased toward given thread
</span><span style=color:#8f5902;font-style:italic>//    [0           | epoch | age | 1 | 01]       lock is anonymously biased
</span><span style=color:#8f5902;font-style:italic>//
</span><span style=color:#8f5902;font-style:italic>//  - the two lock bits are used to describe three states: locked/unlocked and monitor.
</span><span style=color:#8f5902;font-style:italic>//
</span><span style=color:#8f5902;font-style:italic>//    [ptr             | 00]  locked             ptr points to real header on stack
</span><span style=color:#8f5902;font-style:italic>//    [header      | 0 | 01]  unlocked           regular object header
</span><span style=color:#8f5902;font-style:italic>//    [ptr             | 10]  monitor            inflated lock (header is wapped out)
</span><span style=color:#8f5902;font-style:italic>//    [ptr             | 11]  marked             used by markSweep to mark an object
</span><span style=color:#8f5902;font-style:italic>//                                               not valid at any other time
</span></code></pre></div><p>如下图：</p><p>指针压缩开启：</p><p><img src="https://github.com/mxsm/picture/blob/main/java/jvm/markword%E6%8C%87%E9%92%88%E5%8E%8B%E7%BC%A9%E5%BC%80%E5%90%AF.png?raw=true" alt=指针压缩开启></p><p>指针压缩关闭</p><p><img src="https://github.com/mxsm/picture/blob/main/java/jvm/markword%E6%8C%87%E9%92%88%E5%8E%8B%E7%BC%A9%E6%B2%A1%E5%BC%80%E5%90%AF.png?raw=true" alt=指针压缩关闭></p><blockquote><p>说明：</p><ol><li>轻量锁是相对于偏向锁来说的</li><li>无锁状态是用01来表示</li><li>重量锁在英文说明中用的是(inflated lock)膨胀锁</li></ol></blockquote><h3 id=4-mark-word-锁状态>4 Mark Word 锁状态</h3><p>通过分析JVM的源码注释可以发现Java对象头在不同的状态下会有不同的表现形式，主要有三种状态：</p><ul><li><strong>无锁状态</strong></li><li><strong>加锁状态</strong></li><li><strong>GC标记</strong></li></ul><p>Java中上锁可以理解为给对象上锁，也就是改变对象头的状态(锁的状态)如果成功上锁那么就进入同步的代码块中。Java中锁又分为三类：</p><ul><li><strong>偏向锁(01)</strong></li><li><strong>轻量锁(00)</strong></li><li><strong>重量锁(10)</strong></li></ul><blockquote><p>说明：01、00、10 是对象头中锁的两位的表示</p></blockquote><p>不同的锁效率也不一样。</p><h3 id=5-jol数据如何查看>5 jol数据如何查看</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>com.github.mxsm</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.openjdk.jol.info.ClassLayout</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * @author mxsm
</span><span style=color:#8f5902;font-style:italic> * @Date 2021/1/21
</span><span style=color:#8f5902;font-style:italic> * @Since
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>HeaderView</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Header</span> <span style=color:#000>headerView</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Header</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;HashCode十六进制-----------&gt;&#34;</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toHexString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>headerView</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hashCode</span><span style=color:#ce5c00;font-weight:700>()));</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassLayout</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>headerView</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>toPrintable</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>运行结果:</p><p><img src="https://github.com/mxsm/picture/blob/main/java/jvm/jol%E6%95%B0%E6%8D%AE%E5%A6%82%E4%BD%95%E6%9F%A5%E7%9C%8B.png?raw=true" alt></p><p>用示意图来表示Mark Word的数据排列结合jol打印的数据：</p><p><img src="https://github.com/mxsm/picture/blob/main/java/jvm/markword%E4%BD%8D%E5%9B%BE%E5%9B%BE%E8%A7%A3.png?raw=true" alt></p><p>排列如上图就能和上面打印的对比出来了。这样也就解释了为什么头部未使用的25个byte</p><blockquote><p>说明：通过上面的锁的两个位标识可以看出来，在没有枷锁的时候应该是01和图中也一一对上</p></blockquote><h3 id=5-mark-word-正常状态>5 Mark Word 正常状态</h3><p>以下都是在开启指针压缩的情况下(这个也是JVM的默认)，首先看一下Header类</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Header</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>flag</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>date</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>float</span> <span style=color:#000>flt</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>double</span> <span style=color:#000>db</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>bytes</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>string</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>char</span> <span style=color:#000>ch</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>HeaderView</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Header</span> <span style=color:#000>headerView</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Header</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;HashCode十六进制-----------&gt;&#34;</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toHexString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>headerView</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hashCode</span><span style=color:#ce5c00;font-weight:700>()));</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassLayout</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>headerView</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>toPrintable</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>正常状态打印数据：</p><p><img src="https://github.com/mxsm/picture/blob/main/java/jvm/markword%E6%AD%A3%E5%B8%B8%E7%8A%B6%E6%80%81.png?raw=true" alt></p><blockquote><p>说明:从上图可以看出来不同的数据类型占用的字节数都不一样。</p></blockquote><h3 id=6-mark-word-偏向锁>6 Mark Word 偏向锁</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Header</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>biasedLock</span><span style=color:#ce5c00;font-weight:700>(){</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;biasedLock................&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>com.github.mxsm</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.openjdk.jol.info.ClassLayout</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * @author mxsm
</span><span style=color:#8f5902;font-style:italic> * @Date 2021/1/21
</span><span style=color:#8f5902;font-style:italic> * @Since
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>HeaderView</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Header</span> <span style=color:#000>headerView</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Header</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;加锁之前.....&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassLayout</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>headerView</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>toPrintable</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>headerView</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>biasedLock</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;加锁之后.....&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassLayout</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>headerView</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>toPrintable</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>打印结果：</p><p><img src="https://github.com/mxsm/picture/blob/main/java/jvm/%E7%8A%B6%E6%80%81%E8%BD%AC%E5%8F%98%E4%B8%BA%E5%81%8F%E5%90%91%E9%94%811.png?raw=true" alt></p><p>通过结果发现调用上面这个程序只有一个线程去调用biasedLock方法，应该是偏向锁，但是你会发现输出的结果（第一个字节）依然是00000001和无锁的时候一模一样，其实这是<strong>因为虚拟机在启动的时候对于偏向锁有延迟</strong>如果没有偏向锁的延迟的话，虚拟机在启动的时候，可能JVM某个线程调用你的线程，这样就有可能变成了轻量锁或者重量锁(如果没有延迟会降低JVM启动的速度)，所以要做偏向锁的延迟。查看的方式有两种：</p><ol><li><p>增加JVM参数:-XX:BiasedLockingStartupDelay=0</p></li><li><p>加锁之前让线程睡几秒</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>com.github.mxsm</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.concurrent.TimeUnit</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.openjdk.jol.info.ClassLayout</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>com.github.mxsm</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.concurrent.TimeUnit</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.openjdk.jol.info.ClassLayout</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * @author mxsm
</span><span style=color:#8f5902;font-style:italic> * @Date 2021/1/21
</span><span style=color:#8f5902;font-style:italic> * @Since
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>HeaderView</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>         * 睡眠时间大概在5秒左右，4秒测试我这边没有效果
</span><span style=color:#8f5902;font-style:italic>         * 切记延迟一定要放在对象创建之前，不然是无效的，因为在你对象创建之前，偏向锁的延迟的时间
</span><span style=color:#8f5902;font-style:italic>         * 没有给你睡过去，这时候，对象已经创建了，对象头的信息已经生成了。(在对象头生成之前)
</span><span style=color:#8f5902;font-style:italic>         */</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MILLISECONDS</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>4500</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>Header</span> <span style=color:#000>headerView</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Header</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;加锁之前.....&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassLayout</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>headerView</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>toPrintable</span><span style=color:#ce5c00;font-weight:700>());</span>

        <span style=color:#000>headerView</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>biasedLock</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;加锁之后.....&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassLayout</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>headerView</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>toPrintable</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div><blockquote><p>说明：</p><ul><li>睡眠时间大概在五秒左右，具体可以去测试</li><li>线程睡眠时间一定要在对象创建之前(对象头生成之前)</li></ul></blockquote></li></ol><p><img src="https://github.com/mxsm/picture/blob/main/java/jvm/%E7%8A%B6%E6%80%81%E8%BD%AC%E4%B8%BA%E5%81%8F%E5%90%91%E9%94%812.png?raw=true" alt></p><p>通过图片可以看出来已经变成可偏向状态了。</p><h3 id=7-mark-word重量锁膨胀锁>7 Mark Word重量锁(膨胀锁)</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>com.github.mxsm</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.openjdk.jol.info.ClassLayout</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * @author mxsm
</span><span style=color:#8f5902;font-style:italic> * @Date 2021/1/21
</span><span style=color:#8f5902;font-style:italic> * @Since
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Header</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>biasedLock</span><span style=color:#ce5c00;font-weight:700>(){</span>

        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;biasedLock方法执行................&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassLayout</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>toPrintable</span><span style=color:#ce5c00;font-weight:700>());</span>

    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>com.github.mxsm</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.concurrent.TimeUnit</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.openjdk.jol.info.ClassLayout</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * @author mxsm
</span><span style=color:#8f5902;font-style:italic> * @Date 2021/1/26
</span><span style=color:#8f5902;font-style:italic> * @Since
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>InflatedLock</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//偏向锁延迟开启的状态下
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Header</span> <span style=color:#000>headerView</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Header</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;加锁之前.....&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassLayout</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>headerView</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>toPrintable</span><span style=color:#ce5c00;font-weight:700>());</span>

        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>headerView</span><span style=color:#ce5c00;font-weight:700>){</span>
                    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SECONDS</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;------ Thread1 release-----\n&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassLayout</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>headerView</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>toPrintable</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>},</span><span style=color:#4e9a06>&#34;Thread1&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SECONDS</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Thread1 is locking&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassLayout</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>headerView</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>toPrintable</span><span style=color:#ce5c00;font-weight:700>());</span>


        <span style=color:#000>headerView</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>biasedLock</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;加锁之后.....&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassLayout</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>headerView</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>toPrintable</span><span style=color:#ce5c00;font-weight:700>());</span>

        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>gc</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;GC后.....&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassLayout</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>headerView</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>toPrintable</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>执行结果：</p><p><img src="https://github.com/mxsm/picture/blob/main/java/jvm/%E7%8A%B6%E6%80%81%E8%BD%AC%E4%B8%BA%E9%87%8D%E5%BA%A6%E9%94%811.png?raw=true" alt></p><p><img src="https://github.com/mxsm/picture/blob/main/java/jvm/%E7%8A%B6%E6%80%81%E8%BD%AC%E4%B8%BA%E9%87%8D%E5%BA%A6%E9%94%812.png?raw=true" alt></p><p>gc后年龄增加1。</p><p>参考文档：</p><ul><li><a href=https://blog.csdn.net/qq_36434742/article/details/106854061>深入理解Java的对象头mark word</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-7f0cbabc2a77ca6361b159ad79384cf5>类加载器和双亲委派模型</h1><div class="td-byline mb-4"><time datetime=2019-11-11 class=text-muted>2019-11-11</time></div><h3 id=1-类加载器>1. 类加载器</h3><p>每一个类加载器拥有一个独立的类命名空间，通俗的说：比较两个类是否相等只有两个类是同一个类加载器才有意义。</p><h4 id=jvm预定义类加载器分为三种>JVM预定义类加载器分为三种：</h4><ul><li><p><strong>启动类加载器（Bootstrap ClassLoader）—C++写的二进制代码而不是字节码</strong></p><p>启动类加载器主要加载的是JVM自身需要的类，这个类加载使用C++语言实现的，是虚拟机自身的一部分，它负责将 <code>&lt;JAVA_HOME>/lib</code> 路径下的核心类库或<code>-Xbootclasspath</code>参数指定的路径下的jar包加载到内存中，注意必由于虚拟机是按照文件名识别加载jar包的，如rt.jar，如果文件名不被虚拟机识别，即使把jar包丢到lib目录下也是没有作用的(出于安全考虑，Bootstrap启动类加载器只加载包名为java、javax、sun等开头的类)。</p><blockquote><p>在我们测试System.class.getClassLoader()的时候结果为null的原因，并不是表示System这个没有类加载器，而是他的加载器比较特殊。BootstrapClassLoader不是Java类而是C++代码编写的。所以返回为空。</p></blockquote></li><li><p><strong>拓展(Extension)类加载器</strong></p><p>扩展类加载器是指Sun公司(已被Oracle收购)实现的<code>sun.misc.Launcher$ExtClassLoader</code>类，由Java语言实现的，是Launcher的静态内部类，它负责加载<code>&lt;JAVA_HOME>/lib/ext</code>目录下或者由系统变量-Djava.ext.dir指定位路径中的类库，开发者可以直接使用标准扩展类加载器。</p></li><li><p><strong>应用程序(Application)类加载器</strong></p><p>也称应用程序加载器是指 Sun公司实现的<code>sun.misc.Launcher$AppClassLoader</code>。它负责加载系统类路径<code>java -classpath</code>或<code>-Djava.class.path </code>指定路径下的类库，也就是我们经常用到的classpath路径，开发者可以直接使用系统类加载器，一般情况下该类加载是程序中默认的类加载器，通过<code>ClassLoader#getSystemClassLoader()</code>方法可以获取到该类加载器。</p></li></ul><h4 id=自定义加载类>自定义加载类</h4><p>自定义类加载器可以直接或间接继承自类 <strong><code>java.lang.ClassLoader</code></strong> 。在 <strong><code>java.lang.ClassLoader</code></strong> 类的常用方法中，一般来说，自己开发的类加载器只需要覆写 <strong><code>findClass(String name)</code></strong> 方法即可</p><p>java.lang.ClassLoader类的方法 loadClass()封装了代理模式的实现。</p><ul><li>该方法会首先调用 findLoadedClass()方法来检查该类是否已经被加载过；</li><li>如果没有加载过的话，会调用父类加载器的 loadClass()方法来尝试加载该类；</li><li>如果父类加载器无法加载该类的话，就调用 findClass()方法来查找该类。</li></ul><h3 id=2-双亲委派模型>2. 双亲委派模型</h3><p><img src=https://raw.githubusercontent.com/mxsm/document/master/image/JSE/%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%A8%A1%E5%9E%8B%E5%9B%BE.png alt=图解></p><blockquote><p>这里的类加载器之间的父子关系一般不通过继承（Inheritance）来实现，而是通过组合（Composition）关系来服用父加载器代码。双亲委派模型并不是一个强制性约束，而是Java设计者推荐给开发者的一种类加载实现方式。</p></blockquote><h4 id=双亲委派模型的工作过程>双亲委派模型的工作过程</h4><ul><li>如果一个类加载器收到了类加载的请求，它不会先自己尝试处理这个请求，而是委派给它的父类加载器，所有的请求最终都会传送到顶层的启动类加载器。</li><li>只有当父类反馈自己无法完成该请求（它的搜索范围中没有找到所需的类，即抛ClassNotFoundException）时，子加载器才会尝试自己加载。</li></ul><h4 id=为什么用双亲委派模型>为什么用双亲委派模型？</h4><p><strong>为了保证JVM内存中相同的类只有一个，防止出现多个。</strong></p><p>使用双亲委派模型可以使得Java类随着它的类加载器一起具备了一种<strong>带有优先级的层次关系</strong> 。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>     <span style=color:#ce5c00;font-weight:700>*/</span>
    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>loadClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>resolve</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>ClassNotFoundException</span>
    <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getClassLoadingLock</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 首先检查是否已经加载
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>findLoadedClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>t0</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nanoTime</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>loadClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>findBootstrapClassOrNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassNotFoundException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    
                <span style=color:#ce5c00;font-weight:700>}</span>

                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                   <span style=color:#8f5902;font-style:italic>//如果一直没有找到就调用findClassc方法查找
</span><span style=color:#8f5902;font-style:italic></span>                   <span style=color:#8f5902;font-style:italic>//findClass 方法需要自己做override,如果没有直接
</span><span style=color:#8f5902;font-style:italic></span>                  	<span style=color:#8f5902;font-style:italic>//抛出 ClassNotFoundException
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>t1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nanoTime</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>findClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>

                    <span style=color:#8f5902;font-style:italic>// this is the defining class loader; record the stats
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>sun</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>misc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PerfCounter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParentDelegationTime</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>addTime</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t1</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>t0</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#000>sun</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>misc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PerfCounter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getFindClassTime</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>addElapsedTimeFrom</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t1</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#000>sun</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>misc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PerfCounter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getFindClasses</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>increment</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolve</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>resolveClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=3-自定义类加载器>3. 自定义类加载器</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>com.github.mxsm</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.commons.io.FileUtils</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.io.File</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.io.IOException</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MxsmClassLoader</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ClassLoader</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>classLoaderName</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>SUFFIX</span> <span style=color:#ce5c00;font-weight:700>=</span>  <span style=color:#4e9a06>&#34;.class&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MxsmClassLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>classLoaderName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>classLoaderName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>classLoaderName</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>findClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>ClassNotFoundException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>loadClassData</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IOException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>defineClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>loadClassData</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>FileUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readFileToByteArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>File</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getPath</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>replace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;.&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;\\&#34;</span><span style=color:#ce5c00;font-weight:700>)+</span><span style=color:#000>SUFFIX</span><span style=color:#ce5c00;font-weight:700>));</span>

    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getPath</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setPath</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>path</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;MxsmClassLoader{&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                <span style=color:#4e9a06>&#34;classLoaderName=&#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>classLoaderName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#39;\&#39;&#39;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                <span style=color:#4e9a06>&#39;}&#39;</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这个自定义类加载器的模板可以在 <strong><code>ClassLoader</code></strong> 类的说明上面找到。这样就实现了自定义的类加载器。</p><h3 id=4-自定义类加载器的父类说明>4. 自定义类加载器的父类说明</h3><p>下图是我运行当前代码的结果：</p><p><img src="https://github.com/mxsm/document/blob/master/image/JSE/ClassLoader.gif?raw=true" alt></p><ol><li>第一种情况A在ClassPath下面，所以加载类是通过AppClassLoader加载的。</li><li>第二种情况把ClassPath下面的类删除，重新存放。到另一个地方。然后打印发现A加载是通过自定义的 <strong><code>MxsmClassLoader</code></strong> 加载的。</li></ol><p>这里就很好的说明了<a href=#%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%A8%A1%E5%9E%8B%E7%9A%84%E5%B7%A5%E4%BD%9C%E8%BF%87%E7%A8%8B>双亲委派模型的工作原理</a></p><h3 id=5-类加载器的命名空间>5. 类加载器的命名空间</h3><p><strong>每个类加载器都有自己的命名空间，命名空间由该加载器及所有的父加载器所加载的类组成。</strong></p><ol><li>在同一个命名空间里面不允许出现两个完全一样的类</li><li>不同的命名空间可以出现两个完全一样的类，相互无感知也就是说两个Class不一样</li><li>子加载器所加载的类可以看见父加载器加载的类，但是父加载器所加载的类无法看见子加载器加载的类</li></ol><p>下面运行代码来验证，首先在ClassPath下面不删除A查看运行结果：</p><p><img src="https://github.com/mxsm/document/blob/master/image/JSE/ClassLoaderNamspace1.gif?raw=true" alt></p><p>这里是没有报错的。</p><p>我们把ClassPath的A删除然后运行：</p><p><img src="https://github.com/mxsm/document/blob/master/image/JSE/ClassLoaderNamspace2.gif?raw=true" alt></p><p>看一下报错：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>Exception</span> <span style=color:#000>in</span> <span style=color:#000>thread</span> <span style=color:#4e9a06>&#34;main&#34;</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reflect</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>InvocationTargetException</span>
	<span style=color:#000>at</span> <span style=color:#000>sun</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reflect</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NativeMethodAccessorImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke0</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Native</span> <span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>)</span>
	<span style=color:#000>at</span> <span style=color:#000>sun</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reflect</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NativeMethodAccessorImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NativeMethodAccessorImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>java</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>62</span><span style=color:#ce5c00;font-weight:700>)</span>
	<span style=color:#000>at</span> <span style=color:#000>sun</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reflect</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DelegatingMethodAccessorImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DelegatingMethodAccessorImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>java</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>43</span><span style=color:#ce5c00;font-weight:700>)</span>
	<span style=color:#000>at</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reflect</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>java</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>498</span><span style=color:#ce5c00;font-weight:700>)</span>
	<span style=color:#000>at</span> <span style=color:#000>com</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>github</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mxsm</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>App2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>App2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>java</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>23</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#000>Caused</span> <span style=color:#000>by</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ClassCastException</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>com</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>github</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mxsm</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>algorithm</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>A</span> <span style=color:#000>cannot</span> <span style=color:#000>be</span> <span style=color:#000>cast</span> <span style=color:#000>to</span> <span style=color:#000>com</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>github</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mxsm</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>algorithm</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>A</span>
	<span style=color:#000>at</span> <span style=color:#000>com</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>github</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mxsm</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>algorithm</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>A</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setA</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>java</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>12</span><span style=color:#ce5c00;font-weight:700>)</span>
	<span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>5</span> <span style=color:#000>more</span>
</code></pre></div><p>这里报 java.lang.ClassCastException: com.github.mxsm.algorithm.A cannot be cast to com.github.mxsm.algorithm.A 这是为什么？</p><p>原因就在于A的加载是不同的类加载器加载，由于有类加载器命名空间的存在。所以其实加载的是两个不同的类。所以在进行强行转换的时候回出现 A 不能转换 A的情况。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-9025dfd573d9433c3e79d78a3af06901>Java中的引用</h1><div class="td-byline mb-4"><time datetime=2019-09-28 class=text-muted>2019-09-28</time></div><h3 id=java引用的四种类型>Java引用的四种类型</h3><ul><li><p><strong>分为强引用（Strong Reference）</strong></p><p>这个大家天天用可能只是没有注意比如</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>Object</span> <span style=color:#000>obj</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>()</span>
</code></pre></div><p>这就是强引用。只要有强引用，对象永远不会被回收</p></li><li><p><strong>分为软引用（Soft Reference）</strong></p><p>自己表示没有用过，没用过那就看一下通过代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>SoftReference</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>StringBuilder</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>softReference</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SoftReference</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringBuilder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;test&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
</code></pre></div><p>官方的说法是由垃圾收集器根据内存需求自行清除。软引用大部分用来实现<strong>内存敏感</strong>的缓存</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * -XX:+PrintGCDetails
</span><span style=color:#8f5902;font-style:italic> * -Xms20m
</span><span style=color:#8f5902;font-style:italic> * -Xmx20m
</span><span style=color:#8f5902;font-style:italic> */</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SoftReferenceTest</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>_1MB</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1024</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>1024</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#000>SoftReference</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Byte</span><span style=color:#ce5c00;font-weight:700>[]&gt;</span> <span style=color:#000>softReference</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SoftReference</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Byte</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>_1MB</span><span style=color:#ce5c00;font-weight:700>]);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>softReference</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>allco1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>_1MB</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>allco2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>_1MB</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>allco3</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>_1MB</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>allco4</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>_1MB</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>allco5</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>_1MB</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>softReference</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>());</span>

    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div><pre><code>[Ljava.lang.Byte;@6bf2d08e
[GC (Allocation Failure) [PSYoungGen: 5065K-&gt;485K(6144K)] 13257K-&gt;9357K(19968K), 0.0018207 secs] [Times: user=0.00 sys=0.00, real=0.01 secs] 
[GC (Allocation Failure) [PSYoungGen: 4751K-&gt;496K(6144K)] 13623K-&gt;13517K(19968K), 0.0043121 secs] [Times: user=0.01 sys=0.01, real=0.00 secs] 
[Full GC (Ergonomics) [PSYoungGen: 496K-&gt;0K(6144K)] [ParOldGen: 13021K-&gt;13305K(13824K)] 13517K-&gt;13305K(19968K), [Metaspace: 3354K-&gt;3354K(1056768K)], 0.0166522 secs] [Times: user=0.03 sys=0.00, real=0.02 secs] 
[Full GC (Ergonomics) [PSYoungGen: 4340K-&gt;4096K(6144K)] [ParOldGen: 13305K-&gt;13261K(13824K)] 17645K-&gt;17357K(19968K), [Metaspace: 3364K-&gt;3364K(1056768K)], 0.0160700 secs] [Times: user=0.03 sys=0.00, real=0.02 secs] 
[Full GC (Allocation Failure) [PSYoungGen: 4096K-&gt;0K(6144K)] [ParOldGen: 13261K-&gt;9094K(13824K)] 17357K-&gt;9094K(19968K), [Metaspace: 3364K-&gt;3364K(1056768K)], 0.0048642 secs] [Times: user=0.01 sys=0.00, real=0.00 secs] 
null
Heap
 PSYoungGen      total 6144K, used 2129K [0x00000007bf980000, 0x00000007c0000000, 0x00000007c0000000)
  eden space 5632K, 37% used [0x00000007bf980000,0x00000007bfb94778,0x00000007bff00000)
  from space 512K, 0% used [0x00000007bff80000,0x00000007bff80000,0x00000007c0000000)
  to   space 512K, 0% used [0x00000007bff00000,0x00000007bff00000,0x00000007bff80000)
 ParOldGen       total 13824K, used 9094K [0x00000007bec00000, 0x00000007bf980000, 0x00000007bf980000)
  object space 13824K, 65% used [0x00000007bec00000,0x00000007bf4e1b68,0x00000007bf980000)
 Metaspace       used 3375K, capacity 4496K, committed 4864K, reserved 1056768K
  class space    used 367K, capacity 388K, committed 512K, reserved 1048576K
</code></pre><p>打印为null说明GC已经回收了内存。</p><p><strong>对于关联软引用的对象，在系统将要发生内存溢出异常之前，将会把这些对象进行二次回收，如果仍没有足够的内存，才会抛出内存溢出异常。使用SoftReference类来实现</strong></p></li><li><p><strong>分为弱引用（Weak Reference）</strong></p><p><strong>弱引用也是描述非必须的对象，被它关联的对象，只能生存到下一次垃圾回收发生之前，当垃圾回收时，无论内存是否足够，都会被回收，系统提供WeakReference类来实现弱引用</strong></p><p>代码验证：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>WeakRefrenceTest</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#000>WeakReference</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>weakReference</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>WeakReference</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;1111&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;GC前：&#34;</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>weakReference</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>gc</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//手动调用GC操作
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;GC后：&#34;</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>weakReference</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>());</span>

    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>打印结果：</p><pre><code>GC前：1111
GC后：null
</code></pre><p>如果换成下面的这样代码呢？</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>WeakRefrenceTest</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#8f5902;font-style:italic>//new String(&#34;1111&#34;) 换成 
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>WeakReference</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>weakReference</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>WeakReference</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#4e9a06>&#34;1111&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;GC前：&#34;</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>weakReference</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>gc</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;GC后：&#34;</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>weakReference</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>());</span>

    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>打印的结果：</p><pre><code>GC前：1111
GC后：1111
</code></pre><p>为什么上面 <strong><code>new String("111")</code></strong> 打印的GC后的为空而直接 <strong><code>111</code></strong> 打印的是GC后的是111。因为 <strong><code>111</code></strong> 被放到了常量池里面。</p></li><li><p><strong>虚引用（Phantom Reference）</strong></p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-a0c18569317eab7b1bbd8cc1fb6047c0>JVM垃圾收集器</h1><div class="td-byline mb-4"><time datetime=2019-08-12 class=text-muted>2019-08-12</time></div><h3 id=1-垃圾收集算法>1 垃圾收集算法</h3><h4 id=11-标记-----清除>1.1 标记 &mdash; 清除</h4><p><strong>标记清除算法分为两步</strong>：</p><ol><li><strong>标记需要回收的对象 &ndash; 标记</strong></li><li><strong>标记完成后统一回收被标记需要回收的对象。 &ndash; 清除</strong></li></ol><p><strong>优点：</strong></p><ul><li>解决循环引用问题</li><li>必要时才回收(当内存不足的情况)</li></ul><p><strong>缺点：</strong></p><ul><li>标记和清除两个过程效率都不高</li><li>会产生大量的不连续的内存碎片，空间碎片太多会导致以后程序中需要分配比较大的对象的时候，无法找到足够的连续的内存而不得不提前出发一次垃圾收集的动作。</li><li>回收的时候会触发 <strong><code>stop the world</code></strong></li></ul><h4 id=12-标记-----整理>1.2 标记 &mdash; 整理</h4><p>和标记清除算法一样 标记整理也分为两步且第一步是相同的：</p><ol><li><strong>将存活的对象标记&ndash;标记</strong></li><li><strong>移动所有存活的对象，且按照内存地址次序依次排列，然后将末端内存地址以后的内存全部回收&mdash;整理阶段</strong></li></ol><p><strong>优点：</strong></p><ul><li>不会产生内存碎片</li></ul><p><strong>缺点：</strong></p><ul><li>整理的效率不高</li></ul><h4 id=13-复制算法>1.3 复制算法</h4><p><strong>复制算法将内存划分为两个区间，在任意时间点，所有动态分配的对象都只能分配在其中一个区间（称为活动区间），而另外一个区间（称为空闲区间）则是空闲的</strong>。 当有效内存空间耗尽时，JVM将暂停程序运行，开启复制算法GC线程。<strong>接下来GC线程会将活动区间内的存活对象，全部复制到空闲区间，且严格按照内存地址依次排列，与此同时，GC线程将更新存活对象的内存引用地址指向新的内存地址</strong>。</p><p>​ 此时，空闲区间已经与活动区间交换，而垃圾对象现在已经全部留在了原来的活动区间，也就是现在的空闲区间。事实上，在活动区间转换为空间区间的同时，垃圾对象已经被一次性全部回收。</p><h4 id=14-gc的可达性分析算法>1.4 GC的可达性分析算法</h4><p><strong>基本思路：</strong> 通过一系列成为 <strong><code>GC Roots</code></strong> 对象作为起点，从这些起点开始向下搜索，搜索过程的路径称为 <strong><code>Reference Chain(引用链)</code></strong> ，当一个对象没有任何引用链相连的时，证明此对象是不可用的，所以即便有些对象互相引用但是和 <strong><code>GC Roots</code></strong> 之间不可达，依然会 <strong><code>GC</code></strong> ,这种方式很好的解决了计数器法不能解决的循环引用问题。</p><p><img src="https://github.com/mxsm/document/blob/master/image/JSE/GCRoots%E7%9A%84%E5%85%B3%E7%B3%BB%E5%9B%BE.jpg?raw=true" alt=图解></p><p>从上图根据可达性分析可以知道**：A、 B、 C、 D四个对象不会被GC，而 E、F虽然互相引用但是和GC Roots之间不可达**</p><p>可以作为 <strong><code>GC Roots</code></strong> 的对象包括：</p><blockquote><ol><li>虚拟机栈（栈帧中的本地变量表）中引用的对象</li><li>方法区中类静态属性引用的对象</li><li>方法区中常量引用的对象</li><li>本地方法栈中JNI引用的对象</li></ol></blockquote><h3 id=2-相关概念说明>2. 相关概念说明</h3><ul><li><strong>并行（Parallel）</strong>：指多条 <strong><code>垃圾收集线程并行</code></strong> 工作，但此时用户线程仍然处于等待状态。</li><li><strong>并发（Concurrent）</strong>：指用户线程与垃圾收集线程同时执行（但不一定是并行的，可能会交替执行），用户程序在继续运行，而垃圾收集程序运行于另一个CPU上。</li><li><strong>Minor GC 和 Major GC (Full GC)</strong><ul><li><strong>新生代GC（Minor GC）</strong>：指发生在新生代的垃圾收集动作，因为Java对象大多都具备朝生夕灭的特性，所以Minor GC非常频繁，一般回收速度也比较快。</li><li><strong>老年代GC（Major GC / Full GC）</strong>：指发生在老年代的GC，出现了Major GC，经常会伴随至少一次的Minor GC（但非绝对的，在Parallel Scavenge收集器的收集策略里就有直接进行Major GC的策略选择过程）。Major GC的速度一般会比Minor GC慢10倍以上。</li></ul></li><li><strong>吞吐量：</strong> 吞吐量就是CPU用于运行用户代码的时间与CPU总消耗时间的比值，即吞吐量 = 运行用户代码时间 /（运行用户代码时间 + 垃圾收集时间）。
虚拟机总共运行了100分钟，其中垃圾收集花掉1分钟，那吞吐量就是99%。</li></ul><h3 id=3-垃圾收集器>3. 垃圾收集器</h3><p>下面看一下垃圾收集器的相关图(<a href=https://blogs.oracle.com/jonthecollector/our-collectors>来源Oracle官网博客已放入我的github文档目录</a>)：</p><p><img src="https://github.com/mxsm/document/blob/master/image/JSE/collectors.jpg?raw=true" alt=图片></p><p>注：图中的 <strong><code>？</code></strong> 表示什么呢，以后的GC收集器的另一外的实现。比如 <strong><code>JDK11</code></strong> <strong><code>G1</code></strong> 垃圾收集器。</p><p>上图展示了六种(或者说7种 包括G1)不同的收集器在新生代和老年代的垃圾收集。如果两个收集器之间有连线说明说明可以搭配使用 。·</p><blockquote><p>JVM GC的组合</p><table><thead><tr><th>参数</th><th>年轻代GC</th><th>年老代和持久代</th></tr></thead><tbody><tr><td>-XX:+UseSerialGC</td><td>Serial</td><td>Serial Old</td></tr><tr><td>-XX:+UseParallelGC</td><td>并行回收GC(Parallel Scavenge)</td><td>Parallel Old</td></tr><tr><td>-XX:+UseConcMarkSweepGC</td><td>ParNew GC</td><td>并发GC 当出现concurrent Mode failure时采用Serial Old</td></tr><tr><td>-XX:+UseParNewGC</td><td>ParNew GC</td><td>Serial Old</td></tr><tr><td>-XX:+UseParalledlOldGC</td><td>并行回收GC(Parallel Scavenge)</td><td>Parallel Old</td></tr><tr><td>-XX:+UseParalledlOldGC -XX:+UseParNewGC</td><td>Par New GC</td><td>Parallel Old 当出现concurrentMode failure 或promotion failed时采用Serial Old</td></tr></tbody></table></blockquote><h3 id=4-serial收集器>4. Serial收集器</h3><ul><li><p><strong>特性：</strong> 这个收集器是一个<code>单线程</code>的收集器，但它的“单线程”的意义并不仅仅说明它只会使用一个CPU或一条收集线程去完成垃圾收集工作，更重要的是在它进行垃圾收集时，必须暂停其他所有的工作线程，直到它收集结束。停止其他的线程工作就是我们常说的 <strong><code>Stop the world</code></strong></p></li><li><p><strong>应用场景：</strong></p><p><strong><code>Serial</code></strong> 收集器是虚拟机运行在 <strong><code>Client</code></strong> 模式下的默认新生代收集器。</p><p>可以用命令</p><pre><code>java -version 查看
</code></pre><p>一般情况下都是Server模式(Windows 平台可以搜一下jvm.cfg文件)</p></li><li><p><strong>优点：</strong></p><p>简单而高效（与其他收集器的单线程比），对于限定单个CPU的环境来说，Serial收集器由于没有线程交互的开销，专心做垃圾收集自然可以获得最高的单线程收集效率。对于自由一个CPU来说，由于现在的电脑大多数都是多核心CPU所以这个收集器就很少用</p></li><li><p><strong>原理图解：</strong></p><p><img src="https://github.com/mxsm/document/blob/master/image/JSE/Serial%E6%94%B6%E9%9B%86%E5%99%A8.png?raw=true" alt=图解></p></li><li><p><strong>适用范围：</strong></p><ul><li><strong>新生代&ndash;Serial</strong></li><li><strong>老年代&ndash;Serial Old</strong></li></ul><p>所以这个收集器包含了处理新生代的 <strong><code>Serial(复制算法)</code></strong> 收集器和处理老年代的 <strong><code>Serial Old(标记整理算法)</code></strong> 收集器</p></li></ul><h3 id=5-parnew收集器>5. ParNew收集器</h3><ul><li><p><strong>特性：</strong></p><p><strong><code>ParNew</code></strong> 收集器其实就是 <strong><code>Serial(新生代)</code></strong> 收集器的多线程版本，除了使用了多线程以外其他的基本上都和 <strong><code>Serial(新生代)</code></strong> 收集器差不多。</p></li><li><p><strong>应用场景：</strong></p><p>ParNew收集器是许多运行在Server模式下的虚拟机中首选的新生代收集器。</p><p>很重要的原因是：除了 <strong><code>Serial</code></strong> 收集器外，目前只有它能与 <strong><code>CMS</code></strong> 收集器配合工作。
在JDK 1.5时期，HotSpot推出了一款在强交互应用中几乎可认为有划时代意义的垃圾收集器—— <strong><code>CMS</code></strong> 收集器，这款收集器是HotSpot虚拟机中第一款真正意义上的并发收集器，它第一次实现了让垃圾收集线程与用户线程同时工作。不幸的是，CMS作为老年代的收集器，却无法与JDK 1.4.0中已经存在的新生代收集器 <strong><code>Parallel Scavenge</code></strong> 配合工作，所以在JDK 1.5中使用CMS来收集老年代的时候，新生代只能选择 **<code>ParNew</code>**或者 <strong><code>Serial</code></strong> 收集器中的一个。</p></li><li><p><strong>优点：</strong></p><p>多线程收集器</p></li><li><p><strong>原理图解：</strong></p><p><img src="https://github.com/mxsm/document/blob/master/image/JSE/ParNew.png?raw=true" alt=图解></p></li><li><p><strong>适用范围：</strong></p><ul><li>新生代</li></ul></li></ul><h3 id=6-parallel-scavenge收集器>6. Parallel Scavenge收集器</h3><ul><li><p><strong>特性：</strong></p><p>Parallel Scavenge收集器是一个<strong>新生代收集器</strong>，它也是使用<strong>复制算法</strong>的收集器，又是<strong>并行</strong>的多线程收集器。</p></li><li><p><strong>应用场景：</strong></p><p>停顿时间越短就越适合需要与用户交互的程序，良好的响应速度能提升用户体验，而高吞吐量则可以高效率地利用CPU时间，尽快完成程序的运算任务，主要适合在后台运算而不需要太多交互的任务。</p></li><li><p><strong>优点：</strong></p><p>GC自适应调节，Parallel Scavenge收集器有一个参数<code>-XX:+UseAdaptiveSizePolicy</code>。当这个参数打开之后，就不需要手工指定新生代的大小、Eden与Survivor区的比例、晋升老年代对象年龄等细节参数了，虚拟机会根据当前系统的运行情况收集性能监控信息，动态调整这些参数以提供最合适的停顿时间或者最大的吞吐量，这种调节方式称为GC自适应的调节策略（GC Ergonomics）。</p></li><li><p><strong>试用范围：</strong></p><ul><li>新生代GC</li></ul></li></ul><h3 id=7-parallel-old收集器>7. Parallel Old收集器</h3><p><strong><code>Parallel Scavenge</code></strong> 和 <strong><code>Parallel old</code></strong> 属于同一个类型的收集器但是处理里的区域不同。前一个是新生代后一个是老年代。</p><ul><li><p><strong>特性：</strong></p><p>Parallel Old是Parallel Scavenge收集器的<strong>老年代版本</strong>，使用<strong>多线程</strong>和**“标记－整理”**算法。</p></li><li><p><strong>应用场景：</strong></p><p>在注重吞吐量以及CPU资源敏感的场合，都可以优先考虑Parallel Scavenge加Parallel Old收集器。这个收集器是在JDK 1.6中才开始提供的，在此之前，新生代的Parallel Scavenge收集器一直处于比较尴尬的状态。原因是，如果新生代选择了Parallel Scavenge收集器，老年代除了Serial Old收集器外别无选择（Parallel Scavenge收集器无法与CMS收集器配合工作）。由于老年代Serial Old收集器在服务端应用性能上的“拖累”，使用了Parallel Scavenge收集器也未必能在整体应用上获得吞吐量最大化的效果，由于单线程的老年代收集中无法充分利用服务器多CPU的处理能力，在老年代很大而且硬件比较高级的环境中，这种组合的吞吐量甚至还不一定有ParNew加CMS的组合“给力”。直到Parallel Old收集器出现后，“吞吐量优先”收集器终于有了比较名副其实的应用组合。</p></li><li><p><strong>图解：</strong></p><p><img src="https://github.com/mxsm/document/blob/master/image/JSE/ParallelOld.png?raw=true" alt=图解></p></li><li><p><strong>适用范围：</strong></p><ul><li>老年代</li></ul></li></ul><h3 id=8-cms收集器>8. CMS收集器</h3><ul><li><p><strong>特性：</strong></p><p><strong>CMS（Concurrent Mark Sweep）<strong>收集器是一种以</strong>获取最短回收停顿时间</strong>为目标的收集器，它非常符合那些集中在互联网站或者B/S系统的服务端上的Java应用，这些应用都非常重视服务的响应速度。从名字上（“Mark Sweep”）就可以看出它是基于**“标记-清除”**算法实现的。</p><p><strong>CMS</strong> 工作的的个步骤：</p><ul><li><strong>初始化标记(CMS initial mark):</strong> 仅仅只是标记一下GC Roots能直接关联到的对象，速度很快，需要“Stop The World”。 —— <strong>串行</strong></li><li><strong>并发标记(CMS Concurrent mark):</strong> 进行<strong>GC Roots Tracing</strong>的过程，在整个过程中耗时最长。— <strong>并发</strong></li><li><strong>重新标记(CMS remark):</strong> 为了修正并发标记期间因用户程序继续运作而导致标记产生变动的那一部分对象的标记记录，这个阶段的停顿时间一般会比初始标记阶段稍长一些，但远比并发标记的时间短。此阶段也需要“Stop The World”。 — <strong>并行 多个CG线程同时工作</strong></li><li><strong>并发清除(CMS concurrent sweep):</strong></li></ul><p>由于整个过程中耗时最长的并发标记和并发清除过程收集器线程都可以与用户线程一起工作，所以，从总体上来说，CMS收集器的内存回收过程是与用户线程一起并发执行的。通过下图可以比较清楚地看到CMS收集器的运作步骤中并发和需要停顿的时间</p></li><li><p><strong>图解：</strong></p><p><img src="https://github.com/mxsm/document/blob/master/image/JSE/CMS.png?raw=true" alt=图解></p></li><li><p><strong>适用范围：</strong></p><ul><li>老年代</li></ul></li><li><p><strong>优点：</strong></p><p><strong>并发收集</strong>、<strong>低停顿</strong>，因此CMS收集器也被称为<strong>并发低停顿收集器（Concurrent Low Pause Collector）</strong>。</p></li><li><p><strong>缺点：</strong></p><ul><li><p><strong>对CPU资源非常敏感</strong> 其实，面向并发设计的程序都对CPU资源比较敏感。在并发阶段，它虽然不会导致用户线程停顿，但会因为占用了一部分线程（或者说CPU资源）而导致应用程序变慢，总吞吐量会降低。<strong>CMS默认启动的回收线程数是（CPU数量+3）/4</strong>，也就是当CPU在4个以上时，并发回收时垃圾收集线程不少于25%的CPU资源，并且随着CPU数量的增加而下降。但是<strong>当CPU不足4个时（比如2个），CMS对用户程序的影响就可能变得很大</strong>，如果本来CPU负载就比较大，还要分出一半的运算能力去执行收集器线程，就可能导致用户程序的执行速度忽然降低了50%，其实也让人无法接受。</p></li><li><p><strong>无法处理浮动垃圾（Floating Garbage）</strong> 可能出现“Concurrent Mode Failure”失败而导致另一次Full GC的产生。<strong>由于CMS并发清理阶段用户线程还在运行着，伴随程序运行自然就还会有新的垃圾不断产生。<strong>这一部分垃圾出现在标记过程之后，CMS无法再当次收集中处理掉它们，只好留待下一次GC时再清理掉。这一部分垃圾就被称为</strong>“浮动垃圾”</strong>。也是由于在垃圾收集阶段用户线程还需要运行，那也就还需要预留有足够的内存空间给用户线程使用，因此CMS收集器不能像其他收集器那样等到老年代几乎完全被填满了再进行收集，需要预留一部分空间提供并发收集时的程序运作使用。</p></li><li><p><strong>标记-清除算法导致的空间碎片</strong> CMS是一款基于“标记-清除”算法实现的收集器，这意味着收集结束时会有大量空间碎片产生。空间碎片过多时，将会给大对象分配带来很大麻烦，往往出现老年代空间剩余，但无法找到足够大连续空间来分配当前对象。&ndash; 产生垃圾是标记清除算法的通病。</p><p>但是往往老年代还有很大剩余空间，但无法找到足够大的连续空间来分配当前对象,不得不触发一次 <strong><code>Full GC</code></strong> CMS的解决方案是使用<strong>UseCMSCompactAtFullCollection</strong>参数(默认开启)，在顶不住要进行Full GC时开启内存碎片整理。在碎片整理过程需要 <strong><code>STW</code></strong>,停顿时间比正常的 <strong><code>Full GC</code></strong> <strong>STW</strong> 时间更长</p></li></ul></li></ul><h3 id=9-g1收集器>9. G1收集器</h3><ul><li><p><strong>特点：</strong></p><ul><li><strong>并行与并发</strong> G1 能充分利用多CPU、多核环境下的硬件优势，使用多个CPU来缩短“Stop The World”停顿时间，部分其他收集器原本需要停顿Java线程执行的GC动作，G1收集器仍然可以通过并发的方式让Java程序继续执行。</li><li><strong>分代收集</strong> 与其他收集器一样，分代概念在G1中依然得以保留。虽然G1可以不需要其他收集器配合就能独立管理整个GC堆，但它能够采用不同方式去处理新创建的对象和已存活一段时间、熬过多次GC的旧对象来获取更好的收集效果。</li><li><strong>空间整合</strong> G1从整体来看是基于**“标记-整理”**算法实现的收集器，从局部（两个Region之间）上来看是基于**“复制”**算法实现的。这意味着G1运行期间不会产生内存空间碎片，收集后能提供规整的可用内存。此特性有利于程序长时间运行，分配大对象时不会因为无法找到连续内存空间而提前触发下一次GC。</li><li><strong>可预测的停顿</strong> 这是G1相对CMS的一大优势，降低停顿时间是G1和CMS共同的关注点，但G1除了降低停顿外，还能建立可预测的停顿时间模型，能让使用者明确指定在一个长度为M毫秒的时间片段内，消耗在GC上的时间不得超过N毫秒，这几乎已经是实时Java（RTSJ）的垃圾收集器的特征了。</li></ul><p><strong>横跨整个堆内存</strong></p><p>G1将整个个Java堆划分成为多个大小相等的独立区域(Region)，虽然新生代和老年代的概念还保留。但新生代和老年代不再是物理隔离的概念了，而都是一部分Region(不需要连续)的集合。</p><p><strong>避免全表扫描</strong></p><p>G1把Java堆分为多个Region，就是“化整为零”。但是Region不可能是孤立的，一个对象分配在某个Region中，可以与整个Java堆任意的对象发生引用关系。在做可达性分析确定对象是否存活的时候，需要扫描整个Java堆才能保证准确性，这显然是对GC效率的极大伤害。</p><p>为了避免全堆扫描的发生，虚拟机<strong>为G1中每个Region维护了一个与之对应的Remembered Set</strong>。虚拟机发现程序在对Reference类型的数据进行写操作时，会产生一个Write Barrier暂时中断写操作，检查Reference引用的对象是否处于不同的Region之中（在分代的例子中就是检查是否老年代中的对象引用了新生代中的对象），如果是，便通过CardTable<strong>把相关引用信息记录到被引用对象所属的Region的Remembered Set之中</strong>。当进行内存回收时，在GC根节点的枚举范围中加入Remembered Set即可保证不对全堆扫描也不会有遗漏。</p></li><li><h3 id=g1收集步骤>G1收集步骤</h3><ul><li><strong>初始标记（Initial Marking）</strong> 仅仅只是标记一下GC Roots 能直接关联到的对象，并且修改<strong>TAMS（Nest Top Mark Start）<strong>的值，让下一阶段用户程序并发运行时，能在正确可以的Region中创建对象，此阶段需要</strong>停顿线程</strong>，但耗时很短。</li><li><strong>并发标记（Concurrent Marking）</strong> 从GC Root 开始对堆中对象进行<strong>可达性分析</strong>，找到存活对象，此阶段耗时较长，但<strong>可与用户程序并发执行</strong>。</li><li><strong>最终标记（Final Marking）</strong> 为了修正在并发标记期间因用户程序继续运作而导致标记产生变动的那一部分标记记录，虚拟机将这段时间对象变化记录在<strong>线程的Remembered Set Logs</strong>里面，最终标记阶段需要<strong>把Remembered Set Logs的数据合并到Remembered Set中</strong>，这阶段需要<strong>停顿线程</strong>，但是<strong>可并行执行</strong>。</li><li><strong>筛选回收（Live Data Counting and Evacuation）</strong> 首先对各个Region中的回收价值和成本进行排序，根据用户所期望的GC 停顿是时间来制定回收计划。此阶段其实也可以做到与用户程序一起并发执行，但是因为只回收一部分Region，时间是用户可控制的，而且停顿用户线程将大幅度提高收集效率.</li></ul><p><img src="https://github.com/mxsm/document/blob/master/image/JSE/G1%E8%BF%90%E8%A1%8C%E5%9B%BE%E8%A7%A3.jpg?raw=true" alt=图解></p><p>美团对于G1 GC<a href=https://tech.meituan.com/2016/09/23/g1.html></a></p></li></ul><h3 id=10-什么时候会发生gc>10. 什么时候会发生GC</h3><p>这里说的 <strong><code>GC</code></strong> 包括了**<code>Minor GC</code>** 和 **<code>Full GC</code>** 两种。什么时候发生GC这里也分为两种：</p><ul><li>程序调用 <strong><code>System.gc()</code></strong> 通过手动的方式在程序中调用方法</li><li><strong><code>JVM</code></strong> 自身决定 <strong><code>GC</code></strong> 触发的时机<ul><li><strong>Minor GC</strong><ul><li>JVM无法为一个新的对象在<strong>新生代</strong>分配空间触发 <strong><code>Minor GC</code></strong></li></ul></li><li><strong>Full GC</strong><ul><li>老年代空间不足或者永久代空间不足(JDK8 元数据区)</li></ul></li></ul></li></ul><h3 id=11-总结>11. 总结</h3><table><thead><tr><th>收集器</th><th>串行、并行or并发</th><th>新生代/老年代</th><th>算法</th><th>目标</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>Serial</strong></td><td>串行</td><td>新生代</td><td>复制算法</td><td>响应速度优先</td><td>单CPU环境下的Client模式</td></tr><tr><td><strong>Serial Old</strong></td><td>串行</td><td>老年代</td><td>标记-整理</td><td>响应速度优先</td><td>单CPU环境下的Client模式、CMS的后备预案</td></tr><tr><td><strong>ParNew</strong></td><td>并行</td><td>新生代</td><td>复制算法</td><td>响应速度优先</td><td>多CPU环境时在Server模式下与CMS配合</td></tr><tr><td><strong>Parallel Scavenge</strong></td><td>并行</td><td>新生代</td><td>复制算法</td><td>吞吐量优先</td><td>在后台运算而不需要太多交互的任务</td></tr><tr><td><strong>Parallel Old</strong></td><td>并行</td><td>老年代</td><td>标记-整理</td><td>吞吐量优先</td><td>在后台运算而不需要太多交互的任务</td></tr><tr><td><strong>CMS</strong></td><td>并发</td><td>老年代</td><td>标记-清除</td><td>响应速度优先</td><td>集中在互联网站或B/S系统服务端上的Java应用</td></tr><tr><td><strong>G1</strong></td><td>并发</td><td>both</td><td>标记-整理+复制算法</td><td>响应速度优先</td><td>面向服务端应用，将来替换CMS</td></tr></tbody></table><blockquote><p>1 Minor GC 只包含新生代
2 Full GC 包含了老年代和新生代(也就是说Full GC过程伴随着有Minor GC)</p></blockquote><p>参考文档：</p><p><a href=https://www.jianshu.com/p/50d5c88b272d>https://www.jianshu.com/p/50d5c88b272d</a></p><p><a href=https://crowhawk.github.io/2017/08/15/jvm_3/>https://crowhawk.github.io/2017/08/15/jvm_3/</a></p><p><a href=https://tech.meituan.com/2017/12/29/jvm-optimize.html>https://tech.meituan.com/2017/12/29/jvm-optimize.html</a></p><p><a href=https://blogs.oracle.com/jonthecollector/our-collectors>https://blogs.oracle.com/jonthecollector/our-collectors</a></p><p><a href=http://ifeve.com/useful-jvm-flags-part-7-cms-collector/>http://ifeve.com/useful-jvm-flags-part-7-cms-collector/</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-307e78a13440aea85a53342138104377>类的加载</h1><div class="td-byline mb-4"><time datetime=2019-04-27 class=text-muted>2019-04-27</time></div><h3 id=1-虚拟机类的加载>1. 虚拟机类的加载</h3><p>虚拟机加类的生命周期几个阶段图解如下：</p><p><img src=https://raw.githubusercontent.com/mxsm/document/master/image/JSE/JVM%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E7%B1%BB%E5%8A%A0%E8%BD%BD.png alt=图解></p><p>虚拟机加载类的的三个阶段(加载&mdash;>连接&mdash;>初始化)：</p><ul><li><p><strong>加载</strong></p><p><strong>加载</strong> 是 <strong>类加载</strong> (<strong><code>Class Loading</code></strong>)过程的一个阶段在这阶段需要做三件事情：</p><ol><li>通过一个**类的全限定名(带包名)**来获取定义此类的二进制字节流。</li><li>将这个字节的流所代表的静态存储结构转化成为方法区的运行时数据结构</li><li>在内存中生成一个代表这个类的 <strong><code>java.lang.Class</code></strong> 对象，作为方法区这个类的各种数据访问入口</li></ol></li><li><p><strong>连接</strong></p><p>连接又分为三个阶段：</p><ul><li><p><strong>验证</strong></p><ul><li><p>文件格式验证</p><ul><li><strong><code>Java</code></strong> 文件是否已魔数开头</li><li>主次版本号是否在当前虚拟机处理范围内</li><li>常量池中的常量是否有不被支持的类型</li><li>&mldr;&mldr;</li></ul></li><li><p>元数据的验证</p><ul><li>是否有父类</li><li>等等&mldr;..</li></ul></li><li><p>字节码验证</p></li><li><p>符号应用验证</p></li></ul></li><li><p><strong>准备</strong></p><p>正式为类的变量分配内存并设置类变量初始值阶段，这些变量锁使用的内存都将在方法区中进行分配。(<strong>这里的分配对象的内存景包括类变量&ndash;也就是被static修饰的变量，不包括实例变量</strong>)</p></li><li><p><strong>解析</strong></p><p>解析阶段是JVM将常量池内的符号引用替换为直接引用的过程。</p><ul><li><p><strong>符号引用</strong></p><p>符号引用以一组符号来描述所引用的目标，符号可以是任何形式的字面量，只要使用时能够无歧义的定位到目标即可。例如，在Class文件中它以CONSTANT_Class_info、CONSTANT_Fieldref_info、CONSTANT_Methodref_info等类型的常量出现。符号引用与虚拟机的内存布局无关，引用的目标并不一定加载到内存中。在Java中，一个java类将会编译成一个class文件。在编译时，java类并不知道所引用的类的实际地址，因此只能使用符号引用来代替。比如org.simple.People类引用了org.simple.Language类，在编译时People类并不知道Language类的实际内存地址，因此只能使用符号org.simple.Language（假设是这个，当然实际中是由类似于CONSTANT_Class_info的常量来表示的）来表示Language类的地址。各种虚拟机实现的内存布局可能有所不同，但是它们能接受的符号引用都是一致的，因为符号引用的字面量形式明确定义在Java虚拟机规范的Class文件格式中。(<strong>总结一下：就是类似于占位符用一个能唯一标识自己的符号占着</strong>)</p></li><li><p><strong>直接引用</strong></p><p>直接指向目标的指针，相对偏移量，一个能间接定位到目标的句柄</p></li><li><p><strong>类或者接口的解析</strong></p></li><li><p><strong>字段的解析</strong></p></li><li><p><strong>类方法的解析</strong></p></li><li><p><strong>接口方法的解析</strong></p></li></ul></li></ul></li><li><p><strong>初始化</strong></p><p>在类初始化之前的准备阶段虚拟机会将**类变量（static 修饰的变量）**分配内存并设置默认值。初始化阶段：</p><ul><li><p>编译器会在将 <code>.java</code> 文件编译成 <code>.class</code> 文件时，收集所有类初始化代码和 <code>static {}</code> 域的代码，收集在一起成为 <code>&lt;cinit>()</code> 方法 (<strong>注意：静态代码块只能访问代码块之前的变量，定义之后的变量只能赋值不能访问</strong>)</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>String</span> <span style=color:#000>aaa</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>aaa</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;123&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>bbb</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;234&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bbb</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// 在ideal中会报错 但是上面一个语句可以
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>String</span> <span style=color:#000>bbb</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div></li><li><p>子类初始化时会首先调用父类的 <strong><code>&lt;cinit>()</code></strong> 方法</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Animals</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>String</span> <span style=color:#000>animals</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>animals</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;animals&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>animals</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Cat</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Animals</span><span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>String</span> <span style=color:#000>cat</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>cat</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Cat&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cat</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>App</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span> <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Cat</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>打印的结果：</p><pre><code>animals
Cat
</code></pre></li><li><p><strong>多线程环境下保证线程的安全</strong></p></li></ul></li><li><p><strong>使用</strong></p></li><li><p><strong>卸载</strong></p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-b0fc15264e85102271d7c36b7d538658>JVM的内存模型</h1><div class="td-byline mb-4"><time datetime=2018-11-04 class=text-muted>2018-11-04</time></div><h3 id=1--jvm的内存模型>1. JVM的内存模型</h3><p>从网上找了几个内存的模型和自己画的一个</p><p><img src="https://github.com/mxsm/document/blob/master/image/JSE/JVMmodel.png?raw=true" alt=图片></p><p><img src="https://github.com/mxsm/document/blob/master/image/JSE/JVM%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E5%9B%BE%E8%A7%A3.png?raw=true" alt=图片></p><p><img src="https://github.com/mxsm/document/blob/master/image/JSE/%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E5%9B%BE%E8%A7%A3.png?raw=true" alt=图片></p><p><strong>线程共享：</strong></p><ul><li><p><strong>方法区：</strong></p><p>在 <strong><code>Java</code></strong> 虚拟机中，方法区是可供各线程共享的运行时内存区域。在HotSpot中，设计者将方法区纳入GC分代收集。HotSpot虚拟机堆内存被分为新生代和老年代，对堆内存进行分代管理，所以HotSpot虚拟机使用者更愿意将方法区称为 <strong><code>老年代(或者叫永久代)</code></strong> 。</p></li><li><p><strong>堆：</strong></p><p>堆内存是 <strong><code>JVM</code></strong> 所有线程共享的部分，在虚拟机启动的时候就已经创建了。所有的对象和数组都在堆上进行分配。这部分空间可以通过GC进行垃圾回收的。当申请不到空间时会抛出 <strong><code>OutOfMemoryError</code></strong> 。</p></li></ul><p><strong>线程隔离：</strong></p><ul><li><p><strong>PC寄存器</strong></p><p>PC寄存器也叫程序计数器，可以看成当前线程所执行的字节码的行号指示器。在任何一个确定的时刻，一个处理器都只会执行一条线程中的指令。应酬为了线程切换能够正确的恢复到正确的执行位置。每条线程都需要一个独立的程序计数器，PC寄存器所以是线程私有的和特定的线程绑定在一起的。**执行的是Java方法该寄存器保存的是当前指令的地址。如果执行的是本地方法PC寄存器就是空的。 ** ( <strong><code>主要的作用就是完成线程的上下文切换</code></strong> )</p></li><li><p><strong>本地方法栈</strong></p><p>保存native方法进入区域的地址</p></li><li><p><strong>虚拟机栈</strong></p><p>每一个 <strong><code>Java</code></strong> 线程都有自己的虚拟机栈，这个栈与线程一起创建，他的生命周期和线程一样。虚拟机栈描述的是 <strong><code>Java 方法执行的内存模型</code></strong> ，每个方法被执行的时候会同时创建一个 <strong><code>栈帧</code></strong> 用来存储局部变量表，操作数栈，动态链接，方法出口信息等。每个方法被调用直到执行完成的整个过程就对应虚拟机栈创建的一个线程的栈帧，包含了出栈和入栈的过程。</p></li></ul><h3 id=2-java-heap-内存模型jdk7>2 Java Heap 内存模型（JDK7）</h3><p>在Java中 <strong><code>方法区</code></strong> 和 <strong><code>Heap(堆)</code></strong> 应该都属于堆的范畴，但是只是不同的Java虚拟机的实现对此进行了区分而已。</p><p>当代主流虚拟机（ <strong><code>Hotspot VM</code></strong> ）的垃圾回收都采用“分代回收”的算法。“分代回收”是基于这样一个事实：<strong>对象的生命周期不同，所以针对不同生命周期的对象可以采取不同的回收方式，以便提高回收效率。</strong></p><p><strong><code>Hotspot VM</code></strong> 将内存划分为不同的物理区，就是“分代”思想的体现。如图所示，JVM内存主要由 <strong><code>新生代</code></strong> ， <strong><code>老年代</code></strong> 、 <strong><code>永久代构成</code></strong> 。而 <strong><code>新生代</code></strong> 和 <strong><code>老年代</code></strong> 构成上面的JVM内存模型中说的 <strong><code>堆</code></strong> ， 而 <strong><code>永久代</code></strong> 构成了 <strong><code>方法区</code></strong></p><p><img src="https://github.com/mxsm/document/blob/master/image/JSE/JVM%E5%A0%86%E5%92%8C%E6%96%B9%E6%B3%95%E5%8C%BA%E7%9A%84%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.png?raw=true" alt=图解></p><ul><li><p><strong>新生代(Young Generation):</strong> 大多数对象在新生代中被创建，其中很多对象的生命周期很短。每次新生代的垃圾回收（又称 <strong><code>Minor GC</code></strong> ）后只有少量对象存活，所以选用 <strong><code>复制算法</code></strong> ，只需要少量的复制成本就可以完成回收。</p><ul><li><strong>Eden区：</strong> 大部分对象在Eden区中生成。当 <strong><code>Eden区</code></strong> 满时，还存活的对象将被复制到 <strong><code>Survivor区(S0)</code></strong> 。(PS:程序的设计者真的是厉害命名都是结合神话故事然后又能生动反映实际情况。耶和华上帝照自己的形像造了人类的袓先，男的称亚当，女的称夏娃，安置第一对男女住在伊甸园中。伊甸园在圣经的原文中含有快乐，愉快的园子的意思.只有佩服两个字)</li><li><strong>S0区:</strong> S0区存放Eden区GC剩下的。</li><li><strong>S1区:</strong> S1区存放S0区GC剩下的。</li></ul><p>当Eden区满时，还存活的对象将被复制到两个Survivor区（中的一个）。当这个Survivor区满时，此区的存活且不满足“晋升”条件的对象将被复制到另外一个Survivor区。对象每经历一次Minor GC，年龄加1，达到“晋升年龄阈值”后，被放到老年代，这个过程也称为“晋升”。显然，“晋升年龄阈值”的大小直接影响着对象在新生代中的停留时间，在Serial和ParNew GC两种回收器中，“晋升年龄阈值”通过参数MaxTenuringThreshold设定，默认值为15。</p></li><li><p><strong>老年代（Old Generation）</strong> ：在新生代中经历了N次垃圾回收后仍然存活的对象，就会被放到年老代，该区域中对象存活率高。老年代的垃圾回收（又称Major GC）通常使用“ <strong>标记-清理</strong> ”或“ <strong>标记-整理</strong> ”算法。<strong>整堆包括新生代和老年代的垃圾回收称为Full GC</strong>（HotSpot VM里，除了CMS之外，<strong>其它能收集老年代的GC都会同时收集整个GC堆，包括新生代</strong>）。</p></li><li><p><strong>永久代（Perm Generation）：</strong> 主要存放元数据，例如Class、Method的元信息，与垃圾回收要回收的Java对象关系不大。相对于新生代和年老代来说，该区域的划分对垃圾回收影响比较小。</p><p>JDK8用 <strong>MetaSpace</strong> 代替了 <strong>永久代</strong></p></li></ul><h3 id=2-jvm具体分析>2. JVM具体分析</h3><p><img src="https://github.com/mxsm/document/blob/master/image/JSE/JVM.png?raw=true" alt></p><p>通过字节码来分析栈帧，首先看一下源码创建</p><p><img src="https://github.com/mxsm/document/blob/master/image/JSE/bytes.gif?raw=true" alt></p><p>这里演示了如何获取字节码的。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>Compiled</span> <span style=color:#000>from</span> <span style=color:#4e9a06>&#34;Math.java&#34;</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>com</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>github</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mxsm</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Math</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>CONST</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>com</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>github</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mxsm</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Math</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>Code</span><span style=color:#ce5c00;font-weight:700>:</span>
       <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_0</span>
       <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>invokespecial</span> <span style=color:#a40000>#</span><span style=color:#000>1</span>                  <span style=color:#8f5902;font-style:italic>// Method java/lang/Object.&#34;&lt;init&gt;&#34;:()V
</span><span style=color:#8f5902;font-style:italic></span>       <span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>return</span>

  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>compute</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>Code</span><span style=color:#ce5c00;font-weight:700>:</span>
       <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>iconst_1</span>
       <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>istore_1</span>
       <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>iconst_2</span>
       <span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>istore_2</span>
       <span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>iload_1</span>
       <span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>iload_2</span>
       <span style=color:#000>6</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>iadd</span>
       <span style=color:#000>7</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>bipush</span>        <span style=color:#000>10</span>
       <span style=color:#000>9</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>imul</span>
      <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>istore_3</span>
      <span style=color:#000>11</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>iload_3</span>
      <span style=color:#000>12</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>ireturn</span>

  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>String</span><span style=color:#ce5c00;font-weight:700>[]);</span>
    <span style=color:#000>Code</span><span style=color:#ce5c00;font-weight:700>:</span>
       <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>new</span>           <span style=color:#a40000>#</span><span style=color:#000>2</span>                  <span style=color:#8f5902;font-style:italic>// class com/github/mxsm/Math
</span><span style=color:#8f5902;font-style:italic></span>       <span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>dup</span>
       <span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>invokespecial</span> <span style=color:#a40000>#</span><span style=color:#000>3</span>                  <span style=color:#8f5902;font-style:italic>// Method &#34;&lt;init&gt;&#34;:()V
</span><span style=color:#8f5902;font-style:italic></span>       <span style=color:#000>7</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>astore_1</span>
       <span style=color:#000>8</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_1</span>
       <span style=color:#000>9</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>invokevirtual</span> <span style=color:#a40000>#</span><span style=color:#000>4</span>                  <span style=color:#8f5902;font-style:italic>// Method compute:()I
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>12</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>pop</span>
      <span style=color:#000>13</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>return</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote><p>命令对照表：<a href=https://xfl03.gitee.io/coremodtutor/%E9%99%84%E5%BD%95B.html>https://xfl03.gitee.io/coremodtutor/%E9%99%84%E5%BD%95B.html</a></p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-6d17d91bf7dff2fe0b0cfcf7f21b42c5>JVM常用的命令</h1><div class="td-byline mb-4"><time datetime=2018-09-29 class=text-muted>2018-09-29</time></div><h3 id=查看jvm默认垃圾收集器>查看JVM默认垃圾收集器</h3><p>命令：</p><pre><code>java -XX:+PrintCommandLineFlags -version
</code></pre><p>JDK8的打印结果：</p><pre><code>$ java -XX:+PrintCommandLineFlags -version
-XX:InitialHeapSize=134177280 -XX:MaxHeapSize=2146836480 -XX:+PrintCommandLineFlags -XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:-UseLargePagesIndividualAllocation -XX:+UseParallelGC
java version &quot;1.8.0_151&quot;
Java(TM) SE Runtime Environment (build 1.8.0_151-b12)
Java HotSpot(TM) 64-Bit Server VM (build 25.151-b12, mixed mode)

</code></pre><p>JDK11的打印结果：</p><pre><code>$ ./java -XX:+PrintCommandLineFlags -version
-XX:G1ConcRefinementThreads=4 -XX:GCDrainStackTargetSize=64 -XX:InitialHeapSize=134177280 -XX:MaxHeapSize=2146836480 -XX:+PrintCommandLineFlags -XX:ReservedCodeCacheSize=251658240 -XX:+SegmentedCodeCache -XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:+UseG1GC -XX:-UseLargePagesIndividualAllocation
java version &quot;11.0.2&quot; 2019-01-15 LTS
Java(TM) SE Runtime Environment 18.9 (build 11.0.2+9-LTS)
Java HotSpot(TM) 64-Bit Server VM 18.9 (build 11.0.2+9-LTS, mixed mode)

</code></pre><h3 id=jvm打印gc日志详情>JVM打印GC日志详情</h3><p>命令：</p><pre><code>-XX:+PrintGCDetails
</code></pre><h3 id=查看非标准的参数命令>查看非标准的参数命令</h3><pre><code>java -XX:+PrintFlagsInitial  查看-XX的
java -X 参看-X的
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-3762f7c58e742ae639a434348a7a083f>Java GC日志图解</h1><div class="td-byline mb-4"><time datetime=2018-07-14 class=text-muted>2018-07-14</time></div><h3 id=1-gc日志开启>1. GC日志开启</h3><p><strong>Java</strong> 的GC日志可以通过命令 <strong><code>-XX:+PrintGCDetails</code></strong> 开启。下面就来看看如何看懂GC的日志。</p><h3 id=2-如何看gc日志>2. 如何看GC日志</h3><p>下面是以<strong>JDK8</strong>为例子，GC也是用的默认(<strong>ParallelGC</strong>)的没有做任何修改。<strong>GC</strong>分为两种：</p><ul><li><p><strong>Minor GC</strong> — <strong>新生代GC</strong></p><p><img src="https://github.com/mxsm/document/blob/master/image/JSE/MinorGCDetail.jpg?raw=true" alt=图解></p><ol><li><p><strong>GC (System.gc())：</strong> <strong>GC</strong>的类型 GC表示的是 <strong>Minor GC</strong></p></li><li><p><strong>[PSYoungGen: 7887K->1228K(76288K)]</strong></p><pre><code>PSYoungGen: 表示年轻带
7887K: GC前新生代占用的内存
1228K：GC后新生代占用的内存
76288K：新生代总共大小
</code></pre></li><li><p><strong>7887K->1236K(251392K)</strong></p><pre><code>7887K：GC前JVM堆内存占用
1236K：GC后JVM堆内存占用
251392K： JVM堆总大小
</code></pre></li><li><p><strong>0.0019310 secs</strong> GC耗时</p></li><li><p><strong>[Times: user=0.01 sys=0.00, real=0.01 secs]</strong></p><pre><code>user=0.01 用户耗时
sys=0.00 系统耗时
real=0.01 实际耗时
</code></pre></li></ol></li><li><p><strong>Full GC(Major GC) — 老年代GC</strong></p><p><img src="https://github.com/mxsm/document/blob/master/image/JSE/FullGCDetail.jpg?raw=true" alt=图></p></li></ul><ol><li><strong>Full GC (System.gc())</strong> GC类型—<strong>Full GC</strong></li><li><strong>[PSYoungGen: 1228K->0K(76288K)]:</strong> 新生代：GC前内存占用—>GC后内存占用(新生代内存占用总量)</li><li><strong>[ParOldGen: 8K->1081K(175104K)]:</strong> 老年代：GC前内存占用—>GC后内存占用(老年代的内存占用总量)</li><li><strong>1236K->1081K(251392K)：</strong> JVM内存占用: GC前内存占用—>GC后内存占用(JVM内存占用总量)</li><li><strong>[Metaspace: 3212K->3212K(1056768K)]：</strong> 元数据区： GC前内存在用—>GC后内存占用(元数据区总量)</li><li>后面的都是时间</li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-0f2e1c3513283b37e05912623fa733a1>JVM参数</h1><div class="td-byline mb-4"><time datetime=2018-06-19 class=text-muted>2018-06-19</time></div><h3 id=1-参数分类>1. 参数分类</h3><ul><li><p>其一是标准参数（-），所有的JVM实现都必须实现这些参数的功能，而且向后兼容；</p><p>这类选项的功能是很稳定的，在后续版本中也不太会发生变化。</p><p>运行java或者 java -help 可以看到所有的标准选项。</p><p>语法：所有的标准选项都是以 - 开头，比如-version，-server等。</p></li><li><p>其二是非标准参数（-X），默认jvm实现这些参数的功能，但是并不保证所有jvm实现都满足，且不保证向后兼容；</p><p>这类选项的功能还是很稳定，但官方的说法是它们的行为可能会在后续版本中改变，也有可能不在后续版本中提供了.</p><p>运行 命令可以看到所有的X选项。</p><pre><code>java -X
</code></pre><p>语法：这类选项都是以 -X 开头，比如-Xms。</p></li><li><p>其三是非Stable参数（-XX），此类参数各个jvm实现会有所不同，将来可能会随时取消，需要慎重使用；</p><p>这类选项是属于实验性，主要是给JVM开发者用于开发和调试JVM的，在后续的版本中行为有可能会变化。</p><p>语法：</p><ul><li>如果是布尔类型的选项，它的格式为-XX:+flag或者-XX:-flag，分别表示开启和关闭该选项。</li><li>针对非布尔类型的选项，它的格式为-XX:flag=value</li></ul><p>查看命令：</p><pre><code>java -XX:+PrintFlagsInitial
</code></pre></li></ul></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list"><a class=text-white target=_blank rel="noopener noreferrer" href=https://groups.google.com/u/1/g/ljbmxsm><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=个人掘金主页 aria-label=个人掘金主页><a class=text-white target=_blank rel="noopener noreferrer" href=https://juejin.cn/user/1151943918492855><i class="fab fa-twitter"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/mxsm><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2022 The Docsy Authors All Rights Reserved</small>
<small class=ml-1><a href=https://policies.google.com/privacy target=_blank>隐私政策</a></small><p class=mt-2><a href=/about/>Home</a></p></div></div></div></footer><div><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css><script src=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js></script><script>$("p img").wrap(function(){return'<a data-fancybox="gallery" href="'+$(this).attr('src')+'"></a>'})</script></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/mermaid@8.8.1/dist/mermaid.min.js integrity=sha384-to2w0I1OqmbJ9J6yTnIX+KYU8grNpZoD1dKPLjgEJvMe5L5+/7qvuNa2sQo8WAWj crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/raphael/2.3.0/raphael.min.js integrity="sha512-tBzZQxySO5q5lqwLWfu8Q+o4VkTcRGOeQGVQ0ueJga4A1RKuzmAu5HXDOXLEjpbKyV7ow9ympVoa6wZLEzRzDg==" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.15.0/flowchart.min.js integrity="sha512-6QsSiIybtf8tuZ6xfjRTr2tdtw3Gp4q5RSCh2b6q9seoKEQmhAG1RrCA8F0kXTwivVxRVbp/YF3zOh8rvEAU7Q==" crossorigin=anonymous></script><script src=/js/main.min.b541b310f01941a0abfd76b652b5fb60dac470573775bb5b31ff08fe3f6cea51.js integrity="sha256-tUGzEPAZQaCr/Xa2UrX7YNrEcFc3dbtbMf8I/j9s6lE=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.js></script><script type=text/javascript>docsearch({appId:'JO2SY3WDAC',apiKey:'324ddb3b679c1308e5aa8bf222e07f8b',indexName:'mxsm',inputSelector:'.td-search-input',debug:!1})</script></body></html>