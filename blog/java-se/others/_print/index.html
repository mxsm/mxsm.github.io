<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.83.1"><link rel=canonical type=text/html href=/blog/java-se/others/><link rel=alternate type=application/rss+xml href=/blog/java-se/others/index.xml><meta name=ROBOTS content="INDEX, FOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>其他 | 蚂蚁背大象</title><meta property="og:title" content="其他"><meta property="og:description" content="蚂蚁背大象博客"><meta property="og:type" content="website"><meta property="og:url" content="/blog/java-se/others/"><meta property="og:site_name" content="蚂蚁背大象"><meta itemprop=name content="其他"><meta itemprop=description content="蚂蚁背大象博客"><meta name=twitter:card content="summary"><meta name=twitter:title content="其他"><meta name=twitter:description content="蚂蚁背大象博客"><link rel=preload href=/scss/main.min.e09cb23c7dff3bf1285aa0294bcdc4ac8194fb3425a99c621e31e7b871315685.css as=style><link href=/scss/main.min.e09cb23c7dff3bf1285aa0294bcdc4ac8194fb3425a99c621e31e7b871315685.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css></head><body class="td-section td-blog"><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 321.39 78.54"><title id="title19">DUBBO LOGO</title><path class="cls-1" d="M68.46 50.38c0 14.06 11.39 22.11 25.45 22.11s25.45-8.05 25.45-22.11V7.25H68.46zm21.24-28h8.6V31H89.7zm0 22.25h8.6v8.6H89.7zM33.24 7.25H4.06v64H33.24c10.95.0 19.3-7.18 23.29-17.15a45.12 45.12.0 002.38-14.87A45.12 45.12.0 0056.53 24.4C52.84 14.62 44.19 7.25 33.24 7.25zm.43 14.63H30.34a3.44 3.44.0 00-3.44 3.44V53.23a3.44 3.44.0 003.44 3.44h3.33v4.63h-8.3a6.87 6.87.0 01-6.87-6.87V24.12a6.87 6.87.0 016.87-6.87h8.3zM285.51 6.06c-17.05.0-30.88 10.28-30.88 33.21s13.83 33.21 30.88 33.21 30.88-10.28 30.88-33.21S302.56 6.06 285.51 6.06zm7.59 48.36a6.87 6.87.0 01-6.87 6.87h-8.3V56.67h3.33a3.44 3.44.0 003.44-3.44V25.31a3.44 3.44.0 00-3.44-3.44h-3.33V17.25h8.3a6.87 6.87.0 016.87 6.87zm-53.4-17.56A17.39 17.39.0 00227.31 7.25H195.1v64h32.21a19.44 19.44.0 0012.38-34.44zM211.63 61.29h-6.08l18.68-44h6.08zM177 36.85A17.39 17.39.0 00164.65 7.25H132.43v64h32.21A19.44 19.44.0 00177 36.85zM149 61.29h-6.08l18.68-44h6.08z" style="fill:#fff;fill-opacity:1"/></svg></span><span class="text-uppercase font-weight-bold">蚂蚁背大象</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/about/><span>Home</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/blog/><span class=active>Java</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/spring/><span>Spring</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/middlewares/><span>Middleware</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/><span>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/other/><span>Others</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community/><span>Community</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002 站内搜索…" aria-label=站内搜索… autocomplete=off></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/blog/java-se/others/>Return to the regular view of this page</a>.</p></div><h1 class=title>其他</h1><ul><li><a href=#pg-86e119b2c93b452b71397216f6b3cbb0>Java线程池使用不当会发生什么-生产案例</a></li><li><a href=#pg-a056ab89238bb6e55fde70955ab133e1>volatile详解</a></li><li><a href=#pg-d47a2d33379d6be1d88ace1f78f2a4e6>Java操作符</a></li><li><a href=#pg-4a49462ce465c411741ace129ca8f471>Java修饰符</a></li><li><a href=#pg-22d7bcd3dc909e955ce4187ae63abc3a>字符串拼接那些事</a></li><li><a href=#pg-ac06c8373501e5af9c68abef51d41006>String StringBuffer StringBuilder</a></li></ul><div class=content></div></div><div class=td-content><h1 id=pg-86e119b2c93b452b71397216f6b3cbb0>Java线程池使用不当会发生什么-生产案例</h1><div class="td-byline mb-4"><time datetime=2022-01-29 class=text-muted>2022-01-29</time></div><p>线程池使用不当会发生什么？如下图所示(可以自己先分析)：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/java/jvm/Dingtalk_20220129101427.jpeg alt=Dingtalk_20220129101427></p><blockquote><p>这个是我公司在实际工作中发现的一个问题。但是这个接口调用频率不高所以在线上并没有发现问题(发版重新发布项目就会释放服务器的资源)</p></blockquote><p>将线程池化的目的就是减少线程创建和销毁的资源消耗，同时也防止用户无限制的创建线程把系统资源全部消耗掉。所以Java定义了线程池提供给开发者使用。但是如果线程池使用不当会发生什么呢？这种代码写在这里分分钟四十米的大刀架在脖子上。吐槽完，我们接下来写一个类似的来看看会发生什么以及分析一下导致这种情况发生的原因以及如何规避。</p><h3 id=1-例子演示>1. 例子演示</h3><blockquote><p>演示代码地址：https://github.com/mxsm/spring-sample/tree/master/spring-boot-protobuf</p></blockquote><p>定义一个Controller</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@RestController</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ThreadPoolController</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Autowired</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ThreadPoolService</span> <span style=color:#000>threadPoolService</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@GetMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/createThreadPool&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>createThreadPool</span><span style=color:#ce5c00;font-weight:700>(){</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>threadPoolService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createThread</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>定义一个ThreadPool的Service，模拟上图的问题</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Service</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ThreadPoolService</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>createThread</span><span style=color:#ce5c00;font-weight:700>(){</span>

		<span style=color:#8f5902;font-style:italic>//增加ThreadFactory为了好区分
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>ExecutorService</span> <span style=color:#000>executorService</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Executors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newSingleThreadScheduledExecutor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ThreadFactory</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>

            <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>             * Constructs a new {@code Thread}.  Implementations may also initialize priority, name, daemon
</span><span style=color:#8f5902;font-style:italic>             * status, {@code ThreadGroup}, etc.
</span><span style=color:#8f5902;font-style:italic>             *
</span><span style=color:#8f5902;font-style:italic>             * @param r a runnable to be executed by new thread instance
</span><span style=color:#8f5902;font-style:italic>             * @return constructed thread, or {@code null} if the request to create a thread is rejected
</span><span style=color:#8f5902;font-style:italic>             */</span>
            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Thread</span> <span style=color:#000>newThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Runnable</span> <span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;mxsm&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>});</span>
        <span style=color:#000>executorService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>submit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;王尼玛&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>});</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后通过调用接口 <strong><code>/createThreadPool</code></strong> 模拟上面工作中的真实实例的问题。看看会发生什么。将项目打包成jar包然后运行在本地。</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/java/jvm/example%E6%89%93%E5%8C%85%E8%BF%87%E7%A8%8B.gif alt=example打包过程></p><p>然后运行项目：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/java/jvm/example%E8%BF%90%E8%A1%8C.gif alt=example运行></p><p>运行后不停的请求上面的接口：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/java/jvm/%E8%AF%B7%E6%B1%82%E6%A8%A1%E6%8B%9F.gif alt=请求模拟></p><p>看到有执行的打印说明已经请求到了。然后我们通过命令： <strong><code>jps</code></strong> 以及 <strong><code>jstack -l &lt;pid></code></strong> 来查看线程池的情况</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/java/jvm/%E7%BA%BF%E7%A8%8B%E7%8A%B6%E6%80%81%E6%9F%A5%E7%9C%8B.gif alt=线程状态查看></p><p>注意观察下线程的状态如下图：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/java/jvm/image-20220129105917968.png alt=image-20220129105917968></p><p>都是在等待的过程中，这说明了什么问题？<strong><code>线程并没有随着方法执行完成而消亡</code></strong> 这个就很可怕了，如果你的接口不停的被调用，这个线程的创建数会源源不断的增加，当增加到你服务器资源全部被使用完就会导致服务宕机报(java.lang.OutOfMemoryError)。接下来分析如何为什么会写出这样的代码</p><blockquote><p>Tips: 这里可能很多人没有发现 <strong>Executors.newSingleThreadScheduledExecutor</strong> 这个创建的是一个单线程的线程池。所以导致的线程增长速度是调用一次接口增加1，如果是100个线程线程池呢？那可能会很快导致服务不可用宕机。我只想说还好是单线程线程池接口调用频率不高</p></blockquote><h3 id=2-原因分析以及解决>2. 原因分析以及解决</h3><h4 id=21-可能原因分析>2.1 可能原因分析</h4><ol><li><p>对于Spring Bean的几种模式不是很了解，在默认情况下Bean是单例模式，对Bean的生命周期不是很了解。在前面这种情况下，Bean会伴随Spring容器启动到消亡整个生命周期。环境话说我服务不停 <strong><code>UserActionImpl</code></strong> 整个对象实例会以单例的模式一直存在。</p></li><li><p>不了解线程池的原理，只知道Spring Bean的方法是线程隔离的。方法执行完成里面的变量都被回收了。这就是线程池和其他变量不一样的地方。具体的原理可以去研究一下线程池的源码。那这个我们怎么验证呢？</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/java/jvm/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E8%BF%90%E8%A1%8C.gif alt=线程池运行></p><p>从上面的图可以看出来，<strong><code>“完成”</code></strong> 两字都打印出来了按理来说服务要停止了但是服务并没有。这就是因为线程池的原因。</p></li><li><p>也有可能本来只是想异步执行 <strong><code>Runnable</code></strong> 里面代码，有听说线程池的好处很多就直接用了错误的代码，(这里你还不如new Thread算了)</p></li><li><p>同时也有可能是写代码的时候粗心没有注意，本来是想将线程池定义成为类的属性变量的。但是粗心写错了地方</p></li></ol><h4 id=22-解决方法>2.2 解决方法</h4><ol><li>不用线程池直接new Thread去执行 Runnable 实例</li><li>将线程池定义为类的属性变量</li></ol><h3 id=3-正确使用线程池应该注意的地方>3. 正确使用线程池应该注意的地方</h3><ul><li>每一个线程池最好是以单例的形式存在，不要像上面一样每次执行一次方法创建一次线程池。这样很容易消耗光生产的服务器资源</li><li>线程池的最大线程需要在创建线程池的时候确定，线程数需要根据业务需求设置</li><li>线程池的等待队列大小设置根据业务需求以及具体问题来设置（一般无界队列是不允许的，当发生阻塞的情况无界队列同样的道理可能会消耗光服务的所有资源）</li></ul><h3 id=4-总结>4. 总结</h3><p>对每一行代码抱有敬畏之心才能让代码更加高效、简洁、优雅！如果只是为了用某些技术而用，只知其然，而不知其所以然好不如用最笨的方式实现。至少不会导致程序的问题或者服务不可用。在对一些不确定的问题或者有疑问就自己写一个简单的模拟程序去验证自己的猜想。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-a056ab89238bb6e55fde70955ab133e1>volatile详解</h1><div class="td-byline mb-4"><time datetime=2019-11-06 class=text-muted>2019-11-06</time></div><h3 id=volatile的官方定义>volatile的官方定义</h3><p>java语言规范第三版中对volatile的定义如下：java编程语言允许线程访问共享变量，为了确保共享变量能被准确和一致的更新，线程应确保通过排他锁单独获得这个变量。java语言提供了volatile，在某些情况下比锁更加方便。如果一个字段被声明为volatile，java线程内存模型确保所有线程看到这个变量的值是一致的。</p><p><code>Java</code>语言中<code>volatile</code>可以被看着是一种程度比较轻的<code>synchronized</code>；与synchronized相比<code>volatile</code> 变量所需的编码较少，并且运行时开销也较少，但是<strong>它所能实现的功能也仅是 <code>synchronized</code> 的一部分</strong></p><h3 id=volatile-变量>volatile 变量</h3><p>Volatile 变量具有 <code>synchronized</code> 的可见性特性，但是<strong>不具备原子特性</strong>。这就是说线程能够自动发现 volatile 变量的最新值。Volatile 变量可用于提供线程安全，但是只能应用于非常有限的一组用例：多个变量之间或者某个变量的当前值与修改后值之间没有约束。因此，<strong>单独使用 volatile 还不足以实现计数器、互斥锁或任何具有与多个变量相关的不变式（Invariants）的类</strong>（例如 “start &lt;=end”）。</p><p>出于简易性或可伸缩性的考虑，您可能倾向于使用 volatile 变量而不是锁。当使用 volatile 变量而非锁时，某些习惯用法（idiom）更加易于编码和阅读。此外，volatile 变量不会像锁那样造成线程阻塞，因此也很少造成可伸缩性问题。在某些情况下，如果读操作远远大于写操作，volatile 变量还可以提供优于锁的性能优势。</p><p>例子：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>VolatileTest</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>{</span>

       <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>threads</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>20</span><span style=color:#ce5c00;font-weight:700>];</span>
       <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>threads</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>){</span>
           <span style=color:#000>threads</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>(()-&gt;{</span>
               <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>;</span><span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>1000</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>++){</span>
                   <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>++;</span><span style=color:#8f5902;font-style:italic>//这一步操作不是原子操作,而volatile不能保证复合操作的原子性
</span><span style=color:#8f5902;font-style:italic></span>               <span style=color:#ce5c00;font-weight:700>}</span>
           <span style=color:#ce5c00;font-weight:700>});</span>
           <span style=color:#000>threads</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
       <span style=color:#ce5c00;font-weight:700>}</span>
       <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>threads</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#000>threads</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#c4a000>join</span><span style=color:#ce5c00;font-weight:700>();</span>
       <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>运行的结果大部分都不等于20X1000</p><p><strong>所以<code>volatile</code> 无法保证复合性操作的原子性</strong></p><h3 id=正确使用-volatile-变量的条件>正确使用 volatile 变量的条件</h3><p>在有限的一些情形下使用 volatile 变量替代锁。要使 volatile 变量提供理想的线程安全，必须同时满足下面两个条件</p><ul><li><p>对变量的写操作不依赖于当前值</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//不依赖于当前值
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//依赖当前值
</span></code></pre></div></li><li><p>该变量没有包含在具有其他变量的不变式中</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span> 
<span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span> 
</code></pre></div></li></ul><p>第一个条件的限制使 volatile 变量不能用作线程安全计数器。虽然增量操作（<code>x++</code>）看上去类似一个单独操作，实际上它是一个由读取－修改－写入操作序列组成的组合操作，必须以原子方式执行，而 volatile 不能提供必须的原子特性。实现正确的操作需要使 <code>x</code> 的值在操作期间保持不变，而 volatile 变量无法实现这点。（然而，如果将值调整为只从单个线程写入，那么可以忽略第一个条件。）—上面的代码说明这个问题</p><h3 id=性能考虑>性能考虑</h3><p>使用 volatile 变量的主要原因是其简易性：在某些情形下，使用 volatile 变量要比使用相应的锁简单得多。使用 volatile 变量次要原因是其性能：某些情况下，volatile 变量同步机制的性能要优于锁。</p><p>很难做出准确、全面的评价，例如 “X 总是比 Y 快”，尤其是对 JVM 内在的操作而言。（例如，某些情况下 VM 也许能够完全删除锁机制，这使得我们难以抽象地比较 <code>volatile</code> 和 <code>synchronized</code> 的开销。）就是说，在目前大多数的处理器架构上，volatile 读操作开销非常低 —— 几乎和非 volatile 读操作一样。而 volatile 写操作的开销要比非 volatile 写操作多很多，因为要保证可见性需要实现内存界定（Memory Fence），即便如此，volatile 的总开销仍然要比锁获取低。</p><p>volatile 操作不会像锁一样造成阻塞，因此，在能够安全使用 volatile 的情况下，volatile 可以提供一些优于锁的可伸缩特性。如果读操作的次数要远远超过写操作，与锁相比，volatile 变量通常能够减少同步的性能开销。</p><h3 id=正确使用volatile的模式>正确使用volatile的模式</h3><p>要始终牢记使用 volatile 的限制 —— 只有在状态真正独立于程序内其他内容时才能使用 volatile —— 这条规则能够避免将这些模式扩展到不安全的用例</p><h4 id=状态标志>状态标志</h4><p>也许实现 volatile 变量的规范使用仅仅是使用一个布尔状态标志，用于指示发生了一个重要的一次性事件，例如完成初始化或请求停机。</p><p>实际应用：IM工程中在akka actor收到销毁命令的时候设置标记让netty不再往外推消息。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AbstractMessageDistribute</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractActor</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>MessageDistribute</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Logger</span> <span style=color:#000>logger</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>LoggerFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLogger</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getClass</span><span style=color:#ce5c00;font-weight:700>());</span>
	
	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>T</span> <span style=color:#000>channelContext</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>	 * Channel是否active
</span><span style=color:#8f5902;font-style:italic>	 */</span>
	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span>  <span style=color:#204a87;font-weight:700>boolean</span>  <span style=color:#000>isActive</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//状态标记
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setActive</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>active</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>isActive</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>active</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>NettyAkkaActor</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ChannelTransportDistribute</span><span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>postStop</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>setActive</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//设置
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>postStop</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>receiveEtcdCacheMessageWrapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>EtcdCacheMessageWrapper</span> <span style=color:#000>wrapper</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>ImMessage</span> <span style=color:#000>notification</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>wrapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getImMessage</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isActive</span><span style=color:#ce5c00;font-weight:700>()){</span> <span style=color:#8f5902;font-style:italic>//判断
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#8f5902;font-style:italic>//...........
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div><h3 id=一次性安全发布>一次性安全发布</h3><p>缺乏同步会导致无法实现可见性，这使得确定何时写入对象引用而不是原语值变得更加困难。在缺乏同步的情况下，可能会遇到某个对象引用的更新值（由另一个线程写入）和该对象状态的旧值同时存在。（这就是造成著名的双重检查锁定（double-checked-locking）问题的根源，其中对象引用在没有同步的情况下进行读操作，产生的问题是您可能会看到一个更新的引用，但是仍然会通过该引用看到不完全构造的对象）。</p><p>代码示例1：将 volatile 变量用于一次性安全发布</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BackgroundFloobleLoader</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Flooble</span> <span style=color:#000>theFlooble</span><span style=color:#ce5c00;font-weight:700>;</span>
 
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>initInBackground</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// do lots of stuff
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>theFlooble</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Flooble</span><span style=color:#ce5c00;font-weight:700>();</span>  <span style=color:#8f5902;font-style:italic>// this is the only write to theFlooble
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
 
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SomeOtherClass</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>doWork</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> 
            <span style=color:#8f5902;font-style:italic>// do some stuff...
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// use the Flooble, but only if it is ready
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>floobleLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>theFlooble</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> 
                <span style=color:#000>doSomething</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>floobleLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>theFlooble</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>代码示例2：单例模式—懒汉模式—double-checked</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//double checked
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>LazySingleton</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span>  <span style=color:#204a87;font-weight:700>static</span>  <span style=color:#000>LazySingleton</span> <span style=color:#000>lazySingleton</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>LOCK</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>LazySingleton</span><span style=color:#ce5c00;font-weight:700>(){</span>

    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>LazySingleton</span> <span style=color:#000>doubleCheckedLazySingleton</span><span style=color:#ce5c00;font-weight:700>(){</span>

        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lazySingleton</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LOCK</span><span style=color:#ce5c00;font-weight:700>){</span>
                <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lazySingleton</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>){</span>
                    <span style=color:#000>lazySingleton</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LazySingleton</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>lazySingleton</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>//测试代码
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>LazyModel</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Object</span> <span style=color:#000>target</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>LazySingleton</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>set</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConcurrentHashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
        <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>threads</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>10000</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>threads</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;++</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#000>threads</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>(()-&gt;{</span>
                <span style=color:#000>set</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LazySingleton</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doubleCheckedLazySingleton</span><span style=color:#ce5c00;font-weight:700>(),</span><span style=color:#000>target</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>});</span>
            <span style=color:#000>threads</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>threads</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;++</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>){</span>

            <span style=color:#000>threads</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#c4a000>join</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>set</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>());</span> <span style=color:#8f5902;font-style:italic>//输出的size等于1
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=开销较低的读-写锁策略>开销较低的读-写锁策略</h3><p>目前为止，您应该了解了 volatile 的功能还不足以实现计数器。因为 <code>++x</code> 实际上是三种操作（读、添加、存储）的简单组合，如果多个线程凑巧试图同时对 volatile 计数器执行增量操作，那么它的更新值有可能会丢失。</p><p>然而，如果读操作远远超过写操作，您可以结合使用内部锁和 volatile 变量来减少公共代码路径的开销。清单 6 中显示的线程安全的计数器使用 <code>synchronized</code> 确保增量操作是原子的，并使用 <code>volatile</code> 保证当前结果的可见性。如果更新不频繁的话，该方法可实现更好的性能，因为读路径的开销仅仅涉及 volatile 读操作，这通常要优于一个无竞争的锁获取的开销。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>CheesyCounter</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// Employs the cheap read-write lock trick
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// All mutative operations MUST be done with the &#39;this&#39; lock held
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@GuardedBy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;this&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
 
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>getValue</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>}</span>
 
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>increment</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>++;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>之所以将这种技术称之为 “开销较低的读－写锁” 是因为您使用了不同的同步机制进行读写操作。因为本例中的写操作违反了使用 volatile 的第一个条件，因此不能使用 volatile 安全地实现计数器 —— 您必须使用锁。然而，您可以在读操作中使用 volatile 确保当前值的<em>可见性</em>，因此可以使用锁进行所有变化的操作，使用 volatile 进行只读操作。其中，锁一次只允许一个线程访问值，volatile 允许多个线程执行读操作，因此当使用 volatile 保证读代码路径时，要比使用锁执行全部代码路径获得更高的共享度 —— 就像读－写操作一样。然而，要随时牢记这种模式的弱点：如果超越了该模式的最基本应用，结合这两个竞争的同步机制将变得非常困难。</p><h3 id=volatile-底层实现>volatile 底层实现</h3><p>对于<code>volatile</code>变量，当对<code>volatile</code>变量进行写操作的时候，JVM会向处理器发送一条lock前缀的指令，将这个缓存中的变量回写到系统主存中。</p><p>写回主存后，其他处理器缓存的值还是旧的。再执行计算操作就会有问题，所以在多处理器下为了保证各个处理器的缓存是一致的，就会实现缓存一致性协议。</p><blockquote><p>缓存一致性协议：每一个处理器通过嗅探在总线上面的传播的数据来检查自己缓存的值是不是过期了，当处理器发现自己缓存行对应的内存地址被修改，就会将当前的处理器的缓存设置为无效状态，当处理器要对这个数据进行修改操作的时候，会强制重新去系统内存里把数据督导处理器缓存里。</p></blockquote><p>所以如果一个变量被 <strong><code>volatile</code></strong> 所修饰的话，在每次数据变化之后，其值都会被强制刷入主存。而其他的处理器的缓存由于遵守了缓存一致性协议，也会把这个变量的值从主存加载到自己的缓存中， 这就保证了 <strong><code>volatile</code></strong> 在并发编程中期指在多个缓存中是可见的。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-d47a2d33379d6be1d88ace1f78f2a4e6>Java操作符</h1><div class="td-byline mb-4"><time datetime=2019-10-25 class=text-muted>2019-10-25</time></div></div><div class=td-content style=page-break-before:always><h1 id=pg-4a49462ce465c411741ace129ca8f471>Java修饰符</h1><div class="td-byline mb-4"><time datetime=2019-06-02 class=text-muted>2019-06-02</time></div><h3 id=java修饰符>java修饰符</h3><ul><li>**default(缺省):**在同一包内可见，不使用任何修饰符。使用对象：<strong>类、接口、变量、方法</strong></li><li>**private:**同一类里面可见。使用对象：<strong>类(不能修饰外部类)、接口、变量、方法</strong></li><li>**public:**对所有的类可见，使用对象：<strong>类、接口、变量、方法</strong></li><li><strong>protected</strong> : 对同一包内的类和所有子类可见。使用对象：变量、方法。 <strong>注意：不能修饰类（外部类)</strong></li></ul><h3 id=访问权限>访问权限</h3><table><thead><tr><th style=text-align:center>修饰符</th><th style=text-align:center>当前类</th><th style=text-align:center>同一包内</th><th style=text-align:center>子类(同一包)</th><th style=text-align:center>子类(不同包)</th><th style=text-align:center>其他包</th></tr></thead><tbody><tr><td style=text-align:center>public</td><td style=text-align:center>√</td><td style=text-align:center>√</td><td style=text-align:center>√</td><td style=text-align:center>√</td><td style=text-align:center>√</td></tr><tr><td style=text-align:center>protect</td><td style=text-align:center>√</td><td style=text-align:center>√</td><td style=text-align:center>√</td><td style=text-align:center>√或者X</td><td style=text-align:center>X</td></tr><tr><td style=text-align:center>default</td><td style=text-align:center>√</td><td style=text-align:center>√</td><td style=text-align:center>√</td><td style=text-align:center>X</td><td style=text-align:center>X</td></tr><tr><td style=text-align:center>private</td><td style=text-align:center>√</td><td style=text-align:center>X</td><td style=text-align:center>X</td><td style=text-align:center>X</td><td style=text-align:center>X</td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-22d7bcd3dc909e955ce4187ae63abc3a>字符串拼接那些事</h1><div class="td-byline mb-4"><time datetime=2019-06-01 class=text-muted>2019-06-01</time></div><h3 id=1-代码中字符串最常用的拼接方法>1. 代码中字符串最常用的拼接方法</h3><ul><li><strong><code>+</code></strong> 拼接</li><li><strong><code>apache</code></strong> 的工具类 <strong><code>StringUtils.join</code></strong> 方法</li><li><strong><code>String</code></strong> 类的对象方法 <strong><code>concat</code></strong></li><li><strong><code>StringBuffer</code></strong> 类的对象方法 <strong><code>append</code></strong></li><li><strong><code>StringBuilder</code></strong> 类的对象方法 <strong><code>append</code></strong></li></ul><p>等等一些组合方式。以上几种是编码过程中最常见的。下面就来看看这几种方式的字符串拼接的实现和效率</p><h3 id=2---操作符的拼接>2. <strong><code>+</code></strong> 操作符的拼接</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>StringConcatTest</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>String</span> <span style=color:#000>wc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;aaaaa&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>String</span> <span style=color:#000>wc1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;bbbbbb&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>String</span> <span style=color:#000>ct</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>wc</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;,&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>wc1</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>查看 <strong><code>.class</code></strong> 文件后的反编译代码如下</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>com.mxsm.cglib.enhancer</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>StringConcatTest</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>StringConcatTest</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>String</span> <span style=color:#000>wc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;aaaaa&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>String</span> <span style=color:#000>wc1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;bbbbbb&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringBuilder</span><span style=color:#ce5c00;font-weight:700>()).</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wc</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;,&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wc1</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>代码 <strong><code>String ct = wc + "," + wc1;</code></strong> —> <strong><code>(new StringBuilder()).append(wc).append(",").append(wc1).toString();</code></strong></p><p>转换成了 <strong><code>StringBuilder</code></strong> 的 <strong><code>append</code></strong> 方法。</p><p>在阿里巴巴的Java开发手册中不建议循环体中使用 <strong><code>+</code></strong> 进行字符串拼接原因是什么？</p><p><strong>原因就在于 <code>+</code> 每次创建一个 <code>StringBuilder</code> 对象然后 <code>toString()</code> 返回字符串对象，造成内存资源的浪费</strong></p><h3 id=3-string-的-concat-方法>3. <strong><code>String</code></strong> 的 <strong><code>concat</code></strong> 方法</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>StringConcatTest</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>String</span> <span style=color:#000>wc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;aaaaa&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>String</span> <span style=color:#000>wc1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;bbbbbb&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>String</span> <span style=color:#000>ct</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>wc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>concat</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;,&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>concat</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wc1</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>接下来看一下 <strong><code>concat</code></strong> 的源码是怎么实现拼接的</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>concat</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>str</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    	<span style=color:#8f5902;font-style:italic>//获取长度
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>otherLen</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>str</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>otherLen</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    	<span style=color:#8f5902;font-style:italic>//获取原有字段的长处
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span>
    	<span style=color:#8f5902;font-style:italic>//字符串的拷贝
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>char</span> <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>copyOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>otherLen</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>str</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChars</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>);</span>
    	<span style=color:#8f5902;font-style:italic>//返回一个new String的新对象
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=4-stringbuffer-和-stringbuilder-的-append-方法>4. <strong><code>StringBuffer</code></strong> 和 <strong><code>StringBuilder</code></strong> 的 <strong><code>append</code></strong> 方法</h3><ul><li><p><strong><code>StringBuffer</code></strong> 的 <strong><code>append</code></strong> 方法</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#000>StringBuffer</span> <span style=color:#000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>str</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>toStringCache</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>//调用的是父类的append方法
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>str</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
 <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>AbstractStringBuilder</span> <span style=color:#000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>str</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>str</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>appendNull</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>str</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>ensureCapacityInternal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>str</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChars</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>注意：<strong><code>StringBuffer</code></strong> 的 <strong><code>append</code></strong> 方法带有关键字 <strong><code>synchronized</code></strong> 说明是线程安全的。</p></li><li><p><strong><code>StringBuilder</code></strong> 的 <strong><code>append</code></strong> 方法</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>StringBuilder</span> <span style=color:#000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>str</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>str</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

 <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>AbstractStringBuilder</span> <span style=color:#000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>str</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>str</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>appendNull</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>str</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>ensureCapacityInternal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>str</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChars</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li></ul><p>从上面的源码可以看出来 <strong><code>StringBuffer</code></strong> 和 <strong><code>StringBuilder</code></strong> 的底层实现都是 调用了父类 <strong><code>AbstractStringBuilder</code></strong> 的 **<code>append</code>**方法。唯一的区别就是 <strong><code>StringBuffer</code></strong> 线程安全 ， <strong><code>StringBuilder</code></strong> 非线程安全。所以想要线程安全 就用 <strong><code>StringBuffer</code></strong> 没有线程安全的问题的考虑就用 <strong><code>StringBuilder</code></strong> 。</p><h3 id=5-stringutilsjoin>5. <strong><code>StringUtils.join</code></strong></h3><p>这里源码自行参考 <strong><code>apache</code></strong> 工具类 的源码</p><h3 id=6-各自的效率>6. 各自的效率</h3><p>重中之重的来了，那就是各个方法的拼接效率怎么样？为什么阿里巴巴的Java规范中不提倡用 <strong><code>+</code></strong> 进行字符串拼接</p><p>下面我们上代码来说明明天，看看到底谁牛逼速度快。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>StringConcatTest</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>66666</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>t1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>String</span> <span style=color:#000>s1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#000>s1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>s1</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;+ &#34;</span><span style=color:#ce5c00;font-weight:700>+(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>()-</span><span style=color:#000>t1</span><span style=color:#ce5c00;font-weight:700>)+</span><span style=color:#4e9a06>&#34;ms&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>


        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>t2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>StringBuffer</span> <span style=color:#000>s2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringBuffer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#000>s2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;StringBuffer &#34;</span><span style=color:#ce5c00;font-weight:700>+(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>()-</span><span style=color:#000>t2</span><span style=color:#ce5c00;font-weight:700>)+</span><span style=color:#4e9a06>&#34;ms&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>t3</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>StringBuilder</span> <span style=color:#000>s3</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringBuilder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#000>s3</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;StringBuilder &#34;</span><span style=color:#ce5c00;font-weight:700>+(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>()-</span><span style=color:#000>t3</span><span style=color:#ce5c00;font-weight:700>)+</span><span style=color:#4e9a06>&#34;ms&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>t4</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>String</span> <span style=color:#000>s4</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#000>s4</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>s4</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>concat</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;concat &#34;</span><span style=color:#ce5c00;font-weight:700>+(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>()-</span><span style=color:#000>t4</span><span style=color:#ce5c00;font-weight:700>)+</span><span style=color:#4e9a06>&#34;ms&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>运行的打印结果：</p><pre><code>+ 2949ms
StringBuffer 2ms
StringBuilder 1ms
concat 693ms
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-ac06c8373501e5af9c68abef51d41006>String StringBuffer StringBuilder</h1><div class="td-byline mb-4"><time datetime=2018-07-18 class=text-muted>2018-07-18</time></div><h3 id=1-三者的对比>1. 三者的对比</h3><table><thead><tr><th>类</th><th>是否可变</th><th>是否线程安全</th><th>效率</th></tr></thead><tbody><tr><td><strong><code>String</code></strong></td><td>对象不可变</td><td>线程安全</td><td>3</td></tr><tr><td><strong><code>StringBuilder</code></strong></td><td>对象可变</td><td>非线程安全</td><td>1</td></tr><tr><td><strong><code>StringBuffer</code></strong></td><td>对象可变</td><td>线程安全</td><td>2</td></tr></tbody></table><p><strong><code>StringBuffer</code></strong> 和 <strong><code>StringBuilder</code></strong> 的公共父类 <strong><code>AbstractStringBuilder</code></strong><br><strong><code>StringBuffer</code></strong> 的同步是通过在方法上面添加 <strong><code>synchronized</code></strong> 来实现。</p><h3 id=2-string不可变>2. String不可变</h3><p>String对象的任何修改都不会影响原对象，任何相关的操作都会生成新的对象。
例子：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>substring</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>beginIndex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beginIndex</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringIndexOutOfBoundsException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beginIndex</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>subLen</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>beginIndex</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>subLen</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringIndexOutOfBoundsException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>subLen</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beginIndex</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#204a87;font-weight:700>this</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beginIndex</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>subLen</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong><code>String</code></strong> 的 <strong><code>substring</code></strong> 方法，返回的新的对象是通过new了一下新的String的对象返回。如果开始的index=0返回的是当前的对象</p><h3 id=3-使用的原则>3. 使用的原则</h3><ol><li>基本原则：如果要操作少量的数据，用String ；单线程操作大量数据，用 <strong><code>StringBuilder</code></strong> ；多线程操作大量数据，用 <strong><code>StringBuffer</code></strong>。</li><li>不要使用String类的”+”来进行频繁的拼接，因为那样的性能极差的(每次都要生成新的类)例子如下：</li></ol><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>String</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>hugeArray</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
<span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#8f5902;font-style:italic>// 使用StringBuilder
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>StringBuilder</span> <span style=color:#000>sb</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringBuilder</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>hugeArray</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
<span style=color:#000>sb</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#000>String</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sb</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div><p>这样的情况显然用 <strong><code>StringBulider</code></strong> 比较好
3. <strong><code>StringBuilder</code></strong> 一般使用在方法内部来完成类似”+”功能，因为是线程不安全的，所以用完以后可以丢弃。 <strong><code>StringBuffer</code></strong> 主要用在全局变量中
4. 相同情况下使用 <strong><code>StirngBuilder</code></strong> 相比使用 <strong><code>StringBuffer</code></strong> 仅能获得 10%~15% 左右的性能提升，但却要冒多线程不安全的风险。而在现实的模块化编程中，负责某一模块的程序员不一定能清晰地判断该模块是否会放入多线程的环境中运行，因此：除非确定系统的瓶颈是在 StringBuffer 上，并且确定你的模块不会运行在多线程模式下，才可以采用 <strong><code>StringBuilder</code></strong> ；否则还是用 <strong><code>StringBuffer</code></strong></p><h3 id=4-附jmh性能对比>4. 附JMH性能对比</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@BenchmarkMode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Mode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Throughput</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Warmup</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>iterations</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>time</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Measurement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>iterations</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>time</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Threads</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>16</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Fork</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@State</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Scope</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Benchmark</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@OutputTimeUnit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SECONDS</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>StringTest</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Param</span><span style=color:#ce5c00;font-weight:700>({</span><span style=color:#4e9a06>&#34;10000&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;100000&#34;</span><span style=color:#ce5c00;font-weight:700>})</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>counter</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@Benchmark</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>stringTest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Blackhole</span> <span style=color:#000>blackhole</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#000>String</span> <span style=color:#000>st</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>counter</span><span style=color:#ce5c00;font-weight:700>;++</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#000>st</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>blackhole</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consume</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>st</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Benchmark</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>stringBufferTest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Blackhole</span> <span style=color:#000>blackhole</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#000>StringBuffer</span> <span style=color:#000>st</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringBuffer</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>counter</span><span style=color:#ce5c00;font-weight:700>;++</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#000>st</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>blackhole</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consume</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>st</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Benchmark</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>stringBuilderTest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Blackhole</span> <span style=color:#000>blackhole</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#000>StringBuilder</span> <span style=color:#000>st</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringBuilder</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>counter</span><span style=color:#ce5c00;font-weight:700>;++</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#000>st</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>blackhole</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consume</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>st</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>RunnerException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Options</span> <span style=color:#000>opt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>OptionsBuilder</span><span style=color:#ce5c00;font-weight:700>().</span>
            <span style=color:#000>include</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StringTest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSimpleName</span><span style=color:#ce5c00;font-weight:700>())</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>result</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;result.json&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resultFormat</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResultFormatType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>JSON</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>build</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Runner</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>opt</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>run</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>测试结果：</p><p><img src=C:%5CUsers%5Cmxsm%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220215230524058.png alt=image-20220215230524058></p><p><img src=E:%5Cdownload%5Cstringjmhtest.png alt=stringjmhtest></p><blockquote><p>我是蚂蚁背大象，文章对你有帮助点赞关注我，文章有不正确的地方请您斧正留言评论~谢谢！</p></blockquote></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list"><a class=text-white target=_blank rel="noopener noreferrer" href=https://groups.google.com/u/1/g/ljbmxsm><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=个人掘金主页 aria-label=个人掘金主页><a class=text-white target=_blank rel="noopener noreferrer" href=https://juejin.cn/user/1151943918492855><i class="fab fa-twitter"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/mxsm><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2022 The Docsy Authors All Rights Reserved</small>
<small class=ml-1><a href=https://policies.google.com/privacy target=_blank>隐私政策</a></small><p class=mt-2><a href=/about/>Home</a></p></div></div></div></footer><div><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css><script src=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js></script><script>$("p img").wrap(function(){return'<a data-fancybox="gallery" href="'+$(this).attr('src')+'"></a>'})</script></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/mermaid@8.8.1/dist/mermaid.min.js integrity=sha384-to2w0I1OqmbJ9J6yTnIX+KYU8grNpZoD1dKPLjgEJvMe5L5+/7qvuNa2sQo8WAWj crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/raphael/2.3.0/raphael.min.js integrity="sha512-tBzZQxySO5q5lqwLWfu8Q+o4VkTcRGOeQGVQ0ueJga4A1RKuzmAu5HXDOXLEjpbKyV7ow9ympVoa6wZLEzRzDg==" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.15.0/flowchart.min.js integrity="sha512-6QsSiIybtf8tuZ6xfjRTr2tdtw3Gp4q5RSCh2b6q9seoKEQmhAG1RrCA8F0kXTwivVxRVbp/YF3zOh8rvEAU7Q==" crossorigin=anonymous></script><script src=/js/main.min.b541b310f01941a0abfd76b652b5fb60dac470573775bb5b31ff08fe3f6cea51.js integrity="sha256-tUGzEPAZQaCr/Xa2UrX7YNrEcFc3dbtbMf8I/j9s6lE=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.js></script><script type=text/javascript>docsearch({appId:'JO2SY3WDAC',apiKey:'324ddb3b679c1308e5aa8bf222e07f8b',indexName:'mxsm',inputSelector:'.td-search-input',debug:!1})</script></body></html>