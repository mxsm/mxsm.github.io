<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.83.1"><link rel=canonical type=text/html href=/blog/java-se/jdksourcereading/><link rel=alternate type=application/rss+xml href=/blog/java-se/jdksourcereading/index.xml><meta name=ROBOTS content="INDEX, FOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>JDK源码 | 蚂蚁背大象</title><meta property="og:title" content="JDK源码"><meta property="og:description" content="蚂蚁背大象博客"><meta property="og:type" content="website"><meta property="og:url" content="/blog/java-se/jdksourcereading/"><meta property="og:site_name" content="蚂蚁背大象"><meta itemprop=name content="JDK源码"><meta itemprop=description content="蚂蚁背大象博客"><meta name=twitter:card content="summary"><meta name=twitter:title content="JDK源码"><meta name=twitter:description content="蚂蚁背大象博客"><link rel=preload href=/scss/main.min.e09cb23c7dff3bf1285aa0294bcdc4ac8194fb3425a99c621e31e7b871315685.css as=style><link href=/scss/main.min.e09cb23c7dff3bf1285aa0294bcdc4ac8194fb3425a99c621e31e7b871315685.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css></head><body class="td-section td-blog"><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 321.39 78.54"><title id="title19">DUBBO LOGO</title><path class="cls-1" d="M68.46 50.38c0 14.06 11.39 22.11 25.45 22.11s25.45-8.05 25.45-22.11V7.25H68.46zm21.24-28h8.6V31H89.7zm0 22.25h8.6v8.6H89.7zM33.24 7.25H4.06v64H33.24c10.95.0 19.3-7.18 23.29-17.15a45.12 45.12.0 002.38-14.87A45.12 45.12.0 0056.53 24.4C52.84 14.62 44.19 7.25 33.24 7.25zm.43 14.63H30.34a3.44 3.44.0 00-3.44 3.44V53.23a3.44 3.44.0 003.44 3.44h3.33v4.63h-8.3a6.87 6.87.0 01-6.87-6.87V24.12a6.87 6.87.0 016.87-6.87h8.3zM285.51 6.06c-17.05.0-30.88 10.28-30.88 33.21s13.83 33.21 30.88 33.21 30.88-10.28 30.88-33.21S302.56 6.06 285.51 6.06zm7.59 48.36a6.87 6.87.0 01-6.87 6.87h-8.3V56.67h3.33a3.44 3.44.0 003.44-3.44V25.31a3.44 3.44.0 00-3.44-3.44h-3.33V17.25h8.3a6.87 6.87.0 016.87 6.87zm-53.4-17.56A17.39 17.39.0 00227.31 7.25H195.1v64h32.21a19.44 19.44.0 0012.38-34.44zM211.63 61.29h-6.08l18.68-44h6.08zM177 36.85A17.39 17.39.0 00164.65 7.25H132.43v64h32.21A19.44 19.44.0 00177 36.85zM149 61.29h-6.08l18.68-44h6.08z" style="fill:#fff;fill-opacity:1"/></svg></span><span class="text-uppercase font-weight-bold">蚂蚁背大象</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/about/><span>Home</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/blog/><span class=active>Java</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/spring/><span>Spring</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/middlewares/><span>Middleware</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/><span>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/other/><span>Others</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community/><span>Community</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002 站内搜索…" aria-label=站内搜索… autocomplete=off></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/blog/java-se/jdksourcereading/>Return to the regular view of this page</a>.</p></div><h1 class=title>JDK源码</h1><ul><li><a href=#pg-e2db551a5614c0547def270eefed78d0>Collection源码解析</a></li><ul><li><a href=#pg-ef0765e119c71456fa37c9d8b4d668e6>CopyOnWriteArrayList源码解析</a></li><li><a href=#pg-a09c8fe68e32b6c32955b600d479e392>LinkedList源码解析</a></li><li><a href=#pg-701d431a662cfd6db01161eeb5f30026>CopyOnWriteArraySet源码解析</a></li><li><a href=#pg-a2e65ea2ba769706e5cefb5279e36fe9>HashSet源码解析</a></li><li><a href=#pg-017cbae302df6a652f5dc0633d66d09e>ArrayList源码分析</a></li></ul><li><a href=#pg-633056f9f3bceb7552739b40fa275a58>Map源码解析</a></li><ul><li><a href=#pg-f01491bd7481e6b4aa6cdcfe9a4767b7>HashMap和HashTable的区别</a></li><li><a href=#pg-dab4196a35db475a43321485d2789c7d>EnumMap</a></li><li><a href=#pg-9795b83feaeecce3b1feced8b9d12c7f>HashMap源码解析</a></li></ul></ul><div class=content></div></div><div class=td-content><h1 id=pg-e2db551a5614c0547def270eefed78d0>Collection源码解析</h1><div class="td-byline mb-4"></div></div><div class=td-content><h1 id=pg-ef0765e119c71456fa37c9d8b4d668e6>CopyOnWriteArrayList源码解析</h1><div class="td-byline mb-4"><time datetime=2022-03-25 class=text-muted>2022-03-25</time></div><p>Offer 驾到，掘友接招！我正在参与2022春招打卡活动，点击查看<a href=https://juejin.cn/post/7069661622012215309/>活动详情</a>。</p><h3 id=1-copyonwrite容器>1. CopyOnWrite容器</h3><p>基本思路就是在多个线程共享同一个内容，当某个线程想修改这个内容的时候，才会真正的把内容拷贝出去形成一个新的内容然后再修改，这是一种<strong>延迟懒惰策略</strong></p><h3 id=2-概念>2. 概念</h3><p>通俗的理解是当我们往一个容器添加元素的时候，不直接往当前容器添加，而是先将当前容器进行Copy，复制出一个新的容器，然后新的容器里添加元素，添加完元素之后，再将原容器的引用指向新的容器。这样做的好处是我们可以对CopyOnWrite容器<strong>进行并发的读，而不需要加锁</strong>，因为当前容器不会添加任何元素。
所以CopyOnWrite容器也是一种<strong>读写分离的思想，读和写在不同的容器</strong></p><h4 id=21-copyonwritearraylist>2.1 CopyOnWriteArrayList</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#8f5902;font-style:italic>/** 重入锁--同步所有的突变操作 */</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>transient</span> <span style=color:#000>ReentrantLock</span> <span style=color:#000>lock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ReentrantLock</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#8f5902;font-style:italic>/** 数据保存结构 */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>transient</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Gets the array.  Non-private so as to also be accessible
</span><span style=color:#8f5902;font-style:italic>     * from CopyOnWriteArraySet class.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>getArray</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Sets the array.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>array</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 初始化长度为0
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>CopyOnWriteArrayList</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>setArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>]);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 参数为一个集合
</span><span style=color:#8f5902;font-style:italic>     * 
</span><span style=color:#8f5902;font-style:italic>     * 
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param c the collection of initially held elements
</span><span style=color:#8f5902;font-style:italic>     * @throws NullPointerException if the specified collection is null
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>CopyOnWriteArrayList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>elements</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>CopyOnWriteArrayList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>elements</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>CopyOnWriteArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getArray</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>elements</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toArray</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#8f5902;font-style:italic>// c.toArray might (incorrectly) not return Object[] (see 6260652)
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elements</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[].</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#000>elements</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>copyOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elements</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>elements</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[].</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>setArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elements</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 参数为一个数组
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param toCopyIn the array (a copy of this array is used as the
</span><span style=color:#8f5902;font-style:italic>     *        internal array)
</span><span style=color:#8f5902;font-style:italic>     * @throws NullPointerException if the specified array is null
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>CopyOnWriteArrayList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>toCopyIn</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>setArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>copyOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>toCopyIn</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>toCopyIn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[].</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>注意</strong>：由于当我们往一个容器添加元素的时候，不直接往当前容器添加，而是先将当前容器进行Copy，复制出一个新的容器，然后新的容器里添加元素，添加完元素之后，再将原容器的引用指向新的容器。所以在往CopyOnWriteArrayList添加数据的时候不要一个个添加，<strong>最好的方式是通过带参数的构造方法或者调用addAll的方式添加数据，减少底层的每次拷贝而占用内存和频繁的导致GC操作</strong>。</p><h4 id=22-add方法>2.2 Add方法</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>E</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ReentrantLock</span> <span style=color:#000>lock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lock</span><span style=color:#ce5c00;font-weight:700>;</span>
    	<span style=color:#8f5902;font-style:italic>//加锁
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lock</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//获取原有的数据数组
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>elements</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getArray</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#8f5902;font-style:italic>//数组的长度
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>elements</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>//拷贝---长度为len + 1
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>newElements</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>copyOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elements</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>//将新添加的数据设置到最后
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>newElements</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>//将array指向新的newElements --内存可见(array变量被volatile修饰)
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>setArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>newElements</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//释放锁
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unlock</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>    

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>E</span> <span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ReentrantLock</span> <span style=color:#000>lock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lock</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>//加锁
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lock</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>elements</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getArray</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>elements</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IndexOutOfBoundsException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Index: &#34;</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>+</span>
                                                    <span style=color:#4e9a06>&#34;, Size: &#34;</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>newElements</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>numMoved</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>numMoved</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#000>newElements</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>copyOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elements</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>newElements</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>];</span>
                <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>arraycopy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elements</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>newElements</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>arraycopy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elements</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>newElements</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>,</span>
                                 <span style=color:#000>numMoved</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#000>newElements</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>setArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>newElements</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//释放锁
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unlock</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>注意：</p><ul><li>采用<code>ReentrantLock</code>保证了同一时刻只有一个写的线程在复制。</li><li>数组变量array的应用是用<code>volatile</code>修饰过的，应酬将旧的数组应用指向新的数组；根据<code>volatile</code>的<code>happens-before</code>规则，线程对数组引用的修改对线程是可见的。</li><li>由于在写数据的时候，是在新的数组中插入数据的，从而保证读写实在两个不同的数据容器中进行操作。</li></ul><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/java/collection/CopyOnWriteArrayList%E8%AF%BB%E5%86%99%E7%A4%BA%E5%9B%BE.png alt=CopyOnWriteArrayList读写示图></p><h3 id=3-总结>3. 总结</h3><p><strong>优点：</strong></p><ul><li>读写是分离的</li><li>读线程之间是互不阻塞的</li><li>牺牲数据的实时性而保证了最终数据的一致性。即读线程对数据的更新是延迟感知的，因此这种情况下读线程不存在等待的情况。</li></ul><p><strong>缺点：</strong></p><ul><li>内存占用的问题：因为CopyOnWrite是写的时候复制机制，所以在写操作的时候。内存中会存在两个对象的内存，旧的对象和新写入的对象。注意:在复制的时候只是复制容器里的引用，只是在写的时候会创建新对象添加到新容器里，而旧容器的对象还在使用，所以有两份对象内存）如果对象内存占用比较大有可能造成频繁的GC。</li><li>CopyOnWrite容器保证最终的数据一致性而不能保证数据的实时一致性</li></ul><blockquote><p>我是蚂蚁背大象，文章对你有帮助点赞关注我，文章有不正确的地方请您斧正留言评论~谢谢</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-a09c8fe68e32b6c32955b600d479e392>LinkedList源码解析</h1><div class="td-byline mb-4"><time datetime=2019-11-17 class=text-muted>2019-11-17</time></div><h3 id=链表的数据结构>链表的数据结构</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>E</span> <span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>prev</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>prev</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>E</span> <span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>item</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prev</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>prev</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul><li>底层的数据结构为双向链表</li></ul><p><img src="https://github.com/mxsm/document/blob/master/image/datastructure/Doubly-linked-list.svg.png?raw=true" alt=双向链表图示></p><h3 id=linkedlist源码解析>LinkedList源码解析</h3><h5 id=adde-e>add(E e)</h5><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#8f5902;font-style:italic>//直接插入--调用的是插入到最后一个节点的后面
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>E</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//直接调用的往节点后面添加
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>linkLast</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#8f5902;font-style:italic>//插入节点后面
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>linkLast</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>E</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>l</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>last</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>//创建新的节点
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>newNode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>l</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>last</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newNode</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>//如果最后一个节点为NULL说明加入的是第一个节点
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>l</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>first</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newNode</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>else</span>
            <span style=color:#8f5902;font-style:italic>//将新的节点放在最后一个节点后面
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>l</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newNode</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>//增加数量
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>++;</span>
        <span style=color:#000>modCount</span><span style=color:#ce5c00;font-weight:700>++;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#8f5902;font-style:italic>//插入节点前面
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>linkBefore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>E</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>succ</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// assert succ != null;
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>pred</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>succ</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prev</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>newNode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>pred</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>succ</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>succ</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prev</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newNode</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pred</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>first</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newNode</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>else</span>
            <span style=color:#000>pred</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newNode</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>++;</span>
        <span style=color:#000>modCount</span><span style=color:#ce5c00;font-weight:700>++;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h5 id=addint-index-e-e>add(int index, E e)</h5><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#8f5902;font-style:italic>//插入到某个指定位置
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>E</span> <span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//检查是否越界
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>checkPositionIndex</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>//如果和链表的大小相同直接插入到最后
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>linkLast</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>else</span>
            <span style=color:#000>linkBefore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
	
	<span style=color:#8f5902;font-style:italic>//获取当前位置的Node
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        
		<span style=color:#8f5902;font-style:italic>//将size左移一位判断和index之间的关系(巧妙的节省了便利查找的时间)
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span>
                <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>last</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>--)</span>
                <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prev</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div><p><strong>注意：终点关注node函数的算法，来减少获取到节点的耗时</strong></p><h4 id=unlink--删除实现>unlink&ndash;删除实现</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#000>E</span> <span style=color:#000>unlink</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
       
        <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>          *大概的思路：把删除节点prev节点的next设置为删除节点的next
</span><span style=color:#8f5902;font-style:italic>          *把删除节点的next的prev节点设置设置为删除节点prev
</span><span style=color:#8f5902;font-style:italic>          */</span>
        
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>E</span> <span style=color:#000>element</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>item</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>prev</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prev</span><span style=color:#ce5c00;font-weight:700>;</span>
		
        <span style=color:#8f5902;font-style:italic>//处理pre
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prev</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>first</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>prev</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prev</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
		
        <span style=color:#8f5902;font-style:italic>//处理next 
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>next</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>last</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>prev</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prev</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>prev</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>item</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>--;</span>
        <span style=color:#000>modCount</span><span style=color:#ce5c00;font-weight:700>++;</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=总结>总结</h4><p>LinkedList是采用双向链表实现的。所以它也具有链表的特点，每一个元素（结点）的地址不连续，通过引用找到当前结点的上一个结点和下一个结点，即插入和删除效率较高，只需要常数时间，而get和set则较为低效。
LinkedList的方法和使用和ArrayList大致相同，由于LinkedList是链表实现的，所以额外提供了在头部和尾部添加/删除元素的方法，也没有ArrayList扩容的问题了。另外，ArrayList和LinkedList都可以实现栈、队列等数据结构，但LinkedList本身实现了队列的接口，所以更推荐用LinkedList来实现队列和栈。</p><p><strong>在需要频繁读取集合中的元素时，使用ArrayList效率较高，而在插入和删除操作较多时，使用LinkedList效率较高</strong>。同样这些也符合数组和链表的特点</p></div><div class=td-content style=page-break-before:always><h1 id=pg-701d431a662cfd6db01161eeb5f30026>CopyOnWriteArraySet源码解析</h1><div class="td-byline mb-4"><time datetime=2019-05-22 class=text-muted>2019-05-22</time></div><h3 id=1-copyonwritearrayset的构造函数>1. CopyOnWriteArraySet的构造函数</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>CopyOnWriteArraySet</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractSet</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
        <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>io</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Serializable</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>CopyOnWriteArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>al</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>CopyOnWriteArraySet</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>al</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CopyOnWriteArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>CopyOnWriteArraySet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>CopyOnWriteArraySet</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>CopyOnWriteArraySet</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>cc</span> <span style=color:#ce5c00;font-weight:700>=</span>
                <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CopyOnWriteArraySet</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;)</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>al</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CopyOnWriteArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>cc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>al</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>al</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CopyOnWriteArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
            <span style=color:#000>al</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAllAbsent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>    
</code></pre></div><p>通过源码可以看出来 <em><strong><code>CopyOnWriteArraySet</code></strong></em> 实现通过 <em><strong><code>CopyOnWriteArrayList</code></strong></em> 来实现。</p><h3 id=2-copyonwritearraysetadd源码解析>2. CopyOnWriteArraySet#add源码解析</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>E</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>al</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addIfAbsent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过 <strong>CopyOnWriteArrayList#<em>addIfAbsent</em></strong> 方法来实现添加。下面看一下源码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>addIfAbsent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>E</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>snapshot</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getArray</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>indexOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>snapshot</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>snapshot</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#204a87;font-weight:700>false</span> <span style=color:#ce5c00;font-weight:700>:</span>
            <span style=color:#000>addIfAbsent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>snapshot</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>源码比较简单，首先获取已存在的对象，判断要插入的对象是否存在，存在返回false不存在直接添加。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>addIfAbsent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>E</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>snapshot</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ReentrantLock</span> <span style=color:#000>lock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lock</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lock</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>current</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getArray</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>snapshot</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// Optimize for lost race to another addXXX operation
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>common</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>min</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>snapshot</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>common</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>snapshot</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>eq</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]))</span>
                        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>indexOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>common</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
                        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>newElements</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>copyOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>newElements</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>setArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>newElements</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unlock</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-a2e65ea2ba769706e5cefb5279e36fe9>HashSet源码解析</h1><div class="td-byline mb-4"><time datetime=2018-11-27 class=text-muted>2018-11-27</time></div><h3 id=hashset>HashSet</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>transient</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#8f5902;font-style:italic>// Dummy value to associate with an Object in the backing Map
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>PRESENT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div><p>首先看一下HashSet 中的两个变量，一个HashMap类型的，另一个是静态变量Object类型。接下来看一下HashSet的构造方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>HashSet</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>map</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Constructs a new set containing the elements in the specified
</span><span style=color:#8f5902;font-style:italic>     * collection.  The &lt;tt&gt;HashMap&lt;/tt&gt; is created with default load factor
</span><span style=color:#8f5902;font-style:italic>     * (0.75) and an initial capacity sufficient to contain the elements in
</span><span style=color:#8f5902;font-style:italic>     * the specified collection.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param c the collection whose elements are to be placed into this set
</span><span style=color:#8f5902;font-style:italic>     * @throws NullPointerException if the specified collection is null
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>HashSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>map</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>max</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()/.</span><span style=color:#c4a000>75f</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>16</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Constructs a new, empty set; the backing &lt;tt&gt;HashMap&lt;/tt&gt; instance has
</span><span style=color:#8f5902;font-style:italic>     * the specified initial capacity and the specified load factor.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param      initialCapacity   the initial capacity of the hash map
</span><span style=color:#8f5902;font-style:italic>     * @param      loadFactor        the load factor of the hash map
</span><span style=color:#8f5902;font-style:italic>     * @throws     IllegalArgumentException if the initial capacity is less
</span><span style=color:#8f5902;font-style:italic>     *             than zero, or if the load factor is nonpositive
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>HashSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>initialCapacity</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>float</span> <span style=color:#000>loadFactor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>map</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>initialCapacity</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>loadFactor</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Constructs a new, empty set; the backing &lt;tt&gt;HashMap&lt;/tt&gt; instance has
</span><span style=color:#8f5902;font-style:italic>     * the specified initial capacity and default load factor (0.75).
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param      initialCapacity   the initial capacity of the hash table
</span><span style=color:#8f5902;font-style:italic>     * @throws     IllegalArgumentException if the initial capacity is less
</span><span style=color:#8f5902;font-style:italic>     *             than zero
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>HashSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>initialCapacity</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>map</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>initialCapacity</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Constructs a new, empty linked hash set.  (This package private
</span><span style=color:#8f5902;font-style:italic>     * constructor is only used by LinkedHashSet.) The backing
</span><span style=color:#8f5902;font-style:italic>     * HashMap instance is a LinkedHashMap with the specified initial
</span><span style=color:#8f5902;font-style:italic>     * capacity and the specified load factor.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param      initialCapacity   the initial capacity of the hash map
</span><span style=color:#8f5902;font-style:italic>     * @param      loadFactor        the load factor of the hash map
</span><span style=color:#8f5902;font-style:italic>     * @param      dummy             ignored (distinguishes this
</span><span style=color:#8f5902;font-style:italic>     *             constructor from other int, float constructor.)
</span><span style=color:#8f5902;font-style:italic>     * @throws     IllegalArgumentException if the initial capacity is less
</span><span style=color:#8f5902;font-style:italic>     *             than zero, or if the load factor is nonpositive
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#000>HashSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>initialCapacity</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>float</span> <span style=color:#000>loadFactor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>dummy</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>map</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>initialCapacity</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>loadFactor</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>构造函数都是调用了HashMap的构造函数，有一个是调用了LinkedHashMap的构造所以HashSet的实现是通过HashMap的方式来实现的</p></div><div class=td-content style=page-break-before:always><h1 id=pg-017cbae302df6a652f5dc0633d66d09e>ArrayList源码分析</h1><div class="td-byline mb-4"><time datetime=2018-05-07 class=text-muted>2018-05-07</time></div><h3 id=arraylist>ArrayList</h3><p>ArrayList并不是线程安全的，在读线程在读取ArrayList的时候如果有写线程在写数据的时候，基于fast-fail机制，会抛出<strong>ConcurrentModificationException</strong>异常，也就是说ArrayList并不是一个线程安全的容器</p><h3 id=构造方法>构造方法</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 默认容量10
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>DEFAULT_CAPACITY</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 空的数据实例
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>EMPTY_ELEMENTDATA</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{};</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>      *用户指定参数容量
</span><span style=color:#8f5902;font-style:italic>      */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>initialCapacity</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>initialCapacity</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//初始容量大于0，创建对应的Object数组长度
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>elementData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>initialCapacity</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>initialCapacity</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//等于0赋值空数组
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>elementData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>EMPTY_ELEMENTDATA</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//小于0抛错
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Illegal Capacity: &#34;</span><span style=color:#ce5c00;font-weight:700>+</span>
                                               <span style=color:#000>initialCapacity</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 无参数默认为空数组
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>elementData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>DEFAULTCAPACITY_EMPTY_ELEMENTDATA</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 构造包含指定collection元素的列表，这些元素利用该集合的迭代器按顺序返回
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>elementData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toArray</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>elementData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// c.toArray might (incorrectly) not return Object[] (see 6260652)
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elementData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[].</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#8f5902;font-style:italic>//数组的拷贝
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>elementData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>copyOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elementData</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[].</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 空数组替代
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>elementData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>EMPTY_ELEMENTDATA</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul><li>不指定容量默认为空 size=0</li><li>默认的扩容容量为10</li><li>底层的数据结构object数组</li></ul><h3 id=arraylist扩容机制>ArrayList扩容机制</h3><p>是否扩容是根据调用add方法时候来判断的。</p><h4 id=1-先来看-add-方法>1. 先来看 <code>add</code> 方法</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>E</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    	<span style=color:#8f5902;font-style:italic>//添加元素之前调用ensureCapacityInternal确保容量
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>ensureCapacityInternal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>  <span style=color:#8f5902;font-style:italic>// Increments modCount!!
</span><span style=color:#8f5902;font-style:italic></span>    	<span style=color:#8f5902;font-style:italic>//添加到对应的位置
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>elementData</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>++]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=2--add-方法>2. <code>add</code> 方法</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>ensureCapacityInternal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>minCapacity</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>ensureExplicitCapacity</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>calculateCapacity</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elementData</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>minCapacity</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>calculateCapacity</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>elementData</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>minCapacity</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
     <span style=color:#8f5902;font-style:italic>// 获取默认的容量和传入参数的较大值    
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elementData</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>DEFAULTCAPACITY_EMPTY_ELEMENTDATA</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>max</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DEFAULT_CAPACITY</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>minCapacity</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>minCapacity</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>ensureExplicitCapacity</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>minCapacity</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>modCount</span><span style=color:#ce5c00;font-weight:700>++;</span>

        <span style=color:#8f5902;font-style:italic>// 判断最小的容量和数组之间的大小关系
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>minCapacity</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>elementData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#8f5902;font-style:italic>//扩容
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>grow</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>minCapacity</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=3grow方法>3.<code>grow</code>方法</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>grow</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>minCapacity</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>oldCapacity</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>elementData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span>
    	<span style=color:#8f5902;font-style:italic>//进行扩容-- oldCapacity + (oldCapacity &gt;&gt; 1) 相当于 oldCapacity + (oldCapacity / 2) 
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>newCapacity</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>oldCapacity</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldCapacity</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
    	<span style=color:#8f5902;font-style:italic>//然后检查新容量是否大于最小需要容量，若还是小于最小需要容量，那么就把最小需要容量当作数组的新容量，
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>newCapacity</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>minCapacity</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>newCapacity</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>minCapacity</span><span style=color:#ce5c00;font-weight:700>;</span>
    	<span style=color:#8f5902;font-style:italic>/**如果新容量大于 MAX_ARRAY_SIZE,进入(执行) `hugeCapacity()` 
</span><span style=color:#8f5902;font-style:italic>          *方法来比较 minCapacity 和 MAX_ARRAY_SIZE
</span><span style=color:#8f5902;font-style:italic>          *如果minCapacity大于最大容量，则新容量则为`Integer.MAX_VALUE`
</span><span style=color:#8f5902;font-style:italic>          */</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>newCapacity</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>MAX_ARRAY_SIZE</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>newCapacity</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>hugeCapacity</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>minCapacity</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// minCapacity is usually close to size, so this is a win:
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>elementData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>copyOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elementData</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>newCapacity</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=systemarraycopy><code>System.arraycopy()</code></h2><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>src</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[]{</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>};</span>
        <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>dest</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>100</span><span style=color:#ce5c00;font-weight:700>];</span>

        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>arraycopy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>dest</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>50</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dest</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>51</span><span style=color:#ce5c00;font-weight:700>]);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dest</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>50</span><span style=color:#ce5c00;font-weight:700>]);</span>
</code></pre></div><p>输出结果：3</p><p>​ 2</p><h3 id=arraylist和vector的区别>ArrayList和Vector的区别</h3><p><code>Vector</code>从代码层面看方法上加了<code>synchronized</code>是线程安全，但是如果一个线程访问需要同步操作耗时比较长。</p><p>ArrayList不是同步的，所以在不需要保证线程安全的时候使用ArrayList</p><h3 id=使用注意>使用注意</h3><ul><li>如果知道 <strong><code>ArrayList</code></strong> 的长度直接设置 <strong><code>initialCapacity</code></strong> 初始容量。这样的好处在于避免了扩容带来的性能问题。减少了添加过程中扩容的步骤，如果数量小于10就直接用默认的，因为 <strong><code>ArrayList</code></strong> 的最小容量为10。</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-633056f9f3bceb7552739b40fa275a58>Map源码解析</h1><div class="td-byline mb-4"></div></div><div class=td-content><h1 id=pg-f01491bd7481e6b4aa6cdcfe9a4767b7>HashMap和HashTable的区别</h1><div class="td-byline mb-4"><time datetime=2019-08-09 class=text-muted>2019-08-09</time></div><h3 id=hashmap和hashtable区别>HashMap和HashTable区别</h3><ol><li><p><strong>线程是否安全</strong>：HashMap非线程安全，HashTable是线程安全的；HashTable内部都经过了<code>synchronized</code></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//HashMap的put方法
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>V</span> <span style=color:#000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>K</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>V</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>putVal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#8f5902;font-style:italic>//HashTable的put方法
</span><span style=color:#8f5902;font-style:italic></span>     <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#000>V</span> <span style=color:#000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>K</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>V</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// Make sure the value is not null
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NullPointerException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// Makes sure the key is not already in the hashtable.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;?,?&gt;</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hash</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hashCode</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hash</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>0x7FFFFFFF</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>entry</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;)</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(;</span> <span style=color:#000>entry</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>entry</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>entry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>entry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>entry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>V</span> <span style=color:#000>old</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>entry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>entry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>old</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>addEntry</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>


</code></pre></div></li><li><p><strong>效率:</strong> 因为线程安全问题，HashMap要比HashTable效率略高一点，JDK1.8基本上被淘汰了，不要在代码中使用</p></li><li><p><strong>对Null key 和Null value的支持：</strong> HashMap可以用null作为键值，这样的且只有一个。但是在 HashTable 中 put 进的键值或者value只要有一个 null，直接抛出 NullPointerException</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//HashTable
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#000>V</span> <span style=color:#000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>K</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>V</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//确保value不等于null
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NullPointerException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// Makes sure the key is not already in the hashtable.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;?,?&gt;</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>;</span>
     <span style=color:#8f5902;font-style:italic>//key不能为null--NullPointerException
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hash</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hashCode</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hash</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>0x7FFFFFFF</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>entry</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;)</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(;</span> <span style=color:#000>entry</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>entry</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>entry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>entry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>entry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>V</span> <span style=color:#000>old</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>entry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>entry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>old</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>addEntry</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li><li><p><strong>初始容量大小和每次扩充容量大小的不同 ：</strong></p><ul><li><p>默认初始容量不一样：<code>HashMap</code>初始容量16，<code>HashTable</code>初始容量11。扩容HashMap都是变为原来的2倍，HashMap容量每次扩容都是2的幂次方大小(tableSizeFor方法保证)，HashTable的的扩容(oldCapacity &#171; 1) + 1及2n+1</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Hashtable</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>11</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>75f</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#8f5902;font-style:italic>//HashMap 发生在第一次put的时候
</span><span style=color:#8f5902;font-style:italic></span>     <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>newCap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>DEFAULT_INITIAL_CAPACITY</span><span style=color:#ce5c00;font-weight:700>;</span>
     <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>newThr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>DEFAULT_LOAD_FACTOR</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>DEFAULT_INITIAL_CAPACITY</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div></li></ul></li><li><p><strong>底层数据结构:</strong> JDK1.8以后的HashMap在解决Hash冲突试用了哈希表+链表+红黑树，链表转换为红黑树的状态的阈值为8。用来减少搜索时间，HashTable没有这样的改动</p></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-dab4196a35db475a43321485d2789c7d>EnumMap</h1><div class="td-byline mb-4"><time datetime=2018-12-05 class=text-muted>2018-12-05</time></div><h3 id=enummap>EnumMap</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>keyType</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * All of the values comprising K.  (Cached for performance.)
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>transient</span> <span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>keyUniverse</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Array representation of this map.  The ith element is the value
</span><span style=color:#8f5902;font-style:italic>     * to which universe[i] is currently mapped, or null if it isn&#39;t
</span><span style=color:#8f5902;font-style:italic>     * mapped to anything, or NULL if it&#39;s mapped to null.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>transient</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>vals</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * The number of mappings in this map.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>transient</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><p>实现：数组实现</p><p>使用案例：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>Color</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#000>red</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>black</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>green</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Color</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>map</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>EnumMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Color</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>Color</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-9795b83feaeecce3b1feced8b9d12c7f>HashMap源码解析</h1><div class="td-byline mb-4"><time datetime=2018-11-10 class=text-muted>2018-11-10</time></div><h3 id=1-哈希算法>1. 哈希算法</h3><p>hash是具有唯一性且不可逆的，唯一性指的是相同的输入产生的hash code永远是一样的，而不可逆也比较容易理解，数据摘要算法并不是压缩算法，它只是生成了一个该数据的摘要，没有将数据进行压缩。压缩算法一般都是使用一种更节省空间的编码规则将数据重新编码，解压缩只需要按着编码规则解码就是了，试想一下，一个几百MB甚至几GB的数据生成的hash code都只是一个拥有固定长度的序列，如果再能逆向解压缩，那么其他压缩算法该情何以堪？</p><p>我们上述讨论的仅仅是在密码学中的hash算法，而在散列表中所需要的散列函数是要能够将key寻址到buckets中的一个位置，散列函数的实现影响到整个散列表的性能。</p><p>一个完美的散列函数要能够做到均匀地将key分布到buckets中，每一个key分配到一个bucket，但这是不可能的。虽然hash算法具有唯一性，但同时它还具有重复性，<strong>唯一性保证了相同输入的输出是一致的，却没有保证不同输入的输出是不一致的</strong>，也就是说，<strong>完全有可能两个不同的key被分配到了同一个bucket（因为它们的hash code可能是相同的），这叫做碰撞冲突</strong>。总之，理想很丰满，现实很骨感，散列函数只能尽可能地减少冲突，没有办法完全消除冲突。</p><h3 id=2-hashmap的哈希冲突>2. HashMap的哈希冲突</h3><p>HashMap中调用hashCode()方法来计算hashCode。
由于在Java中两个不同的对象可能有一样的hashCode,所以不同的键可能有一样hashCode，从而导致冲突的产生。</p><h4 id=21-hashmap解决冲突方式>2.1 HashMap解决冲突方式</h4><ul><li>HashMap在处理冲突时使用链表存储相同索引(桶)的元素</li><li>从Java 8开始，HashMap，ConcurrentHashMap和LinkedHashMap在处理频繁冲突时将使用平衡树来代替链表，当同一hash桶中的元素数量超过特定的值便会由链表切换到平衡树，这会将get()方法的性能从O(n)提高到O(logn)</li><li>当从链表切换到平衡树时，HashMap迭代的顺序将会改变。不过这并不会造成什么问题，因为HashMap并没有对迭代的顺序提供任何保证</li><li>使用HashMap之所以会产生冲突是因为使用了键对象的hashCode()方法，而equals()和hashCode()方法不保证不同对象的hashCode是不同的。需要记住的是，<strong>相同对象的hashCode一定是相同的，但相同的hashCode不一定是相同的对象</strong></li></ul><p>以上就是Java中HashMap如何处理冲突。这种方法被称为链地址法，因为使用链表存储同一桶内的元素。通常情况HashMap，HashSet，LinkedHashSet，LinkedHashMap，ConcurrentHashMap，HashTable，IdentityHashMap和WeakHashMap均采用这种方法处理冲突。<br>从JDK 8开始，HashMap，LinkedHashMap和ConcurrentHashMap为了提升性能，在频繁冲突的时候使用平衡树来替代链表。因为HashSet内部使用了HashMap，LinkedHashSet内部使用了LinkedHashMap，所以他们的性能也会得到提升。</p><p>在Java 8 之前， 如果发生碰撞往往是将该value直接链接到该位置的其他所有value的末尾，即相互碰撞的所有value形成一个链表。因此，在最坏情况下，HashMap的查找时间复杂度将退化到O（n）.但是在Java 8 中，该碰撞后的处理进行了改进。当一个位置所在的冲突过多时，存储的value将形成一个排序二叉树，排序依据为key的hashcode。则在最坏情况下，HashMap的查找时间复杂度将从O（1）退化到O（logn）。</p><h4 id=22-由链表改进为红黑树的好处>2.2 由链表改进为红黑树的好处</h4><ol><li>最坏的情况的时间开销由O（n）降到了O（logn）</li><li>改善哈希碰撞攻击</li></ol><h4 id=23-哈希碰撞攻击原理>2.3 哈希碰撞攻击原理</h4><p>哈希表的原理是用数组来保存键值对，键值对存放的位置（下标）由键的哈希值决定，键的哈希值可以在参数时间内计算出来，这样哈希表插入、查找和删除的时间复杂度为O(1)，但是这是理想的情况下，真实的情况是，键的哈希值存在冲突碰撞，也就是不同的键的哈希值可能相等，一个好的哈希函数应该是尽可能的减少碰撞。解决冲突碰撞的方法有分为两种：开放地址法和 链接法，这里不具体展开。哈希表一般都采用链接法来解决冲突碰撞，也就是用一个链表来将分配到同一个桶（键的哈希值一样）的键值对保存起来。</p><p>所谓的哈希碰撞攻击就是，针对哈希函数的特性，精心构造数据，使所有数据的哈希值相同，当这些数据保存到哈希表中，哈希表就会退化为单链表，哈希表的各种操作的时间复杂度提升一个数量级，因此会消耗大量CPU资源，导致系统无法快速响应请求，从而达到拒绝服务攻击（Dos）的目的。</p><h3 id=3-jdk18和jdk-18-以前-hashmap对比>3. jdk1.8和JDK 1.8 以前 HashMap对比</h3><p>HashMap之前实现</p><pre><code>方式：数组+链表
缺点：哈希函数取得再好，也很难达到元素百分百均匀分布。当 HashMap 中有大量的元素都存放到同一个桶中时，
这个桶下有一条长长的链表，这个时候 HashMap 就相当于一个单链表，假如单链表有 n
个元素，遍历的时间复杂度就是 O(n)，完全失去了它的优势
</code></pre><p>针对这种情况，JDK 1.8 中引入了 红黑树（查找时间复杂度为 O(logn)）来优化这个问题
常见的算法时间复杂度由小到大依次为： Ο(1)＜Ο(log2n)＜Ο(n)＜Ο(nlog2n)＜Ο(n2)＜Ο(n3)＜…＜Ο(2n)＜Ο(n!)</p><h3 id=4-jdk8-hashmap>4. JDK8 HashMap</h3><p>HashMap数据结构示意图见(哈希表+单链表+红黑树)：<img src="https://github.com/mxsm/document/blob/master/image/JSE/hashmapdatastruct.png?raw=true" alt=HashMap内部结构图示></p><p>HashMap几个重要的变量：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>   <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * The default initial capacity - MUST be a power of two.
</span><span style=color:#8f5902;font-style:italic>     * 默认的容量16--并且容量必须是2的幂
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>DEFAULT_INITIAL_CAPACITY</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//16
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 最大限度容量
</span><span style=color:#8f5902;font-style:italic>     * 
</span><span style=color:#8f5902;font-style:italic>     */</span>
	<span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>MAXIMUM_CAPACITY</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>30</span><span style=color:#ce5c00;font-weight:700>;</span>

	<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 默认加载因子0.75f
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>float</span> <span style=color:#000>DEFAULT_LOAD_FACTOR</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>75f</span><span style=color:#ce5c00;font-weight:700>;</span>

	<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 链表转换为红黑树的阈值
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>TREEIFY_THRESHOLD</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>8</span><span style=color:#ce5c00;font-weight:700>;</span>

 	<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 红黑树转换为链表的阈值
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>UNTREEIFY_THRESHOLD</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>6</span><span style=color:#ce5c00;font-weight:700>;</span>

   <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 如果在创建HashMap实例时没有给定capacity、loadFactor则默认值分别是16和0.75
</span><span style=color:#8f5902;font-style:italic>     * 当好多bin被映射到同一个桶时，如果这个桶中bin的数量小于TREEIFY_THRESHOLD当然不
</span><span style=color:#8f5902;font-style:italic>     * 会转化成树形结构存储；如果这个桶中bin的数量大于了 TREEIFY_THRESHOLD ，
</span><span style=color:#8f5902;font-style:italic>     * 但是capacity小于MIN_TREEIFY_CAPACITY则依然使用链表结构进行存储，此时会对H
</span><span style=color:#8f5902;font-style:italic>     * ashMap进行扩容；如果capacity大于了MIN_TREEIFY_CAPACITY ，则会进行树化。
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>MIN_TREEIFY_CAPACITY</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>64</span><span style=color:#ce5c00;font-weight:700>;</span>

   <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * The table, initialized on first use, and resized as
</span><span style=color:#8f5902;font-style:italic>     * necessary. When allocated, length is always a power of two.
</span><span style=color:#8f5902;font-style:italic>     * (We also tolerate length zero in some operations to allow
</span><span style=color:#8f5902;font-style:italic>     * bootstrapping mechanics that are currently not needed.)
</span><span style=color:#8f5902;font-style:italic>     * 保存HashMap的数据结构，使用懒加载方式，分配长度总是2的幂。
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>transient</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Holds cached entrySet(). Note that AbstractMap fields are used
</span><span style=color:#8f5902;font-style:italic>     * for keySet() and values().
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>transient</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>entrySet</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * The number of key-value mappings contained in this map.
</span><span style=color:#8f5902;font-style:italic>     * K-V map中保存的数量  -- 方法size() 获取的就是这个字段
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>transient</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * The number of times this HashMap has been structurally modified
</span><span style=color:#8f5902;font-style:italic>     * Structural modifications are those that change the number of mappings in
</span><span style=color:#8f5902;font-style:italic>     * the HashMap or otherwise modify its internal structure (e.g.,
</span><span style=color:#8f5902;font-style:italic>     * rehash).  This field is used to make iterators on Collection-views of
</span><span style=color:#8f5902;font-style:italic>     * the HashMap fail-fast.  (See ConcurrentModificationException).
</span><span style=color:#8f5902;font-style:italic>     * HashMap的数据结构改变的次数
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>transient</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>modCount</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * The next size value at which to resize (capacity * load factor).
</span><span style=color:#8f5902;font-style:italic>     * 扩容的阈值
</span><span style=color:#8f5902;font-style:italic>     * @serial
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#8f5902;font-style:italic>// (The javadoc description is true upon serialization.
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// Additionally, if the table array has not been allocated, this
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// field holds the initial array capacity, or zero signifying
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// DEFAULT_INITIAL_CAPACITY.)
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>threshold</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * The load factor for the hash table.
</span><span style=color:#8f5902;font-style:italic>     * 负载因子
</span><span style=color:#8f5902;font-style:italic>     * @serial
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>float</span> <span style=color:#000>loadFactor</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><p>节点：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//哈希值，就是位置
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>//键
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>K</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>//值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>V</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>//指向下一个几点的指针
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>//...
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>红黑树节点</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>
<span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>LinkedHashMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>// red-black tree links
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>prev</span><span style=color:#ce5c00;font-weight:700>;</span>    <span style=color:#8f5902;font-style:italic>// needed to unlink next upon deletion
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>red</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>方法：<strong>tableSizeFor&ndash;找到最接近传入cap的2的幂</strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>tableSizeFor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>cap</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cap</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>|=</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>|=</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>|=</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>|=</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>8</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>|=</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>16</span><span style=color:#ce5c00;font-weight:700>;</span>
    	<span style=color:#8f5902;font-style:italic>//(n &lt; 0) ? 1:()后面的 (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + 1是
</span><span style=color:#8f5902;font-style:italic></span>    	<span style=color:#8f5902;font-style:italic>//是一块
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>MAXIMUM_CAPACITY</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>MAXIMUM_CAPACITY</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>tableSizeFor</strong>方法图解如下：</p><p><img src="https://github.com/mxsm/document/blob/master/image/JSE/tablesize%E7%A4%BA%E6%84%8F%E5%9B%BE.png?raw=true" alt=图解></p><p>方法：<strong>put&ndash;存入数据</strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>V</span> <span style=color:#000>putVal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>K</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>V</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>onlyIfAbsent</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>evict</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>;</span> 
        <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span> 
        <span style=color:#8f5902;font-style:italic>//桶的容量
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>n</span><span style=color:#a40000>；</span>
        <span style=color:#8f5902;font-style:italic>//桶的索引
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>tab</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#8f5902;font-style:italic>//懒加载---没有初始化进行初始化
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resize</span><span style=color:#ce5c00;font-weight:700>()).</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span>
    	<span style=color:#8f5902;font-style:italic>//获取hash桶
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#8f5902;font-style:italic>//没有哈希碰撞直接放在对应的桶中
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span> 
            <span style=color:#000>K</span> <span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>//判断桶的第一个节点是否和插入的数据相等--不是走下一个else if
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>hash</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>))))</span>
                <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>//判断是否已经转换为红黑树了--不是走下面的else
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>)</span>
               <span style=color:#8f5902;font-style:italic>//做红黑树的插入数据操作
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;)</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>putTreeVal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
             
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
             <span style=color:#8f5902;font-style:italic>//桶里面的数据还是链表的结构
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//遍历查找替换或者直接存放到链表最后面
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>binCount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>binCount</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>//找到下一个节点为空的节点
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                   		<span style=color:#8f5902;font-style:italic>//插入链表的下一个节点
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#8f5902;font-style:italic>//判断是否要将链表结构转换成红黑树(TREEIFY_THRESHOLD=8)
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>binCount</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>TREEIFY_THRESHOLD</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// -1 for 1st
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#8f5902;font-style:italic>//桶容器的链表转换为红黑树
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#000>treeifyBin</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#8f5902;font-style:italic>//查找到key值相等的直接跳出
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>hash</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>))))</span>
                        <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#8f5902;font-style:italic>//HashMap中存在插入的key值
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// existing mapping for key
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>V</span> <span style=color:#000>oldValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>onlyIfAbsent</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>oldValue</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>afterNodeAccess</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>oldValue</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    	<span style=color:#8f5902;font-style:italic>//更新修改次数
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>modCount</span><span style=color:#ce5c00;font-weight:700>;</span>
    	<span style=color:#8f5902;font-style:italic>//增加map的size
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(++</span><span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>threshold</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#8f5902;font-style:italic>//大于阈值扩容
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>resize</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>afterNodeInsertion</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>evict</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>方法：<strong>treeifyBin—链表转换为红黑树</strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>treeifyBin</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
    	<span style=color:#8f5902;font-style:italic>//tab为空进行扩容
</span><span style=color:#8f5902;font-style:italic></span>    	<span style=color:#8f5902;font-style:italic>//tab的容量小于MIN_TREEIFY_CAPACITY进行扩容
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>MIN_TREEIFY_CAPACITY</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>resize</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//获取到节点进行链表转换为红黑树
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>hd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>tl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>do</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>//Node --&gt; TreeNode
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>replacementTreeNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tl</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#000>hd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prev</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tl</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#000>tl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#000>tl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>hd</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#8f5902;font-style:italic>//红黑树退化为链表
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>hd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>treeify</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>注意链表的转换为红黑树的两个条件</strong>：</p><ol><li>链表的长度>=TREEIFY_THRESHOLD（8为默认值）</li><li>容量>=MIN_TREEIFY_CAPACITY(64默认值)</li></ol><p>方法：<strong>putTreeVal&ndash;红黑树的添加操作</strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>putTreeVal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>K</span> <span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>V</span> <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>kc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>searched</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>//获取根节点
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>root</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>//每次添加元素时，从根节点遍历，对比哈希值
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>;;)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>dir</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//插入的位置
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ph</span><span style=color:#ce5c00;font-weight:700>;</span> 
                <span style=color:#000>K</span> <span style=color:#000>pk</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ph</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#000>dir</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//左子树
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ph</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#000>dir</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//右子树
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>pk</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pk</span><span style=color:#ce5c00;font-weight:700>)))</span>
                <span style=color:#8f5902;font-style:italic>//如果当前节点的哈希值、键和要添加的都一致，就返回当前节点
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>kc</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>kc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>comparableClassFor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> 
                       <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dir</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>compareComparables</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>kc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pk</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>searched</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ch</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#000>searched</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(((</span><span style=color:#000>ch</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                             <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>q</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>find</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>kc</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span>
                            <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ch</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                             <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>q</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>find</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>kc</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>))</span>
                             <span style=color:#8f5902;font-style:italic>//如果从 ch 所在子树中可以找到要添加的节点，就直接返回
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#8f5902;font-style:italic>//哈希值相等，但键无法比较，只好通过特殊的方法给个结果
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>dir</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tieBreakOrder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pk</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#8f5902;font-style:italic>//经过前面的计算，得到了当前节点和要插入节点的一个大小关系
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//要插入的节点比当前节点小就插到左子树，大就插到右子树
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>xp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>//如果当前节点还没有左孩子或者右孩子时才能插入，否则就进入下一轮循环
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dir</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>xpn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>xp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newTreeNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>xpn</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dir</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
                        <span style=color:#000>xp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>else</span>
                        <span style=color:#000>xp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#000>xp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prev</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>xp</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>xpn</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                        <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;)</span><span style=color:#000>xpn</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>prev</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#8f5902;font-style:italic>//红黑树中，插入元素后必要的平衡调整操作
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>moveRootToFront</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>balanceInsertion</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>));</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>方法：<strong>balanceInsertion &ndash; 调整插入后数据的平衡</strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>balanceInsertion</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//每个新增节点默认为红色
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>red</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>// xp父节点 xpp祖父节点 xppl祖父左节点 xppr 祖父右节点
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>xp</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>xpp</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>xppl</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>xppr</span><span style=color:#ce5c00;font-weight:700>;;)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>xp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>// x的父节点为空，x应为根节点，应为黑色 --(红黑树根节点为黑色)
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>red</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>xp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>red</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>xpp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>xp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#8f5902;font-style:italic>// 父节点是黑色，祖父节点为空，直接返回
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#8f5902;font-style:italic>//一下处理为逻辑--父节点是红色
</span><span style=color:#8f5902;font-style:italic></span>                
                <span style=color:#8f5902;font-style:italic>//父节点为祖父节点的左节点
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>xp</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>xppl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>xpp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>//父节点是祖父节点的左节点
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>xppr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>xpp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>xppr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>red</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>//叔父节点为红色--将叔父节点设置为黑色
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>xppr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>red</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#8f5902;font-style:italic>//父节点设置为黑色
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>xp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>red</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#8f5902;font-style:italic>//将祖父节点设置为红色
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>xpp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>red</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#8f5902;font-style:italic>//将祖父节点设置为当前节点，继续操作
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>xpp</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>//叔父节点为空或者黑色
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>xp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                           <span style=color:#8f5902;font-style:italic>// x为父节点右节点，则要进行左旋操作
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#000>root</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>rotateLeft</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>xp</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#000>xpp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>xp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>xp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#8f5902;font-style:italic>// 经过左旋x为左节点
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>xp</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#8f5902;font-style:italic>//父节点涂成黑色
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#000>xp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>red</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>xpp</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#8f5902;font-style:italic>// 祖父节点不为空
</span><span style=color:#8f5902;font-style:italic></span>                                <span style=color:#8f5902;font-style:italic>// 祖父节点设为红色
</span><span style=color:#8f5902;font-style:italic></span>                                <span style=color:#000>xpp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>red</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
                                <span style=color:#8f5902;font-style:italic>// 以祖父节点为支点右旋转
</span><span style=color:#8f5902;font-style:italic></span>                                <span style=color:#000>root</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>rotateRight</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>xpp</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                 <span style=color:#8f5902;font-style:italic>//父节点为祖父节点的右节点
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>xppl</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>xppl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>red</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>// 叔父节点为红色
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#8f5902;font-style:italic>// 将叔父节点设为黑色
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>xppl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>red</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#000>xp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>red</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#000>xpp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>red</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>xpp</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>xp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>root</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>rotateRight</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>xp</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#000>xpp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>xp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>xp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>xp</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>xp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>red</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>xpp</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#000>xpp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>red</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
                                <span style=color:#000>root</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>rotateLeft</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>xpp</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>方法：<strong>rotateLeft和rotateRight</strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//红黑树左旋
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>rotateLeft</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pp</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rl</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>rl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#000>rl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>pp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>red</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#000>pp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>else</span>
                    <span style=color:#000>pp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>//红黑树右旋
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>rotateRight</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>l</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pp</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>lr</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>l</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>lr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>l</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#000>lr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>pp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>l</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>l</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>red</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#000>pp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>l</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>else</span>
                    <span style=color:#000>pp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>l</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>l</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>l</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>方法：<strong>resize&ndash;扩容</strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>resize</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//保存原有的数据
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>oldTab</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>//原有的容量
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>oldCap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldTab</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>oldTab</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>//临界值 当实际大小(容量*填充比)超过临界值时，会进行扩容
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>oldThr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>threshold</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>newCap</span> <span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>newThr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldCap</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//原有容量大于最大限度容量，临界值=整数最大值，并且返回原有的不进行扩容
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldCap</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>MAXIMUM_CAPACITY</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>threshold</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MAX_VALUE</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>oldTab</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>newCap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>oldCap</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>MAXIMUM_CAPACITY</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                     <span style=color:#000>oldCap</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>DEFAULT_INITIAL_CAPACITY</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#000>newThr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>oldThr</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// double threshold
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldThr</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// initial capacity was placed in threshold
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>newCap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>oldThr</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>               <span style=color:#8f5902;font-style:italic>// zero initial threshold signifies using defaults
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//使用的是无参构造方法
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>newCap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>DEFAULT_INITIAL_CAPACITY</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>newThr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>DEFAULT_LOAD_FACTOR</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>DEFAULT_INITIAL_CAPACITY</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>newThr</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>float</span> <span style=color:#000>ft</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>float</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>newCap</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>loadFactor</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>newThr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>newCap</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>MAXIMUM_CAPACITY</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>ft</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>float</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>MAXIMUM_CAPACITY</span> <span style=color:#ce5c00;font-weight:700>?</span>
                      <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>ft</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MAX_VALUE</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>threshold</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newThr</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>({</span><span style=color:#4e9a06>&#34;rawtypes&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>})</span>
        <span style=color:#8f5902;font-style:italic>//创建新的Node数组
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>newTab</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[])</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>newCap</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#000>table</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newTab</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>//以下就是扩容--判断是不是新new的对象
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldTab</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>j</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>j</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>oldCap</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//处理旧数据的存放位置--三种情况
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>oldTab</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>oldTab</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#8f5902;font-style:italic>//旧数据没有子节点
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                        <span style=color:#000>newTab</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>newCap</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#8f5902;font-style:italic>//TreeNode节点--红黑树的形式存放
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>)</span>
                        <span style=color:#8f5902;font-style:italic>//树形结构修剪
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;)</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>split</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>newTab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>oldCap</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// preserve order
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#8f5902;font-style:italic>//链表有子节点数据移动
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#8f5902;font-style:italic>//保证顺序
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>loHead</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>loTail</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>hiHead</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>hiTail</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#204a87;font-weight:700>do</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#8f5902;font-style:italic>//获取当前节点的下一个
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
                           <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>                            * e.hash &amp; oldCap 说明e.hash后的值小于oldCap,即使扩充了,
</span><span style=color:#8f5902;font-style:italic>                            *也是扩充链表的后半部分,前面已经有的元素还是在原来的位置
</span><span style=color:#8f5902;font-style:italic>                            *（容量除了最大容量其他都是2的倍数，通过(e.hash &amp; oldCap) == 0)
</span><span style=color:#8f5902;font-style:italic>                            *就可以判断链表的扩充）
</span><span style=color:#8f5902;font-style:italic>                            *
</span><span style=color:#8f5902;font-style:italic>                            */</span>
                            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>oldCap</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#8f5902;font-style:italic>//如果loTail==null说明是第一个元素,把这个元素赋值给loHead
</span><span style=color:#8f5902;font-style:italic></span>                                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>loTail</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                                    <span style=color:#000>loHead</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
                                <span style=color:#204a87;font-weight:700>else</span>
                                <span style=color:#8f5902;font-style:italic>//如果不是第一个元素,就把他加到后面
</span><span style=color:#8f5902;font-style:italic></span>                                    <span style=color:#000>loTail</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
                                <span style=color:#000>loTail</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#ce5c00;font-weight:700>}</span><span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#8f5902;font-style:italic>//如果走下面的代码,则说明,新的元素的key值的hash已经超过了oldCap,所有要加入到新库充的链表中
</span><span style=color:#8f5902;font-style:italic></span>                                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hiTail</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                                    <span style=color:#000>hiHead</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
                                <span style=color:#204a87;font-weight:700>else</span>
                                    <span style=color:#000>hiTail</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
                                <span style=color:#000>hiTail</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>loTail</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>loTail</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#000>newTab</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>loHead</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hiTail</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>hiTail</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#000>newTab</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>j</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>oldCap</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>hiHead</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>newTab</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>下列代码的图解：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>oldCap</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span>
</code></pre></div><p><img src="https://github.com/mxsm/document/blob/master/image/JSE/hashMap1.8%E5%93%88%E5%B8%8C%E7%AE%97%E6%B3%95%E4%BE%8B%E5%9B%BE1.png?raw=true" alt=图解></p><p><img src="https://github.com/mxsm/document/blob/master/image/JSE/hashMap1.8%E5%93%88%E5%B8%8C%E7%AE%97%E6%B3%95%E4%BE%8B%E5%9B%BE2.png?raw=true" alt=图解></p><p><img src="https://github.com/mxsm/document/blob/master/image/JSE/jdk1.8hashMap%E6%89%A9%E5%AE%B9%E4%BE%8B%E5%9B%BE.png?raw=true" alt=图解></p><p>方法：<strong>split&ndash;树形结构修剪</strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//tab 表示保存桶头结点的哈希表
</span><span style=color:#8f5902;font-style:italic>//index 表示从哪个位置开始修剪
</span><span style=color:#8f5902;font-style:italic>//bit 要修剪的位数（哈希值）
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>split</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>bit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>// Relink into lo and hi lists, preserving order
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>loHead</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>loTail</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>hiHead</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>hiTail</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>lc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>//当前节点的下个节点
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;)</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>bit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prev</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>loTail</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                        <span style=color:#000>loHead</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>else</span>
                        <span style=color:#000>loTail</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#000>loTail</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>lc</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prev</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>hiTail</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                        <span style=color:#000>hiHead</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>else</span>
                        <span style=color:#000>hiTail</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#000>hiTail</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>hc</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>loHead</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lc</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>UNTREEIFY_THRESHOLD</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>loHead</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>untreeify</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>loHead</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hiHead</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// (else is already treeified)
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>loHead</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>treeify</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hiHead</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hc</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>UNTREEIFY_THRESHOLD</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>bit</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>hiHead</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>untreeify</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>bit</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>hiHead</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>loHead</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                        <span style=color:#000>hiHead</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>treeify</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>方法：<strong>remove&ndash;删除</strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Implements Map.remove and related methods.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param hash key的哈希值
</span><span style=color:#8f5902;font-style:italic>     * @param key the key
</span><span style=color:#8f5902;font-style:italic>     * @param value the value to match if matchValue, else ignored
</span><span style=color:#8f5902;font-style:italic>     * @param matchValue if true only remove if value is equal
</span><span style=color:#8f5902;font-style:italic>     * @param movable if false do not move other nodes while removing
</span><span style=color:#8f5902;font-style:italic>     * @return the node, or null if none
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>removeNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span>
                               <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>matchValue</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>movable</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>;</span> 
        <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span> 
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//哈希表长度保存变量
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//哈希表的索引
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>tab</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
            <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>K</span> <span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>V</span> <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>hash</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>))))</span>
                <span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#8f5902;font-style:italic>//红黑树查找
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;)</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getTreeNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>//链表查找
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>do</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>hash</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                            <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>||</span>
                             <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>))))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>matchValue</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>v</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>||</span>
                                 <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>))))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#8f5902;font-style:italic>//红黑树删除
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;)</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>removeTreeNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>movable</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>)</span>
                	<span style=color:#8f5902;font-style:italic>//链表删除
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>else</span>
                    <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>modCount</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>--</span><span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>afterNodeRemoval</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>方法：<strong>removeTreeNode—红黑树删除节点</strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>removeTreeNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>movable</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>;</span>
    		<span style=color:#8f5902;font-style:italic>//获取到哈希表的第一个节点
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>first</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;)</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>];</span> 
    		<span style=color:#8f5902;font-style:italic>//哈希表的第一个节点即为红黑树的跟节点
</span><span style=color:#8f5902;font-style:italic></span>    		<span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span>  <span style=color:#000>root</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>;</span>
    		<span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>rl</span><span style=color:#ce5c00;font-weight:700>;</span>
    		<span style=color:#8f5902;font-style:italic>//删除节点的下一个节点--链表的情况
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>succ</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;)</span><span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
    		<span style=color:#8f5902;font-style:italic>//删除节点的前一个节点
</span><span style=color:#8f5902;font-style:italic></span>    		<span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>pred</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>prev</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    		<span style=color:#8f5902;font-style:italic>//pred节点为空说明删除节点为跟节点
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pred</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>first</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>succ</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>else</span>
                <span style=color:#8f5902;font-style:italic>//pred非空的--前一个节点的下一个节点为删除节点的下一个节点
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>pred</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>succ</span><span style=color:#ce5c00;font-weight:700>;</span>
    		
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>succ</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#8f5902;font-style:italic>//删除节点的下一个节点不为空将将删除节点的next节点的prev节点设置为删除节点的前一个节点
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>succ</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prev</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pred</span><span style=color:#ce5c00;font-weight:700>;</span>
    		
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>first</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#8f5902;font-style:italic>//first为空说明删除的是根节点且没有其他节点
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>//若删除的结点是树中的唯一结点则直接结束
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
    
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#8f5902;font-style:italic>//获取根节点--确保root指向根节点
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>root</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>root</span><span style=color:#ce5c00;font-weight:700>();</span>
    
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span>
                <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>rl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 根自身或者左右儿子其中一个为空说明结点数过少（不超过2）转为线性表并结束
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>untreeify</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>);</span>  <span style=color:#8f5902;font-style:italic>// too small
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
    		
    		
            <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//指向删除节点
</span><span style=color:#8f5902;font-style:italic></span>    		<span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>pl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//指向删除节点的左子树
</span><span style=color:#8f5902;font-style:italic></span>    		<span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>pr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//指向删除节点的右子树
</span><span style=color:#8f5902;font-style:italic></span>    		<span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>replacement</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//替代的节点
</span><span style=color:#8f5902;font-style:italic></span>    		<span style=color:#8f5902;font-style:italic>//删除节点的左右节点都不为空
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pl</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>pr</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pr</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>sl</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#8f5902;font-style:italic>//找到删除节点的hashCode最小值--二叉查找树的删除原理
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>//删除结点的左右儿子都不为空时，寻找右子树中最左的叶结点作为后继，s指向这个后继结点
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>sl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// find successor
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sl</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#8f5902;font-style:italic>//交换s和删除节点p的颜色--交换后继结点和要删除结点的颜色
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>red</span><span style=color:#ce5c00;font-weight:700>;</span> 
                <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>red</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>red</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>boolean</span>  <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>red</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// swap colors
</span><span style=color:#8f5902;font-style:italic></span>                
                <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>sr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>pp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#8f5902;font-style:italic>//交换s和p的位置
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>pr</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// p was s&#39;s direct parent
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>sp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sp</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>sp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span><span style=color:#ce5c00;font-weight:700>)</span>
                            <span style=color:#000>sp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#204a87;font-weight:700>else</span>
                            <span style=color:#000>sp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pr</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                        <span style=color:#000>pr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sr</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#000>sr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pl</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#000>pl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pp</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#000>root</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>pp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#000>pp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>else</span>
                    <span style=color:#000>pp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sr</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#000>replacement</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sr</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>else</span>
                    <span style=color:#000>replacement</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pl</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#000>replacement</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pl</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pr</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#000>replacement</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pr</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>else</span>
                <span style=color:#000>replacement</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>replacement</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>pp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>replacement</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pp</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#000>root</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>replacement</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>pp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#000>pp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>replacement</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>else</span>
                    <span style=color:#000>pp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>replacement</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>red</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>root</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>balanceDeletion</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>replacement</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>replacement</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  <span style=color:#8f5902;font-style:italic>// detach
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>pp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pp</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>pp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span><span style=color:#ce5c00;font-weight:700>)</span>
                        <span style=color:#000>pp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>pp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span><span style=color:#ce5c00;font-weight:700>)</span>
                        <span style=color:#000>pp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>movable</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#000>moveRootToFront</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote><p>注意：HashMap如果key为null,那么存放的桶的位置为第一个也就是index=0的位置。由源码可以看出来</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hashCode</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>^</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>16</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></blockquote><p>参考文档：</p><ul><li><a href=https://www.cnblogs.com/CarpenterLee/p/5503882.html>https://www.cnblogs.com/CarpenterLee/p/5503882.html</a></li><li><a href=https://blog.csdn.net/wushiwude/article/details/75331926>https://blog.csdn.net/wushiwude/article/details/75331926</a></li><li><a href=http://www.importnew.com/29724.html>http://www.importnew.com/29724.html</a></li><li><a href=https://www.jianshu.com/p/5b157d4be1ad>https://www.jianshu.com/p/5b157d4be1ad</a></li></ul></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list"><a class=text-white target=_blank rel="noopener noreferrer" href=https://groups.google.com/u/1/g/ljbmxsm><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=个人掘金主页 aria-label=个人掘金主页><a class=text-white target=_blank rel="noopener noreferrer" href=https://juejin.cn/user/1151943918492855><i class="fab fa-twitter"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/mxsm><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2022 The Docsy Authors All Rights Reserved</small>
<small class=ml-1><a href=https://policies.google.com/privacy target=_blank>隐私政策</a></small><p class=mt-2><a href=/about/>Home</a></p></div></div></div></footer><div><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css><script src=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js></script><script>$("p img").wrap(function(){return'<a data-fancybox="gallery" href="'+$(this).attr('src')+'"></a>'})</script></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/mermaid@8.8.1/dist/mermaid.min.js integrity=sha384-to2w0I1OqmbJ9J6yTnIX+KYU8grNpZoD1dKPLjgEJvMe5L5+/7qvuNa2sQo8WAWj crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/raphael/2.3.0/raphael.min.js integrity="sha512-tBzZQxySO5q5lqwLWfu8Q+o4VkTcRGOeQGVQ0ueJga4A1RKuzmAu5HXDOXLEjpbKyV7ow9ympVoa6wZLEzRzDg==" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.15.0/flowchart.min.js integrity="sha512-6QsSiIybtf8tuZ6xfjRTr2tdtw3Gp4q5RSCh2b6q9seoKEQmhAG1RrCA8F0kXTwivVxRVbp/YF3zOh8rvEAU7Q==" crossorigin=anonymous></script><script src=/js/main.min.b541b310f01941a0abfd76b652b5fb60dac470573775bb5b31ff08fe3f6cea51.js integrity="sha256-tUGzEPAZQaCr/Xa2UrX7YNrEcFc3dbtbMf8I/j9s6lE=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.js></script><script type=text/javascript>docsearch({appId:'JO2SY3WDAC',apiKey:'324ddb3b679c1308e5aa8bf222e07f8b',indexName:'mxsm',inputSelector:'.td-search-input',debug:!1})</script></body></html>