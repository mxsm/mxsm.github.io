<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.83.1"><link rel=canonical type=text/html href=/middlewares/netty/netty-source-code-analysis/><link rel=alternate type=application/rss+xml href=/middlewares/netty/netty-source-code-analysis/index.xml><meta name=ROBOTS content="INDEX, FOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Netty源码解析 | 蚂蚁背大象</title><meta property="og:title" content="Netty源码解析"><meta property="og:description" content="蚂蚁背大象博客"><meta property="og:type" content="website"><meta property="og:url" content="/middlewares/netty/netty-source-code-analysis/"><meta property="og:site_name" content="蚂蚁背大象"><meta itemprop=name content="Netty源码解析"><meta itemprop=description content="蚂蚁背大象博客"><meta name=twitter:card content="summary"><meta name=twitter:title content="Netty源码解析"><meta name=twitter:description content="蚂蚁背大象博客"><link rel=preload href=/scss/main.min.e09cb23c7dff3bf1285aa0294bcdc4ac8194fb3425a99c621e31e7b871315685.css as=style><link href=/scss/main.min.e09cb23c7dff3bf1285aa0294bcdc4ac8194fb3425a99c621e31e7b871315685.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 321.39 78.54"><title id="title19">DUBBO LOGO</title><path class="cls-1" d="M68.46 50.38c0 14.06 11.39 22.11 25.45 22.11s25.45-8.05 25.45-22.11V7.25H68.46zm21.24-28h8.6V31H89.7zm0 22.25h8.6v8.6H89.7zM33.24 7.25H4.06v64H33.24c10.95.0 19.3-7.18 23.29-17.15a45.12 45.12.0 002.38-14.87A45.12 45.12.0 0056.53 24.4C52.84 14.62 44.19 7.25 33.24 7.25zm.43 14.63H30.34a3.44 3.44.0 00-3.44 3.44V53.23a3.44 3.44.0 003.44 3.44h3.33v4.63h-8.3a6.87 6.87.0 01-6.87-6.87V24.12a6.87 6.87.0 016.87-6.87h8.3zM285.51 6.06c-17.05.0-30.88 10.28-30.88 33.21s13.83 33.21 30.88 33.21 30.88-10.28 30.88-33.21S302.56 6.06 285.51 6.06zm7.59 48.36a6.87 6.87.0 01-6.87 6.87h-8.3V56.67h3.33a3.44 3.44.0 003.44-3.44V25.31a3.44 3.44.0 00-3.44-3.44h-3.33V17.25h8.3a6.87 6.87.0 016.87 6.87zm-53.4-17.56A17.39 17.39.0 00227.31 7.25H195.1v64h32.21a19.44 19.44.0 0012.38-34.44zM211.63 61.29h-6.08l18.68-44h6.08zM177 36.85A17.39 17.39.0 00164.65 7.25H132.43v64h32.21A19.44 19.44.0 00177 36.85zM149 61.29h-6.08l18.68-44h6.08z" style="fill:#fff;fill-opacity:1"/></svg></span><span class="text-uppercase font-weight-bold">蚂蚁背大象</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/about/><span>Home</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog/><span>Java</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/spring/><span>Spring</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/middlewares/><span class=active>Middleware</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/><span>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/other/><span>Others</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community/><span>Community</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002 站内搜索…" aria-label=站内搜索… autocomplete=off></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/middlewares/netty/netty-source-code-analysis/>Return to the regular view of this page</a>.</p></div><h1 class=title>Netty源码解析</h1><ul><li>1: <a href=#pg-eef50a8d9221755d7fecca6b04c7cae1>Netty源码解析-SizeClasses</a></li><li>2: <a href=#pg-1d00fe045cb22ab8b80aa7fdd8ce0553>Netty源码解析-池化内存管理解析</a></li><li>3: <a href=#pg-7f84c18a1b4da472c65805bbe2dd8cc1>Netty FastThreadLocal相比Java ThreadLocal到底快在哪里?</a></li><li>4: <a href=#pg-c03b49486baafa8f2b7e87b2d7e6f286>Netty源码分析-EventLoopGroup如何工作</a></li><li>5: <a href=#pg-a3af78f2b1b21dfc8ab5892ed0ff4c62>Netty组件-EventLoop</a></li><li>6: <a href=#pg-0f44fc84bc0f4506d77828fab7f51513>Netty组件-ChannelHandler(图文并茂)</a></li><li>7: <a href=#pg-0740c3f51af7244086e1889ea8c8435e>Netty源码分析-ChannelHandler方法执行顺序和如何工作</a></li><li>8: <a href=#pg-35b67625f01f01e363b021a0c0f95b45>Netty源码解析-解码器(Decoder)是如何工作</a></li><li>9: <a href=#pg-af1451bcab2bc09841bb3d2cff9f454a>Netty源码解析-累加器(Cumulator)处理粘包半包问题</a></li><li>10: <a href=#pg-f2107ce17caba5b69cb4e0891217d5c0>Netty组件-ChannelHandlerContext和ChannelPipeline</a></li><li>11: <a href=#pg-fd7104d677d757634e721844134f9391>Netty源码解析-ChannelInboundHandler#channelRead参数Object对象到底是什么类型</a></li><li>12: <a href=#pg-ad9d1265ef52473ea3a544b21c1a651f>Netty源码解析-服务端启动流程详解</a></li><li>13: <a href=#pg-d653ef195ed2528f40195183d9a76540>Netty源码解析-EventLoop什么时候启动运行</a></li><li>14: <a href=#pg-b769ec828ee72b657fea63036f09c755>Netty源码分析-Channel如何从主线程切换到从线程</a></li></ul><div class=content></div></div><div class=td-content><h1 id=pg-eef50a8d9221755d7fecca6b04c7cae1>1 - Netty源码解析-SizeClasses</h1><blockquote><p>Netty版本：4.1.72.Final</p></blockquote><p>Netty的内存对齐类SizeClasses，它为Netty内存池中的内存块提供大小对齐，索引计算等服务方法。 <strong><code>4.1.72.Final</code></strong> 是 <strong><code>jemalloc4</code></strong> 的实现。<strong><code>jemalloc4</code></strong> 进一步优化了内存碎片的问题。jemalloc4 相较于 jemalloc3 最大的提升是进一步优化内存碎片问题，因为在 jemalloc3 中最多可能会导致 50% 内存碎片，但 jemalloc4 通过划分更细粒度的内存规格在一定程度上改善了这一问题，这也是 SizeClasses 的由来。</p><blockquote><p>Tips: <a href=https://github.com/netty/netty/issues/3910>https://github.com/netty/netty/issues/3910</a> (Netty Issues) 这里说明了jemalloc4的提升</p></blockquote><h3 id=1-netty内存规格>1. Netty内存规格</h3><p>这里讲的是基于 <strong><code>jemalloc4</code></strong> 实现的内存分配。</p><p><img src="https://github.com/mxsm/picture/blob/main/netty/Netty%E5%86%85%E5%AD%98%E8%A7%84%E6%A0%BC2.png?raw=true" alt=Netty内存规格2></p><p><strong><code>jemalloc4</code></strong> 取消了 <strong><code>Tiny</code></strong> 内存的规格。只保留了 <strong><code>small</code></strong> 、 <strong><code>normal</code></strong> 、 <strong><code>huge</code></strong> 三种规格。下面要分析的 <strong><code>SizeClasses</code></strong> 就是记录了 small和normal规格值的一张表。以及一些其他的有用的信息</p><h3 id=2-sizeclasses解析>2. SizeClasses解析</h3><p>先看一下 <strong><code>SizeClasses</code></strong> 类的说明。</p><h4 id=21-sizeclasses关键字段说明>2.1 SizeClasses关键字段说明</h4><ul><li><strong>LOG2_SIZE_CLASS_GROUP</strong>： 每次大小加倍时，size类计数的对数。值为：2</li><li><strong>LOG2_MAX_LOOKUP_SIZE</strong>：</li><li><strong>index</strong>： 内存块size的索引</li><li><strong>log2Group</strong>：内存块分组</li><li><strong>log2Delta</strong>：增量大小的log2值</li><li><strong>nDelta</strong>：增量乘数</li><li><strong>isMultiPageSize</strong>：表示size是否为page的倍数</li><li><strong>isSubPage</strong>：表示是否为一个subPage类型</li><li><strong>smallMaxSizeIdx</strong>：小规格内存的最小Index</li><li><strong>sizeClasses</strong>:元组表 [index, log2Group, log2Delta, nDelta, isMultiPageSize,isSubPage, log2DeltaLookup]</li></ul><p>看一下在Debug模式下 <strong><code>SizeClasses</code></strong> 相关的属性值</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/sizeClassesdebug%E7%9B%B8%E5%85%B3%E5%80%BC.png alt=sizeClassesdebug相关值></p><h4 id=22-sizeclasses格式>2.2 sizeClasses格式</h4><p>下面来看一下 <strong><code>sizeClasses</code></strong> 下保存了什么。</p><blockquote><p>源码的介绍中也给了一些说明，但是如果需要一个完整的要怎么办呢？ 同样我们可以写写一个简单的Netty项目，然后启动把debug的断点打在类里面如下图方式获取：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/nettySizeClasses.gif alt=nettySizeClasses></p></blockquote><p>表格的数据如下：</p><table><thead><tr><th style=text-align:center>index</th><th style=text-align:center>log2Group</th><th style=text-align:center>log2Delta</th><th style=text-align:center>nDelta</th><th style=text-align:center>isMultiPageSize</th><th style=text-align:center>isSubPage</th><th style=text-align:center>log2DeltaLookup</th><th>size</th></tr></thead><tbody><tr><td style=text-align:center>0</td><td style=text-align:center>4</td><td style=text-align:center>4</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>4</td><td>16B</td></tr><tr><td style=text-align:center>1</td><td style=text-align:center>4</td><td style=text-align:center>4</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>4</td><td>32B</td></tr><tr><td style=text-align:center>2</td><td style=text-align:center>4</td><td style=text-align:center>4</td><td style=text-align:center>2</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>4</td><td>48B</td></tr><tr><td style=text-align:center>3</td><td style=text-align:center>4</td><td style=text-align:center>4</td><td style=text-align:center>3</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>4</td><td>64B</td></tr><tr><td style=text-align:center>4</td><td style=text-align:center>6</td><td style=text-align:center>4</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>4</td><td>80B</td></tr><tr><td style=text-align:center>5</td><td style=text-align:center>6</td><td style=text-align:center>4</td><td style=text-align:center>2</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>4</td><td>96B</td></tr><tr><td style=text-align:center>6</td><td style=text-align:center>6</td><td style=text-align:center>4</td><td style=text-align:center>3</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>4</td><td>112B</td></tr><tr><td style=text-align:center>7</td><td style=text-align:center>6</td><td style=text-align:center>4</td><td style=text-align:center>4</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>4</td><td>128B</td></tr><tr><td style=text-align:center>8</td><td style=text-align:center>7</td><td style=text-align:center>5</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>5</td><td>160B</td></tr><tr><td style=text-align:center>9</td><td style=text-align:center>7</td><td style=text-align:center>5</td><td style=text-align:center>2</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>5</td><td>192B</td></tr><tr><td style=text-align:center>10</td><td style=text-align:center>7</td><td style=text-align:center>5</td><td style=text-align:center>3</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>5</td><td>224B</td></tr><tr><td style=text-align:center>11</td><td style=text-align:center>7</td><td style=text-align:center>5</td><td style=text-align:center>4</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>5</td><td>256B</td></tr><tr><td style=text-align:center>12</td><td style=text-align:center>8</td><td style=text-align:center>6</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>6</td><td>320B</td></tr><tr><td style=text-align:center>13</td><td style=text-align:center>8</td><td style=text-align:center>6</td><td style=text-align:center>2</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>6</td><td>384B</td></tr><tr><td style=text-align:center>14</td><td style=text-align:center>8</td><td style=text-align:center>6</td><td style=text-align:center>3</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>6</td><td>448B</td></tr><tr><td style=text-align:center>15</td><td style=text-align:center>8</td><td style=text-align:center>6</td><td style=text-align:center>4</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>6</td><td>512B</td></tr><tr><td style=text-align:center>16</td><td style=text-align:center>9</td><td style=text-align:center>7</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>7</td><td>640B</td></tr><tr><td style=text-align:center>17</td><td style=text-align:center>9</td><td style=text-align:center>7</td><td style=text-align:center>2</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>7</td><td>768B</td></tr><tr><td style=text-align:center>18</td><td style=text-align:center>9</td><td style=text-align:center>7</td><td style=text-align:center>3</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>7</td><td>896B</td></tr><tr><td style=text-align:center>19</td><td style=text-align:center>9</td><td style=text-align:center>7</td><td style=text-align:center>4</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>7</td><td>1024B</td></tr><tr><td style=text-align:center>20</td><td style=text-align:center>10</td><td style=text-align:center>8</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>8</td><td>1280B</td></tr><tr><td style=text-align:center>21</td><td style=text-align:center>10</td><td style=text-align:center>8</td><td style=text-align:center>2</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>8</td><td>1536B</td></tr><tr><td style=text-align:center>22</td><td style=text-align:center>10</td><td style=text-align:center>8</td><td style=text-align:center>3</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>8</td><td>1792B</td></tr><tr><td style=text-align:center>23</td><td style=text-align:center>10</td><td style=text-align:center>8</td><td style=text-align:center>4</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>8</td><td>2048B</td></tr><tr><td style=text-align:center>24</td><td style=text-align:center>11</td><td style=text-align:center>9</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>9</td><td>2560B</td></tr><tr><td style=text-align:center>25</td><td style=text-align:center>11</td><td style=text-align:center>9</td><td style=text-align:center>2</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>9</td><td>3072B</td></tr><tr><td style=text-align:center>26</td><td style=text-align:center>11</td><td style=text-align:center>9</td><td style=text-align:center>3</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>9</td><td>3584B</td></tr><tr><td style=text-align:center>27</td><td style=text-align:center>11</td><td style=text-align:center>9</td><td style=text-align:center>4</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>9</td><td>4096B</td></tr><tr><td style=text-align:center>28</td><td style=text-align:center>12</td><td style=text-align:center>10</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td>5120B</td></tr><tr><td style=text-align:center>29</td><td style=text-align:center>12</td><td style=text-align:center>10</td><td style=text-align:center>2</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td>6144B</td></tr><tr><td style=text-align:center>30</td><td style=text-align:center>12</td><td style=text-align:center>10</td><td style=text-align:center>3</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td>7168B</td></tr><tr><td style=text-align:center>31</td><td style=text-align:center>12</td><td style=text-align:center>10</td><td style=text-align:center>4</td><td style=text-align:center>1</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td>8K(PageSize)</td></tr><tr><td style=text-align:center>32</td><td style=text-align:center>13</td><td style=text-align:center>11</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td>10K</td></tr><tr><td style=text-align:center>33</td><td style=text-align:center>13</td><td style=text-align:center>11</td><td style=text-align:center>2</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td>12KB</td></tr><tr><td style=text-align:center>34</td><td style=text-align:center>13</td><td style=text-align:center>11</td><td style=text-align:center>3</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td>14KB</td></tr><tr><td style=text-align:center>35</td><td style=text-align:center>13</td><td style=text-align:center>11</td><td style=text-align:center>4</td><td style=text-align:center>1</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td>16KB</td></tr><tr><td style=text-align:center>36</td><td style=text-align:center>14</td><td style=text-align:center>12</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td>20KB</td></tr><tr><td style=text-align:center>37</td><td style=text-align:center>14</td><td style=text-align:center>12</td><td style=text-align:center>2</td><td style=text-align:center>1</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td>24KB</td></tr><tr><td style=text-align:center>38</td><td style=text-align:center>14</td><td style=text-align:center>12</td><td style=text-align:center>3</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td>28KB</td></tr><tr><td style=text-align:center>39</td><td style=text-align:center>14</td><td style=text-align:center>12</td><td style=text-align:center>4</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td>32KB</td></tr><tr><td style=text-align:center>40</td><td style=text-align:center>15</td><td style=text-align:center>13</td><td style=text-align:center>1</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td>40KB</td></tr><tr><td style=text-align:center>41</td><td style=text-align:center>15</td><td style=text-align:center>13</td><td style=text-align:center>2</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td>48KB</td></tr><tr><td style=text-align:center>42</td><td style=text-align:center>15</td><td style=text-align:center>13</td><td style=text-align:center>3</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td>56KB</td></tr><tr><td style=text-align:center>43</td><td style=text-align:center>15</td><td style=text-align:center>13</td><td style=text-align:center>4</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td>64KB</td></tr><tr><td style=text-align:center>44</td><td style=text-align:center>16</td><td style=text-align:center>14</td><td style=text-align:center>1</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td>80KB</td></tr><tr><td style=text-align:center>45</td><td style=text-align:center>16</td><td style=text-align:center>14</td><td style=text-align:center>2</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td>96KB</td></tr><tr><td style=text-align:center>46</td><td style=text-align:center>16</td><td style=text-align:center>14</td><td style=text-align:center>3</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td>112KB</td></tr><tr><td style=text-align:center>47</td><td style=text-align:center>16</td><td style=text-align:center>14</td><td style=text-align:center>4</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td>128KB</td></tr><tr><td style=text-align:center>48</td><td style=text-align:center>17</td><td style=text-align:center>15</td><td style=text-align:center>1</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td>160KB</td></tr><tr><td style=text-align:center>49</td><td style=text-align:center>17</td><td style=text-align:center>15</td><td style=text-align:center>2</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td>192KB</td></tr><tr><td style=text-align:center>50</td><td style=text-align:center>17</td><td style=text-align:center>15</td><td style=text-align:center>3</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td>224KB</td></tr><tr><td style=text-align:center>51</td><td style=text-align:center>17</td><td style=text-align:center>15</td><td style=text-align:center>4</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td>256KB</td></tr><tr><td style=text-align:center>52</td><td style=text-align:center>18</td><td style=text-align:center>16</td><td style=text-align:center>1</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td>320KB</td></tr><tr><td style=text-align:center>53</td><td style=text-align:center>18</td><td style=text-align:center>16</td><td style=text-align:center>2</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td>384KB</td></tr><tr><td style=text-align:center>54</td><td style=text-align:center>18</td><td style=text-align:center>16</td><td style=text-align:center>3</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td>448KB</td></tr><tr><td style=text-align:center>55</td><td style=text-align:center>18</td><td style=text-align:center>16</td><td style=text-align:center>4</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td>512KB</td></tr><tr><td style=text-align:center>56</td><td style=text-align:center>19</td><td style=text-align:center>17</td><td style=text-align:center>1</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td>640KB</td></tr><tr><td style=text-align:center>57</td><td style=text-align:center>19</td><td style=text-align:center>17</td><td style=text-align:center>2</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td>768KB</td></tr><tr><td style=text-align:center>58</td><td style=text-align:center>19</td><td style=text-align:center>17</td><td style=text-align:center>3</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td>896KB</td></tr><tr><td style=text-align:center>59</td><td style=text-align:center>19</td><td style=text-align:center>17</td><td style=text-align:center>4</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td>1.0MB</td></tr><tr><td style=text-align:center>60</td><td style=text-align:center>20</td><td style=text-align:center>18</td><td style=text-align:center>1</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td>1.25MB</td></tr><tr><td style=text-align:center>61</td><td style=text-align:center>20</td><td style=text-align:center>18</td><td style=text-align:center>2</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td>1.5MB</td></tr><tr><td style=text-align:center>62</td><td style=text-align:center>20</td><td style=text-align:center>18</td><td style=text-align:center>3</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td>1.75MB</td></tr><tr><td style=text-align:center>63</td><td style=text-align:center>20</td><td style=text-align:center>18</td><td style=text-align:center>4</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td>2MB</td></tr><tr><td style=text-align:center>64</td><td style=text-align:center>21</td><td style=text-align:center>19</td><td style=text-align:center>1</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td>2.5MB</td></tr><tr><td style=text-align:center>65</td><td style=text-align:center>21</td><td style=text-align:center>19</td><td style=text-align:center>2</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td>3MB</td></tr><tr><td style=text-align:center>66</td><td style=text-align:center>21</td><td style=text-align:center>19</td><td style=text-align:center>3</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td>3.5MB</td></tr><tr><td style=text-align:center>67</td><td style=text-align:center>21</td><td style=text-align:center>19</td><td style=text-align:center>4</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td>4MB</td></tr><tr><td style=text-align:center>68</td><td style=text-align:center>22</td><td style=text-align:center>20</td><td style=text-align:center>1</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td>5MB</td></tr><tr><td style=text-align:center>69</td><td style=text-align:center>22</td><td style=text-align:center>20</td><td style=text-align:center>2</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td>6MB</td></tr><tr><td style=text-align:center>70</td><td style=text-align:center>22</td><td style=text-align:center>20</td><td style=text-align:center>3</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td>7MB</td></tr><tr><td style=text-align:center>71</td><td style=text-align:center>22</td><td style=text-align:center>20</td><td style=text-align:center>4</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td>8MB</td></tr><tr><td style=text-align:center>72</td><td style=text-align:center>23</td><td style=text-align:center>21</td><td style=text-align:center>1</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td>10MB</td></tr><tr><td style=text-align:center>73</td><td style=text-align:center>23</td><td style=text-align:center>21</td><td style=text-align:center>2</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td>12MB</td></tr><tr><td style=text-align:center>74</td><td style=text-align:center>23</td><td style=text-align:center>21</td><td style=text-align:center>3</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td>14MB</td></tr><tr><td style=text-align:center>75</td><td style=text-align:center>23</td><td style=text-align:center>21</td><td style=text-align:center>4</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td>16MB</td></tr></tbody></table><blockquote><p>表格最后面的size如何获取呢？简单的方式还是用debug的方式获取：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/image-20220108163159653.png alt=image-20220108163159653></p><p>使用IDEA的 <strong><code>Add Inline Watch</code></strong> 增加如下的打印</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/image-20220108163134197.png alt=image-20220108163134197></p></blockquote><p>表格说明：</p><ul><li>不管是Small和normal的内存规格的内存，分割的粒度更小。</li><li>从 <strong><code>isSubPage</code></strong> 列可以看出来， 内存小于等于 <strong><code>28K</code></strong> 表示Subpage</li></ul><h4 id=23-源码分析>2.3 源码分析</h4><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/image-20220108170650412.png alt=image-20220108170650412></p><p><strong><code>SizeClasses#sizeClasses</code></strong> 方法负责 计算 <strong><code>sizeClasses</code></strong> 表格。<strong><code>SizeClasses</code></strong> 主要负责根据请求的分配的内存大小规范到最接近 <strong><code>sizeClasses</code></strong> 表格中的最接近的大小。</p><h3 id=3-总结>3. 总结</h3><ul><li><strong><code>SizeClasses</code></strong> 主要是 <strong><code>jemalloc4</code></strong> 的实现，为了更细粒度的管理内存，减少内存碎片的产生</li><li><strong><code>jemalloc4</code></strong> 没有做深入的研究，如果有想研究的可以去<a href=https://github.com/jemalloc/jemalloc>Github</a> 研究C 的实现</li><li><strong><code>jemalloc4</code></strong> 的内存规格减少了Tiny类型，这个也提现在Netty的实现中，在 <strong><code>SizeClass</code></strong> 枚举类中也去掉了 <strong><code>Tiny</code></strong> 类型</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-1d00fe045cb22ab8b80aa7fdd8ce0553>2 - Netty源码解析-池化内存管理解析</h1><blockquote><p>Netty版本：4.1.72.Final</p></blockquote><p>Netty当下最热火最热门的网络编程框架需要处理海量的字节数据。Netty提供了字节池化的机制。对象池化内存分配，使用完成后归给内存次。池化内存，那么内存的管理必不可少。Netty基于<a href=http://jemalloc.net/>jemalloc</a> 实现了一套内存分配和管理的机制。</p><blockquote><p>GitHub地址：https://github.com/jemalloc/jemalloc</p><p>4.1.72.Final 版本基于 jemalloc4 实现</p></blockquote><p>借鉴 <strong><code>jemalloc</code></strong> 用来解决两个问题：</p><ul><li>多线程下的内存回收与分配</li><li>内存的碎片化问题(不断分配和回收过程中会产生，jemalloc4 进一步优化了内存碎片产生)</li></ul><h3 id=1-netty中内存的规格>1. Netty中内存的规格</h3><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/Netty%E5%86%85%E5%AD%98%E8%A7%84%E6%A0%BC2.png alt="Netty内存规格2 (1)"></p><p>如上图所示Netty中内存规格分为三类(SizeClass中定义了)：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>SizeClass</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Small</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>Normal</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote><p>Tiny现在已经去掉</p></blockquote><ul><li>small：0-28K（包含）</li><li>normal: 28K(不包含)-16M(包含)</li><li>Huge: 大于16M（不会进行池化）</li></ul><blockquote><p>Hotspot虚拟机的自动内存管理系统要求对象起始地址必须是8字节的整数倍，换句话说就是对象的大小必须是8字节的整数倍。而对象头部分正好是8字节的倍数（1倍或2倍），因此，当对象实例数据部分没有对齐时，就需要通过对齐填充来补全。</p></blockquote><p>Netty的内存管理实现借鉴了 <strong><code>jemalloc</code></strong> 所以很多概念和 <strong><code>jemalloc</code></strong> 中的概念相同。</p><ul><li><strong>Chunk</strong>：Netty向操作系统申请内存的最小单位(默认值16M),是Run的集合</li><li><strong>Run</strong>: 对应一块连续的内存，大小是Page的倍数</li><li><strong>Page</strong>: Chunk的最小分配单元，默认大小为8K,一个Chunk默认有2K个Page.</li><li><strong>Subpage</strong>: 负责Page内的内存分配，目的是为了减少内存的浪费。如果需要分配的内存小于Page的大小(8K)比如只有100B,如果直接分配一个Page(8K)那就直接浪费了。Subpage的最小是16B的倍数。Subpage没有固定的大小，需要根据用户分配的缓冲区决定。</li></ul><h3 id=2-netty内存池的数据结构>2. Netty内存池的数据结构</h3><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/%E5%86%85%E5%AD%98%E6%B1%A0%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.png alt=内存池的数据结构></p><p>通过图可以知道，Netty根据内存模型抽象出来了一些组件， <strong><code>PoolArena、PoolChunk、PoolChunkList、PoolSubpage、PoolThreadCache、MemoryRegionCache</code></strong> 下面根据不同模块结合代码逐一分析其数据结构和实现。</p><blockquote><p>Tips:很多概念和jemalloc中的概念相似大同小异，当前研究的代码版本中取消了网上很多资料里面出现的内存规格 <strong><code>tiny</code></strong> 类型。只有 <strong>small、normal、huge</strong>, 具体是因为当前的版本的Netty内存分配实现是基于 <strong><code>jemalloc4</code></strong> 。</p></blockquote><h4 id=21-poolsubpage数据结构解析>2.1 PoolSubpage数据结构解析</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PoolSubpage</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>PoolSubpageMetric</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PoolChunk</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>chunk</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//所属的chunk
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>pageShifts</span><span style=color:#ce5c00;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>//页面偏移量
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>runOffset</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//PoolSubpage 在 PoolChunk 中 memory 的偏移量
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>runSize</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//Run的大小
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>bitmap</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//每一块小内存状态
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#000>PoolSubpage</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>prev</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//前一个PoolSubpage
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>PoolSubpage</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//后一个PoolSubpage
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>doNotDestroy</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>elemSize</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// 每个小内存块的大小（最小16B）
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>maxNumElems</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// 最多可以存放多少小内存块：8K(page默认大小)/elemSize=512
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>bitmapLength</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>nextAvail</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>numAvail</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// 可用于分配的内存块个数
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这里需要关注两个点：</p><ul><li>bitmap如何记录内存状态</li><li>PoolSubpage如何和PoolArena关联</li></ul><p><strong>bitmap如何记录内存状态：</strong></p><p><strong><code>bitmap</code></strong> 数组长度由 <strong><code>PoolSubpage</code></strong> 的构造函数中的一段代码决定:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//LOG2_QUANTUM=4
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>bitmap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>long</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>runSize</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>6</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>LOG2_QUANTUM</span><span style=color:#ce5c00;font-weight:700>];</span>
</code></pre></div><p>那么 <strong><code>runSize</code></strong> 的大小决定了 <strong><code>bitmap</code></strong> 的大小。 <strong>PoolChunk#allocateSubpage</strong> 分配 <strong><code>Run</code></strong> （Run的大小也是这里决定）</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>allocateSubpage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>sizeIdx</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// Obtain the head of the PoolSubPage pool that is owned by the PoolArena and synchronize on it.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// This is need as we may add it back and so alter the linked-list structure.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>PoolSubpage</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>head</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>arena</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findSubpagePoolHead</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sizeIdx</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>head</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//allocate a new run
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>runSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>calculateRunSize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sizeIdx</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>//runSize must be multiples of pageSize
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>runHandle</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>allocateRun</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>runSize</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>runHandle</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>runOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>runOffset</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>runHandle</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>assert</span> <span style=color:#000>subpages</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>runOffset</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>elemSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>arena</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sizeIdx2size</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sizeIdx</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#000>PoolSubpage</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>subpage</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PoolSubpage</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>head</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pageShifts</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>runOffset</span><span style=color:#ce5c00;font-weight:700>,</span>
                               <span style=color:#000>runSize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pageShifts</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>runHandle</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>elemSize</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#000>subpages</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>runOffset</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>subpage</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>subpage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allocate</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote><p>Tips: Run必须是PageSize的倍数。</p></blockquote><p><strong><code>PoolSubpage</code></strong> 通过位图 <strong><code>bitmap</code></strong> 记录子内存是否已经被使用，bit 的取值为 0 或者 1</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/SubpageBitmap%20(1).png alt="SubpageBitmap (1)"></p><p><strong>PoolSubpage如何和PoolArena关联</strong></p><p>在前面的图有体现， <strong><code>PoolArena</code></strong> 类中有一个 <strong><code>smallSubpagePools</code></strong> 属性。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PoolArena</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>SizeClasses</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>PoolArenaMetric</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PoolSubpage</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>smallSubpagePools</span><span style=color:#ce5c00;font-weight:700>;</span>
    
     <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>PoolArena</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PooledByteBufAllocator</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>pageSize</span><span style=color:#ce5c00;font-weight:700>,</span>
          <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>pageShifts</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>chunkSize</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>cacheAlignment</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         
         <span style=color:#8f5902;font-style:italic>//省略部分代码 
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>numSmallSubpagePools</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nSubpages</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// nsubpage = 39 查看之前的 《Netty源码解析-SizeClasses》文章中截图有
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>smallSubpagePools</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newSubpagePoolArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>numSmallSubpagePools</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>smallSubpagePools</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>smallSubpagePools</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newSubpagePoolHead</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
         
        <span style=color:#8f5902;font-style:italic>//省略部分代码
</span><span style=color:#8f5902;font-style:italic></span>     <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>PoolSubpage</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>newSubpagePoolHead</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>PoolSubpage</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>head</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PoolSubpage</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
        <span style=color:#000>head</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prev</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>head</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>head</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>head</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>head</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/PoolArena%E5%92%8CSubpage%E5%85%B3%E8%81%94%20(1).png alt="PoolArena和Subpage关联 (1)"></p><p>Subpage有39个可以选择的类型。</p><h4 id=22-poolchunk数据结构解析>2.2 PoolChunk数据结构解析</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PoolChunk</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>PoolChunkMetric</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>SIZE_BIT_LENGTH</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>15</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>INUSED_BIT_LENGTH</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>SUBPAGE_BIT_LENGTH</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>BITMAP_IDX_BIT_LENGTH</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>32</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>IS_SUBPAGE_SHIFT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>BITMAP_IDX_BIT_LENGTH</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>IS_USED_SHIFT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SUBPAGE_BIT_LENGTH</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>IS_SUBPAGE_SHIFT</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>SIZE_SHIFT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>INUSED_BIT_LENGTH</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>IS_USED_SHIFT</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>RUN_OFFSET_SHIFT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SIZE_BIT_LENGTH</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>SIZE_SHIFT</span><span style=color:#ce5c00;font-weight:700>;</span>

     
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PoolArena</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>arena</span><span style=color:#ce5c00;font-weight:700>;</span>   <span style=color:#8f5902;font-style:italic>//所属的PoolArena
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>base</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>T</span> <span style=color:#000>memory</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// 存储的数据
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>unpooled</span><span style=color:#ce5c00;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>//是否池化
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>LongLongHashMap</span> <span style=color:#000>runsAvailMap</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//管理PoolChunk的所有的Run（使用或者没有使用）
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>LongPriorityQueue</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>runsAvail</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// 优先队列，每一个队列管理同样大小的Run
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PoolSubpage</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>subpages</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//PoolSubpage列表
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>pageSize</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>pageShifts</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>chunkSize</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Deque</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ByteBuffer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>cachedNioBuffers</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>freeBytes</span><span style=color:#ce5c00;font-weight:700>;</span>  
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>pinnedBytes</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#000>PoolChunkList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>PoolChunk</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>prev</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//前置节点
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>PoolChunk</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//后置节点
</span><span style=color:#8f5902;font-style:italic></span>	
    <span style=color:#8f5902;font-style:italic>//省略部分代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>Chunk内存中的结构如图：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/Netty-Chunk-Layout.png alt=Netty-Chunk-Layout></p><ul><li>Page组成Run,Run的大小必须是Page的整数倍 RunSize = N * PageSize (N >= 1的整数)</li><li>Subpage的大小为 16B-28K,所以有时候Subpage也包含多个Page（这里是jemalloc4为了进一步解决内存碎片化的问题）</li><li>Chunk中还有一些没有使用的内存段。这些可以待分配</li></ul><p>那么这些内存的状态以及大小什么的如何管理？ 在Chunk中定义了一个 handle（long类型）</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/Netty-chunk-handle%20(1).png alt="Netty-chunk-handle (1)"></p><p>如上图，从上到下分别long的高位到低位。</p><ul><li><strong>o（runOffset）: runOffset(页面的在Chunk的偏移量)，15bit</strong></li><li><strong>s（size）: Run的大小(这个字段存的是page的数量)， 15bit</strong></li><li><strong>u（isUsed）: 当前内存是否使用标记位，1bit</strong></li><li><strong>e（isSubpage）: 当前是否为Subpage标记位，1bit</strong></li><li><strong>b（bitmapIdx）: Subpage的位图索引(bitmapIdx),如果为0表示不是Subpage,32bit</strong></li></ul><p>然后关注一下 <strong><code>PoolChunk</code></strong> 的几个重要属性：</p><ul><li><p><strong>runsAvailMap</strong></p><p>管理Run状态的(使用，未使用)的map</p><p><strong>key: runOffset</strong></p><p><strong>value: handle</strong></p></li><li><p><strong>runsAvail</strong></p><p>一个优先队列数组，每一个队列管理相同大小的Runs。 Run按照offset进行存储，所以我们总是用较小的偏移量分配运行(优先队列的特点)</p></li></ul><p><strong>PoolChunk关键算法解析：</strong></p><ul><li><p><strong>初始化</strong></p><p>在一开始，我们存储了初始运行，也就是整个数据块，初始化的Run:</p><pre><code class=language-properties data-lang=properties>runOffset = 0
size = chunkSize
isUsed = false
isSubpage = false
bitmapIdx = 0
</code></pre></li><li><p><strong>PoolChunk#allocateRun(int runSize)算法</strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>allocateRun</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>runSize</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>pages</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>runSize</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>pageShifts</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>pageIdx</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>arena</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pages2pageIdx</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pages</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>runsAvail</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//find first queue which has at least one big enough run
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>queueIdx</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>runFirstBestFit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pageIdx</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>queueIdx</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>//get run with min offset in this queue
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>LongPriorityQueue</span> <span style=color:#000>queue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>runsAvail</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>queueIdx</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>handle</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>queue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>poll</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#204a87;font-weight:700>assert</span> <span style=color:#000>handle</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>LongPriorityQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NO_VALUE</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>isUsed</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handle</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#34;invalid handle: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>handle</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#000>removeAvailRun</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>queue</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>handle</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handle</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>handle</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>splitLargeRun</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handle</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pages</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>pinnedSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>runSize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pageShifts</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>handle</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>freeBytes</span> <span style=color:#ce5c00;font-weight:700>-=</span> <span style=color:#000>pinnedSize</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>pinnedBytes</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>pinnedSize</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>handle</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ol><li>根据runSize找到第一个可用的Run在 <strong><code>runsAvail</code></strong> 数组</li><li>如果Run的Page大于请求Page，则将其拆分，并且保存剩下的Run随后使用</li></ol></li><li><p><strong>PoolChunk#allocateSubpage(int sizeIdx)算法</strong></p><pre><code>private long allocateSubpage(int sizeIdx) {
    // Obtain the head of the PoolSubPage pool that is owned by the PoolArena and synchronize on it.
    // This is need as we may add it back and so alter the linked-list structure.
    PoolSubpage&lt;T&gt; head = arena.findSubpagePoolHead(sizeIdx);
    synchronized (head) {
        //allocate a new run
        int runSize = calculateRunSize(sizeIdx);
        //runSize must be multiples of pageSize
        long runHandle = allocateRun(runSize);
        if (runHandle &lt; 0) {
            return -1;
        }

        int runOffset = runOffset(runHandle);
        assert subpages[runOffset] == null;
        int elemSize = arena.sizeIdx2size(sizeIdx);

        PoolSubpage&lt;T&gt; subpage = new PoolSubpage&lt;T&gt;(head, this, pageShifts, runOffset,
                           runSize(pageShifts, runHandle), elemSize);

        subpages[runOffset] = subpage;
        return subpage.allocate();
    }
}
</code></pre><ol><li>根据sizeIdx找到一个没有满的Subpage。如果存在就返回，否则分配一个新的PoolSubpage,然后调用init()。注意：当调用init()这个subpage对象被添加到PoolArena的 subpagesPool 中。</li><li>调用 <strong><code>subpage.allocate()</code></strong> 分配</li></ol></li><li><p><strong>PoolChunk#free(long handle, int normCapacity, ByteBuffer nioBuffer)算法</strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>free</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>handle</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>normCapacity</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ByteBuffer</span> <span style=color:#000>nioBuffer</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>runSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>runSize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pageShifts</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>handle</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>pinnedBytes</span> <span style=color:#ce5c00;font-weight:700>-=</span> <span style=color:#000>runSize</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isSubpage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handle</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>sizeIdx</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>arena</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size2SizeIdx</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>normCapacity</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>PoolSubpage</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>head</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>arena</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findSubpagePoolHead</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sizeIdx</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>sIdx</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>runOffset</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handle</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>PoolSubpage</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>subpage</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>subpages</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>sIdx</span><span style=color:#ce5c00;font-weight:700>];</span>
            <span style=color:#204a87;font-weight:700>assert</span> <span style=color:#000>subpage</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>subpage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doNotDestroy</span><span style=color:#ce5c00;font-weight:700>;</span>

            <span style=color:#8f5902;font-style:italic>// Obtain the head of the PoolSubPage pool that is owned by the PoolArena and synchronize on it.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// This is need as we may add it back and so alter the linked-list structure.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>head</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>subpage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>free</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>head</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bitmapIdx</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handle</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>//the subpage is still used, do not free it
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>assert</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>subpage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doNotDestroy</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#8f5902;font-style:italic>// Null out slot in the array as it was freed and we should not use it anymore.
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>subpages</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>sIdx</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>//start free run
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>runsAvail</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// collapse continuous runs, successfully collapsed runs
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// will be removed from runsAvail and runsAvailMap
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>finalRun</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>collapseRuns</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handle</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#8f5902;font-style:italic>//set run as not used
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>finalRun</span> <span style=color:#ce5c00;font-weight:700>&amp;=</span> <span style=color:#ce5c00;font-weight:700>~(</span><span style=color:#000>1L</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>IS_USED_SHIFT</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>//if it is a subpage, set it to run
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>finalRun</span> <span style=color:#ce5c00;font-weight:700>&amp;=</span> <span style=color:#ce5c00;font-weight:700>~(</span><span style=color:#000>1L</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>IS_SUBPAGE_SHIFT</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#000>insertAvailRun</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>runOffset</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>finalRun</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>runPages</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>finalRun</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>finalRun</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>freeBytes</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>runSize</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nioBuffer</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>cachedNioBuffers</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
            <span style=color:#000>cachedNioBuffers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>PooledByteBufAllocator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DEFAULT_MAX_CACHED_BYTEBUFFERS_PER_CHUNK</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>cachedNioBuffers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>offer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nioBuffer</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div><ol><li>如果是Subpage,那么将分片返回到当前的Subpage.</li><li>如果Subpage没有被使用或者是一个Run,开启释放Run</li><li>合并连续可用的Run</li><li>保存合并的Run</li></ol></li></ul><h4 id=23-poolarena数据结构解析>2.3 PoolArena数据结构解析</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PoolArena</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>SizeClasses</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>PoolArenaMetric</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>HAS_UNSAFE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PlatformDependent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasUnsafe</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>SizeClass</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Small</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>Normal</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PooledByteBufAllocator</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//所属分配器
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>numSmallSubpagePools</span><span style=color:#ce5c00;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>// 39
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>directMemoryCacheAlignment</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PoolSubpage</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>smallSubpagePools</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PoolChunkList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>q050</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PoolChunkList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>q025</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PoolChunkList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>q000</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PoolChunkList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>qInit</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PoolChunkList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>q075</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PoolChunkList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>q100</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PoolChunkListMetric</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>chunkListMetrics</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// Metrics for allocations and deallocations
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>allocationsNormal</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// We need to use the LongCounter here as this is not guarded via synchronized block.
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>LongCounter</span> <span style=color:#000>allocationsSmall</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PlatformDependent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newLongCounter</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>LongCounter</span> <span style=color:#000>allocationsHuge</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PlatformDependent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newLongCounter</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>LongCounter</span> <span style=color:#000>activeBytesHuge</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PlatformDependent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newLongCounter</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>deallocationsSmall</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>deallocationsNormal</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// We need to use the LongCounter here as this is not guarded via synchronized block.
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>LongCounter</span> <span style=color:#000>deallocationsHuge</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PlatformDependent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newLongCounter</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#8f5902;font-style:italic>// Number of thread caches backed by this arena.
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>AtomicInteger</span> <span style=color:#000>numThreadCaches</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AtomicInteger</span><span style=color:#ce5c00;font-weight:700>();</span>
    
    
    <span style=color:#8f5902;font-style:italic>//省略部分代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>Netty 借鉴了 jemalloc 中 Arena 的设计思想，采用固定数量的多个 Arena 进行内存分配，Arena 的默认数量通常是CPU核数*2(也可能选择内存计算关系较小的一个)，通过创建多个 Arena 来缓解资源竞争问题，从而提高内存分配效率。线程在首次申请分配内存时，会通过 round-robin 的方式轮询 Arena 数组，选择一个固定的 Arena，在线程的生命周期内只与该 Arena 打交道，所以每个线程都保存了 Arena 信息，从而提高访问效率。下面代码就是计算PoolArena默认个数：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PooledByteBufAllocator</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractByteBufAllocator</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>ByteBufAllocatorMetricProvider</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>DEFAULT_NUM_HEAP_ARENA</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//默认arena的数量
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>DEFAULT_NUM_DIRECT_ARENA</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//默认arena的数量
</span><span style=color:#8f5902;font-style:italic></span>    
    <span style=color:#204a87;font-weight:700>static</span><span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>defaultMinNumArena</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>NettyRuntime</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>availableProcessors</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>defaultChunkSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>DEFAULT_PAGE_SIZE</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>DEFAULT_MAX_ORDER</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>DEFAULT_NUM_HEAP_ARENA</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>max</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#000>SystemPropertyUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInt</span><span style=color:#ce5c00;font-weight:700>(</span>
                        <span style=color:#4e9a06>&#34;io.netty.allocator.numHeapArenas&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                        <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>min</span><span style=color:#ce5c00;font-weight:700>(</span>
                                <span style=color:#000>defaultMinNumArena</span><span style=color:#ce5c00;font-weight:700>,</span>
                                <span style=color:#000>runtime</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>maxMemory</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>defaultChunkSize</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>2</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>)));</span>
        <span style=color:#000>DEFAULT_NUM_DIRECT_ARENA</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>max</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#000>SystemPropertyUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInt</span><span style=color:#ce5c00;font-weight:700>(</span>
                        <span style=color:#4e9a06>&#34;io.netty.allocator.numDirectArenas&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                        <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>min</span><span style=color:#ce5c00;font-weight:700>(</span>
                                <span style=color:#000>defaultMinNumArena</span><span style=color:#ce5c00;font-weight:700>,</span>
                                <span style=color:#000>PlatformDependent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>maxDirectMemory</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>defaultChunkSize</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>2</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>)));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong><code>PoolArena</code></strong> 有两个实现分别对应堆内内存和堆外内存：</p><ul><li><strong>DirectArena</strong></li><li><strong>HeapArena</strong></li></ul><p>图示数据结构如图：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/PoolArena%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%20(1).png alt="PoolArena数据结构 (1)"></p><p>包含了一个 <strong><code>smallSubpagePools（ PoolSubpage&lt;T>[]）</code></strong> 和6个PoolChunkList<t> 。</p><ul><li>smallSubpagePools存放small Subpage类型的内存快</li><li>6个PoolChunkList 存放使用率不同的Chunk,构成一个双向循环链表</li></ul><p><strong><code>PoolArena</code></strong> 对应实现了 <strong><code>Subpage</code></strong> 和 <strong><code>Chunk</code></strong> 中的内存分配。 <strong><code>PoolSubpage</code></strong> 负责分配小于等于28K的内存，<strong><code>PoolChunkList</code></strong> 负责大于等于32K的内存。<strong><code>PoolSubpage</code></strong> 分配的内存情况有39种(为什么可以查看之前的《Netty源码解析-SizeClasses》)。</p><p><strong><code>PoolChunkList</code></strong> 在 <strong><code>PoolArena</code></strong> 初始化了6个：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>PoolArena</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PooledByteBufAllocator</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>pageSize</span><span style=color:#ce5c00;font-weight:700>,</span>
          <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>pageShifts</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>chunkSize</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>cacheAlignment</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>q100</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PoolChunkList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>100</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MAX_VALUE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>chunkSize</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>q075</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PoolChunkList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>q100</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>75</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>100</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>chunkSize</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>q050</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PoolChunkList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>q075</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>50</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>100</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>chunkSize</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>q025</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PoolChunkList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>q050</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>25</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>75</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>chunkSize</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>q000</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PoolChunkList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>q025</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>50</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>chunkSize</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>qInit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PoolChunkList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>q000</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MIN_VALUE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>25</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>chunkSize</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#000>q100</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prevList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>q075</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>q075</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prevList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>q050</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>q050</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prevList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>q025</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>q025</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prevList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>q000</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>q000</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prevList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>qInit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prevList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>qInit</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/ChunkList%E4%BD%BF%E7%94%A8%E7%8E%87%20(1).png alt="ChunkList使用率 (1)"></p><p>Chunk 内存使用率的变化，Netty 会重新检查内存的使用率并放入对应的 PoolChunkList，所以 PoolChunk 会在不同的 PoolChunkList 移动。</p><p><strong>疑问1：qInit 和 q000 为什么需要设计成两个</strong></p><p>qInit 用于存储初始分配的 PoolChunk，因为在第一次内存分配时，PoolChunkList 中并没有可用的 PoolChunk，所以需要新创建一个 PoolChunk 并添加到 qInit 列表中。qInit 中的 PoolChunk 即使内存被完全释放也不会被回收，避免 PoolChunk 的重复初始化工作。</p><p><strong>疑问2：在方法 PoolArena#allocateNormal 为什么首先判断的是 q050</strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>allocateNormal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PooledByteBuf</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>reqCapacity</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>sizeIdx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>PoolThreadCache</span> <span style=color:#000>threadCache</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>q050</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allocate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>reqCapacity</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sizeIdx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>threadCache</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span>
            <span style=color:#000>q025</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allocate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>reqCapacity</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sizeIdx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>threadCache</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span>
            <span style=color:#000>q000</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allocate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>reqCapacity</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sizeIdx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>threadCache</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span>
            <span style=color:#000>qInit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allocate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>reqCapacity</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sizeIdx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>threadCache</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span>
            <span style=color:#000>q075</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allocate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>reqCapacity</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sizeIdx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>threadCache</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// Add a new chunk.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>PoolChunk</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newChunk</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pageSize</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nPSizes</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pageShifts</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>chunkSize</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>success</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allocate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>reqCapacity</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sizeIdx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>threadCache</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>assert</span> <span style=color:#000>success</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>qInit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>分配的逻辑 q050 &mdash;&ndash;> q025 &mdash;&ndash;> q000 &mdash;-> qInit &mdash;-> q075。</p><p>网上解释：折中的选择，在频繁分配内存的场景下，如果从 q000 开始，会有大部分的 PoolChunk 面临频繁的创建和销毁，造成内存分配的性能降低。如果从 q050 开始，会使 PoolChunk 的使用率范围保持在中间水平，降低了 PoolChunk 被回收的概率，从而兼顾了性能。(没有看到官方的设计说明)</p><h4 id=24-poolchunklist数据结构解析>2.4 PoolChunkList数据结构解析</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PoolChunkList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>PoolChunkListMetric</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Iterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PoolChunkMetric</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>EMPTY_METRICS</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Collections</span><span style=color:#ce5c00;font-weight:700>.&lt;</span><span style=color:#000>PoolChunkMetric</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000>emptyList</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>iterator</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PoolArena</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>arena</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PoolChunkList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>nextList</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>minUsage</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>maxUsage</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>maxCapacity</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>PoolChunk</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>head</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>freeMinThreshold</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>freeMaxThreshold</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// This is only update once when create the linked like list of PoolChunkList in PoolArena constructor.
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>PoolChunkList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>prevList</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从上面的数据结构可以看出来，PoolChunkList组成了一个双向循环列表。</p><p>上面就是池化内存分配过程中使用的类和相关的数据结构。但是在分配缓存的过程中还有一个缓存存在。下面来分析一下缓存。缓存主要涉及到两个类：</p><ul><li><strong>PoolThreadCache</strong></li><li><strong>MemoryRegionCache</strong></li></ul><h3 id=3-池化分配中的缓存>3. 池化分配中的缓存</h3><h4 id=31-poolthreadcache>3.1 PoolThreadCache</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PoolThreadCache</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>InternalLogger</span> <span style=color:#000>logger</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>InternalLoggerFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PoolThreadCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>INTEGER_SIZE_MINUS_ONE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SIZE</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PoolArena</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]&gt;</span> <span style=color:#000>heapArena</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PoolArena</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ByteBuffer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>directArena</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// Hold the caches for the different size classes, which are tiny, small and normal.
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MemoryRegionCache</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]&gt;[]</span> <span style=color:#000>smallSubPageHeapCaches</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MemoryRegionCache</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ByteBuffer</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>smallSubPageDirectCaches</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MemoryRegionCache</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]&gt;[]</span> <span style=color:#000>normalHeapCaches</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MemoryRegionCache</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ByteBuffer</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>normalDirectCaches</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>freeSweepAllocationThreshold</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>AtomicBoolean</span> <span style=color:#000>freed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AtomicBoolean</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>allocations</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>Netty官方的说明：充当分配的线程缓存。这个和jemalloc可伸缩内存分配技术一样。</p><p>当内存释放时，与 jemalloc 一样，Netty 并没有将缓存归还给 PoolChunk，而是使用 PoolThreadCache 缓存起来，当下次有同样规格的内存分配时，直接从 PoolThreadCache 取出使用即可。这个可在 <strong><code>PoolArena#tcacheAllocateSmall</code></strong> 方法可以看出来：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>tcacheAllocateSmall</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PoolThreadCache</span> <span style=color:#000>cache</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>PooledByteBuf</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>reqCapacity</span><span style=color:#ce5c00;font-weight:700>,</span>
                                     <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>sizeIdx</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allocateSmall</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>reqCapacity</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sizeIdx</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// was able to allocate out of the cache so move on
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#8f5902;font-style:italic>//省略部分代码
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在PoolThreadCache缓存的时候使用了 <strong><code>MemoryRegionCache</code></strong> 。 存在两个纬度：</p><ul><li>堆内或者堆外</li><li>small或者normal</li></ul><h4 id=32-memoryregioncache>3.2 MemoryRegionCache</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MemoryRegionCache</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Queue</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>queue</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SizeClass</span> <span style=color:#000>sizeClass</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>allocations</span><span style=color:#ce5c00;font-weight:700>;</span>
     
     <span style=color:#8f5902;font-style:italic>//省略部分代码
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>MemoryRegionCache</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SizeClass</span> <span style=color:#000>sizeClass</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MathUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>safeFindNextPositivePowerOfTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>queue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PlatformDependent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newFixedMpscQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sizeClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sizeClass</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
 <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这里有几个属性：</p><ul><li>size: 队列长度， small默认值为256， Normal的默认值为64</li></ul><blockquote><p>缓存最大数据大小为32K(PooledByteBufAllocator的静态变量DEFAULT_MAX_CACHED_BUFFER_CAPACITY设置了)</p></blockquote><h3 id=4-netty-池化内存分配流程>4. Netty 池化内存分配流程</h3><p><strong><code>Netty</code></strong> 池化 <strong><code>ByteBuf</code></strong> 分配由 <strong><code>PooledByteBufAllocator</code></strong> 来分配。分配流程如下：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/Netty%E6%B1%A0%E5%8C%96%E5%88%86%E9%85%8D%E6%B5%81%E7%A8%8B%20.png alt="Netty池化分配流程 "></p><h3 id=5-总结>5. 总结</h3><ul><li>Netty内存分配现在是基于jemalloc4实现的，数据结构模型和之前的有所区别，特别是Chunk的分配管理上面</li><li>Page, Subpage, PoolSubpage, PoolChunk、ChunkList、Run， PoolArena等相关类是实现池化内存分配的重要组成</li><li>**<code>PooledByteBufAllocator</code>**继承了分配的顶层接口 <strong><code>ByteBufAllocator</code></strong> 来作为分配堆内和堆外池化内存的入口</li><li><strong><code>PoolThreadLocalCache</code></strong> 负责缓存分配的内存，Small 的缓存队列默认长度为256，Normal的缓存队列默认长度为64，默认的最大缓存大小32K。</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-7f84c18a1b4da472c65805bbe2dd8cc1>3 - Netty FastThreadLocal相比Java ThreadLocal到底快在哪里?</h1><p>在Netty中有这样一个类 <strong>FastThreadLocal</strong> 从名字可以看出来应该和Java原有的 <strong>ThreadLocal</strong> 有着同样的作用，但是前面加了一个修饰 <strong><code>Fast</code></strong> ，这意思就是具有和Java原有的 <strong>ThreadLocal</strong> 有着同样的作用但是比它快。那到底是怎么样的设计能让 <strong>FastThreadLocal</strong> 更加的快。</p><h3 id=1-性能对比>1. 性能对比</h3><p>FastThreadLocal比ThreadLocal快空口无凭，用数据说话，这里基于JMH来对FastThreadLocal和ThreadLocal进行测试。测试代码如下：</p><blockquote><p>JMH使用可以参考一下之前的文章 《<a href=https://juejin.cn/post/7041886951007338533>Java微基准测试工具-JMH</a>》</p></blockquote><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@BenchmarkMode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Mode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>AverageTime</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Warmup</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>iterations</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>time</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Measurement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>iterations</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>time</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Threads</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>200</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Fork</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@State</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Scope</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Benchmark</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@OutputTimeUnit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MILLISECONDS</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ThreadLocalTest</span> <span style=color:#ce5c00;font-weight:700>{</span>


    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>FastThreadLocal</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>fastThreadLocal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FastThreadLocal</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ThreadLocal</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>threadLocal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ThreadLocal</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1000</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@Benchmark</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>fastThreadLocal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Blackhole</span> <span style=color:#000>blackhole</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>FastThreadLocalThread</span> <span style=color:#000>thread</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FastThreadLocalThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#5c35cc;font-weight:700>@Override</span>
                <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>100000</span><span style=color:#ce5c00;font-weight:700>;++</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>){</span>
                        <span style=color:#000>fastThreadLocal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#000>fastThreadLocal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#000>fastThreadLocal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>

                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>});</span>
            <span style=color:#000>thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>join</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>blackhole</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consume</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Benchmark</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>threadLocal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Blackhole</span> <span style=color:#000>blackhole</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Thread</span> <span style=color:#000>thread</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#5c35cc;font-weight:700>@Override</span>
                <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>100000</span><span style=color:#ce5c00;font-weight:700>;++</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>){</span>
                        <span style=color:#000>threadLocal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#000>threadLocal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#000>threadLocal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>


                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>});</span>
            <span style=color:#000>thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>join</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#000>blackhole</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consume</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>RunnerException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Options</span> <span style=color:#000>opt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>OptionsBuilder</span><span style=color:#ce5c00;font-weight:700>()</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>include</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ThreadLocalTest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSimpleName</span><span style=color:#ce5c00;font-weight:700>())</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>result</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;result.json&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resultFormat</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResultFormatType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>JSON</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>build</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Runner</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>opt</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>run</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>看一下运行结果的截图：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/image-20220122220713516.png alt=image-20220122220713516></p><p>然后看一下将 result.json导入可视化网站后生成的对比图：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/FastThreadLocalJMH.png alt=FastThreadLocalJMH></p><p>这里对比的是调用的平均时间，从图可以看出来FastThreadLocal优于ThreadLocal(FastThreadLocal时间更短)。</p><p>下面看一下吞吐量：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@BenchmarkMode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Mode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Throughput</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Warmup</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>iterations</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>time</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Measurement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>iterations</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>time</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Threads</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>200</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Fork</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@State</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Scope</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Benchmark</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@OutputTimeUnit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SECONDS</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ThreadLocalTest</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//省略代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/image-20220122220123489.png alt></p><p>然后看一下将 result.json导入可视化网站后生成的对比图：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/FastThreadLoacl%E5%90%9E%E5%90%90%E9%87%8F.png alt=FastThreadLoacl吞吐量></p><p><strong>从上面图可以得出结论：不论是单次执行方法的快慢还是吞吐量FastThreadLocal的性能都由于ThreadLocal。</strong></p><blockquote><p>代码为什么要新建一个线程呢？因为FastThreadLocal需要搭配FastThreadLocalThread使用才能发挥出来最大作用，为了消除影响所以在ThreadLocal也同样试用了新建一个Thread去处理。这里实际运行应该比测试出来的值更加高。原因在于这里存在了线程的切换时间</p></blockquote><h3 id=2-fastthreadlocal相比threadlocal到底快在哪里>2. FastThreadLocal相比ThreadLocal到底快在哪里?</h3><p>两者实现的功能差不多，对于两者之间的快慢取决于内部功能实现的数据结构，下面通过分析数据结构的差异来对比一下，两者之间的快慢到底是怎么引起的。</p><h4 id=21-fastthreadlocal解析>2.1 FastThreadLocal解析</h4><p>通过阅读 <strong>FastThreadLocal</strong> 源码的get/remove操作可以知道，在 <strong>FastThreadLocal</strong> 内部主要是由 <strong><code>InternalThreadLocalMap</code></strong> 来实现。只要将InternalThreadLocalMap的实现和数据结构与ThreadLocal的实现以及数据结构进行对比就能知道FastThreadLocal快的秘诀。而Netty有实现了 <strong>FastThreadLocalThread</strong> 将 <strong><code>InternalThreadLocalMap</code></strong> 作为一个变量：整个结构图如下：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/FastThreadLoacl%E7%BB%93%E6%9E%84%20(1).png alt="FastThreadLoacl结构 (1)"></p><p><strong>FastThreadLocal 使用的空间换时间的做法来减少ThreadLocal哈希碰撞产生的问题。</strong></p><p>这里怎么去理解？我就用上面图举例子进行阐述：</p><p>例如我们在项目中新建十个FastThreadLocal，这样的话每一个FastThreadLocal中的变脸index都是一个唯一值：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>FastThreadLocal</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>InternalThreadLocalMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nextVariableIndex</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>是通过InternalThreadLocalMap的一个静态变量产生的。当你不停的创建FastThreadLocal对象的时候就会InternalThreadLocalMap的静态变量nextIndex就会不停的往上递增。</p><p>当 <strong>FastThreadLocal-1</strong> 实例在 <strong>FastThreadLocalThread</strong> 线程对象实例中调用 set方法，会创建一个 <strong>InternalThreadLocalMap</strong> 实例绑定在 <strong>FastThreadLocal-1</strong> 实例上面，</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//InternalThreadLocalMap#get
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>InternalThreadLocalMap</span> <span style=color:#000>get</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Thread</span> <span style=color:#000>thread</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>thread</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>FastThreadLocalThread</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>fastGet</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>FastThreadLocalThread</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>thread</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>slowGet</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>//InternalThreadLocalMap#fastGet
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>InternalThreadLocalMap</span> <span style=color:#000>fastGet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>FastThreadLocalThread</span> <span style=color:#000>thread</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>InternalThreadLocalMap</span> <span style=color:#000>threadLocalMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>threadLocalMap</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>threadLocalMap</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setThreadLocalMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>threadLocalMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InternalThreadLocalMap</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>threadLocalMap</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote><p>Tips: 这里代码有判断是不是FastThreadLocalThread，所以如果普通的Thread线程执行那么FastThreadLocal和普通的ThreadLocal没有什么区别。</p></blockquote><p>然后后续的 <strong>FastThreadLocal</strong> 实例set值的时候，直接就从<strong>FastThreadLocal-1</strong> 实例对象上获取 <strong>InternalThreadLocalMap</strong> 实例。当往 <strong>InternalThreadLocalMap</strong> 实例set数据的时候就是根据不同的 <strong>FastThreadLocal</strong> 的不同index放在不同的数组位置。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//FastThreadLocal#setKnownNotUnset
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setKnownNotUnset</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InternalThreadLocalMap</span> <span style=color:#000>threadLocalMap</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>V</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>threadLocalMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setIndexedVariable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>addToVariablesToRemove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>threadLocalMap</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>//InternalThreadLocalMap#setIndexedVariable
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>setIndexedVariable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>lookup</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>indexedVariables</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>lookup</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Object</span> <span style=color:#000>oldValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lookup</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#000>lookup</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>oldValue</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>UNSET</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>expandIndexedVariableTableAndSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>直接设置到 <strong><code>indexedVariables</code></strong> 数组对应的位置。</p><h3 id=3-总结>3. 总结</h3><ul><li><strong>FastThreadLocal</strong> 快的代价就是用空间换时间。但是对于现在内存较大的情况下空间换时间是一个不错的选择</li><li><strong>FastThreadLocal</strong> 兼容了普通Thread的使用</li><li><strong>FastThreadLocal</strong> 因为是为了Netty量身定制的所以有一定的使用局限性，必须搭配 <strong>FastThreadLocalThread</strong> 才能发挥优势所在</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-c03b49486baafa8f2b7e87b2d7e6f286>4 - Netty源码分析-EventLoopGroup如何工作</h1><blockquote><p>Netty版本：<a href=https://github.com/netty/netty/releases/tag/netty-4.1.74.Final>netty-4.1.74.Final</a></p></blockquote><h3 id=1-reactor-线程模型>1. Reactor 线程模型</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>io.netty.example.discard</span><span style=color:#ce5c00;font-weight:700>;</span>
    
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>io.netty.bootstrap.ServerBootstrap</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>io.netty.channel.ChannelFuture</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>io.netty.channel.ChannelInitializer</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>io.netty.channel.ChannelOption</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>io.netty.channel.EventLoopGroup</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>io.netty.channel.nio.NioEventLoopGroup</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>io.netty.channel.socket.SocketChannel</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>io.netty.channel.socket.nio.NioServerSocketChannel</span><span style=color:#ce5c00;font-weight:700>;</span>
    
<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * Discards any incoming data.
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DiscardServer</span> <span style=color:#ce5c00;font-weight:700>{</span>
    
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>port</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>DiscardServer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>port</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>port</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>port</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>EventLoopGroup</span> <span style=color:#000>bossGroup</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NioEventLoopGroup</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// (1)
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>EventLoopGroup</span> <span style=color:#000>workerGroup</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NioEventLoopGroup</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>ServerBootstrap</span> <span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ServerBootstrap</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>// (2)
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>group</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bossGroup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>workerGroup</span><span style=color:#ce5c00;font-weight:700>)</span>
             <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>channel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NioServerSocketChannel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// (3)
</span><span style=color:#8f5902;font-style:italic></span>             <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>childHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ChannelInitializer</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>SocketChannel</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// (4)
</span><span style=color:#8f5902;font-style:italic></span>                 <span style=color:#5c35cc;font-weight:700>@Override</span>
                 <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>initChannel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SocketChannel</span> <span style=color:#000>ch</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
                     <span style=color:#000>ch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pipeline</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>addLast</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DiscardServerHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
                 <span style=color:#ce5c00;font-weight:700>}</span>
             <span style=color:#ce5c00;font-weight:700>})</span>
             <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>option</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ChannelOption</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SO_BACKLOG</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>128</span><span style=color:#ce5c00;font-weight:700>)</span>          <span style=color:#8f5902;font-style:italic>// (5)
</span><span style=color:#8f5902;font-style:italic></span>             <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>childOption</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ChannelOption</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SO_KEEPALIVE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// (6)
</span><span style=color:#8f5902;font-style:italic></span>    
            <span style=color:#8f5902;font-style:italic>// Bind and start to accept incoming connections.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>ChannelFuture</span> <span style=color:#000>f</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bind</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>port</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>sync</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>// (7)
</span><span style=color:#8f5902;font-style:italic></span>    
            <span style=color:#8f5902;font-style:italic>// Wait until the server socket is closed.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// In this example, this does not happen, but you can do that to gracefully
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// shut down your server.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>channel</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>closeFuture</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>sync</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>workerGroup</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shutdownGracefully</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>bossGroup</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shutdownGracefully</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>port</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>8080</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>port</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>]);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DiscardServer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>port</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>run</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote><p>Tips: 上面代码来源于官网，(1)位置代码构造函数修改了，增加1参数</p></blockquote><p>从上面代码可以看出来Netty推荐主从Reactor的线程模型。Reactor线程模型运行机制主要有以下四步：</p><ul><li><p>连接注册</p></li><li><p>事件轮询</p></li><li><p>事件分发</p><p>I/O事件，Accept、Read、Write</p></li><li><p>事件处理</p></li></ul><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/eventloop/Reactor%E6%A8%A1%E5%9E%8B.png alt=Reactor模型></p><p>下面我们就从一下几个方面来说明<code>EventLoopGroup</code> 如何工作的</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/eventloop/EventLoopGroup%E5%88%86%E6%9E%90%E6%80%9D%E7%BB%B4%E5%AF%BC%E5%9B%BE.png alt=EventLoopGroup分析思维导图></p><h3 id=2-eventloopgroup创建>2. EventLoopGroup创建</h3><p>以 <strong>NioEventLoopGroup</strong> 为例子通过跟进源码可以知道创建一个**<code>EventLoopGroup</code>** 主要的逻辑都在这个 **<code>MultithreadEventExecutorGroup</code>** 的构造函数里面。下面来对构造函数代码段进行分析。</p><h4 id=21-executor的设置>2.1 Executor的设置</h4><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/eventloop/image-20220305202457603.png alt=image-20220305202457603></p><p>没有传入Exector的情况下，创建Netty实现的ThreadPerTaskExecutor，也可以使用Jdk的Executor实现</p><blockquote><p>Tips: new NioEventLoopGroup(2,Executors.newFixedThreadPool(10))</p></blockquote><p>看一下 <code>ThreadPerTaskExecutor</code> 实现：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/eventloop/image-20220305202632525.png alt=image-20220305202632525></p><p>直接实现了Executor接口，整个实现比较简单。</p><blockquote><p>Tips: 想一下如果使用Jdk的Executor实现，NioEventLoopGroup线程数量大于Jdk的Executor实现线程池数量会怎么样？</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NioEventLoopGroup</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>Executors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newFixedThreadPool</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>))</span>
</code></pre></div><p>后续的文章会专门讲解整个问题</p></blockquote><h4 id=22-eventexecutor的创建>2.2 EventExecutor的创建</h4><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/eventloop/image-20220305221245700.png alt=image-20220305221245700></p><p>创建EventExecutor, 上图调用的是一个 <code>MultithreadEventExecutorGroup#newChild</code> 的抽象方法。看具体的实现类实现：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/eventloop/image-20220305221332386.png alt=image-20220305221332386></p><p>我们就以<code>NioEventLoopGroup</code> 为例：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/eventloop/image-20220305221502196.png alt=image-20220305221502196></p><p>这里创建了一个 <code>NioEventLoop</code> 。</p><blockquote><p>Tips: 这个和之前说的EventLoopGroup聚合了EventLoop</p></blockquote><p>从上面创建EventExecutor可以看出来，最终创建的是<code>NioEventLoop</code> 。从继承关系可以知道 <code>NioEventLoop</code> 实现了 EventExecutor。</p><h4 id=23-eventexecutorchooser选择器创建>2.3 EventExecutorChooser选择器创建</h4><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/eventloop/image-20220305232208068.png alt=image-20220305232208068></p><p>选择器创建根据 <code>EventExecutor</code> 的数量。</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/eventloop/image-20220305232443484.png alt=image-20220305232443484></p><p>2的指数选择<code>PowerOfTwoEventExecutorChooser</code> 。 其他的选择 <code>GenericEventExecutorChooser</code> 。</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/eventloop/image-20220305232623870.png alt=image-20220305232623870></p><p>两者的区别就在于2的指数使用的 <strong><code>&</code></strong> 正常的使用的是 <strong><code>%</code></strong></p><blockquote><p>Tips: &效率高于%</p></blockquote><p>创建完成EventExecutor后，同时对EventExecutor数组进行处理成不能修改的<code>Set&lt;EventExecutor></code></p><h3 id=3-bossgroup如何工作>3. BossGroup如何工作</h3><p>主从的线程模式下，<code>BossGroup</code> 主要负责事件轮询，下面来分析一下如何进行工作的</p><h4 id=31-bossgroup线程启动>3.1 BossGroup线程启动</h4><p>通过服务端的例子，通过研究源码可以知道 <strong>AbstractBootstrap#initAndRegister</strong> 方法主要是创建 <strong>Channel</strong></p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/eventloop/image-20220305235718388.png alt=image-20220305235718388></p><p>上述代码的标号3，BossGroup注册Channel也是启动线程的关键，跟进代码往下看，<code>ChannelFuture regFuture = config().group().register(channel);</code> 代码的 <code>register</code> 方法调用的是 <code>MultithreadEventLoopGroup#register</code> 的方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//MultithreadEventLoopGroup#register方法  
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ChannelFuture</span> <span style=color:#000>register</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Channel</span> <span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>register</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>但是最终调用的是 <code>SingleThreadEventLoop#register</code> ：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ChannelFuture</span> <span style=color:#000>register</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Channel</span> <span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>register</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DefaultChannelPromise</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>));</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ChannelFuture</span> <span style=color:#000>register</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ChannelPromise</span> <span style=color:#000>promise</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>ObjectUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>checkNotNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>promise</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;promise&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>promise</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>channel</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>unsafe</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>register</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>promise</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>promise</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote><p>Tips: MultithreadEventLoopGroup对应EventLoopGroup，SingleThreadEventLoop对应EventLoop</p></blockquote><p><code>promise.channel().unsafe().register(this, promise)</code> 这里的this表示的是 NioEventLoop的实例，也就是把NioEventLoop作为参数传入了。调用的是<code>AbstractChannel.AbstractUnsafe#register</code> :</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/eventloop/image-20220306004126148.png alt=image-20220306004126148></p><p>上图代码段框出来的就是 EventLoop启动，跟进代码看一下具体的实现，execute方法具体执行的是 <strong><code>SingleThreadEventExecutor#execute</code></strong></p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/eventloop/image-20220306004449915.png alt=image-20220306004449915></p><blockquote><p>Tips: 通过查看SingleThreadEventExecutor源码你会发现，有一个Thread的属性。所以这里SingleThreadEventExecutor就相当于线程。只是对线程进行包装语义化</p></blockquote><p>在线程没有在EventLoop中，就启动当前线程通过调用<code>SingleThreadEventExecutor#startThread</code> 方法。 在这个方法里面又调用了<code>SingleThreadEventExecutor#doStartThread</code> 方法。</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/eventloop/image-20220306005257301.png alt=image-20220306005257301></p><p>1通过了Executor来执行下面的Runable代码，前面的 <strong><code>EventLoopGroup</code></strong> 创建可以知道，在默认的情况下使用的是 <code>ThreadPerTaskExecutor</code> ，而这个<code>ThreadPerTaskExecutor#execute</code> 方法的实现：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ThreadPerTaskExecutor</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Executor</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ThreadFactory</span> <span style=color:#000>threadFactory</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ThreadPerTaskExecutor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ThreadFactory</span> <span style=color:#000>threadFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>threadFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ObjectUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>checkNotNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>threadFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;threadFactory&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>execute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Runnable</span> <span style=color:#000>command</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>threadFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>command</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>直接创建线程然后启动。</p><p><strong>重点：看到这里你就会发现EventLoopGroup中的EventLoop已经启动了。然后在Runable中 <code>thread = Thread.currentThread();</code>这段代码将当前的线程设置给了SingleThreadEventExecutor变量</strong></p><blockquote><p>Tips:</p><ul><li>Executor如果是JDK的实现，Executor执行Runable其实就是线程池执行</li><li>事件轮询方法是一个死循环来实现。以达到不停的轮询的目的</li></ul></blockquote><h4 id=32-bossgroup轮询事件>3.2 BossGroup轮询事件</h4><p>通过上面的分析可以知道Executor执行的Runable中的 <strong><code>SingleThreadEventExecutor.this.run()</code></strong> 这段代码就是对事件进行轮询。以<code>NioEventLoopGroup</code> 为例，那么这方法的实现应该就是在 <code>NioEventLoop</code> 下面来分析这个方法。</p><p>说到轮询我们应该想到就有循环的过程，下面看一下 <code>NioEventLoop#run</code> 方法：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/eventloop/image-20220306133512844.png alt=image-20220306133512844></p><p>从代码可以看出来，使用的是一个无条件的for死循环来实现。进入for循环后，通过策略来计算出策略值，根据不同的策略值来做相对应的处理：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/eventloop/image-20220306133923602.png alt=image-20220306133923602></p><p>1 计算出策略，第一次进入的时候strategy=0,为什么会是0，下面看一下<code>SelectStrategy</code> 的实现类 <code>DefaultSelectStrategy</code> 也只有这一个实现</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DefaultSelectStrategy</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>SelectStrategy</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SelectStrategy</span> <span style=color:#000>INSTANCE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DefaultSelectStrategy</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>DefaultSelectStrategy</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>calculateStrategy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IntSupplier</span> <span style=color:#000>selectSupplier</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>hasTasks</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>hasTasks</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>selectSupplier</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>SelectStrategy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SELECT</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>selectSupplier.get()</strong> 这个对于 <code>NioEventLoop</code> 来说调用的是：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//NioEventLoop
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>IntSupplier</span> <span style=color:#000>selectNowSupplier</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IntSupplier</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>get</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>selectNow</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>};</span>

<span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>selectNow</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>selector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>selectNow</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在Channel初始化的时候Selector注册的感兴趣的值为0。所以selector.selectNow() 返回的也是0。</p><p>在队列中没有任务的时候就返回 <strong><code>SelectStrategy.SELECT</code></strong> 然后执行的就是上图代码标号2的逻辑代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>select</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>deadlineNanos</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>deadlineNanos</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>NONE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>selector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>select</span><span style=color:#ce5c00;font-weight:700>();</span>   <span style=color:#8f5902;font-style:italic>//(1)
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// Timeout will only be 0 if deadline is within 5 microsecs
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>timeoutMillis</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>deadlineToDelayNanos</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>deadlineNanos</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>995000L</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>1000000L</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>timeoutMillis</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>selector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>selectNow</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>selector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>select</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timeoutMillis</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在定时队列任务中没有任何任务，那就直接调用 （1）<code>selector.select()</code> 如果没有事件触发，就一直阻塞。 如果存在其他的情况就调用 <code>selector.selectNow()</code> 或者 <code>selector.select(timeoutMillis)</code> ，前一个直接返回，第二个等待一定时间没有事件触发就返回。</p><p><strong>到了这里轮询的过程就已经基本上完成，获取到了策略值strategy，剩下的就是对策略值进行处理，也就是事件的分发</strong></p><h4 id=33-eventloop事件处理>3.3 EventLoop事件处理</h4><p>下图这段代码就是 <code>NioEventLoop#run</code> 方法中处理I/O事件：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/eventloop/image-20220306160847456.png alt=image-20220306160847456></p><p>如上图代码段标号1和标号2两者大体都是处理I/O事件以及执行任务队列中的任务。跟进processSelectedKeys方法看一下：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>processSelectedKeys</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>selectedKeys</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>processSelectedKeysOptimized</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>processSelectedKeysPlain</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>selector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>selectedKeys</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>当中有两个方法，但是最终调用的是NioEventLoop#processSelectedKey方法(其中的一个分支)：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/eventloop/image-20220306161558506.png alt=image-20220306161558506></p><p>在这个方法中就有I/O事件的处理：</p><ul><li>连接处理</li><li>写处理</li><li>读处理</li></ul><p><strong>到这里就看到了EventLoop的是如何处理I/O事件</strong></p><blockquote><p>Tips: 里面的具体处理细节不去深究</p></blockquote><p>在前面图的标号3的作用是用来做什么的呢？代码后面的注释：不希望唤醒，这里就是JDK的NIO的空轮询的Bug</p><blockquote><p>Tips: 空轮询的bug可以参看如下链接</p><ul><li><a href="https://bugs.java.com/bugdatabase/view_bug.do?bug_id=6670302">https://bugs.java.com/bugdatabase/view_bug.do?bug_id=6670302</a></li><li><a href="https://bugs.java.com/bugdatabase/view_bug.do?bug_id=6403933">https://bugs.java.com/bugdatabase/view_bug.do?bug_id=6403933</a></li></ul></blockquote><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/eventloop/image-20220306162600078.png alt=image-20220306162600078></p><p>Netty通过计数器来判断是否发生了空轮询，如果发生了那么就重新构建Selector。</p><h3 id=4-workergroup如何工作>4. WorkerGroup如何工作</h3><p>在创建Channel的时候，初始化调用的是<code>ServerBootstrap#init</code> 方法：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/eventloop/image-20220306201837801.png alt=image-20220306201837801></p><p>然后在<code>ChannelPipeline</code> 末尾增加了一个 <code>ServerBootstrapAcceptor</code></p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/eventloop/image-20220306202031182.png alt=image-20220306202031182></p><p>从代码中看到有这样的一段代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>childGroup</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>register</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>addListener</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ChannelFutureListener</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#5c35cc;font-weight:700>@Override</span>
                    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>operationComplete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ChannelFuture</span> <span style=color:#000>future</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSuccess</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>forceClose</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cause</span><span style=color:#ce5c00;font-weight:700>());</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>});</span>
</code></pre></div><p>childGroup就是前面例子中的workerGroup变量，<code>childGroup.register</code> 和 BossGroup的一样，只不过这个是多个线程的。后续的处理和前面分析的一样。</p><h3 id=5-总结>5. 总结</h3><ul><li>EventLoopGroup组件是一个很重要的组件，代码也很复杂。但是只要抓住一点EventLoopGroup就相当于Netty的Jdk执行器Executor的一个实现就可以了。相当于线程池。</li><li>Netty通过巧妙的设计避免了Jdk的空轮询问题。</li><li>开发过程中主从线程模型用的比较多。</li></ul><blockquote><p>我是蚂蚁背大象，文章对你有帮助点赞关注我，文章有不正确的地方请您斧正留言评论~谢谢</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-a3af78f2b1b21dfc8ab5892ed0ff4c62>5 - Netty组件-EventLoop</h1><blockquote><p>Netty版本：<a href=https://github.com/netty/netty/releases/tag/netty-4.1.74.Final>netty-4.1.74.Final</a></p></blockquote><h3 id=1-引言>1. 引言</h3><p><code>EventLoop</code> 作为Netty一个重要的组件，与Reactor的线程模型相对应。要了解什么是 <code>EventLoop</code> 同时需要了解 <code>EventLoopGroup、EventExecutor、EventExecutorGroup、SingleThreadEventLoop</code> 。 这些类之间有什么关系呢？研究过代码的会发现这个这些类之间错综复杂，看的头有点晕。下面我们来看下这些类之间的关系。</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/eventloop/NioEventLoopGroup.png alt=NioEventLoopGroup></p><h3 id=2-eventexecutor和eventexecutorgroup>2. EventExecutor和EventExecutorGroup</h3><p>事件执行器用来执行处理事件</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>EventExecutorGroup</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ScheduledExecutorService</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Iterable</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>EventExecutor</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//省略代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>继承了 <code>ScheduledExecutorService</code> 说明是一个标准的JDK <code>Executor</code> 同时提供定时服务功能(Netty定时心跳实现)。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>EventExecutor</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>EventExecutorGroup</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//省略代码
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#000>EventExecutor</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>EventExecutorGroup管理了多个EventExecutor，EventExecutorGroup由多个EventExecutor聚合而成的。EventExecutor是一个特殊的EventExecutorGroup，它带有一些方便的方法来查看线程是否在事件循环中执行。除此之外，它还扩展了EventExecutorGroup，允许使用通用的方式来访问方法。</p><h3 id=3-eventloop和eventloopgroup>3. EventLoop和EventLoopGroup</h3><p>代码实现上来看首先 <code>EventLoop</code> 继承了 <code>EventLoopGroup</code> ，<code>EventLoop</code> 是 <code>EventLoopGroup</code> 的一种特殊存在。单个线程的叫 <code>EventLoop</code> 。多个线程的叫<code>EventLoopGroup</code> 其次都继承了JDK的 <code>ScheduledExecutorService</code> ，所以 <code>EventLoop和EventLoopGroup</code> 可以看成一个JDK的标准 <code>Executor</code> 同时支持定时执行。也可以理解为Netty自己实现的线程池。 EventLoop的相当于线程池只有一个线程，EventLoopGroup的是多个线程的线程池。<code>EventLoopGroup</code> 可以看做是由 <code>EventLoop</code> 组成。一旦注册，将处理一个Channel的所有I/O操作。一个EventLoop实例通常会处理多个Channel，但这可能取决于实现细节和内部。</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/eventloop/image-20220304001607454.png alt=image-20220304001607454></p><h3 id=4singlethreadeventloop>4.SingleThreadEventLoop</h3><p><code>SingleThreadEventLoop</code> 作为Event处理的底层处理类，从源代码可以看出来：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SingleThreadEventLoop</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>SingleThreadEventExecutor</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>EventLoop</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//省略代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SingleThreadEventExecutor</span> <span style=color:#204a87;font-weight:700>extends</span> 
    <span style=color:#000>AbstractScheduledEventExecutor</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>OrderedEventExecutor</span> <span style=color:#ce5c00;font-weight:700>{</span>
     <span style=color:#8f5902;font-style:italic>//省略代码
</span><span style=color:#8f5902;font-style:italic></span>     <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Thread</span> <span style=color:#000>thread</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>SingleThreadEventExecutor</code> 类中有一个线程变量，这个就是用来处理Event的。</p><h3 id=5-eventloop到底是什么>5. EventLoop到底是什么？</h3><p>功能主要用来处理Event的执行器，这个执行器符合JDK的执行器标准，同时具备定时执行任务的功能。也可以看做是JDK的 <code>Executor</code> 实现，相当于Netty版本线程池的实现。</p><blockquote><p>我是蚂蚁背大象，文章对你有帮助点赞关注我，文章有不正确的地方请您斧正留言评论~谢谢</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-0f44fc84bc0f4506d77828fab7f51513>6 - Netty组件-ChannelHandler(图文并茂)</h1><blockquote><p>Netty版本：<a href=https://github.com/netty/netty/releases/tag/netty-4.1.74.Final>netty-4.1.74.Final</a></p></blockquote><h3 id=1-channelhandler介绍>1. ChannelHandler介绍</h3><p>官方给出的解释ChannelHandler的作用主要有两点：</p><ul><li>处理I/O事件，拦截I/O操作，主要用来处理Channel</li><li>在ChannelPipeline中从当前一个ChannelHandler传递调用到下一个ChannelHandler</li></ul><p>ChannelHandler的继承关系图如下：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/ChannelHandler%E7%9A%84%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB.png alt=ChannelHandler的继承关系></p><p>从上面可以看出来主要分为两类：</p><ul><li><p>ChannelInboundHandler</p><p>接收I/O入站的操作通知</p></li><li><p>ChannelOutboundHandler</p><p>接收I/O出站操作通知</p></li></ul><p>涉及的ChannelOutboundHandlerAdapter和ChannelInboundHandlerAdapter适配器主要是提供了方法的默认实现。</p><blockquote><p>Tips: ChannelDuplexHandler是双工处理器，具有ChannelInboundHandler和ChannelOutboundHandler的功能</p></blockquote><h3 id=2channelhandler的生命周期>2.ChannelHandler的生命周期</h3><p>从ChannelHandler的源码来看：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>ChannelHandler</span> <span style=color:#ce5c00;font-weight:700>{</span>
    
    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>handlerAdded</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ChannelHandlerContext</span> <span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>handlerRemoved</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ChannelHandlerContext</span> <span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#5c35cc;font-weight:700>@Deprecated</span>
    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>exceptionCaught</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ChannelHandlerContext</span> <span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Throwable</span> <span style=color:#000>cause</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@Inherited</span>
    <span style=color:#5c35cc;font-weight:700>@Documented</span>
    <span style=color:#5c35cc;font-weight:700>@Target</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TYPE</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#5c35cc;font-weight:700>@Retention</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RetentionPolicy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RUNTIME</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#5c35cc;font-weight:700>@interface</span> <span style=color:#000>Sharable</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// no value
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>只有三个方法：</p><ul><li><p><strong>ChannelHandler#handlerAdded</strong></p><p>被添加到上线文中触发</p></li><li><p><strong>ChannelHandler#handlerRemoved</strong></p><p>在上下文中被移除触发</p></li><li><p><strong>ChannelHandler#exceptionCaught</strong></p><p>有Throwable错误抛错触发</p></li></ul><blockquote><p>Tips:ChannelHandler#exceptionCaught方法已经被标记为过期，可以实现 ChannelInboundHandler#exceptionCaught的方法</p></blockquote><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/ChannelHandler%E7%94%9F%E5%91%A8%E6%9C%9F.png alt=ChannelHandler生周期></p><p>用一个服务端的例子来讲解整个过程：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>io.netty.example.discard</span><span style=color:#ce5c00;font-weight:700>;</span>
    
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>io.netty.bootstrap.ServerBootstrap</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>io.netty.channel.ChannelFuture</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>io.netty.channel.ChannelInitializer</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>io.netty.channel.ChannelOption</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>io.netty.channel.EventLoopGroup</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>io.netty.channel.nio.NioEventLoopGroup</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>io.netty.channel.socket.SocketChannel</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>io.netty.channel.socket.nio.NioServerSocketChannel</span><span style=color:#ce5c00;font-weight:700>;</span>
    
<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * Discards any incoming data.
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DiscardServer</span> <span style=color:#ce5c00;font-weight:700>{</span>
    
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>port</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>DiscardServer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>port</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>port</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>port</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>EventLoopGroup</span> <span style=color:#000>bossGroup</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NioEventLoopGroup</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>// (1)
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>EventLoopGroup</span> <span style=color:#000>workerGroup</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NioEventLoopGroup</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>ServerBootstrap</span> <span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ServerBootstrap</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>// (2)
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>group</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bossGroup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>workerGroup</span><span style=color:#ce5c00;font-weight:700>)</span>
             <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>channel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NioServerSocketChannel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// (3)
</span><span style=color:#8f5902;font-style:italic></span>             <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>childHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ChannelInitializer</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>SocketChannel</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// (4)
</span><span style=color:#8f5902;font-style:italic></span>                 <span style=color:#5c35cc;font-weight:700>@Override</span>
                 <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>initChannel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SocketChannel</span> <span style=color:#000>ch</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
                     <span style=color:#000>ch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pipeline</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>addLast</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DiscardServerHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
                 <span style=color:#ce5c00;font-weight:700>}</span>
             <span style=color:#ce5c00;font-weight:700>})</span>
             <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>option</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ChannelOption</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SO_BACKLOG</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>128</span><span style=color:#ce5c00;font-weight:700>)</span>          <span style=color:#8f5902;font-style:italic>// (5)
</span><span style=color:#8f5902;font-style:italic></span>             <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>childOption</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ChannelOption</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SO_KEEPALIVE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// (6)
</span><span style=color:#8f5902;font-style:italic></span>    
            <span style=color:#8f5902;font-style:italic>// Bind and start to accept incoming connections.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>ChannelFuture</span> <span style=color:#000>f</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bind</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>port</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>sync</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>// (7)
</span><span style=color:#8f5902;font-style:italic></span>    
            <span style=color:#8f5902;font-style:italic>// Wait until the server socket is closed.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// In this example, this does not happen, but you can do that to gracefully
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// shut down your server.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>channel</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>closeFuture</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>sync</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>workerGroup</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shutdownGracefully</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>bossGroup</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shutdownGracefully</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>port</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>8080</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>port</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>]);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DiscardServer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>port</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>run</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote><p>Tips: 代码来源Netty官网https://netty.io/wiki/user-guide-for-4.x.html#wiki-h3-6</p></blockquote><p>上述代码其实分为两个部分一个部分是 <code>NioServerSocketChannel</code> 以及 <code>SocketChannel</code> 。 首先分析NioServerSocketChannel中的ChannelHandler。</p><p>通过代码可以知道NioServerSocketChannel创建后会调用<code>ServerBootstrap#init</code>方法。在该方法中有这样一段代码：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220311214033108.png alt=image-20220311214033108></p><p>创建一个ChannelHandler的实例也就是ChannelInitializer添加到NioServerSocketChannel的ChannelPipeline中。通过跟踪ChannelPipeline#addLast方法，最终调用的是<code>DefaultChannelPipeline#addLast</code>方法：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220311214725357.png alt=image-20220311214725357></p><p>然后在<code>DefaultChannelPipeline#callHandlerAdded0</code> 方法中调用的是<code>AbstractChannelHandlerContext#callHandlerAdded</code> 方法：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220311214916716.png alt=image-20220311214916716></p><p>然后获取到ChannelHandler实例调用handlerAdded方法。也就是调用<strong>ChannelHandler#handlerAdded</strong> 方法。到这里就完成了从ChannelHandler创建到调用<code>ChannelHandler#handlerAdded</code> 方法。</p><p>如果调用<code>DefaultChannelPipeline#remove</code> 方法，最终调用的就是<code>AbstractChannelHandlerContext#callHandlerRemoved</code>在这个方法中：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220311215453340.png alt=image-20220311215453340></p><p>调用了<code>ChannelHandler#handlerRemoved</code></p><p>对于<code>ChannelHandler#exceptionCaught</code> 在所有的ChannelHandler以及子类方法执行的时候都会有<code>try catch</code> 对异常进行捕获然后执行<code>AbstractChannelHandlerContext#invokeExceptionCaught</code> 方法</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220311220153445.png alt=image-20220311220153445></p><p>这个方法中都是调用了<code>ChannelHandler#exceptionCaught</code></p><blockquote><p>Tips: ChannelHandler#exceptionCaught方法标记为过期了，可以关注ChannelInboundHandler#exceptionCaught方法。同时还会在ChannelInitializer#initChannel中可能被执行</p></blockquote><p><strong>总结：ChannelHandler#handlerAdded方法主要发生在往ChannelPipeline添加ChannelHandler的时候，ChannelHandler#handlerRemoved主要发生在从ChannelPipeline删除ChannelHandler的时候，而ChannelHandler#exceptionCaught主要发生在执行ChannelInboundHandler和ChannelOutboundHandler方法的时候发生错误执行</strong></p><h3 id=3channelhandler的方法执行顺序>3.ChannelHandler的方法执行顺序</h3><p>这里所说的ChannelHandler方法指的是ChannelHandler本身的方法以及ChannelInboundHandler和ChannelOutboundHandler方法的顺序。看一下这个三个类中分别有什么方法：</p><p><strong>ChannelHandler接口</strong></p><table><thead><tr><th>类型</th><th>描述</th></tr></thead><tbody><tr><td>handlerAdded</td><td>当把 ChannelHandler 添加到 ChannelPipeline 中时被调用</td></tr><tr><td>handlerRemoved</td><td>当从 ChannelPipeline 中移除 ChannelHandler 时被调用</td></tr><tr><td>exceptionCaught</td><td>当处理过程中在 ChannelPipeline 中有错误产生时被调用</td></tr></tbody></table><p><strong><code>Netty</code></strong> 定义了下面两个重要的 <strong><code>ChannelHandler</code></strong> 子接口：</p><ul><li><strong>ChannelInboundHandler</strong> — 处理 <strong>入站</strong> 数据以及各种状态变化</li><li><strong>ChannelOutboundHandler</strong> — 处理 <strong>出站</strong> 数据并且允许拦截所有的操作</li></ul><p><strong>ChannelInboundHandler 接口</strong></p><table><thead><tr><th>类型</th><th>描述</th></tr></thead><tbody><tr><td>channelRegistered</td><td>当 Channel 已经注册到它的 EventLoop 并且能够处理 I/O 时被调用</td></tr><tr><td>channelUnregistered</td><td>当 Channel 从它的 EventLoop 注销并且无法处理任何 I/O 时被调用</td></tr><tr><td>channelActive</td><td>当 Channel 处于活动状态时被调用;Channel 已经连接/绑定并且已经就绪</td></tr><tr><td>channelInactive</td><td>当 Channel 离开活动状态并且不再连接它的远程节点时被调用</td></tr><tr><td>channelReadComplete</td><td>当Channel上的一个读操作完成时被调用</td></tr><tr><td>channelRead</td><td>当从 Channel 读取数据时被调用</td></tr><tr><td>ChannelWritabilityChanged</td><td>当Channel的可写状态发生改变时被调用。用户可以确保写操作不会完成得太快(以避免发生 OutOfMemoryError)或者可以在 Channel 变为再次可写时恢复写入。可以通过调用Channel的isWritable()方法来检测Channel 的可写性。与可写性相关的阈值可以通过Channel.config().setWriteHighWaterMark()和 Channel.config().setWriteLowWaterMark()方法来设置</td></tr><tr><td>userEventTriggered</td><td>当 ChannelnboundHandler.fireUserEventTriggered()方法被调用时被调用，因为一个 POJO 被传经了 ChannelPipeline</td></tr></tbody></table><p><strong>ChannelOutboundHandler 接口</strong></p><table><thead><tr><th>类型</th><th>描述</th></tr></thead><tbody><tr><td>bind(ChannelHandlerContext,SocketAddress,ChannelPromise)</td><td>当请求将 Channel 绑定到本地地址时被调用</td></tr><tr><td>connect(ChannelHandlerContext,SocketAddress,SocketAddress,ChannelPromise)</td><td>当请求将 Channel 连接到远程节点时被调用</td></tr><tr><td>disconnect(ChannelHandlerContext,ChannelPromise)</td><td>当请求将 Channel 从远程节点断开时被调用</td></tr><tr><td>close(ChannelHandlerContext,ChannelPromise)</td><td>当请求关闭 Channel 时被调用</td></tr><tr><td>deregister(ChannelHandlerContext,ChannelPromise)</td><td>当请求将 Channel 从它的 EventLoop 注销时被调用</td></tr><tr><td>read(ChannelHandlerContext)</td><td>当请求从 Channel 读取更多的数据时被调用</td></tr><tr><td>flush(ChannelHandlerContext)</td><td>当请求通过 Channel 将入队数据冲刷到远程节点时被调用</td></tr><tr><td>write(ChannelHandlerContext,Object,ChannelPromise)</td><td>当请求通过 Channel 将数据写到远程节点时被调用</td></tr></tbody></table><h4 id=32-从源码解析channelhandler方法执行顺序>3.2 从源码解析ChannelHandler方法执行顺序</h4><p>这个需要较长的篇幅来说明，我在文章《Netty源码解析-ChannelHandler方法执行顺序》进行详细的讲解。</p><h3 id=4channelhandler的分类说明>4.ChannelHandler的分类说明</h3><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/ChannelHandler%E5%88%86%E7%B1%BB.png alt=ChannelHandler分类></p><p>ChannelHandler的实现主要有三个：</p><ul><li>ChannelInboundHandler ：处理<strong>入站</strong>数据以及各种变化，简单理解就是：客户端或者服务器端接收其他端的数据进行处理。</li><li>ChannelOutboundHandler ：处理 <strong>出站</strong> 数据并且允许拦截所有的操作，简单理解就是：客户端或者服务器端发送数据给其他端的数据处理，同时还可以拦截读写操作</li><li>ChannelDuplexHandler： 包含了ChannelInboundHandler 和ChannelOutboundHandler 的功能。</li></ul><p>从上面衍生出来就是解码器和编码器：</p><ul><li>XXXXDecoder： 主要负责将网络中的数据解码成端需要的数据，例如：ProtobufDecoder</li><li>XXXXEncoder： 主要负责将端结构化的数据编码成网络中传输的数据格式，例如：ProtobufEncoder</li></ul><p>解码器和编码器也是Netty中重要的组件。</p><h3 id=5总结>5.总结</h3><ul><li>ChannelHandler是和Channel进行绑定的，通过ChannelHandlerContext进行触发。</li><li>ChannelHandler主要用于拦截I/O操作和I/O事件，同时通过ChannelPipeline将多个ChannelHandler串联在一起，形成一个调用链</li><li>ChannelHandler分为出站和入栈两种处理器，同时衍生出了编码器和解码器。</li></ul><blockquote><p>我是蚂蚁背大象，文章对你有帮助点赞关注我，文章有不正确的地方请您斧正留言评论~谢谢</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-0740c3f51af7244086e1889ea8c8435e>7 - Netty源码分析-ChannelHandler方法执行顺序和如何工作</h1><blockquote><p>Netty版本：Netty版本：<a href=https://github.com/netty/netty/releases/tag/netty-4.1.75.Final>netty-4.1.75.Final</a></p></blockquote><h3 id=1-前言>1. 前言</h3><p>在之前的文章《<a href=https://juejin.cn/post/7074394630678134791/>Netty组件-ChannelHandler(图文并茂)</a> 》中了解了ChannelHandler同时对其两个继承接口ChannelInboundHandler和ChannelOutboundHandler都有了一定的了解，从如下几个方面来对ChannelHandler通过源码进一步解析：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/ChannelHandler%E8%A7%A3%E6%9E%90%E7%82%B9.png alt=ChannelHandler解析点></p><blockquote><p>Tips: 上图后面两个内容会在后续的文章更新</p></blockquote><h3 id=2-channelhandler方法执行顺序>2. ChannelHandler方法执行顺序</h3><p>ChannelHandler方法执行顺序执行顺序其实说的是三个类：<code>ChannelHandler、ChannelInboundHandler、ChannelOutboundHandler</code> 这三个类的方法执行顺序。通过一个简答的Netty例子来打印一下执行的顺序。代码比较多这里就不直接粘贴出来了，已经上传到github仓库，可以下载到本地运行。</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220313142535666.png alt=image-20220313142535666></p><blockquote><p>代码github地址：https://github.com/mxsm/spring-sample/tree/master/java-sample/src/main/java/com/github/mxsm/netty/channelhandler</p></blockquote><p>运行结果分为两个部分：</p><ul><li><p>服务端结果</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220313143016219.png alt=image-20220313143016219></p></li><li><p>客户端结果</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220313143110607.png alt=image-20220313143110607></p></li></ul><p>接下来对运行结果结合源码进行分析。客户端和服务器端ChannelHandler的执行大部分相同，只有细小出的区别。我们会在有区别的地方进行说明</p><blockquote><p>Tips: 服务端线程模型是主从模型，所以我们会分别分析Boss线程中的ChannelHandler以及Work线程中的ChannelHandler。</p></blockquote><p>大致流程：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/ChannelHandler%E6%96%B9%E6%B3%95%E6%89%A7%E8%A1%8C%E5%88%86%E6%9E%90%E6%B5%81%E7%A8%8B.png alt=ChannelHandler方法执行分析流程></p><p>下面分析如果没有特别说明都是以服务端为例进行源码分析。</p><h4 id=21-channelhandlerhandleradded>2.1 ChannelHandler#handlerAdded</h4><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220313144554334.png alt=image-20220313144554334></p><blockquote><p>Tips：代码地址https://github.com/mxsm/spring-sample/blob/master/java-sample/src/main/java/com/github/mxsm/netty/channelhandler/DiscardServer.java</p></blockquote><p>主要关注上图红框部分的代码，通过跟进代码会发现 <code>ServerBootstrap</code> 创建后会创建一个 <code>NioServerSocketChannel</code> 实例，然后调用 <code>ServerBootstrap#init</code> 方法进行初始化，如下图所示：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220313145719703.png alt=image-20220313145719703></p><p>如上图代码所示，我这边把这里圈成了三个部分：</p><blockquote><p>Tips: ChannelInitializer其实就是一个ChannelInboundHandlerAdapter</p></blockquote><ol><li>NioServerSocketChannel的实例的ChannelPipeline中添加ChannelInitializer，那么<strong>ChannelInitializer#initChannel</strong> 什么时候触发，如下代码：</li></ol><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220313150218471.png alt=image-20220313150218471></p><p>在触发 <code>channelRegistered</code> 方法后调用了 <strong>ChannelInitializer#initChannel</strong> 这个私有方法，私有方法又调用了 <strong>ChannelInitializer#initChannel</strong> 抽象方法。</p><ol start=2><li><p>NioServerSocketChannel的实例的ChannelPipeline添加<strong>ServerBootstrap#handler</strong>方法设置的ChannelHandler。对应上面的例子就是这段代码里面的ChannelHandler，如下图标号1位置所示：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220313150751020.png alt=image-20220313150751020></p></li><li><p>将数据处理交给Worker线程，也是通过这个地方进行的。(后续会专门写一篇文章来说主负线程如何配合工作)</p></li></ol><p><strong>总结：从上面的分析可以看出来ChannelHandler#handlerAdded方法的触发，主要是通过ChannelPipeline的add类型方法来触发，底层是通过AbstractChannelHandlerContext#callHandlerAdded调用来实现。</strong></p><h4 id=22-channelinboundhandlerchannelregistered>2.2 ChannelInboundHandler#channelRegistered</h4><p>在调用<code>ServerBootstrap#bind</code>方法当中，ServerSocketChannel初始化后，将ServerSocketChannel注册到BossGroup上，如下图所示：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220313152322696.png alt=image-20220313152322696></p><p>上图标号1所示位置就是将ServerSocketChannel注册到BossGroup。跟进代码最终调用的是<code>AbstractChannel#register0</code> 方法，如下图所示：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220313152757422.png alt=image-20220313152757422></p><p>如上图标号2位置就是触发<code>ChannelInboundHandler#channelRegistered</code>方法。</p><p><strong>总结：ChannelInboundHandler#channelRegistered方法触发是在往EventLoopGroup中添加Channel的时候触发</strong></p><blockquote><p>Tips: 上面说的都是触发NioServerSocketChannel实例中的ChannelHandler，也就是BossGroup中。workGroup中的ChannelHandler触发在哪里触发呢？之前ChannelHandler#handlerAdded章节分析图中有个标号3的位置中的代码就是触发childHandler的channelRegistered方法的：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220313153504750.png alt=image-20220313153504750></p></blockquote><h4 id=23-channeloutboundhandlerbind>2.3 ChannelOutboundHandler#bind</h4><p>当NioServerSocketChannel创建、初始化、注册到EventLoopGroup完成后，接下来就进行绑定，与本地端口进行绑定以便接收数据,绑定的工作通过代码分析发现最后调用的是 <code>AbstractBootstrap#doBind0</code> 方法，如下图所示：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220313154352156.png alt=image-20220313154352156></p><blockquote><p>Tips: 这个地方的channel变量其实就是NioServerSocketChannel的实例。</p></blockquote><p>通过跟进bind方法的代码可以发现最终调用的是 <strong>AbstractChannelHandlerContext#invokeBind</strong></p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220313154614406.png alt=image-20220313154614406></p><p>**总结：ChannelOutboundHandler#bind调用是服务端的Channel绑定本地地址触发，如NioServerSocketChannel绑定本地地址端口准备接受客户端数据 **</p><blockquote><p>Tips: ChannelOutboundHandler#bind是BossGroup的Channel所特有，在childHandler中不会执行。</p></blockquote><h4 id=24-channelinboundhandlerchannelactive>2.4 ChannelInboundHandler#channelActive</h4><p>ChannelInboundHandler#channelActive的触发需要分两种情况：</p><ol><li>BossGroup中的ServerSocketChannel触发</li><li>WorkerGroup中的SocketChannel触发</li></ol><p>首先看一下BossGroup中的ServerSocketChannel触发中的触发，在执行<code>NioServerSocketChannel#bind</code> ，触发了自定义的<code>TimeServerBossOutHandler#bind</code>：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220313202937928.png alt=image-20220313202937928></p><p>上图标号1又调用了父类的bind方法，最终调用了<code>AbstractChannel.AbstractUnsafe#bind</code>：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220313203458047.png alt=image-20220313203458047></p><p>上图1位置就是触发ChannelInboundHandler#channelActive。</p><blockquote><p>Tips: TimeServerBossOutHandler#bind代码中去掉 <code>super.bind(ctx, localAddress, promise);</code> 这段代码，你用客户端链接发现连不上。这就是因为NioServerSocketChannel没有绑定。</p></blockquote><p>WorkerGroup中的SocketChannel触发如何触发？服务端接收到连接请求处理由BossGroup处理，读写操作是由WorkGroup处理，那么这个转换就是在<code>ServerBootstrap#init</code> 方法中完成,如下图代码所示：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220313205348929.png alt=image-20220313205348929></p><p>上图框出来的代码 <code>ServerBootstrapAcceptor</code> 其实也是一个<code>ChannelInboundHandler</code> ：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220313205548252.png alt=image-20220313205548252></p><p>上图框出来的就是往WorkGroup中注册Channel。所有这里会触发 <strong>ChannelInboundHandler#channelRegistered</strong> 。</p><blockquote><p>Tips: BossGroup注册NioServerSocketChannel和WorkGroup注册SocketChannel两者触发<strong>ChannelInboundHandler#channelRegistered</strong> 的逻辑没有区别。</p></blockquote><p>注册最终也是调用了<code>AbstractChannel.AbstractUnsafe#register0</code> :</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220313210108887.png alt=image-20220313210108887></p><p>BossGroup注册NioServerSocketChannel和WorkGroup注册NioSocketChannel区别在于上图标号1的<code>isActive()</code> 方法，这个方法是一个抽象方法。根据不同的类似实现。</p><ul><li><p>NioServerSocketChannel实现isActive()</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220313210426171.png alt=image-20220313210426171></p></li><li><p>NioSocketChannel实现isActive()</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220313210603668.png alt=image-20220313210603668></p></li></ul><p>所以会进入if条件语句中，加上又是第一次注册，最终会触发标号为2的方法。</p><p><strong>总结：NioServerSocketChannel和NioSocketChannel触发ChannelInboundHandler#channelActive不一样，但是都是当Channel可用的时候触发</strong></p><h4 id=25-channeloutboundhandlerread>2.5 ChannelOutboundHandler#read</h4><p><code>AbstractChannelHandlerContext#invokeChannelActive</code>方法主要触发channelActive如下图：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220313213615164.png alt=image-20220313213615164></p><p>然后通过调用AbstractChannelHandlerContext#invokeChannelActive方法：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220313214123319.png alt=image-20220313214123319></p><p>通过上图可以知道最终调用的是<code>DefaultChannelPipeline.HeadContext#channelActive</code>方法</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220313214354015.png alt=image-20220313214354015></p><p>然后调用<code>DefaultChannelPipeline.HeadContext#readIfIsAutoRead</code></p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220313214604152.png alt=image-20220313214604152></p><p>然后调用<code>AbstractChannel#read</code>方法，这个方法中调用了<code>ChannelPipeline#read</code> 方法触发ChannelOutboundHandler#read。</p><p><strong>总结：ChannelOutboundHandler#read的触发都是在ChannelInboundHandler#channelActive，通过DefaultChannelPipeline.HeadContext#readIfIsAutoRead方法实现。</strong></p><h4 id=26-channelinboundhandlerchannelread>2.6 ChannelInboundHandler#channelRead</h4><p>ServerSocketChannel还是SocketChannel都是通过NioEventLoop#processSelectedKey方法中一下代码触发unsafe.read()：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220319090947767.png alt=image-20220319090947767></p><p>这里根据ServerSocketChannel还是SocketChannel执行不同的Unsafe实现。</p><p>ServerSocketChannel也就是BossGroup执行的是<code>AbstractNioMessageChannel.NioMessageUnsafe#read</code> 方法：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220319091352613.png alt=image-20220319091352613></p><p>标号1触发ChannelInboundHandler#channelRead，标号2触发ChannelInboundHandler#channelReadComplete。</p><p>SocketChannel也就是workGroup执行的是AbstractNioByteChannel.NioByteUnsafe#read方法：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220319093237906.png alt=image-20220319093237906></p><p>上图的标号1,2分别触发ChannelInboundHandler#channelRead和ChannelInboundHandler#channelReadComplete。</p><p>在workGroup中还有这样两个：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>TimeServerOutHandler--write
TimeServerOutHandler--flush
</code></pre></div><p>那只是为什么? 这个是因为在TimeServerInHandler中调用了如下方法：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220319093647383.png alt=image-20220319093647383></p><p>下面就下来分析</p><h4 id=27-channeloutboundhandlerwrite和channeloutboundhandlerflush>2.7 ChannelOutboundHandler#write和ChannelOutboundHandler#flush</h4><p>通过上面知道要想触发ChannelOutboundHandler#write和ChannelOutboundHandler#flush需要调用ChannelHandlerContext#writeAndFlush,通过代码研究发现最终调用的是AbstractChannelHandlerContext#write：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220319095241942.png alt=image-20220319095241942></p><p>标号1查找到ChannelOutboundHandler，然后执行2，执行ChannelOutboundHandler#write或者ChannelOutboundHandler#write和ChannelOutboundHandler#flush。</p><h4 id=28-channeloutboundhandlerchannelinactive和channeloutboundhandlerchannelunregistered>2.8 ChannelOutboundHandler#channelInactive和ChannelOutboundHandler#channelUnregistered</h4><p>当客户端关闭服务端调用到如下的代码AbstractNioByteChannel#read方法：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220319160330612.png alt=image-20220319160330612></p><p>最终会调用标号2的位置，然后调用AbstractNioByteChannel.NioByteUnsafe#closeOnRead方法：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220319160515607.png alt=image-20220319160515607></p><p>跟进代码发现最终调用了AbstractChannel.AbstractUnsafe#deregister方法。在这个方法中有调用如下代码：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220319161139680.png alt=image-20220319161139680></p><p>这里就触发了ChannelOutboundHandler#channelInactive和ChannelOutboundHandler#channelUnregistered。</p><h4 id=28-channelhandlerhandlerremoved>2.8 ChannelHandler#handlerRemoved</h4><p>上图标号2调用了 <code>pipeline.fireChannelUnregistered();</code> 方法，最终是调用了<code>DefaultChannelPipeline.HeadContext#channelUnregistered</code> 方法：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220319162739667.png alt=image-20220319162739667></p><p>上图标号1的位置就是触发ChannelHandler#handlerRemoved。将当前Channel的ChannelHandler移除从EventLoop上面。</p><h4 id=29-channeloutboundhandlerconnect和channeloutboundhandlerclose>2.9 ChannelOutboundHandler#connect和ChannelOutboundHandler#close</h4><p>这两个都发生在客户端，整体的触发机制和上面说的大体相同，大家可以自己去进行分析。</p><h3 id=3-总结>3. 总结</h3><p>Netty的ChannelHandler的整体触发流程如上面所述。其中没有涉及到错误捕捉的触发。</p><ul><li>ChannelPipeline的双向链表中的HeadContext和TailContext都是ChannelHandler，同时继承了AbstractChannelHandlerContext，也可以说是ChannelHandlerContext。</li><li>ChannelHander添加到队列中，会被包装成ChannelHandlerContext</li></ul><blockquote><p>Tips: 我是蚂蚁背大象，文章对你有帮助点赞关注我，文章有不正确的地方请您斧正留言评论~谢谢</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-35b67625f01f01e363b021a0c0f95b45>8 - Netty源码解析-解码器(Decoder)是如何工作</h1><h3 id=1-解码器decoder概述>1. 解码器(Decoder)概述</h3><p>以类似流的方式将Bytes从一个ByteBuf中通过解码器转换成另一种消息类型</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/decoder/Decoder%E8%A7%A3%E7%A0%81.png alt=Decoder解码></p><p>Netty中的解码器就是<code>ChannelInboundHandlerAdapter</code>的一个实现。主要是将网络中的bytes数据解码成用户需要的消息类型。</p><blockquote><p>TIps: 解码器不能使用@Sharable修饰，解码器只能单独为一个Channel进行解码，如果为多个进行解码会导致数据混乱</p></blockquote><h3 id=2解码器decoder如何工作>2.解码器(Decoder)如何工作</h3><p>解码器的重要一个类就是<code>ByteToMessageDecoder</code> ，该类继承了<code>ChannelInboundHandlerAdapter</code> 。所以从本质上来说解码器其实就是 <code>ChannelInboundHandler</code> 。既然是<code>ChannelInboundHandler</code> 数据读取就在<code>ChannelInboundHandler#channelRead</code>方法里面：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/decoder/image-20220320144205350.png alt=image-20220320144205350></p><blockquote><p>Tips: 这里为什么会有一个if else的分支，原因在于如果开发者ByteToMessageDecoder设置在ServerBootstrap的ServerSocketChannel的handler，那么Object的对象类型就是SocketChannel，走的就是else分支，如果是设置在ServerBootstrap的childHandler那么那么Object的对象类型就是ByteBuf，走的就是if分支。 这里我只需要关注if分支即可</p></blockquote><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/decoder/%E8%A7%A3%E7%A0%81%E5%99%A8%E5%85%B7%E4%BD%93%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B.png alt=解码器具体处理流程></p><h4 id=21-累加器cumulator>2.1 累加器Cumulator</h4><p><code>ByteToMessageDecoder</code> 类中有一个Cumulator接口：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ByteToMessageDecoder</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ChannelInboundHandlerAdapter</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Cumulator</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>         * Cumulate the given {@link ByteBuf}s and return the {@link ByteBuf} that holds the cumulated bytes.
</span><span style=color:#8f5902;font-style:italic>         * The implementation is responsible to correctly handle the life-cycle of the given {@link ByteBuf}s and so
</span><span style=color:#8f5902;font-style:italic>         * call {@link ByteBuf#release()} if a {@link ByteBuf} is fully consumed.
</span><span style=color:#8f5902;font-style:italic>         */</span>
        <span style=color:#000>ByteBuf</span> <span style=color:#000>cumulate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ByteBufAllocator</span> <span style=color:#000>alloc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ByteBuf</span> <span style=color:#000>cumulation</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ByteBuf</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>作用：累加传入的Byte数据，同时也是为了解决粘包和半包的问题。</p><p>假设我们每次解码成的数据都要是：ABCD,由于存在粘包和半包的情况，累加器会进行如下操作(以半包为例)：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/decoder/%E7%B4%AF%E5%8A%A0%E5%99%A8%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86.png alt=累加器的工作原理></p><p>第一次传入并不会解码出需要的Message,会将数据存入ByteToMessageDecoder的cumulation变量，第二次传入数据会将解码器的之前数据和传入的数据进行合并，cumulation中的数据就变成了如上图所示，然后进行解码就解码出了所需要的Message。然后清空cumulation中已经解码了的数据。</p><h4 id=22-解码器工作解析>2.2 解码器工作解析</h4><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/decoder/%E8%A7%A3%E7%A0%81%E5%99%A8%E7%9A%84%E6%95%B4%E4%B8%AA%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%E5%9B%BE.png alt=解码器的整个工作流程图></p><p>从网络中读取的bytes数组，首先经过ByteToMessageDecoder累加器处理：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/decoder/image-20220320155201164.png alt=image-20220320155201164></p><p>如上图1所示：累加器处理传入的数据和前一次处理剩下的数据合并到一起，然后调用解码：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/decoder/image-20220320155451061.png alt=image-20220320155451061></p><p>①变量是用来保存解码后的消息，②就是调用解码方法**<code>ByteToMessageDecoder#decode</code>** ：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/decoder/image-20220320155713635.png alt=image-20220320155713635></p><p><strong><code>ByteToMessageDecoder#decode</code></strong> 是一个抽象方法，所以具体看解码器的实现，例如：</p><ul><li>RedisDecoder</li><li>XmlDecoder</li></ul><p>等等一些Netty实现的解码器。解码出来的结构化对象，保存在**<code>List&lt;Object></code>**中。当前的ChannelHandler解码完成后触发后续的ChannelHandler</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/decoder/image-20220320160046448.png alt=image-20220320160046448></p><p>后续ChannelHandler的channelRead方法中传入的值就是解码后的Message类型，如下图ByteToMessageDecoder#fireChannelRead静态方法：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/decoder/image-20220320160201318.png alt=image-20220320160201318></p><blockquote><p>Tips:</p><ul><li>传入的Bytefuf如何不够解码成需要类型的Message，这些bytes会被累加器保存在ByteToMessageDecoder的私有变量ByteBuf cumulation中</li><li>解码多出来的同样也会被bytes会被累加器保存在ByteToMessageDecoder的私有变量ByteBuf cumulation中</li><li>累加器的作用就是用来解决粘包和半包的问题。</li></ul></blockquote><h3 id=3总结>3.总结</h3><p>解码器的关键就是累加器，累加器的作用就是解决了数据的粘包和半包问题。数据不够解析成对应的Message将数据保存下来，等待后续的数据传入进行合并再次进行解码，当一次传入的数据过多但是又不能够完整的解析成多个(大于1)消息，将解析后的剩下的数据保存下来，等待后续的数据传入然后进行累加。这样就实现了整个解码的过程。</p><blockquote><p>我是蚂蚁背大象，文章对你有帮助点赞关注我，文章有不正确的地方请您斧正留言评论~谢谢</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-af1451bcab2bc09841bb3d2cff9f454a>9 - Netty源码解析-累加器(Cumulator)处理粘包半包问题</h1><h3 id=1前言>1.前言</h3><p>Netty将网络中的bytes数据转换成对应的消息数据，这个在Netty中叫做解码过程。在基于流的传输(如TCP/IP)中，接收到的数据存储在套接字接收缓冲区中。不幸的是，基于流的传输的缓冲区不是包队列，而是字节队列。这意味着，即使您将两个消息作为两个独立的包发送，操作系统也不会将它们视为两个消息，而只是将它们视为一串字节。因此，不能保证您所读的内容与远程同行所写的内容完全一致。而Netty中的累加器就是为了解决这个问题。我们将从一下几个方面结合来分析</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/Netty%E7%B4%AF%E5%8A%A0%E5%99%A8.png alt=Netty累加器></p><h3 id=2什么是粘包半包>2.什么是粘包、半包</h3><p><strong>粘包：比如发送方应该发送ABC、DEF,接收方期望接收到的是ABC、DEF。但是由于粘包可能接收到的是ABCDEF</strong></p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/%E7%B2%98%E5%8C%85%E7%A4%BA%E6%84%8F%E5%9B%BE.png alt=粘包示意图></p><p><strong>半包：比如发送方应该发送ABCDEF,接收方期望接收到的是ABCDEF。但是由于存在半包的情况可能接收到的是ABC、DEF</strong></p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/%E5%8D%8A%E5%8C%85%E7%A4%BA%E6%84%8F%E5%9B%BE.png alt=半包示意图></p><h3 id=3如何导致粘包半包>3.如何导致粘包、半包</h3><p>应用A发送消息给应用B的过程：</p><ol><li>应用A把流数据发送到TCP发送缓冲区。</li><li>TCP发送缓冲区把数据发送到达B服务器TCP接收缓冲区。</li><li>应用B从TCP接收缓冲区读取流数据。</li></ol><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/TCP%E5%8D%8A%E5%8C%85%E3%80%81%E7%B2%98%E5%8C%85%E4%BA%A7%E7%94%9F%E7%9A%84%E5%8E%9F%E5%9B%A0.png alt=TCP半包、粘包产生的原因></p><p><strong>粘包的原因:</strong></p><ul><li>发送方每次写入数据 &lt; Socket缓冲区大小</li><li>接收方读取Socket缓冲区数据不够及时</li></ul><p><strong>半包的原因：</strong></p><ul><li>发送方每次写入数据 > Socket缓冲区大小</li><li>发送的数据大于协议的 MTU (Maximum Transmission Unit，最大传输单元)，因此必须拆包</li></ul><h3 id=4解码器中的累加器如何解决粘包半包>4.解码器中的累加器如何解决粘包半包</h3><p>对于Netty解码器来说，粘包表示bytes转换成一个需要的消息Message后还会有省下的bytes。而半包就是bytes不够解码成Message。需要将当前的存下来等待新的数据配合上次读取的进行解码。而Netty的解码器中的累加器就是实现这个功能。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Cumulator</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>         * Cumulate the given {@link ByteBuf}s and return the {@link ByteBuf} that holds the cumulated bytes.
</span><span style=color:#8f5902;font-style:italic>         * The implementation is responsible to correctly handle the life-cycle of the given {@link ByteBuf}s and so
</span><span style=color:#8f5902;font-style:italic>         * call {@link ByteBuf#release()} if a {@link ByteBuf} is fully consumed.
</span><span style=color:#8f5902;font-style:italic>         */</span>
        <span style=color:#000>ByteBuf</span> <span style=color:#000>cumulate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ByteBufAllocator</span> <span style=color:#000>alloc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ByteBuf</span> <span style=color:#000>cumulation</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ByteBuf</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote><p>Tips: Cumulator是 ByteToMessageDecoder的内部接口。</p></blockquote><p>Netty中<code>Cumulator</code> 有两个实现：</p><ul><li><p>MERGE_CUMULATOR(默认)</p><p>采用的是内存复制，如果累加的ByteBuf比输入的ByteBuf小，那就需要扩容，再复制输入的ByteBuf到类的Byteful中。</p></li><li><p>COMPOSITE_CUMULATOR</p><p>使用CompositeByteBuf，通过将bytebuf添加到CompositeByteBuf来累积bytebuf，因此尽可能不进行内存复制</p></li></ul><p>累加的ByteBuf作为解码器的变量。这个就保存了没有被解码的bytes。然后后续传入的bytes就合并到累加的ByteBuf上面。然后根据拆包的规范，例如按照固定长度。那就读取固定的长度的bytes。不够就再次等待累加。</p><h3 id=5-总结>5. 总结</h3><p>Netty巧妙的运用累加器将未解码的ByteBuf保存到解码器的ByteBuf变量。后续进入的ByteBuf和已经累加的进行合并然后再次进行解码。如此往复就完成了。</p><blockquote><p>我是蚂蚁背大象，文章对你有帮助点赞关注我，文章有不正确的地方请您斧正留言评论~谢谢</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-f2107ce17caba5b69cb4e0891217d5c0>10 - Netty组件-ChannelHandlerContext和ChannelPipeline</h1><p>Netty的组件中还有两个重要的组件：<code>ChannelHandlerContext</code> 和 <code>ChannelPipeline</code> ，这两个组件经常搭配一起使用，下面结合源码来讲讲这两个组件如何在Netty中发挥作用的。</p><h3 id=1-channelhandlercontext>1. ChannelHandlerContext</h3><p><code>ChannelHandlerContext</code> 允许 <code>ChannelHandler</code> 和 <code>ChannelHandler</code> 所在的 <code>ChannelPipeline</code> (这个下面进行介绍)以及 <code>ChannelPipeline</code> 拥有的其他Handlers进行交互。通知所在 <code>ChannelPipeline</code> 中下一个 <code>ChannelHandler</code> ,同时也可以动态修改其所属的 <code>ChannelPipeline</code></p><ul><li>通知：通知同一个ChannelPipeline中临近的ChannelHandler，通过调用ChannelHandlerContext提供的方法</li><li>修改ChannelPipeline：可以获取到当前ChannelHandlerContext所属的ChannelPipeline，应用可以在运行时动态的往ChannelPipeline中添加、删除、或者替换ChannelHandler</li><li>存储一些状态信息</li></ul><blockquote><p>Tips: 一个ChannelHandler可以拥有多个ChannelHandlerContext,原因在于：一个ChannelHandler可以被添加到多个ChannelPipeline，因此一个单例的ChannelHandler被添加到了多个ChannelPipeline上面就可以被多个ChannelHandlerContext调用。</p></blockquote><p>划重点：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelPipeline/ChannelHandlerContext%E5%88%92%E9%87%8D%E7%82%B9.png alt=ChannelHandlerContext划重点></p><h3 id=2channelpipeline>2.ChannelPipeline</h3><p>ChannelPipeline是一个ChannelHandlers列表，用于处理或拦截Channel的入站事件和出站操作。ChannelPipeline实现了拦截过滤器模式的高级形式，让用户完全控制如何处理事件，以及管道中的ChannelHandlers如何交互。ChannelPipeline在netty中只有一个实现就是 <code>DefaultChannelPipeline</code></p><h4 id=21channelpipeline创建>2.1ChannelPipeline创建</h4><p>当Channel创建的时候ChannelPipeline自动创建。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//AbstractChannel
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>AbstractChannel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Channel</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newId</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>unsafe</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newUnsafe</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>pipeline</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newChannelPipeline</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>DefaultChannelPipeline</span> <span style=color:#000>newChannelPipeline</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DefaultChannelPipeline</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=22-event如何在channelpipeline流转>2.2 Event如何在ChannelPipeline流转</h4><p>Event在ChannelPipeline流转示意图如下：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelPipeline/ChannelPipeline%E4%BA%8B%E4%BB%B6%E6%B5%81%E8%BD%AC.png alt=ChannelPipeline事件流转></p><p>入站事件从下往上执行如上图，入栈事件通常由I/O线程生成入栈数据,入站数据通常是通过实际的输入操作(如SocketChannel.read(ByteBuffer))从远程读取。如果入站事件超出了顶部的入站处理程序，则会将其静默丢弃，或者在需要注意时将其记录下来。</p><p>出站事件从上往下处理。出站处理程序通常生成或转换出站流量，比如写请求。如果出站事件超出底部出站处理程序，则由与Channel关联的I/O线程处理。I/O线程通常执行实际的输出操作，例如SocketChannel.write(ByteBuffer)</p><h4 id=23-channelpipeline组织channelhandler的方式>2.3 ChannelPipeline组织ChannelHandler的方式</h4><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelPipeline/ChannelPipeline%E4%B8%ADChannelHandlerdler%E7%9A%84%E7%BB%84%E7%BB%87%E6%96%B9%E5%BC%8F.png alt=ChannelPipeline中ChannelHandlerdler的组织方式></p><p>通过一个双向的ChannelHandlerContext队列来组织ChannelHandler，当ChannelHandler被添加到ChannelPipeline的时候首先会被包装成ChannelHandlerContext。然后插入到链表中。</p><blockquote><p>Tips: ChannelPipeline是线程安全的，官方还给出了这样的一个建议：如果开发者的业务逻辑全部都是异步或者执行时间非常短就不需要一个特殊的EventLoopGroup</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>pipeline</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addLast</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>group</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;handler&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyBusinessLogicHandler</span><span style=color:#ce5c00;font-weight:700>())</span>
</code></pre></div></blockquote><h4 id=24-event流转channelhandler执行的顺序>2.4 Event流转ChannelHandler执行的顺序</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>ChannelPipeline</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>....;</span>
<span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addLast</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InboundHandlerA</span><span style=color:#ce5c00;font-weight:700>());</span> <span style=color:#8f5902;font-style:italic>//实现了ChannelInboundHandler
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addLast</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;2&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InboundHandlerB</span><span style=color:#ce5c00;font-weight:700>());</span> <span style=color:#8f5902;font-style:italic>//实现了ChannelInboundHandler
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addLast</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;3&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>OutboundHandlerA</span><span style=color:#ce5c00;font-weight:700>());</span> <span style=color:#8f5902;font-style:italic>//实现了ChannelOutboundHandler
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addLast</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;4&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>OutboundHandlerB</span><span style=color:#ce5c00;font-weight:700>());</span> <span style=color:#8f5902;font-style:italic>//实现了ChannelOutboundHandler
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addLast</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;5&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InboundOutboundHandlerX</span><span style=color:#ce5c00;font-weight:700>());</span> <span style=color:#8f5902;font-style:italic>//实现了ChannelInboundHandler和实现了ChannelOutboundHandler
</span></code></pre></div><p>上述代码ChannelPipeline中的ChannelHandler的链表顺序：head&lt;&mdash; 1 &lt;&mdash; 2 &lt;&mdash; 3 &lt;&mdash; 4 &lt;&mdash; 5 &lt;&mdash; tail。</p><p>入站的执行顺序： 1、2、5</p><p>入站的执行顺序：5、4、3</p><h3 id=3-总结>3. 总结</h3><ul><li>ChannelPipeline与Channel的关系是一对一的关系，ChannelPipeline是在Channel创建的时候自动创建。</li><li>当ChannelHandler是单例模式的时候，一个ChannelHandler可以对应多个ChannelPipeline，是一个1对多的关系</li><li>Channel创建时候自动创建ChannelPipeline实现Channel和ChannelPipeline的绑定，然后往ChannelPipeline中绑定ChannelHandler</li></ul><blockquote><p>我是蚂蚁背大象，文章对你有帮助点赞关注我，文章有不正确的地方请您斧正留言评论~谢谢</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-fd7104d677d757634e721844134f9391>11 - Netty源码解析-ChannelInboundHandler#channelRead参数Object对象到底是什么类型</h1><blockquote><p>Netty版本：<a href=https://github.com/netty/netty/releases/tag/netty-4.1.75.Final>netty-4.1.75.Final</a></p></blockquote><h3 id=1-引言>1. 引言</h3><p>在之前的文章《<a href=https://juejin.cn/post/7076731940706975758>Netty源码分析-ChannelHandler方法执行顺序和如何工作</a>》中分析了ChannelHandler的方法执行的顺序问题。在这个过程中细心的人可能会发现<code>ChannelInboundHandler#channelRead</code> 方法有个参数是Object:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>channelRead</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ChannelHandlerContext</span> <span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><p>刚刚接触的Netty的开发者肯定也很好奇这个Object到底会是什么类型，今天我们就从源码来分析一下这个Object的类型。了解Object的具体类型同时也可以帮助我们更好的开发。</p><h3 id=2-netty源码分析channelinboundhandlerchannelread参数object类型>2. Netty源码分析ChannelInboundHandler#channelRead参数Object类型</h3><p>这里我们还是以服务器的代码作为例子讲解</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>com.github.mxsm.netty.channelhandler</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>com.github.mxsm.netty.DiscardServerHandler</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>io.netty.bootstrap.ServerBootstrap</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>io.netty.channel.ChannelFuture</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>io.netty.channel.ChannelInitializer</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>io.netty.channel.ChannelOption</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>io.netty.channel.EventLoopGroup</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>io.netty.channel.nio.NioEventLoopGroup</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>io.netty.channel.socket.ServerSocketChannel</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>io.netty.channel.socket.SocketChannel</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>io.netty.channel.socket.nio.NioServerSocketChannel</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * @author mxsm
</span><span style=color:#8f5902;font-style:italic> * @date 2022/3/13 10:47
</span><span style=color:#8f5902;font-style:italic> * @Since 1.0.0
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DiscardServer</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>port</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>DiscardServer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>port</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>port</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>port</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>EventLoopGroup</span> <span style=color:#000>bossGroup</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NioEventLoopGroup</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// (1)
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>EventLoopGroup</span> <span style=color:#000>workerGroup</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NioEventLoopGroup</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>ServerBootstrap</span> <span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ServerBootstrap</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>// (2)
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>handler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ChannelInitializer</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ServerSocketChannel</span><span style=color:#ce5c00;font-weight:700>&gt;(){</span>
                <span style=color:#5c35cc;font-weight:700>@Override</span>
                <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>initChannel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ServerSocketChannel</span> <span style=color:#000>ch</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>ch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pipeline</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>addLast</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TimeServerBossOutHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
                    <span style=color:#000>ch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pipeline</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>addLast</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TimeServerBossInHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>});</span>
            <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>group</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bossGroup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>workerGroup</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>channel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NioServerSocketChannel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// (3)
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>childHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ChannelInitializer</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>SocketChannel</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// (4)
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#5c35cc;font-weight:700>@Override</span>
                    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>initChannel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SocketChannel</span> <span style=color:#000>ch</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>ch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pipeline</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>addLast</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TimeServerOutHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
                        <span style=color:#000>ch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pipeline</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>addLast</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TimeServerInHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>})</span>
                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>option</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ChannelOption</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SO_BACKLOG</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>128</span><span style=color:#ce5c00;font-weight:700>)</span>          <span style=color:#8f5902;font-style:italic>// (5)
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>childOption</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ChannelOption</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SO_KEEPALIVE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// (6)
</span><span style=color:#8f5902;font-style:italic></span>
            <span style=color:#8f5902;font-style:italic>// Bind and start to accept incoming connections.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>ChannelFuture</span> <span style=color:#000>f</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bind</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>port</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>sync</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>// (7)
</span><span style=color:#8f5902;font-style:italic></span>
            <span style=color:#8f5902;font-style:italic>// Wait until the server socket is closed.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// In this example, this does not happen, but you can do that to gracefully
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// shut down your server.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>channel</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>closeFuture</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>sync</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>workerGroup</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shutdownGracefully</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>bossGroup</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shutdownGracefully</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>port</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>8080</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>port</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>]);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DiscardServer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>port</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>run</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote><p>Tips:代码地址https://github.com/mxsm/spring-sample/tree/master/java-sample/src/main/java/com/github/mxsm/netty/channelhandler</p></blockquote><p>上面代码改自Netty官网，我这里给BossGroup中的ServerSocketChannel也显示加了ChannelHandler。<strong>所以对于ChannelInboundHandler#channelRead参数Object类型我们需要区分是ServerSocketChannel还是SocketChannel。</strong> 下面我们也从这两个方面进行源码分析。</p><blockquote><p>Tips: 下面讲的会用到ChannelHandler的方法执行顺序的相关知识，不太清楚的可以查看之前的文章 《<a href=https://juejin.cn/post/7076731940706975758>Netty源码分析-ChannelHandler方法执行顺序和如何工作</a>》</p></blockquote><h4 id=21-serversocketchannel中channelinboundhandlerchannelread参数object类型>2.1 ServerSocketChannel中ChannelInboundHandler#channelRead参数Object类型</h4><p>NioServerSocketChannel创建完成后绑定到BossGroup的EvenLoop上面，往EvenLoop提交任务后，NioEventLoop就开始运行EventLoop#run</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#5c35cc;font-weight:700>@Override</span>
 <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
     <span style=color:#8f5902;font-style:italic>//省略了大量的代码
</span><span style=color:#8f5902;font-style:italic></span>     
     <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;;)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>strategy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>select</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>curDeadlineNanos</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//select
</span><span style=color:#8f5902;font-style:italic></span>         
         <span style=color:#000>processSelectedKeys</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#8f5902;font-style:italic>//处理SelectedKeys
</span><span style=color:#8f5902;font-style:italic></span>     <span style=color:#ce5c00;font-weight:700>}</span>
 <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面代码主要看一下<code>processSelectedKeys()</code> 这个方法最终调用的是 <code>NioEventLoop#processSelectedKey(SelectionKey k, AbstractNioChannel ch)</code> 这个方法。这个方法也是ServerSocketChannel的主要处理逻辑：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220320101400589.png alt></p><p>如上图1位置所示，<code>unsafe.read()</code> 这个方法是解析ChannelInboundHandler#channelRead参数Object类型的关键代码。这个unsafe是怎么来的呢，上面有这样一段代码：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220320102124732.png alt=image-20220320102124732></p><p><strong>重点：unsafe.read()，调用那个实现取决于具体的实现，NioServerSocketChannel那么调用的就是AbstractNioMessageChannel.NioMessageUnsafe.read</strong> ：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220320102542119.png alt=image-20220320102542119></p><p>这个方法重点关注一下上图的标号位置</p><ul><li><p>标号1 的位置调用了<code>AbstractNioMessageChannel#doReadMessages</code>的抽象方法，这个案例下调用的是<code>NioServerSocketChannel#doReadMessages</code>方法：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220320102645617.png alt=image-20220320102645617></p><p>往<code>List&lt;Object> buf</code> 列表中添加了<code>NioSocketChannel</code>的实例</p></li><li><p>标号2的位置，是触发<code>ChannelInboundHandler#channelRead</code> ，将标号1中添加的<code>NioSocketChannel</code>作为Object的实际对象传入<code>ChannelInboundHandler#channelRead</code>参数Object类型</p></li></ul><p><strong>总结：ServerSocketChannel中ChannelInboundHandler#channelRead参数Object类型是NioSocketChannel</strong></p><blockquote><p>Tips: 使用者可以启动项目进行测试，看一下是不是和上面分析的一样进行验证，上面的关键之处就是在于unsafe.read()这个方法到底是调用哪个实现，同时在触发了ServerSocketChannel的ChannelPipeline后的fireChannelRead如何进行传导到SocketChannel，这个就是我下面要接着分析的。</p></blockquote><h4 id=22-serversocketchannel中channelinboundhandlerchannelread参数object类型>2.2 ServerSocketChannel中ChannelInboundHandler#channelRead参数Object类型</h4><p>触发了ServerSocketChannel的ChannelPipeline后的fireChannelRead后，最终调用的是 <strong><code>ServerBootstrap#init</code></strong> 中的如下图框出来的代码：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220320104301073.png alt=image-20220320104301073></p><p>ServerBootstrapAcceptor也是一个ChannelInboundHandlerAdapter，同样会触发ChannelInboundHandler#channelRead</p><blockquote><p>Tips: 此时触发的ChannelInboundHandler#channelRead还是属于NioServerSocketChannel</p></blockquote><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220320104427432.png alt=image-20220320104427432></p><p>如上图标号1所示此处的Channel实际上是NioSocketChannel实例，也就是NioServerSocketChannel传递过来的。如上图标号2所示这里就是往workGroup中注册NioSocketChannel实例。然后就是workGroup的NioEventLoop就开始运行EventLoop#run，这里的执行和BossGroup中执行的是一样的。唯一不同的就是</p><p><strong>unsafe.read()</strong> 方法，在NioSocketChannel中是执行<code>AbstractNioByteChannel.NioByteUnsafe#read</code></p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhandler/image-20220320103708124.png alt=image-20220320103708124></p><p>如上图标号1所示，这里同样触发了<code>ChannelPipeline#fireChannelRead</code> 这里传入的ChannelInboundHandler#channelRead参数Object类型是ByteBuf的实例。</p><blockquote><p>Tips: 这里的ChannelPipeline#fireChannelRead触发的是NioSocketChannel的。</p></blockquote><p><strong>总结：ServerSocketChannel中ChannelInboundHandler#channelRead参数Object类型是ByteBuf</strong></p><blockquote><p>Tips: 如果经过解码器后，触发的后续的ChannelInboundHandler#channelRead参数Object的类型就是解码后的消息类型</p></blockquote><h3 id=3-总结>3. 总结</h3><p>ChannelInboundHandler#channelRead参数Object类型取决于是ServerSocketChannel还是SocketChannel。</p><ul><li><strong>ServerSocketChannel中ChannelInboundHandler#channelRead参数Object类型是NioSocketChannel</strong></li><li><strong>ServerSocketChannel中ChannelInboundHandler#channelRead参数Object类型是ByteBuf</strong></li><li><strong>对于Netty的解码器只是对ChannelInboundHandler进行拓展</strong></li></ul><blockquote><p>我是蚂蚁背大象，文章对你有帮助点赞关注我，文章有不正确的地方请您斧正留言评论~谢谢</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-ad9d1265ef52473ea3a544b21c1a651f>12 - Netty源码解析-服务端启动流程详解</h1><p>之前讲了很多关于Netty的组件相关的知识以及Netty启动过程中的一些调用关系。下面通过一个官网的例子(稍微增加了修改)来说明整个启动过程的每一步到底做了什么。</p><h3 id=1-官网示例>1. 官网示例</h3><p>下述例子是在官网的例子上做了一些修改，增加了NioServerSocketChannel设置ChannelHandler。也就是标号5的位置。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DiscardServer</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>port</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>DiscardServer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>port</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>port</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>port</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>EventLoopGroup</span> <span style=color:#000>bossGroup</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NioEventLoopGroup</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// (1)
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>EventLoopGroup</span> <span style=color:#000>workerGroup</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NioEventLoopGroup</span><span style=color:#ce5c00;font-weight:700>();</span><span style=color:#8f5902;font-style:italic>// (2)
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>ServerBootstrap</span> <span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ServerBootstrap</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>// (3)
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>group</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bossGroup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>workerGroup</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// (3)
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>channel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NioServerSocketChannel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// (4)
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>handler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ChannelInitializer</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ServerSocketChannel</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#5c35cc;font-weight:700>@Override</span>
                    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>initChannel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ServerSocketChannel</span> <span style=color:#000>ch</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>ch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pipeline</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>addLast</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TimeServerBossOutHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
                        <span style=color:#000>ch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pipeline</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>addLast</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TimeServerBossInHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>})</span><span style=color:#8f5902;font-style:italic>// (5)
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>childHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ChannelInitializer</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>SocketChannel</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#5c35cc;font-weight:700>@Override</span>
                    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>initChannel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SocketChannel</span> <span style=color:#000>ch</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>ch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pipeline</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>addLast</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TimeServerOutHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
                        <span style=color:#000>ch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pipeline</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>addLast</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TimeServerInHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>})</span><span style=color:#8f5902;font-style:italic>// (6)
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>option</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ChannelOption</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SO_BACKLOG</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>128</span><span style=color:#ce5c00;font-weight:700>)</span>          <span style=color:#8f5902;font-style:italic>// (7)
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>childOption</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ChannelOption</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SO_KEEPALIVE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// (8)
</span><span style=color:#8f5902;font-style:italic></span>
            <span style=color:#8f5902;font-style:italic>// Bind and start to accept incoming connections.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>ChannelFuture</span> <span style=color:#000>f</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bind</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>port</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>sync</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>// (9)
</span><span style=color:#8f5902;font-style:italic></span>
            <span style=color:#8f5902;font-style:italic>// Wait until the server socket is closed.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// In this example, this does not happen, but you can do that to gracefully
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// shut down your server.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>channel</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>closeFuture</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>sync</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>workerGroup</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shutdownGracefully</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>bossGroup</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shutdownGracefully</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>port</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>8080</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>port</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>]);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DiscardServer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>port</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>run</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上述代码地址：https://github.com/mxsm/spring-sample/blob/master/java-sample/src/main/java/com/github/mxsm/netty/channelhandler/DiscardServer.java</p><h3 id=2服务端启动流程详解分析>2.服务端启动流程详解分析</h3><p>上述代码被分成了9个步骤，基本上涵盖了Netty的服务端基本开发。我们就一个个步骤分析，分析过程中两个将近的步骤会放在一起进行分析</p><h4 id=21-eventloopgroup的创建>2.1 EventLoopGroup的创建</h4><p>步骤(1)、(2)创建**<code>EventLoopGroup</code>**，上述代码创建的是**<code>NioEventLoopGroup</code>**。那么做了一些什么事情呢？</p><blockquote><p>Tips: EventLoopGroup还有 DefaultEventLoopGroup 、EpollEventLoopGroup(这个只能运行在Linux上面)</p></blockquote><ul><li>创建EventExecutor，也就是NioEventLoop。</li><li>创建Java NIO 的Selector, 这个是创建NioEventLoop的时候创建。</li></ul><h4 id=22-创建服务端的启动类>2.2 创建服务端的启动类</h4><p>步骤（3）就是创建服务端的启动类，这个没什么好介绍的。创建完成后将bossGroup和workGroup分别设置到服务端启动服务类中。作用：</p><ul><li>bossGroup负责监听来自客户端的连接，以及将连接转交给workGroup处理</li><li>workGroup主要负责客户端连接Channel的数据读写操作</li></ul><h4 id=23-设置创建的channel的类型>2.3 设置创建的Channel的类型</h4><p>对于服务端的设置Channel，其实有两类：ServerSocketChannel和SocketChannel，BossGroup创建的是ServerSocketChannel，而workGroup创建的是SocketChannel(这个会在下面讲到)。（4）这里设置的是boss的ChannelServerSocketChannel。</p><h4 id=24-为serversocketchannel设置channelhandler>2.4 为ServerSocketChannel设置ChannelHandler</h4><p>步骤（5）设置的ChannelServerSocketChannel的ChannelHandler，在不设置的情况下，其中有默认的添加 <strong><code>ChannelInitializer</code></strong> 在ServerBootstrap#init方法中：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>init</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Channel</span> <span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>setChannelOptions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>newOptionsArray</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>setAttributes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>newAttributesArray</span><span style=color:#ce5c00;font-weight:700>());</span>

    <span style=color:#000>ChannelPipeline</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pipeline</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>EventLoopGroup</span> <span style=color:#000>currentChildGroup</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>childGroup</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ChannelHandler</span> <span style=color:#000>currentChildHandler</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>childHandler</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ChannelOption</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>currentChildOptions</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newOptionsArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>childOptions</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>AttributeKey</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>currentChildAttrs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newAttributesArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>childAttrs</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addLast</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ChannelInitializer</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Channel</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>initChannel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Channel</span> <span style=color:#000>ch</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ChannelPipeline</span> <span style=color:#000>pipeline</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pipeline</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>ChannelHandler</span> <span style=color:#000>handler</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>handler</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handler</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>pipeline</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addLast</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//(1)
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#000>ch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>eventLoop</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>execute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#5c35cc;font-weight:700>@Override</span>
                <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>pipeline</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addLast</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ServerBootstrapAcceptor</span><span style=color:#ce5c00;font-weight:700>(</span>
                            <span style=color:#000>ch</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>currentChildGroup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>currentChildHandler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>currentChildOptions</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>currentChildAttrs</span><span style=color:#ce5c00;font-weight:700>));</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>});</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>});</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面代码标号1的位置就是将步骤（5）设置的ChannelHandler添加到ChannelServerSocketChannel所绑定的ChannelPipeline中。</p><h4 id=25-为socketchannel设置channelhandler>2.5 为SocketChannel设置ChannelHandler</h4><p>步骤（6）为SocketChannel设置ChannelHandler，这个和步骤5相似但是注意下ChannelInitializer中的泛型类C是不一样的，步骤（5）是ServerSocketChannel，而步骤（6）是SocketChannel。</p><h4 id=26-serversocketchannel和socketchannel的设置>2.6 ServerSocketChannel和SocketChannel的设置</h4><p>步骤（7）、（8）分别设置ServerSocketChannel和SocketChannel的TCP以及其他相关的参数设置。</p><blockquote><p>Tips: 以上的步骤，主要是创建启动服务类以及设置ChannelHandler和Channel的配置。</p></blockquote><h4 id=27-绑定端口启动服务>2.7 绑定端口启动服务</h4><p>步骤（9）主要是绑定端口，然后将之前步骤的设置串连起来。将服务启动。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ChannelFuture</span> <span style=color:#000>doBind</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SocketAddress</span> <span style=color:#000>localAddress</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ChannelFuture</span> <span style=color:#000>regFuture</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>initAndRegister</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Channel</span> <span style=color:#000>channel</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>regFuture</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>channel</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>regFuture</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cause</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>regFuture</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>regFuture</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDone</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>ChannelPromise</span> <span style=color:#000>promise</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newPromise</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>doBind0</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>regFuture</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>localAddress</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>promise</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>promise</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PendingRegistrationPromise</span> <span style=color:#000>promise</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PendingRegistrationPromise</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>regFuture</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addListener</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ChannelFutureListener</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>operationComplete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ChannelFuture</span> <span style=color:#000>future</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>Throwable</span> <span style=color:#000>cause</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cause</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cause</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>promise</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setFailure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cause</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>promise</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registered</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#000>doBind0</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>regFuture</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>localAddress</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>promise</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>});</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>promise</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul><li>创建NioServerSocketChannel的实例，在创建NioServerSocketChannel实例的同时也创建了当前NioServerSocketChannel的ID,内部接口Unsafe的实例对象，以及当前NioServerSocketChannel说绑定的ChannelPipeline。</li><li>对NioServerSocketChannel的实例进行初始化, 初始化做了哪些工作?<ul><li>NioServerSocketChannel设置之前设置的options配置</li><li>NioServerSocketChannel属性</li><li>给NioServerSocketChannel的ChannelPipeline中添加ChannelInitializer，这里添加的ChannelInitializer会将之前案例代码中步骤（5）添加的ChannelHandler添加到NioServerSocketChannel的ChannelInitializer中，同时还添加了ServerBootstrapAcceptor(这个类的作用后面会讲到)</li></ul></li><li>将NioServerSocketChannel的实例注册到BossGroup的EventLoop上面，对于Nio来说就是注册到NioEventLoop上面。</li><li>绑定启动服务器的本地端口，等待客户端连接</li></ul><p>到这里就完成整个服务的启动工作。</p><h3 id=3-总结>3. 总结</h3><p>netty服务端的启动和Java NIO的启动和工作的流程一致，只是将接收连接和处理连接的读写分开了。也就是Netty的Reactor的主从模型（图片来源网上）</p><p><img src="https://github.com/mxsm/document/blob/master/image/netty/NettyServer%E5%A4%84%E7%90%86%E8%BF%9E%E6%8E%A5%E7%9A%84%E7%A4%BA%E6%84%8F%E5%9B%BE.png?raw=true" alt></p><blockquote><p>我是蚂蚁背大象，文章对你有帮助点赞关注我，文章有不正确的地方请您斧正留言评论~谢谢</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-d653ef195ed2528f40195183d9a76540>13 - Netty源码解析-EventLoop什么时候启动运行</h1><h3 id=1引言>1.引言</h3><p>Netty中EventLoopGroup其实就相当于线程池，而EventLoop就相当于线程池中的线程。既然说是线程但是我们在开发的过程中没有看到类似于线程的启动start或者run方法的调用。那么Netty的EventLoop什么时候启动运行的呢？下面来通过源码分析一下这个问题。在分析这个问题之前需要明确一个事情：Netty的执行器可以使用用户自定义的或者用Netty默认实现的。下面讲的是使用Netty默认的执行器 <strong><code>ThreadPerTaskExecutor</code></strong>。</p><blockquote><p>Tips: 用户自定义的可以用户自己实现Executor接口或者使用JDK实现的线程池。这两种情况都可以归类为用户自定义。</p></blockquote><h3 id=2eventloop启动源码分析>2.EventLoop启动源码分析</h3><p>已NioEventLoop为例，NioEventLoop创建是在创建NioEventLoopGroup的时候创建。</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/image-20220321223154151.png alt=image-20220321223154151></p><p>上图标注的部分代码就是创建NioEventLoop。整个方法是一个抽象方法，看具体的实现，我们这里的实现就在NioEventLoopGroup中</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/image-20220321223324109.png alt=image-20220321223324109></p><p>NioEventLoop,将执行器作为构造函数的参数。这里就完成NioEventLoop创建。</p><p>ServerBootstrap绑定本地端口的时候会进行NioServerSocketChannel初始化的工作，然后将NioServerSocketChannel对象注册到NioEventLoop：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//AbstractBootstrap#initAndRegister
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ChannelFuture</span> <span style=color:#000>initAndRegister</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//省略部分代码
</span><span style=color:#8f5902;font-style:italic></span>     <span style=color:#000>ChannelFuture</span> <span style=color:#000>regFuture</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>group</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>register</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>);</span>
 <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>跟进register方法的代码，发现最终调用的是**<code>AbstractChannel#AbstractUnsafe.register</code>** 方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>register</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>EventLoop</span> <span style=color:#000>eventLoop</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ChannelPromise</span> <span style=color:#000>promise</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#8f5902;font-style:italic>//省略部分无关代码
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>AbstractChannel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>eventLoop</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>eventLoop</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>eventLoop</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>inEventLoop</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>register0</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>promise</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>eventLoop</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>execute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>//(1)
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#5c35cc;font-weight:700>@Override</span>
                <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>register0</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>promise</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>});</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在首次注册的时候上述代码肯定走得是else分支。</p><p><strong>标号（1）位置的就是 EventLoop启动的关键代码</strong>。跟进EventLoop#execute方法，调用的是SingleThreadEventExecutor#execute：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>execute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Runnable</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>ObjectUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>checkNotNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;task&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>execute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>!(</span><span style=color:#000>task</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>LazyRunnable</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>wakesUpForTask</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>));</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>execute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Runnable</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>immediate</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>inEventLoop</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>inEventLoop</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>addTask</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//(1)
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>inEventLoop</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>startThread</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//(2)
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isShutdown</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>reject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>removeTask</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>reject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UnsupportedOperationException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>reject</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>reject</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>addTaskWakesUp</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>immediate</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>wakeup</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inEventLoop</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如上述代码SingleThreadEventExecutor#execute方法中调用的是SingleThreadEventExecutor#execute的私有方法。</p><p>标号（1）：将提交的任务加入队列，然后判断运行线程是否已经在当前EventLoop，不在就启动线程调用**<code>startThread();</code>** 。然后跟进代码发现调用的是SingleThreadEventExecutor#doStartThread方法：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/image-20220321223555039.png alt=image-20220321223555039></p><p>调用的是 **<code>executor.execute</code>**方法.也就是Executor#execute方法，对于Netty默认真的执行器来说就是调用 <strong><code>ThreadPerTaskExecutor#execute</code></strong> 方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ThreadPerTaskExecutor</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Executor</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ThreadFactory</span> <span style=color:#000>threadFactory</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ThreadPerTaskExecutor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ThreadFactory</span> <span style=color:#000>threadFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>threadFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ObjectUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>checkNotNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>threadFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;threadFactory&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>execute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Runnable</span> <span style=color:#000>command</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>threadFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>command</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从代码中可以看到创建线程然后启动，运行的内容就是上图标号为1的内容，实际就是**<code>SingleThreadEventExecutor.this.run()</code>** 的内容，具体看实现，例如NioEventLoop的实现：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/image-20220321223639743.png alt=image-20220321223639743></p><p><strong>重点：EventLoop是在Channel注册到EventLoop的时候，通过执行器提交任务启动线程的</strong></p><h3 id=3-总结>3. 总结</h3><p>EventLoop是在Channel注册到EventLoop的时候通过执行器启动。任务会被添加到队列中。待EventLoop启动后从队列中获取任务进行处理。</p><blockquote><p>我是蚂蚁背大象，文章对你有帮助点赞关注我，文章有不正确的地方请您斧正留言评论~谢谢</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-b769ec828ee72b657fea63036f09c755>14 - Netty源码分析-Channel如何从主线程切换到从线程</h1><h3 id=1-前言>1. 前言</h3><p>在Netty的主从Reactor线程模型，如下图(图片来自网络)：</p><p><img src="https://github.com/mxsm/document/blob/master/image/netty/NettyServer%E5%A4%84%E7%90%86%E8%BF%9E%E6%8E%A5%E7%9A%84%E7%A4%BA%E6%84%8F%E5%9B%BE.png?raw=true" alt=线程模型></p><p>那么Channel如何从bossGroup处理完成 ACCETP后切换到workerGroup进行读写处理。下面就通过Netty的源码来告诉你Netty是如何进行切换的。</p><blockquote><p>Tips: 下面源码解析以Nio为例子</p></blockquote><h3 id=2-源码分析>2. 源码分析</h3><p>首先在服务端的服务绑定的过程中：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>ChannelFuture</span> <span style=color:#000>f</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bind</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>port</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>sync</span><span style=color:#ce5c00;font-weight:700>()</span>
</code></pre></div><p>实例化的NioServerSocketChannel的对象会注册到bossGroup的线程上面，这个注册的过程在**<code>AbstractBootstrap#initAndRegister</code>** 方法如下图框出来的部分：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhanlder/image-20220322103757962.png alt=image-20220322103757962></p><p>注册完成后，此时注册了当前NioServerSocketChannel实例的EventLoop也启动了。</p><blockquote><p>Tips: EventLoop何时启动不清楚的可以看一下之前的文章《<a href=https://juejin.cn/post/7077562070715088926>Netty源码解析-EventLoop什么时候启动运行</a>》</p></blockquote><p>启动后会运行<strong>NioEventLoop#run</strong>方法，主要是处理NioServerSocketChannel的select()。然后获取到SelectedKeys进行处理。这些key的处理是由**<code>NioEventLoop#processSelectedKey</code>** 方法处理：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhanlder/image-20220322104625856.png alt=image-20220322104625856></p><p>当有连接接入的时候就会调用上图框出来的部分代码，对于NioServerSocketChannel来说实际调用的**<code>AbstractNioMessageChannel.NioMessageUnsafe#read</code>**方法：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhanlder/image-20220322105033192.png alt=image-20220322105033192></p><p>上图标号1是将接受的Channel包装成NioSocketChannel存入List<object> readBuf列表中。标号2就是触发了NioServerSocketChannel所属ChannelPipeline的channelRead方法。</p><p>**重点：这个触发NioServerSocketChannel的所属ChannelPipeline的channelRead方法就是从BossGroup转到WorkGroup处理读写的关键。**下面分析为什么？</p><p>在调用 <strong><code>ChannelFuture f = b.bind(port).sync()</code></strong> 这段代码的时候，跟进bind的代码会发现ServerBootstrap#init方法中有这样的一段代码：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhanlder/image-20220322110133556.png alt=image-20220322110133556></p><p>我们就来分析一下这段标号①的代码。大致的意思就是：<strong>给NioServerSocketChannel所属ChannelPipeline中增加一个ChannelInitializer，在ChannelInitializer同时有增加一个ServerBootstrapAcceptor实例对象(ServerBootstrapAcceptor其实就是ChannelInboundHandler)</strong> 。 那么这段代码何时触发呢？</p><p>通过研究代码发现**<code>ChannelInitializer#initChannel</code>** 是一个抽象方法，在**<code>ChannelInitializer#channelRegistered</code>** 中触发：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhanlder/image-20220322111138952.png alt=image-20220322111138952></p><p>当NioServerSocketChannel所属ChannelPipeline触发channelRegistered，然后往ChannelPipeline中添加ServerBootstrapAcceptor。接下来就是看一下ServerBootstrapAcceptor的代码：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/netty/channelhanlder/image-20220322111803750.png alt=image-20220322111803750></p><p>从上面图片标号①可以看出来ServerBootstrapAcceptor其实是一个ChannelInboundHandler。所以在当NioServerSocketChannel所属ChannelPipeline触发channelRead的时候也会触发ServerBootstrapAcceptor#channelRead方法，而在标号③的位置就是将NioSocketChannel对象实例注册到workerGroup上面进行后续的读写处理。</p><p><strong>到这里就完成了整个有BossGroup线程到WorkGroup线程处理的转换</strong></p><h3 id=3-总结>3. 总结</h3><p>BossGroup线程到WorkGroup线程处理的转换是通过ChannelPipeline和ChannelHandler的巧妙运用进行转换的。通过NioServerSocketChannel所属ChannelPipeline触发channelRead，在ChannelPipeline上触发所有的ChannelInboundHandler的channelRead方法，最终调用到ServerBootstrapAcceptor#channelRead方法。这个方法里面实现了将ServerSocketChannel交由workGroup处理后续的读写操作的转换工作。也和前面说的Netty的主从模型对应上了。</p><blockquote><p>我是蚂蚁背大象，文章对你有帮助点赞关注我，文章有不正确的地方请您斧正留言评论~谢谢</p></blockquote></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list"><a class=text-white target=_blank rel="noopener noreferrer" href=https://groups.google.com/u/1/g/ljbmxsm><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=个人掘金主页 aria-label=个人掘金主页><a class=text-white target=_blank rel="noopener noreferrer" href=https://juejin.cn/user/1151943918492855><i class="fab fa-twitter"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/mxsm><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2022 The Docsy Authors All Rights Reserved</small>
<small class=ml-1><a href=https://policies.google.com/privacy target=_blank>隐私政策</a></small><p class=mt-2><a href=/about/>Home</a></p></div></div></div></footer><div><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css><script src=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js></script><script>$("p img").wrap(function(){return'<a data-fancybox="gallery" href="'+$(this).attr('src')+'"></a>'})</script></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/mermaid@8.8.1/dist/mermaid.min.js integrity=sha384-to2w0I1OqmbJ9J6yTnIX+KYU8grNpZoD1dKPLjgEJvMe5L5+/7qvuNa2sQo8WAWj crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/raphael/2.3.0/raphael.min.js integrity="sha512-tBzZQxySO5q5lqwLWfu8Q+o4VkTcRGOeQGVQ0ueJga4A1RKuzmAu5HXDOXLEjpbKyV7ow9ympVoa6wZLEzRzDg==" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.15.0/flowchart.min.js integrity="sha512-6QsSiIybtf8tuZ6xfjRTr2tdtw3Gp4q5RSCh2b6q9seoKEQmhAG1RrCA8F0kXTwivVxRVbp/YF3zOh8rvEAU7Q==" crossorigin=anonymous></script><script src=/js/main.min.b541b310f01941a0abfd76b652b5fb60dac470573775bb5b31ff08fe3f6cea51.js integrity="sha256-tUGzEPAZQaCr/Xa2UrX7YNrEcFc3dbtbMf8I/j9s6lE=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.js></script><script type=text/javascript>docsearch({appId:'JO2SY3WDAC',apiKey:'324ddb3b679c1308e5aa8bf222e07f8b',indexName:'mxsm',inputSelector:'.td-search-input',debug:!1})</script></body></html>