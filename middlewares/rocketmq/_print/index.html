<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.83.1"><link rel=canonical type=text/html href=/middlewares/rocketmq/><link rel=alternate type=application/rss+xml href=/middlewares/rocketmq/index.xml><meta name=ROBOTS content="INDEX, FOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Apache RocketMQ | 蚂蚁背大象</title><meta property="og:title" content="Apache RocketMQ"><meta property="og:description" content="Apache RocketMQ 笔记文档"><meta property="og:type" content="website"><meta property="og:url" content="/middlewares/rocketmq/"><meta property="og:site_name" content="蚂蚁背大象"><meta itemprop=name content="Apache RocketMQ"><meta itemprop=description content="Apache RocketMQ 笔记文档"><meta name=twitter:card content="summary"><meta name=twitter:title content="Apache RocketMQ"><meta name=twitter:description content="Apache RocketMQ 笔记文档"><link rel=preload href=/scss/main.min.e09cb23c7dff3bf1285aa0294bcdc4ac8194fb3425a99c621e31e7b871315685.css as=style><link href=/scss/main.min.e09cb23c7dff3bf1285aa0294bcdc4ac8194fb3425a99c621e31e7b871315685.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 321.39 78.54"><title id="title19">DUBBO LOGO</title><path class="cls-1" d="M68.46 50.38c0 14.06 11.39 22.11 25.45 22.11s25.45-8.05 25.45-22.11V7.25H68.46zm21.24-28h8.6V31H89.7zm0 22.25h8.6v8.6H89.7zM33.24 7.25H4.06v64H33.24c10.95.0 19.3-7.18 23.29-17.15a45.12 45.12.0 002.38-14.87A45.12 45.12.0 0056.53 24.4C52.84 14.62 44.19 7.25 33.24 7.25zm.43 14.63H30.34a3.44 3.44.0 00-3.44 3.44V53.23a3.44 3.44.0 003.44 3.44h3.33v4.63h-8.3a6.87 6.87.0 01-6.87-6.87V24.12a6.87 6.87.0 016.87-6.87h8.3zM285.51 6.06c-17.05.0-30.88 10.28-30.88 33.21s13.83 33.21 30.88 33.21 30.88-10.28 30.88-33.21S302.56 6.06 285.51 6.06zm7.59 48.36a6.87 6.87.0 01-6.87 6.87h-8.3V56.67h3.33a3.44 3.44.0 003.44-3.44V25.31a3.44 3.44.0 00-3.44-3.44h-3.33V17.25h8.3a6.87 6.87.0 016.87 6.87zm-53.4-17.56A17.39 17.39.0 00227.31 7.25H195.1v64h32.21a19.44 19.44.0 0012.38-34.44zM211.63 61.29h-6.08l18.68-44h6.08zM177 36.85A17.39 17.39.0 00164.65 7.25H132.43v64h32.21A19.44 19.44.0 00177 36.85zM149 61.29h-6.08l18.68-44h6.08z" style="fill:#fff;fill-opacity:1"/></svg></span><span class="text-uppercase font-weight-bold">蚂蚁背大象</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/about/><span>Home</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog/><span>Java</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/spring/><span>Spring</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/middlewares/><span class=active>Middleware</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/><span>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/other/><span>Others</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community/><span>Community</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002 站内搜索…" aria-label=站内搜索… autocomplete=off></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/middlewares/rocketmq/>Return to the regular view of this page</a>.</p></div><h1 class=title>Apache RocketMQ</h1><div class=lead>Apache RocketMQ 笔记文档</div><ul><li>1: <a href=#pg-f22d8f4d3d412b9a8b84dcf74a381b66>Apache RocketMQ 应用</a></li><ul><li>1.1: <a href=#pg-4a165336ae798ddd3e739802fad343b5>当SLF4J遇上RocketMQ</a></li></ul><li>2: <a href=#pg-93763797b84ed2da184d5517014e4e24>RocketMQ-基本概念</a></li><li>3: <a href=#pg-d9cb5c1f6846220c228ed743ac3333ed>RocketMQ-架构设计</a></li><li>4: <a href=#pg-44caf4678a2ffdda5b2e7e5e101bdc0f>RocketMQ-模块设计</a></li><li>5: <a href=#pg-1894b5c028a9e6b041f4883c79d9ee42>RocketMQ-特性</a></li><li>6: <a href=#pg-d11afb91d365586f2715373ee87ffcd6>RocketMQ Name Server</a></li><ul><li>6.1: <a href=#pg-2ec75df1201cddcb51c9549a4a9b6e48>NameServer</a></li><li>6.2: <a href=#pg-80e16469ef810b0280a6f4324ac46db3>RocketMQ源码解析-NameServer启动</a></li><li>6.3: <a href=#pg-039627ec513fed111ae3e49aaa0ad4d0>RocketMQ源码解析-NameServer对Broker的管理</a></li></ul><li>7: <a href=#pg-82fe895728c3c692794542d870b4e2b3>RocketMQ Broker</a></li><ul><li>7.1: <a href=#pg-509eb51b6081d849ed4c61b8e6620a26>RocketMQ源码解析-Broker启动</a></li><li>7.2: <a href=#pg-cdaf32cb67db0031ee4184b758640ac6>RocketMQ源码解析-Broker与NameServer交互</a></li><li>7.3: <a href=#pg-1d71c5af06e2352a2297be5b774c9efe>RocketMQ源码解析-Broker消息存储设计与实现</a></li><li>7.4: <a href=#pg-0fec2e79472ea5138a6011e79ed0c356>RocketMQ源码解析-Broker消息存储CommitLog</a></li><li>7.5: <a href=#pg-5ef930f71905a5f352f4de5310e3a582>RocketMQ源码解析-Broker消息存储ConsumeQueue</a></li><li>7.6: <a href=#pg-dfb0d002a8796933e78fa9fb8fb118e1>RocketMQ源码解析-Broker接收拉取消息</a></li><li>7.7: <a href=#pg-4d09b652a4bc68f5db4484f96fa278db>RocketMQ源码解析-Broker故障恢复</a></li><li>7.8: <a href=#pg-2e0b99c502e1d6196c2f892af868f2d9>RocketMQ源码解析-Broker存储配置文件说明</a></li><li>7.9: <a href=#pg-73525016293fc3e03673666421e0bb7b>RocketMQ源码解析-Broker 消息Tag过滤</a></li></ul><li>8: <a href=#pg-847fa820597dc46f22232d7ac858f231>RockerMQ 生产者</a></li><ul><li>8.1: <a href=#pg-a11b7514ad3e66334e5e1537e6fb32bd>RocketMQ源码解析-topic创建机制</a></li><li>8.2: <a href=#pg-395544e354ea6266fbab9cae741be2bf>RocketMQ源码解析-生产者投递消息策略</a></li><li>8.3: <a href=#pg-533c04015e0f55b75a9a135850a5aac5>RocketMQ源码解析-producer发送消息的流程</a></li><li>8.4: <a href=#pg-2ff23244bad53963311bd2be6ec7bcbf>Producer</a></li></ul><li>9: <a href=#pg-2f1f4ed9fee6f5a521a12ca84d078bdb>RocketMQ 消费者</a></li><ul><li>9.1: <a href=#pg-f3ce38d2979b908b5298da8f7d4faaf3>RocketMQ源码解析-消费者启动源码解析</a></li><li>9.2: <a href=#pg-4a9d2f0e9f10fa0bec13d5d37250a300>RocketMQ源码解析-消费者定时任务解析</a></li><li>9.3: <a href=#pg-e0711aee983677d5223cac91b892553c>RocketMQ源码解析-消费模式消费进度加载源码解析</a></li><li>9.4: <a href=#pg-affc4b406e122036a5eb9f43a5c1ee03>RocketMQ源码解析-并发消费消息源码解析</a></li><li>9.5: <a href=#pg-364fe808b49f058a193321e037d185cf>RocketMQ源码解析-消费者消费策略源码解析</a></li><li>9.6: <a href=#pg-9695cfa4768abc79a5b8502ccf44718d>RocketMQ源码解析-RocketMQ消息ACK机制及消费进度管理</a></li><li>9.7: <a href=#pg-99120f536b9e43c2a63509eb70d86756>RocketMQ源码解析-RocketMQ顺序消息的投递与消费</a></li><li>9.8: <a href=#pg-546f6c63b6ed87db92eddc2dc9e6ed92>RocketMQ源码解析-消费者重复消费</a></li></ul><li>10: <a href=#pg-c514a84bd6a6d3132366c2937864c38f>RocketMQ 问题记录</a></li><ul><li>10.1: <a href=#pg-b44c3354ecc8d651cf18c99a1b1ab0d2>broker busy问题</a></li></ul><li>11: <a href=#pg-1318634060ab5b269397ea8e6eabebfb>RocketMQ Docker部署</a></li></ul><div class=content></div></div><div class=td-content><h1 id=pg-f22d8f4d3d412b9a8b84dcf74a381b66>1 - Apache RocketMQ 应用</h1></div><div class=td-content><h1 id=pg-4a165336ae798ddd3e739802fad343b5>1.1 - 当SLF4J遇上RocketMQ</h1><blockquote><p>RocketMQ版本: 4.9.2</p><p>SpringBoot版本：2.6.2</p><p>日志工具： logback</p></blockquote><p>在平时Java项目的开发中，日志是一个很长见来纪录项目运行过程中的一些关键节点以及业务数据的搜集的一种方式。SLF4J在Java的日志中又有着举足轻重的地位。绝大部分的项目中都有用到。只是可能实现的方式不一样：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/rocketmq/%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86.png alt=日志收集></p><p>从上图可以看出来，在日志的实现中列举了一些常见的。<strong><code>logback</code></strong> <strong><code>log4j</code></strong> 是我们比较常见也常用的。然后存储上我们基本上都是把日志输出到应用所在的本地文件上进行保存。</p><blockquote><p>上图的日志存储，Socket和MQ严格意义上说起来不算是日志存储，是一个日志转存的方式。最终日志落地就是落地到 <strong><code>ES、文件、数据库(非ES)</code></strong></p></blockquote><p>这里我们着重讲一下日志对接MQ,让你的项目高大上起来。不要只会把日志数据放在文件了。</p><h3 id=1-环境准备>1. 环境准备</h3><h4 id=11-rocketmq的环境搭建>1.1 RocketMQ的环境搭建</h4><p>MQ的环境搭建建议直接使用Docker搭建，快速方便有省心，后续的使用也更加的方便。搭建的教程参照 <a href=https://blog.ljbmxsm.com/middlewares/rocketmq/rocketmq-docker/>《RocketMQ Docker部署》</a>。</p><h4 id=12-开发环境搭建>1.2 开发环境搭建</h4><p>这里我们使用的是SpringBoot的web项目来进行实现的。这里推荐两个Spring项目初始化器的网站</p><ul><li><p><a href=https://start.spring.io/>https://start.spring.io/</a></p><p>Spring官网的一个脚手架，上面可以用最新的相关Spring Boot的项目。</p></li><li><p><a href=https://start.aliyun.com/bootstrap.html>https://start.aliyun.com/bootstrap.html</a></p><p>阿里的一个脚手架网站，这个Spring Boot版本相对比较落后。没有更新到最新的。</p></li></ul><p>项目生成了接下来就是导入项目开发</p><h3 id=2-日志接入rocketmq>2. 日志接入RocketMQ</h3><h4 id=21-pom文件导入rockermq-loggerappender>2.1 pom文件导入RockerMQ LoggerAppender</h4><p>将在上面的脚手架网站生成的项目导入IDEA，然后在pom.xml文件中增加</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;dependency&gt;</span>
	<span style=color:#204a87;font-weight:700>&lt;groupId&gt;</span>org.apache.rocketmq<span style=color:#204a87;font-weight:700>&lt;/groupId&gt;</span>
	<span style=color:#204a87;font-weight:700>&lt;artifactId&gt;</span>rocketmq-logappender<span style=color:#204a87;font-weight:700>&lt;/artifactId&gt;</span>
	<span style=color:#204a87;font-weight:700>&lt;version&gt;</span>4.9.2<span style=color:#204a87;font-weight:700>&lt;/version&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/dependency&gt;</span>
</code></pre></div><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/rocketmq/%E5%AF%BC%E5%85%A5logappender.png alt></p><h4 id=22-logback配置文件增加appender>2.2 logback配置文件增加Appender</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;configuration</span> <span style=color:#c4a000>debug=</span><span style=color:#4e9a06>&#34;false&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    <span style=color:#8f5902;font-style:italic>&lt;!--
</span><span style=color:#8f5902;font-style:italic>    Base logback configuration provided for compatibility with Spring Boot 1.1
</span><span style=color:#8f5902;font-style:italic>    --&gt;</span>

    <span style=color:#204a87;font-weight:700>&lt;include</span> <span style=color:#c4a000>resource=</span><span style=color:#4e9a06>&#34;org/springframework/boot/logging/logback/defaults.xml&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;include</span> <span style=color:#c4a000>resource=</span><span style=color:#4e9a06>&#34;org/springframework/boot/logging/logback/console-appender.xml&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>

    <span style=color:#204a87;font-weight:700>&lt;appender</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;rocketMQAppender&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.apache.rocketmq.logappender.logback.RocketmqLogbackAppender&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;tag&gt;</span>mxsm-log<span style=color:#204a87;font-weight:700>&lt;/tag&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;topic&gt;</span>mxsm<span style=color:#204a87;font-weight:700>&lt;/topic&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;producerGroup&gt;</span>mxsm<span style=color:#204a87;font-weight:700>&lt;/producerGroup&gt;</span>
            <span style=color:#8f5902;font-style:italic>&lt;!--这里地址是我本地Docker容器部署的RockerMQ地址--&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;nameServerAddress&gt;</span>192.168.43.128:9876<span style=color:#204a87;font-weight:700>&lt;/nameServerAddress&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;layout&gt;</span>
            <span style=color:#204a87;font-weight:700>&lt;pattern&gt;</span>%date %p %t - %m%n<span style=color:#204a87;font-weight:700>&lt;/pattern&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;/layout&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/appender&gt;</span>

    <span style=color:#204a87;font-weight:700>&lt;appender</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;rocketMQAsyncAppender&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;ch.qos.logback.classic.AsyncAppender&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;queueSize&gt;</span>1024<span style=color:#204a87;font-weight:700>&lt;/queueSize&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;discardingThreshold&gt;</span>80<span style=color:#204a87;font-weight:700>&lt;/discardingThreshold&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;maxFlushTime&gt;</span>2000<span style=color:#204a87;font-weight:700>&lt;/maxFlushTime&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;neverBlock&gt;</span>true<span style=color:#204a87;font-weight:700>&lt;/neverBlock&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;appender-ref</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;rocketMQAppender&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/appender&gt;</span>

    <span style=color:#204a87;font-weight:700>&lt;logger</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;rocketMQAsyncLogger&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;appender-ref</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;rocketMQAsyncAppender&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/logger&gt;</span>

    <span style=color:#204a87;font-weight:700>&lt;logger</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;rocketMQLogger&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;appender-ref</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;rocketMQAppender&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/logger&gt;</span>

    <span style=color:#204a87;font-weight:700>&lt;root</span> <span style=color:#c4a000>level=</span><span style=color:#4e9a06>&#34;INFO&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;appender-ref</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;CONSOLE&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/root&gt;</span>

<span style=color:#204a87;font-weight:700>&lt;/configuration&gt;</span>
</code></pre></div><blockquote><p>为了IDAE启动打印和SpringBoot原有的保持一致，我这里应用了Spring原有的。</p></blockquote><p>增加了两个logger: <strong><code>rocketMQAsyncLogger</code></strong> 和 <strong><code>rocketMQLogger</code></strong> 。</p><h4 id=23-测试代码>2.3 测试代码</h4><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/rocketmq/rockermqappender%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81.png alt></p><p>运行项目然去RockerMQ的消息查询web控制台查看：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/rocketmq/image-20211231120226707.png alt=image-20211231120226707></p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/rocketmq/image-20211231120246443.png alt=image-20211231120246443></p><p>从查询的数据可以看出来已经将日志发送到了RocketMQ。</p><h3 id=3-总结>3. 总结</h3><p>上面的例子是一个简单的如何使用将RocketMQ和项目中的日志进行对接的一个小的例子。相对于将对接MQ和日志存在本地文件有以下几个好处：</p><ul><li>降低了项目服务的本地磁盘的IO,同时也减少了本地磁盘的使用。(如果是本地文件也可以使用定时任务进行清理，压测环境磁盘被日志撑爆过)</li><li>可以通过一个消费服务或者消费集群服务来对MQ的消息进行处理，而文件就需要对数据进行处理就需要在每个应用服务上再部署一个文件处理服务来对文件进行处理。</li></ul><p>参考文档：</p><ul><li><a href=https://rocketmq.apache.org/docs/logappender-example/>https://rocketmq.apache.org/docs/logappender-example/</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-93763797b84ed2da184d5517014e4e24>2 - RocketMQ-基本概念</h1><h1 id=rocketmq基本概念>rocketmq基本概念</h1><blockquote><p>介绍RocketMQ的基本概念模型</p></blockquote><hr><h2 id=1-消息模型message-model>1 消息模型（Message Model）</h2><p>RocketMQ主要由 Producer、Broker、Consumer 三部分组成，其中Producer 负责生产消息，Consumer 负责消费消息，Broker 负责存储消息。Broker 在实际部署过程中对应一台服务器，每个 Broker 可以存储多个Topic的消息，每个Topic的消息也可以分片存储于不同的 Broker。Message Queue 用于存储消息的物理地址，每个Topic中的消息地址存储于多个 Message Queue 中。ConsumerGroup 由多个Consumer 实例构成。</p><h2 id=2-消息生产者producer>2 消息生产者（Producer）</h2><p>负责生产消息，一般由业务系统负责生产消息。一个消息生产者会把业务应用系统里产生的消息发送到broker服务器。RocketMQ提供多种发送方式，同步发送、异步发送、顺序发送、单向发送。同步和异步方式均需要Broker返回确认信息，单向发送不需要。</p><h2 id=3-消息消费者consumer>3 消息消费者（Consumer）</h2><p>负责消费消息，一般是后台系统负责异步消费。一个消息消费者会从Broker服务器拉取消息、并将其提供给应用程序。从用户应用的角度而言提供了两种消费形式：拉取式消费、推动式消费。</p><h2 id=4-主题topic>4 主题（Topic）</h2><p>表示一类消息的集合，每个主题包含若干条消息，每条消息只能属于一个主题，是RocketMQ进行消息订阅的基本单位。</p><h2 id=5-代理服务器broker-server>5 代理服务器（Broker Server）</h2><p>消息中转角色，负责存储消息、转发消息。代理服务器在RocketMQ系统中负责接收从生产者发送来的消息并存储、同时为消费者的拉取请求作准备。代理服务器也存储消息相关的元数据，包括消费者组、消费进度偏移和主题和队列消息等。</p><h2 id=6-名字服务name-server>6 名字服务（Name Server）</h2><p>名称服务充当路由消息的提供者。生产者或消费者能够通过名字服务查找各主题相应的Broker IP列表。多个Namesrv实例组成集群，但相互独立，没有信息交换。</p><h2 id=7-拉取式消费pull-consumer>7 拉取式消费（Pull Consumer）</h2><p>Consumer消费的一种类型，应用通常主动调用Consumer的拉消息方法从Broker服务器拉消息、主动权由应用控制。一旦获取了批量消息，应用就会启动消费过程。</p><h2 id=8-推动式消费push-consumer>8 推动式消费（Push Consumer）</h2><p>Consumer消费的一种类型，该模式下Broker收到数据后会主动推送给消费端，该消费模式一般实时性较高。</p><h2 id=9-生产者组producer-group>9 生产者组（Producer Group）</h2><p>同一类Producer的集合，这类Producer发送同一类消息且发送逻辑一致。如果发送的是事务消息且原始生产者在发送之后崩溃，则Broker服务器会联系同一生产者组的其他生产者实例以提交或回溯消费。</p><h2 id=10-消费者组consumer-group>10 消费者组（Consumer Group）</h2><p>同一类Consumer的集合，这类Consumer通常消费同一类消息且消费逻辑一致。消费者组使得在消息消费方面，实现负载均衡和容错的目标变得非常容易。要注意的是，消费者组的消费者实例必须订阅完全相同的Topic。RocketMQ 支持两种消息模式：集群消费（Clustering）和广播消费（Broadcasting）。</p><h2 id=11-集群消费clustering>11 集群消费（Clustering）</h2><p>集群消费模式下,相同Consumer Group的每个Consumer实例平均分摊消息。</p><h2 id=12-广播消费broadcasting>12 广播消费（Broadcasting）</h2><p>广播消费模式下，相同Consumer Group的每个Consumer实例都接收全量的消息。</p><h2 id=13-普通顺序消息normal-ordered-message>13 普通顺序消息（Normal Ordered Message）</h2><p>普通顺序消费模式下，消费者通过同一个消费队列收到的消息是有顺序的，不同消息队列收到的消息则可能是无顺序的。</p><h2 id=14-严格顺序消息strictly-ordered-message>14 严格顺序消息（Strictly Ordered Message）</h2><p>严格顺序消息模式下，消费者收到的所有消息均是有顺序的。</p><h2 id=15-消息message>15 消息（Message）</h2><p>消息系统所传输信息的物理载体，生产和消费数据的最小单位，每条消息必须属于一个主题。RocketMQ中每个消息拥有唯一的Message ID，且可以携带具有业务标识的Key。系统提供了通过Message ID和Key查询消息的功能。</p><h2 id=16-标签tag>16 标签（Tag）</h2><p>为消息设置的标志，用于同一主题下区分不同类型的消息。来自同一业务单元的消息，可以根据不同业务目的在同一主题下设置不同标签。标签能够有效地保持代码的清晰度和连贯性，并优化RocketMQ提供的查询系统。消费者可以根据Tag实现对不同子主题的不同消费逻辑，实现更好的扩展性。</p><p>参考文档：</p><p>[1] <a href=https://github.com/apache/rocketmq/blob/master/docs/cn/concept.md>MQ基本概念</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-d9cb5c1f6846220c228ed743ac3333ed>3 - RocketMQ-架构设计</h1><h1 id=架构设计>架构设计</h1><hr><h2 id=1-技术架构>1 技术架构</h2><p><img src="https://github.com/apache/rocketmq/blob/master/docs/cn/image/rocketmq_architecture_1.png?raw=true" alt></p><p>RocketMQ架构上主要分为四部分，如上图所示:</p><ul><li><p><strong>Producer</strong> ：消息发布的角色，支持分布式集群方式部署。Producer通过MQ的负载均衡模块选择相应的Broker集群队列进行消息投递，投递的过程支持快速失败并且低延迟。</p></li><li><p><strong>Consumer</strong> ：消息消费的角色，支持分布式集群方式部署。支持以push推，pull拉两种模式对消息进行消费。同时也支持集群方式和广播方式的消费，它提供实时消息订阅机制，可以满足大多数用户的需求。</p></li><li><p><strong>NameServer</strong> ：NameServer是一个非常简单的Topic路由注册中心，其角色类似Dubbo中的zookeeper，支持Broker的动态注册与发现。主要包括两个功能：Broker管理，NameServer接受Broker集群的注册信息并且保存下来作为路由信息的基本数据。然后提供心跳检测机制，检查Broker是否还存活；路由信息管理，每个NameServer将保存关于Broker集群的整个路由信息和用于客户端查询的队列信息。然后Producer和Conumser通过NameServer就可以知道整个Broker集群的路由信息，从而进行消息的投递和消费。NameServer通常也是集群的方式部署，各实例间相互不进行信息通讯。Broker是向每一台NameServer注册自己的路由信息，所以每一个NameServer实例上面都保存一份完整的路由信息。当某个NameServer因某种原因下线了，Broker仍然可以向其它NameServer同步其路由信息，Producer,Consumer仍然可以动态感知Broker的路由的信息。</p></li><li><p><strong>BrokerServer</strong> ：Broker主要负责消息的存储、投递和查询以及服务高可用保证，为了实现这些功能，Broker包含了以下几个重要子模块。</p></li></ul><ol><li><strong>Remoting Module</strong> ：整个Broker的实体，负责处理来自clients端的请求。</li><li><strong>Client Manager</strong>：负责管理客户端(Producer/Consumer)和维护Consumer的Topic订阅信息</li><li><strong>Store Service</strong> ：提供方便简单的API接口处理消息存储到物理硬盘和查询功能。</li><li><strong>HA Service</strong> ：高可用服务，提供Master Broker 和 Slave Broker之间的数据同步功能。</li><li><strong>Index Service</strong> ：根据特定的Message key对投递到Broker的消息进行索引服务，以提供消息的快速查询。</li></ol><p><img src=https://github.com/apache/rocketmq/raw/master/docs/cn/image/rocketmq_architecture_2.png alt></p><h2 id=2-部署架构>2 部署架构</h2><p><img src=https://github.com/apache/rocketmq/raw/master/docs/cn/image/rocketmq_architecture_3.png alt></p><h3 id=rocketmq-网络部署特点>RocketMQ 网络部署特点</h3><ul><li><p>NameServer是一个几乎无状态节点，可集群部署，节点之间无任何信息同步。</p></li><li><p>Broker部署相对复杂，Broker分为Master与Slave，一个Master可以对应多个Slave，但是一个Slave只能对应一个Master，Master与Slave 的对应关系通过指定相同的BrokerName，不同的BrokerId 来定义，BrokerId为0表示Master，非0表示Slave。Master也可以部署多个。每个Broker与NameServer集群中的所有节点建立长连接，定时注册Topic信息到所有NameServer。 注意：当前RocketMQ版本在部署架构上支持一Master多Slave，但只有BrokerId=1的从服务器才会参与消息的读负载。</p></li><li><p>Producer与NameServer集群中的其中一个节点（随机选择）建立长连接，定期从NameServer获取Topic路由信息，并向提供Topic 服务的Master建立长连接，且定时向Master发送心跳。Producer完全无状态，可集群部署。</p></li><li><p>Consumer与NameServer集群中的其中一个节点（随机选择）建立长连接，定期从NameServer获取Topic路由信息，并向提供Topic服务的Master、Slave建立长连接，且定时向Master、Slave发送心跳。Consumer既可以从Master订阅消息，也可以从Slave订阅消息，消费者在向Master拉取消息时，Master服务器会根据拉取偏移量与最大偏移量的距离（判断是否读老消息，产生读I/O），以及从服务器是否可读等因素建议下一次是从Master还是Slave拉取。</p></li></ul><p>结合部署架构图，描述集群工作流程：</p><ul><li>启动NameServer，NameServer起来后监听端口，等待Broker、Producer、Consumer连上来，相当于一个路由控制中心。</li><li>Broker启动，跟所有的NameServer保持长连接，定时发送心跳包。心跳包中包含当前Broker信息(IP+端口等)以及存储所有Topic信息。注册成功后，NameServer集群中就有Topic跟Broker的映射关系。</li><li>收发消息前，先创建Topic，创建Topic时需要指定该Topic要存储在哪些Broker上，也可以在发送消息时自动创建Topic。</li><li>Producer发送消息，启动时先跟NameServer集群中的其中一台建立长连接，并从NameServer中获取当前发送的Topic存在哪些Broker上，轮询从队列列表中选择一个队列，然后与队列所在的Broker建立长连接从而向Broker发消息。</li><li>Consumer跟Producer类似，跟其中一台NameServer建立长连接，获取当前订阅Topic存在哪些Broker上，然后直接跟Broker建立连接通道，开始消费消息。</li></ul><blockquote><p>后续会根据架构结合源码进行Rocket mq的源码分析</p></blockquote><p>参考文档：</p><ul><li><a href=https://github.com/apache/rocketmq/blob/master/docs/cn/architecture.md>MQ架构设计</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-44caf4678a2ffdda5b2e7e5e101bdc0f>4 - RocketMQ-模块设计</h1><h1 id=模块设计design>模块设计(design)</h1><hr><h3 id=1-消息存储>1 消息存储</h3><p><img src=https://github.com/apache/rocketmq/raw/master/docs/cn/image/rocketmq_design_1.png alt></p><p>消息存储是RocketMQ中最为复杂和最为重要的一部分，本节将分别从RocketMQ的消息存储整体架构、PageCache与Mmap内存映射以及RocketMQ中两种不同的刷盘方式三方面来分别展开叙述。</p><h4 id=11-消息存储整体架构>1.1 消息存储整体架构</h4><p>消息存储架构图中主要有下面三个跟消息存储相关的文件构成。</p><p>(1) CommitLog：消息主体以及元数据的存储主体，存储Producer端写入的消息主体内容,消息内容不是定长的。单个文件大小默认1G ，文件名长度为20位，左边补零，剩余为起始偏移量，比如00000000000000000000代表了第一个文件，起始偏移量为0，文件大小为1G=1073741824；当第一个文件写满了，第二个文件为00000000001073741824，起始偏移量为1073741824，以此类推。消息主要是顺序写入日志文件，当文件满了，写入下一个文件；</p><p>(2) ConsumeQueue：消息消费队列，引入的目的主要是提高消息消费的性能，由于RocketMQ是基于主题topic的订阅模式，消息消费是针对主题进行的，如果要遍历commitlog文件中根据topic检索消息是非常低效的。Consumer即可根据ConsumeQueue来查找待消费的消息。其中，ConsumeQueue（逻辑消费队列）作为消费消息的索引，保存了指定Topic下的队列消息在CommitLog中的起始物理偏移量offset，消息大小size和消息Tag的HashCode值。consumequeue文件可以看成是基于topic的commitlog索引文件，故consumequeue文件夹的组织方式如下：topic/queue/file三层组织结构，具体存储路径为：$HOME/store/consumequeue/{topic}/{queueId}/{fileName}。同样consumequeue文件采取定长设计，每一个条目共20个字节，分别为8字节的commitlog物理偏移量、4字节的消息长度、8字节tag hashcode，单个文件由30W个条目组成，可以像数组一样随机访问每一个条目，每个ConsumeQueue文件大小约5.72M；</p><p>(3) IndexFile：IndexFile（索引文件）提供了一种可以通过key或时间区间来查询消息的方法。Index文件的存储位置是：$HOME \store\index${fileName}，文件名fileName是以创建时的时间戳命名的，固定的单个IndexFile文件大小约为400M，一个IndexFile可以保存 2000W个索引，IndexFile的底层存储设计为在文件系统中实现HashMap结构，故rocketmq的索引文件其底层实现为hash索引。</p><p>在上面的RocketMQ的消息存储整体架构图中可以看出，RocketMQ采用的是混合型的存储结构，即为Broker单个实例下所有的队列共用一个日志数据文件（即为CommitLog）来存储。RocketMQ的混合型存储结构(多个Topic的消息实体内容都存储于一个CommitLog中)针对Producer和Consumer分别采用了数据和索引部分相分离的存储结构，Producer发送消息至Broker端，然后Broker端使用同步或者异步的方式对消息刷盘持久化，保存至CommitLog中。只要消息被刷盘持久化至磁盘文件CommitLog中，那么Producer发送的消息就不会丢失。正因为如此，Consumer也就肯定有机会去消费这条消息。当无法拉取到消息后，可以等下一次消息拉取，同时服务端也支持长轮询模式，如果一个消息拉取请求未拉取到消息，Broker允许等待30s的时间，只要这段时间内有新消息到达，将直接返回给消费端。这里，RocketMQ的具体做法是，使用Broker端的后台服务线程—ReputMessageService不停地分发请求并异步构建ConsumeQueue（逻辑消费队列）和IndexFile（索引文件）数据。</p><h4 id=12-页缓存与内存映射>1.2 页缓存与内存映射</h4><p>页缓存（PageCache)是OS对文件的缓存，用于加速对文件的读写。一般来说，程序对文件进行顺序读写的速度几乎接近于内存的读写速度，主要原因就是由于OS使用PageCache机制对读写访问操作进行了性能优化，将一部分的内存用作PageCache。对于数据的写入，OS会先写入至Cache内，随后通过异步的方式由pdflush内核线程将Cache内的数据刷盘至物理磁盘上。对于数据的读取，如果一次读取文件时出现未命中PageCache的情况，OS从物理磁盘上访问读取文件的同时，会顺序对其他相邻块的数据文件进行预读取。</p><p>在RocketMQ中，ConsumeQueue逻辑消费队列存储的数据较少，并且是顺序读取，在page cache机制的预读取作用下，Consume Queue文件的读性能几乎接近读内存，即使在有消息堆积情况下也不会影响性能。而对于CommitLog消息存储的日志数据文件来说，读取消息内容时候会产生较多的随机访问读取，严重影响性能。如果选择合适的系统IO调度算法，比如设置调度算法为“Deadline”（此时块存储采用SSD的话），随机读的性能也会有所提升。</p><p>另外，RocketMQ主要通过MappedByteBuffer对文件进行读写操作。其中，利用了NIO中的FileChannel模型将磁盘上的物理文件直接映射到用户态的内存地址中（这种Mmap的方式减少了传统IO将磁盘文件数据在操作系统内核地址空间的缓冲区和用户应用程序地址空间的缓冲区之间来回进行拷贝的性能开销），将对文件的操作转化为直接对内存地址进行操作，从而极大地提高了文件的读写效率（正因为需要使用内存映射机制，故RocketMQ的文件存储都使用定长结构来存储，方便一次将整个文件映射至内存）。</p><h4 id=13-消息刷盘>1.3 消息刷盘</h4><p><img src=https://github.com/apache/rocketmq/raw/master/docs/cn/image/rocketmq_design_2.png alt></p><p>(1) 同步刷盘：如上图所示，只有在消息真正持久化至磁盘后RocketMQ的Broker端才会真正返回给Producer端一个成功的ACK响应。同步刷盘对MQ消息可靠性来说是一种不错的保障，但是性能上会有较大影响，一般适用于金融业务应用该模式较多。</p><p>(2) 异步刷盘：能够充分利用OS的PageCache的优势，只要消息写入PageCache即可将成功的ACK返回给Producer端。消息刷盘采用后台异步线程提交的方式进行，降低了读写延迟，提高了MQ的性能和吞吐量。</p><h3 id=2-通信机制>2 通信机制</h3><p>RocketMQ消息队列集群主要包括NameServer、Broker(Master/Slave)、Producer、Consumer4个角色，基本通讯流程如下：</p><p>(1) Broker启动后需要完成一次将自己注册至NameServer的操作；随后每隔30s时间定时向NameServer上报Topic路由信息。</p><p>(2) 消息生产者Producer作为客户端发送消息时候，需要根据消息的Topic从本地缓存的TopicPublishInfoTable获取路由信息。如果没有则更新路由信息会从NameServer上重新拉取，同时Producer会默认每隔30s向NameServer拉取一次路由信息。</p><p>(3) 消息生产者Producer根据2）中获取的路由信息选择一个队列（MessageQueue）进行消息发送；Broker作为消息的接收者接收消息并落盘存储。</p><p>(4) 消息消费者Consumer根据2）中获取的路由信息，并再完成客户端的负载均衡后，选择其中的某一个或者某几个消息队列来拉取消息并进行消费。</p><p>从上面1）~3）中可以看出在消息生产者, Broker和NameServer之间都会发生通信（这里只说了MQ的部分通信），因此如何设计一个良好的网络通信模块在MQ中至关重要，它将决定RocketMQ集群整体的消息传输能力与最终的性能。</p><p>rocketmq-remoting 模块是 RocketMQ消息队列中负责网络通信的模块，它几乎被其他所有需要网络通信的模块（诸如rocketmq-client、rocketmq-broker、rocketmq-namesrv）所依赖和引用。为了实现客户端与服务器之间高效的数据请求与接收，RocketMQ消息队列自定义了通信协议并在Netty的基础之上扩展了通信模块。</p><h4 id=21-remoting通信类结构>2.1 Remoting通信类结构</h4><p><img src=https://github.com/apache/rocketmq/raw/master/docs/cn/image/rocketmq_design_3.png alt></p><h4 id=22-协议设计与编解码>2.2 协议设计与编解码</h4><p>在Client和Server之间完成一次消息发送时，需要对发送的消息进行一个协议约定，因此就有必要自定义RocketMQ的消息协议。同时，为了高效地在网络中传输消息和对收到的消息读取，就需要对消息进行编解码。在RocketMQ中，RemotingCommand这个类在消息传输过程中对所有数据内容的封装，不但包含了所有的数据结构，还包含了编码解码操作。</p><table><thead><tr><th>Header字段</th><th>类型</th><th>Request说明</th><th>Response说明</th></tr></thead><tbody><tr><td>code</td><td>int</td><td>请求操作码，应答方根据不同的请求码进行不同的业务处理</td><td>应答响应码。0表示成功，非0则表示各种错误</td></tr><tr><td>language</td><td>LanguageCode</td><td>请求方实现的语言</td><td>应答方实现的语言</td></tr><tr><td>version</td><td>int</td><td>请求方程序的版本</td><td>应答方程序的版本</td></tr><tr><td>opaque</td><td>int</td><td>相当于requestId，在同一个连接上的不同请求标识码，与响应消息中的相对应</td><td>应答不做修改直接返回</td></tr><tr><td>flag</td><td>int</td><td>区分是普通RPC还是onewayRPC得标志</td><td>区分是普通RPC还是onewayRPC得标志</td></tr><tr><td>remark</td><td>String</td><td>传输自定义文本信息</td><td>传输自定义文本信息</td></tr><tr><td>extFields</td><td>HashMap&lt;String, String></td><td>请求自定义扩展信息</td><td>响应自定义扩展信息</td></tr></tbody></table><p><img src=https://github.com/apache/rocketmq/raw/master/docs/cn/image/rocketmq_design_4.png alt></p><p>可见传输内容主要可以分为以下4部分：</p><p>(1) 消息长度：总长度，四个字节存储，占用一个int类型；</p><p>(2) 序列化类型&消息头长度：同样占用一个int类型，第一个字节表示序列化类型，后面三个字节表示消息头长度；</p><p>(3) 消息头数据：经过序列化后的消息头数据；</p><p>(4) 消息主体数据：消息主体的二进制字节数据内容；</p><h4 id=23-消息的通信方式和流程>2.3 消息的通信方式和流程</h4><p>在RocketMQ消息队列中支持通信的方式主要有同步(sync)、异步(async)、单向(oneway)
三种。其中“单向”通信模式相对简单，一般用在发送心跳包场景下，无需关注其Response。这里，主要介绍RocketMQ的异步通信流程。</p><p><img src=https://github.com/apache/rocketmq/raw/master/docs/cn/image/rocketmq_design_5.png alt></p><h4 id=24-reactor多线程设计>2.4 Reactor多线程设计</h4><p>RocketMQ的RPC通信采用Netty组件作为底层通信库，同样也遵循了Reactor多线程模型，同时又在这之上做了一些扩展和优化。</p><p><img src=https://github.com/apache/rocketmq/raw/master/docs/cn/image/rocketmq_design_6.png alt></p><p>上面的框图中可以大致了解RocketMQ中NettyRemotingServer的Reactor 多线程模型。一个 Reactor 主线程（eventLoopGroupBoss，即为上面的1）负责监听 TCP网络连接请求，建立好连接，创建SocketChannel，并注册到selector上。RocketMQ的源码中会自动根据OS的类型选择NIO和Epoll，也可以通过参数配置）,然后监听真正的网络数据。拿到网络数据后，再丢给Worker线程池（eventLoopGroupSelector，即为上面的“N”，源码中默认设置为3），在真正执行业务逻辑之前需要进行SSL验证、编解码、空闲检查、网络连接管理，这些工作交给defaultEventExecutorGroup（即为上面的“M1”，源码中默认设置为8）去做。而处理业务操作放在业务线程池中执行，根据 RomotingCommand 的业务请求码code去processorTable这个本地缓存变量中找到对应的 processor，然后封装成task任务后，提交给对应的业务processor处理线程池来执行（sendMessageExecutor，以发送消息为例，即为上面的 “M2”）。从入口到业务逻辑的几个步骤中线程池一直再增加，这跟每一步逻辑复杂性相关，越复杂，需要的并发通道越宽。</p><table><thead><tr><th>线程数</th><th>线程名</th><th>线程具体说明</th></tr></thead><tbody><tr><td>1</td><td>NettyBoss_%d</td><td>Reactor 主线程</td></tr><tr><td>N</td><td>NettyServerEPOLLSelector_%d_%d</td><td>Reactor 线程池</td></tr><tr><td>M1</td><td>NettyServerCodecThread_%d</td><td>Worker线程池</td></tr><tr><td>M2</td><td>RemotingExecutorThread_%d</td><td>业务processor处理线程池</td></tr></tbody></table><h3 id=3-消息过滤>3 消息过滤</h3><p>RocketMQ分布式消息队列的消息过滤方式有别于其它MQ中间件，是在Consumer端订阅消息时再做消息过滤的。RocketMQ这么做是在于其Producer端写入消息和Consumer端订阅消息采用分离存储的机制来实现的，Consumer端订阅消息是需要通过ConsumeQueue这个消息消费的逻辑队列拿到一个索引，然后再从CommitLog里面读取真正的消息实体内容，所以说到底也是还绕不开其存储结构。其ConsumeQueue的存储结构如下，可以看到其中有8个字节存储的Message Tag的哈希值，基于Tag的消息过滤正式基于这个字段值的。</p><p><img src=https://github.com/apache/rocketmq/raw/master/docs/cn/image/rocketmq_design_7.png alt></p><p>主要支持如下2种的过滤方式
(1) Tag过滤方式：Consumer端在订阅消息时除了指定Topic还可以指定TAG，如果一个消息有多个TAG，可以用||分隔。其中，Consumer端会将这个订阅请求构建成一个 SubscriptionData，发送一个Pull消息的请求给Broker端。Broker端从RocketMQ的文件存储层—Store读取数据之前，会用这些数据先构建一个MessageFilter，然后传给Store。Store从 ConsumeQueue读取到一条记录后，会用它记录的消息tag hash值去做过滤，由于在服务端只是根据hashcode进行判断，无法精确对tag原始字符串进行过滤，故在消息消费端拉取到消息后，还需要对消息的原始tag字符串进行比对，如果不同，则丢弃该消息，不进行消息消费。</p><p>(2) SQL92的过滤方式：这种方式的大致做法和上面的Tag过滤方式一样，只是在Store层的具体过滤过程不太一样，真正的 SQL expression 的构建和执行由rocketmq-filter模块负责的。每次过滤都去执行SQL表达式会影响效率，所以RocketMQ使用了BloomFilter避免了每次都去执行。SQL92的表达式上下文为消息的属性。</p><h3 id=4-负载均衡>4 负载均衡</h3><p>RocketMQ中的负载均衡都在Client端完成，具体来说的话，主要可以分为Producer端发送消息时候的负载均衡和Consumer端订阅消息的负载均衡。</p><h4 id=41-producer的负载均衡>4.1 Producer的负载均衡</h4><p>Producer端在发送消息的时候，会先根据Topic找到指定的TopicPublishInfo，在获取了TopicPublishInfo路由信息后，RocketMQ的客户端在默认方式下selectOneMessageQueue()方法会从TopicPublishInfo中的messageQueueList中选择一个队列（MessageQueue）进行发送消息。具体的容错策略均在MQFaultStrategy这个类中定义。这里有一个sendLatencyFaultEnable开关变量，如果开启，在随机递增取模的基础上，再过滤掉not available的Broker代理。所谓的"latencyFaultTolerance"，是指对之前失败的，按一定的时间做退避。例如，如果上次请求的latency超过550Lms，就退避3000Lms；超过1000L，就退避60000L；如果关闭，采用随机递增取模的方式选择一个队列（MessageQueue）来发送消息，latencyFaultTolerance机制是实现消息发送高可用的核心关键所在。</p><h4 id=42-consumer的负载均衡>4.2 Consumer的负载均衡</h4><p>在RocketMQ中，Consumer端的两种消费模式（Push/Pull）都是基于拉模式来获取消息的，而在Push模式只是对pull模式的一种封装，其本质实现为消息拉取线程在从服务器拉取到一批消息后，然后提交到消息消费线程池后，又“马不停蹄”的继续向服务器再次尝试拉取消息。如果未拉取到消息，则延迟一下又继续拉取。在两种基于拉模式的消费方式（Push/Pull）中，均需要Consumer端在知道从Broker端的哪一个消息队列—队列中去获取消息。因此，有必要在Consumer端来做负载均衡，即Broker端中多个MessageQueue分配给同一个ConsumerGroup中的哪些Consumer消费。</p><p>1、Consumer端的心跳包发送</p><p>在Consumer启动后，它就会通过定时任务不断地向RocketMQ集群中的所有Broker实例发送心跳包（其中包含了，消息消费分组名称、订阅关系集合、消息通信模式和客户端id的值等信息）。Broker端在收到Consumer的心跳消息后，会将它维护在ConsumerManager的本地缓存变量—consumerTable，同时并将封装后的客户端网络通道信息保存在本地缓存变量—channelInfoTable中，为之后做Consumer端的负载均衡提供可以依据的元数据信息。</p><p>2、Consumer端实现负载均衡的核心类—RebalanceImpl</p><p>在Consumer实例的启动流程中的启动MQClientInstance实例部分，会完成负载均衡服务线程—RebalanceService的启动（每隔20s执行一次）。通过查看源码可以发现，RebalanceService线程的run()方法最终调用的是RebalanceImpl类的rebalanceByTopic()方法，该方法是实现Consumer端负载均衡的核心。这里，rebalanceByTopic()方法会根据消费者通信类型为“广播模式”还是“集群模式”做不同的逻辑处理。这里主要来看下集群模式下的主要处理流程：</p><p>(1) 从rebalanceImpl实例的本地缓存变量—topicSubscribeInfoTable中，获取该Topic主题下的消息消费队列集合（mqSet）；</p><p>(2) 根据topic和consumerGroup为参数调用mQClientFactory.findConsumerIdList()方法向Broker端发送获取该消费组下消费者Id列表的RPC通信请求（Broker端基于前面Consumer端上报的心跳包数据而构建的consumerTable做出响应返回，业务请求码：GET_CONSUMER_LIST_BY_GROUP）；</p><p>(3) 先对Topic下的消息消费队列、消费者Id排序，然后用消息队列分配策略算法（默认为：消息队列的平均分配算法），计算出待拉取的消息队列。这里的平均分配算法，类似于分页的算法，将所有MessageQueue排好序类似于记录，将所有消费端Consumer排好序类似页数，并求出每一页需要包含的平均size和每个页面记录的范围range，最后遍历整个range而计算出当前Consumer端应该分配到的记录（这里即为：MessageQueue）。</p><p><img src=https://github.com/apache/rocketmq/raw/master/docs/cn/image/rocketmq_design_8.png alt></p><p>(4) 然后，调用updateProcessQueueTableInRebalance()方法，具体的做法是，先将分配到的消息队列集合（mqSet）与processQueueTable做一个过滤比对。</p><p><img src=https://github.com/apache/rocketmq/raw/master/docs/cn/image/rocketmq_design_9.png alt></p><ul><li><p>上图中processQueueTable标注的红色部分，表示与分配到的消息队列集合mqSet互不包含。将这些队列设置Dropped属性为true，然后查看这些队列是否可以移除出processQueueTable缓存变量，这里具体执行removeUnnecessaryMessageQueue()方法，即每隔1s 查看是否可以获取当前消费处理队列的锁，拿到的话返回true。如果等待1s后，仍然拿不到当前消费处理队列的锁则返回false。如果返回true，则从processQueueTable缓存变量中移除对应的Entry；</p></li><li><p>上图中processQueueTable的绿色部分，表示与分配到的消息队列集合mqSet的交集。判断该ProcessQueue是否已经过期了，在Pull模式的不用管，如果是Push模式的，设置Dropped属性为true，并且调用removeUnnecessaryMessageQueue()方法，像上面一样尝试移除Entry；</p></li></ul><p>最后，为过滤后的消息队列集合（mqSet）中的每个MessageQueue创建一个ProcessQueue对象并存入RebalanceImpl的processQueueTable队列中（其中调用RebalanceImpl实例的computePullFromWhere(MessageQueue mq)方法获取该MessageQueue对象的下一个进度消费值offset，随后填充至接下来要创建的pullRequest对象属性中），并创建拉取请求对象—pullRequest添加到拉取列表—pullRequestList中，最后执行dispatchPullRequest()方法，将Pull消息的请求对象PullRequest依次放入PullMessageService服务线程的阻塞队列pullRequestQueue中，待该服务线程取出后向Broker端发起Pull消息的请求。其中，可以重点对比下，RebalancePushImpl和RebalancePullImpl两个实现类的dispatchPullRequest()方法不同，RebalancePullImpl类里面的该方法为空，这样子也就回答了上一篇中最后的那道思考题了。</p><p>消息消费队列在同一消费组不同消费者之间的负载均衡，其核心设计理念是在一个消息消费队列在同一时间只允许被同一消费组内的一个消费者消费，一个消息消费者能同时消费多个消息队列。</p><h3 id=5-事务消息>5 事务消息</h3><p>Apache RocketMQ在4.3.0版中已经支持分布式事务消息，这里RocketMQ采用了2PC的思想来实现了提交事务消息，同时增加一个补偿逻辑来处理二阶段超时或者失败的消息，如下图所示。</p><p><img src=https://github.com/apache/rocketmq/raw/master/docs/cn/image/rocketmq_design_10.png alt></p><h4 id=51-rocketmq事务消息流程概要>5.1 RocketMQ事务消息流程概要</h4><p>上图说明了事务消息的大致方案，其中分为两个流程：正常事务消息的发送及提交、事务消息的补偿流程。</p><p>1.事务消息发送及提交：</p><p>(1) 发送消息（half消息）。</p><p>(2) 服务端响应消息写入结果。</p><p>(3) 根据发送结果执行本地事务（如果写入失败，此时half消息对业务不可见，本地逻辑不执行）。</p><p>(4) 根据本地事务状态执行Commit或者Rollback（Commit操作生成消息索引，消息对消费者可见）</p><p>2.补偿流程：</p><p>(1) 对没有Commit/Rollback的事务消息（pending状态的消息），从服务端发起一次“回查”</p><p>(2) Producer收到回查消息，检查回查消息对应的本地事务的状态</p><p>(3) 根据本地事务状态，重新Commit或者Rollback</p><p>其中，补偿阶段用于解决消息Commit或者Rollback发生超时或者失败的情况。</p><h4 id=52-rocketmq事务消息设计>5.2 RocketMQ事务消息设计</h4><p>1.事务消息在一阶段对用户不可见</p><p>在RocketMQ事务消息的主要流程中，一阶段的消息如何对用户不可见。其中，事务消息相对普通消息最大的特点就是一阶段发送的消息对用户是不可见的。那么，如何做到写入消息但是对用户不可见呢？RocketMQ事务消息的做法是：如果消息是half消息，将备份原消息的主题与消息消费队列，然后改变主题为RMQ_SYS_TRANS_HALF_TOPIC。由于消费组未订阅该主题，故消费端无法消费half类型的消息，然后RocketMQ会开启一个定时任务，从Topic为RMQ_SYS_TRANS_HALF_TOPIC中拉取消息进行消费，根据生产者组获取一个服务提供者发送回查事务状态请求，根据事务状态来决定是提交或回滚消息。</p><p>在RocketMQ中，消息在服务端的存储结构如下，每条消息都会有对应的索引信息，Consumer通过ConsumeQueue这个二级索引来读取消息实体内容，其流程如下：</p><p><img src=https://github.com/apache/rocketmq/raw/master/docs/cn/image/rocketmq_design_11.png alt></p><p>RocketMQ的具体实现策略是：写入的如果事务消息，对消息的Topic和Queue等属性进行替换，同时将原来的Topic和Queue信息存储到消息的属性中，正因为消息主题被替换，故消息并不会转发到该原主题的消息消费队列，消费者无法感知消息的存在，不会消费。其实改变消息主题是RocketMQ的常用“套路”，回想一下延时消息的实现机制。</p><p>2.Commit和Rollback操作以及Op消息的引入</p><p>在完成一阶段写入一条对用户不可见的消息后，二阶段如果是Commit操作，则需要让消息对用户可见；如果是Rollback则需要撤销一阶段的消息。先说Rollback的情况。对于Rollback，本身一阶段的消息对用户是不可见的，其实不需要真正撤销消息（实际上RocketMQ也无法去真正的删除一条消息，因为是顺序写文件的）。但是区别于这条消息没有确定状态（Pending状态，事务悬而未决），需要一个操作来标识这条消息的最终状态。RocketMQ事务消息方案中引入了Op消息的概念，用Op消息标识事务消息已经确定的状态（Commit或者Rollback）。如果一条事务消息没有对应的Op消息，说明这个事务的状态还无法确定（可能是二阶段失败了）。引入Op消息后，事务消息无论是Commit或者Rollback都会记录一个Op操作。Commit相对于Rollback只是在写入Op消息前创建Half消息的索引。</p><p>3.Op消息的存储和对应关系</p><p>RocketMQ将Op消息写入到全局一个特定的Topic中通过源码中的方法—TransactionalMessageUtil.buildOpTopic()；这个Topic是一个内部的Topic（像Half消息的Topic一样），不会被用户消费。Op消息的内容为对应的Half消息的存储的Offset，这样通过Op消息能索引到Half消息进行后续的回查操作。</p><p><img src=https://github.com/apache/rocketmq/raw/master/docs/cn/image/rocketmq_design_12.png alt></p><p>4.Half消息的索引构建</p><p>在执行二阶段Commit操作时，需要构建出Half消息的索引。一阶段的Half消息由于是写到一个特殊的Topic，所以二阶段构建索引时需要读取出Half消息，并将Topic和Queue替换成真正的目标的Topic和Queue，之后通过一次普通消息的写入操作来生成一条对用户可见的消息。所以RocketMQ事务消息二阶段其实是利用了一阶段存储的消息的内容，在二阶段时恢复出一条完整的普通消息，然后走一遍消息写入流程。</p><p>5.如何处理二阶段失败的消息？</p><p>如果在RocketMQ事务消息的二阶段过程中失败了，例如在做Commit操作时，出现网络问题导致Commit失败，那么需要通过一定的策略使这条消息最终被Commit。RocketMQ采用了一种补偿机制，称为“回查”。Broker端对未确定状态的消息发起回查，将消息发送到对应的Producer端（同一个Group的Producer），由Producer根据消息来检查本地事务的状态，进而执行Commit或者Rollback。Broker端通过对比Half消息和Op消息进行事务消息的回查并且推进CheckPoint（记录那些事务消息的状态是确定的）。</p><p>值得注意的是，rocketmq并不会无休止的的信息事务状态回查，默认回查15次，如果15次回查还是无法得知事务状态，rocketmq默认回滚该消息。</p><h3 id=6-消息查询>6 消息查询</h3><p>RocketMQ支持按照下面两种维度（“按照Message Id查询消息”、“按照Message Key查询消息”）进行消息查询。</p><h4 id=61---按照messageid查询消息>6.1 按照MessageId查询消息</h4><p>RocketMQ中的MessageId的长度总共有16字节，其中包含了消息存储主机地址（IP地址和端口），消息Commit Log offset。“按照MessageId查询消息”在RocketMQ中具体做法是：Client端从MessageId中解析出Broker的地址（IP地址和端口）和Commit Log的偏移地址后封装成一个RPC请求后通过Remoting通信层发送（业务请求码：VIEW_MESSAGE_BY_ID）。Broker端走的是QueryMessageProcessor，读取消息的过程用其中的 commitLog offset 和 size 去 commitLog 中找到真正的记录并解析成一个完整的消息返回。</p><h4 id=62--按照message-key查询消息>6.2 按照Message Key查询消息</h4><p>“按照Message Key查询消息”，主要是基于RocketMQ的IndexFile索引文件来实现的。RocketMQ的索引文件逻辑结构，类似JDK中HashMap的实现。索引文件的具体结构如下：</p><p><img src=https://github.com/apache/rocketmq/raw/master/docs/cn/image/rocketmq_design_13.png alt></p><p>IndexFile索引文件为用户提供通过“按照Message Key查询消息”的消息索引查询服务，IndexFile文件的存储位置是：$HOME\store\index${fileName}，文件名fileName是以创建时的时间戳命名的，文件大小是固定的，等于40+500W*4+2000W*20= 420000040个字节大小。如果消息的properties中设置了UNIQ_KEY这个属性，就用 topic + “#” + UNIQ_KEY的value作为 key 来做写入操作。如果消息设置了KEYS属性（多个KEY以空格分隔），也会用 topic + “#” + KEY 来做索引。</p><p>其中的索引数据包含了Key Hash/CommitLog Offset/Timestamp/NextIndex offset 这四个字段，一共20 Byte。NextIndex offset 即前面读出来的 slotValue，如果有 hash冲突，就可以用这个字段将所有冲突的索引用链表的方式串起来了。Timestamp记录的是消息storeTimestamp之间的差，并不是一个绝对的时间。整个Index File的结构如图，40 Byte 的Header用于保存一些总的统计信息，4*500W的 Slot Table并不保存真正的索引数据，而是保存每个槽位对应的单向链表的头。20*2000W 是真正的索引数据，即一个 Index File 可以保存 2000W个索引。</p><p>“按照Message Key查询消息”的方式，RocketMQ的具体做法是，主要通过Broker端的QueryMessageProcessor业务处理器来查询，读取消息的过程就是用topic和key找到IndexFile索引文件中的一条记录，根据其中的commitLog offset从CommitLog文件中读取消息的实体内容。</p><p>参考文档：</p><ul><li><a href=https://github.com/apache/rocketmq/blob/master/docs/cn/design.md>MQ设计</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-1894b5c028a9e6b041f4883c79d9ee42>5 - RocketMQ-特性</h1><h1 id=特性features>特性(features)</h1><hr><h2 id=1-订阅与发布>1 订阅与发布</h2><p>消息的发布是指某个生产者向某个topic发送消息；消息的订阅是指某个消费者关注了某个topic中带有某些tag的消息，进而从该topic消费数据。</p><h2 id=2-消息顺序>2 消息顺序</h2><p>消息有序指的是一类消息消费时，能按照发送的顺序来消费。例如：一个订单产生了三条消息分别是订单创建、订单付款、订单完成。消费时要按照这个顺序消费才能有意义，但是同时订单之间是可以并行消费的。RocketMQ可以严格的保证消息有序。</p><p>顺序消息分为全局顺序消息与分区顺序消息，全局顺序是指某个Topic下的所有消息都要保证顺序；部分顺序消息只要保证每一组消息被顺序消费即可。</p><ul><li>全局顺序
对于指定的一个 Topic，所有消息按照严格的先入先出（FIFO）的顺序进行发布和消费。
适用场景：性能要求不高，所有的消息严格按照 FIFO 原则进行消息发布和消费的场景</li><li>分区顺序
对于指定的一个 Topic，所有消息根据 sharding key 进行区块分区。 同一个分区内的消息按照严格的 FIFO 顺序进行发布和消费。 Sharding key 是顺序消息中用来区分不同分区的关键字段，和普通消息的 Key 是完全不同的概念。
适用场景：性能要求高，以 sharding key 作为分区字段，在同一个区块中严格的按照 FIFO 原则进行消息发布和消费的场景。</li></ul><h2 id=3-消息过滤>3 消息过滤</h2><p>RocketMQ的消费者可以根据Tag进行消息过滤，也支持自定义属性过滤。消息过滤目前是在Broker端实现的，优点是减少了对于Consumer无用消息的网络传输，缺点是增加了Broker的负担、而且实现相对复杂。</p><h2 id=4-消息可靠性>4 消息可靠性</h2><p>RocketMQ支持消息的高可靠，影响消息可靠性的几种情况：</p><ol><li>Broker非正常关闭</li><li>Broker异常Crash</li><li>OS Crash</li><li>机器掉电，但是能立即恢复供电情况</li><li>机器无法开机（可能是cpu、主板、内存等关键设备损坏）</li><li>磁盘设备损坏</li></ol><p>1)、2)、3)、4) 四种情况都属于硬件资源可立即恢复情况，RocketMQ在这四种情况下能保证消息不丢，或者丢失少量数据（依赖刷盘方式是同步还是异步）。</p><p>5)、6)属于单点故障，且无法恢复，一旦发生，在此单点上的消息全部丢失。RocketMQ在这两种情况下，通过异步复制，可保证99%的消息不丢，但是仍然会有极少量的消息可能丢失。通过同步双写技术可以完全避免单点，同步双写势必会影响性能，适合对消息可靠性要求极高的场合，例如与Money相关的应用。注：RocketMQ从3.0版本开始支持同步双写。</p><h2 id=5-至少一次>5 至少一次</h2><p>至少一次(At least Once)指每个消息必须投递一次。Consumer先Pull消息到本地，消费完成后，才向服务器返回ack，如果没有消费一定不会ack消息，所以RocketMQ可以很好的支持此特性。</p><h2 id=6-回溯消费>6 回溯消费</h2><p>回溯消费是指Consumer已经消费成功的消息，由于业务上需求需要重新消费，要支持此功能，Broker在向Consumer投递成功消息后，消息仍然需要保留。并且重新消费一般是按照时间维度，例如由于Consumer系统故障，恢复后需要重新消费1小时前的数据，那么Broker要提供一种机制，可以按照时间维度来回退消费进度。RocketMQ支持按照时间回溯消费，时间维度精确到毫秒。</p><h2 id=7-事务消息>7 事务消息</h2><p>RocketMQ事务消息（Transactional Message）是指应用本地事务和发送消息操作可以被定义到全局事务中，要么同时成功，要么同时失败。RocketMQ的事务消息提供类似 X/Open XA 的分布事务功能，通过事务消息能达到分布式事务的最终一致。</p><h2 id=8-定时消息>8 定时消息</h2><p>定时消息（延迟队列）是指消息发送到broker后，不会立即被消费，等待特定时间投递给真正的topic。
broker有配置项messageDelayLevel，默认值为“1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h”，18个level。可以配置自定义messageDelayLevel。注意，messageDelayLevel是broker的属性，不属于某个topic。发消息时，设置delayLevel等级即可：msg.setDelayLevel(level)。level有以下三种情况：</p><ul><li>level == 0，消息为非延迟消息</li><li>1&lt;=level&lt;=maxLevel，消息延迟特定时间，例如level==1，延迟1s</li><li>level > maxLevel，则level== maxLevel，例如level==20，延迟2h</li></ul><p>定时消息会暂存在名为SCHEDULE_TOPIC_XXXX的topic中，并根据delayTimeLevel存入特定的queue，queueId = delayTimeLevel – 1，即一个queue只存相同延迟的消息，保证具有相同发送延迟的消息能够顺序消费。broker会调度地消费SCHEDULE_TOPIC_XXXX，将消息写入真实的topic。</p><p>需要注意的是，定时消息会在第一次写入和调度写入真实topic时都会计数，因此发送数量、tps都会变高。</p><h2 id=9-消息重试>9 消息重试</h2><p>Consumer消费消息失败后，要提供一种重试机制，令消息再消费一次。Consumer消费消息失败通常可以认为有以下几种情况：</p><ul><li>由于消息本身的原因，例如反序列化失败，消息数据本身无法处理（例如话费充值，当前消息的手机号被注销，无法充值）等。这种错误通常需要跳过这条消息，再消费其它消息，而这条失败的消息即使立刻重试消费，99%也不成功，所以最好提供一种定时重试机制，即过10秒后再重试。</li><li>由于依赖的下游应用服务不可用，例如db连接不可用，外系统网络不可达等。遇到这种错误，即使跳过当前失败的消息，消费其他消息同样也会报错。这种情况建议应用sleep 30s，再消费下一条消息，这样可以减轻Broker重试消息的压力。</li></ul><p>RocketMQ会为每个消费组都设置一个Topic名称为“%RETRY%+consumerGroup”的重试队列（这里需要注意的是，这个Topic的重试队列是针对消费组，而不是针对每个Topic设置的），用于暂时保存因为各种异常而导致Consumer端无法消费的消息。考虑到异常恢复起来需要一些时间，会为重试队列设置多个重试级别，每个重试级别都有与之对应的重新投递延时，重试次数越多投递延时就越大。RocketMQ对于重试消息的处理是先保存至Topic名称为“SCHEDULE_TOPIC_XXXX”的延迟队列中，后台定时任务按照对应的时间进行Delay后重新保存至“%RETRY%+consumerGroup”的重试队列中。</p><h2 id=10-消息重投>10 消息重投</h2><p>生产者在发送消息时，同步消息失败会重投，异步消息有重试，oneway没有任何保证。消息重投保证消息尽可能发送成功、不丢失，但可能会造成消息重复，消息重复在RocketMQ中是无法避免的问题。消息重复在一般情况下不会发生，当出现消息量大、网络抖动，消息重复就会是大概率事件。另外，生产者主动重发、consumer负载变化也会导致重复消息。如下方法可以设置消息重试策略：</p><ul><li>retryTimesWhenSendFailed:同步发送失败重投次数，默认为2，因此生产者会最多尝试发送retryTimesWhenSendFailed + 1次。不会选择上次失败的broker，尝试向其他broker发送，最大程度保证消息不丢。超过重投次数，抛出异常，由客户端保证消息不丢。当出现RemotingException、MQClientException和部分MQBrokerException时会重投。</li><li>retryTimesWhenSendAsyncFailed:异步发送失败重试次数，异步重试不会选择其他broker，仅在同一个broker上做重试，不保证消息不丢。</li><li>retryAnotherBrokerWhenNotStoreOK:消息刷盘（主或备）超时或slave不可用（返回状态非SEND_OK），是否尝试发送到其他broker，默认false。十分重要消息可以开启。</li></ul><h2 id=11-流量控制>11 流量控制</h2><p>生产者流控，因为broker处理能力达到瓶颈；消费者流控，因为消费能力达到瓶颈。</p><p>生产者流控：</p><ul><li>commitLog文件被锁时间超过osPageCacheBusyTimeOutMills时，参数默认为1000ms，返回流控。</li><li>如果开启transientStorePoolEnable == true，且broker为异步刷盘的主机，且transientStorePool中资源不足，拒绝当前send请求，返回流控。</li><li>broker每隔10ms检查send请求队列头部请求的等待时间，如果超过waitTimeMillsInSendQueue，默认200ms，拒绝当前send请求，返回流控。</li><li>broker通过拒绝send 请求方式实现流量控制。</li></ul><p>注意，生产者流控，不会尝试消息重投。</p><p>消费者流控：</p><ul><li>消费者本地缓存消息数超过pullThresholdForQueue时，默认1000。</li><li>消费者本地缓存消息大小超过pullThresholdSizeForQueue时，默认100MB。</li><li>消费者本地缓存消息跨度超过consumeConcurrentlyMaxSpan时，默认2000。</li></ul><p>消费者流控的结果是降低拉取频率。</p><h2 id=12-死信队列>12 死信队列</h2><p>死信队列用于处理无法被正常消费的消息。当一条消息初次消费失败，消息队列会自动进行消息重试；达到最大重试次数后，若消费依然失败，则表明消费者在正常情况下无法正确地消费该消息，此时，消息队列 不会立刻将消息丢弃，而是将其发送到该消费者对应的特殊队列中。</p><p>RocketMQ将这种正常情况下无法被消费的消息称为死信消息（Dead-Letter Message），将存储死信消息的特殊队列称为死信队列（Dead-Letter Queue）。在RocketMQ中，可以通过使用console控制台对死信队列中的消息进行重发来使得消费者实例再次进行消费。</p><p>参考文档：</p><ul><li><a href=https://github.com/apache/rocketmq/blob/master/docs/cn/features.md>MQ特性</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-d11afb91d365586f2715373ee87ffcd6>6 - RocketMQ Name Server</h1></div><div class=td-content><h1 id=pg-2ec75df1201cddcb51c9549a4a9b6e48>6.1 - NameServer</h1><h3 id=1-什么是nameserver>1. 什么是NameServer?</h3><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/RocketMQ%E7%89%A9%E7%90%86%E9%83%A8%E7%BD%B2%E5%9B%BE.jpg?raw=true" alt=图解></p><p><strong><code>NameServer</code></strong> 就是一个保存Broker状态的一个服务和Broker管理。</p><p><strong>NameServer 的特点：</strong></p><ul><li><strong>NameServer 和 每一台Broker 服务器保持长连接，并间隔30s检测一次Broker是否存活。</strong></li><li><strong>检测到 Broker右机 ， 则从路由注册表中将其移除 。 但是路由变化不会马上通知消息生产者。— 降低 NameServer实现的复杂性，在消息发送端提供容错机制来保证消息发送的高可用性</strong>。</li><li><strong>NameServer本身的高可用可通过部 署多台 NameServerr服务器来实现，但彼此之间互不通信，也就是 NameServer服务器之间在某一时刻的数据并不会完全相同</strong></li></ul><p><strong>作用</strong>：</p><ul><li><strong>消息生产者 和 消息消费者提供关 于主题 Topic 的路由信息</strong></li><li><strong>NameServer存储路由 的基础信息</strong></li><li><strong>管理 Broker节点，包括路由 注册、路由删除等功能</strong></li></ul><h3 id=2-nameserver-路由注册故障剔除>2. NameServer 路由注册、故障剔除</h3><h4 id=21-nameserver-存储了哪些信息>2.1 NameServer 存储了哪些信息</h4><ul><li>Topic 消息队列路由信息。消息发送时根据路由表进行负 载均衡。</li><li>Broker 基础信息， 包含 brokerName、 所属集群名称 、 主备 Broker 地址</li><li>Broker 集群信息，存储集群中所有 Broker 名称</li><li>Broker 状态信息 。NameServer 每次收到心跳包时会替换该信息</li><li>Broker上的 FilterServer列表，用于类模式消息过滤</li></ul><blockquote><p>RocketMQ 基于订阅发布机制 ， 一个Topic拥有多个消息队列 ，一个Broker为每一主题默认创建 4 个读队列 4 个写队列。多个Broker组成一个集群， BrokerName由相同的多台Broker组成Master-Slave架构。brokerId 为0代表 Master， 大于0表示Slave。 BrokerLivelnfo中的lastUpdateTimestamp 存储上次收到 Broker 心跳包的时间</p></blockquote><h4 id=22-路由注册>2.2 路由注册</h4><p>路由注册的步骤：</p><ul><li><strong>Broker发送心跳包</strong><ul><li>Header<ul><li>Broker地址</li><li>BrokerId, 0:Master; 大于0:slave</li><li>Broker名称</li><li>集群名称</li><li>master地址，初次请求时为空，slave向NameServer注册后返回</li></ul></li><li>Body<ul><li>消息过滤服务器列表</li><li>主题的配置</li></ul></li></ul></li><li><strong>NameServer 心跳包处理</strong><ul><li>路由 注册需要加写锁 ，防止并发修改 RoutelnfoManager 中的路由 表 。Broker 所属 集群是否存在， 如果不存在，则创 建，然 后将 broker 名加入到集群Broker集合中</li><li>维护 BrokerData信息。</li><li>如果Broker为Master，并且BrokerTopic配置信息发生变化或者是初次注册，则需要创建或更新 Topic路由元数据，填充 topicQueueTable， 其实就是为默认主题自动注册路由信息，其中包含 MixAII.DEFAULT TOPIC 的路由信息。 当消息生产者发送主题时，如果该主题未创建并且BrokerConfig 的autoCreateTopicEnable为true时， 将返回MixAII.DEFAULT TOPIC的路由信息。</li><li>更新 BrokerLivelnfo，存活 Broker信息表， BrokeLivelnfo是执行路由删除的重要依据</li><li>注册 Broker 的过滤器 Server地址列表 ，一个 Broker上会关联多个 FilterServer消息过滤服务器</li></ul></li></ul><blockquote><p>NameServer和Broker保持长连接，Broker状态存储在brokerLiveTable中，NameServer收到每一个心跳包将更新brokerLiveTable中关于Broker的状态信息以及路由表(topicQueueTable、brokerAddrTable、
brokerLiveTable、filterServerTable)</p></blockquote><h4 id=23-路由删除>2.3 路由删除</h4><p>对于Broker来说每隔30秒想NameServer发送一个心跳包来维持Broker在NameServer中的状态。</p><p>对于NameServer来说会每隔10秒扫描一次brokerLiveTable状态表，如果发现Broker的lastUpdateTimestamp的时间戳距当前超过120S，这样认为Broker已经失效，移除Broker,关闭与Broker的连接。同时更新对应的信息。</p><p><strong>触发路由删除：</strong></p><ul><li><strong>NameServer定时扫描 brokerLiveTable检测上次心跳包与 当前系统时间的时间差如果时间戳大于 120s，则需要移除该 Broker 信息 。</strong></li><li><strong>Broker在正常被关闭的情况下，会执行 unregisterBroker指令。</strong></li></ul><h4 id=24-路由发现>2.4 路由发现</h4><p>RocketMQ 路由发现是非实时的，NameServer不会主动推送给客户端。而是由客户端定时拉去主题最新的路由。</p><h3 id=3-总结>3. 总结</h3><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/NameServer%E8%B7%AF%E7%94%B1%E6%B3%A8%E5%86%8C%E5%88%A0%E9%99%A4%E5%8F%91%E7%8E%B0%E6%9C%BA%E5%88%B6.jpg?raw=true" alt=图解></p><p>NameServer路由发现与删除机制就介绍到这里了，我们会发现这种设计会存在这样一种情况: NameServer需要等 Broker失效至少 120s才能将该 Broker从路由表中移除掉，那如果在 Broker故障期间，消息生产者 Producer根据主题获取到的路由信息包含已经看机的Broker，会导致消息发送失败，那这种情况 怎么办。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-80e16469ef810b0280a6f4324ac46db3>6.2 - RocketMQ源码解析-NameServer启动</h1><blockquote><p>以下源码基于Rocket MQ 4.7.0</p></blockquote><h3 id=1-nameserver>1. NameServer</h3><p>NameServer是一个非常简单的Topic路由注册中心，其角色类似Dubbo中的zookeeper，支持Broker的动态注册与发现。主要包括两个功能：</p><ul><li>Broker管理，NameServer接受Broker集群的注册信息并且保存下来作为路由信息的基本数据。然后提供心跳检测机制，检查Broker是否还存活(代码中通过定时扫描BrokerLiveInfo的信息来管理)；</li><li>路由信息管理，每个NameServer将保存关于Broker集群的整个路由信息和用于客户端查询的队列信息。然后Producer和Conumser通过NameServer就可以知道整个Broker集群的路由信息，从而进行消息的投递和消费。</li></ul><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/NameServer%E7%9A%84%E5%8A%9F%E8%83%BD.png?raw=true" alt></p><p>NameServer通常也是集群的方式部署，各实例间相互不进行信息通讯。Broker是向每一台NameServer注册自己的路由信息，所以每一个NameServer实例上面都保存一份完整的路由信息。当某个NameServer因某种原因下线了，Broker仍然可以向其它NameServer同步其路由信息，Producer,Consumer仍然可以动态感知Broker的路由的信息。</p><blockquote><p>NameServer各个实例之间互不通讯</p></blockquote><h3 id=2-源码分析>2. 源码分析</h3><h4 id=21-remoting通信类结构>2.1 Remoting通信类结构</h4><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/RemotingService.png?raw=true" alt></p><h4 id=22-nameserver-启动>2.2 NameServer 启动</h4><p><strong>org.apache.rocketmq.namesrv.NamesrvStartup</strong> 是NameServer的启动类</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>main0</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

     <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>NamesrvController</span> <span style=color:#000>main0</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>NamesrvController</span> <span style=color:#000>controller</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createNamesrvController</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>controller</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>String</span> <span style=color:#000>tip</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;The Name Server boot success. serializeType=&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>RemotingCommand</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSerializeTypeConfigInThisServer</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tip</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;%s%n&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>tip</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>controller</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>exit</span><span style=color:#ce5c00;font-weight:700>(-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过 <strong><code>createNamesrvController</code></strong> 创建 <strong><code>NamesrvController</code></strong></p><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/createNamesrvController.png?raw=true" alt></p><p>NameServer 启动时首先判断是否传入了命令行参数。从代码可以看到有两个参数：</p><ul><li>-c可以指定 NameServer 的配置文件，如果不指定，则使用默认值</li><li>-p 打印 NameServer 的配置参数信息。打印完参数后退出进程</li></ul><p>下面就是打印的配置参数</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>22:06:51.794 <span style=color:#ce5c00;font-weight:700>[</span>main<span style=color:#ce5c00;font-weight:700>]</span> INFO  RocketmqNamesrvConsole - <span style=color:#000>rocketmqHome</span><span style=color:#ce5c00;font-weight:700>=</span>D:<span style=color:#4e9a06>\d</span>ev<span style=color:#4e9a06>\g</span>itproject<span style=color:#4e9a06>\r</span>ocketmq<span style=color:#4e9a06>\d</span>istribution
22:06:51.857 <span style=color:#ce5c00;font-weight:700>[</span>main<span style=color:#ce5c00;font-weight:700>]</span> INFO  RocketmqNamesrvConsole - <span style=color:#000>kvConfigPath</span><span style=color:#ce5c00;font-weight:700>=</span>C:<span style=color:#4e9a06>\U</span>sers<span style=color:#4e9a06>\m</span>xsm<span style=color:#4e9a06>\n</span>amesrv<span style=color:#4e9a06>\k</span>vConfig.json
22:06:51.858 <span style=color:#ce5c00;font-weight:700>[</span>main<span style=color:#ce5c00;font-weight:700>]</span> INFO  RocketmqNamesrvConsole - <span style=color:#000>configStorePath</span><span style=color:#ce5c00;font-weight:700>=</span>C:<span style=color:#4e9a06>\U</span>sers<span style=color:#4e9a06>\m</span>xsm<span style=color:#4e9a06>\n</span>amesrv<span style=color:#4e9a06>\n</span>amesrv.properties
22:06:51.858 <span style=color:#ce5c00;font-weight:700>[</span>main<span style=color:#ce5c00;font-weight:700>]</span> INFO  RocketmqNamesrvConsole - <span style=color:#000>productEnvName</span><span style=color:#ce5c00;font-weight:700>=</span>center
22:06:51.859 <span style=color:#ce5c00;font-weight:700>[</span>main<span style=color:#ce5c00;font-weight:700>]</span> INFO  RocketmqNamesrvConsole - <span style=color:#000>clusterTest</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>
22:06:51.859 <span style=color:#ce5c00;font-weight:700>[</span>main<span style=color:#ce5c00;font-weight:700>]</span> INFO  RocketmqNamesrvConsole - <span style=color:#000>orderMessageEnable</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>
22:06:51.860 <span style=color:#ce5c00;font-weight:700>[</span>main<span style=color:#ce5c00;font-weight:700>]</span> INFO  RocketmqNamesrvConsole - <span style=color:#000>listenPort</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>9876</span>
22:06:51.862 <span style=color:#ce5c00;font-weight:700>[</span>main<span style=color:#ce5c00;font-weight:700>]</span> INFO  RocketmqNamesrvConsole - <span style=color:#000>serverWorkerThreads</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>8</span>
22:06:51.864 <span style=color:#ce5c00;font-weight:700>[</span>main<span style=color:#ce5c00;font-weight:700>]</span> INFO  RocketmqNamesrvConsole - <span style=color:#000>serverCallbackExecutorThreads</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span>
22:06:51.864 <span style=color:#ce5c00;font-weight:700>[</span>main<span style=color:#ce5c00;font-weight:700>]</span> INFO  RocketmqNamesrvConsole - <span style=color:#000>serverSelectorThreads</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>3</span>
22:06:51.864 <span style=color:#ce5c00;font-weight:700>[</span>main<span style=color:#ce5c00;font-weight:700>]</span> INFO  RocketmqNamesrvConsole - <span style=color:#000>serverOnewaySemaphoreValue</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>256</span>
22:06:51.865 <span style=color:#ce5c00;font-weight:700>[</span>main<span style=color:#ce5c00;font-weight:700>]</span> INFO  RocketmqNamesrvConsole - <span style=color:#000>serverAsyncSemaphoreValue</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>64</span>
22:06:51.865 <span style=color:#ce5c00;font-weight:700>[</span>main<span style=color:#ce5c00;font-weight:700>]</span> INFO  RocketmqNamesrvConsole - <span style=color:#000>serverChannelMaxIdleTimeSeconds</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>120</span>
22:06:51.865 <span style=color:#ce5c00;font-weight:700>[</span>main<span style=color:#ce5c00;font-weight:700>]</span> INFO  RocketmqNamesrvConsole - <span style=color:#000>serverSocketSndBufSize</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>65535</span>
22:06:51.865 <span style=color:#ce5c00;font-weight:700>[</span>main<span style=color:#ce5c00;font-weight:700>]</span> INFO  RocketmqNamesrvConsole - <span style=color:#000>serverSocketRcvBufSize</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>65535</span>
22:06:51.865 <span style=color:#ce5c00;font-weight:700>[</span>main<span style=color:#ce5c00;font-weight:700>]</span> INFO  RocketmqNamesrvConsole - <span style=color:#000>serverPooledByteBufAllocatorEnable</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
22:06:51.865 <span style=color:#ce5c00;font-weight:700>[</span>main<span style=color:#ce5c00;font-weight:700>]</span> INFO  RocketmqNamesrvConsole - <span style=color:#000>useEpollNativeSelector</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>
</code></pre></div><p>下面的代码就是在 <strong><code>createNamesrvController</code></strong> 中创建 <strong><code>NamesrvController</code></strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>NamesrvController</span> <span style=color:#000>controller</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NamesrvController</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>namesrvConfig</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nettyServerConfig</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#8f5902;font-style:italic>// remember all configs to prevent discard
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>controller</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConfiguration</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>registerConfig</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><h4 id=23-namesrvcontroller初始化>2.3 NamesrvController初始化</h4><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/NamesrvControllerStart.png?raw=true" alt></p><p><strong><code>NamesrvStartup.start</code></strong> 主要初始化NamesrvController和启动</p><ol><li>调用NamesrvController.initialize方法初始化</li><li>调用NamesrvController.start方法启动</li></ol><blockquote><p>在上图的代码中可以看到还注册了Hook，如果使用kill -9 的方式杀死进程就不会执行Hook中的代码</p></blockquote><h4 id=24-namesrvcontrollerinitialize>2.4 NamesrvController.initialize</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>initialize</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>//从${user.home}/namesrv/kvConfig.json加载配置NameServer的配置
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>kvConfigManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>load</span><span style=color:#ce5c00;font-weight:700>();</span>  <span style=color:#8f5902;font-style:italic>//1
</span><span style=color:#8f5902;font-style:italic></span>		
        <span style=color:#8f5902;font-style:italic>//创建Netty Server
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remotingServer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NettyRemotingServer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nettyServerConfig</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerHousekeepingService</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//2
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#8f5902;font-style:italic>//创建一个固定线程池
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remotingExecutor</span> <span style=color:#ce5c00;font-weight:700>=</span>
            <span style=color:#000>Executors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newFixedThreadPool</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nettyServerConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getServerWorkerThreads</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ThreadFactoryImpl</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;RemotingExecutorThread_&#34;</span><span style=color:#ce5c00;font-weight:700>));</span><span style=color:#8f5902;font-style:italic>//3
</span><span style=color:#8f5902;font-style:italic></span>        
		<span style=color:#8f5902;font-style:italic>////注册NameServer服务接受请求的处理类
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerProcessor</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//4
</span><span style=color:#8f5902;font-style:italic></span>		
        <span style=color:#8f5902;font-style:italic>//定时清理失效的Broker
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scheduledExecutorService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scheduleAtFixedRate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>

            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>NamesrvController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>routeInfoManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scanNotActiveBroker</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SECONDS</span><span style=color:#ce5c00;font-weight:700>);</span>  <span style=color:#8f5902;font-style:italic>//5
</span><span style=color:#8f5902;font-style:italic></span>
        <span style=color:#8f5902;font-style:italic>//定时打印NameServer配置
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scheduledExecutorService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scheduleAtFixedRate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>

            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>NamesrvController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>kvConfigManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printAllPeriodically</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MINUTES</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//6
</span><span style=color:#8f5902;font-style:italic></span>
        <span style=color:#8f5902;font-style:italic>//7
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TlsSystemConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>tlsMode</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>TlsMode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DISABLED</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>//................
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ol><li><p>从${user.home}/namesrv/kvConfig.json加载配置NameServer的配置</p></li><li><p>创建NettyServer来提供服务</p></li><li><p>创建NettyServer执行使用的线程池</p></li><li><p>给NettyServer注入请求处理器</p></li><li><p>创建一个定时清理超时的 Broker 定时任务</p><p>每十秒钟扫描一下Broker的窗台，删除2分钟没有更新状态的Broker,关闭对应的Netty的Channel</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>scanNotActiveBroker</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Iterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BrokerLiveInfo</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>it</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerLiveTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>entrySet</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>iterator</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>it</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasNext</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BrokerLiveInfo</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>it</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>last</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getLastUpdateTimestamp</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>last</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>BROKER_CHANNEL_EXPIRED_TIME</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>//关闭Channel
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>RemotingUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>closeChannel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getChannel</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#000>it</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The broker channel expired, {} {}ms&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getKey</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>BROKER_CHANNEL_EXPIRED_TIME</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>onChannelDestroy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getKey</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getChannel</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li><li><p>创建一个打印 NameServer 配置的定时任务</p><p>每隔10分钟打印一次NameServer的配置参数。即KVConfigManager.configTable变量的内容。</p></li><li><p>SSL的启用</p></li></ol><h4 id=25-namesrvcontrollerregisterprocessor>2.5 NamesrvController.registerProcessor</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//注册接收请求的类
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerProcessor</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>namesrvConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isClusterTest</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>

            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remotingServer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerDefaultProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClusterTestRequestProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>namesrvConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProductEnvName</span><span style=color:#ce5c00;font-weight:700>()),</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remotingExecutor</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>

            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remotingServer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerDefaultProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DefaultRequestProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remotingExecutor</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>默认注入的请求类 <strong><code>DefaultRequestProcessor</code></strong> 。</p><h4 id=26-defaultrequestprocessor>2.6 DefaultRequestProcessor</h4><p>通过 <strong><code>DefaultRequestProcessor.processRequest</code></strong> 方法来处理客户端的请求。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>RemotingCommand</span> <span style=color:#000>processRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ChannelHandlerContext</span> <span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>RemotingCommand</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>RemotingCommandException</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#8f5902;font-style:italic>//打印请求的信息
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;receive request, {} {} {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCode</span><span style=color:#ce5c00;font-weight:700>(),</span>
                <span style=color:#000>RemotingHelper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseChannelRemoteAddr</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>channel</span><span style=color:#ce5c00;font-weight:700>()),</span>
                <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>switch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCode</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PUT_KV_CONFIG</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putKVConfig</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET_KV_CONFIG</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getKVConfig</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DELETE_KV_CONFIG</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>deleteKVConfig</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>QUERY_DATA_VERSION</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>queryBrokerTopicConfig</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>REGISTER_BROKER</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#000>Version</span> <span style=color:#000>brokerVersion</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MQVersion</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value2Version</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getVersion</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>brokerVersion</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ordinal</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>MQVersion</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Version</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>V3_0_11</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ordinal</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerBrokerWithFilterServer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerBroker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>UNREGISTER_BROKER</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unregisterBroker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET_ROUTEINTO_BY_TOPIC</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRouteInfoByTopic</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET_BROKER_CLUSTER_INFO</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerClusterInfo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>WIPE_WRITE_PERM_OF_BROKER</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wipeWritePermOfBroker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET_ALL_TOPIC_LIST_FROM_NAMESERVER</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getAllTopicListFromNameserver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DELETE_TOPIC_IN_NAMESRV</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>deleteTopicInNamesrv</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET_KVLIST_BY_NAMESPACE</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getKVListByNamespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET_TOPICS_BY_CLUSTER</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopicsByCluster</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET_SYSTEM_TOPIC_LIST_FROM_NS</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSystemTopicListFromNs</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET_UNIT_TOPIC_LIST</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUnitTopicList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET_HAS_UNIT_SUB_TOPIC_LIST</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getHasUnitSubTopicList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET_HAS_UNIT_SUB_UNUNIT_TOPIC_LIST</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getHasUnitSubUnUnitTopicList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>UPDATE_NAMESRV_CONFIG</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>updateConfig</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET_NAMESRV_CONFIG</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConfig</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>default</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>所有的请求类型定义在 <strong>RequestCode</strong> 中：</p><table><thead><tr><th>RequestCode</th><th>说明</th></tr></thead><tbody><tr><td>PUT_KV_CONFIG</td><td>向Namesrv追加KV配置</td></tr><tr><td>GET_KV_CONFIG</td><td>从Namesrv获取KV配置</td></tr><tr><td>DELETE_KV_CONFIG</td><td>从Namesrv获取KV配置</td></tr><tr><td>QUERY_DATA_VERSION</td><td>获取版本信息</td></tr><tr><td>REGISTER_BROKER</td><td>注册一个Broker，数据都是持久化的，如果存在则覆盖配置</td></tr><tr><td>UNREGISTER_BROKER</td><td>卸载一个Broker，数据都是持久化的</td></tr><tr><td>GET_ROUTEINTO_BY_TOPIC</td><td>根据Topic获取Broker Name、topic配置信息</td></tr><tr><td>GET_BROKER_CLUSTER_INFO</td><td>获取注册到Name Server的所有Broker集群信息-客户端获取</td></tr><tr><td>WIPE_WRITE_PERM_OF_BROKER</td><td>去掉BrokerName的写权限</td></tr><tr><td>GET_ALL_TOPIC_LIST_FROM_NAMESERVER</td><td>从Name Server获取完整Topic列表</td></tr><tr><td>DELETE_TOPIC_IN_NAMESRV</td><td>从Namesrv删除Topic配置</td></tr><tr><td>GET_KVLIST_BY_NAMESPACE</td><td>通过NameSpace获取所有的KV List</td></tr><tr><td>GET_TOPICS_BY_CLUSTER</td><td>获取指定集群下的所有 topic</td></tr><tr><td>GET_SYSTEM_TOPIC_LIST_FROM_NS</td><td>获取所有系统内置 Topic 列表</td></tr><tr><td>GET_UNIT_TOPIC_LIST</td><td>单元化相关 topic</td></tr><tr><td>GET_HAS_UNIT_SUB_TOPIC_LIST</td><td>获取含有单元化订阅组的 Topic 列表</td></tr><tr><td>GET_HAS_UNIT_SUB_UNUNIT_TOPIC_LIST</td><td>获取含有单元化订阅组的非单元化</td></tr><tr><td>UPDATE_NAMESRV_CONFIG</td><td>更新Name Server配置</td></tr><tr><td>GET_NAMESRV_CONFIG</td><td>获取Name Server配置</td></tr></tbody></table><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/RequestCode.png?raw=true" alt></p><blockquote><p>以上RequestCode分为两类：</p><ol><li>路由信息</li><li>NameServer的配置</li></ol></blockquote><h4 id=27-routeinfomanager>2.7 RouteInfoManager</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>RouteInfoManager</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>InternalLogger</span> <span style=color:#000>log</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>InternalLoggerFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLogger</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LoggerName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NAMESRV_LOGGER_NAME</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>BROKER_CHANNEL_EXPIRED_TIME</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1000</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>60</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ReadWriteLock</span> <span style=color:#000>lock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ReentrantReadWriteLock</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#8f5902;font-style:italic>/* topic */</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>QueueData</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>topicQueueTable</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#8f5902;font-style:italic>/* brokerName */</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BrokerData</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>brokerAddrTable</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#8f5902;font-style:italic>/* clusterName */</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#8f5902;font-style:italic>/* brokerName */</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>clusterAddrTable</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#8f5902;font-style:italic>/* brokerAddr */</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BrokerLiveInfo</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>brokerLiveTable</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#8f5902;font-style:italic>/* brokerAddr */</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#8f5902;font-style:italic>/* Filter Server */</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>filterServerTable</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h5 id=topicqueuetable>topicQueueTable</h5><p>key：存储的是topic, value:QueueData的列表。QueueData 的集合 size 等于 Topic 对应的 Broker Master 的个数。下面来看一下QueueData数据结构：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>QueueData</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Comparable</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>QueueData</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>brokerName</span><span style=color:#ce5c00;font-weight:700>;</span>   <span style=color:#8f5902;font-style:italic>//broker 名字
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>readQueueNums</span><span style=color:#ce5c00;font-weight:700>;</span>   <span style=color:#8f5902;font-style:italic>//可读 queue 数
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>writeQueueNums</span><span style=color:#ce5c00;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>//可写 queue 数 
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>perm</span><span style=color:#ce5c00;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>//读写权限
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>topicSynFlag</span><span style=color:#ce5c00;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>//同步标识
</span><span style=color:#8f5902;font-style:italic></span>    
    <span style=color:#8f5902;font-style:italic>//............
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h5 id=brokeraddrtable>brokerAddrTable</h5><p>key：broker的名称</p><p>value: broker的相关信息</p><p>下面来看一下BrokerData数据结构：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BrokerData</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Comparable</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BrokerData</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>cluster</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//集群名称
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>brokerName</span><span style=color:#ce5c00;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>//broker名称
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//brokerId和broker的地址
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Long</span><span style=color:#8f5902;font-style:italic>/* brokerId */</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#8f5902;font-style:italic>/* broker address */</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>brokerAddrs</span><span style=color:#ce5c00;font-weight:700>;</span> 
	
    <span style=color:#8f5902;font-style:italic>//............
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h5 id=clusteraddrtable>clusterAddrTable</h5><p>key存储的是 clusterName 的名称， value 存储的是 brokerName 的集合</p><h5 id=brokerlivetable>brokerLiveTable</h5><p>key 存储的是 brokerAddr(IP:port) 信息，value 存储的是 BrokerLiveInfo 信息，BrokerLiveInfo 中存储了 Broker 的实时状态。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BrokerLiveInfo</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>lastUpdateTimestamp</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//最新更新时间
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>DataVersion</span> <span style=color:#000>dataVersion</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//数据版本
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Channel</span> <span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>haServerAddr</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>NamesrvController.initialize() 中有一个schedule定时任务，每个10秒钟定时调用 scanNotActiveBroker() 方法进行扫描不活动的 Broker，并把不活动的 Broker 删除掉，就是判断的 这个 lastUpdateTimestamp 这个数据。如果超过两分钟没有更新lastUpdateTimestamp这个值。就认为当前这个Broker不可用。</p><h5 id=filterservertable>filterServerTable</h5><p>key 存储的是 brokerAddr 信息，value 存储的是 Filter Server 信息。Filter Server 是消息的过滤服务器，一个 Broker 可以对应多个 Filter Server。</p><h4 id=28-namesrvcontrollerstart>2.8 NamesrvController.start</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//启动监听服务
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remotingServer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fileWatchService</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fileWatchService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=3-总结>3. 总结</h3><p>通过分析启动流程图如下：</p><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/NameServerStartProcess.png?raw=true" alt></p></div><div class=td-content style=page-break-before:always><h1 id=pg-039627ec513fed111ae3e49aaa0ad4d0>6.3 - RocketMQ源码解析-NameServer对Broker的管理</h1><blockquote><p>以下源码基于Rocket MQ 4.8.0</p></blockquote><p>前面的 <a href=https://blog.ljbmxsm.com/middlewares/rocketmq/name-server/rocketmq-analysis-nameserver-start/>RocketMQ源码解析-NameServer启动</a>已经知道NameServer的两大功能：</p><ul><li>Broker管理</li><li>路由管理</li></ul><p>NameServer可以部署多个，相互之间独立，其他角色同时向多个NameServer上报状态信息，从而达到热备份的目的。NameServer本身是无状态的，也就是说NameServer中的Broker、Topic等信息都不会持久化，都是由各个角色定时上报并存储到内存中的（NameServer支持参数的持久化，一般用不到）。</p><p>下面就来结合源码以及项目运行添加打印日志来具体分析一下NameServer是如何对Broker进行管理的。</p><h3 id=1-broker元数据>1. Broker元数据</h3><p>当Broker启动，会向NameServer注册当前broker的信息。在NameServer通过 <strong><code>BrokerData</code></strong> 来保存Broker的元数据信息：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BrokerData</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Comparable</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BrokerData</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>cluster</span><span style=color:#ce5c00;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>//broker集群名称
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>brokerName</span><span style=color:#ce5c00;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>//broker名称
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Long</span><span style=color:#8f5902;font-style:italic>/* brokerId */</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#8f5902;font-style:italic>/* broker address */</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>brokerAddrs</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//broker Id和broker地址的映射关系
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>我们通过打印日志来看一下这个里面的数据具体包含了那些数据，日志添加在 <strong><code>RouteInfoManager#registerBroker</code></strong> 方法中：</p><p><img src="https://github.com/mxsm/picture/blob/main/rocketmq/nameserverborker%E5%85%83%E6%95%B0%E6%8D%AE%E6%B7%BB%E5%8A%A0%E6%97%A5%E5%BF%97.png?raw=true" alt></p><p>添加好后我们配置好broker的配置文件：</p><p><img src="https://github.com/mxsm/picture/blob/main/rocketmq/brokerconfig%E9%85%8D%E7%BD%AE.png?raw=true" alt></p><p>然后首先启动NameServer，再启动broker如下图：</p><p><img src="https://github.com/mxsm/picture/blob/main/rocketmq/brokerdata%E5%85%83%E6%95%B0%E6%8D%AE%E6%89%93%E5%8D%B0%E9%AA%8C%E8%AF%81.gif?raw=true" alt></p><p>打印的元数据如下：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>打印BrokerData元数据信息:<span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;brokerAddrs&#34;</span>:<span style=color:#ce5c00;font-weight:700>{</span>0:<span style=color:#4e9a06>&#34;169.254.144.194:10911&#34;</span><span style=color:#ce5c00;font-weight:700>}</span>,<span style=color:#4e9a06>&#34;brokerName&#34;</span>:<span style=color:#4e9a06>&#34;mxsm-1&#34;</span>,<span style=color:#4e9a06>&#34;cluster&#34;</span>:<span style=color:#4e9a06>&#34;MxsmClusterName&#34;</span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=2-broker存活状态管理>2. Broker存活状态管理</h3><p>Broker的存活状态管理分为两种：</p><ul><li><p><strong>Broker正常下线</strong></p><p>Broker正常下线会给NameServer发送一个 <strong><code>RequestCode.UNREGISTER_BROKER</code></strong> 。然后调用最终调用 <strong><code>RouteInfoManager#unregisterBroker</code></strong> 方法来注销</p></li><li><p><strong>Broker异常下线，NameServer通过定时任务扫描</strong></p><p>定时任务在NameServer启动的时候创建</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scheduledExecutorService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scheduleAtFixedRate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>NamesrvController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>routeInfoManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scanNotActiveBroker</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SECONDS</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>每10秒执行一次。调用 <strong><code>RouteInfoManager#scanNotActiveBroker</code></strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>scanNotActiveBroker</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Iterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BrokerLiveInfo</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>it</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerLiveTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>entrySet</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>iterator</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>it</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasNext</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BrokerLiveInfo</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>it</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>last</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getLastUpdateTimestamp</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>//private final static long BROKER_CHANNEL_EXPIRED_TIME = 1000 * 60 * 2;
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>last</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>BROKER_CHANNEL_EXPIRED_TIME</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>RemotingUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>closeChannel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getChannel</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#000>it</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The broker channel expired, {} {}ms&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getKey</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>BROKER_CHANNEL_EXPIRED_TIME</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>onChannelDestroy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getKey</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getChannel</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过上面的代码可以发现120秒没有更新NameServer中当Broker的状态。后将连接关闭，同时需要清除这些已关闭连接的 broker 的路由信息。这部分则是在<code>onChannelDestroy</code>方法中</p></li></ul><h3 id=3-topic的信息>3. Topic的信息</h3><p>在 <strong><code>RouteInfoManager</code></strong> 类中有一个变量 <strong><code>topicQueueTable</code></strong> 这个变量用来保存Topic和Broker之间的读写队列数和权限。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#8f5902;font-style:italic>/* topic */</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>QueueData</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>topicQueueTable</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>QueueData</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Comparable</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>QueueData</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//broker名称
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>brokerName</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>//读的队列数
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>readQueueNums</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>//写的队列数
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>writeQueueNums</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>//读写权限
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>perm</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>topicSynFlag</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-82fe895728c3c692794542d870b4e2b3>7 - RocketMQ Broker</h1><p>Broker主要负责消息的存储、投递和查询以及服务高可用保证，为了实现这些功能，Broker包含了以下几个重要子模块:</p><ul><li><strong>Remoting Module</strong> ：整个Broker的实体，负责处理来自clients端的请求</li><li><strong>Client Manager</strong>：负责管理客户端(Producer/Consumer)和维护Consumer的Topic订阅信息</li><li><strong>Store Service</strong> ：提供方便简单的API接口处理消息存储到物理硬盘和查询功能</li><li><strong>HA Service</strong> ：高可用服务，提供Master Broker 和 Slave Broker之间的数据同步功能</li><li><strong>Index Service</strong> ：根据特定的Message key对投递到Broker的消息进行索引服务，以提供消息的快速查询</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-509eb51b6081d849ed4c61b8e6620a26>7.1 - RocketMQ源码解析-Broker启动</h1><blockquote><p>以下源码基于Rocket MQ 4.7.0</p></blockquote><h3 id=1-broker>1. Broker</h3><p>消息中转角色，负责存储消息、转发消息。Broker在RocketMQ系统中负责接收从生产者发送来的消息并存储、同时为消费者的拉取请求作准备。代理服务器也存储消息相关的元数据，包括消费者组、消费进度偏移和主题和队列消息等。</p><h3 id=2-broker作用>2. Broker作用</h3><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/Broker%E5%8A%9F%E8%83%BD%E5%88%97%E8%A1%A8%E5%9B%BE.png?raw=true" alt></p><p>主要四个作用：</p><ul><li>消息存储</li><li>消息投递</li><li>消息查询</li><li>服务的高可用</li></ul><p>这四个功能由五个模块来实现。</p><h3 id=3-broker启动流程分析>3. Broker启动流程分析</h3><p>总体的启动流程和NameServer的启动流程差不多但是比NameServer的启动流程复杂：</p><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/BrokerControllerFlowchart.png?raw=true" alt></p><p>这个流程大致分为以下的几个步骤：</p><ol><li><strong>BrokerController创建</strong><ul><li>NettyServer和NettyClient的配置处理</li><li>命令行参数的处理</li><li>Broker角色的处理</li><li>创建BrokerController</li><li>初始化BrokerController通过调用方法</li></ul></li><li><strong>BrokerController启动</strong></li></ol><h3 id=4-brokercontroller创建>4. BrokerController创建</h3><p><strong><code>BrokerStartUp.createBrokerController</code></strong> 调用方法创建</p><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/%E8%AE%BE%E7%BD%AE%E5%8F%91%E9%80%81%E5%8C%BA%E6%8E%A5%E6%94%B6%E5%8C%BA%E7%9A%84%E7%BC%93%E5%AD%98.png?raw=true" alt></p><p>上图是设置Netty的发送和接收缓冲区的大小。</p><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/Broker%E8%A7%92%E8%89%B2%E5%A4%84%E7%90%86.png?raw=true" alt></p><p>上图主要是处理在集群条件小的Broker角色的，从这里看出来brokerId为0的为Mater节点，其他的为Slave节点。</p><blockquote><p>角色类型：SYNC_MASTER/ASYNC_MASTER/SLAVE 默认为ASYNC_MASTER，</p><p>官方文档：https://rocketmq.apache.org/docs/rmq-deployment/</p></blockquote><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%82%E6%95%B0%E5%A4%84%E7%90%86.png?raw=true" alt></p><p>上图是处理命令行参数</p><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/%E5%88%9D%E5%A7%8B%E5%8C%96BrokerController.png?raw=true" alt></p><p>初始化BrokerController。然后返回controller。</p><h3 id=5-brokercontroller启动>5. BrokerController启动</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>BrokerController</span> <span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BrokerController</span> <span style=color:#000>controller</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>

            <span style=color:#000>controller</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#000>String</span> <span style=color:#000>tip</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;The broker[&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>controller</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getBrokerName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;, &#34;</span>
                <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>controller</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerAddr</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;] boot success. serializeType=&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>RemotingCommand</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSerializeTypeConfigInThisServer</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>controller</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getNamesrvAddr</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>tip</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#4e9a06>&#34; and name server is &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>controller</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getNamesrvAddr</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tip</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;%s%n&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>tip</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>controller</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>exit</span><span style=color:#ce5c00;font-weight:700>(-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div><p>启动比较简单，调用start方法。</p><h3 id=6-broker配置>6. Broker配置</h3><table><thead><tr><th style=text-align:left>Property Name</th><th style=text-align:center>Default value</th><th style=text-align:right>Details</th></tr></thead><tbody><tr><td style=text-align:left>listenPort</td><td style=text-align:center>10911</td><td style=text-align:right>listen port for client</td></tr><tr><td style=text-align:left>namesrvAddr</td><td style=text-align:center>null</td><td style=text-align:right>name server address</td></tr><tr><td style=text-align:left>brokerIP1</td><td style=text-align:center>InetAddress for network interface</td><td style=text-align:right>Should be configured if having multiple addresses</td></tr><tr><td style=text-align:left>brokerName</td><td style=text-align:center>null</td><td style=text-align:right>broker name</td></tr><tr><td style=text-align:left>brokerClusterName</td><td style=text-align:center>DefaultCluster</td><td style=text-align:right>this broker belongs to which cluster</td></tr><tr><td style=text-align:left>brokerId</td><td style=text-align:center>0</td><td style=text-align:right>broker id, 0 means master, positive integers mean slave</td></tr><tr><td style=text-align:left>storePathCommitLog</td><td style=text-align:center>$HOME/store/commitlog/</td><td style=text-align:right>file path for commit log</td></tr><tr><td style=text-align:left>storePathConsumerQueue</td><td style=text-align:center>$HOME/store/consumequeue/</td><td style=text-align:right>file path for consume queue</td></tr><tr><td style=text-align:left>mapedFileSizeCommitLog</td><td style=text-align:center>1024 * 1024 * 1024(1G)</td><td style=text-align:right>mapped file size for commit log</td></tr><tr><td style=text-align:left>deleteWhen</td><td style=text-align:center>04</td><td style=text-align:right>When to delete the commitlog which is out of the reserve time</td></tr><tr><td style=text-align:left>fileReserverdTime</td><td style=text-align:center>72</td><td style=text-align:right>The number of hours to keep a commitlog before deleting it</td></tr><tr><td style=text-align:left>brokerRole</td><td style=text-align:center>ASYNC_MASTER</td><td style=text-align:right>SYNC_MASTER/ASYNC_MASTER/SLAVE</td></tr><tr><td style=text-align:left>flushDiskType</td><td style=text-align:center>ASYNC_FLUSH</td><td style=text-align:right>{SYNC_FLUSH/ASYNC_FLUSH}. Broker of SYNC_FLUSH mode flushes each message onto disk before acknowledging producer. Broker of ASYNC_FLUSH mode, on the other hand, takes advantage of group-committing, achieving better performance.</td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-cdaf32cb67db0031ee4184b758640ac6>7.2 - RocketMQ源码解析-Broker与NameServer交互</h1><blockquote><p>以下源码基于Rocket MQ 4.7.0</p></blockquote><h3 id=1-broker与nameserver的交互>1. Broker与NameServer的交互</h3><p>Broker启动，跟所有的NameServer保持长连接，定时发送心跳包。心跳包中包含当前Broker信息(IP+端口等)以及存储所有Topic信息。注册成功后，NameServer集群中就有Topic跟Broker的映射关系。</p><blockquote><p>Broker会连接配置在配置文件中的所有NameServer。以同步(sync)通讯的方式和NameServer进行通讯。</p><p>通讯方式：</p><ul><li>同步(sync)</li><li>异步(async)</li><li>单向(oneway)</li></ul></blockquote><h3 id=2-客户端的创建>2. 客户端的创建</h3><p>Broker与NameServer进行数据交互主要是通过一个叫做 <strong><code>BrokerOuterAPI</code></strong> 的类来进行的。那么这个类的实例对象在哪里没创建又在哪里被引用来处理和NameServer的数据交互。</p><p>首先来看一下在哪里创建：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BrokerController</span><span style=color:#ce5c00;font-weight:700>(</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>BrokerConfig</span> <span style=color:#000>brokerConfig</span><span style=color:#ce5c00;font-weight:700>,</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>NettyServerConfig</span> <span style=color:#000>nettyServerConfig</span><span style=color:#ce5c00;font-weight:700>,</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>NettyClientConfig</span> <span style=color:#000>nettyClientConfig</span><span style=color:#ce5c00;font-weight:700>,</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MessageStoreConfig</span> <span style=color:#000>messageStoreConfig</span>
<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
<span style=color:#8f5902;font-style:italic>//.....
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerOuterAPI</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BrokerOuterAPI</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nettyClientConfig</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>//.....
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面这段代码是在BrokerController的构造函数里面，没错就在创建BrokerController的时候会在构造函数里面创建BrokerOuterAPI这个类。</p><p>接下来看一下这个类在哪里被引用了。首先我们来看一下在BrokerController创建好了以后，最后调用BrokerController.start方法来启动Controller。在启动代码中有这样一段。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//BrokerController.start方法中的一段代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scheduledExecutorService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scheduleAtFixedRate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>BrokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerBrokerAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>brokerConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isForceRegister</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;registerBrokerAll Exception&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>1000</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>max</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>10000</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>min</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>brokerConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRegisterNameServerPeriod</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>60000</span><span style=color:#ce5c00;font-weight:700>)),</span> <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MILLISECONDS</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>从上面的代码可以看出来是一个以以固定频率执行的定时器，这个定时器执行了BrokerController.registerBrokerAll 方法。</p><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/registerBrokerAll.png?raw=true" alt></p><ol><li>构造一些Broker topic的信息</li><li>Broker的元数据信息</li></ol><p>通过 <strong><code>BrokerController.doRegisterBrokerAll</code></strong> 私有方法来处理数据。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>doRegisterBrokerAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>checkOrderConfig</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>oneway</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>TopicConfigSerializeWrapper</span> <span style=color:#000>topicConfigWrapper</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//通过brokerOuterAPI注册Broker的信息到NameServer
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>RegisterBrokerResult</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>registerBrokerResultList</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerOuterAPI</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerBrokerAll</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerClusterName</span><span style=color:#ce5c00;font-weight:700>(),</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerAddr</span><span style=color:#ce5c00;font-weight:700>(),</span>  <span style=color:#8f5902;font-style:italic>//IP:Port
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerName</span><span style=color:#ce5c00;font-weight:700>(),</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerId</span><span style=color:#ce5c00;font-weight:700>(),</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getHAServerAddr</span><span style=color:#ce5c00;font-weight:700>(),</span>
            <span style=color:#000>topicConfigWrapper</span><span style=color:#ce5c00;font-weight:700>,</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>filterServerManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>buildNewFilterServerList</span><span style=color:#ce5c00;font-weight:700>(),</span>
            <span style=color:#000>oneway</span><span style=color:#ce5c00;font-weight:700>,</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRegisterBrokerTimeoutMills</span><span style=color:#ce5c00;font-weight:700>(),</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isCompressedRegister</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#8f5902;font-style:italic>//注册结果返回处理
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registerBrokerResultList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>RegisterBrokerResult</span> <span style=color:#000>registerBrokerResult</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>registerBrokerResultList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registerBrokerResult</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>updateMasterHAServerAddrPeriodically</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>registerBrokerResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getHaServerAddr</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>updateHaMasterAddress</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registerBrokerResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getHaServerAddr</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#ce5c00;font-weight:700>}</span>

                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>slaveSynchronize</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setMasterAddr</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registerBrokerResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMasterAddr</span><span style=color:#ce5c00;font-weight:700>());</span>

                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>checkOrderConfig</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopicConfigManager</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>updateOrderTopicConfig</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registerBrokerResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getKvTable</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=3-broker端数据的处理>3. Broker端数据的处理</h3><p>Broker和NameServer的数据处理通过上面可以知道主要是通过 <strong><code>BrokerOuterAPI.registerBrokerAll</code></strong> 处理。首先通过获取配置在Broker配置文件中的namesrvAddr。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>nameServerAddressList</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remotingClient</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNameServerAddressList</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div><p>然后构建 <strong><code>RegisterBrokerRequestHeader</code></strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>RegisterBrokerRequestHeader</span> <span style=color:#000>requestHeader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RegisterBrokerRequestHeader</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBrokerAddr</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>brokerAddr</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//broker地址 IP:Port
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBrokerId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>brokerId</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// broker id 
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBrokerName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>brokerName</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// broker名称
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setClusterName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clusterName</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// 集群名称
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setHaServerAddr</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>haServerAddr</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// haServer地址
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCompressed</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>compressed</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// 是否压缩
</span></code></pre></div><p>构造 <strong><code>RegisterBrokerBody</code></strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>            <span style=color:#000>RegisterBrokerBody</span> <span style=color:#000>requestBody</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RegisterBrokerBody</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>requestBody</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTopicConfigSerializeWrapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topicConfigWrapper</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>requestBody</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setFilterServerList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>filterServerList</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>body</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>requestBody</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>encode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>compressed</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>bodyCrc32</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>UtilAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>crc32</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>body</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBodyCrc32</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bodyCrc32</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>然后就是发送数据到NameServer</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>CountDownLatch</span> <span style=color:#000>countDownLatch</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CountDownLatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nameServerAddressList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>namesrvAddr</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>nameServerAddressList</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>brokerOuterExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>execute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#5c35cc;font-weight:700>@Override</span>
                    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#8f5902;font-style:italic>//注册Broker发送数据
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#000>RegisterBrokerResult</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>registerBroker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>namesrvAddr</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>oneway</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>timeoutMills</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>body</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#000>registerBrokerResultList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>

                            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;register broker[{}]to name server {} OK&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>brokerId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>namesrvAddr</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;registerBroker Exception, {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>namesrvAddr</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>countDownLatch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>countDown</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>});</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>countDownLatch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>await</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timeoutMills</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MILLISECONDS</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过调用 <strong><code>BrokerOuterAPI.registerBroker</code></strong> 方法来注册Broker。</p><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/registerBroker.png?raw=true" alt></p><ol><li>单向通讯</li><li>同步通讯</li></ol><p>通过上面可以看到请求的代码是 <strong><code>RequestCode.REGISTER_BROKER</code></strong> 。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-1d71c5af06e2352a2297be5b774c9efe>7.3 - RocketMQ源码解析-Broker消息存储设计与实现</h1><blockquote><p>以下源码基于Rocket MQ 4.7.0</p></blockquote><h3 id=1-消息存储图解>1. 消息存储图解</h3><p><img src=https://github.com/apache/rocketmq/raw/master/docs/cn/image/rocketmq_design_1.png alt=官网图></p><p>消息存储是RocketMQ中最为复杂和最为重要的一部分，本节将分别从RocketMQ的消息存储整体架构、PageCache与Mmap内存映射以及RocketMQ中两种不同的刷盘方式三方面来分别展开叙述。</p><ul><li><strong>消息存储整体架构</strong></li><li><strong>页缓存与内存映射</strong></li><li><strong>消息刷盘</strong></li></ul><h3 id=2-消息存储整体架构>2. 消息存储整体架构</h3><p>跟消息存储的主要有三个相关的文件组成：</p><ul><li><p><strong>CommitLog</strong></p><p>消息主体以及元数据的存储主体，存储Producer端写入的消息主体内容,消息内容不是定长的。单个文件大小默认1G ，文件名长度为20位，左边补零，剩余为起始偏移量，比如00000000000000000000代表了第一个文件，起始偏移量为0，文件大小为1G=1073741824；当第一个文件写满了，第二个文件为00000000001073741824，起始偏移量为1073741824，以此类推。消息主要是顺序写入日志文件，当文件满了，写入下一个文件:</p><p><img src="https://github.com/mxsm/picture/blob/main/rocketmq/commitlog%E4%BD%8D%E7%BD%AE.png?raw=true" alt></p></li><li><p><strong>ConsumeQueue</strong></p><p>消息消费队列，引入的目的主要是提高消息消费的性能，由于RocketMQ是基于主题topic的订阅模式，消息消费是针对主题进行的，如果要遍历commitlog文件中根据topic检索消息是非常低效的。Consumer即可根据ConsumeQueue来查找待消费的消息。其中，ConsumeQueue（逻辑消费队列）作为消费消息的索引，保存了指定Topic下的队列消息在CommitLog中的起始物理偏移量offset，消息大小size和消息Tag的HashCode值。consumequeue文件可以看成是基于topic的commitlog索引文件，故consumequeue文件夹的组织方式如下：topic/queue/file三层组织结构，具体存储路径为：$HOME/store/consumequeue/{topic}/{queueId}/{fileName}。同样consumequeue文件采取定长设计，每一个条目共20个字节，分别为8字节的commitlog物理偏移量、4字节的消息长度、8字节tag hashcode，单个文件由30W个条目组成，可以像数组一样随机访问每一个条目，每个ConsumeQueue文件大小约5.72M；</p><p><img src="https://github.com/mxsm/picture/blob/main/rocketmq/consumequeue%E4%BD%8D%E7%BD%AE.png?raw=true" alt></p></li><li><p><strong>IndexFile</strong></p><p>IndexFile（索引文件）提供了一种可以通过key或时间区间来查询消息的方法。Index文件的存储位置是：$HOME \store\index${fileName}，文件名fileName是以创建时的<strong>时间戳命名</strong>的，固定的单个IndexFile文件大小约为400M，一个IndexFile可以保存 2000W个索引，IndexFile的底层存储设计为在文件系统中实现HashMap结构，故rocketmq的索引文件其底层实现为hash索引。</p><p><img src="https://github.com/mxsm/picture/blob/main/rocketmq/indexLog.png?raw=true" alt></p></li></ul><p>在上面的RocketMQ的消息存储整体架构图中可以看出，RocketMQ采用的是混合型的存储结构，即为Broker单个实例下所有的队列共用一个日志数据文件（即为CommitLog）来存储。RocketMQ的混合型存储结构(多个Topic的消息实体内容都存储于一个CommitLog中)针对Producer和Consumer分别采用了数据和索引部分相分离的存储结构，Producer发送消息至Broker端，然后Broker端使用同步或者异步的方式对消息刷盘持久化，保存至CommitLog中。只要消息被刷盘持久化至磁盘文件CommitLog中，那么Producer发送的消息就不会丢失。正因为如此，Consumer也就肯定有机会去消费这条消息。当无法拉取到消息后，可以等下一次消息拉取，同时服务端也支持长轮询模式，如果一个消息拉取请求未拉取到消息，Broker允许等待30s的时间，只要这段时间内有新消息到达，将直接返回给消费端。这里，RocketMQ的具体做法是，使用Broker端的后台服务线程—ReputMessageService不停地分发请求并异步构建ConsumeQueue（逻辑消费队列）和IndexFile（索引文件）数据。下面从代码的角度来分析这三个文件的生成。</p><h4 id=21-commitlog>2.1 CommitLog</h4><p>在代码中 <strong>CommitLog</strong> 对应一个 <strong><code>CommitLog</code></strong> 的Java类。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>CommitLog</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 消息的 MAGIC CODE daa320a7
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>MESSAGE_MAGIC_CODE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>626843481</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>InternalLogger</span> <span style=color:#000>log</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>InternalLoggerFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLogger</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LoggerName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>STORE_LOGGER_NAME</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 文件结尾空的 MAGIC CODE cbd43194
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>BLANK_MAGIC_CODE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>875286124</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MappedFileQueue</span> <span style=color:#000>mappedFileQueue</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>DefaultMessageStore</span> <span style=color:#000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>FlushCommitLogService</span> <span style=color:#000>flushCommitLogService</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>FlushCommitLogService</span> <span style=color:#000>commitLogService</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>AppendMessageCallback</span> <span style=color:#000>appendMessageCallback</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ThreadLocal</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageExtBatchEncoder</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>batchEncoderThreadLocal</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#8f5902;font-style:italic>/* topic-queueid */</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Long</span><span style=color:#8f5902;font-style:italic>/* offset */</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>topicQueueTable</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>1024</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>confirmOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1L</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>beginTimeInLock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>//..............
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>RocketMQ 以如下图所示存储格式将消息顺序写入 CommitLog，除了记录消息本身的属性（消息长度、消息体、Topic 长度、Topic、消息属性长度和消息属性），CommitLog 同时记录了消息所在消费队列的信息（消费队列 ID 和偏移量）。由于存储条目具备不定长的特性，当 CommitLog 剩余空间无法满足消息时，CommitLog 在尾部追加一个 MAGIC CODE 等于 BLANK_MAGIC_CODE 的存储条目作为结束标记，并将消息存储至下一个 CommitLog 文件。</p><blockquote><p>BLANK_MAGIC_CODE 的作用就是作为标记当前文件存储CommitLog纪录满了，接下来要用下一个文件存储。</p><p><strong>存储的位置：${user.home}/store/commitlog</strong></p></blockquote><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/CommitLog%E8%AE%B0%E5%BD%95%E6%A0%BC%E5%BC%8F.png?raw=true" alt></p><p>那么我们在代码中哪里可以看出来下面我们可以看一下 <strong><code>CommitLog.calMsgLength</code></strong> 的这个方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>calMsgLength</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>sysFlag</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>bodyLength</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>topicLength</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>propertiesLength</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>bornhostLength</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sysFlag</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>MessageSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>BORNHOST_V6_FLAG</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>8</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>20</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>storehostAddressLength</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sysFlag</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>MessageSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>STOREHOSTADDRESS_V6_FLAG</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>8</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>20</span><span style=color:#ce5c00;font-weight:700>;</span> 
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>msgLen</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>4</span> <span style=color:#8f5902;font-style:italic>//TOTALSIZE
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>4</span> <span style=color:#8f5902;font-style:italic>//MAGICCODE
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>4</span> <span style=color:#8f5902;font-style:italic>//BODYCRC
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>4</span> <span style=color:#8f5902;font-style:italic>//QUEUEID
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>4</span> <span style=color:#8f5902;font-style:italic>//FLAG
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>8</span> <span style=color:#8f5902;font-style:italic>//QUEUEOFFSET
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>8</span> <span style=color:#8f5902;font-style:italic>//PHYSICALOFFSET
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>4</span> <span style=color:#8f5902;font-style:italic>//SYSFLAG
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>8</span> <span style=color:#8f5902;font-style:italic>//BORNTIMESTAMP
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>bornhostLength</span> <span style=color:#8f5902;font-style:italic>//BORNHOST
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>8</span> <span style=color:#8f5902;font-style:italic>//STORETIMESTAMP
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>storehostAddressLength</span> <span style=color:#8f5902;font-style:italic>//STOREHOSTADDRESS
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>4</span> <span style=color:#8f5902;font-style:italic>//RECONSUMETIMES
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>8</span> <span style=color:#8f5902;font-style:italic>//PREPARED TRANSACTION OFFSET
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>4</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bodyLength</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>bodyLength</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>//BODY
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>topicLength</span> <span style=color:#8f5902;font-style:italic>//TOPIC
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>2</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertiesLength</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>propertiesLength</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>//propertieslength
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>msgLen</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>所以地址字段有IPV4和IPV6的区分所以长度会是8或者20字段。(这里包含了端口的数据)</p><blockquote><p>地址IPV4或者IPV6本来可以用4个字节和16个字节完成表示，这里为啥加了四个字节首先看MessageExt.socketAddress2ByteBuffer方法代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>ByteBuffer</span> <span style=color:#000>socketAddress2ByteBuffer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SocketAddress</span> <span style=color:#000>socketAddress</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ByteBuffer</span> <span style=color:#000>byteBuffer</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>InetSocketAddress</span> <span style=color:#000>inetSocketAddress</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InetSocketAddress</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>socketAddress</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>InetAddress</span> <span style=color:#000>address</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>inetSocketAddress</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAddress</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>address</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Inet4Address</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>byteBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inetSocketAddress</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAddress</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getAddress</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>byteBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inetSocketAddress</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAddress</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getAddress</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>16</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>byteBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inetSocketAddress</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPort</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>byteBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>flip</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>byteBuffer</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>因为加入了端口，4个字节来表示端口所以这里用的8和20个字节来表示。</p></blockquote><h4 id=22-consumequeue>2.2 ConsumeQueue</h4><p><strong><code>ConsumeQueue</code></strong> 在代码中对应的 <strong>ConsumeQueue</strong> 类：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ConsumeQueue</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>InternalLogger</span> <span style=color:#000>log</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>InternalLoggerFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLogger</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LoggerName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>STORE_LOGGER_NAME</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#8f5902;font-style:italic>//消费队列存储单元大小
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>CQ_STORE_UNIT_SIZE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>20</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>InternalLogger</span> <span style=color:#000>LOG_ERROR</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>InternalLoggerFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLogger</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LoggerName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>STORE_ERROR_LOGGER_NAME</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>DefaultMessageStore</span> <span style=color:#000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MappedFileQueue</span> <span style=color:#000>mappedFileQueue</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>queueId</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ByteBuffer</span> <span style=color:#000>byteBufferIndex</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>storePath</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>mappedFileSize</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>maxPhysicOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>minLogicOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ConsumeQueueExt</span> <span style=color:#000>consumeQueueExt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MessageStoreConfig</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// ConsumeQueue file size,default is 30W -- 默认条数30w调记录
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>mappedFileSizeConsumeQueue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>300000</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>ConsumeQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CQ_STORE_UNIT_SIZE</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#8f5902;font-style:italic>//获取ConsumeQueue的大小：5.72M左右5.73M不到
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>getMappedFileSizeConsumeQueue</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>factor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ceil</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mappedFileSizeConsumeQueue</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConsumeQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CQ_STORE_UNIT_SIZE</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>0</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>factor</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>ConsumeQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CQ_STORE_UNIT_SIZE</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从代码中可以看到 <strong><code>CQ_STORE_UNIT_SIZE</code></strong> 是一个固定值20，如下图所示。为了实现定长存储，ConsumeQueue 存储了消息 Tag 的 Hash Code，在进行 Broker 端消息过滤时，通过比较 Consumer 订阅 Tag 的 HashCode 和存储条目中的 Tag Hash Code 是否一致来决定是否消费消息。</p><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/ConsumeQueue.png?raw=true" alt></p><blockquote><p><strong>存储的位置：${user.home}/store/consumequeue/${topicName}/${queueId}/${fileName}</strong></p><p>每一个文件存储30w条数据</p></blockquote><h4 id=3-indexfile>3. IndexFile</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>IndexFile</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>InternalLogger</span> <span style=color:#000>log</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>InternalLoggerFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLogger</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LoggerName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>STORE_LOGGER_NAME</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hashSlotSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>indexSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>20</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>invalidIndex</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hashSlotNum</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//500w
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>indexNum</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//2000w
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MappedFile</span> <span style=color:#000>mappedFile</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>FileChannel</span> <span style=color:#000>fileChannel</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MappedByteBuffer</span> <span style=color:#000>mappedByteBuffer</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>IndexHeader</span> <span style=color:#000>indexHeader</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>//..........
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>下面来看一下IndexFile的存储结构：</p><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/IndexFile.png?raw=true" alt></p></div><div class=td-content style=page-break-before:always><h1 id=pg-0fec2e79472ea5138a6011e79ed0c356>7.4 - RocketMQ源码解析-Broker消息存储CommitLog</h1><blockquote><p>以下源码基于Rocket MQ 4.8.0</p></blockquote><h3 id=1-commitlog格式>1. CommitLog格式</h3><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/CommitLog%E8%AE%B0%E5%BD%95%E6%A0%BC%E5%BC%8F.png?raw=true" alt></p><h3 id=2-验证环境的准备>2. 验证环境的准备</h3><p>下载RocketMQ代码，然后选择对应的版本(4.8.0版本)，导入开发工具设置对应的启动参数如下图</p><p><img src="https://github.com/mxsm/picture/blob/main/rocketmq/broker%E5%90%AF%E5%8A%A8debug%E6%95%B0%E6%8D%AE.png?raw=true" alt></p><blockquote><p>这里的NameServer部署在自己本地的虚拟机</p></blockquote><p>然后就是本地 <strong><code>ROCKETMQ_HOME</code></strong> 地址：</p><p><img src="https://github.com/mxsm/picture/blob/main/rocketmq/RocketMQhome.png?raw=true" alt></p><p>这里配置就用从官网下载的启动文件夹里面的对应的就可以。最后就是用来验证的RocketMQ消息生产者的代码(同样代码来自官网)：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MQProducer</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#8f5902;font-style:italic>//代码来源地址： https://rocketmq.apache.org/docs/simple-example/
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>/* Instantiate with a producer group name. */</span>
        <span style=color:#000>DefaultMQProducer</span> <span style=color:#000>producer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span>
            <span style=color:#000>DefaultMQProducer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;please_rename_unique_group_name&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// Specify name server addresses.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>producer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setNamesrvAddr</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;192.168.31.49:9876&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>//Launch the instance.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>producer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//Create a message instance, specifying topic, tag and message body.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>Message</span> <span style=color:#000>msg</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Message</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;TopicTest&#34;</span> <span style=color:#8f5902;font-style:italic>/* Topic */</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#4e9a06>&#34;TagB&#34;</span> <span style=color:#8f5902;font-style:italic>/* Tag */</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Hello RocketMQ &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nanoTime</span><span style=color:#ce5c00;font-weight:700>()).</span><span style=color:#c4a000>getBytes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RemotingHelper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DEFAULT_CHARSET</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>/* Message body */</span>
            <span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>//Call send message to deliver message to one of brokers.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>SendResult</span> <span style=color:#000>sendResult</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>producer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>send</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;%s%n&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sendResult</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//Shut down once the producer instance is not longer in use.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>producer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shutdown</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=3-commitlog持久化过程>3. CommitLog持久化过程</h3><p>这里我们通过分析源码同时通过例子结合Debug来验证分析中的猜想看一下从生产者把数据提交到Broker然后如何写入到磁盘上的CommitLog文件中的。</p><p>首先Broker模块中BrokerStartup类作为主启动类：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>createBrokerController</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>));</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过调用 <strong><code>createBrokerController</code></strong> 方法来创建BrokerController。在 <strong><code>createBrokerController</code></strong> 方法中有一个有这样一段代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>BrokerController</span> <span style=color:#000>controller</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BrokerController</span><span style=color:#ce5c00;font-weight:700>(</span>
                <span style=color:#000>brokerConfig</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#000>nettyServerConfig</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#000>nettyClientConfig</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#000>messageStoreConfig</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// remember all configs to prevent discard
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>controller</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConfiguration</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>registerConfig</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>);</span>
			
            <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>initResult</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>controller</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>initialize</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div><p>通过 <strong><code>controller.initialize()</code></strong> 来对 <strong>BrokerController</strong> 来进行初始化。在初始的过程中，创建了用来处理处理生产者发送的MQ消息数据的类，这个类叫做 <strong><code>SendMessageProcessor</code></strong> 。这个类在 <strong>controller.initialize()</strong> 通过 <strong>BrokerController.registerProcessor</strong> 方法来注入。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>initialize</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>CloneNotSupportedException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    
    <span style=color:#8f5902;font-style:italic>//省略代码
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerProcessor</span><span style=color:#ce5c00;font-weight:700>();</span>
    
    <span style=color:#8f5902;font-style:italic>//省略代码
</span><span style=color:#8f5902;font-style:italic></span>    
<span style=color:#ce5c00;font-weight:700>}</span>


<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerProcessor</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>         * SendMessageProcessor
</span><span style=color:#8f5902;font-style:italic>         */</span>
        <span style=color:#000>SendMessageProcessor</span> <span style=color:#000>sendProcessor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SendMessageProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>sendProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerSendMessageHook</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sendMessageHookList</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>sendProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerConsumeMessageHook</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>consumeMessageHookList</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remotingServer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SEND_MESSAGE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sendProcessor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sendMessageExecutor</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remotingServer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SEND_MESSAGE_V2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sendProcessor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sendMessageExecutor</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remotingServer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SEND_BATCH_MESSAGE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sendProcessor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sendMessageExecutor</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remotingServer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONSUMER_SEND_MSG_BACK</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sendProcessor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sendMessageExecutor</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fastRemotingServer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SEND_MESSAGE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sendProcessor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sendMessageExecutor</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fastRemotingServer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SEND_MESSAGE_V2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sendProcessor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sendMessageExecutor</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fastRemotingServer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SEND_BATCH_MESSAGE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sendProcessor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sendMessageExecutor</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fastRemotingServer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONSUMER_SEND_MSG_BACK</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sendProcessor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sendMessageExecutor</span><span style=color:#ce5c00;font-weight:700>);</span>
 
 	<span style=color:#8f5902;font-style:italic>//后续代码省略
</span><span style=color:#8f5902;font-style:italic></span> <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>所以通过上面的分析处理消息主要是通过 <strong><code>SendMessageProcessor</code></strong> 来进行处理。下面来验证一下是不是会通过</p><p>接下来看一下 <strong><code>SendMessageProcessor</code></strong> 的源码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SendMessageProcessor</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractSendMessageProcessor</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>NettyRequestProcessor</span> <span style=color:#ce5c00;font-weight:700>{</span>
	
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>主要是通过继承 <strong>AbstractSendMessageProcessor</strong> 抽象类和实现 <strong>NettyRequestProcessor</strong> 两个接口。数据处理主要是通过实现 <strong><code>NettyRequestProcessor.processRequest</code></strong> 方法来处理各种不同类型的消息。看一下 <strong><code>SendMessageProcessor.processRequest</code></strong> 的实现：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>RemotingCommand</span> <span style=color:#000>processRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ChannelHandlerContext</span> <span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span>
                                          <span style=color:#000>RemotingCommand</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>RemotingCommandException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>RemotingCommand</span> <span style=color:#000>response</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>response</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>asyncProcessRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>ExecutionException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;process SendMessage error, request : &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote><p>两个参数：</p><ul><li>ctx ： netty的相关参数</li><li>request： 类型RemotingCommand，这个是RocketMQ的消息协议的抽象(rocketmq-模块设计的文章)</li></ul></blockquote><p>然后调用 <strong><code>asyncProcessRequest</code></strong> 来获取结果。接下来看一下这个方法的实现：</p><blockquote><p>注意： 从方法名称来看是一个异步的调用过程，但是通过等待返回值来达到一个同步的过程。其实在后台的很多实现都是异步调用，然后通过等待返回结果实现同步的过程。</p></blockquote><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>RemotingCommand</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>asyncProcessRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ChannelHandlerContext</span> <span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span>
                                                                  <span style=color:#000>RemotingCommand</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>RemotingCommandException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SendMessageContext</span> <span style=color:#000>mqtraceContext</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>switch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCode</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>///这个分支是消费失败将消息重新发回Broker才会走
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONSUMER_SEND_MSG_BACK</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>asyncConsumerSendMsgBack</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>default</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#000>SendMessageRequestHeader</span> <span style=color:#000>requestHeader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parseRequestHeader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>completedFuture</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#000>mqtraceContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>buildMsgContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#8f5902;font-style:italic>//SendMessageHook 接口的处理
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>executeSendMessageHookBefore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mqtraceContext</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isBatch</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>//批量消息处理
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>asyncSendBatchMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mqtraceContext</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>//单个消息处理
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>asyncSendMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mqtraceContext</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面处理数据就是两大类数据：</p><ul><li>消费失败的数据RequestCode.CONSUMER_SEND_MSG_BACK</li><li>生产者的发送数据，这个数据又包含两大类<ul><li>RequestCode.SEND_BATCH_MESSAGE 批量数据</li><li>RequestCode.SEND_MESSAGE_V2 和 RequestCode.SEND_MESSAGE 单个数据 (只是版本不一样)</li></ul></li></ul><p>所以上面主要有两类处理一个是单个消息 <strong><code>asyncSendMessage</code></strong> f方法和 <strong><code>asyncSendBatchMessage</code></strong> 处理批量发送的数据。这里只分析单个数据的存储(多个数据原理差不多)。</p><p><img src="https://github.com/mxsm/picture/blob/main/rocketmq/broker-commitlog.gif?raw=true" alt></p><p>首先是对数据进行处理和一些前期的校验如下代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>RemotingCommand</span> <span style=color:#000>response</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>preSend</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SendMessageResponseHeader</span> <span style=color:#000>responseHeader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SendMessageResponseHeader</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readCustomHeader</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>completedFuture</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>body</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBody</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>queueIdInt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueId</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>TopicConfig</span> <span style=color:#000>topicConfig</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopicConfigManager</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>selectTopicConfig</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>());</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>queueIdInt</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>queueIdInt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>randomQueueId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topicConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWriteQueueNums</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后构建 <strong><code>MessageExtBrokerInner</code></strong> 在Broker内部使用的对象类,这里主要是设置一些Broker的信息到消息中如下：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>MessageExtBrokerInner</span> <span style=color:#000>msgInner</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MessageExtBrokerInner</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTopic</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setQueueId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>queueIdInt</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>handleRetryAndDLQ</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>topicConfig</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>completedFuture</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBody</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>body</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setFlag</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getFlag</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>MessageAccessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MessageDecoder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>string2messageProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProperties</span><span style=color:#ce5c00;font-weight:700>()));</span>
        <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setPropertiesString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProperties</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBornTimestamp</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBornTimestamp</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBornHost</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>channel</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>remoteAddress</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setStoreHost</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStoreHost</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setReconsumeTimes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getReconsumeTimes</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getReconsumeTimes</span><span style=color:#ce5c00;font-weight:700>());</span>
</code></pre></div><p>然后就是存储消息处理：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PutMessageResult</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>putMessageResult</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>origProps</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MessageDecoder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>string2messageProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProperties</span><span style=color:#ce5c00;font-weight:700>());</span>
<span style=color:#000>String</span> <span style=color:#000>transFlag</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>origProps</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageConst</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PROPERTY_TRANSACTION_PREPARED</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#8f5902;font-style:italic>//判断是否为事务消息
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>transFlag</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseBoolean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>transFlag</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isRejectTransactionMessage</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NO_PERMISSION</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setRemark</span><span style=color:#ce5c00;font-weight:700>(</span>
                <span style=color:#4e9a06>&#34;the broker[&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getBrokerIP1</span><span style=color:#ce5c00;font-weight:700>()</span>
                        <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;] sending transaction message is forbidden&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>completedFuture</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>putMessageResult</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTransactionalMessageService</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>asyncPrepareMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>putMessageResult</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStore</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>asyncPutMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>handlePutMessageResultFuture</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>putMessageResult</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>responseHeader</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mqtraceContext</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>queueIdInt</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>这里有消息分为两种：</p><ul><li>事务消息(以后分析处理)</li><li>普通消息</li></ul><p><img src="https://github.com/mxsm/picture/blob/main/rocketmq/broker-commitlog-1.gif?raw=true" alt></p><blockquote><p>这里产生的是普通消息</p></blockquote><p>存储通过调用 <strong><code>MessageStore.asyncPutMessage</code></strong> 方法，而 <strong><code>MessageStore</code></strong> 的实现为 <strong>DefaultMessageStore</strong> 。 看一下 <strong><code>DefaultMessageStore.asyncPutMessage</code></strong> 实现：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PutMessageResult</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>asyncPutMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageExtBrokerInner</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#8f5902;font-style:italic>//检测存储状态
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>PutMessageStatus</span> <span style=color:#000>checkStoreStatus</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>checkStoreStatus</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>checkStoreStatus</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>PutMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PUT_OK</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>completedFuture</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PutMessageResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>checkStoreStatus</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>//校验消息的topic和Properties
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>PutMessageStatus</span> <span style=color:#000>msgCheckStatus</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>checkMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgCheckStatus</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>PutMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MESSAGE_ILLEGAL</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>completedFuture</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PutMessageResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgCheckStatus</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>beginTime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSystemClock</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>now</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>//消息处理
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PutMessageResult</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>putResultFuture</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>asyncPutMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#000>putResultFuture</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>thenAccept</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>elapsedTime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSystemClock</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>now</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>beginTime</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elapsedTime</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>500</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;putMessage not in lock elapsed time(ms)={}, bodyLength={}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>elapsedTime</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBody</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>storeStatsService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setPutMessageEntireTimeMax</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elapsedTime</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isOk</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>storeStatsService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPutMessageFailedTimes</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>incrementAndGet</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>});</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>putResultFuture</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过 <strong><code>CommitLog.asyncPutMessage</code></strong> 方法来持久化数据，在这个方法中主要主要做了三件事情：</p><ul><li><p>设置消息Body的CRC校验，后期读取数据要用到。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PutMessageResult</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>asyncPutMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MessageExtBrokerInner</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//设置存储的时间
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setStoreTimestamp</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#8f5902;font-style:italic>//设置CRC的校验值
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBodyCRC</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UtilAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>crc32</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBody</span><span style=color:#ce5c00;font-weight:700>()));</span>

    <span style=color:#8f5902;font-style:italic>// ..........省略代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li><li><p>延迟消息的处理</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PutMessageResult</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>asyncPutMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MessageExtBrokerInner</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>//省略代码
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tranType</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>MessageSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TRANSACTION_NOT_TYPE</span>
                <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>tranType</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>MessageSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TRANSACTION_COMMIT_TYPE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// Delay Delivery
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDelayTimeLevel</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDelayTimeLevel</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getScheduleMessageService</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getMaxDelayLevel</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setDelayTimeLevel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getScheduleMessageService</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getMaxDelayLevel</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#ce5c00;font-weight:700>}</span>

                <span style=color:#000>topic</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ScheduleMessageService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SCHEDULE_TOPIC</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>queueId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ScheduleMessageService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>delayLevel2QueueId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDelayTimeLevel</span><span style=color:#ce5c00;font-weight:700>());</span>

                <span style=color:#8f5902;font-style:italic>// Backup real topic, queueId
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>MessageAccessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MessageConst</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PROPERTY_REAL_TOPIC</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#000>MessageAccessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MessageConst</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PROPERTY_REAL_QUEUE_ID</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>valueOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueId</span><span style=color:#ce5c00;font-weight:700>()));</span>
                <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setPropertiesString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageDecoder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageProperties2String</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProperties</span><span style=color:#ce5c00;font-weight:700>()));</span>

                <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTopic</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setQueueId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>queueId</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>//省略代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这里是处理不同延迟等级的延迟消费消息的数据。</p></li><li><p>CommitLog的数据处理</p><p>message消息的处理也分为了三步：</p><ol><li><p>CommitLog的提交</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PutMessageResult</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>asyncPutMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MessageExtBrokerInner</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
     <span style=color:#8f5902;font-style:italic>//省略代码
</span><span style=color:#8f5902;font-style:italic></span>     <span style=color:#000>putMessageLock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lock</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//spin or ReentrantLock ,depending on store config
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>beginLockTimestamp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSystemClock</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>now</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beginTimeInLock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beginLockTimestamp</span><span style=color:#ce5c00;font-weight:700>;</span>

            <span style=color:#8f5902;font-style:italic>// Here settings are stored timestamp, in order to ensure an orderly
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// global
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setStoreTimestamp</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beginLockTimestamp</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>mappedFile</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>mappedFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isFull</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>mappedFile</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mappedFileQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLastMappedFile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// Mark: NewFile may be cause noise
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>mappedFile</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;create mapped file1 error, topic: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; clientAddr: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBornHostString</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#000>beginTimeInLock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>completedFuture</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PutMessageResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PutMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CREATE_MAPEDFILE_FAILED</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
           <span style=color:#8f5902;font-style:italic>//关键代码--添加CommitLog日志消息
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mappedFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>appendMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>appendMessageCallback</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>switch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStatus</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>PUT_OK</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>END_OF_FILE</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#000>unlockMappedFile</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mappedFile</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#8f5902;font-style:italic>// Create a new file, re-write the message
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>mappedFile</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mappedFileQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLastMappedFile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>mappedFile</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>// XXX: warn and notify me
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;create mapped file2 error, topic: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; clientAddr: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBornHostString</span><span style=color:#ce5c00;font-weight:700>());</span>
                        <span style=color:#000>beginTimeInLock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>completedFuture</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PutMessageResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PutMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CREATE_MAPEDFILE_FAILED</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>));</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mappedFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>appendMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>appendMessageCallback</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>MESSAGE_SIZE_EXCEEDED</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>PROPERTIES_SIZE_EXCEEDED</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#000>beginTimeInLock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>completedFuture</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PutMessageResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PutMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MESSAGE_ILLEGAL</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>));</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>UNKNOWN_ERROR</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#000>beginTimeInLock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>completedFuture</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PutMessageResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PutMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>UNKNOWN_ERROR</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>));</span>
                <span style=color:#204a87;font-weight:700>default</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#000>beginTimeInLock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>completedFuture</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PutMessageResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PutMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>UNKNOWN_ERROR</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#000>elapsedTimeInLock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSystemClock</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>now</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>beginLockTimestamp</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>beginTimeInLock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>putMessageLock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unlock</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
     <span style=color:#8f5902;font-style:italic>//省略代码
</span><span style=color:#8f5902;font-style:italic></span> <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li><li><p>CommitLog的刷盘(同步刷盘和异步刷盘两种)</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PutMessageStatus</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>flushResultFuture</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>submitFlushRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>putMessageResult</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PutMessageStatus</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>submitFlushRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AppendMessageResult</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>PutMessageResult</span> <span style=color:#000>putMessageResult</span><span style=color:#ce5c00;font-weight:700>,</span>
                                                                  <span style=color:#000>MessageExt</span> <span style=color:#000>messageExt</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 判断刷盘的方式---默认值为FlushDiskType.ASYNC_FLUSH 异步刷盘的方式
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>FlushDiskType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SYNC_FLUSH</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStoreConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getFlushDiskType</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>GroupCommitService</span> <span style=color:#000>service</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>GroupCommitService</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>flushCommitLogService</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>messageExt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isWaitStoreMsgOK</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>GroupCommitRequest</span> <span style=color:#000>request</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>GroupCommitRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWroteOffset</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWroteBytes</span><span style=color:#ce5c00;font-weight:700>(),</span>
                        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStoreConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getSyncFlushTimeout</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>future</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>completedFuture</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PutMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PUT_OK</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// Asynchronous flush
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStoreConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isTransientStorePoolEnable</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>flushCommitLogService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span>  <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>commitLogService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>completedFuture</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PutMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PUT_OK</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过配置文件可以配置刷盘的方式，默认的刷盘方式为异步刷盘方式(根据官网的说明如果使用防止消息的丢失可以使用同步刷盘方式但是同步刷盘会影响并发)。</p></li><li><p>提交给Slave同步(同步和异步两种)</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PutMessageStatus</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>replicaResultFuture</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>submitReplicaRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>putMessageResult</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PutMessageStatus</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>submitReplicaRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AppendMessageResult</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>PutMessageResult</span> <span style=color:#000>putMessageResult</span><span style=color:#ce5c00;font-weight:700>,</span>
                                                        <span style=color:#000>MessageExt</span> <span style=color:#000>messageExt</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
       <span style=color:#8f5902;font-style:italic>//默认的是BrokerRole.ASYNC_MASTER 所以也是异步的方式
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BrokerRole</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SYNC_MASTER</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStoreConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getBrokerRole</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>HAService</span> <span style=color:#000>service</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getHaService</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>messageExt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isWaitStoreMsgOK</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSlaveOK</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWroteBytes</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWroteOffset</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>GroupCommitRequest</span> <span style=color:#000>request</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>GroupCommitRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWroteOffset</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWroteBytes</span><span style=color:#ce5c00;font-weight:700>(),</span>
                            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStoreConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getSyncFlushTimeout</span><span style=color:#ce5c00;font-weight:700>());</span>
                    <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWaitNotifyObject</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>wakeupAll</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>future</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>completedFuture</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PutMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SLAVE_NOT_AVAILABLE</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>completedFuture</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PutMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PUT_OK</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li></ol></li></ul><p>上面可以通过官网的一个图片来说明这两种情况：</p><p><img src=https://github.com/apache/rocketmq/raw/master/docs/cn/image/rocketmq_design_2.png alt></p><p>通过上面的代码分析可以知道主要是通过：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mappedFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>appendMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>appendMessageCallback</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>这段代码把message持久化，在RocketMQ的所有的文件都是通过 <strong><code>MappedFile</code></strong> 包装进行处理的。下面来看一下 <strong><code>MappedFile.appendMessage</code></strong> 方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>AppendMessageResult</span> <span style=color:#000>appendMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MessageExtBrokerInner</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>AppendMessageCallback</span> <span style=color:#000>cb</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>appendMessagesInner</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cb</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong><code>appendMessage</code></strong> 方法调用了 <strong><code>MappedFile.appendMessagesInner</code></strong> 的内部方法。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>AppendMessageResult</span> <span style=color:#000>appendMessagesInner</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MessageExt</span> <span style=color:#000>messageExt</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>AppendMessageCallback</span> <span style=color:#000>cb</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>assert</span> <span style=color:#000>messageExt</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>assert</span> <span style=color:#000>cb</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>currentPos</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wrotePosition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#8f5902;font-style:italic>//当前偏移量和文件大小做比较
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentPos</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fileSize</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>ByteBuffer</span> <span style=color:#000>byteBuffer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>writeBuffer</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>writeBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>slice</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mappedByteBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>slice</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>byteBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>position</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentPos</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>AppendMessageResult</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>//同样这里区分了处理批量消息和单个消息
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>messageExt</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>MessageExtBrokerInner</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cb</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doAppend</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getFileFromOffset</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>byteBuffer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fileSize</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>currentPos</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageExtBrokerInner</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>messageExt</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>messageExt</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>MessageExtBatch</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cb</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doAppend</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getFileFromOffset</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>byteBuffer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fileSize</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>currentPos</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageExtBatch</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>messageExt</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AppendMessageResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AppendMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>UNKNOWN_ERROR</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wrotePosition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAndGet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWroteBytes</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>storeTimestamp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStoreTimestamp</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;MappedFile.appendMessage return null, wrotePosition: {} fileSize: {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>currentPos</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fileSize</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AppendMessageResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AppendMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>UNKNOWN_ERROR</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过代码发现代码里面通过调用 <strong><code>AppendMessageCallback.doAppend</code></strong> 来处理数据， 在 <strong><code>CommitLog</code></strong> 类**<code>AppendMessageCallback</code>** 中有一个 的内部类的实现 **<code>DefaultAppendMessageCallback</code>** 。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>AppendMessageResult</span> <span style=color:#000>doAppend</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>fileFromOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ByteBuffer</span> <span style=color:#000>byteBuffer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>maxBlank</span><span style=color:#ce5c00;font-weight:700>,</span>
            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MessageExtBrokerInner</span> <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// STORETIMESTAMP + STOREHOSTADDRESS + OFFSET &lt;br&gt;
</span><span style=color:#8f5902;font-style:italic></span>
            <span style=color:#8f5902;font-style:italic>// PHY OFFSET
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>wroteOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>fileFromOffset</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>byteBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>position</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>sysflag</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSysFlag</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>bornHostLength</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sysflag</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>MessageSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>BORNHOST_V6_FLAG</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>4</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>4</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>16</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>storeHostLength</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sysflag</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>MessageSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>STOREHOSTADDRESS_V6_FLAG</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>4</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>4</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>16</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>ByteBuffer</span> <span style=color:#000>bornHostHolder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ByteBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allocate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bornHostLength</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>ByteBuffer</span> <span style=color:#000>storeHostHolder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ByteBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allocate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>storeHostLength</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resetByteBuffer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>storeHostHolder</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>storeHostLength</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>String</span> <span style=color:#000>msgId</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>sysflag</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>MessageSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>STOREHOSTADDRESS_V6_FLAG</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>msgId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MessageDecoder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createMessageId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgIdMemory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStoreHostBytes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>storeHostHolder</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>wroteOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>msgId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MessageDecoder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createMessageId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgIdV6Memory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStoreHostBytes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>storeHostHolder</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>wroteOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>// Record ConsumeQueue information
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>keyBuilder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setLength</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>keyBuilder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#000>keyBuilder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;-&#39;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>keyBuilder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueId</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#000>String</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>keyBuilder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>Long</span> <span style=color:#000>queueOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>CommitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>topicQueueTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>queueOffset</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>queueOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0L</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>CommitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>topicQueueTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>queueOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>// Transaction messages that require special handling
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>tranType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MessageSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTransactionValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSysFlag</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#204a87;font-weight:700>switch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tranType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// Prepared and Rollback message is not consumed, will not enter the
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// consumer queuec
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>MessageSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TRANSACTION_PREPARED_TYPE</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>MessageSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TRANSACTION_ROLLBACK_TYPE</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#000>queueOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0L</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>MessageSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TRANSACTION_NOT_TYPE</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>MessageSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TRANSACTION_COMMIT_TYPE</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>default</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>             * Serialize message
</span><span style=color:#8f5902;font-style:italic>             */</span>
            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>propertiesData</span> <span style=color:#ce5c00;font-weight:700>=</span>
                <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPropertiesString</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPropertiesString</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getBytes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageDecoder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CHARSET_UTF8</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>propertiesLength</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>propertiesData</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>propertiesData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertiesLength</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Short</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MAX_VALUE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;putMessage message properties length too long. length={}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>propertiesData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AppendMessageResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AppendMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PROPERTIES_SIZE_EXCEEDED</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>topicData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getBytes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageDecoder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CHARSET_UTF8</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>topicLength</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>topicData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span>

            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>bodyLength</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBody</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBody</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span>

            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>msgLen</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>calMsgLength</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSysFlag</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>bodyLength</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>topicLength</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>propertiesLength</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#8f5902;font-style:italic>// Exceeds the maximum message
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgLen</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>maxMessageSize</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>CommitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;message size exceeded, msg total size: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>msgLen</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;, msg body size: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>bodyLength</span>
                    <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;, maxMessageSize: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>maxMessageSize</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AppendMessageResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AppendMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MESSAGE_SIZE_EXCEEDED</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>// Determines whether there is sufficient free space
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>msgLen</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>END_FILE_MIN_BLANK_LENGTH</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>maxBlank</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resetByteBuffer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>maxBlank</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#8f5902;font-style:italic>// 1 TOTALSIZE
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>maxBlank</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#8f5902;font-style:italic>// 2 MAGICCODE
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CommitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>BLANK_MAGIC_CODE</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#8f5902;font-style:italic>// 3 The remaining space may be any value
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// Here the length of the specially set maxBlank
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>beginTimeMills</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>CommitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>now</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#000>byteBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>array</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>maxBlank</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AppendMessageResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AppendMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>END_OF_FILE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>wroteOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>maxBlank</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>msgId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStoreTimestamp</span><span style=color:#ce5c00;font-weight:700>(),</span>
                    <span style=color:#000>queueOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CommitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>now</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>beginTimeMills</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>// Initialization of storage space
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resetByteBuffer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>msgLen</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 1 TOTALSIZE
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgLen</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 2 MAGICCODE
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CommitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MESSAGE_MAGIC_CODE</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 3 BODYCRC
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBodyCRC</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#8f5902;font-style:italic>// 4 QUEUEID
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueId</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#8f5902;font-style:italic>// 5 FLAG
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getFlag</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#8f5902;font-style:italic>// 6 QUEUEOFFSET
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putLong</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>queueOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 7 PHYSICALOFFSET
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putLong</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fileFromOffset</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>byteBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>position</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#8f5902;font-style:italic>// 8 SYSFLAG
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSysFlag</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#8f5902;font-style:italic>// 9 BORNTIMESTAMP
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putLong</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBornTimestamp</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#8f5902;font-style:italic>// 10 BORNHOST
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resetByteBuffer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bornHostHolder</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bornHostLength</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBornHostBytes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bornHostHolder</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#8f5902;font-style:italic>// 11 STORETIMESTAMP
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putLong</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStoreTimestamp</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#8f5902;font-style:italic>// 12 STOREHOSTADDRESS
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resetByteBuffer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>storeHostHolder</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>storeHostLength</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStoreHostBytes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>storeHostHolder</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#8f5902;font-style:italic>// 13 RECONSUMETIMES
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getReconsumeTimes</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#8f5902;font-style:italic>// 14 Prepared Transaction Offset
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putLong</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPreparedTransactionOffset</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#8f5902;font-style:italic>// 15 BODY
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bodyLength</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bodyLength</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBody</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#8f5902;font-style:italic>// 16 TOPIC
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>topicLength</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topicData</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 17 PROPERTIES
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putShort</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#204a87;font-weight:700>short</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>propertiesLength</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertiesLength</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertiesData</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>beginTimeMills</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>CommitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>now</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#8f5902;font-style:italic>// Write messages to the queue buffer
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>byteBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>array</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>msgLen</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#000>AppendMessageResult</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AppendMessageResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AppendMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PUT_OK</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>wroteOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>msgLen</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>msgId</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStoreTimestamp</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>queueOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CommitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>now</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>beginTimeMills</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#204a87;font-weight:700>switch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tranType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>MessageSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TRANSACTION_PREPARED_TYPE</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>MessageSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TRANSACTION_ROLLBACK_TYPE</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>MessageSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TRANSACTION_NOT_TYPE</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>MessageSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TRANSACTION_COMMIT_TYPE</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#8f5902;font-style:italic>// The next update ConsumeQueue information
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>CommitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>topicQueueTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>queueOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>default</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这个方法讲解CommitLog的整个数据组装。</p><p><img src="https://github.com/mxsm/picture/blob/main/rocketmq/broker-commitlog-2.gif?raw=true" alt></p><h3 id=4-commitlog持久化过程中的重要类>4. CommitLog持久化过程中的重要类</h3><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/RocketMQLevel.png?raw=true" alt></p><p>以上的图片说明了RocketMQ的不同分层的。</p><h4 id=41-commitlog>4.1 CommitLog</h4><p>对CommitLog日志的抽象和处理类</p><h4 id=42-mappedfilequeue>4.2 MappedFileQueue</h4><p>映射的文件队列，用来处理文件映射的队列数据。比如CommitLog日志文件</p><h4 id=43-mappedfile>4.3 MappedFile</h4><p>大文件的磁盘操作</p><h3 id=5-commitlog数据读取验证>5. CommitLog数据读取验证</h3><p>发送消息的代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MQProducer</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>/* Instantiate with a producer group name. */</span>
        <span style=color:#000>DefaultMQProducer</span> <span style=color:#000>producer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span>
            <span style=color:#000>DefaultMQProducer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;please_rename_unique_group_name&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// Specify name server addresses.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>producer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setNamesrvAddr</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;192.168.31.49:9876&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>//Launch the instance.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>producer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//Create a message instance, specifying topic, tag and message body.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>String</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Hello RocketMQ &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nanoTime</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>Message</span> <span style=color:#000>msg</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Message</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;TopicTest&#34;</span> <span style=color:#8f5902;font-style:italic>/* Topic */</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#4e9a06>&#34;TagB&#34;</span> <span style=color:#8f5902;font-style:italic>/* Tag */</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBytes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RemotingHelper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DEFAULT_CHARSET</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>/* Message body */</span>
            <span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>//Call send message to deliver message to one of brokers.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>SendResult</span> <span style=color:#000>sendResult</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>producer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>send</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;%s%n&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sendResult</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//Shut down once the producer instance is not longer in use.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>producer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shutdown</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div><p>发送到MQ的消息如下图：</p><p><img src="https://github.com/mxsm/picture/blob/main/rocketmq/%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8%E6%89%93%E5%8D%B0%E5%AD%98%E5%82%A8%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE.png?raw=true" alt></p><p>然后再Broker存储的时候增加日志打印如下图：</p><p><img src="https://github.com/mxsm/picture/blob/main/rocketmq/%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8%E6%89%93%E5%8D%B0%E5%AD%98%E5%82%A8.png?raw=true" alt></p><p><img src="https://github.com/mxsm/picture/blob/main/rocketmq/broker%E6%89%93%E5%8D%B0%E5%AD%98%E5%82%A8%E7%9A%84%E9%95%BF%E5%BA%A6.png?raw=true" alt></p><p>然后通过代码解析数据：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MappedFile</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>{</span>

     
        <span style=color:#000>File</span> <span style=color:#000>file</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>File</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;C:\\Users\\mxsm\\store\\commitlog\\00000000000000000000&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>RandomAccessFile</span> <span style=color:#000>randomAccessFile</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RandomAccessFile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>file</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;rw&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>FileChannel</span> <span style=color:#000>channel</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>randomAccessFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChannel</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>MappedByteBuffer</span> <span style=color:#000>map</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MapMode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>READ_WRITE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>file</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>totalSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInt</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>// 1 TOTALSIZE
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;TOTALSIZE:&#34;</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>totalSize</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>bytes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>totalSize</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bytes</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>ByteBuffer</span> <span style=color:#000>wrap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ByteBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wrap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bytes</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>msgLen</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>4</span> <span style=color:#8f5902;font-style:italic>//MAGICCODE
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>4</span> <span style=color:#8f5902;font-style:italic>//BODYCRC
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>4</span> <span style=color:#8f5902;font-style:italic>//QUEUEID
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>4</span> <span style=color:#8f5902;font-style:italic>//FLAG
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>8</span> <span style=color:#8f5902;font-style:italic>//QUEUEOFFSET
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>8</span> <span style=color:#8f5902;font-style:italic>//PHYSICALOFFSET
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>4</span> <span style=color:#8f5902;font-style:italic>//SYSFLAG
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>8</span> <span style=color:#8f5902;font-style:italic>//BORNTIMESTAMP
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>8</span> <span style=color:#8f5902;font-style:italic>//BORNHOST
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>8</span> <span style=color:#8f5902;font-style:italic>//STORETIMESTAMP
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>8</span> <span style=color:#8f5902;font-style:italic>//STOREHOSTADDRESS
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>4</span> <span style=color:#8f5902;font-style:italic>//RECONSUMETIMES
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>8</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//Prepared Transaction Offset
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>//获取Body的长度
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>bytes1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#000>wrap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>position</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgLen</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>wrap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bytes1</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>anInt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ByteBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wrap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bytes1</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getInt</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>bodyBytes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>anInt</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#000>wrap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bodyBytes</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>bodyBytes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>//打印Body
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bodyBytes</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><img src="https://github.com/mxsm/picture/blob/main/rocketmq/commitlog%E8%A7%A3%E6%9E%90%E5%90%8E%E7%9A%84%E6%95%B0%E6%8D%AE.png?raw=true" alt></p></div><div class=td-content style=page-break-before:always><h1 id=pg-5ef930f71905a5f352f4de5310e3a582>7.5 - RocketMQ源码解析-Broker消息存储ConsumeQueue</h1><blockquote><p>以下源码基于Rocket MQ 4.7.0</p></blockquote><h3 id=1-consumequeue格式>1. ConsumeQueue格式</h3><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/ConsumeQueue.png?raw=true" alt></p><p>在之前就分析过，每一条ConsumeQueue数据是定长的20bytes，然后每一个文件存储30w条数据。存储是按照topic和queueId进行分类存储。那么ConsumeQueue的作用：</p><ul><li>前8个byte保存了CommitLog的偏移量，根据这个偏移量能够找到该条消息的CommitLog文件所在的位置</li><li>中间的四个字节保存了消息大小根据前面的八个字节就能随机读出消息。</li><li>最后八个字节用于处理消费者tag的过滤</li></ul><p>这里我们只分析ConsumeQueue文件的生成过程，其他的会在后续的其他文章中分析</p><h3 id=2-consumequeue持久化过程>2. ConsumeQueue持久化过程</h3><p>ConsumeQueue持久化也是RocketMQ三大持久化之一，所以通过源码分析找到，ConsumeQueue持久化是用过一个 <strong><code>ReputMessageService</code></strong> 来提供持久化服务，这个类是 <strong><code>ReputMessageService</code></strong> 类中的一个内部类:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ReputMessageService</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ServiceThread</span> <span style=color:#ce5c00;font-weight:700>{</span>

     <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>reputFromOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#8f5902;font-style:italic>//省略代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>继承了RocketMQ自定义的 <strong><code>ServiceThread</code></strong> 服务线程。所以个服务就是个线程。看一下Run方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getServiceName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; service started&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isStopped</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doReput</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getServiceName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; service has exception. &#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getServiceName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; service end&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>主要是通过调用doReput方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>doReput</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//获取读取数据的位置--默认是从0开始，对于运行一段时间的系统会进行设置
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reputFromOffset</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMinOffset</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The reputFromOffset={} is smaller than minPyOffset={}, this usually indicate that the dispatch behind too much and the commitlog has expired.&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reputFromOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMinOffset</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reputFromOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMinOffset</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>doNext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isCommitLogAvailable</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>doNext</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStoreConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isDuplicationEnable</span><span style=color:#ce5c00;font-weight:700>()</span>
                    <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reputFromOffset</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConfirmOffset</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#8f5902;font-style:italic>//获取CommitLog中可以使用的数据结果
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>SelectMappedBufferResult</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getData</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>reputFromOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reputFromOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStartOffset</span><span style=color:#ce5c00;font-weight:700>();</span>

                        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>readSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>readSize</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSize</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>doNext</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
							<span style=color:#8f5902;font-style:italic>//获取一条CommitLog数据出来
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#000>DispatchRequest</span> <span style=color:#000>dispatchRequest</span> <span style=color:#ce5c00;font-weight:700>=</span>
                                <span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>checkMessageAndReturnSize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getByteBuffer</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
									
                            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBufferSize</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgSize</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBufferSize</span><span style=color:#ce5c00;font-weight:700>();</span>
							
                            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSuccess</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
									<span style=color:#8f5902;font-style:italic>//调用处理数据生成ConsumeQueue
</span><span style=color:#8f5902;font-style:italic></span>                                    <span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doDispatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>);</span>

									<span style=color:#8f5902;font-style:italic>//对于Broker Master进行处理
</span><span style=color:#8f5902;font-style:italic></span>                                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BrokerRole</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SLAVE</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStoreConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getBrokerRole</span><span style=color:#ce5c00;font-weight:700>()</span>
                                        <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isLongPollingEnable</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                        <span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageArrivingListener</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>arriving</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span>
                                            <span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueId</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumeQueueOffset</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>,</span>
                                            <span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTagsCode</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStoreTimestamp</span><span style=color:#ce5c00;font-weight:700>(),</span>
                                            <span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBitMap</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPropertiesMap</span><span style=color:#ce5c00;font-weight:700>());</span>
                                    <span style=color:#ce5c00;font-weight:700>}</span>
									<span style=color:#8f5902;font-style:italic>//向前推进offset
</span><span style=color:#8f5902;font-style:italic></span>                                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reputFromOffset</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>;</span>
                                    <span style=color:#000>readSize</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>;</span>
                                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStoreConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getBrokerRole</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>BrokerRole</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SLAVE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                        <span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>storeStatsService</span>
                                            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSinglePutMessageTopicTimesTotal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>()).</span><span style=color:#c4a000>incrementAndGet</span><span style=color:#ce5c00;font-weight:700>();</span>
                                        <span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>storeStatsService</span>
                                            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSinglePutMessageTopicSizeTotal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>())</span>
                                            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAndGet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgSize</span><span style=color:#ce5c00;font-weight:700>());</span>
                                    <span style=color:#ce5c00;font-weight:700>}</span>
                                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
									<span style=color:#8f5902;font-style:italic>//读取下一个文件
</span><span style=color:#8f5902;font-style:italic></span>                                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reputFromOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rollNextFile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reputFromOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
                                    <span style=color:#000>readSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSize</span><span style=color:#ce5c00;font-weight:700>();</span>
                                <span style=color:#ce5c00;font-weight:700>}</span>
                            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSuccess</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>

                                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[BUG]read total count not equals msg total size. reputFromOffset={}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>reputFromOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
                                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reputFromOffset</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>;</span>
                                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                    <span style=color:#000>doNext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
                                    <span style=color:#8f5902;font-style:italic>// If user open the dledger pattern or the broker is master node,
</span><span style=color:#8f5902;font-style:italic></span>                                    <span style=color:#8f5902;font-style:italic>// it will not ignore the exception and fix the reputFromOffset variable
</span><span style=color:#8f5902;font-style:italic></span>                                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStoreConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isEnableDLegerCommitLog</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>||</span>
                                        <span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerId</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>MixAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MASTER_ID</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[BUG]dispatch message to consume queue error, COMMITLOG OFFSET: {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                                            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reputFromOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
                                        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reputFromOffset</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSize</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>readSize</span><span style=color:#ce5c00;font-weight:700>;</span>
                                    <span style=color:#ce5c00;font-weight:700>}</span>
                                <span style=color:#ce5c00;font-weight:700>}</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>release</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>doNext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ol><li>读取CommitLog中当前次数能够处理的数据。(数据可能在不同的文件中)</li><li>循环处理当前批次的数据将数据转换为 <strong><code>DispatchRequest</code></strong></li><li>通过 <strong><code>DefaultMessageStore.doDispatch</code></strong> 去分发 <strong><code>DispatchReques</code></strong> t数据</li></ol><p>下面来看一下 <strong><code>DefaultMessageStore.doDispatch</code></strong> 方法是如何对数据进行分发的：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>doDispatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DispatchRequest</span> <span style=color:#000>req</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CommitLogDispatcher</span> <span style=color:#000>dispatcher</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dispatcherList</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>dispatcher</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dispatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>req</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过这里可以看出来有一个 <strong><code>CommitLogDispatcher</code></strong> 接口, 这里其实就分别处理来生成 ConsumeQueue和IndexFile两种文件。</p><blockquote><p><strong><code>CommitLogDispatcher</code></strong> 在RocketMQ中有三种实现：</p><ol><li>CommitLogDispatcherBuildConsumeQueue &ndash; 处理ConsumeQueue的生成</li><li>CommitLogDispatcherBuildIndex &ndash; 处理IndexFile的生成</li><li>CommitLogDispatcherCalcBitMap &ndash; 处理计算bit Map</li></ol></blockquote><p>下面来看一下CommitLogDispatcherBuildConsumeQueue的实现：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>CommitLogDispatcherBuildConsumeQueue</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>CommitLogDispatcher</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>dispatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DispatchRequest</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>tranType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MessageSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTransactionValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSysFlag</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#204a87;font-weight:700>switch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tranType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>MessageSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TRANSACTION_NOT_TYPE</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>MessageSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TRANSACTION_COMMIT_TYPE</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putMessagePositionInfo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>MessageSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TRANSACTION_PREPARED_TYPE</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>MessageSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TRANSACTION_ROLLBACK_TYPE</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这里TRANSACTION_PREPARED_TYPE和TRANSACTION_ROLLBACK_TYPE这两种数据类型不需要处理。数据处理只要是通过 <strong><code>DefaultMessageStore.this.putMessagePositionInfo(request)</code></strong> 这段代码处理。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>putMessagePositionInfo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DispatchRequest</span> <span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>ConsumeQueue</span> <span style=color:#000>cq</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findConsumeQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueId</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>cq</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putMessagePositionInfoWrapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过topic和queueId找到对应的ConsumeQueue。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>putMessagePositionInfoWrapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DispatchRequest</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>maxRetries</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>30</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>canWrite</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRunningFlags</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isCQWriteable</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>maxRetries</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>canWrite</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>tagsCode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTagsCode</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isExtWriteEnable</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>ConsumeQueueExt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CqExtUnit</span> <span style=color:#000>cqExtUnit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConsumeQueueExt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CqExtUnit</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#000>cqExtUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setFilterBitMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBitMap</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#000>cqExtUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setMsgStoreTime</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStoreTimestamp</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#000>cqExtUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTagsCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTagsCode</span><span style=color:#ce5c00;font-weight:700>());</span>

                <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>extAddr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumeQueueExt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cqExtUnit</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isExtAddr</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>extAddr</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>tagsCode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>extAddr</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Save consume queue extend fail, So just save tagsCode! {}, topic:{}, queueId:{}, offset:{}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cqExtUnit</span><span style=color:#ce5c00;font-weight:700>,</span>
                        <span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>queueId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCommitLogOffset</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putMessagePositionInfo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCommitLogOffset</span><span style=color:#ce5c00;font-weight:700>(),</span>
                <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgSize</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>tagsCode</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumeQueueOffset</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStoreConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getBrokerRole</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>BrokerRole</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SLAVE</span> <span style=color:#ce5c00;font-weight:700>||</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStoreConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isEnableDLegerCommitLog</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStoreCheckpoint</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>setPhysicMsgTimestamp</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStoreTimestamp</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStoreCheckpoint</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>setLogicsMsgTimestamp</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStoreTimestamp</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// XXX: warn and notify me
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[BUG]put commit log position info to &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>topic</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;:&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>queueId</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCommitLogOffset</span><span style=color:#ce5c00;font-weight:700>()</span>
                    <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; failed, retry &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; times&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1000</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// XXX: warn and notify me
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[BUG]consume queue can not write, {} {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>queueId</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRunningFlags</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>makeLogicsQueueError</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面代码通过处理 <strong><code>putMessagePositionInfo</code></strong> 方法处理数据：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>putMessagePositionInfo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>tagsCode</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>cqOffset</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>maxPhysicOffset</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Maybe try to build consume queue repeatedly maxPhysicOffset={} phyOffset={}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>maxPhysicOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>byteBufferIndex</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>flip</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>byteBufferIndex</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>limit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CQ_STORE_UNIT_SIZE</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>byteBufferIndex</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putLong</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>byteBufferIndex</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>byteBufferIndex</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putLong</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tagsCode</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>expectLogicOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cqOffset</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>CQ_STORE_UNIT_SIZE</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#000>MappedFile</span> <span style=color:#000>mappedFile</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mappedFileQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLastMappedFile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expectLogicOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mappedFile</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mappedFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isFirstCreateInQueue</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>cqOffset</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>mappedFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWrotePosition</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>minLogicOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>expectLogicOffset</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mappedFileQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setFlushedWhere</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expectLogicOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mappedFileQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCommittedWhere</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expectLogicOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fillPreBlank</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mappedFile</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>expectLogicOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;fill pre blank space &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>mappedFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getFileName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>expectLogicOffset</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; &#34;</span>
                    <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>mappedFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWrotePosition</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cqOffset</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>currentLogicOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mappedFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWrotePosition</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>mappedFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getFileFromOffset</span><span style=color:#ce5c00;font-weight:700>();</span>

                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expectLogicOffset</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>currentLogicOffset</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Build  consume queue repeatedly, expectLogicOffset: {} currentLogicOffset: {} Topic: {} QID: {} Diff: {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                        <span style=color:#000>expectLogicOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>currentLogicOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>queueId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>expectLogicOffset</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>currentLogicOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>

                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expectLogicOffset</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>currentLogicOffset</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>LOG_ERROR</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span>
                        <span style=color:#4e9a06>&#34;[BUG]logic queue order maybe wrong, expectLogicOffset: {} currentLogicOffset: {} Topic: {} QID: {} Diff: {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                        <span style=color:#000>expectLogicOffset</span><span style=color:#ce5c00;font-weight:700>,</span>
                        <span style=color:#000>currentLogicOffset</span><span style=color:#ce5c00;font-weight:700>,</span>
                        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>topic</span><span style=color:#ce5c00;font-weight:700>,</span>
                        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>queueId</span><span style=color:#ce5c00;font-weight:700>,</span>
                        <span style=color:#000>expectLogicOffset</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>currentLogicOffset</span>
                    <span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>maxPhysicOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>mappedFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>appendMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>byteBufferIndex</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>array</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>后续的数据其实和CommitLog的数据差不多，都是通过MappedFile进行数据落地。</p><h3 id=3-总结>3. 总结</h3><p>总结一下ConsumeQueue生成的过程：</p><ol><li>启动一个ReputMessageService服务线程</li><li>然后根据reputFromOffset去读取本次的CommitLog数据（没有或者有）</li><li>将每条数据包装为DispatchRequest</li><li>DefaultMessageStore.doDispatch的方法进行处理数据，内部主要是通过CommitLogDispatcher的实现来进行处理</li><li>生成完ConsumeQueue纪录后的后续处理</li><li>重复2-4的步骤</li></ol><blockquote><p>每次处理完成一轮后会睡1毫秒的时间。并不是消息生成端发送了消息消费端就能够里面消费数据，而是要经过处理后生成ConsumeQueue才能消费。</p></blockquote><p>上面说了能够消费的数据需要将CommitLog转化成为ConsumeQueue才能进行消费下面就来看一下，进行验证，将 <strong>ReputMessageService</strong> 的睡眠时间改为一分钟代码如下：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getServiceName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; service started&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isStopped</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//Thread.sleep(1);
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//将睡眠时间改为1分钟
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MINUTES</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doReput</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getServiceName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; service has exception. &#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getServiceName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; service end&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>启动修改后的MQ Broker。</p><p><img src="https://github.com/mxsm/picture/blob/main/rocketmq/ConsumeQueue%E7%9D%A1%E7%9C%A0%E6%97%B6%E9%97%B4%E4%BF%AE%E6%94%B9.gif?raw=true" alt></p><p>然后启动消费者，同时用生产者发送消息：</p><p><img src="https://github.com/mxsm/picture/blob/main/rocketmq/ConsumeQueue%E7%9D%A1%E7%9C%A0%E6%97%B6%E9%97%B4%E4%BF%AE%E6%94%B9-1.gif?raw=true" alt></p><p>看一下两个时间的间隔：</p><p>1623405444983(发送时间)=2021-06-11 17:57:24</p><p>1623405552338(消费时间)=2021-06-11 17:59:12</p><p>通过两个时间发现不是立马进行消费。所以验证了前面的猜测。</p><p><strong>每次处理完成一轮后会睡1毫秒的时间。并不是消息生成端发送了消息消费端就能够里面消费数据，而是要经过处理后生成ConsumeQueue才能消费。</strong></p></div><div class=td-content style=page-break-before:always><h1 id=pg-dfb0d002a8796933e78fa9fb8fb118e1>7.6 - RocketMQ源码解析-Broker接收拉取消息</h1><blockquote><p>以下源码基于Rocket MQ 4.7.0</p></blockquote><p>引言：Broker对于不同消息有不同的NettyRequestProcessor，对于DefaultMQPushConsumer的pull请求对应的Processor为PullMessageProcessor。</p><h3 id=pullmessageprocessor>PullMessageProcessor</h3><p>通过上面的分析可以知道，处理DefaultMQPushConsumer的pull请求主要是通过 <strong><code>PullMessageProcessor.processRequest</code></strong> 方法来实现的：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param channel
</span><span style=color:#8f5902;font-style:italic>     * @param request 请求的command
</span><span style=color:#8f5902;font-style:italic>     * @param brokerAllowSuspend 是否允许挂起
</span><span style=color:#8f5902;font-style:italic>     * @return
</span><span style=color:#8f5902;font-style:italic>     * @throws RemotingCommandException
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>RemotingCommand</span> <span style=color:#000>processRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Channel</span> <span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RemotingCommand</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>brokerAllowSuspend</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>RemotingCommandException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>RemotingCommand</span> <span style=color:#000>response</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RemotingCommand</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createResponseCommand</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PullMessageResponseHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PullMessageResponseHeader</span> <span style=color:#000>responseHeader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PullMessageResponseHeader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readCustomHeader</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PullMessageRequestHeader</span> <span style=color:#000>requestHeader</span> <span style=color:#ce5c00;font-weight:700>=</span>
            <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PullMessageRequestHeader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>decodeCommandCustomHeader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PullMessageRequestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setOpaque</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOpaque</span><span style=color:#ce5c00;font-weight:700>());</span>

        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;receive PullMessage request command, {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#8f5902;font-style:italic>//判断Broker是否可读
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>PermName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isReadable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getBrokerPermission</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NO_PERMISSION</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setRemark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>format</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;the broker[%s] pulling message is forbidden&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getBrokerIP1</span><span style=color:#ce5c00;font-weight:700>()));</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// 判断consumerGroup是否存在-如果不存在判断是否允许自动创建，可以自动创建就直接创建消费者组(权限控制)
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>SubscriptionGroupConfig</span> <span style=color:#000>subscriptionGroupConfig</span> <span style=color:#ce5c00;font-weight:700>=</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSubscriptionGroupManager</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>findSubscriptionGroupConfig</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>subscriptionGroupConfig</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SUBSCRIPTION_GROUP_NOT_EXIST</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setRemark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>format</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;subscription group [%s] does not exist, %s&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>FAQUrl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>suggestTodo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>FAQUrl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SUBSCRIPTION_GROUP_NOT_EXIST</span><span style=color:#ce5c00;font-weight:700>)));</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// 判断consumerGroup的消费状态是否Enable
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>subscriptionGroupConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isConsumeEnable</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NO_PERMISSION</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setRemark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;subscription group no permission, &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>hasSuspendFlag</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PullSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasSuspendFlag</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSysFlag</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>hasCommitOffsetFlag</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PullSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasCommitOffsetFlag</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSysFlag</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>hasSubscriptionFlag</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PullSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasSubscriptionFlag</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSysFlag</span><span style=color:#ce5c00;font-weight:700>());</span>

        <span style=color:#8f5902;font-style:italic>//获取挂起超时时间
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>suspendTimeoutMillisLong</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>hasSuspendFlag</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSuspendTimeoutMillis</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#8f5902;font-style:italic>//判断主题配置是否为空
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>TopicConfig</span> <span style=color:#000>topicConfig</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopicConfigManager</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>selectTopicConfig</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>topicConfig</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;the topic {} not exist, consumer: {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>RemotingHelper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseChannelRemoteAddr</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TOPIC_NOT_EXIST</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setRemark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>format</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;topic[%s] not exist, apply first please! %s&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>FAQUrl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>suggestTodo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>FAQUrl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>APPLY_TOPIC_URL</span><span style=color:#ce5c00;font-weight:700>)));</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>//判断主题是否可读
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>PermName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isReadable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topicConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPerm</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NO_PERMISSION</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setRemark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;the topic[&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;] pulling message is forbidden&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>//判断请求消息队列ID是否合法
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueId</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueId</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>topicConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getReadQueueNums</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>String</span> <span style=color:#000>errorInfo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>format</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;queueId[%d] is illegal, topic:[%s] topicConfig.readQueueNums:[%d] consumer:[%s]&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueId</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>topicConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getReadQueueNums</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remoteAddress</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>errorInfo</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SYSTEM_ERROR</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setRemark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>errorInfo</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#000>SubscriptionData</span> <span style=color:#000>subscriptionData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>ConsumerFilterData</span> <span style=color:#000>consumerFilterData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#8f5902;font-style:italic>// 有设置subscribe flag,表示第一次pull或者需要更新filter
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasSubscriptionFlag</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 获得订阅信息，用于过滤消息
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>subscriptionData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>FilterAPI</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>build</span><span style=color:#ce5c00;font-weight:700>(</span>
                    <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSubscription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getExpressionType</span><span style=color:#ce5c00;font-weight:700>()</span>
                <span style=color:#ce5c00;font-weight:700>);</span>

                <span style=color:#8f5902;font-style:italic>// 是否使用了表达式过滤
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>ExpressionType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTagType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>subscriptionData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getExpressionType</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>consumerFilterData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ConsumerFilterManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>build</span><span style=color:#ce5c00;font-weight:700>(</span>
                        <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSubscription</span><span style=color:#ce5c00;font-weight:700>(),</span>
                        <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getExpressionType</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSubVersion</span><span style=color:#ce5c00;font-weight:700>()</span>
                    <span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>assert</span> <span style=color:#000>consumerFilterData</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Parse the consumer&#39;s subscription[{}] failed, group: {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSubscription</span><span style=color:#ce5c00;font-weight:700>(),</span>
                    <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SUBSCRIPTION_PARSE_FAILED</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setRemark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;parse the consumer&#39;s subscription failed&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 没有设置subscribe flag，表示之前已经订阅过了,对比订阅条件是否一致
</span><span style=color:#8f5902;font-style:italic></span>
            <span style=color:#8f5902;font-style:italic>// 对于同一个ConsumerGroup下的多个consumer客户端，Broker要求订阅参数设置必须要是一致的，要不然会造成数据混乱
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>ConsumerGroupInfo</span> <span style=color:#000>consumerGroupInfo</span> <span style=color:#ce5c00;font-weight:700>=</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerManager</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getConsumerGroupInfo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>consumerGroupInfo</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;the consumer&#39;s group info not exist, group: {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SUBSCRIPTION_NOT_EXIST</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setRemark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;the consumer&#39;s group info not exist&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>FAQUrl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>suggestTodo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>FAQUrl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SAME_GROUP_DIFFERENT_TOPIC</span><span style=color:#ce5c00;font-weight:700>));</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>subscriptionGroupConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isConsumeBroadcastEnable</span><span style=color:#ce5c00;font-weight:700>()</span>
                <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>consumerGroupInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageModel</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>MessageModel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>BROADCASTING</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NO_PERMISSION</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setRemark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;the consumer group[&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;] can not consume by broadcast way&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#000>subscriptionData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>consumerGroupInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findSubscriptionData</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>subscriptionData</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;the consumer&#39;s subscription not exist, group: {}, topic:{}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SUBSCRIPTION_NOT_EXIST</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setRemark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;the consumer&#39;s subscription not exist&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>FAQUrl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>suggestTodo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>FAQUrl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SAME_GROUP_DIFFERENT_TOPIC</span><span style=color:#ce5c00;font-weight:700>));</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>subscriptionData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSubVersion</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSubVersion</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The broker&#39;s subscription is not latest, group: {} {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(),</span>
                    <span style=color:#000>subscriptionData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSubString</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SUBSCRIPTION_NOT_LATEST</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setRemark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;the consumer&#39;s subscription not latest&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>ExpressionType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTagType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>subscriptionData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getExpressionType</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>consumerFilterData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerFilterManager</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span>
                    <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>consumerFilterData</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>FILTER_DATA_NOT_EXIST</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setRemark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The broker&#39;s consumer filter data is not exist!Your expression may be wrong!&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>consumerFilterData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClientVersion</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSubVersion</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The broker&#39;s consumer filter data is not latest, group: {}, topic: {}, serverV: {}, clientV: {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                        <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>consumerFilterData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClientVersion</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSubVersion</span><span style=color:#ce5c00;font-weight:700>());</span>
                    <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>FILTER_DATA_NOT_LATEST</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setRemark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;the consumer&#39;s consumer filter data not latest&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>ExpressionType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTagType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>subscriptionData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getExpressionType</span><span style=color:#ce5c00;font-weight:700>())</span>
            <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isEnablePropertyFilter</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SYSTEM_ERROR</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setRemark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The broker does not support consumer to filter message by &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>subscriptionData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getExpressionType</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>//创建消息过滤器
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>MessageFilter</span> <span style=color:#000>messageFilter</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isFilterSupportRetry</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>messageFilter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ExpressionForRetryMessageFilter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>subscriptionData</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>consumerFilterData</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerFilterManager</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>messageFilter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ExpressionMessageFilter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>subscriptionData</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>consumerFilterData</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerFilterManager</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>//读取消息
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>GetMessageResult</span> <span style=color:#000>getMessageResult</span> <span style=color:#ce5c00;font-weight:700>=</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStore</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span>
                <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueId</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueOffset</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMaxMsgNums</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>messageFilter</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getMessageResult</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setRemark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getMessageResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStatus</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>name</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#000>responseHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setNextBeginOffset</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getMessageResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNextBeginOffset</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#000>responseHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setMinOffset</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getMessageResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMinOffset</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#000>responseHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setMaxOffset</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getMessageResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMaxOffset</span><span style=color:#ce5c00;font-weight:700>());</span>

            <span style=color:#8f5902;font-style:italic>//判断是否建议从slave读取数据---默认为false
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getMessageResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSuggestPullingFromSlave</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>responseHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSuggestWhichBrokerId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>subscriptionGroupConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWhichBrokerWhenConsumeSlowly</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>responseHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSuggestWhichBrokerId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MixAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MASTER_ID</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#204a87;font-weight:700>switch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStoreConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getBrokerRole</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>ASYNC_MASTER</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>SYNC_MASTER</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>SLAVE</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#8f5902;font-style:italic>// 如果当前broker是slave，并且不支持read，则提示客户端从master读
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isSlaveReadEnable</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PULL_RETRY_IMMEDIATELY</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#000>responseHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSuggestWhichBrokerId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MixAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MASTER_ID</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isSlaveReadEnable</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 消费太慢重定向到另外一台机器消费
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getMessageResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSuggestPullingFromSlave</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>responseHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSuggestWhichBrokerId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>subscriptionGroupConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWhichBrokerWhenConsumeSlowly</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#8f5902;font-style:italic>// consume ok
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>responseHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSuggestWhichBrokerId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>subscriptionGroupConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerId</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>responseHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSuggestWhichBrokerId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MixAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MASTER_ID</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>//将读取的消息状态转换为Response的状态code
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>switch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getMessageResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStatus</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>FOUND</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SUCCESS</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>MESSAGE_WAS_REMOVING</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PULL_RETRY_IMMEDIATELY</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>NO_MATCHED_LOGIC_QUEUE</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>NO_MESSAGE_IN_QUEUE</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueOffset</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PULL_OFFSET_MOVED</span><span style=color:#ce5c00;font-weight:700>);</span>

                        <span style=color:#8f5902;font-style:italic>// XXX: warn and notify me
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;the broker store no queue data, fix the request offset {} to {}, Topic: {} QueueId: {} Consumer Group: {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                            <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueOffset</span><span style=color:#ce5c00;font-weight:700>(),</span>
                            <span style=color:#000>getMessageResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNextBeginOffset</span><span style=color:#ce5c00;font-weight:700>(),</span>
                            <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span>
                            <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueId</span><span style=color:#ce5c00;font-weight:700>(),</span>
                            <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>()</span>
                        <span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PULL_NOT_FOUND</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>NO_MATCHED_MESSAGE</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PULL_RETRY_IMMEDIATELY</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>OFFSET_FOUND_NULL</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PULL_NOT_FOUND</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>OFFSET_OVERFLOW_BADLY</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PULL_OFFSET_MOVED</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#8f5902;font-style:italic>// XXX: warn and notify me
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;the request offset: {} over flow badly, broker max offset: {}, consumer: {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                        <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueOffset</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>getMessageResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMaxOffset</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remoteAddress</span><span style=color:#ce5c00;font-weight:700>());</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>OFFSET_OVERFLOW_ONE</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PULL_NOT_FOUND</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>OFFSET_TOO_SMALL</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PULL_OFFSET_MOVED</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;the request offset too small. group={}, topic={}, requestOffset={}, brokerMinOffset={}, clientIp={}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                        <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueOffset</span><span style=color:#ce5c00;font-weight:700>(),</span>
                        <span style=color:#000>getMessageResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMinOffset</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remoteAddress</span><span style=color:#ce5c00;font-weight:700>());</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>default</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#204a87;font-weight:700>assert</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasConsumeMessageHook</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>ConsumeMessageContext</span> <span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConsumeMessageContext</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTopic</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setQueueId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueId</span><span style=color:#ce5c00;font-weight:700>());</span>

                <span style=color:#000>String</span> <span style=color:#000>owner</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getExtFields</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BrokerStatsManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>COMMERCIAL_OWNER</span><span style=color:#ce5c00;font-weight:700>);</span>

                <span style=color:#204a87;font-weight:700>switch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCode</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SUCCESS</span><span style=color:#ce5c00;font-weight:700>:</span>
                        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>commercialBaseCount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getCommercialBaseCount</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>incValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getMessageResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgCount4Commercial</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>commercialBaseCount</span><span style=color:#ce5c00;font-weight:700>;</span>

                        <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCommercialRcvStats</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BrokerStatsManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>StatsType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RCV_SUCCESS</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCommercialRcvTimes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>incValue</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCommercialRcvSize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getMessageResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBufferTotalSize</span><span style=color:#ce5c00;font-weight:700>());</span>
                        <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCommercialOwner</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>owner</span><span style=color:#ce5c00;font-weight:700>);</span>

                        <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PULL_NOT_FOUND</span><span style=color:#ce5c00;font-weight:700>:</span>
                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>brokerAllowSuspend</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

                            <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCommercialRcvStats</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BrokerStatsManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>StatsType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RCV_EPOLLS</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCommercialRcvTimes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCommercialOwner</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>owner</span><span style=color:#ce5c00;font-weight:700>);</span>

                        <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PULL_RETRY_IMMEDIATELY</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PULL_OFFSET_MOVED</span><span style=color:#ce5c00;font-weight:700>:</span>
                        <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCommercialRcvStats</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BrokerStatsManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>StatsType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RCV_EPOLLS</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCommercialRcvTimes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCommercialOwner</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>owner</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>default</span><span style=color:#ce5c00;font-weight:700>:</span>
                        <span style=color:#204a87;font-weight:700>assert</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>

                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>executeConsumeMessageHookBefore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>//进一步处理返回的结果
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>switch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCode</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SUCCESS</span><span style=color:#ce5c00;font-weight:700>:</span>

                    <span style=color:#8f5902;font-style:italic>//更新topic获取的消息数量信息
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerStatsManager</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>incGroupGetNums</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span>
                        <span style=color:#000>getMessageResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageCount</span><span style=color:#ce5c00;font-weight:700>());</span>

                    <span style=color:#8f5902;font-style:italic>//更新统计的消息大小
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerStatsManager</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>incGroupGetSize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span>
                        <span style=color:#000>getMessageResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBufferTotalSize</span><span style=color:#ce5c00;font-weight:700>());</span>

                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerStatsManager</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>incBrokerGetNums</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getMessageResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageCount</span><span style=color:#ce5c00;font-weight:700>());</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isTransferMsgByHeap</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>beginTimeMills</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStore</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>now</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readGetMessageResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getMessageResult</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueId</span><span style=color:#ce5c00;font-weight:700>());</span>
                        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerStatsManager</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>incGroupGetLatency</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(),</span>
                            <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueId</span><span style=color:#ce5c00;font-weight:700>(),</span>
                            <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStore</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>now</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>beginTimeMills</span><span style=color:#ce5c00;font-weight:700>));</span>
                        <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBody</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>FileRegion</span> <span style=color:#000>fileRegion</span> <span style=color:#ce5c00;font-weight:700>=</span>
                                <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ManyMessageTransfer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>encodeHeader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getMessageResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBufferTotalSize</span><span style=color:#ce5c00;font-weight:700>()),</span> <span style=color:#000>getMessageResult</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>writeAndFlush</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fileRegion</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>addListener</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ChannelFutureListener</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#5c35cc;font-weight:700>@Override</span>
                                <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>operationComplete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ChannelFuture</span> <span style=color:#000>future</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                    <span style=color:#000>getMessageResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>release</span><span style=color:#ce5c00;font-weight:700>();</span>
                                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSuccess</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;transfer many message by pagecache failed, {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remoteAddress</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cause</span><span style=color:#ce5c00;font-weight:700>());</span>
                                    <span style=color:#ce5c00;font-weight:700>}</span>
                                <span style=color:#ce5c00;font-weight:700>}</span>
                            <span style=color:#ce5c00;font-weight:700>});</span>
                        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;transfer many message by pagecache exception&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#000>getMessageResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>release</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>

                        <span style=color:#000>response</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>

                <span style=color:#8f5902;font-style:italic>//没有读取到消息，则hold住请求，有新消息时唤醒
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>//等待超时后还是没读到brokerAllowSuspend=false
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PULL_NOT_FOUND</span><span style=color:#ce5c00;font-weight:700>:</span>

                    <span style=color:#8f5902;font-style:italic>//brokerAllowSuspend=ture 方法传入
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>brokerAllowSuspend</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>hasSuspendFlag</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>pollingTimeMills</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>suspendTimeoutMillisLong</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isLongPollingEnable</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>pollingTimeMills</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getShortPollingTimeMills</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>

                        <span style=color:#000>String</span> <span style=color:#000>topic</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueOffset</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>queueId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueId</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#000>PullRequest</span> <span style=color:#000>pullRequest</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PullRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pollingTimeMills</span><span style=color:#ce5c00;font-weight:700>,</span>
                            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStore</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>now</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>subscriptionData</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>messageFilter</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPullRequestHoldService</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>suspendPullRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>queueId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#000>response</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>

                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PULL_RETRY_IMMEDIATELY</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#8f5902;font-style:italic>// 消费开始的offset不正确
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PULL_OFFSET_MOVED</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStoreConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getBrokerRole</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>BrokerRole</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SLAVE</span>
                        <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStoreConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isOffsetCheckInSlave</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>MessageQueue</span> <span style=color:#000>mq</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTopic</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>());</span>
                        <span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setQueueId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueId</span><span style=color:#ce5c00;font-weight:700>());</span>
                        <span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBrokerName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getBrokerName</span><span style=color:#ce5c00;font-weight:700>());</span>

                        <span style=color:#000>OffsetMovedEvent</span> <span style=color:#000>event</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>OffsetMovedEvent</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#000>event</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>());</span>
                        <span style=color:#000>event</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setMessageQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#000>event</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setOffsetRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueOffset</span><span style=color:#ce5c00;font-weight:700>());</span>
                        <span style=color:#000>event</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setOffsetNew</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getMessageResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNextBeginOffset</span><span style=color:#ce5c00;font-weight:700>());</span>
                        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>generateOffsetMovedEvent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>event</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span>
                            <span style=color:#4e9a06>&#34;PULL_OFFSET_MOVED:correction offset. topic={}, groupId={}, requestOffset={}, newOffset={}, suggestBrokerId={}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                            <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>event</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOffsetRequest</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>event</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOffsetNew</span><span style=color:#ce5c00;font-weight:700>(),</span>
                            <span style=color:#000>responseHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSuggestWhichBrokerId</span><span style=color:#ce5c00;font-weight:700>());</span>
                    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>responseHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSuggestWhichBrokerId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>subscriptionGroupConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerId</span><span style=color:#ce5c00;font-weight:700>());</span>
                        <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PULL_RETRY_IMMEDIATELY</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;PULL_OFFSET_MOVED:none correction. topic={}, groupId={}, requestOffset={}, suggestBrokerId={}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                            <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueOffset</span><span style=color:#ce5c00;font-weight:700>(),</span>
                            <span style=color:#000>responseHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSuggestWhichBrokerId</span><span style=color:#ce5c00;font-weight:700>());</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>

                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>default</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#204a87;font-weight:700>assert</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SYSTEM_ERROR</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setRemark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;store getMessage return null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>storeOffsetEnable</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>brokerAllowSuspend</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>storeOffsetEnable</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>storeOffsetEnable</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>hasCommitOffsetFlag</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>storeOffsetEnable</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>storeOffsetEnable</span>
            <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStoreConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getBrokerRole</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>BrokerRole</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SLAVE</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>storeOffsetEnable</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//持久化储存offerSet
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerOffsetManager</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>commitOffset</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RemotingHelper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseChannelRemoteAddr</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>),</span>
                <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueId</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCommitOffset</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从上面的分析可以知道：根据 <strong><code>Topic、queueId、offfset</code></strong> 以及过滤器从 <strong><code>MessageStore</code></strong> 获取消息。如果成功获取到消息根据配置有两种返回的方式：</p><ol><li><code>ByteBuffer</code>中将数据读取到response中（经过堆）</li><li>netty直接读取<code>ByteBuffer</code>，将消息写给客户端</li></ol><h3 id=defaultmessagestoregetmessage>DefaultMessageStore.getMessage</h3><p>下面来看一下这个方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>GetMessageResult</span> <span style=color:#000>getMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>group</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>queueId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>maxMsgNums</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MessageFilter</span> <span style=color:#000>messageFilter</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shutdown</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;message store has shutdown, so getMessage is forbidden&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>runningFlags</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isReadable</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;message store is not readable, so getMessage is forbidden &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>runningFlags</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getFlagBits</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>beginTime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSystemClock</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>now</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#000>GetMessageStatus</span> <span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>GetMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NO_MESSAGE_IN_QUEUE</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>nextBeginOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>minOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>maxOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#000>GetMessageResult</span> <span style=color:#000>getResult</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>GetMessageResult</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>maxOffsetPy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMaxOffset</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#8f5902;font-style:italic>//找到对应的消费队列
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>ConsumeQueue</span> <span style=color:#000>consumeQueue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>findConsumeQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>queueId</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>consumeQueue</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>minOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>consumeQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMinOffsetInQueue</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>maxOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>consumeQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMaxOffsetInQueue</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>maxOffset</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>GetMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NO_MESSAGE_IN_QUEUE</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>nextBeginOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nextOffsetCorrection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>minOffset</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>GetMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>OFFSET_TOO_SMALL</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>nextBeginOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nextOffsetCorrection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>minOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>maxOffset</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>GetMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>OFFSET_OVERFLOW_ONE</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>nextBeginOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nextOffsetCorrection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>maxOffset</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>GetMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>OFFSET_OVERFLOW_BADLY</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>minOffset</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>nextBeginOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nextOffsetCorrection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>minOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>nextBeginOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nextOffsetCorrection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>maxOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>SelectMappedBufferResult</span> <span style=color:#000>bufferConsumeQueue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>consumeQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getIndexBuffer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bufferConsumeQueue</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>GetMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NO_MATCHED_MESSAGE</span><span style=color:#ce5c00;font-weight:700>;</span>

                        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>nextPhyFileStartOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MIN_VALUE</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>maxPhyOffsetPulling</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>

                        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>maxFilterMessageCount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>max</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>16000</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>maxMsgNums</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>ConsumeQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CQ_STORE_UNIT_SIZE</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>diskFallRecorded</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageStoreConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDiskFallRecorded</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#000>ConsumeQueueExt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CqExtUnit</span> <span style=color:#000>cqExtUnit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConsumeQueueExt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CqExtUnit</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>bufferConsumeQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSize</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>maxFilterMessageCount</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>ConsumeQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CQ_STORE_UNIT_SIZE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>offsetPy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bufferConsumeQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getByteBuffer</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getLong</span><span style=color:#ce5c00;font-weight:700>();</span>
                            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>sizePy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bufferConsumeQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getByteBuffer</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getInt</span><span style=color:#ce5c00;font-weight:700>();</span>
                            <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>tagsCode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bufferConsumeQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getByteBuffer</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getLong</span><span style=color:#ce5c00;font-weight:700>();</span>

                            <span style=color:#000>maxPhyOffsetPulling</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>offsetPy</span><span style=color:#ce5c00;font-weight:700>;</span>

                            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nextPhyFileStartOffset</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MIN_VALUE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offsetPy</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>nextPhyFileStartOffset</span><span style=color:#ce5c00;font-weight:700>)</span>
                                    <span style=color:#204a87;font-weight:700>continue</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>

                            <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isInDisk</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>checkInDiskByCommitOffset</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offsetPy</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>maxOffsetPy</span><span style=color:#ce5c00;font-weight:700>);</span>

                            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTheBatchFull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sizePy</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>maxMsgNums</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBufferTotalSize</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>getResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageCount</span><span style=color:#ce5c00;font-weight:700>(),</span>
                                <span style=color:#000>isInDisk</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>

                            <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>extRet</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>isTagsCodeLegal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>consumeQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isExtAddr</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tagsCode</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#000>extRet</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>consumeQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getExt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tagsCode</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cqExtUnit</span><span style=color:#ce5c00;font-weight:700>);</span>
                                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>extRet</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                    <span style=color:#000>tagsCode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cqExtUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTagsCode</span><span style=color:#ce5c00;font-weight:700>();</span>
                                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                    <span style=color:#8f5902;font-style:italic>// can&#39;t find ext content.Client will filter messages by tag also.
</span><span style=color:#8f5902;font-style:italic></span>                                    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[BUG] can&#39;t find consume queue extend file content!addr={}, offsetPy={}, sizePy={}, topic={}, group={}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                                        <span style=color:#000>tagsCode</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>offsetPy</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sizePy</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>group</span><span style=color:#ce5c00;font-weight:700>);</span>
                                    <span style=color:#000>isTagsCodeLegal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
                                <span style=color:#ce5c00;font-weight:700>}</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>

                            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>messageFilter</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span>
                                <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>messageFilter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isMatchedByConsumeQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isTagsCodeLegal</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>tagsCode</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>extRet</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>cqExtUnit</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBufferTotalSize</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                    <span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>GetMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NO_MATCHED_MESSAGE</span><span style=color:#ce5c00;font-weight:700>;</span>
                                <span style=color:#ce5c00;font-weight:700>}</span>

                                <span style=color:#204a87;font-weight:700>continue</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>

                            <span style=color:#000>SelectMappedBufferResult</span> <span style=color:#000>selectResult</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offsetPy</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sizePy</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>selectResult</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBufferTotalSize</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                    <span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>GetMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MESSAGE_WAS_REMOVING</span><span style=color:#ce5c00;font-weight:700>;</span>
                                <span style=color:#ce5c00;font-weight:700>}</span>

                                <span style=color:#000>nextPhyFileStartOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rollNextFile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offsetPy</span><span style=color:#ce5c00;font-weight:700>);</span>
                                <span style=color:#204a87;font-weight:700>continue</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>

                            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>messageFilter</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span>
                                <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>messageFilter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isMatchedByCommitLog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>selectResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getByteBuffer</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>slice</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBufferTotalSize</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                    <span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>GetMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NO_MATCHED_MESSAGE</span><span style=color:#ce5c00;font-weight:700>;</span>
                                <span style=color:#ce5c00;font-weight:700>}</span>
                                <span style=color:#8f5902;font-style:italic>// release...
</span><span style=color:#8f5902;font-style:italic></span>                                <span style=color:#000>selectResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>release</span><span style=color:#ce5c00;font-weight:700>();</span>
                                <span style=color:#204a87;font-weight:700>continue</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>

                            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>storeStatsService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getGetMessageTransferedMsgCount</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>incrementAndGet</span><span style=color:#ce5c00;font-weight:700>();</span>
                            <span style=color:#000>getResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>selectResult</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>GetMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>FOUND</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#000>nextPhyFileStartOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MIN_VALUE</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>

                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>diskFallRecorded</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>fallBehind</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>maxOffsetPy</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>maxPhyOffsetPulling</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#000>brokerStatsManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>recordDiskFallBehindSize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>group</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>queueId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>fallBehind</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>

                        <span style=color:#000>nextBeginOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>ConsumeQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CQ_STORE_UNIT_SIZE</span><span style=color:#ce5c00;font-weight:700>);</span>

                        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>diff</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>maxOffsetPy</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>maxPhyOffsetPulling</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>memory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StoreUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TOTAL_PHYSICAL_MEMORY_SIZE</span>
                            <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageStoreConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAccessMessageInMemoryMaxRatio</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>100</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>0</span><span style=color:#ce5c00;font-weight:700>));</span>
                        <span style=color:#000>getResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSuggestPullingFromSlave</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>diff</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>memory</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>

                        <span style=color:#000>bufferConsumeQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>release</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>GetMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>OFFSET_FOUND_NULL</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#000>nextBeginOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nextOffsetCorrection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>consumeQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rollNextFile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>));</span>
                    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;consumer request topic: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>topic</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;offset: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; minOffset: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>minOffset</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; maxOffset: &#34;</span>
                        <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>maxOffset</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;, but access logic queue failed.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>GetMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NO_MATCHED_LOGIC_QUEUE</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>nextBeginOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nextOffsetCorrection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>GetMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>FOUND</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>status</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>storeStatsService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getGetMessageTimesTotalFound</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>incrementAndGet</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>storeStatsService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getGetMessageTimesTotalMiss</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>incrementAndGet</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>elapsedTime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSystemClock</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>now</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>beginTime</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>storeStatsService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setGetMessageEntireTimeMax</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elapsedTime</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#000>getResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setStatus</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>status</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>getResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setNextBeginOffset</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nextBeginOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>getResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setMaxOffset</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>maxOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>getResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setMinOffset</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>minOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getResult</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>首先根据topic和queueId找到对应的ConsumeQueue。然后找到对应的MappedFile获取对应数量的数据，然后根据tag进行过滤出来对应的数据。</p><h3 id=挂起请求处理>挂起请求处理</h3><p>之前PullRequest请求处理中有这样一段代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PULL_NOT_FOUND</span><span style=color:#ce5c00;font-weight:700>:</span>

                    <span style=color:#8f5902;font-style:italic>//brokerAllowSuspend=ture 方法传入
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>brokerAllowSuspend</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>hasSuspendFlag</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>pollingTimeMills</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>suspendTimeoutMillisLong</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isLongPollingEnable</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>pollingTimeMills</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getShortPollingTimeMills</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>

                        <span style=color:#000>String</span> <span style=color:#000>topic</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueOffset</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>queueId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueId</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#000>PullRequest</span> <span style=color:#000>pullRequest</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PullRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pollingTimeMills</span><span style=color:#ce5c00;font-weight:700>,</span>
                            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStore</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>now</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>subscriptionData</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>messageFilter</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPullRequestHoldService</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>suspendPullRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>queueId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#000>response</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这段代码就是在没有找到Message的时候去挂起请求，通过PullRequestHoldService#suspendPullRequest来挂起请求：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>suspendPullRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>queueId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PullRequest</span> <span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>String</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>buildKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>queueId</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>ManyPullRequest</span> <span style=color:#000>mpr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pullRequestTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>mpr</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>mpr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ManyPullRequest</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>ManyPullRequest</span> <span style=color:#000>prev</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pullRequestTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putIfAbsent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mpr</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prev</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>mpr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>prev</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#000>mpr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addPullRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>我们是不是在BrokerController启动中看到了PullRequestHoldService(继承ServiceThread)被启动了，所以我们应该去看看PullRequestHoldService做了什么，所以首先去看他的run方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;{} service started&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getServiceName</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isStopped</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>//是否开启了长轮询
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isLongPollingEnable</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>//长轮询等待5s
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>waitForRunning</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>5</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>1000</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                   <span style=color:#8f5902;font-style:italic>//短轮询等待1s this.waitForRunning(this.brokerController.getBrokerConfig().getShortPollingTimeMills());
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#ce5c00;font-weight:700>}</span>

                <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>beginLockTimestamp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>systemClock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>now</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#8f5902;font-style:italic>//检查挂起的请求
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>checkHoldRequest</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>costTime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>systemClock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>now</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>beginLockTimestamp</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>costTime</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>5</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>1000</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[NOTIFYME] check hold request cost {} ms.&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>costTime</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getServiceName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; service has exception. &#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;{} service end&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getServiceName</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过调用 <strong><code>PullRequestHoldService#checkHoldRequest</code></strong> 方法来检查保存在这个里面的数据：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>checkHoldRequest</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pullRequestTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>keySet</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>kArray</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>split</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TOPIC_QUEUEID_SEPARATOR</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>2</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>kArray</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>String</span> <span style=color:#000>topic</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>kArray</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>];</span>
                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>queueId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>kArray</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>]);</span>
                <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStore</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getMaxOffsetInQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>queueId</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>//五秒钟通知一次
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>notifyMessageArriving</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>queueId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;check hold request failed. topic={}, queueId={}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>queueId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>看一下 <strong><code>PullRequestHoldService#notifyMessageArriving</code></strong> 方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>notifyMessageArriving</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>queueId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>maxOffset</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>notifyMessageArriving</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>queueId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>maxOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>notifyMessageArriving</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>queueId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>maxOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Long</span> <span style=color:#000>tagsCode</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>msgStoreTime</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>filterBitMap</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>String</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>buildKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>queueId</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>ManyPullRequest</span> <span style=color:#000>mpr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pullRequestTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mpr</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PullRequest</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>requestList</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mpr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cloneListAndClear</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestList</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PullRequest</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>replayList</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PullRequest</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>

                <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PullRequest</span> <span style=color:#000>request</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>requestList</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>newestOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>maxOffset</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>newestOffset</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPullFromThisOffset</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>newestOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStore</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getMaxOffsetInQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>queueId</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>

                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>newestOffset</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPullFromThisOffset</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>match</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageFilter</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isMatchedByConsumeQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tagsCode</span><span style=color:#ce5c00;font-weight:700>,</span>
                            <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConsumeQueueExt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CqExtUnit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tagsCode</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>msgStoreTime</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>filterBitMap</span><span style=color:#ce5c00;font-weight:700>));</span>
                        <span style=color:#8f5902;font-style:italic>// match by bit map, need eval again when properties is not null.
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>match</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>properties</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>match</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageFilter</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isMatchedByCommitLog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>

                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>match</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPullMessageProcessor</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>executeRequestWhenWakeup</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClientChannel</span><span style=color:#ce5c00;font-weight:700>(),</span>
                                    <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRequestCommand</span><span style=color:#ce5c00;font-weight:700>());</span>
                            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;execute request when wakeup failed.&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>
                            <span style=color:#204a87;font-weight:700>continue</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>

                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSuspendTimestamp</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTimeoutMillis</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPullMessageProcessor</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>executeRequestWhenWakeup</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClientChannel</span><span style=color:#ce5c00;font-weight:700>(),</span>
                                <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRequestCommand</span><span style=color:#ce5c00;font-weight:700>());</span>
                        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;execute request when wakeup failed.&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#204a87;font-weight:700>continue</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>

                    <span style=color:#000>replayList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>

                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>replayList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>mpr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addPullRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>replayList</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过 <strong><code>PullMessageProcessor#executeRequestWhenWakeup</code></strong> 来处理数据。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>executeRequestWhenWakeup</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Channel</span> <span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>RemotingCommand</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>RemotingCommandException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Runnable</span> <span style=color:#000>run</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>RemotingCommand</span> <span style=color:#000>response</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PullMessageProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>processRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>

                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>response</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setOpaque</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOpaque</span><span style=color:#ce5c00;font-weight:700>());</span>
                        <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>markResponseType</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>writeAndFlush</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>addListener</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ChannelFutureListener</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#5c35cc;font-weight:700>@Override</span>
                                <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>operationComplete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ChannelFuture</span> <span style=color:#000>future</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSuccess</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;processRequestWrapper response to {} failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                                            <span style=color:#000>future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>channel</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>remoteAddress</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cause</span><span style=color:#ce5c00;font-weight:700>());</span>
                                        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>());</span>
                                        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>());</span>
                                    <span style=color:#ce5c00;font-weight:700>}</span>
                                <span style=color:#ce5c00;font-weight:700>}</span>
                            <span style=color:#ce5c00;font-weight:700>});</span>
                        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;processRequestWrapper process request over, but response failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>());</span>
                            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>());</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RemotingCommandException</span> <span style=color:#000>e1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;excuteRequestWhenWakeup run&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e1</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>};</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPullMessageExecutor</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>submit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RequestTask</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>最终还是通过 <strong><code>PullMessageProcessor#processRequest</code></strong> 这个方法来处理数据，但是这里的brokerAllowSuspend=false意思就是只会挂起一次，不会无限制的挂起这个请求在没有消息来的时候。到这里就Broker接收完了</p></div><div class=td-content style=page-break-before:always><h1 id=pg-4d09b652a4bc68f5db4484f96fa278db>7.7 - RocketMQ源码解析-Broker故障恢复</h1><blockquote><p>以下源码基于Rocket MQ 4.7.0</p></blockquote><p>RocketMQ正常退出或者异常退出的时候，如果重新启动那么怎么恢复数据。接下来通过代码来分析这个过程。</p><h3 id=1broker故障恢复>1.Broker故障恢复</h3><p>在broker第一次启动或者重新启动的时候会调用这样的一段代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//BrokerController#initialize 中的方法
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>initialize</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>CloneNotSupportedException</span> <span style=color:#ce5c00;font-weight:700>{</span>
     <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>load</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从上面的代码可以知道，在broker进行初始的时候，会 <strong><code>MessageStore#load</code></strong> 方法，这个方法的默认实现为 <strong>DefaultMessageStore</strong> 。接下来看一下 load方法这里就是Broker恢复的入口：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>load</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//通过判断abort文件是否存在来判断是否正常退出
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>lastExitOK</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTempFileExist</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>scheduleMessageService</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>//解析延迟的等级-可以自己配置
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scheduleMessageService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>load</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>// 加载CommitLog
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>load</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#8f5902;font-style:italic>//加载ConsumeQueue
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>loadConsumeQueue</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>storeCheckpoint</span> <span style=color:#ce5c00;font-weight:700>=</span>
                    <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StoreCheckpoint</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StorePathConfigHelper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStoreCheckpoint</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageStoreConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStorePathRootDir</span><span style=color:#ce5c00;font-weight:700>()));</span>

                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>indexService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>load</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lastExitOK</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#8f5902;font-style:italic>//恢复入口
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>recover</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lastExitOK</span><span style=color:#ce5c00;font-weight:700>);</span>

                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMaxPhyOffset</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allocateMappedFileService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shutdown</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过上面的代码可以知道恢复是通过 <strong><code>recover</code></strong> 方法来处理。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>recover</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>lastExitOK</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//获取ConsumeQueue最大的物理偏移量--这个也是CommitLog中物理偏移量(后续会有测试的打印代码)
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>maxPhyOffsetOfConsumeQueue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>recoverConsumeQueue</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lastExitOK</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//正常退出处理
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>recoverNormally</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>maxPhyOffsetOfConsumeQueue</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//异常退出处理
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>recoverAbnormally</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>maxPhyOffsetOfConsumeQueue</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>recoverTopicQueueTable</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote><p>在RocketMQ的4.7.0版本中CommitLog#recoverAbnormally方法显示为过期，这里暂时就不去分析这个情况。等后续看这里如何处理。</p></blockquote><h3 id=2commitlog和consumequeue的恢复>2.CommitLog和ConsumeQueue的恢复</h3><p>下面来通过添加测试代码的方式说明一下 <strong><code>maxPhyOffsetOfConsumeQueue</code></strong> 到底是什么值。首先能在 <strong><code>recover</code></strong> 中添加如下代码然后打包源码：</p><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/recover1.png?raw=true" alt></p><p>然后启动broker,我这里启动这个值为384</p><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/recover2.png?raw=true" alt></p><p>然后通过客户端在产生一条消息到Broker</p><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/recover3.png?raw=true" alt></p><p>通过监控broker日志(这个也是自己添加的)，存入CommitLog的大小为192字节。</p><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/recover4.png?raw=true" alt></p><p>然后重启Broker发现这个 <strong><code>maxPhyOffsetOfConsumeQueue</code></strong> 变为了 <strong>576</strong> 。<img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/recover5.png?raw=true" alt></p><p>通过这个日志的打印说明了 <strong><code>maxPhyOffsetOfConsumeQueue</code></strong> 为CommitLog日志中的物理偏移量。接下来分一下 <strong><code>CommitLog#recoverNormally</code></strong> 是怎么样来处理的：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>recoverNormally</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>maxPhyOffsetOfConsumeQueue</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//CRC检查在恢复的时候--默认值true
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>checkCRCOnRecover</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStoreConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isCheckCRCOnRecover</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>//获取CommitLog的列表    
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MappedFile</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>mappedFiles</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mappedFileQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMappedFiles</span><span style=color:#ce5c00;font-weight:700>();</span>
    	<span style=color:#8f5902;font-style:italic>//非空说明不是第一次启动
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>mappedFiles</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 大于三个CommitLog文件就从最新的三个开始，小于三个就有多少校验多少
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mappedFiles</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
			
            <span style=color:#000>MappedFile</span> <span style=color:#000>mappedFile</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mappedFiles</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>ByteBuffer</span> <span style=color:#000>byteBuffer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mappedFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sliceByteBuffer</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>processOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mappedFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getFileFromOffset</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>mappedFileOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>//每条数据的校验然后返回DispatchRequest
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>DispatchRequest</span> <span style=color:#000>dispatchRequest</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>checkMessageAndReturnSize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>byteBuffer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>checkCRCOnRecover</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgSize</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#8f5902;font-style:italic>// 正常数据处理
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSuccess</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>mappedFileOffset</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                
                <span style=color:#8f5902;font-style:italic>//来到文件结尾或者处理完了，或者需要换文件
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSuccess</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>++;</span>
                    <span style=color:#8f5902;font-style:italic>//最新的三个文件都处理完了
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>mappedFiles</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                 
                        <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>//切换文件
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>mappedFile</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mappedFiles</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#000>byteBuffer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mappedFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sliceByteBuffer</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#000>processOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mappedFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getFileFromOffset</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#000>mappedFileOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>

                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#8f5902;font-style:italic>// 终端文件的读取由于错误
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSuccess</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;recover physics file end, &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>mappedFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getFileName</span><span style=color:#ce5c00;font-weight:700>());</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#000>processOffset</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>mappedFileOffset</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>//设置刷新位置
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mappedFileQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setFlushedWhere</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>processOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>//设置接下来文件的提交位置
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mappedFileQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCommittedWhere</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>processOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>//删除过期的文件
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mappedFileQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>truncateDirtyFiles</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>processOffset</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#8f5902;font-style:italic>//清除ConsumeQueue多余的数据
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>maxPhyOffsetOfConsumeQueue</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>processOffset</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>truncateDirtyLogicFiles</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>processOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// CommitLog日志文件全部删除(特殊情况就是第一次启动)
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mappedFileQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setFlushedWhere</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mappedFileQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCommittedWhere</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>destroyLogics</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面代码有一个两个变量可能不太明白他的数据到底为多少一个是 <strong><code>processOffset、mappedFileOffset</code></strong> 下面来通过添加日志打印的模式来看一下，首先如下图所示添加代码然后打包对应的模块：</p><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/recoverNormally1.png?raw=true" alt></p><p>然后启动Broker看一下对应的值如下图：</p><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/recoverNormally2.png?raw=true" alt></p><p><strong><code>processOffset</code></strong> 启动的时候其实是0，<strong><code>mappedFileOffset</code></strong> 就是每一个CommitLog的处理数据。</p><p>上面主要分为两种正常恢复：</p><ul><li><p><strong><code>存在CommitLog日志文件</code></strong></p><ol><li>检查最新三个文件数据中的每条数据</li><li>设置flushedWhere和committedWhere值</li><li>删除处理过了的CommitLog日志文件。</li></ol></li><li><p><strong><code>不存在CommitLog日志文件(第一次启动或者日志文件被删除)</code></strong></p><p>设置flushedWhere和committedWhere为0并且删除ConsumeQueue文件</p></li></ul><h3 id=3topicqueue的恢复>3.TopicQueue的恢复</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//topic queueId和offset的关系 
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>recoverTopicQueueTable</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#8f5902;font-style:italic>/* topic-queueid */</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Long</span><span style=color:#8f5902;font-style:italic>/* offset */</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>table</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>1024</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>minPhyOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMinOffset</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConcurrentMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ConsumeQueue</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>maps</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumeQueueTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>values</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConsumeQueue</span> <span style=color:#000>logic</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>maps</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>values</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>String</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>logic</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;-&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>logic</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueId</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>logic</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMaxOffsetInQueue</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#000>logic</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>correctMinOffset</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>minPhyOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTopicQueueTable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这个里面的关系数据会在CommitLog日志数据保存在如下代码中会用到。 <strong><code>DefaultAppendMessageCallback#doAppend</code></strong> 方法中。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>Long</span> <span style=color:#000>queueOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>CommitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>topicQueueTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#000>ueueOffset</span><span style=color:#ce5c00;font-weight:700>++;</span>

<span style=color:#000>CommitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>topicQueueTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>queueOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-2e0b99c502e1d6196c2f892af868f2d9>7.8 - RocketMQ源码解析-Broker存储配置文件说明</h1><blockquote><p>RocketMQ版本4..8.0版本</p></blockquote><h3 id=1-broker-store-config-下面的文件>1. Broker store config 下面的文件</h3><p>在Broker启动后在 <strong><code>$HOME \store\config</code></strong> 路径下面有五个文件分别是：</p><ul><li><strong>consumerFilter.json</strong></li><li><strong>consumerOffset.json</strong></li><li><strong>delayOffset.json</strong></li><li><strong>subscriptionGroup.json</strong></li><li><strong>topics.json</strong></li></ul><h3 id=2-consumerfilterjson>2. consumerFilter.json</h3><h3 id=3-consumeroffsetjson>3. consumerOffset.json</h3><p>记录该broker上针对每个topic的每个consumer group的针对每个queue的消费位移</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>&#34;offsetTable&#34;</span><span style=color:#000;font-weight:700>:{</span>
		<span style=color:#204a87;font-weight:700>&#34;%RETRY%please_rename_unique_group_name@please_rename_unique_group_name&#34;</span><span style=color:#000;font-weight:700>:{</span><span style=color:#a40000>0:0</span>
		<span style=color:#000;font-weight:700>},</span>
		<span style=color:#204a87;font-weight:700>&#34;TopicTest@please_rename_unique_group_name&#34;</span><span style=color:#000;font-weight:700>:{</span><span style=color:#a40000>0:6,1:3,2:3,3:2</span>
		<span style=color:#000;font-weight:700>}</span>
	<span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><h4 id=4-delayoffsetjson>4. delayOffset.json</h4><p>记录该broker延迟队列的消费位移情况，1:1中1表示延迟粒度，1表示位移</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>&#34;offsetTable&#34;</span><span style=color:#000;font-weight:700>:{</span><span style=color:#a40000>1:1</span>
	<span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><h3 id=5-subscriptiongroupjson>5. subscriptionGroup.json</h3><p>记录该broker上各类订阅关系</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>&#34;dataVersion&#34;</span><span style=color:#000;font-weight:700>:{</span>
		<span style=color:#204a87;font-weight:700>&#34;counter&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span>
		<span style=color:#204a87;font-weight:700>&#34;timestamp&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1622907213308</span>
	<span style=color:#000;font-weight:700>},</span>
	<span style=color:#204a87;font-weight:700>&#34;subscriptionGroupTable&#34;</span><span style=color:#000;font-weight:700>:{</span>
		<span style=color:#204a87;font-weight:700>&#34;SELF_TEST_C_GROUP&#34;</span><span style=color:#000;font-weight:700>:{</span>
			<span style=color:#204a87;font-weight:700>&#34;brokerId&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeBroadcastEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeFromMinEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;groupName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;SELF_TEST_C_GROUP&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;notifyConsumerIdsChangedEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;retryMaxTimes&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;retryQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;whichBrokerWhenConsumeSlowly&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span>
		<span style=color:#000;font-weight:700>},</span>
		<span style=color:#204a87;font-weight:700>&#34;CID_ONSAPI_OWNER&#34;</span><span style=color:#000;font-weight:700>:{</span>
			<span style=color:#204a87;font-weight:700>&#34;brokerId&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeBroadcastEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeFromMinEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;groupName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;CID_ONSAPI_OWNER&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;notifyConsumerIdsChangedEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;retryMaxTimes&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;retryQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;whichBrokerWhenConsumeSlowly&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span>
		<span style=color:#000;font-weight:700>},</span>
		<span style=color:#204a87;font-weight:700>&#34;CID_ONSAPI_PERMISSION&#34;</span><span style=color:#000;font-weight:700>:{</span>
			<span style=color:#204a87;font-weight:700>&#34;brokerId&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeBroadcastEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeFromMinEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;groupName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;CID_ONSAPI_PERMISSION&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;notifyConsumerIdsChangedEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;retryMaxTimes&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;retryQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;whichBrokerWhenConsumeSlowly&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span>
		<span style=color:#000;font-weight:700>},</span>
		<span style=color:#204a87;font-weight:700>&#34;please_rename_unique_group_name&#34;</span><span style=color:#000;font-weight:700>:{</span>
			<span style=color:#204a87;font-weight:700>&#34;brokerId&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeBroadcastEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeFromMinEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;groupName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;please_rename_unique_group_name&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;notifyConsumerIdsChangedEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;retryMaxTimes&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;retryQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;whichBrokerWhenConsumeSlowly&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span>
		<span style=color:#000;font-weight:700>},</span>
		<span style=color:#204a87;font-weight:700>&#34;TOOLS_CONSUMER&#34;</span><span style=color:#000;font-weight:700>:{</span>
			<span style=color:#204a87;font-weight:700>&#34;brokerId&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeBroadcastEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeFromMinEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;groupName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;TOOLS_CONSUMER&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;notifyConsumerIdsChangedEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;retryMaxTimes&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;retryQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;whichBrokerWhenConsumeSlowly&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span>
		<span style=color:#000;font-weight:700>},</span>
		<span style=color:#204a87;font-weight:700>&#34;CID_ONS-HTTP-PROXY&#34;</span><span style=color:#000;font-weight:700>:{</span>
			<span style=color:#204a87;font-weight:700>&#34;brokerId&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeBroadcastEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeFromMinEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;groupName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;CID_ONS-HTTP-PROXY&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;notifyConsumerIdsChangedEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;retryMaxTimes&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;retryQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;whichBrokerWhenConsumeSlowly&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span>
		<span style=color:#000;font-weight:700>},</span>
		<span style=color:#204a87;font-weight:700>&#34;FILTERSRV_CONSUMER&#34;</span><span style=color:#000;font-weight:700>:{</span>
			<span style=color:#204a87;font-weight:700>&#34;brokerId&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeBroadcastEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeFromMinEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;groupName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;FILTERSRV_CONSUMER&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;notifyConsumerIdsChangedEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;retryMaxTimes&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;retryQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;whichBrokerWhenConsumeSlowly&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span>
		<span style=color:#000;font-weight:700>},</span>
		<span style=color:#204a87;font-weight:700>&#34;CID_ONSAPI_PULL&#34;</span><span style=color:#000;font-weight:700>:{</span>
			<span style=color:#204a87;font-weight:700>&#34;brokerId&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeBroadcastEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeFromMinEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;groupName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;CID_ONSAPI_PULL&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;notifyConsumerIdsChangedEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;retryMaxTimes&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;retryQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;whichBrokerWhenConsumeSlowly&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span>
		<span style=color:#000;font-weight:700>}</span>
	<span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><h3 id=6-topicsjson>6. topics.json</h3><p>记录该broker上各topic信息，包括queue信息、读写权限</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>&#34;dataVersion&#34;</span><span style=color:#000;font-weight:700>:{</span>
		<span style=color:#204a87;font-weight:700>&#34;counter&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span>
		<span style=color:#204a87;font-weight:700>&#34;timestamp&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1622907213314</span>
	<span style=color:#000;font-weight:700>},</span>
	<span style=color:#204a87;font-weight:700>&#34;topicConfigTable&#34;</span><span style=color:#000;font-weight:700>:{</span>
		<span style=color:#204a87;font-weight:700>&#34;SCHEDULE_TOPIC_XXXX&#34;</span><span style=color:#000;font-weight:700>:{</span>
			<span style=color:#204a87;font-weight:700>&#34;order&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;perm&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;readQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicFilterType&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;SINGLE_TAG&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;SCHEDULE_TOPIC_XXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicSysFlag&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;writeQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>18</span>
		<span style=color:#000;font-weight:700>},</span>
		<span style=color:#204a87;font-weight:700>&#34;TopicTest&#34;</span><span style=color:#000;font-weight:700>:{</span>
			<span style=color:#204a87;font-weight:700>&#34;order&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;perm&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;readQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicFilterType&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;SINGLE_TAG&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;TopicTest&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicSysFlag&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;writeQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>4</span>
		<span style=color:#000;font-weight:700>},</span>
		<span style=color:#204a87;font-weight:700>&#34;SELF_TEST_TOPIC&#34;</span><span style=color:#000;font-weight:700>:{</span>
			<span style=color:#204a87;font-weight:700>&#34;order&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;perm&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;readQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicFilterType&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;SINGLE_TAG&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;SELF_TEST_TOPIC&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicSysFlag&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;writeQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span>
		<span style=color:#000;font-weight:700>},</span>
		<span style=color:#204a87;font-weight:700>&#34;DefaultCluster&#34;</span><span style=color:#000;font-weight:700>:{</span>
			<span style=color:#204a87;font-weight:700>&#34;order&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;perm&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;readQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicFilterType&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;SINGLE_TAG&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;DefaultCluster&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicSysFlag&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;writeQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>16</span>
		<span style=color:#000;font-weight:700>},</span>
		<span style=color:#204a87;font-weight:700>&#34;DefaultCluster_REPLY_TOPIC&#34;</span><span style=color:#000;font-weight:700>:{</span>
			<span style=color:#204a87;font-weight:700>&#34;order&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;perm&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;readQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicFilterType&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;SINGLE_TAG&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;DefaultCluster_REPLY_TOPIC&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicSysFlag&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;writeQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span>
		<span style=color:#000;font-weight:700>},</span>
		<span style=color:#204a87;font-weight:700>&#34;DESKTOP-B7KDPBT&#34;</span><span style=color:#000;font-weight:700>:{</span>
			<span style=color:#204a87;font-weight:700>&#34;order&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;perm&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;readQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicFilterType&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;SINGLE_TAG&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;DESKTOP-B7KDPBT&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicSysFlag&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;writeQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span>
		<span style=color:#000;font-weight:700>},</span>
		<span style=color:#204a87;font-weight:700>&#34;RMQ_SYS_TRANS_HALF_TOPIC&#34;</span><span style=color:#000;font-weight:700>:{</span>
			<span style=color:#204a87;font-weight:700>&#34;order&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;perm&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;readQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicFilterType&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;SINGLE_TAG&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;RMQ_SYS_TRANS_HALF_TOPIC&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicSysFlag&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;writeQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span>
		<span style=color:#000;font-weight:700>},</span>
		<span style=color:#204a87;font-weight:700>&#34;%RETRY%please_rename_unique_group_name&#34;</span><span style=color:#000;font-weight:700>:{</span>
			<span style=color:#204a87;font-weight:700>&#34;order&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;perm&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;readQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicFilterType&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;SINGLE_TAG&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;%RETRY%please_rename_unique_group_name&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicSysFlag&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;writeQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span>
		<span style=color:#000;font-weight:700>},</span>
		<span style=color:#204a87;font-weight:700>&#34;TBW102&#34;</span><span style=color:#000;font-weight:700>:{</span>
			<span style=color:#204a87;font-weight:700>&#34;order&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;perm&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;readQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicFilterType&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;SINGLE_TAG&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;TBW102&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicSysFlag&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;writeQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>8</span>
		<span style=color:#000;font-weight:700>},</span>
		<span style=color:#204a87;font-weight:700>&#34;BenchmarkTest&#34;</span><span style=color:#000;font-weight:700>:{</span>
			<span style=color:#204a87;font-weight:700>&#34;order&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;perm&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;readQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1024</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicFilterType&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;SINGLE_TAG&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;BenchmarkTest&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicSysFlag&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;writeQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1024</span>
		<span style=color:#000;font-weight:700>},</span>
		<span style=color:#204a87;font-weight:700>&#34;OFFSET_MOVED_EVENT&#34;</span><span style=color:#000;font-weight:700>:{</span>
			<span style=color:#204a87;font-weight:700>&#34;order&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;perm&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;readQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicFilterType&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;SINGLE_TAG&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;OFFSET_MOVED_EVENT&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicSysFlag&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;writeQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span>
		<span style=color:#000;font-weight:700>}</span>
	<span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-73525016293fc3e03673666421e0bb7b>7.9 - RocketMQ源码解析-Broker 消息Tag过滤</h1><blockquote><p>RocketMQ源码版本4.8.0</p></blockquote><h3 id=1-消息tagcode生成>1. 消息TagCode生成</h3><p>通过 <strong>ReputMessageService</strong> 服务获取commitlog数据。然后通过 <strong><code>CommitLog#checkMessageAndReturnSize</code></strong> 生成tagCode:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>DispatchRequest</span> <span style=color:#000>checkMessageAndReturnSize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nio</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ByteBuffer</span> <span style=color:#000>byteBuffer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>checkCRC</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>readBody</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertiesLength</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>byteBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bytesContent</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>propertiesLength</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>String</span> <span style=color:#000>properties</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bytesContent</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>propertiesLength</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MessageDecoder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CHARSET_UTF8</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>propertiesMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MessageDecoder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>string2messageProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#000>keys</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>propertiesMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageConst</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PROPERTY_KEYS</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#000>uniqKey</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>propertiesMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageConst</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PROPERTY_UNIQ_CLIENT_MESSAGE_ID_KEYIDX</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#000>String</span> <span style=color:#000>tags</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>propertiesMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageConst</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PROPERTY_TAGS</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tags</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>tags</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//生成TagCode
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>tagsCode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MessageExtBrokerInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>tagsString2tagsCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageExt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseTopicFilterType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sysFlag</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>tags</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>String</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>propertiesMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageConst</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PROPERTY_DELAY_TIME_LEVEL</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TopicValidator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RMQ_SYS_SCHEDULE_TOPIC</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>delayLevel</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span>

                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delayLevel</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getScheduleMessageService</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getMaxDelayLevel</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>delayLevel</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getScheduleMessageService</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getMaxDelayLevel</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#ce5c00;font-weight:700>}</span>

                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delayLevel</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>tagsCode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getScheduleMessageService</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>computeDeliverTimestamp</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delayLevel</span><span style=color:#ce5c00;font-weight:700>,</span>
                        <span style=color:#000>storeTimestamp</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

 <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MessageExtBrokerInner</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>MessageExt</span> <span style=color:#ce5c00;font-weight:700>{</span>
     <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>tagsString2tagsCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>TopicFilterType</span> <span style=color:#000>filter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>tags</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>tags</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>tags</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>tags</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hashCode</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul><li>DispatchRequest将tag转化为tagCode</li><li>DispatchRequest用于consumeQueue的存储，通过CommitLogDispatcherBuildConsumeQueue保存了tagsCode</li></ul><h3 id=2-消费者订阅主题和tags>2. 消费者订阅主题和Tags</h3><p>Consumer端在订阅消息时除了指定Topic还可以指定TAG，如果一个消息有多个TAG，可以用 <strong>||</strong> 分隔。其中，Consumer端会将这个订阅请求构建成一个 SubscriptionData，发送一个Pull消息的请求给Broker端，看一下消费者代码的实现：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>SubscriptionData</span> <span style=color:#000>buildSubscriptionData</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>consumerGroup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span>
    <span style=color:#000>String</span> <span style=color:#000>subString</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>SubscriptionData</span> <span style=color:#000>subscriptionData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SubscriptionData</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>subscriptionData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTopic</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>subscriptionData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSubString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>subString</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>subString</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>subString</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SubscriptionData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SUB_ALL</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>subString</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>subscriptionData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSubString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SubscriptionData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SUB_ALL</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>tags</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>subString</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>split</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;\\|\\|&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tags</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>tag</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>tags</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>String</span> <span style=color:#000>trimString</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trim</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>trimString</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>subscriptionData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTagsSet</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>trimString</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#8f5902;font-style:italic>//获取tagCode其实就是hashCode
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>subscriptionData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCodeSet</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>trimString</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hashCode</span><span style=color:#ce5c00;font-weight:700>());</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;subString split error&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>subscriptionData</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=3-broker-tag过滤>3. Broker Tag过滤</h3><p>Broker从CommitLog读取存储消息数据之前，会用消费者发送的SubscriptionData构建一个MessageFilter过滤器。然后传给MessageStore。然后通过MessageStore从 ConsumeQueue读取到一条记录后，会用它记录的消息tag hash(tagCode)值去做过滤，由于在服务端只是根据hashcode进行判断，无法精确对tag原始字符串进行过滤，故在消息消费端拉取到消息后，还需要对消息的原始tag字符串进行比对，如果不同，则丢弃该消息，不进行消息消费。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-847fa820597dc46f22232d7ac858f231>8 - RockerMQ 生产者</h1></div><div class=td-content><h1 id=pg-a11b7514ad3e66334e5e1537e6fb32bd>8.1 - RocketMQ源码解析-topic创建机制</h1><blockquote><p>以下源码基于Rocket MQ 4.7.0</p></blockquote><h3 id=1-rocketmq-topic创建机制>1. RocketMQ Topic创建机制</h3><p>RocketMQ Topic创建机制分为两种：一种自动创建，一种手动创建。可以通过设置broker的配置文件来禁用或者允许自动创建。默认是开启的允许自动创建</p><blockquote><p>autoCreateTopicEnable=true/false</p></blockquote><p>下面会结合源码来深度分析一下自动创建和手动创建的过程。</p><h3 id=2-自动topic>2. 自动Topic</h3><p>默认情况下，topic不用手动创建，当producer进行消息发送时，会从nameserver拉取topic的路由信息，如果topic的路由信息不存在，那么会默认拉取broker启动时默认创建好名为“TBW102”的Topic,这定义在org.apache.rocketmq.common.MixAll类中</p><pre><code class=language-javaMixAll data-lang=javaMixAll>// Will be created at broker when isAutoCreateTopicEnable
 public static final String AUTO_CREATE_TOPIC_KEY_TOPIC = &quot;TBW102&quot;; 
</code></pre><p>自动创建开关是下BrokerConfig类中有一个私有变量：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@ImportantField</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>autoCreateTopicEnable</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><p>这变量可以通过配置文件配置来进行修改，代码中的默认值为true，所以在默认的情况下Rocket MQ是会自动创建Topic的。<br>在Broker启动，会调用TopicConfigManager的构造方法，在构造方法中定义了一系列RocketMQ系统内置的一些系统Topic（这里只关注一下TBW102）:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// MixAll.AUTO_CREATE_TOPIC_KEY_TOPIC
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isAutoCreateTopicEnable</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>String</span> <span style=color:#000>topic</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MixAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>AUTO_CREATE_TOPIC_KEY_TOPIC</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>TopicConfig</span> <span style=color:#000>topicConfig</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TopicConfig</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>systemTopicList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>topicConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setReadQueueNums</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>()</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDefaultTopicQueueNums</span><span style=color:#ce5c00;font-weight:700>());</span> <span style=color:#8f5902;font-style:italic>//8
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>topicConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setWriteQueueNums</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>()</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDefaultTopicQueueNums</span><span style=color:#ce5c00;font-weight:700>());</span> <span style=color:#8f5902;font-style:italic>//8
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>perm</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PermName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PERM_INHERIT</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>PermName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PERM_READ</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>PermName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PERM_WRITE</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>topicConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setPerm</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>perm</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>topicConfigTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topicConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopicName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>topicConfig</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这里有 <strong><code>this.brokerController.getBrokerConfig().isAutoCreateTopicEnable()</code></strong> 这样一段代码，在开启允许自动创建的时候，会把当前Topic的信息存入topicConfigTable变量中。然后通过发送定期发送心跳包把Topic和Broker的信息发送到NameServer的RouteInfoManager中进行保存。在BrokerController中定义了这样的一个定时任务来执行这个心跳包的发送：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scheduledExecutorService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scheduleAtFixedRate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>

            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>BrokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerBrokerAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>brokerConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isForceRegister</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;registerBrokerAll Exception&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>1000</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>max</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>10000</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>min</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>brokerConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRegisterNameServerPeriod</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>60000</span><span style=color:#ce5c00;font-weight:700>)),</span> <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MILLISECONDS</span><span style=color:#ce5c00;font-weight:700>);</span>

</code></pre></div><p>这里就说明了如何把每个Broker的系统自定义的Topic注册到NameServer。接下来看在发送过程中如何从NameServer获取Topic的路由信息：
DefaultMQProducerImpl.sendDefaultImpl</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>SendResult</span> <span style=color:#000>sendDefaultImpl</span><span style=color:#ce5c00;font-weight:700>(</span>
        <span style=color:#000>Message</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>CommunicationMode</span> <span style=color:#000>communicationMode</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SendCallback</span> <span style=color:#000>sendCallback</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>timeout</span>
    <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>MQClientException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RemotingException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MQBrokerException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>InterruptedException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        
        <span style=color:#8f5902;font-style:italic>//省略代码
</span><span style=color:#8f5902;font-style:italic></span>        
        <span style=color:#8f5902;font-style:italic>//获取路由信息
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>TopicPublishInfo</span> <span style=color:#000>topicPublishInfo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>tryToFindTopicPublishInfo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>());</span>
        
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过DefaultMQProducerImpl.tryToFindTopicPublishInfo方法获取Topic的路由信息。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>TopicPublishInfo</span> <span style=color:#000>tryToFindTopicPublishInfo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        
        <span style=color:#000>TopicPublishInfo</span> <span style=color:#000>topicPublishInfo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>topicPublishInfoTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>//第一次从缓存中获取--肯定没有因为还没创建
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>topicPublishInfo</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>topicPublishInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ok</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>topicPublishInfoTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putIfAbsent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TopicPublishInfo</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#8f5902;font-style:italic>//从NameServer获取--也是没有，因为没有创建
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mQClientFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>updateTopicRouteInfoFromNameServer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>topicPublishInfo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>topicPublishInfoTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topicPublishInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isHaveTopicRouterInfo</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>topicPublishInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ok</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>topicPublishInfo</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//第二次从这里获取
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mQClientFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>updateTopicRouteInfoFromNameServer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQProducer</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>topicPublishInfo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>topicPublishInfoTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>topicPublishInfo</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>下面来看一下 <strong><code>MQClientInstance.updateTopicRouteInfoFromNameServer</code></strong> 的方法:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>updateTopicRouteInfoFromNameServer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isDefault</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>DefaultMQProducer</span> <span style=color:#000>defaultMQProducer</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            
    <span style=color:#8f5902;font-style:italic>//省略代码
</span><span style=color:#8f5902;font-style:italic></span>    
    
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isDefault</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>defaultMQProducer</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//使用默认的TBW102 Topic获取数据
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>topicRouteData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mQClientAPIImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDefaultTopicRouteInfoFromNameServer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>defaultMQProducer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCreateTopicKey</span><span style=color:#ce5c00;font-weight:700>(),</span>
                            <span style=color:#000>1000</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topicRouteData</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>QueueData</span> <span style=color:#000>data</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>topicRouteData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueDatas</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>queueNums</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>min</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>defaultMQProducer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDefaultTopicQueueNums</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getReadQueueNums</span><span style=color:#ce5c00;font-weight:700>());</span>
                                <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setReadQueueNums</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>queueNums</span><span style=color:#ce5c00;font-weight:700>);</span>
                                <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setWriteQueueNums</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>queueNums</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>//这是正常的
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>topicRouteData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mQClientAPIImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopicRouteInfoFromNameServer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>1000</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>//省略代码      
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果isDefault=true并且defaultMQProducer不为空，从nameserver中获取默认路由信息，此时会获取所有已开启自动创建开关的broker的默认“TBW102”topic路由信息，并保存默认的topic消息队列数量。</p><blockquote><p>这里会比较一下配在在 DefaultMQProducer.defaultTopicQueueNums中的默认值和TBW102中的值哪个更小。</p></blockquote><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topicRouteData</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>TopicRouteData</span> <span style=color:#000>old</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>topicRouteTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>changed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>topicRouteDataIsChange</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>old</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>topicRouteData</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>changed</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>changed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isNeedUpdateTopicRouteInfo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;the topic[{}] route info changed, old[{}] ,new[{}]&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>old</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>topicRouteData</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
 <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>判断获取默认的是否存在，如果存在把当前的Topic的信息更新。也就是把TBW102 Topic的数据更新为自动创建的数据。</p><pre><code> if (changed) {
    TopicRouteData cloneTopicRouteData = topicRouteData.cloneTopicRouteData();

    for (BrokerData bd : topicRouteData.getBrokerDatas()) {
        this.brokerAddrTable.put(bd.getBrokerName(), bd.getBrokerAddrs());
    }

    // Update Pub info
    {
        TopicPublishInfo publishInfo = topicRouteData2TopicPublishInfo(topic, topicRouteData);
        publishInfo.setHaveTopicRouterInfo(true);
        Iterator&lt;Entry&lt;String, MQProducerInner&gt;&gt; it = this.producerTable.entrySet().iterator();
        while (it.hasNext()) {
            Entry&lt;String, MQProducerInner&gt; entry = it.next();
            MQProducerInner impl = entry.getValue();
            if (impl != null) {
                impl.updateTopicPublishInfo(topic, publishInfo);
            }
        }
    }
    	// Update sub info
    {
        Set&lt;MessageQueue&gt; subscribeInfo = topicRouteData2TopicSubscribeInfo(topic, topicRouteData);
        Iterator&lt;Entry&lt;String, MQConsumerInner&gt;&gt; it = this.consumerTable.entrySet().iterator();
        while (it.hasNext()) {
            Entry&lt;String, MQConsumerInner&gt; entry = it.next();
            MQConsumerInner impl = entry.getValue();
            if (impl != null) {
                impl.updateTopicSubscribeInfo(topic, subscribeInfo);
            }
        }
    }
    log.info(&quot;topicRouteTable.put. Topic = {}, TopicRouteData[{}]&quot;, topic, cloneTopicRouteData);
    this.topicRouteTable.put(topic, cloneTopicRouteData);
    return true;
}
</code></pre><p>更新本地的缓存。这样TBW102 Topic的负载和一些默认的路由信息就会被自己创建的Topic使用。这里就是整个自动创建的过程.<br>总结一下就是：通过使用系统内部的一个TBW102的Topic的配置来自动创建当前用户的要创建的自定义Topic。</p><h3 id=3-手动创建--预先创建>3. 手动创建&ndash;预先创建</h3><p>手动创建也叫预先创建，就是在使用Topic之前就创建，可以通过命令行或者通过RocketMQ的管理界面创建Topic。</p><h4 id=通过界面控制台创建>通过界面控制台创建</h4><blockquote><p>项目地址： <a href=https://github.com/apache/rocketmq-externals>https://github.com/apache/rocketmq-externals</a></p></blockquote><p><img src=https://raw.githubusercontent.com/mxsm/document/master/image/MQ/RocketMQ/createTopicByHuman.png alt></p><p>TopicController主要负责Topic的管理</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/createOrUpdate.do&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>RequestMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>POST</span><span style=color:#ce5c00;font-weight:700>})</span>
<span style=color:#5c35cc;font-weight:700>@ResponseBody</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>topicCreateOrUpdateRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@RequestBody</span> <span style=color:#000>TopicConfigInfo</span> <span style=color:#000>topicCreateOrUpdateRequest</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Preconditions</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>checkArgument</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CollectionUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isNotEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topicCreateOrUpdateRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerNameList</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>CollectionUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isNotEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topicCreateOrUpdateRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClusterNameList</span><span style=color:#ce5c00;font-weight:700>()),</span>
            <span style=color:#4e9a06>&#34;clusterName or brokerName can not be all blank&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;op=look topicCreateOrUpdateRequest={}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>JsonUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>obj2String</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topicCreateOrUpdateRequest</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>topicService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createOrUpdate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topicCreateOrUpdateRequest</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后通过MQAdminExtImpl.createAndUpdateTopicConfig方法来创建：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>createAndUpdateTopicConfig</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>addr</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TopicConfig</span> <span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>RemotingException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MQBrokerException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>InterruptedException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MQClientException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>MQAdminInstance</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>threadLocalMQAdminExt</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>createAndUpdateTopicConfig</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>addr</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过调用DefaultMQAdminExtImpl.createAndUpdateTopicConfig创建Topic</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>createAndUpdateTopicConfig</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>addr</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TopicConfig</span> <span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>RemotingException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MQBrokerException</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>InterruptedException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MQClientException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mqClientInstance</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMQClientAPIImpl</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>createTopic</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>addr</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQAdminExt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCreateTopicKey</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>timeoutMillis</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>最后通过MQClientAPIImpl.createTopic创建Topic</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>createTopic</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>addr</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>defaultTopic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>TopicConfig</span> <span style=color:#000>topicConfig</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>timeoutMillis</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>RemotingException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MQBrokerException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>InterruptedException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MQClientException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>CreateTopicRequestHeader</span> <span style=color:#000>requestHeader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CreateTopicRequestHeader</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTopic</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topicConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopicName</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setDefaultTopic</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>defaultTopic</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setReadQueueNums</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topicConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getReadQueueNums</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setWriteQueueNums</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topicConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWriteQueueNums</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setPerm</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topicConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPerm</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTopicFilterType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topicConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopicFilterType</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>name</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTopicSysFlag</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topicConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopicSysFlag</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setOrder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topicConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isOrder</span><span style=color:#ce5c00;font-weight:700>());</span>

        <span style=color:#000>RemotingCommand</span> <span style=color:#000>request</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RemotingCommand</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createRequestCommand</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>UPDATE_AND_CREATE_TOPIC</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#000>RemotingCommand</span> <span style=color:#000>response</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remotingClient</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invokeSync</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MixAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerVIPChannel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clientConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isVipChannelEnabled</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>addr</span><span style=color:#ce5c00;font-weight:700>),</span>
            <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>timeoutMillis</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>assert</span> <span style=color:#000>response</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>switch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCode</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SUCCESS</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>default</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MQClientException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCode</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRemark</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-395544e354ea6266fbab9cae741be2bf>8.2 - RocketMQ源码解析-生产者投递消息策略</h1><blockquote><p>以下源码基于Rocket MQ 4.7.0</p></blockquote><h3 id=1-消息类型>1. 消息类型</h3><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/RocketMQMessageType.png?raw=true" alt=RocketMQMessageType.png></p><h3 id=2-基于queue队列轮询算法投递>2. 基于Queue队列轮询算法投递</h3><h4 id=21-默认轮询算法>2.1 默认轮询算法</h4><p>默认情况下，采用了最简单的轮询算法，这种算法有个很好的特性就是，保证每一个Queue队列的消息投递数量尽可能均匀。看一下代码的实现，</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//DefaultMQProducerImpl selectOneMessageQueue选择队列
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MessageQueue</span> <span style=color:#000>selectOneMessageQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>TopicPublishInfo</span> <span style=color:#000>tpInfo</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>lastBrokerName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mqFaultStrategy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>selectOneMessageQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tpInfo</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>lastBrokerName</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>//MQFaultStrategy selectOneMessageQueue
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MessageQueue</span> <span style=color:#000>selectOneMessageQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>TopicPublishInfo</span> <span style=color:#000>tpInfo</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>lastBrokerName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sendLatencyFaultEnable</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tpInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSendWhichQueue</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getAndIncrement</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>tpInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageQueueList</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>abs</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#000>tpInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageQueueList</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
                        <span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#000>MessageQueue</span> <span style=color:#000>mq</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tpInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageQueueList</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>latencyFaultTolerance</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAvailable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>lastBrokerName</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerName</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lastBrokerName</span><span style=color:#ce5c00;font-weight:700>))</span>
                            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>

                <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>notBestBroker</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>latencyFaultTolerance</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pickOneAtLeast</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>writeQueueNums</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tpInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueIdByBroker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>notBestBroker</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>writeQueueNums</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MessageQueue</span> <span style=color:#000>mq</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tpInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>selectOneMessageQueue</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>notBestBroker</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBrokerName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>notBestBroker</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setQueueId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tpInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSendWhichQueue</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getAndIncrement</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#000>writeQueueNums</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>latencyFaultTolerance</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>notBestBroker</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error occurred when selecting message queue&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>tpInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>selectOneMessageQueue</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>tpInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>selectOneMessageQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lastBrokerName</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在默认的情况下 <strong><code>sendLatencyFaultEnable=false</code></strong> 直接调用的是 <strong><code>TopicPublishInfo.selectOneMessageQueue</code></strong> 方法:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//发布的对象中TopicPublishInfo
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TopicPublishInfo</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>//基于线程上下文的计数递增--用于轮询目的
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>ThreadLocalIndex</span> <span style=color:#000>sendWhichQueue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ThreadLocalIndex</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MessageQueue</span> <span style=color:#000>selectOneMessageQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>lastBrokerName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lastBrokerName</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>selectOneMessageQueue</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sendWhichQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAndIncrement</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageQueueList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>//轮询
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>abs</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageQueueList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>MessageQueue</span> <span style=color:#000>mq</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageQueueList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerName</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lastBrokerName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>selectOneMessageQueue</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>//获取消费队列
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MessageQueue</span> <span style=color:#000>selectOneMessageQueue</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sendWhichQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAndIncrement</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>abs</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageQueueList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageQueueList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=22-默认投递方式的增强>2.2 默认投递方式的增强</h4><p>基于Queue队列轮询算法和消息投递延迟最小的策略投递，默认的投递方式比较简单，但是也暴露了一个问题，就是有些Queue队列可能由于自身数量积压等原因，可能在投递的过程比较长，对于这样的Queue队列会影响后续投递的效果。
基于这种现象，RocketMQ在每发送一个MQ消息后，都会统计一下消息投递的时间延迟，根据这个时间延迟，可以知道往哪些Queue队列投递的速度快。 在这种场景下，会优先使用消息投递延迟最小的策略，如果没有生效，再使用Queue队列轮询的方式。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MessageQueue</span> <span style=color:#000>selectOneMessageQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>TopicPublishInfo</span> <span style=color:#000>tpInfo</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>lastBrokerName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sendLatencyFaultEnable</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tpInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSendWhichQueue</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getAndIncrement</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>tpInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageQueueList</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>abs</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#000>tpInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageQueueList</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
                        <span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#8f5902;font-style:italic>//轮询获取
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>MessageQueue</span> <span style=color:#000>mq</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tpInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageQueueList</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#8f5902;font-style:italic>//第一次返回一定是true
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>latencyFaultTolerance</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAvailable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>lastBrokerName</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerName</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lastBrokerName</span><span style=color:#ce5c00;font-weight:700>))</span>
                            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>

                <span style=color:#8f5902;font-style:italic>// 从延迟容错broker列表中挑选一个容错性最好的一个 broker
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>notBestBroker</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>latencyFaultTolerance</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pickOneAtLeast</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>writeQueueNums</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tpInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueIdByBroker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>notBestBroker</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>writeQueueNums</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MessageQueue</span> <span style=color:#000>mq</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tpInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>selectOneMessageQueue</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>notBestBroker</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>// 取余挑选其中一个队列
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBrokerName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>notBestBroker</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setQueueId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tpInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSendWhichQueue</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getAndIncrement</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#000>writeQueueNums</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>latencyFaultTolerance</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>notBestBroker</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error occurred when selecting message queue&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>tpInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>selectOneMessageQueue</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>tpInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>selectOneMessageQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lastBrokerName</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>数据的设置在：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>SendResult</span> <span style=color:#000>sendDefaultImpl</span><span style=color:#ce5c00;font-weight:700>(</span>
        <span style=color:#000>Message</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>CommunicationMode</span> <span style=color:#000>communicationMode</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SendCallback</span> <span style=color:#000>sendCallback</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>timeout</span>
    <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>MQClientException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RemotingException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MQBrokerException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>InterruptedException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//省略代码
</span><span style=color:#8f5902;font-style:italic></span>    
    <span style=color:#8f5902;font-style:italic>//这里就是把发送消息的数据到broker时间
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>updateFaultItem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>endTimestamp</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>beginTimestampPrev</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
    
    <span style=color:#8f5902;font-style:italic>//省略代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=3-顺序消息的投递>3. 顺序消息的投递</h3><p>上面的两种消息的投递方式时序性没有要求的场景，这种投递的速度和效率比较高。而在有些场景下，需要保证同类型消息投递和消费的顺序性。通过一定的策略，将其放置在一个 queue队列中。看一下在生产者中如何发送顺序消息：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>OrderedProducer</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//Instantiate with a producer group name.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>MQProducer</span> <span style=color:#000>producer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DefaultMQProducer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;example_group_name&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>//Launch the instance.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>producer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>tags</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;TagA&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;TagB&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;TagC&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;TagD&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;TagE&#34;</span><span style=color:#ce5c00;font-weight:700>};</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>100</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>orderId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>//Create a message instance, specifying topic, tag and message body.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>Message</span> <span style=color:#000>msg</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Message</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;TopicTestjjj&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>tags</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#000>tags</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#4e9a06>&#34;KEY&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>,</span>
                    <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Hello RocketMQ &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getBytes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RemotingHelper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DEFAULT_CHARSET</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#000>SendResult</span> <span style=color:#000>sendResult</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>producer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>send</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MessageQueueSelector</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MessageQueue</span> <span style=color:#000>select</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>mqs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Message</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>arg</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>Integer</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>arg</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#000>mqs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>mqs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>orderId</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;%s%n&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sendResult</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//server shutdown
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>producer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shutdown</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div><p>上面的例子是官网的一个例子。通过ID来选择发送的broker中的某一个写入队列。生产者在消息的投递过程中使用了 <strong><code>MessageQueueSelector</code></strong> 作为消息队列的选择策略。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>MessageQueueSelector</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>MessageQueue</span> <span style=color:#000>select</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>mqs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Message</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>arg</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在MQ中默认提供了三种实现:</p><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/MessageQueueSelector.png?raw=true" alt></p><p>SelectMessageQueueByHash的实现：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SelectMessageQueueByHash</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>MessageQueueSelector</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MessageQueue</span> <span style=color:#000>select</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>mqs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Message</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>arg</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>arg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hashCode</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>abs</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#000>mqs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>mqs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>SelectMessageQueueByMachineRoom的实现：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SelectMessageQueueByMachineRoom</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>MessageQueueSelector</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>consumeridcs</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MessageQueue</span> <span style=color:#000>select</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>mqs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Message</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>arg</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getConsumeridcs</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>consumeridcs</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setConsumeridcs</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>consumeridcs</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumeridcs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>consumeridcs</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>SelectMessageQueueByRandom的实现：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SelectMessageQueueByRandom</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>MessageQueueSelector</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Random</span> <span style=color:#000>random</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Random</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>());</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MessageQueue</span> <span style=color:#000>select</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>mqs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Message</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>arg</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>random</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nextInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mqs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>mqs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote><p>通过 MessageQueueSelector 类的实现跨越选择消息发送的队列。对于同一个队列的消息是有序的。不同队列的消息进行消费可能是无序的。</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-533c04015e0f55b75a9a135850a5aac5>8.3 - RocketMQ源码解析-producer发送消息的流程</h1><blockquote><p>以下源码基于Rocket MQ 4.7.0</p></blockquote><h3 id=1-调用流程>1. 调用流程</h3><p>RocketMQ提供的Producer实现为DefaultMQProducer。Producer在创建的时候必须指定Producer Group Name，在正式发送消息之前需要调用start方法初始化Producer</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/other/git/MQ%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81%E7%9A%84%E9%80%BB%E8%BE%91.png alt=MQ消息发送的逻辑></p><h4 id=1producer端发送同步消息>1、Producer端发送同步消息</h4><p>这种可靠性同步地发送方式使用的比较广泛，比如：重要的消息通知，短信通知。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SyncProducer</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    	<span style=color:#8f5902;font-style:italic>// 实例化消息生产者Producer
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>DefaultMQProducer</span> <span style=color:#000>producer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DefaultMQProducer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;please_rename_unique_group_name&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    	<span style=color:#8f5902;font-style:italic>// 设置NameServer的地址
</span><span style=color:#8f5902;font-style:italic></span>    	<span style=color:#000>producer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setNamesrvAddr</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;localhost:9876&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    	<span style=color:#8f5902;font-style:italic>// 启动Producer实例
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>producer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
    	<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>100</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    	    <span style=color:#8f5902;font-style:italic>// 创建消息，并指定Topic，Tag和消息体
</span><span style=color:#8f5902;font-style:italic></span>    	    <span style=color:#000>Message</span> <span style=color:#000>msg</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Message</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;TopicTest&#34;</span> <span style=color:#8f5902;font-style:italic>/* Topic */</span><span style=color:#ce5c00;font-weight:700>,</span>
        	<span style=color:#4e9a06>&#34;TagA&#34;</span> <span style=color:#8f5902;font-style:italic>/* Tag */</span><span style=color:#ce5c00;font-weight:700>,</span>
        	<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Hello RocketMQ &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getBytes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RemotingHelper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DEFAULT_CHARSET</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>/* Message body */</span>
        	<span style=color:#ce5c00;font-weight:700>);</span>
        	<span style=color:#8f5902;font-style:italic>// 发送消息到一个Broker
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>SendResult</span> <span style=color:#000>sendResult</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>producer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>send</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 通过sendResult返回消息是否成功送达
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;%s%n&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sendResult</span><span style=color:#ce5c00;font-weight:700>);</span>
    	<span style=color:#ce5c00;font-weight:700>}</span>
    	<span style=color:#8f5902;font-style:italic>// 如果不再发送消息，关闭Producer实例。
</span><span style=color:#8f5902;font-style:italic></span>    	<span style=color:#000>producer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shutdown</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=2发送异步消息>2、发送异步消息</h4><p>异步消息通常用在对响应时间敏感的业务场景，即发送端不能容忍长时间地等待Broker的响应。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AsyncProducer</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    	<span style=color:#8f5902;font-style:italic>// 实例化消息生产者Producer
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>DefaultMQProducer</span> <span style=color:#000>producer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DefaultMQProducer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;please_rename_unique_group_name&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    	<span style=color:#8f5902;font-style:italic>// 设置NameServer的地址
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>producer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setNamesrvAddr</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;localhost:9876&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    	<span style=color:#8f5902;font-style:italic>// 启动Producer实例
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>producer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>producer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setRetryTimesWhenSendAsyncFailed</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
	
	<span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>messageCount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>100</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// 根据消息数量实例化倒计时计算器
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>CountDownLatch2</span> <span style=color:#000>countDownLatch</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CountDownLatch2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>messageCount</span><span style=color:#ce5c00;font-weight:700>);</span>
    	<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>messageCount</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>;</span>
            	<span style=color:#8f5902;font-style:italic>// 创建消息，并指定Topic，Tag和消息体
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>Message</span> <span style=color:#000>msg</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Message</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;TopicTest&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                    <span style=color:#4e9a06>&#34;TagA&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                    <span style=color:#4e9a06>&#34;OrderID188&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                    <span style=color:#4e9a06>&#34;Hello world&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBytes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RemotingHelper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DEFAULT_CHARSET</span><span style=color:#ce5c00;font-weight:700>));</span>
                <span style=color:#8f5902;font-style:italic>// SendCallback接收异步返回结果的回调
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>producer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>send</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SendCallback</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#5c35cc;font-weight:700>@Override</span>
                    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>onSuccess</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SendResult</span> <span style=color:#000>sendResult</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;%-10d OK %s %n&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>,</span>
                            <span style=color:#000>sendResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgId</span><span style=color:#ce5c00;font-weight:700>());</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#5c35cc;font-weight:700>@Override</span>
                    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>onException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      	              <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;%-10d Exception %s %n&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
      	              <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
            	<span style=color:#ce5c00;font-weight:700>});</span>
    	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#8f5902;font-style:italic>// 等待5s
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>countDownLatch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>await</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SECONDS</span><span style=color:#ce5c00;font-weight:700>);</span>
    	<span style=color:#8f5902;font-style:italic>// 如果不再发送消息，关闭Producer实例。
</span><span style=color:#8f5902;font-style:italic></span>    	<span style=color:#000>producer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shutdown</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=3单向发送消息>3、单向发送消息</h4><p>这种方式主要用在不特别关心发送结果的场景，例如日志发送。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>OnewayProducer</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>{</span>
    	<span style=color:#8f5902;font-style:italic>// 实例化消息生产者Producer
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>DefaultMQProducer</span> <span style=color:#000>producer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DefaultMQProducer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;please_rename_unique_group_name&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    	<span style=color:#8f5902;font-style:italic>// 设置NameServer的地址
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>producer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setNamesrvAddr</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;localhost:9876&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    	<span style=color:#8f5902;font-style:italic>// 启动Producer实例
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>producer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
    	<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>100</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        	<span style=color:#8f5902;font-style:italic>// 创建消息，并指定Topic，Tag和消息体
</span><span style=color:#8f5902;font-style:italic></span>        	<span style=color:#000>Message</span> <span style=color:#000>msg</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Message</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;TopicTest&#34;</span> <span style=color:#8f5902;font-style:italic>/* Topic */</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#4e9a06>&#34;TagA&#34;</span> <span style=color:#8f5902;font-style:italic>/* Tag */</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Hello RocketMQ &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getBytes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RemotingHelper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DEFAULT_CHARSET</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>/* Message body */</span>
        	<span style=color:#ce5c00;font-weight:700>);</span>
        	<span style=color:#8f5902;font-style:italic>// 发送单向消息，没有任何返回结果
</span><span style=color:#8f5902;font-style:italic></span>        	<span style=color:#000>producer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sendOneway</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>);</span>

    	<span style=color:#ce5c00;font-weight:700>}</span>
    	<span style=color:#8f5902;font-style:italic>// 如果不再发送消息，关闭Producer实例。
</span><span style=color:#8f5902;font-style:italic></span>    	<span style=color:#000>producer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shutdown</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote><p>Producer发送消息存在三种模式，分别为：</p><ul><li>Sync 同步</li><li>Async 异步</li><li>Oneway 单向发送</li></ul></blockquote><h3 id=2-消息发送流程源码解析>2. 消息发送流程源码解析</h3><p>DefaultMQProducer.start启动生产者，下面来看一下start的源码解析：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>MQClientException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setProducerGroup</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>withNamespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>producerGroup</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#8f5902;font-style:italic>//通过启动
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQProducerImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>traceDispatcher</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>traceDispatcher</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNamesrvAddr</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAccessChannel</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MQClientException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;trace dispatcher start failed &#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>下面看一下 <strong><code>this.defaultMQProducerImpl.start();</code></strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>MQClientException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>startFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>MQClientException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        
        <span style=color:#204a87;font-weight:700>switch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>serviceState</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>CREATE_JUST</span><span style=color:#ce5c00;font-weight:700>:</span>
            
            <span style=color:#8f5902;font-style:italic>//省略部分代码
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mQClientFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MQClientManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInstance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getOrCreateMQClientInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQProducer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rpcHook</span><span style=color:#ce5c00;font-weight:700>);</span>
        
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>startFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//启动MQClientInstance
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>mQClientFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>    
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过代码可以发现MQClientInstance是整个客户端的核心类。下面来看一下start方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>MQClientException</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>switch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>serviceState</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>CREATE_JUST</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>serviceState</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ServiceState</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>START_FAILED</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#8f5902;font-style:italic>// 在没有配置NameServer地址，适配地址
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clientConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNamesrvAddr</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mQClientAPIImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fetchNameServerAddr</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#8f5902;font-style:italic>// 启动客户端请求返回的netty 客户端
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mQClientAPIImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#8f5902;font-style:italic>// 启动各种计划任务
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>startScheduledTask</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#8f5902;font-style:italic>// 启动拉去消息服务
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pullMessageService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#8f5902;font-style:italic>// 启动负载均衡服务
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rebalanceService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#8f5902;font-style:italic>// 启动推送服务
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQProducer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDefaultMQProducerImpl</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;the client factory [{}] start OK&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clientId</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>serviceState</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ServiceState</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RUNNING</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>START_FAILED</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MQClientException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The Factory object[&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClientId</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;] has been created before, and failed.&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>default</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>MQClientInstance.start 主要做下面几件事：</p><ol><li>启动客户端消息处理</li><li>启动定时任务&ndash;更新路由信息定时任务，和broker的心跳定时任务，持久化所有的消费offset的定时任务，自适应定时线程池定时任务(减少或者增加线程数)</li><li>拉取消息服务启动</li><li>负载均衡服务启动</li><li>推送消息服务启动</li></ol><h3 id=3-消息的发送>3. 消息的发送</h3><p>通过上面的发送代码看出来主要是调用send消息，最后是通过实现DefaultMQProducerImpl.sendDefaultImpl：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>TopicPublishInfo</span> <span style=color:#000>topicPublishInfo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>tryToFindTopicPublishInfo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>());</span>
</code></pre></div><p>首先获取发送消息的Topic的路由信息。根据路由信息发送数据Message</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>MessageQueue</span> <span style=color:#000>mqSelected</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>selectOneMessageQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topicPublishInfo</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>lastBrokerName</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>然后选择一个topic对应的一个MessageQueue队列发送。下面来分析 selectOneMessageQueue 来看一下发送过程中的负载均衡。DefaultMQProducerImpl.selectOneMessageQueue</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MessageQueue</span> <span style=color:#000>selectOneMessageQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>TopicPublishInfo</span> <span style=color:#000>tpInfo</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>lastBrokerName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mqFaultStrategy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>selectOneMessageQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tpInfo</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>lastBrokerName</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>实现选择一个消息队列进行发送有MQFaultStrategy类中的selectOneMessageQueue方法来实现。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MessageQueue</span> <span style=color:#000>selectOneMessageQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>TopicPublishInfo</span> <span style=color:#000>tpInfo</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>lastBrokerName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sendLatencyFaultEnable</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tpInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSendWhichQueue</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getAndIncrement</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>tpInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageQueueList</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>abs</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#000>tpInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageQueueList</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
                        <span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#000>MessageQueue</span> <span style=color:#000>mq</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tpInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageQueueList</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>latencyFaultTolerance</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAvailable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>lastBrokerName</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerName</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lastBrokerName</span><span style=color:#ce5c00;font-weight:700>))</span>
                            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>

                <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>notBestBroker</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>latencyFaultTolerance</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pickOneAtLeast</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>writeQueueNums</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tpInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueIdByBroker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>notBestBroker</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>writeQueueNums</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MessageQueue</span> <span style=color:#000>mq</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tpInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>selectOneMessageQueue</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>notBestBroker</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBrokerName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>notBestBroker</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setQueueId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tpInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSendWhichQueue</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getAndIncrement</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#000>writeQueueNums</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>latencyFaultTolerance</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>notBestBroker</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error occurred when selecting message queue&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>tpInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>selectOneMessageQueue</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>tpInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>selectOneMessageQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lastBrokerName</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote><p>我是蚂蚁背大象，文章对你有帮助点赞关注我，文章有不正确的地方请您斧正留言评论~谢谢</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-2ff23244bad53963311bd2be6ec7bcbf>8.4 - Producer</h1><h3 id=1-消息发送的基本流程>1. 消息发送的基本流程</h3><ul><li><p><strong>消息的验证</strong></p><p>主题名称 、 消息体不能为空 、 消息长度不能等于 0且默认不能超过允许发送消息的最大长度 4M 。</p></li><li><p><strong>查找路由</strong></p><p>发送前获取路由信息，如果生产者本地缓存了路由信息直接获取返回。如果没有本地缓存则想NameServer查询topic的路由信息。如果最终没能找到路由信息则抛出异常。</p><ul><li>首先根据设置判断是否用默认主题去查询，如果默认主题查询到路由信息则替换路由信息中读写队列个数为消息生产者默认的队列个数( defaultTopicQueueNums);如果isDefault为 false，则使用参数 topic去查询;如果未查询到路由信息，则返回 false，表示路由信息未变化 。</li><li>如果路由信息找到，与本地缓存中的路由信息进行对比，判断路由信息是否发生 了改变， 如果未发生变化，则直接返回 false。</li><li>将信息转换为本地</li></ul></li><li><p><strong>消息发送</strong></p></li></ul><h3 id=2-总结>2. 总结</h3></div><div class=td-content style=page-break-before:always><h1 id=pg-2f1f4ed9fee6f5a521a12ca84d078bdb>9 - RocketMQ 消费者</h1></div><div class=td-content><h1 id=pg-f3ce38d2979b908b5298da8f7d4faaf3>9.1 - RocketMQ源码解析-消费者启动源码解析</h1><blockquote><p>以下源码基于RocketMQ 4.8.0</p></blockquote><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Consumer</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MQClientException</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#8f5902;font-style:italic>// Instantiate with specified consumer group name.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>DefaultMQPushConsumer</span> <span style=color:#000>consumer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DefaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;please_rename_unique_group_name&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
         
        <span style=color:#8f5902;font-style:italic>// Specify name server addresses.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>consumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setNamesrvAddr</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;localhost:9876&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        
        <span style=color:#8f5902;font-style:italic>// Subscribe one more more topics to consume.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>consumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>subscribe</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;TopicTest&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;*&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// Register callback to execute on arrival of messages fetched from brokers.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>consumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerMessageListener</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MessageListenerConcurrently</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>

            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ConsumeConcurrentlyStatus</span> <span style=color:#000>consumeMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageExt</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>msgs</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#000>ConsumeConcurrentlyContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;%s Receive New Messages: %s %n&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>msgs</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>ConsumeConcurrentlyStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONSUME_SUCCESS</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>});</span>

        <span style=color:#8f5902;font-style:italic>//Launch the consumer instance.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>consumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Consumer Started.%n&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>以上代码来自官网，下面基于上面的消费源码来分析消费者的源码，看一下消费者如何进行消费的。</p><h3 id=1--消费接口继承关系>1. 消费接口继承关系</h3><p><img src="https://github.com/mxsm/picture/blob/main/rocketmq/MQConsumerExtends.png?raw=true" alt></p><p>通过继承关系可以发现消费分为两中：</p><ul><li><p><strong>Push消费</strong></p><p>在启动后，Consumer客户端会主动循环发送Pull请求到broker，如果没有消息，broker会把请求放入等待队列，新消息到达后返回response</p></li><li><p><strong>Pull消费</strong></p><p>由用户主动调用pull方法来获取消息，没有则返回。从上面继承关系发现Pull的实现已经被弃用了。(暂时也不分析)</p></li></ul><h3 id=2-defaultmqpushconsumer常用设置>2. DefaultMQPushConsumer常用设置</h3><table><thead><tr><th style=text-align:center>字段</th><th style=text-align:center>说明</th><th style=text-align:center>备注</th></tr></thead><tbody><tr><td style=text-align:center>consumerGroup</td><td style=text-align:center>消费者组</td><td style=text-align:center></td></tr><tr><td style=text-align:center>messageModel</td><td style=text-align:center>消费模式(默认MessageModel.CLUSTERING)</td><td style=text-align:center>消费集群模式(CLUSTERING)和广播播模式(BROADCASTING)</td></tr><tr><td style=text-align:center>allocateMessageQueueStrategy</td><td style=text-align:center>消费策略(默认AllocateMessageQueueAveragely)</td><td style=text-align:center>AllocateMessageQueueStrategy接口有五个实现在MQ里面</td></tr><tr><td style=text-align:center>messageListener</td><td style=text-align:center>消息监听器</td><td style=text-align:center>MessageListenerConcurrently和MessageListenerOrderly<br>消息监听器对于无序消息用第一个，有序消息用第二个</td></tr><tr><td style=text-align:center>consumeThreadMin</td><td style=text-align:center>消费最小线程池(默认20)</td><td style=text-align:center></td></tr><tr><td style=text-align:center>consumeThreadMax</td><td style=text-align:center>消费最大线程池(默认20)</td><td style=text-align:center></td></tr><tr><td style=text-align:center>consumeMessageBatchMaxSize</td><td style=text-align:center>批量消费消息数量(默认1)</td><td style=text-align:center></td></tr><tr><td style=text-align:center>pullBatchSize</td><td style=text-align:center>批量拉取的消息数量的大小(默认32)</td><td style=text-align:center></td></tr></tbody></table><h3 id=3-消费者启动>3. 消费者启动</h3><p>启动流程图：</p><p><img src="https://github.com/mxsm/picture/blob/main/rocketmq/MQ%E6%B6%88%E8%B4%B9%E8%80%85%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%9B%BE.png?raw=true" alt></p><p>消费者启动最终是调用 <strong><code>DefaultMQPushConsumerImpl#start</code></strong> 方法：</p><h4 id=31-基础配置和前期实例化>3.1 基础配置和前期实例化</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//DefaultMQPushConsumerImpl#start
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>MQClientException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    
    <span style=color:#8f5902;font-style:italic>//检查一些必须要的配置
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>checkConfig</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#8f5902;font-style:italic>//拷贝订阅关系到RebalancePushImpl负载实现中
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>copySubscription</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#8f5902;font-style:italic>//集群模式将实例名称改为JVM PID
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageModel</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>MessageModel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CLUSTERING</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>changeInstanceNameToPID</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#8f5902;font-style:italic>//创建MQClientInstance
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mQClientFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MQClientManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInstance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getOrCreateMQClientInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rpcHook</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rebalanceImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rebalanceImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setMessageModel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageModel</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rebalanceImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAllocateMessageQueueStrategy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAllocateMessageQueueStrategy</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rebalanceImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setmQClientFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mQClientFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#8f5902;font-style:italic>//创建PullAPIWrapper
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pullAPIWrapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PullAPIWrapper</span><span style=color:#ce5c00;font-weight:700>(</span>
        <span style=color:#000>mQClientFactory</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>isUnitMode</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pullAPIWrapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerFilterMessageHook</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>filterMessageHookList</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span> 

</code></pre></div><ul><li>检查启动的消费者的必备参数</li><li>创建MQClientInstance实例</li><li>创建PullAPIWrapper</li></ul><h3 id=32--消费类型和消息类型不同的设置>3.2 消费类型和消息类型不同的设置</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//DefaultMQPushConsumerImpl#start
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>MQClientException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOffsetStore</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>offsetStore</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOffsetStore</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>switch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageModel</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>BROADCASTING</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>offsetStore</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LocalFileOffsetStore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mQClientFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>CLUSTERING</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>offsetStore</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RemoteBrokerOffsetStore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mQClientFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>default</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setOffsetStore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>offsetStore</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>offsetStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>load</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageListenerInner</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>MessageListenerOrderly</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumeOrderly</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumeMessageService</span> <span style=color:#ce5c00;font-weight:700>=</span>
            <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConsumeMessageOrderlyService</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageListenerOrderly</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageListenerInner</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageListenerInner</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>MessageListenerConcurrently</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumeOrderly</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumeMessageService</span> <span style=color:#ce5c00;font-weight:700>=</span>
            <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConsumeMessageConcurrentlyService</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageListenerConcurrently</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageListenerInner</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumeMessageService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul><li>根据消费模式不同创建不同的消费进度加载情况。广播消费从本地加载，集群消费从Broker端进行加载</li><li>根据消息类型的不同创建不同的消费消息服务。 无序消息创建并发消费服务，有序消息创建有序消息消费服务</li></ul><blockquote><p>注意：集群消费消息的消费进度保存在Broker端，广播消费消息的进度保存在消费组本地</p></blockquote><h4 id=33-消费启动>3.3 消费启动</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>mQClientFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div><h3 id=4-mqclientinstancestart-启动>4. MQClientInstance#start 启动</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>MQClientException</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>switch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>serviceState</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>CREATE_JUST</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>serviceState</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ServiceState</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>START_FAILED</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#8f5902;font-style:italic>// If not specified,looking address from name server
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clientConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNamesrvAddr</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mQClientAPIImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fetchNameServerAddr</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#8f5902;font-style:italic>// 启动客户端channel
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mQClientAPIImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#8f5902;font-style:italic>// 启动多个定时任务
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>startScheduledTask</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#8f5902;font-style:italic>// 启动拉取消息服务
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pullMessageService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#8f5902;font-style:italic>// 启动负载均衡服务
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rebalanceService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#8f5902;font-style:italic>// 启动push服务(显示过期方法这个不关注)
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQProducer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDefaultMQProducerImpl</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;the client factory [{}] start OK&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clientId</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>serviceState</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ServiceState</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RUNNING</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>START_FAILED</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MQClientException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The Factory object[&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClientId</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;] has been created before, and failed.&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>default</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>到这里消费者客户端就启动完成了。可以对MQ消息进行消费了。</p><h3 id=5-总结与思考>5. 总结与思考</h3><p>在分析过程中有几个比较重要的地方：</p><ul><li><p><strong>消费模式</strong></p><p>集群消费模式和广播消费模式，不同的消费模式模式下获取消费者的消费进度地方不一样。</p></li><li><p><strong>消息类型</strong></p><p>不同的消息类型处理消息类型的服务也不一样，无序消息类型处理消息类型的类为：ConsumeMessageConcurrentlyService， 而有序消费类型处理消费的服务为：ConsumeMessageOrderlyService</p></li><li><p><strong>消费端的定时任务</strong></p><p>消费者启动后，客户端还有好几个定时任务在本地跑。</p></li><li><p><strong>分配消息队列的消费策略</strong></p><p>通过选择不同的消费策略来实现不同的消费者对消息的消费</p></li><li><p><strong>消费的负载均衡</strong></p><p>负载均衡的实现</p></li><li><p><strong>消费者消息流量控制</strong></p><p>如何消息进行流量控制</p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-4a9d2f0e9f10fa0bec13d5d37250a300>9.2 - RocketMQ源码解析-消费者定时任务解析</h1><blockquote><p>以下源码基于RocketMQ 4.8.0</p></blockquote><p>在分析消费者启动消费的时候我们看到了，在本地启动一系列的定时任务。下面就来分析这些定时任务的作用在整个消费的过程中。定时任务启动在 <strong><code>MQClientInstance#startScheduledTask</code></strong> 方法中。</p><h3 id=1-读取namesrv地址>1. 读取Namesrv地址</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clientConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNamesrvAddr</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scheduledExecutorService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scheduleAtFixedRate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>MQClientInstance</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mQClientAPIImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fetchNameServerAddr</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;ScheduledTask fetchNameServerAddr exception&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>1000</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>1000</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>60</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MILLISECONDS</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>说明: 延迟10秒执行，每两分钟获取一次Namesrv的地址(在NamesrvAddr为空的情况下)</p><h3 id=2-从namesrv更新topic路由信息>2. 从Namesrv更新Topic路由信息</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scheduledExecutorService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scheduleAtFixedRate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>MQClientInstance</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>updateTopicRouteInfoFromNameServer</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;ScheduledTask updateTopicRouteInfoFromNameServer exception&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clientConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPollNameServerInterval</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MILLISECONDS</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>说明：默认每30秒更新一次Topic路由信息</p><h3 id=3-清除离线broker和发送心跳给broker>3. 清除离线Broker和发送心跳给Broker</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scheduledExecutorService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scheduleAtFixedRate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>MQClientInstance</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cleanOfflineBroker</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>MQClientInstance</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sendHeartbeatToAllBrokerWithLock</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;ScheduledTask sendHeartbeatToAllBroker exception&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>1000</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clientConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getHeartbeatBrokerInterval</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MILLISECONDS</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>说明：默认每30秒清除一次离线的Broker,给所有的Broker发送心跳</p><h3 id=4-持久化消费进度>4. 持久化消费进度</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scheduledExecutorService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scheduleAtFixedRate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>MQClientInstance</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>persistAllConsumerOffset</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;ScheduledTask persistAllConsumerOffset exception&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>1000</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clientConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPersistConsumerOffsetInterval</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MILLISECONDS</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>说明：默认每5秒钟持久化一次消费进度。(正常关闭的时候回也会持久化)</p><h3 id=5-线程池适配>5. 线程池适配</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scheduledExecutorService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scheduleAtFixedRate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>MQClientInstance</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>adjustThreadPool</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;ScheduledTask adjustThreadPool exception&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MINUTES</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>说明:每一分钟适配一次</p></div><div class=td-content style=page-break-before:always><h1 id=pg-e0711aee983677d5223cac91b892553c>9.3 - RocketMQ源码解析-消费模式消费进度加载源码解析</h1><blockquote><p>以下源码基于RocketMQ 4.8.0</p></blockquote><p>MQ的消费模式通过之前的分析可以知道有两种：</p><ul><li>集群消费模式(CLUSTERING)</li><li>广播消费模式(BROADCASTING)</li></ul><p>两种不同类型的消费模式当中有区别，下面通过源码来说明：</p><h3 id=1-从何处加载消费进度>1. 从何处加载消费进度？</h3><p>从之前的分析可以知道，Consumer通过调用：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>consumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div><p>在启动后会加载消费进度 <strong><code>DefaultMQPushConsumerImpl#start</code></strong> 代码片段：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOffsetStore</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
     <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>offsetStore</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOffsetStore</span><span style=color:#ce5c00;font-weight:700>();</span>
 <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
     <span style=color:#204a87;font-weight:700>switch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageModel</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>BROADCASTING</span><span style=color:#ce5c00;font-weight:700>:</span>
             <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>offsetStore</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LocalFileOffsetStore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mQClientFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>());</span>
             <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
         <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>CLUSTERING</span><span style=color:#ce5c00;font-weight:700>:</span>
             <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>offsetStore</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RemoteBrokerOffsetStore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mQClientFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>());</span>
             <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
         <span style=color:#204a87;font-weight:700>default</span><span style=color:#ce5c00;font-weight:700>:</span>
             <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
     <span style=color:#ce5c00;font-weight:700>}</span>
     <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setOffsetStore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>offsetStore</span><span style=color:#ce5c00;font-weight:700>);</span>
 <span style=color:#ce5c00;font-weight:700>}</span>
 <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>offsetStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>load</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div><p>代码可以看出：</p><ul><li>BROADCASTING的消费模式消费进度的持久化由LocalFileOffsetStore实现</li><li>CLUSTERING的消费模式消费进度的持久化由RemoteBrokerOffsetStore实现</li></ul><p>两者都实现了 <strong><code>OffsetStore</code></strong> 接口，该接口提供了例如：加载消费进度、持久化消费进度、更新消费进度等功能：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>OffsetStore</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>load</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>MQClientException</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>updateOffset</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MessageQueue</span> <span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>increaseOnly</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>readOffset</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MessageQueue</span> <span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ReadOffsetType</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>persistAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>mqs</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>persist</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MessageQueue</span> <span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>removeOffset</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageQueue</span> <span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>cloneOffsetTable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>updateConsumeOffsetToBroker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageQueue</span> <span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isOneway</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>RemotingException</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>MQBrokerException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>InterruptedException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MQClientException</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div><p>通过上面的分析可以看出来，是通过调用 OffsetStore#load方法来加载消费进度。</p><p><strong>RemoteBrokerOffsetStore#load</strong> 的实现：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>RemoteBrokerOffsetStore</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>OffsetStore</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>InternalLogger</span> <span style=color:#000>log</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ClientLogger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLog</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MQClientInstance</span> <span style=color:#000>mQClientFactory</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>groupName</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ConcurrentMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>AtomicLong</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>offsetTable</span> <span style=color:#ce5c00;font-weight:700>=</span>
        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConcurrentHashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>AtomicLong</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>RemoteBrokerOffsetStore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MQClientInstance</span> <span style=color:#000>mQClientFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>groupName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mQClientFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mQClientFactory</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>groupName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>groupName</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>load</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        
        <span style=color:#8f5902;font-style:italic>//空实现？
</span><span style=color:#8f5902;font-style:italic></span>        
    <span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#8f5902;font-style:italic>//省略部分代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote><p>RemoteBrokerOffsetStore发现是空实现，原因是因为集群消费的消费进度保存在Broker端</p></blockquote><p><strong>LocalFileOffsetStore#load</strong> 实现：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>LocalFileOffsetStore</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>OffsetStore</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>String</span> <span style=color:#000>LOCAL_OFFSET_STORE_DIR</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProperty</span><span style=color:#ce5c00;font-weight:700>(</span>
        <span style=color:#4e9a06>&#34;rocketmq.client.localOffsetStoreDir&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;user.home&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>File</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>separator</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;.rocketmq_offsets&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>InternalLogger</span> <span style=color:#000>log</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ClientLogger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLog</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MQClientInstance</span> <span style=color:#000>mQClientFactory</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>groupName</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>storePath</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ConcurrentMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>AtomicLong</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>offsetTable</span> <span style=color:#ce5c00;font-weight:700>=</span>
        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConcurrentHashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>AtomicLong</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>load</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>MQClientException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>OffsetSerializeWrapper</span> <span style=color:#000>offsetSerializeWrapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readLocalOffset</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offsetSerializeWrapper</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>offsetSerializeWrapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOffsetTable</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>offsetTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offsetSerializeWrapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOffsetTable</span><span style=color:#ce5c00;font-weight:700>());</span>

            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageQueue</span> <span style=color:#000>mq</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>offsetSerializeWrapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOffsetTable</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>keySet</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>AtomicLong</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>offsetSerializeWrapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOffsetTable</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;load consumer&#39;s offset, {} {} {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>groupName</span><span style=color:#ce5c00;font-weight:700>,</span>
                    <span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>,</span>
                    <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//省略其他代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过 LocalFileOffsetStore#load实现可以看出来，广播消费是在本地加载消费进度，消费进度保存在消费者本地。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-affc4b406e122036a5eb9f43a5c1ee03>9.4 - RocketMQ源码解析-并发消费消息源码解析</h1><blockquote><p>以下源码基于RocketMQ 4.8.0</p></blockquote><p>RocketMQ的消费模式有两种分别为：</p><ul><li>集群消费模式(CLUSTERING)</li><li>广播消费模式(BROADCASTING)</li></ul><p>然而在对于消息的类型分为以下几种：</p><ul><li>无序消息(并发消息)</li><li>顺序消息</li><li>延迟消息</li><li>事务消息</li></ul><p>接下来逐个通过源码来分析这些消息在不同的模式下是如何进行消费的。在客户端在启动的时候 <strong><code>DefaultMQPushConsumerImpl#start</code></strong> 方法中有这样一个代码片段：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageListenerInner</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>MessageListenerOrderly</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumeOrderly</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumeMessageService</span> <span style=color:#ce5c00;font-weight:700>=</span>
        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConsumeMessageOrderlyService</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageListenerOrderly</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageListenerInner</span><span style=color:#ce5c00;font-weight:700>());</span>
<span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageListenerInner</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>MessageListenerConcurrently</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumeOrderly</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumeMessageService</span> <span style=color:#ce5c00;font-weight:700>=</span>
        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConsumeMessageConcurrentlyService</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageListenerConcurrently</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageListenerInner</span><span style=color:#ce5c00;font-weight:700>());</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumeMessageService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div><p>通过判断设置的 <strong><code>MessageListener</code></strong> 监听器为 <strong><code>MessageListenerOrderly</code></strong> 还是 <strong><code>MessageListenerConcurrently</code></strong> 监听器来判断消费消息的服务是用 <strong><code>ConsumeMessageOrderlyService</code></strong> 还是 <strong><code>ConsumeMessageConcurrentlyService</code></strong> 。总结一下：</p><ul><li>无序消息由 <strong><code>ConsumeMessageConcurrentlyService</code></strong> 处理</li><li>有序消息由 <strong><code>ConsumeMessageOrderlyService</code></strong> 处理</li></ul><h3 id=1-并发消费服务consumemessageconcurrentlyservice启动>1. 并发消费服务ConsumeMessageConcurrentlyService启动</h3><p>在 <strong><code>DefaultMQPushConsumerImpl#start</code></strong> 方法中调用 <strong><code>this.consumeMessageService.start();</code></strong> 启动并发服务。下面来看一下并发服务启动做了什么：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ConsumeMessageConcurrentlyService</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>ConsumeMessageService</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cleanExpireMsgExecutors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scheduleAtFixedRate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>

            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>cleanExpireMsg</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumeTimeout</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumeTimeout</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MINUTES</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从代码可以看出是定时清除过期的消息。</p><h3 id=2-消息拉取>2. 消息拉取</h3><p>在 <strong><code>MQClientInstance#start</code></strong> 方法中启动消息的拉取服务：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>MQClientException</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>switch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>serviceState</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>CREATE_JUST</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>serviceState</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ServiceState</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>START_FAILED</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#8f5902;font-style:italic>// If not specified,looking address from name server
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clientConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNamesrvAddr</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mQClientAPIImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fetchNameServerAddr</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#8f5902;font-style:italic>// Start request-response channel
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mQClientAPIImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#8f5902;font-style:italic>// Start various schedule tasks
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>startScheduledTask</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#8f5902;font-style:italic>// 拉取服务启动
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pullMessageService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#8f5902;font-style:italic>// Start rebalance service
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rebalanceService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#8f5902;font-style:italic>// Start push service
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQProducer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDefaultMQProducerImpl</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;the client factory [{}] start OK&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clientId</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>serviceState</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ServiceState</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RUNNING</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>START_FAILED</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MQClientException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The Factory object[&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClientId</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;] has been created before, and failed.&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>default</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>下面看一下拉取服务 <strong><code>PullMessageService#start</code></strong> 方法中做了一些什么事情。 <strong><code>PullMessageService</code></strong> 本质是一个线程的实现类实现了 <strong><code>Runnable</code></strong> ，所以调用start方法是调用了 <strong><code>Thread#start</code></strong> 。最终执行的是 <strong><code>PullMessageService#run</code></strong> 方法。逻辑在这个里面：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PullMessageService</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ServiceThread</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>InternalLogger</span> <span style=color:#000>log</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ClientLogger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLog</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>//拉取请求的阻塞队列
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>LinkedBlockingQueue</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PullRequest</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>pullRequestQueue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedBlockingQueue</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PullRequest</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MQClientInstance</span> <span style=color:#000>mQClientFactory</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ScheduledExecutorService</span> <span style=color:#000>scheduledExecutorService</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Executors</span>
        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newSingleThreadScheduledExecutor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ThreadFactory</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Thread</span> <span style=color:#000>newThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Runnable</span> <span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;PullMessageServiceScheduledThread&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>});</span>
    
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getServiceName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; service started&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isStopped</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>//循环的从阻塞队列中获取PullRequest
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>PullRequest</span> <span style=color:#000>pullRequest</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pullRequestQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>take</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pullMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>ignored</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Pull Message Service Run Method exception&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getServiceName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; service end&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后调用了 <strong><code>PullMessageService#pullMessage</code></strong> 私有方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>pullMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PullRequest</span> <span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MQConsumerInner</span> <span style=color:#000>consumer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mQClientFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>selectConsumer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>consumer</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>DefaultMQPushConsumerImpl</span> <span style=color:#000>impl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DefaultMQPushConsumerImpl</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>consumer</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>impl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pullMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;No matched consumer for the PullRequest {}, drop it&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>最终请求了 <strong><code>DefaultMQPushConsumerImpl#pullMessage</code></strong> 方法。这个会在后续进行分析。</p><p>分析到这里会发现一个问题，<strong><code>PullMessageService</code></strong> 类实例化的时候 <strong><code>pullRequestQueue</code></strong> 队列是空的那么在 <strong><code>PullMessageService#run</code></strong> 方法中获取 <strong><code>PullRequest</code></strong> 会阻塞。那么在哪里会将 <strong><code>PullRequest</code></strong> 加入到队列中。在 <strong><code>PullMessageService</code></strong> 中还有几个重要的方法，这些方法就是向队列中添加 <strong><code>PullRequest</code></strong> ：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PullMessageService</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ServiceThread</span> <span style=color:#ce5c00;font-weight:700>{</span>
    
    <span style=color:#8f5902;font-style:italic>//延迟加入
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>executePullRequestLater</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PullRequest</span> <span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>timeDelay</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>isStopped</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scheduledExecutorService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>schedule</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#5c35cc;font-weight:700>@Override</span>
                <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>PullMessageService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>executePullRequestImmediately</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>timeDelay</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MILLISECONDS</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;PullMessageServiceScheduledThread has shutdown&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>//立马加入
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>executePullRequestImmediately</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PullRequest</span> <span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pullRequestQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;executePullRequestImmediately pullRequestQueue.put&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=3-pullrequest放入队列>3. PullRequest放入队列</h3><p>首先我们通过开发工具来看下调用链：</p><p><img src="https://github.com/mxsm/picture/blob/main/rocketmq/putPullRequest.png?raw=true" alt></p><p>通过分析调用链发现是 <strong><code>RebalanceService#run</code></strong> 方法。最终将 <strong><code>PullRequest</code></strong> 存放到队列。</p><h3 id=4-pullrequest处理>4. PullRequest处理</h3><p>从阻塞队列中取出 <strong><code>PullRequest</code></strong> ,调用 <strong><code>PullMessageService#pullMessage</code></strong> 方法。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>pullMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PullRequest</span> <span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MQConsumerInner</span> <span style=color:#000>consumer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mQClientFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>selectConsumer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>consumer</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>DefaultMQPushConsumerImpl</span> <span style=color:#000>impl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DefaultMQPushConsumerImpl</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>consumer</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>impl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pullMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;No matched consumer for the PullRequest {}, drop it&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过代码跟踪可以发现最终是通过 <strong><code>DefaultMQPushConsumerImpl#pullMessage</code></strong> 来处理。</p><h3 id=5-defaultmqpushconsumerimplpullmessage>5. DefaultMQPushConsumerImpl#pullMessage</h3><p>这个方法主要用来处理拉取消息和处理，同时在这个方法中还有一些流量控制(专门用一个篇章去分析说明)等等。在
<strong>DefaultMQPushConsumerImpl#pullMessage</strong> 方法中有一个 <strong>PullCallback</strong> 回调接口，里面处理消息拉取成功后回调的处理,下面看一下 <strong>pullResult.getPullStatus()</strong> 为 <strong>FOUND</strong> 的状态(表示拉取到了消息)：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>FOUND</span><span style=color:#ce5c00;font-weight:700>:</span>
    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>prevRequestOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNextOffset</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setNextOffset</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pullResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNextBeginOffset</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>pullRT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>beginTimestamp</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>//消息拉取花费的时间
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>DefaultMQPushConsumerImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerStatsManager</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>incPullRT</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(),</span>
        <span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageQueue</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>pullRT</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>firstMsgOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MAX_VALUE</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>//拉取结果消息列表为空，将请求重新放入消息拉取请求阻塞队列
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pullResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgFoundList</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>pullResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgFoundList</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>DefaultMQPushConsumerImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>executePullRequestImmediately</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>firstMsgOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pullResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgFoundList</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getQueueOffset</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>//消费者消息增加数量
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>DefaultMQPushConsumerImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerStatsManager</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>incPullTPS</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(),</span>
            <span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageQueue</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>pullResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgFoundList</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#8f5902;font-style:italic>//是否分配消费--顺序消费处理
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>dispatchToConsume</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>processQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pullResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgFoundList</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#8f5902;font-style:italic>//消费消息服务消费消息
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>DefaultMQPushConsumerImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumeMessageService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>submitConsumeRequest</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#000>pullResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgFoundList</span><span style=color:#ce5c00;font-weight:700>(),</span>
            <span style=color:#000>processQueue</span><span style=color:#ce5c00;font-weight:700>,</span>
            <span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageQueue</span><span style=color:#ce5c00;font-weight:700>(),</span>
            <span style=color:#000>dispatchToConsume</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#8f5902;font-style:italic>//消费完成将拉取请求重新放入请求队列中
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DefaultMQPushConsumerImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPullInterval</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>DefaultMQPushConsumerImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>executePullRequestLater</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#000>DefaultMQPushConsumerImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPullInterval</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>DefaultMQPushConsumerImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>executePullRequestImmediately</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pullResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNextBeginOffset</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>prevRequestOffset</span>
        <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>firstMsgOffset</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>prevRequestOffset</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#4e9a06>&#34;[BUG] pull message result maybe data wrong, nextBeginOffset: {} firstMsgOffset: {} prevRequestOffset: {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
            <span style=color:#000>pullResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNextBeginOffset</span><span style=color:#ce5c00;font-weight:700>(),</span>
            <span style=color:#000>firstMsgOffset</span><span style=color:#ce5c00;font-weight:700>,</span>
            <span style=color:#000>prevRequestOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><p>在拉取成功后状态为 <strong>FOUND</strong>：</p><ul><li>统计拉取消息花费的时间</li><li>判断拉取的消息是否有，没有将PullRequest请求放入请求队列中</li><li>处理拉取的消费组、Topic消息的增加</li><li>由ConsumeMessageService服务来消费消息(根据不同的消息类型调用不同的消费者实例)</li><li>根据是否需要延迟将PullRequest放入队列</li></ul><h3 id=6-consumemessageconcurrentlyservicesubmitconsumerequest>6. ConsumeMessageConcurrentlyService#submitConsumeRequest</h3><p>通过判断消费者启动的时候设置的消费最大的消费的数量(默认为1)，</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>submitConsumeRequest</span><span style=color:#ce5c00;font-weight:700>(</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageExt</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>msgs</span><span style=color:#ce5c00;font-weight:700>,</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ProcessQueue</span> <span style=color:#000>processQueue</span><span style=color:#ce5c00;font-weight:700>,</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MessageQueue</span> <span style=color:#000>messageQueue</span><span style=color:#ce5c00;font-weight:700>,</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>dispatchToConsume</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>consumeBatchSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumeMessageBatchMaxSize</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>consumeBatchSize</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//构建消费请求
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>ConsumeRequest</span> <span style=color:#000>consumeRequest</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConsumeRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>processQueue</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>messageQueue</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//提交线程池执行消费
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumeExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>submit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RejectedExecutionException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//线程池满了延迟，随后延迟添加
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>submitConsumeRequestLater</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>//省略部分代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>构建批量消费的请求：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>total</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>total</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>msgs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageExt</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>msgThis</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageExt</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>consumeBatchSize</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>//构建消息列表
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>consumeBatchSize</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++,</span> <span style=color:#000>total</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>total</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>msgs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>msgThis</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>total</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//构建消费请求
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>ConsumeRequest</span> <span style=color:#000>consumeRequest</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConsumeRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgThis</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>processQueue</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>messageQueue</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumeExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>submit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RejectedExecutionException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//将所有剩下的数据都加入列表
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;</span> <span style=color:#000>total</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>msgs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#000>total</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>msgThis</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>total</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//延迟提交请求到线程池
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>submitConsumeRequestLater</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>submitConsumeRequest方法主要是构建ConsumeRequest提交到消费线程池中对消息进行消费。</p><h3 id=7-consumerequest源码解析>7. ConsumeRequest源码解析</h3><p>ConsumeRequest实现了Runnable，所以所有的逻辑都在run方法中，下面来分析一下逻辑：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>MessageListenerConcurrently</span> <span style=color:#000>listener</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ConsumeMessageConcurrentlyService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageListener</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#000>ConsumeConcurrentlyContext</span> <span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConsumeConcurrentlyContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>messageQueue</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>ConsumeConcurrentlyStatus</span> <span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#000>defaultMQPushConsumerImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resetRetryAndNamespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>());</span>

<span style=color:#000>ConsumeMessageContext</span> <span style=color:#000>consumeMessageContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConsumeMessageConcurrentlyService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumerImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasHook</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>consumeMessageContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConsumeMessageContext</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>consumeMessageContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setNamespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNamespace</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>consumeMessageContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>consumeMessageContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setProps</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;());</span>
    <span style=color:#000>consumeMessageContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setMq</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>messageQueue</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>consumeMessageContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setMsgList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgs</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>consumeMessageContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSuccess</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>ConsumeMessageConcurrentlyService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumerImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>executeHookBefore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>consumeMessageContext</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>对消息拉取进行设置，以及设置Hook执行前执行ConsumeMessageContext，</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>beginTimestamp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>hasException</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#000>ConsumeReturnType</span> <span style=color:#000>returnType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ConsumeReturnType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SUCCESS</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgs</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>msgs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//设置消费开始时间
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageExt</span> <span style=color:#000>msg</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>msgs</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>MessageAccessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setConsumeStartTimeStamp</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>valueOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>()));</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//消费消息---也就业务逻辑
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>listener</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumeMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unmodifiableList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgs</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;consumeMessage exception: {} Group: {} Msgs: {} MQ: {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>RemotingHelper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>exceptionSimpleDesc</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>),</span>
        <span style=color:#000>ConsumeMessageConcurrentlyService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumerGroup</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>msgs</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>messageQueue</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>hasException</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>consumeRT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>beginTimestamp</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><p>上面的代码主要是我们写在 <strong>MessageListenerConcurrently</strong> 中的消费业务逻辑。通过消费状态来判断消息的后续处理。</p><blockquote><p>这里有在消费报错的情况下的处理hasException = true</p></blockquote><p>下面看一下不同状态下返回的returnType:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>consumeRT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>beginTimestamp</span><span style=color:#ce5c00;font-weight:700>;</span>
 <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>status</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
     <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasException</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>returnType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ConsumeReturnType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>EXCEPTION</span><span style=color:#ce5c00;font-weight:700>;</span>
     <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>returnType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ConsumeReturnType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RETURNNULL</span><span style=color:#ce5c00;font-weight:700>;</span>
     <span style=color:#ce5c00;font-weight:700>}</span>
 <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>consumeRT</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumeTimeout</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>60</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>1000</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
     <span style=color:#000>returnType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ConsumeReturnType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TIME_OUT</span><span style=color:#ce5c00;font-weight:700>;</span>
 <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConsumeConcurrentlyStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RECONSUME_LATER</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>status</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
     <span style=color:#000>returnType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ConsumeReturnType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>FAILED</span><span style=color:#ce5c00;font-weight:700>;</span>
 <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConsumeConcurrentlyStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONSUME_SUCCESS</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>status</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
     <span style=color:#000>returnType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ConsumeReturnType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SUCCESS</span><span style=color:#ce5c00;font-weight:700>;</span>
 <span style=color:#ce5c00;font-weight:700>}</span>

 <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConsumeMessageConcurrentlyService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumerImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasHook</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
     <span style=color:#000>consumeMessageContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProps</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MixAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONSUME_CONTEXT_TYPE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>returnType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>name</span><span style=color:#ce5c00;font-weight:700>());</span>
 <span style=color:#ce5c00;font-weight:700>}</span>

 <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>status</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
     <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;consumeMessage return null, Group: {} Msgs: {} MQ: {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
         <span style=color:#000>ConsumeMessageConcurrentlyService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumerGroup</span><span style=color:#ce5c00;font-weight:700>,</span>
         <span style=color:#000>msgs</span><span style=color:#ce5c00;font-weight:700>,</span>
         <span style=color:#000>messageQueue</span><span style=color:#ce5c00;font-weight:700>);</span>
     <span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ConsumeConcurrentlyStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RECONSUME_LATER</span><span style=color:#ce5c00;font-weight:700>;</span>
 <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>MessageListenerConcurrently</strong> 监听主要返回 <strong>ConsumeConcurrentlyStatus.CONSUME_SUCCESS</strong> 和 <strong>ConsumeConcurrentlyStatus.RECONSUME_LATER</strong> 两种消费类型。根据不同的状态接下来处理消费后的结果， <strong>ConsumeMessageConcurrentlyService#processConsumeResult</strong> 最终处理消费后的消息。接下来看看结果的处理：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>switch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>status</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>CONSUME_SUCCESS</span><span style=color:#ce5c00;font-weight:700>:</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ackIndex</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgs</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>ackIndex</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgs</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ok</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ackIndex</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>failed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgs</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>ok</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerStatsManager</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>incConsumeOKTPS</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>consumerGroup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageQueue</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>ok</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerStatsManager</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>incConsumeFailedTPS</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>consumerGroup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageQueue</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>failed</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RECONSUME_LATER</span><span style=color:#ce5c00;font-weight:700>:</span>
        <span style=color:#000>ackIndex</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerStatsManager</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>incConsumeFailedTPS</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>consumerGroup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageQueue</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span>
            <span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgs</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>default</span><span style=color:#ce5c00;font-weight:700>:</span>
        <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>第一部分处理消息的ackIdex和处理消息的TPS等。处理完成后接下来处理根据不同的消费类型:</p><ul><li>集群消费</li><li>广播消费</li></ul><p>两种情况：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>switch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageModel</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>BROADCASTING</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#8f5902;font-style:italic>//广播消费
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ackIndex</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgs</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>MessageExt</span> <span style=color:#000>msg</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgs</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;BROADCASTING, the message consume failed, drop it, {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>CLUSTERING</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#8f5902;font-style:italic>//集群消费--处理消费失败的数据
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageExt</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>msgBackFailed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageExt</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgs</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ackIndex</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgs</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>MessageExt</span> <span style=color:#000>msg</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgs</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>//将消息重新发回
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sendMessageBack</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setReconsumeTimes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getReconsumeTimes</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>msgBackFailed</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>msgBackFailed</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgs</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>removeAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgBackFailed</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>submitConsumeRequestLater</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgBackFailed</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProcessQueue</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageQueue</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>default</span><span style=color:#ce5c00;font-weight:700>:</span>
        <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在集群消费后将消费失败的消息发送回去Broker。用来给后续的进行重复消费</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProcessQueue</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>removeMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgs</span><span style=color:#ce5c00;font-weight:700>());</span>
<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProcessQueue</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isDropped</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumerImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOffsetStore</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>updateOffset</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageQueue</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>消费进度，通过一个TreeMap将数据的删除消费的消息的偏移量。然后获取第一个key这个就是未消费的最小偏移量。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-364fe808b49f058a193321e037d185cf>9.5 - RocketMQ源码解析-消费者消费策略源码解析</h1><blockquote><p>以下源码基于Rocket MQ 4.7.0</p></blockquote><h3 id=1-消费者的两种消费方式>1. 消费者的两种消费方式</h3><ol><li><strong>Push消费&ndash;底层通过长轮询来实现(DefaultMQPushConsumer来实现的)</strong></li><li><strong>Pull消费&ndash;(4.7.0中代码已经用Deprecated标记了DefaultMQPullConsumer的实现)</strong></li></ol><h3 id=2-消费者消费模型>2. 消费者消费模型</h3><p><img src=https://raw.githubusercontent.com/mxsm/document/master/image/MQ/RocketMQ/Cosume%E6%B6%88%E8%B4%B9%E6%9E%B6%E6%9E%84.png alt></p><h3 id=3-消费者并发消费数据>3. 消费者并发消费数据</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Consumer</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MQClientException</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#8f5902;font-style:italic>// Instantiate with specified consumer group name.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>DefaultMQPushConsumer</span> <span style=color:#000>consumer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DefaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;please_rename_unique_group_name&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
         
        <span style=color:#8f5902;font-style:italic>// Specify name server addresses.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>consumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setNamesrvAddr</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;localhost:9876&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        
        <span style=color:#8f5902;font-style:italic>// Subscribe one more more topics to consume.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>consumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>subscribe</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;TopicTest&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;*&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// Register callback to execute on arrival of messages fetched from brokers.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>consumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerMessageListener</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MessageListenerConcurrently</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>

            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ConsumeConcurrentlyStatus</span> <span style=color:#000>consumeMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageExt</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>msgs</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#000>ConsumeConcurrentlyContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;%s Receive New Messages: %s %n&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>msgs</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>ConsumeConcurrentlyStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONSUME_SUCCESS</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>});</span>

        <span style=color:#8f5902;font-style:italic>//Launch the consumer instance.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>consumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Consumer Started.%n&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div><p>代码来自官网的例子，这个就是并发消费MQ消息。通过设置MessageListenerConcurrently并发的监听器来实现监听消费的消息然后做后续的处理。通过调用 <strong><code>DefaultMQPushConsumer.start</code></strong> 方法来启动消费者消费。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DefaultMQPushConsumer</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ClientConfig</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>MQPushConsumer</span> <span style=color:#ce5c00;font-weight:700>{</span>
    
    <span style=color:#8f5902;font-style:italic>//消费实现类
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>transient</span> <span style=color:#000>DefaultMQPushConsumerImpl</span> <span style=color:#000>defaultMQPushConsumerImpl</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#8f5902;font-style:italic>//消费组
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>consumerGroup</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#8f5902;font-style:italic>//消费模式--默认为集群消费，还有一种BROADCASTING 广播消费
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>MessageModel</span> <span style=color:#000>messageModel</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MessageModel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CLUSTERING</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#8f5902;font-style:italic>//消费的起始位置--默认为末尾的offset
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ConsumeFromWhere</span> <span style=color:#000>consumeFromWhere</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ConsumeFromWhere</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONSUME_FROM_LAST_OFFSET</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#8f5902;font-style:italic>//消息队列分配策略
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>AllocateMessageQueueStrategy</span> <span style=color:#000>allocateMessageQueueStrategy</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#8f5902;font-style:italic>//topic和订阅关系 
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span> <span style=color:#8f5902;font-style:italic>/* topic */</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#8f5902;font-style:italic>/* sub expression */</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>subscription</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
    
    <span style=color:#8f5902;font-style:italic>//消息监听器--并发消费和顺序消费 
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>MessageListener</span> <span style=color:#000>messageListener</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#8f5902;font-style:italic>//消费offset存储实现 
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>OffsetStore</span> <span style=color:#000>offsetStore</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#8f5902;font-style:italic>//最小消费线程数  
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>consumeThreadMin</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>20</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>//最大消费线程数
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>consumeThreadMax</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>20</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>//用于动态调整线程池数目的阈值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>adjustThreadPoolNumsThreshold</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>100000</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>//并发同时最大跨度偏移。它对顺序消费没有影响
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>consumeConcurrentlyMaxSpan</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>2000</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>//流控制阈值在队列级别，每个消息队列默认最多缓存1000条消息
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>pullThresholdForQueue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1000</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>//在队列级别限制缓存的消息大小，默认情况下每个消息队列最多缓存100 MiB消息
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>pullThresholdSizeForQueue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>100</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#8f5902;font-style:italic>//拉Topic的阈值--无限制
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>pullThresholdForTopic</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#000>限制主题级别上缓存的消息大小</span><span style=color:#a40000>，</span><span style=color:#000>默认值为</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span> <span style=color:#000>MiB</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>无限制</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>pullThresholdSizeForTopic</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>//消息拉取间隔
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>pullInterval</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>//批量消费规模
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>consumeMessageBatchMaxSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>//批处理拉取大小
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>pullBatchSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>32</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>//是否每次拉取的时候更新订阅关系
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>postSubscriptionWhenPull</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>


    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>unitMode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>//最大重复消费次数- -1-16
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>maxReconsumeTimes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>//对于需要缓慢拉动的情况，如流量控制情况，暂停拉动时间。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>suspendCurrentQueueTimeMillis</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1000</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>//以分钟为单位的最大时间量可能会阻塞正在使用的线程。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>consumeTimeout</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>15</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>//异步传输数据的接口
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>TraceDispatcher</span> <span style=color:#000>traceDispatcher</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#8f5902;font-style:italic>//.........省略部分代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>MQClientException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>setConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NamespaceUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wrapNamespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNamespace</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumerGroup</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumerImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>traceDispatcher</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>traceDispatcher</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNamesrvAddr</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAccessChannel</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MQClientException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;trace dispatcher start failed &#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过调用 <strong><code>DefaultMQPushConsumerImpl.start</code></strong> 方法来启动消费。看一下DefaultMQPushConsumerImpl的创建</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#8f5902;font-style:italic>// this 为DefaultMQPushConsumer的实例
</span><span style=color:#8f5902;font-style:italic></span> <span style=color:#000>defaultMQPushConsumerImpl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DefaultMQPushConsumerImpl</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rpcHook</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>接下来看一下 start方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>MQClientException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>switch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>serviceState</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>CREATE_JUST</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;the consumer [{}] start beginning. messageModel={}, isUnitMode={}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(),</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageModel</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isUnitMode</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>serviceState</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ServiceState</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>START_FAILED</span><span style=color:#ce5c00;font-weight:700>;</span>

                <span style=color:#8f5902;font-style:italic>//检查配置信息包括 是否设置了消费组，消费模式等等
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>checkConfig</span><span style=color:#ce5c00;font-weight:700>();</span>

                <span style=color:#8f5902;font-style:italic>//拷贝订阅关系到RebalanceImpl中
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>copySubscription</span><span style=color:#ce5c00;font-weight:700>();</span>

                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageModel</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>MessageModel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CLUSTERING</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>changeInstanceNameToPID</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#ce5c00;font-weight:700>}</span>

                <span style=color:#8f5902;font-style:italic>//获取MQClientInstance
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mQClientFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MQClientManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInstance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getOrCreateMQClientInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rpcHook</span><span style=color:#ce5c00;font-weight:700>);</span>

                <span style=color:#8f5902;font-style:italic>//设置rebalanceImpl配置
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rebalanceImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rebalanceImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setMessageModel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageModel</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rebalanceImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAllocateMessageQueueStrategy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAllocateMessageQueueStrategy</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rebalanceImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setmQClientFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mQClientFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
                                <span style=color:#8f5902;font-style:italic>//创建PullAPIWrapper--pull的api的包装类
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pullAPIWrapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PullAPIWrapper</span><span style=color:#ce5c00;font-weight:700>(</span>
                    <span style=color:#000>mQClientFactory</span><span style=color:#ce5c00;font-weight:700>,</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>isUnitMode</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pullAPIWrapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerFilterMessageHook</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>filterMessageHookList</span><span style=color:#ce5c00;font-weight:700>);</span>

                <span style=color:#8f5902;font-style:italic>//处理offerSet的存储
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOffsetStore</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>offsetStore</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOffsetStore</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>switch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageModel</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>BROADCASTING</span><span style=color:#ce5c00;font-weight:700>:</span>
                            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>offsetStore</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LocalFileOffsetStore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mQClientFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>());</span>
                            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>CLUSTERING</span><span style=color:#ce5c00;font-weight:700>:</span>
                            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>offsetStore</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RemoteBrokerOffsetStore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mQClientFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>());</span>
                            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#204a87;font-weight:700>default</span><span style=color:#ce5c00;font-weight:700>:</span>
                            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setOffsetStore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>offsetStore</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>offsetStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>load</span><span style=color:#ce5c00;font-weight:700>();</span>
                               <span style=color:#8f5902;font-style:italic>//根据不的监听器创建不同的消息消费服务
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageListenerInner</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>MessageListenerOrderly</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumeOrderly</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumeMessageService</span> <span style=color:#ce5c00;font-weight:700>=</span>
                        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConsumeMessageOrderlyService</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageListenerOrderly</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageListenerInner</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageListenerInner</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>MessageListenerConcurrently</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumeOrderly</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumeMessageService</span> <span style=color:#ce5c00;font-weight:700>=</span>
                        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConsumeMessageConcurrentlyService</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageListenerConcurrently</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageListenerInner</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#ce5c00;font-weight:700>}</span>

                <span style=color:#8f5902;font-style:italic>//启动消费服务--定时清理过期的消息
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumeMessageService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>

                <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>registerOK</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mQClientFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerConsumer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>registerOK</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>serviceState</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ServiceState</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CREATE_JUST</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumeMessageService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shutdown</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MQClientException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The consumer group[&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>()</span>
                        <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;] has been created before, specify another name please.&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>FAQUrl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>suggestTodo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>FAQUrl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GROUP_NAME_DUPLICATE_URL</span><span style=color:#ce5c00;font-weight:700>),</span>
                        <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                               <span style=color:#8f5902;font-style:italic>//MQClientInstance启动
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>mQClientFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;the consumer [{}] start OK.&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>serviceState</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ServiceState</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RUNNING</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RUNNING</span><span style=color:#ce5c00;font-weight:700>:</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>START_FAILED</span><span style=color:#ce5c00;font-weight:700>:</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>SHUTDOWN_ALREADY</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MQClientException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The PushConsumer service state not OK, maybe started once, &#34;</span>
                    <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>serviceState</span>
                    <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>FAQUrl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>suggestTodo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>FAQUrl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CLIENT_SERVICE_NOT_OK</span><span style=color:#ce5c00;font-weight:700>),</span>
                    <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>default</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>updateTopicSubscribeInfoWhenSubscriptionChanged</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mQClientFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>checkClientInBroker</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mQClientFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sendHeartbeatToAllBrokerWithLock</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>//正在开始消费数据启动
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mQClientFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rebalanceImmediately</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在启动MQClientInstance的过程中，对消息拉取线程进行了start()。消息拉取线程开始运行，看下代码实现：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>MQClientException</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>switch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>serviceState</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>CREATE_JUST</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>serviceState</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ServiceState</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>START_FAILED</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#8f5902;font-style:italic>// If not specified,looking address from name server
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clientConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNamesrvAddr</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mQClientAPIImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fetchNameServerAddr</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#8f5902;font-style:italic>// 启动客户端通讯
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mQClientAPIImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#8f5902;font-style:italic>// 启动定时任务
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>startScheduledTask</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#8f5902;font-style:italic>// 启动拉取消息
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pullMessageService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#8f5902;font-style:italic>// 启动负载均衡
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rebalanceService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#8f5902;font-style:italic>// Start push service
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQProducer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDefaultMQProducerImpl</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;the client factory [{}] start OK&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clientId</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>serviceState</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ServiceState</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RUNNING</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>START_FAILED</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MQClientException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The Factory object[&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClientId</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;] has been created before, and failed.&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>default</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>启动负载均衡是消费者消费Message的入口，接下来入手分析RebalanceService.start。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>RebalanceService</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ServiceThread</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>waitInterval</span> <span style=color:#ce5c00;font-weight:700>=</span>
        <span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseLong</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProperty</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#4e9a06>&#34;rocketmq.client.rebalance.waitInterval&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;20000&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>InternalLogger</span> <span style=color:#000>log</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ClientLogger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLog</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MQClientInstance</span> <span style=color:#000>mqClientFactory</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>RebalanceService</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MQClientInstance</span> <span style=color:#000>mqClientFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mqClientFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mqClientFactory</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getServiceName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; service started&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isStopped</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>waitForRunning</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>waitInterval</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mqClientFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doRebalance</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getServiceName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; service end&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getServiceName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>RebalanceService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSimpleName</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div><p><strong>RebalanceService</strong> 是一个服务线程，继承了ServiceThread，调用start方法最终是执行 <strong>RebalanceService.run</strong> 方法。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getServiceName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; service started&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isStopped</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>waitForRunning</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>waitInterval</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>//负载处理
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mqClientFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doRebalance</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getServiceName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; service end&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在 <strong>RebalanceService.run</strong> 方法中主要通过 <strong>MQClientInstance.doRebalance</strong> 来实现消费者的负载均衡。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>doRebalance</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MQConsumerInner</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>entry</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumerTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>entrySet</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>MQConsumerInner</span> <span style=color:#000>impl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>entry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>impl</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>impl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doRebalance</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;doRebalance exception&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过从消费列表 <strong>consumerTable中</strong> 中获取保存的 <strong>MQConsumerInner</strong> 调用 <strong>MQConsumerInner.doRebalance</strong> 方法。那么 <strong>consumerTable</strong> 中保存的是什么？什么时候保存的。在 DefaultMQPushConsumerImpl.start方法中有这样一段代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>registerOK</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mQClientFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerConsumer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>这里就是往consumerTable中注入消费者。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>registerConsumer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>group</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MQConsumerInner</span> <span style=color:#000>consumer</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>group</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>consumer</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#000>MQConsumerInner</span> <span style=color:#000>prev</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumerTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putIfAbsent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>group</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>consumer</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prev</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;the consumer group[&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>group</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;] exist already.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>所以consumerTable中保存的是消费组和消费者的关系，consumerTable中的value为DefaultMQPushConsumerImpl的实例，因为该类实现了MQConsumerInner接口。
那么在 <strong>MQClientInstance.doRebalance</strong> 方法中调用的 <strong>MQConsumerInner. doRebalance</strong> 方法实际上调用的是 <strong>DefaultMQPushConsumerImpl.doRebalance</strong> 方法。下面来看一下 <strong>DefaultMQPushConsumerImpl.doRebalance</strong> 方法的实现。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>doRebalance</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pause</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//参数为是否为顺序消费
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rebalanceImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doRebalance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isConsumeOrderly</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>最终的负载均衡是由 <strong>RebalanceImpl</strong> 的实现类 <strong>RebalancePushImpl</strong> 来处理。先看一下 <strong>RebalanceImpl.doRebalance</strong> 这个方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>doRebalance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isOrder</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//获取topic和订阅关系--之前在启动时候有copy
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SubscriptionData</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>subTable</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSubscriptionInner</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>subTable</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SubscriptionData</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>entry</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>subTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>entrySet</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>topic</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>entry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getKey</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>//按topic来进行负载均衡
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rebalanceByTopic</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>isOrder</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>startsWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MixAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RETRY_GROUP_TOPIC_PREFIX</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;rebalanceByTopic Exception&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>truncateMessageQueueNotMyTopic</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通调用 <strong>RebalanceImpl.rebalanceByTopic</strong> 私有方法来处理Topic的消费的负载均衡问题。这个方法了两大类处理</p><ol><li>广播消费</li></ol><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>        <span style=color:#204a87;font-weight:700>switch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>messageModel</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>BROADCASTING</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>mqSet</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>topicSubscribeInfoTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mqSet</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>changed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>updateProcessQueueTableInRebalance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mqSet</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>isOrder</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>changed</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageQueueChanged</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mqSet</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mqSet</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;messageQueueChanged {} {} {} {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                            <span style=color:#000>consumerGroup</span><span style=color:#ce5c00;font-weight:700>,</span>
                            <span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span>
                            <span style=color:#000>mqSet</span><span style=color:#ce5c00;font-weight:700>,</span>
                            <span style=color:#000>mqSet</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;doRebalance, {}, but the topic[{}] not exist.&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>consumerGroup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>广播消费暂时不分析</p><ol start=2><li>集群消费</li></ol><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>CLUSTERING</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>//根据topic获取订阅消息队列
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>mqSet</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>topicSubscribeInfoTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#8f5902;font-style:italic>//获取消费者ID列表
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>cidAll</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mQClientFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findConsumerIdList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>consumerGroup</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>mqSet</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>startsWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MixAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RETRY_GROUP_TOPIC_PREFIX</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;doRebalance, {}, but the topic[{}] not exist.&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>consumerGroup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>

                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>cidAll</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;doRebalance, {} {}, get consumer id list failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>consumerGroup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>

                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mqSet</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>cidAll</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>mqAll</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
                    <span style=color:#000>mqAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mqSet</span><span style=color:#ce5c00;font-weight:700>);</span>

                    <span style=color:#000>Collections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sort</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mqAll</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#000>Collections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sort</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cidAll</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#8f5902;font-style:italic>//分配消息队列的策略
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>AllocateMessageQueueStrategy</span> <span style=color:#000>strategy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allocateMessageQueueStrategy</span><span style=color:#ce5c00;font-weight:700>;</span>

                    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>allocateResult</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>allocateResult</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>strategy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allocate</span><span style=color:#ce5c00;font-weight:700>(</span>
                            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumerGroup</span><span style=color:#ce5c00;font-weight:700>,</span>
                            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mQClientFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClientId</span><span style=color:#ce5c00;font-weight:700>(),</span>
                            <span style=color:#000>mqAll</span><span style=color:#ce5c00;font-weight:700>,</span>
                            <span style=color:#000>cidAll</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;AllocateMessageQueueStrategy.allocate Exception. allocateMessageQueueStrategyName={}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>strategy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>(),</span>
                            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>

                    <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>allocateResultSet</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashSet</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>allocateResult</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>allocateResultSet</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>allocateResult</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#8f5902;font-style:italic>//更新处理队列
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>changed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>updateProcessQueueTableInRebalance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>allocateResultSet</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>isOrder</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>changed</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span>
                            <span style=color:#4e9a06>&#34;rebalanced result changed. allocateMessageQueueStrategyName={}, group={}, topic={}, clientId={}, mqAllSize={}, cidAllSize={}, rebalanceResultSize={}, rebalanceResultSet={}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                            <span style=color:#000>strategy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>consumerGroup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mQClientFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClientId</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>mqSet</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>cidAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>(),</span>
                            <span style=color:#000>allocateResultSet</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>allocateResultSet</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageQueueChanged</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mqSet</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>allocateResultSet</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过 <strong>RebalanceImpl.updateProcessQueueTableInRebalance</strong> 处理消息队列。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>updateProcessQueueTableInRebalance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>mqSet</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isOrder</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            
        <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PullRequest</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>pullRequestList</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PullRequest</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
        <span style=color:#8f5902;font-style:italic>//将MessageQueue变成PullRequest
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageQueue</span> <span style=color:#000>mq</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>mqSet</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>processQueueTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isOrder</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lock</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;doRebalance, {}, add a new mq failed, {}, because lock failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>consumerGroup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>continue</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>

                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>removeDirtyOffset</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>ProcessQueue</span> <span style=color:#000>pq</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ProcessQueue</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>nextOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>computePullFromWhere</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nextOffset</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>ProcessQueue</span> <span style=color:#000>pre</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>processQueueTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putIfAbsent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pq</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pre</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;doRebalance, {}, mq already exists, {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>consumerGroup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;doRebalance, {}, add a new mq, {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>consumerGroup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#000>PullRequest</span> <span style=color:#000>pullRequest</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PullRequest</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>consumerGroup</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setNextOffset</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nextOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setMessageQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setProcessQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pq</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#000>pullRequestList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#000>changed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;doRebalance, {}, add new mq failed, {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>consumerGroup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        
        <span style=color:#8f5902;font-style:italic>//分派PullRequest
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dispatchPullRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pullRequestList</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>changed</span><span style=color:#ce5c00;font-weight:700>;</span>
            
            
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过 <strong>RebalanceImpl.dispatchPullRequest</strong> 来处理。在RebalanceImpl中方法dispatchPullRequest是一个抽象方法。具体实现看RebalanceImpl的实现。下面来看一下RebalancePushImpl.dispatchPullRequest</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>dispatchPullRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PullRequest</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>pullRequestList</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PullRequest</span> <span style=color:#000>pullRequest</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>pullRequestList</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumerImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>executePullRequestImmediately</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;doRebalance, {}, add a new pull request {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>consumerGroup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后通过 <strong>DefaultMQPushConsumerImpl.executePullRequestImmediately</strong> 来处理PullRequest数据：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>executePullRequestImmediately</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PullRequest</span> <span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mQClientFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPullMessageService</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>executePullRequestImmediately</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过获取 <strong>MQClientInstance</strong> 实例中的 <strong>PullMessageService</strong> 消息拉取服务(线程)。下面来看一下 <strong>PullMessageService.executePullRequestImmediately</strong> 方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>executePullRequestImmediately</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PullRequest</span> <span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pullRequestQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;executePullRequestImmediately pullRequestQueue.put&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>将 <strong>PullRequest</strong> 请求放入阻塞队列中。然后通过获取队列中的PullRequest来拉取Broker中的Message。在 <strong>PullMessageService.run</strong> 方法中获取队列中的PullRequest来进行处理：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getServiceName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; service started&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isStopped</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>//获取队列中的数据
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>PullRequest</span> <span style=color:#000>pullRequest</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pullRequestQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>take</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#8f5902;font-style:italic>//处理数据
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pullMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>ignored</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Pull Message Service Run Method exception&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getServiceName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; service end&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote><p>PullMessageService的服务启动在MQClientInstance类的start方法中启动</p></blockquote><p><strong>PullMessageService.pullMessage</strong> 方法中的处理逻辑：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>pullMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PullRequest</span> <span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//获取DefaultMQPushConsumerImpl实例根据消费组
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MQConsumerInner</span> <span style=color:#000>consumer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mQClientFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>selectConsumer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>consumer</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>DefaultMQPushConsumerImpl</span> <span style=color:#000>impl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DefaultMQPushConsumerImpl</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>consumer</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>//拉取消息
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>impl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pullMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;No matched consumer for the PullRequest {}, drop it&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>看一下 <strong>DefaultMQPushConsumerImpl.pullMessage</strong> 是如何处理拉取消息请求的这个方法中的代码有点多，这里分开来进行分析：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ProcessQueue</span> <span style=color:#000>processQueue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProcessQueue</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>processQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDropped</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;the pull request[{}] is dropped.&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProcessQueue</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>setLastPullTimestamp</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>());</span>
</code></pre></div><p>上面代码主要是判断处理队列的 <strong><code>ProcessQueue</code></strong> 一些状态，然后就是判断 <strong><code>DefaultMQPushConsumerImpl</code></strong> 的状态：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//状态是否为ServiceState.RUNNING
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>makeSureStateOK</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MQClientException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;pullMessage exception, consumer state not ok&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>executePullRequestLater</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pullTimeDelayMillsWhenException</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isPause</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;consumer was paused, execute pull request later. instanceName={}, group={}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInstanceName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>executePullRequestLater</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>PULL_TIME_DELAY_MILLS_WHEN_SUSPEND</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后就是一些限流的操作，这里包括一下几个方面：</p><ul><li><p>从消息的条数进行限流（大于1000条）</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cachedMessageCount</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPullThresholdForQueue</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>executePullRequestLater</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>queueFlowControlTimes</span><span style=color:#ce5c00;font-weight:700>++</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#000>1000</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span>
                    <span style=color:#4e9a06>&#34;the cached message count exceeds the threshold {}, so do flow control, minOffset={}, maxOffset={}, count={}, size={} MiB, pullRequest={}, flowControlTimes={}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPullThresholdForQueue</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>processQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgTreeMap</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>firstKey</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>processQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgTreeMap</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>lastKey</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>cachedMessageCount</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cachedMessageSizeInMiB</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>queueFlowControlTimes</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li><li><p>从缓存消息的大小(大于100M)</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cachedMessageSizeInMiB</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPullThresholdSizeForQueue</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>executePullRequestLater</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>queueFlowControlTimes</span><span style=color:#ce5c00;font-weight:700>++</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#000>1000</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span>
                    <span style=color:#4e9a06>&#34;the cached message size exceeds the threshold {} MiB, so do flow control, minOffset={}, maxOffset={}, count={}, size={} MiB, pullRequest={}, flowControlTimes={}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPullThresholdSizeForQueue</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>processQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgTreeMap</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>firstKey</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>processQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgTreeMap</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>lastKey</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>cachedMessageCount</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cachedMessageSizeInMiB</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>queueFlowControlTimes</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div></li><li><p>非顺序消息的跨度(不能大于2000)</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumeOrderly</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>processQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMaxSpan</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumeConcurrentlyMaxSpan</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>//延迟50毫秒消费
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>executePullRequestLater</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>queueMaxSpanFlowControlTimes</span><span style=color:#ce5c00;font-weight:700>++</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#000>1000</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span>
                        <span style=color:#4e9a06>&#34;the queue&#39;s messages, span too long, so do flow control, minOffset={}, maxOffset={}, maxSpan={}, pullRequest={}, flowControlTimes={}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                        <span style=color:#000>processQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgTreeMap</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>firstKey</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>processQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgTreeMap</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>lastKey</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>processQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMaxSpan</span><span style=color:#ce5c00;font-weight:700>(),</span>
                        <span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>queueMaxSpanFlowControlTimes</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>processQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isLocked</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isLockedFirst</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rebalanceImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>computePullFromWhere</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageQueue</span><span style=color:#ce5c00;font-weight:700>());</span>
                    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>brokerBusy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNextOffset</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;the first time to pull message, so fix offset from broker. pullRequest: {} NewOffset: {} brokerBusy: {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                        <span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>brokerBusy</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>brokerBusy</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[NOTIFYME]the first time to pull message, but pull request offset larger than broker consume offset. pullRequest: {} NewOffset: {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                            <span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>

                    <span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setLockedFirst</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setNextOffset</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>executePullRequestLater</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pullTimeDelayMillsWhenException</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;pull message later because not locked in broker, {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li></ul><p>然后获取topic的订阅关系数据SubscriptionData：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SubscriptionData</span> <span style=color:#000>subscriptionData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rebalanceImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSubscriptionInner</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageQueue</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>subscriptionData</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>executePullRequestLater</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pullTimeDelayMillsWhenException</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;find the consumer&#39;s subscription failed, {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>创建一个 <strong><code>PullCallback</code></strong> 对象，用于回调这个回到函数的创建会在调用的地方进行分析。然后根据消费模式是否为集群消费（CLUSTERING）获取消费的偏移量：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>commitOffsetEnable</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>commitOffsetValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0L</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageModel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CLUSTERING</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageModel</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>commitOffsetValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>offsetStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readOffset</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageQueue</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>ReadOffsetType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>READ_FROM_MEMORY</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>commitOffsetValue</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>commitOffsetEnable</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>接下来的代码都是处理和偏移量相关的数据：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>String</span> <span style=color:#000>subExpression</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>classFilter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>SubscriptionData</span> <span style=color:#000>sd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rebalanceImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSubscriptionInner</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageQueue</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sd</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isPostSubscriptionWhenPull</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>sd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isClassFilterMode</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>subExpression</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSubString</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#000>classFilter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isClassFilterMode</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#8f5902;font-style:italic>//同步标记
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>sysFlag</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PullSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>buildSysFlag</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#000>commitOffsetEnable</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#8f5902;font-style:italic>// commitOffset
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#8f5902;font-style:italic>// suspend
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>subExpression</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#8f5902;font-style:italic>// subscription
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>classFilter</span> <span style=color:#8f5902;font-style:italic>// class filter
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>然后通过 <strong><code>PullAPIWrapper.pullKernelImpl</code></strong> 拉去消息进行消费。接着就来分析当前这个：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>PullResult</span> <span style=color:#000>pullKernelImpl</span><span style=color:#ce5c00;font-weight:700>(</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MessageQueue</span> <span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>subExpression</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>expressionType</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>subVersion</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>maxNums</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>sysFlag</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>commitOffset</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>brokerSuspendMaxTimeMillis</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>timeoutMillis</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>CommunicationMode</span> <span style=color:#000>communicationMode</span><span style=color:#ce5c00;font-weight:700>,</span>  <span style=color:#8f5902;font-style:italic>// CommunicationMode.ASYNC
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PullCallback</span> <span style=color:#000>pullCallback</span>
    <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>MQClientException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RemotingException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MQBrokerException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>InterruptedException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>FindBrokerResult</span> <span style=color:#000>findBrokerResult</span> <span style=color:#ce5c00;font-weight:700>=</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mQClientFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findBrokerAddressInSubscribe</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerName</span><span style=color:#ce5c00;font-weight:700>(),</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>recalculatePullFromWhichNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>findBrokerResult</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mQClientFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>updateTopicRouteInfoFromNameServer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#000>findBrokerResult</span> <span style=color:#ce5c00;font-weight:700>=</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mQClientFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findBrokerAddressInSubscribe</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerName</span><span style=color:#ce5c00;font-weight:700>(),</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>recalculatePullFromWhichNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>findBrokerResult</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// check version
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>ExpressionType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTagType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expressionType</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>findBrokerResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerVersion</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>MQVersion</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Version</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>V4_1_0_SNAPSHOT</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ordinal</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MQClientException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The broker[&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;, &#34;</span>
                        <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>findBrokerResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerVersion</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;] does not upgrade to support for filter message by &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>expressionType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>sysFlagInner</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sysFlag</span><span style=color:#ce5c00;font-weight:700>;</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>findBrokerResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSlave</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>sysFlagInner</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PullSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clearCommitOffsetFlag</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sysFlagInner</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
			
            <span style=color:#8f5902;font-style:italic>//组装请求参数
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>PullMessageRequestHeader</span> <span style=color:#000>requestHeader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PullMessageRequestHeader</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumerGroup</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTopic</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setQueueId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueId</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setQueueOffset</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setMaxMsgNums</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>maxNums</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSysFlag</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sysFlagInner</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCommitOffset</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>commitOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSuspendTimeoutMillis</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>brokerSuspendMaxTimeMillis</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSubscription</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>subExpression</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSubVersion</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>subVersion</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setExpressionType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expressionType</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#000>String</span> <span style=color:#000>brokerAddr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>findBrokerResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerAddr</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PullSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasClassFilterFlag</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sysFlagInner</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>brokerAddr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>computPullFromWhichFilterServer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>brokerAddr</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
			
            <span style=color:#8f5902;font-style:italic>//拉取消息
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>PullResult</span> <span style=color:#000>pullResult</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mQClientFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMQClientAPIImpl</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>pullMessage</span><span style=color:#ce5c00;font-weight:700>(</span>
                <span style=color:#000>brokerAddr</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#000>timeoutMillis</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#000>communicationMode</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#000>pullCallback</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>pullResult</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MQClientException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The broker[&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;] not exist&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后调用 <strong><code>MQClientAPIImpl.pullMessage</code></strong> 方法获取数据:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>PullResult</span> <span style=color:#000>pullMessage</span><span style=color:#ce5c00;font-weight:700>(</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>addr</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PullMessageRequestHeader</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>timeoutMillis</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>CommunicationMode</span> <span style=color:#000>communicationMode</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PullCallback</span> <span style=color:#000>pullCallback</span>
    <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>RemotingException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MQBrokerException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>InterruptedException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>RemotingCommand</span> <span style=color:#000>request</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RemotingCommand</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createRequestCommand</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PULL_MESSAGE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>switch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>communicationMode</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>ONEWAY</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>assert</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>ASYNC</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pullMessageAsync</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>addr</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>timeoutMillis</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pullCallback</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>SYNC</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pullMessageSync</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>addr</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>timeoutMillis</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>default</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>assert</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>默认获取消息是异步的方式获取数据。</p><h3 id=4-分配消息队列策略>4. 分配消息队列策略</h3><p>RocketMQ定义了策略接口<code>AllocateMessageQueueStrategy</code>，对于给定的<code>消费者分组</code>,和<code>消息队列列表</code>、<code>消费者列表</code>，<code>当前消费者</code>应当被分配到哪些<code>queue队列</code>，定义如下：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//消息队列分配策略接口
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>AllocateMessageQueueStrategy</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Allocating by consumer id
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param consumerGroup 当前消费组
</span><span style=color:#8f5902;font-style:italic>     * @param currentCID 当前消费ID
</span><span style=color:#8f5902;font-style:italic>     * @param mqAll 当前Topic的所有消息队列
</span><span style=color:#8f5902;font-style:italic>     * @param cidAll consumer群组下所有的consumer id set集合
</span><span style=color:#8f5902;font-style:italic>     * @return 根据策略给当前consumer分配的queue列表
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>allocate</span><span style=color:#ce5c00;font-weight:700>(</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>consumerGroup</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>currentCID</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>mqAll</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>cidAll</span>
    <span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 算法名称
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @return 返回策略名称
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#000>String</span> <span style=color:#000>getName</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div><p>实现继承图：</p><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/AllocateMessageQueueStrategy.png?raw=true" alt></p><table><thead><tr><th style=text-align:left>算法名称</th><th style=text-align:left>含义</th></tr></thead><tbody><tr><td style=text-align:left>AllocateMessageQueueAveragely</td><td style=text-align:left>平均分配算法</td></tr><tr><td style=text-align:left>AllocateMessageQueueAveragelyByCircle</td><td style=text-align:left>基于环形平均分配算法</td></tr><tr><td style=text-align:left>AllocateMachineRoomNearby</td><td style=text-align:left>基于机房临近原则算法</td></tr><tr><td style=text-align:left>AllocateMessageQueueByMachineRoom</td><td style=text-align:left>基于机房分配算法</td></tr><tr><td style=text-align:left>AllocateMessageQueueConsistentHash</td><td style=text-align:left>基于一致性hash算法</td></tr><tr><td style=text-align:left>AllocateMessageQueueByConfig</td><td style=text-align:left>基于配置分配算法</td></tr></tbody></table><h4 id=allocatemessagequeueaveragely-平均分配算法>AllocateMessageQueueAveragely-平均分配算法</h4><p>这里所谓的平均分配算法，并不是指的严格意义上的完全平均，如上面的例子中，10个queue，而消费者只有4个，无法是整除关系，除了整除之外的多出来的queue,将依次根据消费者的顺序均摊。 按照上述例子来看，<code>10/4=2</code>，即表示每个<code>消费者</code>平均均摊2个queue；而<code>10%4=2</code>，即除了均摊之外，多出来2个<code>queue</code>还没有分配，那么，根据消费者的顺序<code>consumer-1</code>、<code>consumer-2</code>、<code>consumer-3</code>、<code>consumer-4</code>,则多出来的2个<code>queue</code>将分别给<code>consumer-1</code>和<code>consumer-2</code>。最终，分摊关系如下： <code>consumer-1</code>:<code>3个</code>;<code>consumer-2</code>:<code>3个</code>;<code>consumer-3</code>:<code>2个</code>;<code>consumer-4</code>:<code>2个</code>,如下图所示：</p><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/%E5%B9%B3%E5%9D%87%E5%88%86%E9%85%8D%E7%AE%97%E6%B3%95.png?raw=true" alt></p><p>看一下代码实现：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>org.apache.rocketmq.client.consumer.rebalance</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.ArrayList</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.List</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.rocketmq.client.consumer.AllocateMessageQueueStrategy</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.rocketmq.client.log.ClientLogger</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.rocketmq.logging.InternalLogger</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.rocketmq.common.message.MessageQueue</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * Average Hashing queue algorithm
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AllocateMessageQueueAveragely</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>AllocateMessageQueueStrategy</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>InternalLogger</span> <span style=color:#000>log</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ClientLogger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLog</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>allocate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>consumerGroup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>currentCID</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>mqAll</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>cidAll</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#8f5902;font-style:italic>//常规数据校验
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentCID</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>currentCID</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;currentCID is empty&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mqAll</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>mqAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;mqAll is null or mqAll empty&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cidAll</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>cidAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;cidAll is null or cidAll empty&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>cidAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentCID</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[BUG] ConsumerGroup: {} The consumerId: {} not in cidAll: {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#000>consumerGroup</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#000>currentCID</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#000>cidAll</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cidAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>indexOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentCID</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>mod</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mqAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#000>cidAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>averageSize</span> <span style=color:#ce5c00;font-weight:700>=</span>
            <span style=color:#000>mqAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>cidAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mod</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>mod</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>mqAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>cidAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span>
                <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>mqAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>cidAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>startIndex</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mod</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>mod</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>averageSize</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>averageSize</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>mod</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>range</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>min</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>averageSize</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mqAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>startIndex</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>range</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mqAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>startIndex</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#000>mqAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()));</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;AVG&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=allocatemessagequeueaveragelybycircle--基于环形平均算法>AllocateMessageQueueAveragelyByCircle -基于环形平均算法</h4><p>环形平均算法，是指根据消费者的顺序，依次在由<code>queue队列</code>组成的环形图中逐个分配。具体流程如下所示:</p><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/%E5%9F%BA%E4%BA%8E%E7%8E%AF%E5%BD%A2%E5%B9%B3%E5%9D%87%E7%AE%97%E6%B3%95.png?raw=true" alt></p><p>代码实现如下：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>org.apache.rocketmq.client.consumer.rebalance</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.ArrayList</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.List</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.rocketmq.client.consumer.AllocateMessageQueueStrategy</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.rocketmq.client.log.ClientLogger</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.rocketmq.logging.InternalLogger</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.rocketmq.common.message.MessageQueue</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * Cycle average Hashing queue algorithm
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AllocateMessageQueueAveragelyByCircle</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>AllocateMessageQueueStrategy</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>InternalLogger</span> <span style=color:#000>log</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ClientLogger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLog</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>allocate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>consumerGroup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>currentCID</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>mqAll</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>cidAll</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentCID</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>currentCID</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;currentCID is empty&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mqAll</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>mqAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;mqAll is null or mqAll empty&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cidAll</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>cidAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;cidAll is null or cidAll empty&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>cidAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentCID</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[BUG] ConsumerGroup: {} The consumerId: {} not in cidAll: {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#000>consumerGroup</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#000>currentCID</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#000>cidAll</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
		
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cidAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>indexOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentCID</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>mqAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#000>cidAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mqAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;AVG_BY_CIRCLE&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div><h4 id=allocatemessagequeueconsistenthash-基于一致性hash算法>AllocateMessageQueueConsistentHash-基于一致性hash算法</h4><blockquote><p><strong>什么是一致性hash 算法</strong> ? 一致性hash算法用于在分布式系统中，保证数据的一致性而提出的一种基于hash环实现的算法，限于文章篇幅，不在这里展开描述，有兴趣的同学可以参考下 别人的博文：<a href=https://www.cnblogs.com/lpfuture/p/5796398.html>一致性哈希算法原理</a></p></blockquote><p>看一下代码实现：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic> * Licensed to the Apache Software Foundation (ASF) under one or more
</span><span style=color:#8f5902;font-style:italic> * contributor license agreements.  See the NOTICE file distributed with
</span><span style=color:#8f5902;font-style:italic> * this work for additional information regarding copyright ownership.
</span><span style=color:#8f5902;font-style:italic> * The ASF licenses this file to You under the Apache License, Version 2.0
</span><span style=color:#8f5902;font-style:italic> * (the &#34;License&#34;); you may not use this file except in compliance with
</span><span style=color:#8f5902;font-style:italic> * the License.  You may obtain a copy of the License at
</span><span style=color:#8f5902;font-style:italic> *
</span><span style=color:#8f5902;font-style:italic> *     http://www.apache.org/licenses/LICENSE-2.0
</span><span style=color:#8f5902;font-style:italic> *
</span><span style=color:#8f5902;font-style:italic> * Unless required by applicable law or agreed to in writing, software
</span><span style=color:#8f5902;font-style:italic> * distributed under the License is distributed on an &#34;AS IS&#34; BASIS,
</span><span style=color:#8f5902;font-style:italic> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
</span><span style=color:#8f5902;font-style:italic> * See the License for the specific language governing permissions and
</span><span style=color:#8f5902;font-style:italic> * limitations under the License.
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>org.apache.rocketmq.client.consumer.rebalance</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.ArrayList</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.Collection</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.List</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.rocketmq.client.consumer.AllocateMessageQueueStrategy</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.rocketmq.client.log.ClientLogger</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.rocketmq.common.consistenthash.ConsistentHashRouter</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.rocketmq.common.consistenthash.HashFunction</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.rocketmq.common.consistenthash.Node</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.rocketmq.logging.InternalLogger</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.rocketmq.common.message.MessageQueue</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * Consistent Hashing queue algorithm
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AllocateMessageQueueConsistentHash</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>AllocateMessageQueueStrategy</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>InternalLogger</span> <span style=color:#000>log</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ClientLogger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLog</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>virtualNodeCnt</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>HashFunction</span> <span style=color:#000>customHashFunction</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>AllocateMessageQueueConsistentHash</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>AllocateMessageQueueConsistentHash</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>virtualNodeCnt</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>virtualNodeCnt</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>AllocateMessageQueueConsistentHash</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>virtualNodeCnt</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>HashFunction</span> <span style=color:#000>customHashFunction</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>virtualNodeCnt</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;illegal virtualNodeCnt :&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>virtualNodeCnt</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>virtualNodeCnt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>virtualNodeCnt</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>customHashFunction</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>customHashFunction</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>allocate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>consumerGroup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>currentCID</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>mqAll</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>cidAll</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentCID</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>currentCID</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;currentCID is empty&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mqAll</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>mqAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;mqAll is null or mqAll empty&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cidAll</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>cidAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;cidAll is null or cidAll empty&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>cidAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentCID</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[BUG] ConsumerGroup: {} The consumerId: {} not in cidAll: {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#000>consumerGroup</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#000>currentCID</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#000>cidAll</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ClientNode</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>cidNodes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ClientNode</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>cid</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>cidAll</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>cidNodes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClientNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cid</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ConsistentHashRouter</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ClientNode</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>router</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//for building hash ring
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>customHashFunction</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>router</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConsistentHashRouter</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ClientNode</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>cidNodes</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>virtualNodeCnt</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>customHashFunction</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>router</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConsistentHashRouter</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ClientNode</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>cidNodes</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>virtualNodeCnt</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>results</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageQueue</span> <span style=color:#000>mq</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>mqAll</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>ClientNode</span> <span style=color:#000>clientNode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>router</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>routeNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clientNode</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>currentCID</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clientNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getKey</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>results</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>results</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;CONSISTENT_HASH&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ClientNode</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Node</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>clientID</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ClientNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>clientID</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clientID</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>clientID</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getKey</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>clientID</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div><p>其他的就不分析了用的少。默认为 <strong><code>AllocateMessageQueueAveragely</code></strong></p></div><div class=td-content style=page-break-before:always><h1 id=pg-9695cfa4768abc79a5b8502ccf44718d>9.6 - RocketMQ源码解析-RocketMQ消息ACK机制及消费进度管理</h1><blockquote><p>以下源码基于Rocket MQ 4.7.0</p></blockquote><h3 id=1-消息的ack机制>1. 消息的ACK机制</h3><p>consumer的每个实例是靠AllocateMessageQueueStrategy队列分配来决定如何消费消息的。那么消费进度具体是如何管理的，又是如何保证消息成功消费的?（RocketMQ有保证消息肯定消费成功的特性,失败则重试）？由于以上工作所有的机制都实现在PushConsumer中，所以本文的原理均只适用于RocketMQ中的PushConsumer即Java客户端中的DefaultPushConsumer。 若使用了PullConsumer模式，类似的工作如何ack，如何保证消费等均需要使用方自己实现。</p><h3 id=2-消费进度管理>2. 消费进度管理</h3><p>在创建消费者添加了一个消费回调监听器：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//并发消费监听器
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>consumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerMessageListener</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MessageListenerConcurrently</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ConsumeConcurrentlyStatus</span> <span style=color:#000>consumeMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageExt</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>msgs</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>ConsumeConcurrentlyContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//用户自定义业务处理
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>ConsumeConcurrentlyStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONSUME_SUCCESS</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>});</span>
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//顺序消费监听器
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>consumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerMessageListener</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MessageListenerOrderly</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#000>AtomicLong</span> <span style=color:#000>consumeTimes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AtomicLong</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ConsumeOrderlyStatus</span> <span style=color:#000>consumeMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageExt</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>msgs</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>ConsumeOrderlyContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        
		<span style=color:#8f5902;font-style:italic>//用户业务处理
</span><span style=color:#8f5902;font-style:italic></span>  
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>ConsumeOrderlyStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SUCCESS</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>});</span>
</code></pre></div><p>在执行完成监听器的业务逻辑后根据返回的状态客户端做后续的处理，这里分为两种：</p><ol><li>ConsumeOrderlyStatus(SUCCESS,SUSPEND_CURRENT_QUEUE_A_MOMENT 其他的被Deprecated标记)</li><li>ConsumeConcurrentlyStatus(CONSUME_SUCCESS,RECONSUME_LATER)</li></ol><h4 id=并发消费进度管理>并发消费进度管理</h4><p>并发消费主要通过ConsumeMessageConcurrentlyService来处理。ConsumeMessageConcurrentlyService#processConsumeResult处理消费的。第一部分根据消费状态统计消费成功和消费失败的TPS信息：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>switch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>status</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>CONSUME_SUCCESS</span><span style=color:#ce5c00;font-weight:700>:</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ackIndex</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgs</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>ackIndex</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgs</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ok</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ackIndex</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>failed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgs</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>ok</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerStatsManager</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>incConsumeOKTPS</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>consumerGroup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageQueue</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>ok</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerStatsManager</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>incConsumeFailedTPS</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>consumerGroup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageQueue</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>failed</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RECONSUME_LATER</span><span style=color:#ce5c00;font-weight:700>:</span>
        <span style=color:#000>ackIndex</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerStatsManager</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>incConsumeFailedTPS</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>consumerGroup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageQueue</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span>
            <span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgs</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>default</span><span style=color:#ce5c00;font-weight:700>:</span>
        <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>接着根据不同的消费模式来处理消费掉的信息和为消费的信息，对于未消费的信息重新提交延迟消费。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>switch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageModel</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>BROADCASTING</span><span style=color:#ce5c00;font-weight:700>:</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ackIndex</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgs</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>MessageExt</span> <span style=color:#000>msg</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgs</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;BROADCASTING, the message consume failed, drop it, {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>CLUSTERING</span><span style=color:#ce5c00;font-weight:700>:</span>
        <span style=color:#8f5902;font-style:italic>//延迟消费处理
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageExt</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>msgBackFailed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageExt</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgs</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ackIndex</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgs</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>MessageExt</span> <span style=color:#000>msg</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgs</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sendMessageBack</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setReconsumeTimes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getReconsumeTimes</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>msgBackFailed</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>msgBackFailed</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgs</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>removeAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgBackFailed</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#8f5902;font-style:italic>//消费失败的重新延迟消费
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>submitConsumeRequestLater</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgBackFailed</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProcessQueue</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageQueue</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>default</span><span style=color:#ce5c00;font-weight:700>:</span>
        <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>处理完成失败的消息后接着处理更新消费进度：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//每次获取第一个TreeMap中的offset(这里出来的就是当前队列的消费指针所在)
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProcessQueue</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>removeMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgs</span><span style=color:#ce5c00;font-weight:700>());</span>
<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProcessQueue</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isDropped</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#8f5902;font-style:italic>//更新消费进度
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumerImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOffsetStore</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>updateOffset</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageQueue</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面的代码</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProcessQueue</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>removeMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgs</span><span style=color:#ce5c00;font-weight:700>());</span>
</code></pre></div><p>这段代码获取的是 <strong><code>msgTreeMap</code></strong> 中的第一个。这里就会存在这一的一个问题如图所示：</p><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/RocketMQ%E6%B6%88%E8%B4%B9%E5%9B%BE.png?raw=true" alt></p><p>如果是最上面的队列全部消费了那么序列化的就是7后面的消息。而对于第二个那么如果此时消费者停止宕机。那么序列化的就是2后面的而不是7这样重新启动消费。那么就会重新消费7</p><p>下面来看一下如何更新消费进度的。从代码可以看出来是通过调用接口 <strong>OffsetStore#updateOffset</strong> 方法来处理，对于集群消费模式OffsetStore的实现类为RemoteBrokerOffsetStore(另一个实现LocalFileOffsetStore)。创建代码在 DefaultMQPushConsumerImpl#start方法中。那么看一下：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>updateOffset</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageQueue</span> <span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>increaseOnly</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mq</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>AtomicLong</span> <span style=color:#000>offsetOld</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>offsetTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>offsetOld</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>offsetOld</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>offsetTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putIfAbsent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AtomicLong</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>offsetOld</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>increaseOnly</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>MixAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndIncreaseOnly</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offsetOld</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>offsetOld</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这里就是把数据更新到一个offsetTable中，这个table包含了消息队列和消费进度的对应关系。
这里的消费数据保存在客户端消费集群的内存中，这样就会带来一些问题：</p><ul><li>消费者宕机了怎么处理消费进度</li><li>正常情况下如何处理消费进度</li></ul><p>上面两个问题的本质归结到一个那就是如何把这些数据持久化，在哪里持久化的问题。如何持久化这个就是说到持久化策略和持久化的时机。持久化的位置这就确定了这些数据加载的位置。接下分析这两个问题。
OffsetStore 接口主要负责持久化，这里分析的集群消费。RemoteBrokerOffsetStore的实现中看一下 persistAll 这个方法(持久化所有的)</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//RemoteBrokerOffsetStore#persistAll 方法
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>persistAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>mqs</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>mqs</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>mqs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span>
        <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>HashSet</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>unusedMQ</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashSet</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>

    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>AtomicLong</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>entry</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>offsetTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>entrySet</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>MessageQueue</span> <span style=color:#000>mq</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>entry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getKey</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>AtomicLong</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>entry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mqs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#8f5902;font-style:italic>//更新消费进度到Broker
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>updateConsumeOffsetToBroker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;updateConsumeOffsetToBroker exception, &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>unusedMQ</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>unusedMQ</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageQueue</span> <span style=color:#000>mq</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>unusedMQ</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>offsetTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;remove unused mq, {}, {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>groupName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>调用这个方法主要在两个地方：</p><ul><li>DefaultMQPushConsumerImpl#shutdown ()</li></ul><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>shutdown</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>switch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>serviceState</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>CREATE_JUST</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RUNNING</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumeMessageService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shutdown</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>persistConsumerOffset</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mQClientFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unregisterConsumer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mQClientFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shutdown</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;the consumer [{}] shutdown OK&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rebalanceImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>destroy</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>serviceState</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ServiceState</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SHUTDOWN_ALREADY</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>SHUTDOWN_ALREADY</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>default</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul><li>MQClientInstance中的定时任务(会在创客户端的时候启动)</li></ul><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//默认是每五秒触发一次
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scheduledExecutorService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scheduleAtFixedRate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>MQClientInstance</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>persistAllConsumerOffset</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;ScheduledTask persistAllConsumerOffset exception&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>1000</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clientConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPersistConsumerOffsetInterval</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MILLISECONDS</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>通过代码分析可以发现： <strong>在消费者shutdown的时候会去持久化，然后就在运行过程中每5秒定时去持久化一次消费进度。消费的进度保存在Broker。</strong></p></div><div class=td-content style=page-break-before:always><h1 id=pg-99120f536b9e43c2a63509eb70d86756>9.7 - RocketMQ源码解析-RocketMQ顺序消息的投递与消费</h1><blockquote><p>以下源码基于Rocket MQ 4.7.0</p></blockquote><h3 id=生产顺序消息>生产顺序消息</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>OrderedProducer</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//Instantiate with a producer group name.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>MQProducer</span> <span style=color:#000>producer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DefaultMQProducer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;example_group_name&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>//Launch the instance.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>producer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>tags</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;TagA&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;TagB&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;TagC&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;TagD&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;TagE&#34;</span><span style=color:#ce5c00;font-weight:700>};</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>100</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>orderId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>//Create a message instance, specifying topic, tag and message body.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>Message</span> <span style=color:#000>msg</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Message</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;TopicTestjjj&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>tags</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#000>tags</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#4e9a06>&#34;KEY&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>,</span>
                    <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Hello RocketMQ &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getBytes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RemotingHelper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DEFAULT_CHARSET</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#000>SendResult</span> <span style=color:#000>sendResult</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>producer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>send</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MessageQueueSelector</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MessageQueue</span> <span style=color:#000>select</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>mqs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Message</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>arg</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>Integer</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>arg</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#000>mqs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>mqs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>orderId</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;%s%n&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sendResult</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//server shutdown
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>producer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shutdown</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>官网的顺序消息的投递例子，之前也在消息投递策略中分析过， <a href=https://blog.ljbmxsm.com/pages/544b0df5/>RocketMQ源码解析-生产者投递消息策略</a>。主要是通过 <strong><code>MessageQueueSelector</code></strong> 选择器来选择投递的消息队列。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>MessageQueueSelector</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>MessageQueue</span> <span style=color:#000>select</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>mqs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Message</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>arg</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>接口中的 <strong><code>arg</code></strong> 的数据是 <strong><code>MQProducer#send</code></strong> 中Object传入的。比如上面的例子中的send传入orderId那么，select中就是orderId。<br>通过MessageQueueSelector选择对应的消息队列，比如订单ID相同的这样就分配到了同一条消息队列中，在同一条消息队列中是有序的，这样消息就实现了有序。接下来如何消费。</p><h3 id=消费顺序消息>消费顺序消息</h3><p>首先看一下官网的顺序消费的例子：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>OrderedConsumer</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>DefaultMQPushConsumer</span> <span style=color:#000>consumer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DefaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;example_group_name&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#000>consumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setConsumeFromWhere</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConsumeFromWhere</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONSUME_FROM_FIRST_OFFSET</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#000>consumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>subscribe</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;TopicTest&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;TagA || TagC || TagD&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#000>consumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerMessageListener</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MessageListenerOrderly</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>

            <span style=color:#000>AtomicLong</span> <span style=color:#000>consumeTimes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AtomicLong</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ConsumeOrderlyStatus</span> <span style=color:#000>consumeMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageExt</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>msgs</span><span style=color:#ce5c00;font-weight:700>,</span>
                                                       <span style=color:#000>ConsumeOrderlyContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAutoCommit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; Receive New Messages: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>msgs</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;%n&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumeTimes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>incrementAndGet</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumeTimes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>ConsumeOrderlyStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SUCCESS</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumeTimes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>ConsumeOrderlyStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ROLLBACK</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumeTimes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>ConsumeOrderlyStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>COMMIT</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumeTimes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSuspendCurrentQueueTimeMillis</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>3000</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>ConsumeOrderlyStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SUSPEND_CURRENT_QUEUE_A_MOMENT</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>ConsumeOrderlyStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SUCCESS</span><span style=color:#ce5c00;font-weight:700>;</span>

            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>});</span>

        <span style=color:#000>consumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Consumer Started.%n&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div><p>这里一个关键的接口就是 <strong><code>MessageListenerOrderly</code></strong> (并发消费为MessageListenerConcurrently) 来处理顺序消费的消息。接下来从源码来分析如何选择线程来处理顺序消非。<br>在创建 <strong><code>DefaultMQPushConsumer</code></strong> 根据不同的不同的监听器 <strong><code>MessageListenerOrderly</code></strong> 和 <strong><code>MessageListenerConcurrently</code></strong> 来创建不同的消费服务：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//DefaultMQPushConsumerImpl#start 方法
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageListenerInner</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>MessageListenerOrderly</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumeOrderly</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumeMessageService</span> <span style=color:#ce5c00;font-weight:700>=</span>
        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConsumeMessageOrderlyService</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageListenerOrderly</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageListenerInner</span><span style=color:#ce5c00;font-weight:700>());</span>
<span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageListenerInner</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>MessageListenerConcurrently</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumeOrderly</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumeMessageService</span> <span style=color:#ce5c00;font-weight:700>=</span>
        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConsumeMessageConcurrentlyService</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageListenerConcurrently</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageListenerInner</span><span style=color:#ce5c00;font-weight:700>());</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>对于消息的拉取和并发消费没有什么区别，区别在于消费处理的类不一样；</p><ul><li>并发处理类&mdash;ConsumeMessageConcurrentlyService</li><li>顺序处理类&mdash;ConsumeMessageOrderlyService</li></ul><p>那么看一下是如何处理 <strong><code>ConsumeMessageOrderlyService#submitConsumeRequest</code></strong> (所有的消息都是包装成了ConsumeRequest然后提交给线程池这里和并发处理没有区别)</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//ConsumeMessageOrderlyService#submitConsumeRequest
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>submitConsumeRequest</span><span style=color:#ce5c00;font-weight:700>(</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageExt</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>msgs</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ProcessQueue</span> <span style=color:#000>processQueue</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MessageQueue</span> <span style=color:#000>messageQueue</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>dispathToConsume</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dispathToConsume</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>ConsumeRequest</span> <span style=color:#000>consumeRequest</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConsumeRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>processQueue</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>messageQueue</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumeExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>submit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>consumeRequest</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>那么看一下 <strong><code>ConsumeMessageOrderlyService</code></strong> 内部类 <strong><code>ConsumeRequest</code></strong> 。看一下在这个内部类是如何处理数据的。<br>这里有一个消息队列锁的东西,作用： <strong>严格的确保在同一消费时间内有且仅有一个线程消费该消息队列</strong> 。 下面看一下队列锁的实现：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MessageQueueLock</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ConcurrentMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>mqLockTable</span> <span style=color:#ce5c00;font-weight:700>=</span>
        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConcurrentHashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>fetchLockObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MessageQueue</span> <span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Object</span> <span style=color:#000>objLock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mqLockTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>objLock</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>objLock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>Object</span> <span style=color:#000>prevLock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mqLockTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putIfAbsent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>objLock</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prevLock</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>objLock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>prevLock</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>objLock</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div><p>分析完成消息队列锁接着分析消费队列的处理，既然提交给了线程来处理说明 ConsumeRequest继承了Runnable接口，直接就分析run方法就可以了。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>processQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDropped</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;run, the message queue not be able to consume, because it&#39;s dropped. {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageQueue</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
 <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>objLock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>messageQueueLock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fetchLockObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageQueue</span><span style=color:#ce5c00;font-weight:700>);</span>
 <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>objLock</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
     <span style=color:#8f5902;font-style:italic>//省略代码
</span><span style=color:#8f5902;font-style:italic></span> <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>首先判断当前ProcessQueue的状态，然后从消息队列锁中获取当前的消费队列对应的对象锁，然后用synchronized进行同步。<br>接下来就是执行同步代码块的代码，这里的代码只能由获取当前对象锁的线程(Thread)执行：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageModel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>BROADCASTING</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConsumeMessageOrderlyService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumerImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageModel</span><span style=color:#ce5c00;font-weight:700>())</span>
                    <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>processQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isLocked</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>processQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isLockExpired</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
 <span style=color:#8f5902;font-style:italic>//省略代码                       
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span><span style=color:#204a87;font-weight:700>else</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>processQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDropped</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;the message queue not be able to consume, because it&#39;s dropped. {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageQueue</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>ConsumeMessageOrderlyService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>tryLockLaterAndReconsume</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageQueue</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>processQueue</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>100</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>真正处理的时候这里有两块逻辑：</p><ol><li>广播消费或者ProcessQueue状态正常，这种状态下就是正常消费</li><li>延迟消费</li></ol><p>分析正常状态下的是如何消费的。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//判断消费前的processQueue状态
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>processQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDropped</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;the message queue not be able to consume, because it&#39;s dropped. {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageQueue</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageModel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CLUSTERING</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConsumeMessageOrderlyService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumerImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageModel</span><span style=color:#ce5c00;font-weight:700>())</span>
    <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>processQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isLocked</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;the message queue not locked, so consume later, {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageQueue</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>ConsumeMessageOrderlyService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>tryLockLaterAndReconsume</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageQueue</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>processQueue</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageModel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CLUSTERING</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConsumeMessageOrderlyService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumerImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageModel</span><span style=color:#ce5c00;font-weight:700>())</span>
    <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>processQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isLockExpired</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;the message queue lock expired, so consume later, {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageQueue</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>ConsumeMessageOrderlyService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>tryLockLaterAndReconsume</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageQueue</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>processQueue</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>interval</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>beginTime</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>interval</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>MAX_TIME_CONSUME_CONTINUOUSLY</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>ConsumeMessageOrderlyService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>submitConsumeRequestLater</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>processQueue</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>messageQueue</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在集群消费和ProcessQueue状态不正确的情况下会进行尝试延迟重新消费的操作(ProcessQueue没有锁定和过期的情况)。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//获取消息
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>consumeBatchSize</span> <span style=color:#ce5c00;font-weight:700>=</span>
    <span style=color:#000>ConsumeMessageOrderlyService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumeMessageBatchMaxSize</span><span style=color:#ce5c00;font-weight:700>();</span>

<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageExt</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>msgs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>processQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>takeMessags</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>consumeBatchSize</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>defaultMQPushConsumerImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resetRetryAndNamespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>());</span>
</code></pre></div><p>获取ProcessQueue队列中的消息数量，最大值为consumeBatchSize(默认值1)。然后判断消息是否为空。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>beginTimestamp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#000>ConsumeReturnType</span> <span style=color:#000>returnType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ConsumeReturnType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SUCCESS</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>hasException</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//消费队列加锁
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>processQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLockConsume</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>lock</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>processQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDropped</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;consumeMessage, the message queue not be able to consume, because it&#39;s dropped. {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageQueue</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#8f5902;font-style:italic>//消费处理--这里也是创建的时候的MessageListenerOrderly实现类
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>messageListener</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumeMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unmodifiableList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgs</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;consumeMessage exception: {} Group: {} Msgs: {} MQ: {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>RemotingHelper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>exceptionSimpleDesc</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>),</span>
        <span style=color:#000>ConsumeMessageOrderlyService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumerGroup</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>msgs</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>messageQueue</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>hasException</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#8f5902;font-style:italic>//取消锁
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>processQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLockConsume</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>unlock</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面代码主要是处理消息。然后返回处理后的状态 <strong><code>ConsumeOrderlyStatus</code></strong> 。然后就对于返回的状态进行处理：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//返回ConsumeOrderlyStatus处理
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>consumeRT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>beginTimestamp</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>status</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasException</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>returnType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ConsumeReturnType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>EXCEPTION</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>returnType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ConsumeReturnType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RETURNNULL</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>consumeRT</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>defaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumeTimeout</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>60</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>1000</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>returnType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ConsumeReturnType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TIME_OUT</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConsumeOrderlyStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SUSPEND_CURRENT_QUEUE_A_MOMENT</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>status</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>returnType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ConsumeReturnType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>FAILED</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConsumeOrderlyStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SUCCESS</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>status</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>returnType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ConsumeReturnType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SUCCESS</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConsumeMessageOrderlyService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumerImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasHook</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>consumeMessageContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProps</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MixAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONSUME_CONTEXT_TYPE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>returnType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>name</span><span style=color:#ce5c00;font-weight:700>());</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>status</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ConsumeOrderlyStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SUSPEND_CURRENT_QUEUE_A_MOMENT</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConsumeMessageOrderlyService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumerImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasHook</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>consumeMessageContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setStatus</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>status</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>consumeMessageContext</span>
        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSuccess</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConsumeOrderlyStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SUCCESS</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>ConsumeOrderlyStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>COMMIT</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>status</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>ConsumeMessageOrderlyService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMQPushConsumerImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>executeHookAfter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>consumeMessageContext</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#000>ConsumeMessageOrderlyService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerStatsManager</span><span style=color:#ce5c00;font-weight:700>()</span>
    <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>incConsumeRT</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConsumeMessageOrderlyService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumerGroup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>messageQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>consumeRT</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#8f5902;font-style:italic>//结果处理
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>continueConsume</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ConsumeMessageOrderlyService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>processConsumeResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>status</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>最后根据 <strong>ConsumeOrderlyStatus</strong> 调用 <strong>ConsumeMessageOrderlyService#processConsumeResult</strong> 方法来处理。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-546f6c63b6ed87db92eddc2dc9e6ed92>9.8 - RocketMQ源码解析-消费者重复消费</h1><h3 id=重复消费>重复消费</h3><p>对于MQ不可避免的要牵涉到消息的重复消费，消息重复消费情况千奇百怪。下面就分析一下一些常见的场景。平时的使用过程中要注意的情况。以及如何避免一些重复消费。</p><h3 id=重复消费的场景分析>重复消费的场景分析</h3><h4 id=业务处理时候失败>业务处理时候失败</h4><p>首先借用官网的代码看一下：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Consumer</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MQClientException</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#8f5902;font-style:italic>// Instantiate with specified consumer group name.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>DefaultMQPushConsumer</span> <span style=color:#000>consumer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DefaultMQPushConsumer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;please_rename_unique_group_name&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
         
        <span style=color:#8f5902;font-style:italic>// Specify name server addresses.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>consumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setNamesrvAddr</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;localhost:9876&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        
        <span style=color:#8f5902;font-style:italic>// Subscribe one more more topics to consume.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>consumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>subscribe</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;TopicTest&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;*&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// Register callback to execute on arrival of messages fetched from brokers.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>consumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerMessageListener</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MessageListenerConcurrently</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>

            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ConsumeConcurrentlyStatus</span> <span style=color:#000>consumeMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageExt</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>msgs</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#000>ConsumeConcurrentlyContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#8f5902;font-style:italic>//进行业务处理完成-- 操作已经入库
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>ConsumeConcurrentlyStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONSUME_SUCCESS</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>});</span>

        <span style=color:#8f5902;font-style:italic>//Launch the consumer instance.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>consumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Consumer Started.%n&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul><li>如面代码所示，已经处理了业务逻辑但是没有自行 <strong><code>return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</code></strong> 代码。如果这个时候程序运行失败或者宕机。那么就会存在重复消费。</li><li>上面代码每次默认取1条消息进行消费，但是为了消费加快，我们可以通过 <strong><code>consumer.setConsumeMessageBatchMaxSize();</code></strong> 设置大小，如果设置10或者更大，在消费完成没有完全完成抛错。那么就会存现重复消费的情况。</li></ul><h4 id=直接结束消费者进程>直接结束消费者进程</h4><p>直接结束消费者进程在Linux中非kill -9的方式结束。在这种情况下就不会调用Hook来持久化。然后在每次消费过程中不是事实去更新消费进度，<strong><code>MQClientInstance</code></strong> 类中</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scheduledExecutorService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scheduleAtFixedRate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>

            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>MQClientInstance</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>persistAllConsumerOffset</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;ScheduledTask persistAllConsumerOffset exception&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>1000</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clientConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPersistConsumerOffsetInterval</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MILLISECONDS</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>这里是定期5秒自行一次。所以在五秒内出了问题又没办法自行Hook的情况下就会重新消费。</p><p>在并发消费过程中会有这样的一个问题，队列中前面的消息后消费，后面的消息已经消费完成了。这里就会存在这一的一个问题如图所示：</p><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/RocketMQ%E6%B6%88%E8%B4%B9%E5%9B%BE.png?raw=true" alt></p><p>如果是最上面的队列全部消费了那么序列化的就是7后面的消息。而对于第二个那么如果此时消费者停止宕机。那么序列化的就是2后面的而不是7这样重新启动消费。那么就会重新消费7。</p><p>这种情况下如果也是直接结束进程，那么也会出现重启后的消息重复消费的情况。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-c514a84bd6a6d3132366c2937864c38f>10 - RocketMQ 问题记录</h1></div><div class=td-content><h1 id=pg-b44c3354ecc8d651cf18c99a1b1ab0d2>10.1 - broker busy问题</h1><p>一起养成写作习惯！这是我参与「掘金日新计划 · 4 月更文挑战」的第20天，<a href=https://juejin.cn/post/7080800226365145118>点击查看活动详情</a>。</p><blockquote><p>Rocket MQ版本 4.8.0</p></blockquote><h3 id=1-问题描述>1. 问题描述</h3><p>在生产者不停的往Broker发送消息报broker busy，这个是在研究RocketMQ源码本地启动服务进行测试的时候出现的。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>org.apache.rocketmq.client.exception.MQBrokerException: CODE: <span style=color:#0000cf;font-weight:700>2</span>  DESC: <span style=color:#ce5c00;font-weight:700>[</span>TIMEOUT_CLEAN_QUEUE<span style=color:#ce5c00;font-weight:700>]</span>broker busy, start flow control <span style=color:#204a87;font-weight:700>for</span> a <span style=color:#204a87;font-weight:700>while</span>, period in queue: 240ms, size of queue: <span style=color:#0000cf;font-weight:700>9</span>
For more information, please visit the url, http://rocketmq.apache.org/docs/faq/
	at org.apache.rocketmq.client.impl.MQClientAPIImpl.processSendResponse<span style=color:#ce5c00;font-weight:700>(</span>MQClientAPIImpl.java:711<span style=color:#ce5c00;font-weight:700>)</span>
	at org.apache.rocketmq.client.impl.MQClientAPIImpl.sendMessageSync<span style=color:#ce5c00;font-weight:700>(</span>MQClientAPIImpl.java:505<span style=color:#ce5c00;font-weight:700>)</span>
	at org.apache.rocketmq.client.impl.MQClientAPIImpl.sendMessage<span style=color:#ce5c00;font-weight:700>(</span>MQClientAPIImpl.java:487<span style=color:#ce5c00;font-weight:700>)</span>
	at org.apache.rocketmq.client.impl.MQClientAPIImpl.sendMessage<span style=color:#ce5c00;font-weight:700>(</span>MQClientAPIImpl.java:431<span style=color:#ce5c00;font-weight:700>)</span>
	at org.apache.rocketmq.client.impl.producer.DefaultMQProducerImpl.sendKernelImpl<span style=color:#ce5c00;font-weight:700>(</span>DefaultMQProducerImpl.java:853<span style=color:#ce5c00;font-weight:700>)</span>
	at org.apache.rocketmq.client.impl.producer.DefaultMQProducerImpl.sendDefaultImpl<span style=color:#ce5c00;font-weight:700>(</span>DefaultMQProducerImpl.java:583<span style=color:#ce5c00;font-weight:700>)</span>
	at org.apache.rocketmq.client.impl.producer.DefaultMQProducerImpl.send<span style=color:#ce5c00;font-weight:700>(</span>DefaultMQProducerImpl.java:1342<span style=color:#ce5c00;font-weight:700>)</span>
	at org.apache.rocketmq.client.impl.producer.DefaultMQProducerImpl.send<span style=color:#ce5c00;font-weight:700>(</span>DefaultMQProducerImpl.java:1288<span style=color:#ce5c00;font-weight:700>)</span>
	at org.apache.rocketmq.client.producer.DefaultMQProducer.send<span style=color:#ce5c00;font-weight:700>(</span>DefaultMQProducer.java:324<span style=color:#ce5c00;font-weight:700>)</span>
	at com.github.mxsm.MQProducer.lambda<span style=color:#000>$main$0</span><span style=color:#ce5c00;font-weight:700>(</span>MQProducer.java:50<span style=color:#ce5c00;font-weight:700>)</span>
	at java.util.concurrent.Executors<span style=color:#000>$RunnableAdapter</span>.call<span style=color:#ce5c00;font-weight:700>(</span>Executors.java:511<span style=color:#ce5c00;font-weight:700>)</span>
	at java.util.concurrent.FutureTask.run<span style=color:#000>$$$capture</span><span style=color:#ce5c00;font-weight:700>(</span>FutureTask.java:266<span style=color:#ce5c00;font-weight:700>)</span>
	at java.util.concurrent.FutureTask.run<span style=color:#ce5c00;font-weight:700>(</span>FutureTask.java<span style=color:#ce5c00;font-weight:700>)</span>
	at java.util.concurrent.ThreadPoolExecutor.runWorker<span style=color:#ce5c00;font-weight:700>(</span>ThreadPoolExecutor.java:1149<span style=color:#ce5c00;font-weight:700>)</span>
	at java.util.concurrent.ThreadPoolExecutor<span style=color:#000>$Worker</span>.run<span style=color:#ce5c00;font-weight:700>(</span>ThreadPoolExecutor.java:624<span style=color:#ce5c00;font-weight:700>)</span>
	at java.lang.Thread.run<span style=color:#ce5c00;font-weight:700>(</span>Thread.java:748<span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>那么我们就从源码分析问题，看看如何解决。</p><h3 id=2-源码分析问题>2. 源码分析问题</h3><p>通过搜索错误信息可以定位到错误是从 <strong><code>BrokerFastFailure</code></strong> 类抛出来的。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>cleanExpiredRequestInQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>BlockingQueue</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>blockingQueue</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>maxWaitTimeMillsInQueue</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>blockingQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Runnable</span> <span style=color:#000>runnable</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>blockingQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>peek</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>runnable</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>RequestTask</span> <span style=color:#000>rt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>castRunnable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>runnable</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rt</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>rt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isStopRun</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>

                    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>behind</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>rt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCreateTimestamp</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>behind</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>maxWaitTimeMillsInQueue</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>blockingQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>runnable</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>rt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setStopRun</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#000>rt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>returnResponse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RemotingSysResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SYSTEM_BUSY</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>format</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[TIMEOUT_CLEAN_QUEUE]broker busy, start flow control for a while, period in queue: %sms, size of queue: %d&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>behind</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>blockingQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()));</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ignored</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>那么这个 <strong><code>BrokerFastFailure#cleanExpiredRequestInQueue</code></strong> 主要用于清理阻塞队列中的过期的 <strong><code>RequestTask</code></strong> 。这个方法在**<code>BrokerFastFailure#cleanExpiredRequest</code>** 中被调用：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>cleanExpiredRequest</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        
        <span style=color:#8f5902;font-style:italic>//系统页忙抛错
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStore</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isOSPageCacheBusy</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSendThreadPoolQueue</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Runnable</span> <span style=color:#000>runnable</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSendThreadPoolQueue</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>poll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SECONDS</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>runnable</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>

                    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>RequestTask</span> <span style=color:#000>rt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>castRunnable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>runnable</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#000>rt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>returnResponse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RemotingSysResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SYSTEM_BUSY</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>format</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[PCBUSY_CLEAN_QUEUE]broker busy, start flow control for a while, period in queue: %sms, size of queue: %d&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>rt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCreateTimestamp</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSendThreadPoolQueue</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()));</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ignored</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#8f5902;font-style:italic>//清理过期发送消息队列请求
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>cleanExpiredRequestInQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSendThreadPoolQueue</span><span style=color:#ce5c00;font-weight:700>(),</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getWaitTimeMillsInSendQueue</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#8f5902;font-style:italic>//清理过期拉取消息的请求
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>cleanExpiredRequestInQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPullThreadPoolQueue</span><span style=color:#ce5c00;font-weight:700>(),</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getWaitTimeMillsInPullQueue</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#8f5902;font-style:italic>//清理过期心跳的请求
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>cleanExpiredRequestInQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getHeartbeatThreadPoolQueue</span><span style=color:#ce5c00;font-weight:700>(),</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getWaitTimeMillsInHeartbeatQueue</span><span style=color:#ce5c00;font-weight:700>());</span>
<span style=color:#8f5902;font-style:italic>//清理过期事务请求
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>cleanExpiredRequestInQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getEndTransactionThreadPoolQueue</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>this</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getWaitTimeMillsInTransactionQueue</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>由于是之前在不停的往MQ发送消息消息，所以判断是由于清理过期的发送处理请求导致的。</strong></p><h3 id=3-如何解决问题>3. 如何解决问题</h3><p>那么如何解决问题，通过代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>cleanExpiredRequestInQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSendThreadPoolQueue</span><span style=color:#ce5c00;font-weight:700>(),</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getWaitTimeMillsInSendQueue</span><span style=color:#ce5c00;font-weight:700>());</span>
</code></pre></div><p>可以看一出来通过增加等待时间来解决这个问题。只需要在配置Broker的配置文件中修改如下值即可：</p><pre><code class=language-properties data-lang=properties>waitTimeMillsInSendQueue=200 （默认值）--修改这个值
</code></pre><blockquote><p>我是蚂蚁背大象，文章对你有帮助点赞关注我，文章有不正确的地方请您斧正留言评论~谢谢！</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-1318634060ab5b269397ea8e6eabebfb>11 - RocketMQ Docker部署</h1><blockquote><p>目前官方 RocketMQ 镜像 <code>hub.docker.com</code> 最新版本为<a href="https://hub.docker.com/layers/apacherocketmq/rocketmq/4.6.0/images/sha256-4c640187427b68c832b821cf7f4dcbb3004089cdda9e2079e9070179d0ce86df?context=explore">4.6.0</a>，但是现在RocketMQ的最新版本已经到了4.9.2。所以4.6.0往上的新版本就不能直接通过DockerHub进行安装。那么RocketMQ只能自己在本地打包镜像。</p><p>这里我基于RocketMQ 4.9.2版本来进行全套的打包部署</p></blockquote><h3 id=1-镜像制作前准备>1. 镜像制作前准备</h3><h4 id=11-clone-rocketmq-docker项目的代码>1.1 clone rocketmq-docker项目的代码</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#8f5902;font-style:italic>#官方的docker地址</span>
git clone https://github.com/apache/rocketmq-docker.git
</code></pre></div><p>执行上面命令克隆下来这项目的代码。</p><h3 id=2-构建镜像>2. 构建镜像</h3><p>这里需要构建的镜像有两个</p><ul><li>rocketmq-dashboard镜像(web控制台)</li><li>rocketmq镜像(NameSrv和Broker)</li></ul><h4 id=21-rocketmq镜像构建>2.1 rocketmq镜像构建</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#204a87>cd</span> image-build
sh build-image.sh RMQ-VERSION BASE-IMAGE
</code></pre></div><blockquote><p>原理：通过版本和BASE-IMAGE(支持centos, alpine)来判断是使用 Dockerfile-centos文件还是Dockerfile-alpine文件来构建镜像。</p></blockquote><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/rocketmq/rocketmq-centos%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA.png alt></p><p>等待镜像构建完成，然后通过docker命令查看</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>docker image ls
</code></pre></div><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/rocketmq/rocketmq%E5%88%9B%E5%BB%BA%E5%A5%BD%E7%9A%84%E9%95%9C%E5%83%8F.png alt></p><h4 id=22-rocketmq-dashboard镜像构建>2.2 rocketmq-dashboard镜像构建</h4><p>和构建rocketmq镜像一样，我们依葫芦画瓢构建rocketmq-dashboard镜像</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#204a87>cd</span> image-build
sh build-image-dashboard.sh dashboard-VERSION BASE-IMAGE
</code></pre></div><blockquote><p>BASE-IMAGE只支持centos</p></blockquote><p><img src="https://github.com/mxsm/picture/blob/main/rocketmq/build-image-dashboard.png?raw=true" alt></p><p>等待镜像构建完成。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>docker image ls
</code></pre></div><p><img src="https://github.com/mxsm/picture/blob/main/rocketmq/web%E6%8E%A7%E5%88%B6%E5%8F%B0%E6%89%93%E5%8C%85%E9%95%9C%E5%83%8F%E5%AE%8C%E6%88%90.png?raw=true" alt></p><h3 id=3-docker-compose-安装>3. Docker-compose 安装</h3><p>这里为什么用Docker-compose 安装呢？因为RocketMQ的安装的东西有三个部分：<strong>namesrv、broker、rocketmq-dashboard</strong> ，用Docker-compose安装起来比较方便。</p><h4 id=31-环境准备>3.1 环境准备</h4><blockquote><p>本地已经有了rocketmq-dashboard镜像和rocketmq镜像</p></blockquote><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/rocketmq/%E5%B7%B2%E7%BB%8F%E5%87%86%E5%A4%87%E5%A5%BD%E7%9A%84%E9%95%9C%E5%83%8F.png alt></p><h4 id=32-rockermq-单机部署>3.2 RockerMQ 单机部署</h4><h5 id=321-namesrv的docker宿主机环境>3.2.1 NameSrv的Docker宿主机环境</h5><p>主要配置的是日志路径以及存储路径。(挂载路径)</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>mkdir -p /root/rocketmq/data/namesrv/logs

mkdir -p /root/rocketmq/data/namesrv/store
</code></pre></div><h5 id=322-broker的docker宿主机环境>3.2.2 Broker的Docker宿主机环境</h5><p>主要创建日志、数据存储、以及配置存放的挂载路径</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>mkdir -p /root/rocketmq/data/broker/logs
mkdir -p /root/rocketmq/data/broker/store
mkdir -p /root/rocketmq/etc/broker
</code></pre></div><h5 id=323-broker配置文件创建>3.2.3 Broker配置文件创建</h5><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>nano /root/rocketmq/etc/broker/broker.conf
</code></pre></div><p>文件内容如下:</p><pre><code class=language-properties data-lang=properties>brokerClusterName = mxsm-docker
brokerName = mxsm-docker-a
brokerId = 0
deleteWhen = 04
fileReservedTime = 48
brokerRole = ASYNC_MASTER
flushDiskType = ASYNC_FLUSH
# Docker环境需要设置成宿主机IP
#brokerIP1 = {docker宿主机IP}
brokerIP1 = 192.168.43.128
</code></pre><blockquote><p>例如：在Docker宿主机通过命令查询到的IP地址为 <strong><code>192.168.43.128</code></strong> 那么这个地方就设置为 <strong><code>192.168.43.128</code></strong></p></blockquote><h5 id=324-编写docker-compose文件>3.2.4 编写Docker-compose文件</h5><blockquote><p>这里编写Docker-compose文件版本使用的3，有的人docker可能版本没这么高，可以使用2看个人调整。</p></blockquote><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;3&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>services</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic>#Service for nameserver</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namesrv</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apacherocketmq/rocketmq:4.9.2</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>container_name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>rocketmq-namesrv</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>ports</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#0000cf;font-weight:700>9876</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>9876</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>environment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#000>JAVA_OPT_EXT=-server -Xms256m -Xmx256m -Xmn256m</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>volumes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#000>/root/rocketmq/data/namesrv/logs:/root/logs</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>command</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sh mqnamesrv</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic>#Service for broker</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>broker</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apacherocketmq/rocketmq:4.9.2</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>container_name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>rocketmq-broker</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>links</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#000>namesrv</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>depends_on</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#000>namesrv</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>ports</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#0000cf;font-weight:700>10909</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>10909</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#0000cf;font-weight:700>10911</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>10911</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#0000cf;font-weight:700>10912</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>10912</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>environment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#000>NAMESRV_ADDR=namesrv:9876</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#000>JAVA_OPT_EXT=-server -Xms512m -Xmx512m -Xmn256m</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>volumes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#000>/root/rocketmq/data/broker/logs:/home/rocketmq/logs</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#000>/root/rocketmq/data/broker/store:/home/rocketmq/store</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#000>/root/rocketmq/etc/broker/broker.conf:/home/rocketmq/conf/broker.conf</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>command</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sh mqbroker -c /home/rocketmq/conf/broker.conf</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic>#Service for rocketmq-dashboard</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>dashboard</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apache/rocketmq-dashboard:1.0.0-centos</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>container_name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>rocketmq-dashboard</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>ports</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#0000cf;font-weight:700>8080</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>8080</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>links</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#000>namesrv</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>depends_on</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#000>namesrv</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>environment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#000>NAMESRV_ADDR=namesrv:9876</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>运行命令：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>docker-compose -f ./docker-compose.yml up
</code></pre></div><p>然后查看运行的情况。</p><blockquote><p>在运行的过程中总是发现有这样的一个问题：rocketmq-broker exited with code 253，也没日志打印。这里可能是挂载路径没有权限的问题。加上权限即可。</p></blockquote><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/rocketmq/%E8%BF%90%E8%A1%8C%E6%88%90%E5%8A%9F.png alt></p><p>然后在本地登录web控制台进行验证</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/rocketmq/web%E6%8E%A7%E5%88%B6%E5%8F%B0.png alt></p><h3 id=4-总结>4. 总结</h3><ul><li>总的来说大家可以根据官方的 <strong><code>rocketmq-docker</code></strong> 项目来进行docker部署。这里也存在一些问题，我开始用官方的创建镜像很慢，特别是下载和编译的时候。这里也可以在本地将项目进行编译然后修改一下从本地进行镜像构建。这样构建有一个好处，在本地能够构建正在开发的版本镜像。</li><li>官方的Docker-compose没有将rocketmq-dashboard控制台进行运行。</li></ul></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list"><a class=text-white target=_blank rel="noopener noreferrer" href=https://groups.google.com/u/1/g/ljbmxsm><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=个人掘金主页 aria-label=个人掘金主页><a class=text-white target=_blank rel="noopener noreferrer" href=https://juejin.cn/user/1151943918492855><i class="fab fa-twitter"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/mxsm><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2022 The Docsy Authors All Rights Reserved</small>
<small class=ml-1><a href=https://policies.google.com/privacy target=_blank>隐私政策</a></small><p class=mt-2><a href=/about/>Home</a></p></div></div></div></footer><div><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css><script src=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js></script><script>$("p img").wrap(function(){return'<a data-fancybox="gallery" href="'+$(this).attr('src')+'"></a>'})</script></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/mermaid@8.8.1/dist/mermaid.min.js integrity=sha384-to2w0I1OqmbJ9J6yTnIX+KYU8grNpZoD1dKPLjgEJvMe5L5+/7qvuNa2sQo8WAWj crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/raphael/2.3.0/raphael.min.js integrity="sha512-tBzZQxySO5q5lqwLWfu8Q+o4VkTcRGOeQGVQ0ueJga4A1RKuzmAu5HXDOXLEjpbKyV7ow9ympVoa6wZLEzRzDg==" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.15.0/flowchart.min.js integrity="sha512-6QsSiIybtf8tuZ6xfjRTr2tdtw3Gp4q5RSCh2b6q9seoKEQmhAG1RrCA8F0kXTwivVxRVbp/YF3zOh8rvEAU7Q==" crossorigin=anonymous></script><script src=/js/main.min.b541b310f01941a0abfd76b652b5fb60dac470573775bb5b31ff08fe3f6cea51.js integrity="sha256-tUGzEPAZQaCr/Xa2UrX7YNrEcFc3dbtbMf8I/j9s6lE=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.js></script><script type=text/javascript>docsearch({appId:'JO2SY3WDAC',apiKey:'324ddb3b679c1308e5aa8bf222e07f8b',indexName:'mxsm',inputSelector:'.td-search-input',debug:!1})</script></body></html>