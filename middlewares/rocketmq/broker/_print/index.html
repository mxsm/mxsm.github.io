<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.83.1"><link rel=canonical type=text/html href=/middlewares/rocketmq/broker/><link rel=alternate type=application/rss+xml href=/middlewares/rocketmq/broker/index.xml><meta name=ROBOTS content="INDEX, FOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>RocketMQ Broker | 蚂蚁背大象</title><meta property="og:title" content="RocketMQ Broker"><meta property="og:description" content="蚂蚁背大象博客"><meta property="og:type" content="website"><meta property="og:url" content="/middlewares/rocketmq/broker/"><meta property="og:site_name" content="蚂蚁背大象"><meta itemprop=name content="RocketMQ Broker"><meta itemprop=description content="蚂蚁背大象博客"><meta name=twitter:card content="summary"><meta name=twitter:title content="RocketMQ Broker"><meta name=twitter:description content="蚂蚁背大象博客"><link rel=preload href=/scss/main.min.e09cb23c7dff3bf1285aa0294bcdc4ac8194fb3425a99c621e31e7b871315685.css as=style><link href=/scss/main.min.e09cb23c7dff3bf1285aa0294bcdc4ac8194fb3425a99c621e31e7b871315685.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 321.39 78.54"><title id="title19">DUBBO LOGO</title><path class="cls-1" d="M68.46 50.38c0 14.06 11.39 22.11 25.45 22.11s25.45-8.05 25.45-22.11V7.25H68.46zm21.24-28h8.6V31H89.7zm0 22.25h8.6v8.6H89.7zM33.24 7.25H4.06v64H33.24c10.95.0 19.3-7.18 23.29-17.15a45.12 45.12.0 002.38-14.87A45.12 45.12.0 0056.53 24.4C52.84 14.62 44.19 7.25 33.24 7.25zm.43 14.63H30.34a3.44 3.44.0 00-3.44 3.44V53.23a3.44 3.44.0 003.44 3.44h3.33v4.63h-8.3a6.87 6.87.0 01-6.87-6.87V24.12a6.87 6.87.0 016.87-6.87h8.3zM285.51 6.06c-17.05.0-30.88 10.28-30.88 33.21s13.83 33.21 30.88 33.21 30.88-10.28 30.88-33.21S302.56 6.06 285.51 6.06zm7.59 48.36a6.87 6.87.0 01-6.87 6.87h-8.3V56.67h3.33a3.44 3.44.0 003.44-3.44V25.31a3.44 3.44.0 00-3.44-3.44h-3.33V17.25h8.3a6.87 6.87.0 016.87 6.87zm-53.4-17.56A17.39 17.39.0 00227.31 7.25H195.1v64h32.21a19.44 19.44.0 0012.38-34.44zM211.63 61.29h-6.08l18.68-44h6.08zM177 36.85A17.39 17.39.0 00164.65 7.25H132.43v64h32.21A19.44 19.44.0 00177 36.85zM149 61.29h-6.08l18.68-44h6.08z" style="fill:#fff;fill-opacity:1"/></svg></span><span class="text-uppercase font-weight-bold">蚂蚁背大象</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/about/><span>Home</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog/><span>Java</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/spring/><span>Spring</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/middlewares/><span class=active>Middleware</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/><span>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/other/><span>Others</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community/><span>Community</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002 站内搜索…" aria-label=站内搜索… autocomplete=off></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/middlewares/rocketmq/broker/>Return to the regular view of this page</a>.</p></div><h1 class=title>RocketMQ Broker</h1><ul><li>1: <a href=#pg-509eb51b6081d849ed4c61b8e6620a26>RocketMQ源码解析-Broker启动</a></li><li>2: <a href=#pg-cdaf32cb67db0031ee4184b758640ac6>RocketMQ源码解析-Broker与NameServer交互</a></li><li>3: <a href=#pg-1d71c5af06e2352a2297be5b774c9efe>RocketMQ源码解析-Broker消息存储设计与实现</a></li><li>4: <a href=#pg-0fec2e79472ea5138a6011e79ed0c356>RocketMQ源码解析-Broker消息存储CommitLog</a></li><li>5: <a href=#pg-5ef930f71905a5f352f4de5310e3a582>RocketMQ源码解析-Broker消息存储ConsumeQueue</a></li><li>6: <a href=#pg-dfb0d002a8796933e78fa9fb8fb118e1>RocketMQ源码解析-Broker接收拉取消息</a></li><li>7: <a href=#pg-4d09b652a4bc68f5db4484f96fa278db>RocketMQ源码解析-Broker故障恢复</a></li><li>8: <a href=#pg-2e0b99c502e1d6196c2f892af868f2d9>RocketMQ源码解析-Broker存储配置文件说明</a></li><li>9: <a href=#pg-73525016293fc3e03673666421e0bb7b>RocketMQ源码解析-Broker 消息Tag过滤</a></li></ul><div class=content><p>Broker主要负责消息的存储、投递和查询以及服务高可用保证，为了实现这些功能，Broker包含了以下几个重要子模块:</p><ul><li><strong>Remoting Module</strong> ：整个Broker的实体，负责处理来自clients端的请求</li><li><strong>Client Manager</strong>：负责管理客户端(Producer/Consumer)和维护Consumer的Topic订阅信息</li><li><strong>Store Service</strong> ：提供方便简单的API接口处理消息存储到物理硬盘和查询功能</li><li><strong>HA Service</strong> ：高可用服务，提供Master Broker 和 Slave Broker之间的数据同步功能</li><li><strong>Index Service</strong> ：根据特定的Message key对投递到Broker的消息进行索引服务，以提供消息的快速查询</li></ul></div></div><div class=td-content style=page-break-before:always><h1 id=pg-509eb51b6081d849ed4c61b8e6620a26>1 - RocketMQ源码解析-Broker启动</h1><blockquote><p>以下源码基于Rocket MQ 4.7.0</p></blockquote><h3 id=1-broker>1. Broker</h3><p>消息中转角色，负责存储消息、转发消息。Broker在RocketMQ系统中负责接收从生产者发送来的消息并存储、同时为消费者的拉取请求作准备。代理服务器也存储消息相关的元数据，包括消费者组、消费进度偏移和主题和队列消息等。</p><h3 id=2-broker作用>2. Broker作用</h3><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/Broker%E5%8A%9F%E8%83%BD%E5%88%97%E8%A1%A8%E5%9B%BE.png?raw=true" alt></p><p>主要四个作用：</p><ul><li>消息存储</li><li>消息投递</li><li>消息查询</li><li>服务的高可用</li></ul><p>这四个功能由五个模块来实现。</p><h3 id=3-broker启动流程分析>3. Broker启动流程分析</h3><p>总体的启动流程和NameServer的启动流程差不多但是比NameServer的启动流程复杂：</p><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/BrokerControllerFlowchart.png?raw=true" alt></p><p>这个流程大致分为以下的几个步骤：</p><ol><li><strong>BrokerController创建</strong><ul><li>NettyServer和NettyClient的配置处理</li><li>命令行参数的处理</li><li>Broker角色的处理</li><li>创建BrokerController</li><li>初始化BrokerController通过调用方法</li></ul></li><li><strong>BrokerController启动</strong></li></ol><h3 id=4-brokercontroller创建>4. BrokerController创建</h3><p><strong><code>BrokerStartUp.createBrokerController</code></strong> 调用方法创建</p><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/%E8%AE%BE%E7%BD%AE%E5%8F%91%E9%80%81%E5%8C%BA%E6%8E%A5%E6%94%B6%E5%8C%BA%E7%9A%84%E7%BC%93%E5%AD%98.png?raw=true" alt></p><p>上图是设置Netty的发送和接收缓冲区的大小。</p><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/Broker%E8%A7%92%E8%89%B2%E5%A4%84%E7%90%86.png?raw=true" alt></p><p>上图主要是处理在集群条件小的Broker角色的，从这里看出来brokerId为0的为Mater节点，其他的为Slave节点。</p><blockquote><p>角色类型：SYNC_MASTER/ASYNC_MASTER/SLAVE 默认为ASYNC_MASTER，</p><p>官方文档：https://rocketmq.apache.org/docs/rmq-deployment/</p></blockquote><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%82%E6%95%B0%E5%A4%84%E7%90%86.png?raw=true" alt></p><p>上图是处理命令行参数</p><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/%E5%88%9D%E5%A7%8B%E5%8C%96BrokerController.png?raw=true" alt></p><p>初始化BrokerController。然后返回controller。</p><h3 id=5-brokercontroller启动>5. BrokerController启动</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>BrokerController</span> <span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BrokerController</span> <span style=color:#000>controller</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>

            <span style=color:#000>controller</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#000>String</span> <span style=color:#000>tip</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;The broker[&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>controller</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getBrokerName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;, &#34;</span>
                <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>controller</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerAddr</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;] boot success. serializeType=&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>RemotingCommand</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSerializeTypeConfigInThisServer</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>controller</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getNamesrvAddr</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>tip</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#4e9a06>&#34; and name server is &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>controller</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getNamesrvAddr</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tip</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;%s%n&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>tip</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>controller</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>exit</span><span style=color:#ce5c00;font-weight:700>(-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div><p>启动比较简单，调用start方法。</p><h3 id=6-broker配置>6. Broker配置</h3><table><thead><tr><th style=text-align:left>Property Name</th><th style=text-align:center>Default value</th><th style=text-align:right>Details</th></tr></thead><tbody><tr><td style=text-align:left>listenPort</td><td style=text-align:center>10911</td><td style=text-align:right>listen port for client</td></tr><tr><td style=text-align:left>namesrvAddr</td><td style=text-align:center>null</td><td style=text-align:right>name server address</td></tr><tr><td style=text-align:left>brokerIP1</td><td style=text-align:center>InetAddress for network interface</td><td style=text-align:right>Should be configured if having multiple addresses</td></tr><tr><td style=text-align:left>brokerName</td><td style=text-align:center>null</td><td style=text-align:right>broker name</td></tr><tr><td style=text-align:left>brokerClusterName</td><td style=text-align:center>DefaultCluster</td><td style=text-align:right>this broker belongs to which cluster</td></tr><tr><td style=text-align:left>brokerId</td><td style=text-align:center>0</td><td style=text-align:right>broker id, 0 means master, positive integers mean slave</td></tr><tr><td style=text-align:left>storePathCommitLog</td><td style=text-align:center>$HOME/store/commitlog/</td><td style=text-align:right>file path for commit log</td></tr><tr><td style=text-align:left>storePathConsumerQueue</td><td style=text-align:center>$HOME/store/consumequeue/</td><td style=text-align:right>file path for consume queue</td></tr><tr><td style=text-align:left>mapedFileSizeCommitLog</td><td style=text-align:center>1024 * 1024 * 1024(1G)</td><td style=text-align:right>mapped file size for commit log</td></tr><tr><td style=text-align:left>deleteWhen</td><td style=text-align:center>04</td><td style=text-align:right>When to delete the commitlog which is out of the reserve time</td></tr><tr><td style=text-align:left>fileReserverdTime</td><td style=text-align:center>72</td><td style=text-align:right>The number of hours to keep a commitlog before deleting it</td></tr><tr><td style=text-align:left>brokerRole</td><td style=text-align:center>ASYNC_MASTER</td><td style=text-align:right>SYNC_MASTER/ASYNC_MASTER/SLAVE</td></tr><tr><td style=text-align:left>flushDiskType</td><td style=text-align:center>ASYNC_FLUSH</td><td style=text-align:right>{SYNC_FLUSH/ASYNC_FLUSH}. Broker of SYNC_FLUSH mode flushes each message onto disk before acknowledging producer. Broker of ASYNC_FLUSH mode, on the other hand, takes advantage of group-committing, achieving better performance.</td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-cdaf32cb67db0031ee4184b758640ac6>2 - RocketMQ源码解析-Broker与NameServer交互</h1><blockquote><p>以下源码基于Rocket MQ 4.7.0</p></blockquote><h3 id=1-broker与nameserver的交互>1. Broker与NameServer的交互</h3><p>Broker启动，跟所有的NameServer保持长连接，定时发送心跳包。心跳包中包含当前Broker信息(IP+端口等)以及存储所有Topic信息。注册成功后，NameServer集群中就有Topic跟Broker的映射关系。</p><blockquote><p>Broker会连接配置在配置文件中的所有NameServer。以同步(sync)通讯的方式和NameServer进行通讯。</p><p>通讯方式：</p><ul><li>同步(sync)</li><li>异步(async)</li><li>单向(oneway)</li></ul></blockquote><h3 id=2-客户端的创建>2. 客户端的创建</h3><p>Broker与NameServer进行数据交互主要是通过一个叫做 <strong><code>BrokerOuterAPI</code></strong> 的类来进行的。那么这个类的实例对象在哪里没创建又在哪里被引用来处理和NameServer的数据交互。</p><p>首先来看一下在哪里创建：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BrokerController</span><span style=color:#ce5c00;font-weight:700>(</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>BrokerConfig</span> <span style=color:#000>brokerConfig</span><span style=color:#ce5c00;font-weight:700>,</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>NettyServerConfig</span> <span style=color:#000>nettyServerConfig</span><span style=color:#ce5c00;font-weight:700>,</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>NettyClientConfig</span> <span style=color:#000>nettyClientConfig</span><span style=color:#ce5c00;font-weight:700>,</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MessageStoreConfig</span> <span style=color:#000>messageStoreConfig</span>
<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
<span style=color:#8f5902;font-style:italic>//.....
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerOuterAPI</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BrokerOuterAPI</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nettyClientConfig</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>//.....
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面这段代码是在BrokerController的构造函数里面，没错就在创建BrokerController的时候会在构造函数里面创建BrokerOuterAPI这个类。</p><p>接下来看一下这个类在哪里被引用了。首先我们来看一下在BrokerController创建好了以后，最后调用BrokerController.start方法来启动Controller。在启动代码中有这样一段。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//BrokerController.start方法中的一段代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scheduledExecutorService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scheduleAtFixedRate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>BrokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerBrokerAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>brokerConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isForceRegister</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;registerBrokerAll Exception&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>1000</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>max</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>10000</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>min</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>brokerConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRegisterNameServerPeriod</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>60000</span><span style=color:#ce5c00;font-weight:700>)),</span> <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MILLISECONDS</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>从上面的代码可以看出来是一个以以固定频率执行的定时器，这个定时器执行了BrokerController.registerBrokerAll 方法。</p><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/registerBrokerAll.png?raw=true" alt></p><ol><li>构造一些Broker topic的信息</li><li>Broker的元数据信息</li></ol><p>通过 <strong><code>BrokerController.doRegisterBrokerAll</code></strong> 私有方法来处理数据。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>doRegisterBrokerAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>checkOrderConfig</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>oneway</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>TopicConfigSerializeWrapper</span> <span style=color:#000>topicConfigWrapper</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//通过brokerOuterAPI注册Broker的信息到NameServer
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>RegisterBrokerResult</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>registerBrokerResultList</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerOuterAPI</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerBrokerAll</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerClusterName</span><span style=color:#ce5c00;font-weight:700>(),</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerAddr</span><span style=color:#ce5c00;font-weight:700>(),</span>  <span style=color:#8f5902;font-style:italic>//IP:Port
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerName</span><span style=color:#ce5c00;font-weight:700>(),</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerId</span><span style=color:#ce5c00;font-weight:700>(),</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getHAServerAddr</span><span style=color:#ce5c00;font-weight:700>(),</span>
            <span style=color:#000>topicConfigWrapper</span><span style=color:#ce5c00;font-weight:700>,</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>filterServerManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>buildNewFilterServerList</span><span style=color:#ce5c00;font-weight:700>(),</span>
            <span style=color:#000>oneway</span><span style=color:#ce5c00;font-weight:700>,</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRegisterBrokerTimeoutMills</span><span style=color:#ce5c00;font-weight:700>(),</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isCompressedRegister</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#8f5902;font-style:italic>//注册结果返回处理
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registerBrokerResultList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>RegisterBrokerResult</span> <span style=color:#000>registerBrokerResult</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>registerBrokerResultList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registerBrokerResult</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>updateMasterHAServerAddrPeriodically</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>registerBrokerResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getHaServerAddr</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>updateHaMasterAddress</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registerBrokerResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getHaServerAddr</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#ce5c00;font-weight:700>}</span>

                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>slaveSynchronize</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setMasterAddr</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registerBrokerResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMasterAddr</span><span style=color:#ce5c00;font-weight:700>());</span>

                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>checkOrderConfig</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopicConfigManager</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>updateOrderTopicConfig</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registerBrokerResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getKvTable</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=3-broker端数据的处理>3. Broker端数据的处理</h3><p>Broker和NameServer的数据处理通过上面可以知道主要是通过 <strong><code>BrokerOuterAPI.registerBrokerAll</code></strong> 处理。首先通过获取配置在Broker配置文件中的namesrvAddr。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>nameServerAddressList</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remotingClient</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNameServerAddressList</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div><p>然后构建 <strong><code>RegisterBrokerRequestHeader</code></strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>RegisterBrokerRequestHeader</span> <span style=color:#000>requestHeader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RegisterBrokerRequestHeader</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBrokerAddr</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>brokerAddr</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//broker地址 IP:Port
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBrokerId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>brokerId</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// broker id 
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBrokerName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>brokerName</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// broker名称
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setClusterName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clusterName</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// 集群名称
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setHaServerAddr</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>haServerAddr</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// haServer地址
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCompressed</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>compressed</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// 是否压缩
</span></code></pre></div><p>构造 <strong><code>RegisterBrokerBody</code></strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>            <span style=color:#000>RegisterBrokerBody</span> <span style=color:#000>requestBody</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RegisterBrokerBody</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>requestBody</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTopicConfigSerializeWrapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topicConfigWrapper</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>requestBody</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setFilterServerList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>filterServerList</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>body</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>requestBody</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>encode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>compressed</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>bodyCrc32</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>UtilAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>crc32</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>body</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBodyCrc32</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bodyCrc32</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>然后就是发送数据到NameServer</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>CountDownLatch</span> <span style=color:#000>countDownLatch</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CountDownLatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nameServerAddressList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>namesrvAddr</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>nameServerAddressList</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>brokerOuterExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>execute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#5c35cc;font-weight:700>@Override</span>
                    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#8f5902;font-style:italic>//注册Broker发送数据
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#000>RegisterBrokerResult</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>registerBroker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>namesrvAddr</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>oneway</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>timeoutMills</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>body</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#000>registerBrokerResultList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>

                            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;register broker[{}]to name server {} OK&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>brokerId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>namesrvAddr</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;registerBroker Exception, {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>namesrvAddr</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>countDownLatch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>countDown</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>});</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>countDownLatch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>await</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timeoutMills</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MILLISECONDS</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过调用 <strong><code>BrokerOuterAPI.registerBroker</code></strong> 方法来注册Broker。</p><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/registerBroker.png?raw=true" alt></p><ol><li>单向通讯</li><li>同步通讯</li></ol><p>通过上面可以看到请求的代码是 <strong><code>RequestCode.REGISTER_BROKER</code></strong> 。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-1d71c5af06e2352a2297be5b774c9efe>3 - RocketMQ源码解析-Broker消息存储设计与实现</h1><blockquote><p>以下源码基于Rocket MQ 4.7.0</p></blockquote><h3 id=1-消息存储图解>1. 消息存储图解</h3><p><img src=https://github.com/apache/rocketmq/raw/master/docs/cn/image/rocketmq_design_1.png alt=官网图></p><p>消息存储是RocketMQ中最为复杂和最为重要的一部分，本节将分别从RocketMQ的消息存储整体架构、PageCache与Mmap内存映射以及RocketMQ中两种不同的刷盘方式三方面来分别展开叙述。</p><ul><li><strong>消息存储整体架构</strong></li><li><strong>页缓存与内存映射</strong></li><li><strong>消息刷盘</strong></li></ul><h3 id=2-消息存储整体架构>2. 消息存储整体架构</h3><p>跟消息存储的主要有三个相关的文件组成：</p><ul><li><p><strong>CommitLog</strong></p><p>消息主体以及元数据的存储主体，存储Producer端写入的消息主体内容,消息内容不是定长的。单个文件大小默认1G ，文件名长度为20位，左边补零，剩余为起始偏移量，比如00000000000000000000代表了第一个文件，起始偏移量为0，文件大小为1G=1073741824；当第一个文件写满了，第二个文件为00000000001073741824，起始偏移量为1073741824，以此类推。消息主要是顺序写入日志文件，当文件满了，写入下一个文件:</p><p><img src="https://github.com/mxsm/picture/blob/main/rocketmq/commitlog%E4%BD%8D%E7%BD%AE.png?raw=true" alt></p></li><li><p><strong>ConsumeQueue</strong></p><p>消息消费队列，引入的目的主要是提高消息消费的性能，由于RocketMQ是基于主题topic的订阅模式，消息消费是针对主题进行的，如果要遍历commitlog文件中根据topic检索消息是非常低效的。Consumer即可根据ConsumeQueue来查找待消费的消息。其中，ConsumeQueue（逻辑消费队列）作为消费消息的索引，保存了指定Topic下的队列消息在CommitLog中的起始物理偏移量offset，消息大小size和消息Tag的HashCode值。consumequeue文件可以看成是基于topic的commitlog索引文件，故consumequeue文件夹的组织方式如下：topic/queue/file三层组织结构，具体存储路径为：$HOME/store/consumequeue/{topic}/{queueId}/{fileName}。同样consumequeue文件采取定长设计，每一个条目共20个字节，分别为8字节的commitlog物理偏移量、4字节的消息长度、8字节tag hashcode，单个文件由30W个条目组成，可以像数组一样随机访问每一个条目，每个ConsumeQueue文件大小约5.72M；</p><p><img src="https://github.com/mxsm/picture/blob/main/rocketmq/consumequeue%E4%BD%8D%E7%BD%AE.png?raw=true" alt></p></li><li><p><strong>IndexFile</strong></p><p>IndexFile（索引文件）提供了一种可以通过key或时间区间来查询消息的方法。Index文件的存储位置是：$HOME \store\index${fileName}，文件名fileName是以创建时的<strong>时间戳命名</strong>的，固定的单个IndexFile文件大小约为400M，一个IndexFile可以保存 2000W个索引，IndexFile的底层存储设计为在文件系统中实现HashMap结构，故rocketmq的索引文件其底层实现为hash索引。</p><p><img src="https://github.com/mxsm/picture/blob/main/rocketmq/indexLog.png?raw=true" alt></p></li></ul><p>在上面的RocketMQ的消息存储整体架构图中可以看出，RocketMQ采用的是混合型的存储结构，即为Broker单个实例下所有的队列共用一个日志数据文件（即为CommitLog）来存储。RocketMQ的混合型存储结构(多个Topic的消息实体内容都存储于一个CommitLog中)针对Producer和Consumer分别采用了数据和索引部分相分离的存储结构，Producer发送消息至Broker端，然后Broker端使用同步或者异步的方式对消息刷盘持久化，保存至CommitLog中。只要消息被刷盘持久化至磁盘文件CommitLog中，那么Producer发送的消息就不会丢失。正因为如此，Consumer也就肯定有机会去消费这条消息。当无法拉取到消息后，可以等下一次消息拉取，同时服务端也支持长轮询模式，如果一个消息拉取请求未拉取到消息，Broker允许等待30s的时间，只要这段时间内有新消息到达，将直接返回给消费端。这里，RocketMQ的具体做法是，使用Broker端的后台服务线程—ReputMessageService不停地分发请求并异步构建ConsumeQueue（逻辑消费队列）和IndexFile（索引文件）数据。下面从代码的角度来分析这三个文件的生成。</p><h4 id=21-commitlog>2.1 CommitLog</h4><p>在代码中 <strong>CommitLog</strong> 对应一个 <strong><code>CommitLog</code></strong> 的Java类。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>CommitLog</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 消息的 MAGIC CODE daa320a7
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>MESSAGE_MAGIC_CODE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>626843481</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>InternalLogger</span> <span style=color:#000>log</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>InternalLoggerFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLogger</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LoggerName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>STORE_LOGGER_NAME</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 文件结尾空的 MAGIC CODE cbd43194
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>BLANK_MAGIC_CODE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>875286124</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MappedFileQueue</span> <span style=color:#000>mappedFileQueue</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>DefaultMessageStore</span> <span style=color:#000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>FlushCommitLogService</span> <span style=color:#000>flushCommitLogService</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>FlushCommitLogService</span> <span style=color:#000>commitLogService</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>AppendMessageCallback</span> <span style=color:#000>appendMessageCallback</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ThreadLocal</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MessageExtBatchEncoder</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>batchEncoderThreadLocal</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#8f5902;font-style:italic>/* topic-queueid */</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Long</span><span style=color:#8f5902;font-style:italic>/* offset */</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>topicQueueTable</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>1024</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>confirmOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1L</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>beginTimeInLock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>//..............
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>RocketMQ 以如下图所示存储格式将消息顺序写入 CommitLog，除了记录消息本身的属性（消息长度、消息体、Topic 长度、Topic、消息属性长度和消息属性），CommitLog 同时记录了消息所在消费队列的信息（消费队列 ID 和偏移量）。由于存储条目具备不定长的特性，当 CommitLog 剩余空间无法满足消息时，CommitLog 在尾部追加一个 MAGIC CODE 等于 BLANK_MAGIC_CODE 的存储条目作为结束标记，并将消息存储至下一个 CommitLog 文件。</p><blockquote><p>BLANK_MAGIC_CODE 的作用就是作为标记当前文件存储CommitLog纪录满了，接下来要用下一个文件存储。</p><p><strong>存储的位置：${user.home}/store/commitlog</strong></p></blockquote><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/CommitLog%E8%AE%B0%E5%BD%95%E6%A0%BC%E5%BC%8F.png?raw=true" alt></p><p>那么我们在代码中哪里可以看出来下面我们可以看一下 <strong><code>CommitLog.calMsgLength</code></strong> 的这个方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>calMsgLength</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>sysFlag</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>bodyLength</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>topicLength</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>propertiesLength</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>bornhostLength</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sysFlag</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>MessageSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>BORNHOST_V6_FLAG</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>8</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>20</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>storehostAddressLength</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sysFlag</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>MessageSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>STOREHOSTADDRESS_V6_FLAG</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>8</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>20</span><span style=color:#ce5c00;font-weight:700>;</span> 
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>msgLen</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>4</span> <span style=color:#8f5902;font-style:italic>//TOTALSIZE
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>4</span> <span style=color:#8f5902;font-style:italic>//MAGICCODE
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>4</span> <span style=color:#8f5902;font-style:italic>//BODYCRC
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>4</span> <span style=color:#8f5902;font-style:italic>//QUEUEID
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>4</span> <span style=color:#8f5902;font-style:italic>//FLAG
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>8</span> <span style=color:#8f5902;font-style:italic>//QUEUEOFFSET
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>8</span> <span style=color:#8f5902;font-style:italic>//PHYSICALOFFSET
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>4</span> <span style=color:#8f5902;font-style:italic>//SYSFLAG
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>8</span> <span style=color:#8f5902;font-style:italic>//BORNTIMESTAMP
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>bornhostLength</span> <span style=color:#8f5902;font-style:italic>//BORNHOST
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>8</span> <span style=color:#8f5902;font-style:italic>//STORETIMESTAMP
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>storehostAddressLength</span> <span style=color:#8f5902;font-style:italic>//STOREHOSTADDRESS
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>4</span> <span style=color:#8f5902;font-style:italic>//RECONSUMETIMES
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>8</span> <span style=color:#8f5902;font-style:italic>//PREPARED TRANSACTION OFFSET
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>4</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bodyLength</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>bodyLength</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>//BODY
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>topicLength</span> <span style=color:#8f5902;font-style:italic>//TOPIC
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>2</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertiesLength</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>propertiesLength</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>//propertieslength
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>msgLen</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>所以地址字段有IPV4和IPV6的区分所以长度会是8或者20字段。(这里包含了端口的数据)</p><blockquote><p>地址IPV4或者IPV6本来可以用4个字节和16个字节完成表示，这里为啥加了四个字节首先看MessageExt.socketAddress2ByteBuffer方法代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>ByteBuffer</span> <span style=color:#000>socketAddress2ByteBuffer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SocketAddress</span> <span style=color:#000>socketAddress</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ByteBuffer</span> <span style=color:#000>byteBuffer</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>InetSocketAddress</span> <span style=color:#000>inetSocketAddress</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InetSocketAddress</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>socketAddress</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>InetAddress</span> <span style=color:#000>address</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>inetSocketAddress</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAddress</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>address</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Inet4Address</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>byteBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inetSocketAddress</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAddress</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getAddress</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>byteBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inetSocketAddress</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAddress</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getAddress</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>16</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>byteBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inetSocketAddress</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPort</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>byteBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>flip</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>byteBuffer</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>因为加入了端口，4个字节来表示端口所以这里用的8和20个字节来表示。</p></blockquote><h4 id=22-consumequeue>2.2 ConsumeQueue</h4><p><strong><code>ConsumeQueue</code></strong> 在代码中对应的 <strong>ConsumeQueue</strong> 类：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ConsumeQueue</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>InternalLogger</span> <span style=color:#000>log</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>InternalLoggerFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLogger</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LoggerName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>STORE_LOGGER_NAME</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#8f5902;font-style:italic>//消费队列存储单元大小
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>CQ_STORE_UNIT_SIZE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>20</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>InternalLogger</span> <span style=color:#000>LOG_ERROR</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>InternalLoggerFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLogger</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LoggerName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>STORE_ERROR_LOGGER_NAME</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>DefaultMessageStore</span> <span style=color:#000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MappedFileQueue</span> <span style=color:#000>mappedFileQueue</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>queueId</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ByteBuffer</span> <span style=color:#000>byteBufferIndex</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>storePath</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>mappedFileSize</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>maxPhysicOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>minLogicOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ConsumeQueueExt</span> <span style=color:#000>consumeQueueExt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MessageStoreConfig</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// ConsumeQueue file size,default is 30W -- 默认条数30w调记录
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>mappedFileSizeConsumeQueue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>300000</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>ConsumeQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CQ_STORE_UNIT_SIZE</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#8f5902;font-style:italic>//获取ConsumeQueue的大小：5.72M左右5.73M不到
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>getMappedFileSizeConsumeQueue</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>factor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ceil</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mappedFileSizeConsumeQueue</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConsumeQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CQ_STORE_UNIT_SIZE</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>0</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>factor</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>ConsumeQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CQ_STORE_UNIT_SIZE</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从代码中可以看到 <strong><code>CQ_STORE_UNIT_SIZE</code></strong> 是一个固定值20，如下图所示。为了实现定长存储，ConsumeQueue 存储了消息 Tag 的 Hash Code，在进行 Broker 端消息过滤时，通过比较 Consumer 订阅 Tag 的 HashCode 和存储条目中的 Tag Hash Code 是否一致来决定是否消费消息。</p><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/ConsumeQueue.png?raw=true" alt></p><blockquote><p><strong>存储的位置：${user.home}/store/consumequeue/${topicName}/${queueId}/${fileName}</strong></p><p>每一个文件存储30w条数据</p></blockquote><h4 id=3-indexfile>3. IndexFile</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>IndexFile</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>InternalLogger</span> <span style=color:#000>log</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>InternalLoggerFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLogger</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LoggerName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>STORE_LOGGER_NAME</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hashSlotSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>indexSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>20</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>invalidIndex</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hashSlotNum</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//500w
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>indexNum</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//2000w
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MappedFile</span> <span style=color:#000>mappedFile</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>FileChannel</span> <span style=color:#000>fileChannel</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MappedByteBuffer</span> <span style=color:#000>mappedByteBuffer</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>IndexHeader</span> <span style=color:#000>indexHeader</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>//..........
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>下面来看一下IndexFile的存储结构：</p><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/IndexFile.png?raw=true" alt></p></div><div class=td-content style=page-break-before:always><h1 id=pg-0fec2e79472ea5138a6011e79ed0c356>4 - RocketMQ源码解析-Broker消息存储CommitLog</h1><blockquote><p>以下源码基于Rocket MQ 4.8.0</p></blockquote><h3 id=1-commitlog格式>1. CommitLog格式</h3><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/CommitLog%E8%AE%B0%E5%BD%95%E6%A0%BC%E5%BC%8F.png?raw=true" alt></p><h3 id=2-验证环境的准备>2. 验证环境的准备</h3><p>下载RocketMQ代码，然后选择对应的版本(4.8.0版本)，导入开发工具设置对应的启动参数如下图</p><p><img src="https://github.com/mxsm/picture/blob/main/rocketmq/broker%E5%90%AF%E5%8A%A8debug%E6%95%B0%E6%8D%AE.png?raw=true" alt></p><blockquote><p>这里的NameServer部署在自己本地的虚拟机</p></blockquote><p>然后就是本地 <strong><code>ROCKETMQ_HOME</code></strong> 地址：</p><p><img src="https://github.com/mxsm/picture/blob/main/rocketmq/RocketMQhome.png?raw=true" alt></p><p>这里配置就用从官网下载的启动文件夹里面的对应的就可以。最后就是用来验证的RocketMQ消息生产者的代码(同样代码来自官网)：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MQProducer</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#8f5902;font-style:italic>//代码来源地址： https://rocketmq.apache.org/docs/simple-example/
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>/* Instantiate with a producer group name. */</span>
        <span style=color:#000>DefaultMQProducer</span> <span style=color:#000>producer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span>
            <span style=color:#000>DefaultMQProducer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;please_rename_unique_group_name&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// Specify name server addresses.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>producer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setNamesrvAddr</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;192.168.31.49:9876&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>//Launch the instance.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>producer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//Create a message instance, specifying topic, tag and message body.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>Message</span> <span style=color:#000>msg</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Message</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;TopicTest&#34;</span> <span style=color:#8f5902;font-style:italic>/* Topic */</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#4e9a06>&#34;TagB&#34;</span> <span style=color:#8f5902;font-style:italic>/* Tag */</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Hello RocketMQ &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nanoTime</span><span style=color:#ce5c00;font-weight:700>()).</span><span style=color:#c4a000>getBytes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RemotingHelper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DEFAULT_CHARSET</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>/* Message body */</span>
            <span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>//Call send message to deliver message to one of brokers.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>SendResult</span> <span style=color:#000>sendResult</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>producer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>send</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;%s%n&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sendResult</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//Shut down once the producer instance is not longer in use.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>producer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shutdown</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=3-commitlog持久化过程>3. CommitLog持久化过程</h3><p>这里我们通过分析源码同时通过例子结合Debug来验证分析中的猜想看一下从生产者把数据提交到Broker然后如何写入到磁盘上的CommitLog文件中的。</p><p>首先Broker模块中BrokerStartup类作为主启动类：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>createBrokerController</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>));</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过调用 <strong><code>createBrokerController</code></strong> 方法来创建BrokerController。在 <strong><code>createBrokerController</code></strong> 方法中有一个有这样一段代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>BrokerController</span> <span style=color:#000>controller</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BrokerController</span><span style=color:#ce5c00;font-weight:700>(</span>
                <span style=color:#000>brokerConfig</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#000>nettyServerConfig</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#000>nettyClientConfig</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#000>messageStoreConfig</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// remember all configs to prevent discard
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>controller</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConfiguration</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>registerConfig</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>);</span>
			
            <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>initResult</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>controller</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>initialize</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div><p>通过 <strong><code>controller.initialize()</code></strong> 来对 <strong>BrokerController</strong> 来进行初始化。在初始的过程中，创建了用来处理处理生产者发送的MQ消息数据的类，这个类叫做 <strong><code>SendMessageProcessor</code></strong> 。这个类在 <strong>controller.initialize()</strong> 通过 <strong>BrokerController.registerProcessor</strong> 方法来注入。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>initialize</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>CloneNotSupportedException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    
    <span style=color:#8f5902;font-style:italic>//省略代码
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerProcessor</span><span style=color:#ce5c00;font-weight:700>();</span>
    
    <span style=color:#8f5902;font-style:italic>//省略代码
</span><span style=color:#8f5902;font-style:italic></span>    
<span style=color:#ce5c00;font-weight:700>}</span>


<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerProcessor</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>         * SendMessageProcessor
</span><span style=color:#8f5902;font-style:italic>         */</span>
        <span style=color:#000>SendMessageProcessor</span> <span style=color:#000>sendProcessor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SendMessageProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>sendProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerSendMessageHook</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sendMessageHookList</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>sendProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerConsumeMessageHook</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>consumeMessageHookList</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remotingServer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SEND_MESSAGE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sendProcessor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sendMessageExecutor</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remotingServer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SEND_MESSAGE_V2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sendProcessor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sendMessageExecutor</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remotingServer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SEND_BATCH_MESSAGE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sendProcessor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sendMessageExecutor</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remotingServer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONSUMER_SEND_MSG_BACK</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sendProcessor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sendMessageExecutor</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fastRemotingServer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SEND_MESSAGE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sendProcessor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sendMessageExecutor</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fastRemotingServer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SEND_MESSAGE_V2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sendProcessor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sendMessageExecutor</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fastRemotingServer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SEND_BATCH_MESSAGE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sendProcessor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sendMessageExecutor</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fastRemotingServer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONSUMER_SEND_MSG_BACK</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sendProcessor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sendMessageExecutor</span><span style=color:#ce5c00;font-weight:700>);</span>
 
 	<span style=color:#8f5902;font-style:italic>//后续代码省略
</span><span style=color:#8f5902;font-style:italic></span> <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>所以通过上面的分析处理消息主要是通过 <strong><code>SendMessageProcessor</code></strong> 来进行处理。下面来验证一下是不是会通过</p><p>接下来看一下 <strong><code>SendMessageProcessor</code></strong> 的源码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SendMessageProcessor</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractSendMessageProcessor</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>NettyRequestProcessor</span> <span style=color:#ce5c00;font-weight:700>{</span>
	
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>主要是通过继承 <strong>AbstractSendMessageProcessor</strong> 抽象类和实现 <strong>NettyRequestProcessor</strong> 两个接口。数据处理主要是通过实现 <strong><code>NettyRequestProcessor.processRequest</code></strong> 方法来处理各种不同类型的消息。看一下 <strong><code>SendMessageProcessor.processRequest</code></strong> 的实现：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>RemotingCommand</span> <span style=color:#000>processRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ChannelHandlerContext</span> <span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span>
                                          <span style=color:#000>RemotingCommand</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>RemotingCommandException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>RemotingCommand</span> <span style=color:#000>response</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>response</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>asyncProcessRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>ExecutionException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;process SendMessage error, request : &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote><p>两个参数：</p><ul><li>ctx ： netty的相关参数</li><li>request： 类型RemotingCommand，这个是RocketMQ的消息协议的抽象(rocketmq-模块设计的文章)</li></ul></blockquote><p>然后调用 <strong><code>asyncProcessRequest</code></strong> 来获取结果。接下来看一下这个方法的实现：</p><blockquote><p>注意： 从方法名称来看是一个异步的调用过程，但是通过等待返回值来达到一个同步的过程。其实在后台的很多实现都是异步调用，然后通过等待返回结果实现同步的过程。</p></blockquote><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>RemotingCommand</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>asyncProcessRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ChannelHandlerContext</span> <span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span>
                                                                  <span style=color:#000>RemotingCommand</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>RemotingCommandException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SendMessageContext</span> <span style=color:#000>mqtraceContext</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>switch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCode</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>///这个分支是消费失败将消息重新发回Broker才会走
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONSUMER_SEND_MSG_BACK</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>asyncConsumerSendMsgBack</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>default</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#000>SendMessageRequestHeader</span> <span style=color:#000>requestHeader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parseRequestHeader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>completedFuture</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#000>mqtraceContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>buildMsgContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#8f5902;font-style:italic>//SendMessageHook 接口的处理
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>executeSendMessageHookBefore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mqtraceContext</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isBatch</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>//批量消息处理
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>asyncSendBatchMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mqtraceContext</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>//单个消息处理
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>asyncSendMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mqtraceContext</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面处理数据就是两大类数据：</p><ul><li>消费失败的数据RequestCode.CONSUMER_SEND_MSG_BACK</li><li>生产者的发送数据，这个数据又包含两大类<ul><li>RequestCode.SEND_BATCH_MESSAGE 批量数据</li><li>RequestCode.SEND_MESSAGE_V2 和 RequestCode.SEND_MESSAGE 单个数据 (只是版本不一样)</li></ul></li></ul><p>所以上面主要有两类处理一个是单个消息 <strong><code>asyncSendMessage</code></strong> f方法和 <strong><code>asyncSendBatchMessage</code></strong> 处理批量发送的数据。这里只分析单个数据的存储(多个数据原理差不多)。</p><p><img src="https://github.com/mxsm/picture/blob/main/rocketmq/broker-commitlog.gif?raw=true" alt></p><p>首先是对数据进行处理和一些前期的校验如下代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>RemotingCommand</span> <span style=color:#000>response</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>preSend</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SendMessageResponseHeader</span> <span style=color:#000>responseHeader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SendMessageResponseHeader</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readCustomHeader</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>completedFuture</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>body</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBody</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>queueIdInt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueId</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>TopicConfig</span> <span style=color:#000>topicConfig</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopicConfigManager</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>selectTopicConfig</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>());</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>queueIdInt</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>queueIdInt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>randomQueueId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topicConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWriteQueueNums</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后构建 <strong><code>MessageExtBrokerInner</code></strong> 在Broker内部使用的对象类,这里主要是设置一些Broker的信息到消息中如下：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>MessageExtBrokerInner</span> <span style=color:#000>msgInner</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MessageExtBrokerInner</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTopic</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setQueueId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>queueIdInt</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>handleRetryAndDLQ</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>topicConfig</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>completedFuture</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBody</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>body</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setFlag</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getFlag</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>MessageAccessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MessageDecoder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>string2messageProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProperties</span><span style=color:#ce5c00;font-weight:700>()));</span>
        <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setPropertiesString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProperties</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBornTimestamp</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBornTimestamp</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBornHost</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>channel</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>remoteAddress</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setStoreHost</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStoreHost</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setReconsumeTimes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getReconsumeTimes</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getReconsumeTimes</span><span style=color:#ce5c00;font-weight:700>());</span>
</code></pre></div><p>然后就是存储消息处理：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PutMessageResult</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>putMessageResult</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>origProps</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MessageDecoder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>string2messageProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProperties</span><span style=color:#ce5c00;font-weight:700>());</span>
<span style=color:#000>String</span> <span style=color:#000>transFlag</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>origProps</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageConst</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PROPERTY_TRANSACTION_PREPARED</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#8f5902;font-style:italic>//判断是否为事务消息
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>transFlag</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseBoolean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>transFlag</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isRejectTransactionMessage</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NO_PERMISSION</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setRemark</span><span style=color:#ce5c00;font-weight:700>(</span>
                <span style=color:#4e9a06>&#34;the broker[&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getBrokerIP1</span><span style=color:#ce5c00;font-weight:700>()</span>
                        <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;] sending transaction message is forbidden&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>completedFuture</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>putMessageResult</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTransactionalMessageService</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>asyncPrepareMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>putMessageResult</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStore</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>asyncPutMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>handlePutMessageResultFuture</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>putMessageResult</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>responseHeader</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mqtraceContext</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>queueIdInt</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>这里有消息分为两种：</p><ul><li>事务消息(以后分析处理)</li><li>普通消息</li></ul><p><img src="https://github.com/mxsm/picture/blob/main/rocketmq/broker-commitlog-1.gif?raw=true" alt></p><blockquote><p>这里产生的是普通消息</p></blockquote><p>存储通过调用 <strong><code>MessageStore.asyncPutMessage</code></strong> 方法，而 <strong><code>MessageStore</code></strong> 的实现为 <strong>DefaultMessageStore</strong> 。 看一下 <strong><code>DefaultMessageStore.asyncPutMessage</code></strong> 实现：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PutMessageResult</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>asyncPutMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageExtBrokerInner</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#8f5902;font-style:italic>//检测存储状态
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>PutMessageStatus</span> <span style=color:#000>checkStoreStatus</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>checkStoreStatus</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>checkStoreStatus</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>PutMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PUT_OK</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>completedFuture</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PutMessageResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>checkStoreStatus</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>//校验消息的topic和Properties
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>PutMessageStatus</span> <span style=color:#000>msgCheckStatus</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>checkMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgCheckStatus</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>PutMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MESSAGE_ILLEGAL</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>completedFuture</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PutMessageResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgCheckStatus</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>beginTime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSystemClock</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>now</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>//消息处理
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PutMessageResult</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>putResultFuture</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>asyncPutMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#000>putResultFuture</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>thenAccept</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>elapsedTime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSystemClock</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>now</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>beginTime</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elapsedTime</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>500</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;putMessage not in lock elapsed time(ms)={}, bodyLength={}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>elapsedTime</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBody</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>storeStatsService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setPutMessageEntireTimeMax</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elapsedTime</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isOk</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>storeStatsService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPutMessageFailedTimes</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>incrementAndGet</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>});</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>putResultFuture</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过 <strong><code>CommitLog.asyncPutMessage</code></strong> 方法来持久化数据，在这个方法中主要主要做了三件事情：</p><ul><li><p>设置消息Body的CRC校验，后期读取数据要用到。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PutMessageResult</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>asyncPutMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MessageExtBrokerInner</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//设置存储的时间
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setStoreTimestamp</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#8f5902;font-style:italic>//设置CRC的校验值
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBodyCRC</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UtilAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>crc32</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBody</span><span style=color:#ce5c00;font-weight:700>()));</span>

    <span style=color:#8f5902;font-style:italic>// ..........省略代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li><li><p>延迟消息的处理</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PutMessageResult</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>asyncPutMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MessageExtBrokerInner</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>//省略代码
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tranType</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>MessageSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TRANSACTION_NOT_TYPE</span>
                <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>tranType</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>MessageSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TRANSACTION_COMMIT_TYPE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// Delay Delivery
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDelayTimeLevel</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDelayTimeLevel</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getScheduleMessageService</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getMaxDelayLevel</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setDelayTimeLevel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getScheduleMessageService</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getMaxDelayLevel</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#ce5c00;font-weight:700>}</span>

                <span style=color:#000>topic</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ScheduleMessageService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SCHEDULE_TOPIC</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>queueId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ScheduleMessageService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>delayLevel2QueueId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDelayTimeLevel</span><span style=color:#ce5c00;font-weight:700>());</span>

                <span style=color:#8f5902;font-style:italic>// Backup real topic, queueId
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>MessageAccessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MessageConst</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PROPERTY_REAL_TOPIC</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#000>MessageAccessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MessageConst</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PROPERTY_REAL_QUEUE_ID</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>valueOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueId</span><span style=color:#ce5c00;font-weight:700>()));</span>
                <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setPropertiesString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageDecoder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageProperties2String</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProperties</span><span style=color:#ce5c00;font-weight:700>()));</span>

                <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTopic</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setQueueId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>queueId</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>//省略代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这里是处理不同延迟等级的延迟消费消息的数据。</p></li><li><p>CommitLog的数据处理</p><p>message消息的处理也分为了三步：</p><ol><li><p>CommitLog的提交</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PutMessageResult</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>asyncPutMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MessageExtBrokerInner</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
     <span style=color:#8f5902;font-style:italic>//省略代码
</span><span style=color:#8f5902;font-style:italic></span>     <span style=color:#000>putMessageLock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lock</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//spin or ReentrantLock ,depending on store config
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>beginLockTimestamp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSystemClock</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>now</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beginTimeInLock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beginLockTimestamp</span><span style=color:#ce5c00;font-weight:700>;</span>

            <span style=color:#8f5902;font-style:italic>// Here settings are stored timestamp, in order to ensure an orderly
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// global
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setStoreTimestamp</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beginLockTimestamp</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>mappedFile</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>mappedFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isFull</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>mappedFile</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mappedFileQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLastMappedFile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// Mark: NewFile may be cause noise
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>mappedFile</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;create mapped file1 error, topic: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; clientAddr: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBornHostString</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#000>beginTimeInLock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>completedFuture</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PutMessageResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PutMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CREATE_MAPEDFILE_FAILED</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
           <span style=color:#8f5902;font-style:italic>//关键代码--添加CommitLog日志消息
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mappedFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>appendMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>appendMessageCallback</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>switch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStatus</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>PUT_OK</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>END_OF_FILE</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#000>unlockMappedFile</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mappedFile</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#8f5902;font-style:italic>// Create a new file, re-write the message
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>mappedFile</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mappedFileQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLastMappedFile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>mappedFile</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>// XXX: warn and notify me
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;create mapped file2 error, topic: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; clientAddr: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBornHostString</span><span style=color:#ce5c00;font-weight:700>());</span>
                        <span style=color:#000>beginTimeInLock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>completedFuture</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PutMessageResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PutMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CREATE_MAPEDFILE_FAILED</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>));</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mappedFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>appendMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>appendMessageCallback</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>MESSAGE_SIZE_EXCEEDED</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>PROPERTIES_SIZE_EXCEEDED</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#000>beginTimeInLock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>completedFuture</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PutMessageResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PutMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MESSAGE_ILLEGAL</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>));</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>UNKNOWN_ERROR</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#000>beginTimeInLock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>completedFuture</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PutMessageResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PutMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>UNKNOWN_ERROR</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>));</span>
                <span style=color:#204a87;font-weight:700>default</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#000>beginTimeInLock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>completedFuture</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PutMessageResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PutMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>UNKNOWN_ERROR</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#000>elapsedTimeInLock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSystemClock</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>now</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>beginLockTimestamp</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>beginTimeInLock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>putMessageLock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unlock</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
     <span style=color:#8f5902;font-style:italic>//省略代码
</span><span style=color:#8f5902;font-style:italic></span> <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li><li><p>CommitLog的刷盘(同步刷盘和异步刷盘两种)</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PutMessageStatus</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>flushResultFuture</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>submitFlushRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>putMessageResult</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PutMessageStatus</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>submitFlushRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AppendMessageResult</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>PutMessageResult</span> <span style=color:#000>putMessageResult</span><span style=color:#ce5c00;font-weight:700>,</span>
                                                                  <span style=color:#000>MessageExt</span> <span style=color:#000>messageExt</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 判断刷盘的方式---默认值为FlushDiskType.ASYNC_FLUSH 异步刷盘的方式
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>FlushDiskType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SYNC_FLUSH</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStoreConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getFlushDiskType</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>GroupCommitService</span> <span style=color:#000>service</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>GroupCommitService</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>flushCommitLogService</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>messageExt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isWaitStoreMsgOK</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>GroupCommitRequest</span> <span style=color:#000>request</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>GroupCommitRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWroteOffset</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWroteBytes</span><span style=color:#ce5c00;font-weight:700>(),</span>
                        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStoreConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getSyncFlushTimeout</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>future</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>completedFuture</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PutMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PUT_OK</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// Asynchronous flush
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStoreConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isTransientStorePoolEnable</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>flushCommitLogService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span>  <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>commitLogService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>completedFuture</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PutMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PUT_OK</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过配置文件可以配置刷盘的方式，默认的刷盘方式为异步刷盘方式(根据官网的说明如果使用防止消息的丢失可以使用同步刷盘方式但是同步刷盘会影响并发)。</p></li><li><p>提交给Slave同步(同步和异步两种)</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PutMessageStatus</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>replicaResultFuture</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>submitReplicaRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>putMessageResult</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PutMessageStatus</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>submitReplicaRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AppendMessageResult</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>PutMessageResult</span> <span style=color:#000>putMessageResult</span><span style=color:#ce5c00;font-weight:700>,</span>
                                                        <span style=color:#000>MessageExt</span> <span style=color:#000>messageExt</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
       <span style=color:#8f5902;font-style:italic>//默认的是BrokerRole.ASYNC_MASTER 所以也是异步的方式
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BrokerRole</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SYNC_MASTER</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStoreConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getBrokerRole</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>HAService</span> <span style=color:#000>service</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getHaService</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>messageExt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isWaitStoreMsgOK</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSlaveOK</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWroteBytes</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWroteOffset</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>GroupCommitRequest</span> <span style=color:#000>request</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>GroupCommitRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWroteOffset</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWroteBytes</span><span style=color:#ce5c00;font-weight:700>(),</span>
                            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStoreConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getSyncFlushTimeout</span><span style=color:#ce5c00;font-weight:700>());</span>
                    <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWaitNotifyObject</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>wakeupAll</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>future</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>completedFuture</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PutMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SLAVE_NOT_AVAILABLE</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>completedFuture</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PutMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PUT_OK</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li></ol></li></ul><p>上面可以通过官网的一个图片来说明这两种情况：</p><p><img src=https://github.com/apache/rocketmq/raw/master/docs/cn/image/rocketmq_design_2.png alt></p><p>通过上面的代码分析可以知道主要是通过：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mappedFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>appendMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>appendMessageCallback</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>这段代码把message持久化，在RocketMQ的所有的文件都是通过 <strong><code>MappedFile</code></strong> 包装进行处理的。下面来看一下 <strong><code>MappedFile.appendMessage</code></strong> 方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>AppendMessageResult</span> <span style=color:#000>appendMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MessageExtBrokerInner</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>AppendMessageCallback</span> <span style=color:#000>cb</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>appendMessagesInner</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cb</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong><code>appendMessage</code></strong> 方法调用了 <strong><code>MappedFile.appendMessagesInner</code></strong> 的内部方法。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>AppendMessageResult</span> <span style=color:#000>appendMessagesInner</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MessageExt</span> <span style=color:#000>messageExt</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>AppendMessageCallback</span> <span style=color:#000>cb</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>assert</span> <span style=color:#000>messageExt</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>assert</span> <span style=color:#000>cb</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>currentPos</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wrotePosition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#8f5902;font-style:italic>//当前偏移量和文件大小做比较
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentPos</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fileSize</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>ByteBuffer</span> <span style=color:#000>byteBuffer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>writeBuffer</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>writeBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>slice</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mappedByteBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>slice</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>byteBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>position</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentPos</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>AppendMessageResult</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>//同样这里区分了处理批量消息和单个消息
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>messageExt</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>MessageExtBrokerInner</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cb</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doAppend</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getFileFromOffset</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>byteBuffer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fileSize</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>currentPos</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageExtBrokerInner</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>messageExt</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>messageExt</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>MessageExtBatch</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cb</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doAppend</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getFileFromOffset</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>byteBuffer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fileSize</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>currentPos</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageExtBatch</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>messageExt</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AppendMessageResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AppendMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>UNKNOWN_ERROR</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wrotePosition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAndGet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWroteBytes</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>storeTimestamp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStoreTimestamp</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;MappedFile.appendMessage return null, wrotePosition: {} fileSize: {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>currentPos</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fileSize</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AppendMessageResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AppendMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>UNKNOWN_ERROR</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过代码发现代码里面通过调用 <strong><code>AppendMessageCallback.doAppend</code></strong> 来处理数据， 在 <strong><code>CommitLog</code></strong> 类**<code>AppendMessageCallback</code>** 中有一个 的内部类的实现 **<code>DefaultAppendMessageCallback</code>** 。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>AppendMessageResult</span> <span style=color:#000>doAppend</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>fileFromOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ByteBuffer</span> <span style=color:#000>byteBuffer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>maxBlank</span><span style=color:#ce5c00;font-weight:700>,</span>
            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MessageExtBrokerInner</span> <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// STORETIMESTAMP + STOREHOSTADDRESS + OFFSET &lt;br&gt;
</span><span style=color:#8f5902;font-style:italic></span>
            <span style=color:#8f5902;font-style:italic>// PHY OFFSET
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>wroteOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>fileFromOffset</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>byteBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>position</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>sysflag</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSysFlag</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>bornHostLength</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sysflag</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>MessageSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>BORNHOST_V6_FLAG</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>4</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>4</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>16</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>storeHostLength</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sysflag</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>MessageSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>STOREHOSTADDRESS_V6_FLAG</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>4</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>4</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>16</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>ByteBuffer</span> <span style=color:#000>bornHostHolder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ByteBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allocate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bornHostLength</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>ByteBuffer</span> <span style=color:#000>storeHostHolder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ByteBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allocate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>storeHostLength</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resetByteBuffer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>storeHostHolder</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>storeHostLength</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>String</span> <span style=color:#000>msgId</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>sysflag</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>MessageSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>STOREHOSTADDRESS_V6_FLAG</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>msgId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MessageDecoder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createMessageId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgIdMemory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStoreHostBytes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>storeHostHolder</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>wroteOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>msgId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MessageDecoder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createMessageId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgIdV6Memory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStoreHostBytes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>storeHostHolder</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>wroteOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>// Record ConsumeQueue information
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>keyBuilder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setLength</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>keyBuilder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#000>keyBuilder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;-&#39;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>keyBuilder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueId</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#000>String</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>keyBuilder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>Long</span> <span style=color:#000>queueOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>CommitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>topicQueueTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>queueOffset</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>queueOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0L</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>CommitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>topicQueueTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>queueOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>// Transaction messages that require special handling
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>tranType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MessageSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTransactionValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSysFlag</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#204a87;font-weight:700>switch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tranType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// Prepared and Rollback message is not consumed, will not enter the
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// consumer queuec
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>MessageSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TRANSACTION_PREPARED_TYPE</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>MessageSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TRANSACTION_ROLLBACK_TYPE</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#000>queueOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0L</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>MessageSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TRANSACTION_NOT_TYPE</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>MessageSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TRANSACTION_COMMIT_TYPE</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>default</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>             * Serialize message
</span><span style=color:#8f5902;font-style:italic>             */</span>
            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>propertiesData</span> <span style=color:#ce5c00;font-weight:700>=</span>
                <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPropertiesString</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPropertiesString</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getBytes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageDecoder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CHARSET_UTF8</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>propertiesLength</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>propertiesData</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>propertiesData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertiesLength</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Short</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MAX_VALUE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;putMessage message properties length too long. length={}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>propertiesData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AppendMessageResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AppendMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PROPERTIES_SIZE_EXCEEDED</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>topicData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getBytes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageDecoder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CHARSET_UTF8</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>topicLength</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>topicData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span>

            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>bodyLength</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBody</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBody</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span>

            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>msgLen</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>calMsgLength</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSysFlag</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>bodyLength</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>topicLength</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>propertiesLength</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#8f5902;font-style:italic>// Exceeds the maximum message
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgLen</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>maxMessageSize</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>CommitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;message size exceeded, msg total size: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>msgLen</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;, msg body size: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>bodyLength</span>
                    <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;, maxMessageSize: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>maxMessageSize</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AppendMessageResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AppendMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MESSAGE_SIZE_EXCEEDED</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>// Determines whether there is sufficient free space
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>msgLen</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>END_FILE_MIN_BLANK_LENGTH</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>maxBlank</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resetByteBuffer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>maxBlank</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#8f5902;font-style:italic>// 1 TOTALSIZE
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>maxBlank</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#8f5902;font-style:italic>// 2 MAGICCODE
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CommitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>BLANK_MAGIC_CODE</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#8f5902;font-style:italic>// 3 The remaining space may be any value
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// Here the length of the specially set maxBlank
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>beginTimeMills</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>CommitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>now</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#000>byteBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>array</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>maxBlank</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AppendMessageResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AppendMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>END_OF_FILE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>wroteOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>maxBlank</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>msgId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStoreTimestamp</span><span style=color:#ce5c00;font-weight:700>(),</span>
                    <span style=color:#000>queueOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CommitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>now</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>beginTimeMills</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>// Initialization of storage space
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resetByteBuffer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>msgLen</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 1 TOTALSIZE
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgLen</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 2 MAGICCODE
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CommitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MESSAGE_MAGIC_CODE</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 3 BODYCRC
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBodyCRC</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#8f5902;font-style:italic>// 4 QUEUEID
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueId</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#8f5902;font-style:italic>// 5 FLAG
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getFlag</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#8f5902;font-style:italic>// 6 QUEUEOFFSET
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putLong</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>queueOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 7 PHYSICALOFFSET
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putLong</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fileFromOffset</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>byteBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>position</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#8f5902;font-style:italic>// 8 SYSFLAG
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSysFlag</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#8f5902;font-style:italic>// 9 BORNTIMESTAMP
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putLong</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBornTimestamp</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#8f5902;font-style:italic>// 10 BORNHOST
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resetByteBuffer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bornHostHolder</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bornHostLength</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBornHostBytes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bornHostHolder</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#8f5902;font-style:italic>// 11 STORETIMESTAMP
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putLong</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStoreTimestamp</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#8f5902;font-style:italic>// 12 STOREHOSTADDRESS
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resetByteBuffer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>storeHostHolder</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>storeHostLength</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStoreHostBytes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>storeHostHolder</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#8f5902;font-style:italic>// 13 RECONSUMETIMES
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getReconsumeTimes</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#8f5902;font-style:italic>// 14 Prepared Transaction Offset
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putLong</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPreparedTransactionOffset</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#8f5902;font-style:italic>// 15 BODY
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bodyLength</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bodyLength</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBody</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#8f5902;font-style:italic>// 16 TOPIC
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>topicLength</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topicData</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 17 PROPERTIES
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putShort</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#204a87;font-weight:700>short</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>propertiesLength</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertiesLength</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertiesData</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>beginTimeMills</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>CommitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>now</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#8f5902;font-style:italic>// Write messages to the queue buffer
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>byteBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>msgStoreItemMemory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>array</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>msgLen</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#000>AppendMessageResult</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AppendMessageResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AppendMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PUT_OK</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>wroteOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>msgLen</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>msgId</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#000>msgInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStoreTimestamp</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>queueOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CommitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>now</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>beginTimeMills</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#204a87;font-weight:700>switch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tranType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>MessageSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TRANSACTION_PREPARED_TYPE</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>MessageSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TRANSACTION_ROLLBACK_TYPE</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>MessageSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TRANSACTION_NOT_TYPE</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>MessageSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TRANSACTION_COMMIT_TYPE</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#8f5902;font-style:italic>// The next update ConsumeQueue information
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>CommitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>topicQueueTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>queueOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>default</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这个方法讲解CommitLog的整个数据组装。</p><p><img src="https://github.com/mxsm/picture/blob/main/rocketmq/broker-commitlog-2.gif?raw=true" alt></p><h3 id=4-commitlog持久化过程中的重要类>4. CommitLog持久化过程中的重要类</h3><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/RocketMQLevel.png?raw=true" alt></p><p>以上的图片说明了RocketMQ的不同分层的。</p><h4 id=41-commitlog>4.1 CommitLog</h4><p>对CommitLog日志的抽象和处理类</p><h4 id=42-mappedfilequeue>4.2 MappedFileQueue</h4><p>映射的文件队列，用来处理文件映射的队列数据。比如CommitLog日志文件</p><h4 id=43-mappedfile>4.3 MappedFile</h4><p>大文件的磁盘操作</p><h3 id=5-commitlog数据读取验证>5. CommitLog数据读取验证</h3><p>发送消息的代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MQProducer</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>/* Instantiate with a producer group name. */</span>
        <span style=color:#000>DefaultMQProducer</span> <span style=color:#000>producer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span>
            <span style=color:#000>DefaultMQProducer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;please_rename_unique_group_name&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// Specify name server addresses.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>producer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setNamesrvAddr</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;192.168.31.49:9876&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>//Launch the instance.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>producer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//Create a message instance, specifying topic, tag and message body.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>String</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Hello RocketMQ &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nanoTime</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>Message</span> <span style=color:#000>msg</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Message</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;TopicTest&#34;</span> <span style=color:#8f5902;font-style:italic>/* Topic */</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#4e9a06>&#34;TagB&#34;</span> <span style=color:#8f5902;font-style:italic>/* Tag */</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBytes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RemotingHelper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DEFAULT_CHARSET</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>/* Message body */</span>
            <span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>//Call send message to deliver message to one of brokers.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>SendResult</span> <span style=color:#000>sendResult</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>producer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>send</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;%s%n&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sendResult</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//Shut down once the producer instance is not longer in use.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>producer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shutdown</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div><p>发送到MQ的消息如下图：</p><p><img src="https://github.com/mxsm/picture/blob/main/rocketmq/%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8%E6%89%93%E5%8D%B0%E5%AD%98%E5%82%A8%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE.png?raw=true" alt></p><p>然后再Broker存储的时候增加日志打印如下图：</p><p><img src="https://github.com/mxsm/picture/blob/main/rocketmq/%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8%E6%89%93%E5%8D%B0%E5%AD%98%E5%82%A8.png?raw=true" alt></p><p><img src="https://github.com/mxsm/picture/blob/main/rocketmq/broker%E6%89%93%E5%8D%B0%E5%AD%98%E5%82%A8%E7%9A%84%E9%95%BF%E5%BA%A6.png?raw=true" alt></p><p>然后通过代码解析数据：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MappedFile</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>{</span>

     
        <span style=color:#000>File</span> <span style=color:#000>file</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>File</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;C:\\Users\\mxsm\\store\\commitlog\\00000000000000000000&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>RandomAccessFile</span> <span style=color:#000>randomAccessFile</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RandomAccessFile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>file</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;rw&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>FileChannel</span> <span style=color:#000>channel</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>randomAccessFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChannel</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>MappedByteBuffer</span> <span style=color:#000>map</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MapMode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>READ_WRITE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>file</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>totalSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInt</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>// 1 TOTALSIZE
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;TOTALSIZE:&#34;</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>totalSize</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>bytes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>totalSize</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bytes</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>ByteBuffer</span> <span style=color:#000>wrap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ByteBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wrap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bytes</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>msgLen</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>4</span> <span style=color:#8f5902;font-style:italic>//MAGICCODE
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>4</span> <span style=color:#8f5902;font-style:italic>//BODYCRC
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>4</span> <span style=color:#8f5902;font-style:italic>//QUEUEID
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>4</span> <span style=color:#8f5902;font-style:italic>//FLAG
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>8</span> <span style=color:#8f5902;font-style:italic>//QUEUEOFFSET
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>8</span> <span style=color:#8f5902;font-style:italic>//PHYSICALOFFSET
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>4</span> <span style=color:#8f5902;font-style:italic>//SYSFLAG
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>8</span> <span style=color:#8f5902;font-style:italic>//BORNTIMESTAMP
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>8</span> <span style=color:#8f5902;font-style:italic>//BORNHOST
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>8</span> <span style=color:#8f5902;font-style:italic>//STORETIMESTAMP
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>8</span> <span style=color:#8f5902;font-style:italic>//STOREHOSTADDRESS
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>4</span> <span style=color:#8f5902;font-style:italic>//RECONSUMETIMES
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>8</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//Prepared Transaction Offset
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>//获取Body的长度
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>bytes1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#000>wrap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>position</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msgLen</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>wrap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bytes1</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>anInt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ByteBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wrap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bytes1</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getInt</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>bodyBytes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>anInt</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#000>wrap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bodyBytes</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>bodyBytes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>//打印Body
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bodyBytes</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><img src="https://github.com/mxsm/picture/blob/main/rocketmq/commitlog%E8%A7%A3%E6%9E%90%E5%90%8E%E7%9A%84%E6%95%B0%E6%8D%AE.png?raw=true" alt></p></div><div class=td-content style=page-break-before:always><h1 id=pg-5ef930f71905a5f352f4de5310e3a582>5 - RocketMQ源码解析-Broker消息存储ConsumeQueue</h1><blockquote><p>以下源码基于Rocket MQ 4.7.0</p></blockquote><h3 id=1-consumequeue格式>1. ConsumeQueue格式</h3><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/ConsumeQueue.png?raw=true" alt></p><p>在之前就分析过，每一条ConsumeQueue数据是定长的20bytes，然后每一个文件存储30w条数据。存储是按照topic和queueId进行分类存储。那么ConsumeQueue的作用：</p><ul><li>前8个byte保存了CommitLog的偏移量，根据这个偏移量能够找到该条消息的CommitLog文件所在的位置</li><li>中间的四个字节保存了消息大小根据前面的八个字节就能随机读出消息。</li><li>最后八个字节用于处理消费者tag的过滤</li></ul><p>这里我们只分析ConsumeQueue文件的生成过程，其他的会在后续的其他文章中分析</p><h3 id=2-consumequeue持久化过程>2. ConsumeQueue持久化过程</h3><p>ConsumeQueue持久化也是RocketMQ三大持久化之一，所以通过源码分析找到，ConsumeQueue持久化是用过一个 <strong><code>ReputMessageService</code></strong> 来提供持久化服务，这个类是 <strong><code>ReputMessageService</code></strong> 类中的一个内部类:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ReputMessageService</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ServiceThread</span> <span style=color:#ce5c00;font-weight:700>{</span>

     <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>reputFromOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#8f5902;font-style:italic>//省略代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>继承了RocketMQ自定义的 <strong><code>ServiceThread</code></strong> 服务线程。所以个服务就是个线程。看一下Run方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getServiceName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; service started&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isStopped</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doReput</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getServiceName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; service has exception. &#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getServiceName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; service end&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>主要是通过调用doReput方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>doReput</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//获取读取数据的位置--默认是从0开始，对于运行一段时间的系统会进行设置
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reputFromOffset</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMinOffset</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The reputFromOffset={} is smaller than minPyOffset={}, this usually indicate that the dispatch behind too much and the commitlog has expired.&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reputFromOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMinOffset</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reputFromOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMinOffset</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>doNext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isCommitLogAvailable</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>doNext</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStoreConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isDuplicationEnable</span><span style=color:#ce5c00;font-weight:700>()</span>
                    <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reputFromOffset</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConfirmOffset</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#8f5902;font-style:italic>//获取CommitLog中可以使用的数据结果
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>SelectMappedBufferResult</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getData</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>reputFromOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reputFromOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStartOffset</span><span style=color:#ce5c00;font-weight:700>();</span>

                        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>readSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>readSize</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSize</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>doNext</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
							<span style=color:#8f5902;font-style:italic>//获取一条CommitLog数据出来
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#000>DispatchRequest</span> <span style=color:#000>dispatchRequest</span> <span style=color:#ce5c00;font-weight:700>=</span>
                                <span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>checkMessageAndReturnSize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getByteBuffer</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
									
                            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBufferSize</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgSize</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBufferSize</span><span style=color:#ce5c00;font-weight:700>();</span>
							
                            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSuccess</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
									<span style=color:#8f5902;font-style:italic>//调用处理数据生成ConsumeQueue
</span><span style=color:#8f5902;font-style:italic></span>                                    <span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doDispatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>);</span>

									<span style=color:#8f5902;font-style:italic>//对于Broker Master进行处理
</span><span style=color:#8f5902;font-style:italic></span>                                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BrokerRole</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SLAVE</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStoreConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getBrokerRole</span><span style=color:#ce5c00;font-weight:700>()</span>
                                        <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isLongPollingEnable</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                        <span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageArrivingListener</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>arriving</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span>
                                            <span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueId</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumeQueueOffset</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>,</span>
                                            <span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTagsCode</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStoreTimestamp</span><span style=color:#ce5c00;font-weight:700>(),</span>
                                            <span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBitMap</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPropertiesMap</span><span style=color:#ce5c00;font-weight:700>());</span>
                                    <span style=color:#ce5c00;font-weight:700>}</span>
									<span style=color:#8f5902;font-style:italic>//向前推进offset
</span><span style=color:#8f5902;font-style:italic></span>                                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reputFromOffset</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>;</span>
                                    <span style=color:#000>readSize</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>;</span>
                                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStoreConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getBrokerRole</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>BrokerRole</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SLAVE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                        <span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>storeStatsService</span>
                                            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSinglePutMessageTopicTimesTotal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>()).</span><span style=color:#c4a000>incrementAndGet</span><span style=color:#ce5c00;font-weight:700>();</span>
                                        <span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>storeStatsService</span>
                                            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSinglePutMessageTopicSizeTotal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>())</span>
                                            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAndGet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgSize</span><span style=color:#ce5c00;font-weight:700>());</span>
                                    <span style=color:#ce5c00;font-weight:700>}</span>
                                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
									<span style=color:#8f5902;font-style:italic>//读取下一个文件
</span><span style=color:#8f5902;font-style:italic></span>                                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reputFromOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rollNextFile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reputFromOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
                                    <span style=color:#000>readSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSize</span><span style=color:#ce5c00;font-weight:700>();</span>
                                <span style=color:#ce5c00;font-weight:700>}</span>
                            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSuccess</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>

                                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[BUG]read total count not equals msg total size. reputFromOffset={}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>reputFromOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
                                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reputFromOffset</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>;</span>
                                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                    <span style=color:#000>doNext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
                                    <span style=color:#8f5902;font-style:italic>// If user open the dledger pattern or the broker is master node,
</span><span style=color:#8f5902;font-style:italic></span>                                    <span style=color:#8f5902;font-style:italic>// it will not ignore the exception and fix the reputFromOffset variable
</span><span style=color:#8f5902;font-style:italic></span>                                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStoreConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isEnableDLegerCommitLog</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>||</span>
                                        <span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerId</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>MixAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MASTER_ID</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[BUG]dispatch message to consume queue error, COMMITLOG OFFSET: {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                                            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reputFromOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
                                        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reputFromOffset</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSize</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>readSize</span><span style=color:#ce5c00;font-weight:700>;</span>
                                    <span style=color:#ce5c00;font-weight:700>}</span>
                                <span style=color:#ce5c00;font-weight:700>}</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>release</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>doNext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ol><li>读取CommitLog中当前次数能够处理的数据。(数据可能在不同的文件中)</li><li>循环处理当前批次的数据将数据转换为 <strong><code>DispatchRequest</code></strong></li><li>通过 <strong><code>DefaultMessageStore.doDispatch</code></strong> 去分发 <strong><code>DispatchReques</code></strong> t数据</li></ol><p>下面来看一下 <strong><code>DefaultMessageStore.doDispatch</code></strong> 方法是如何对数据进行分发的：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>doDispatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DispatchRequest</span> <span style=color:#000>req</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CommitLogDispatcher</span> <span style=color:#000>dispatcher</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dispatcherList</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>dispatcher</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dispatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>req</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过这里可以看出来有一个 <strong><code>CommitLogDispatcher</code></strong> 接口, 这里其实就分别处理来生成 ConsumeQueue和IndexFile两种文件。</p><blockquote><p><strong><code>CommitLogDispatcher</code></strong> 在RocketMQ中有三种实现：</p><ol><li>CommitLogDispatcherBuildConsumeQueue &ndash; 处理ConsumeQueue的生成</li><li>CommitLogDispatcherBuildIndex &ndash; 处理IndexFile的生成</li><li>CommitLogDispatcherCalcBitMap &ndash; 处理计算bit Map</li></ol></blockquote><p>下面来看一下CommitLogDispatcherBuildConsumeQueue的实现：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>CommitLogDispatcherBuildConsumeQueue</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>CommitLogDispatcher</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>dispatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DispatchRequest</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>tranType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MessageSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTransactionValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSysFlag</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#204a87;font-weight:700>switch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tranType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>MessageSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TRANSACTION_NOT_TYPE</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>MessageSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TRANSACTION_COMMIT_TYPE</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putMessagePositionInfo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>MessageSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TRANSACTION_PREPARED_TYPE</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>MessageSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TRANSACTION_ROLLBACK_TYPE</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这里TRANSACTION_PREPARED_TYPE和TRANSACTION_ROLLBACK_TYPE这两种数据类型不需要处理。数据处理只要是通过 <strong><code>DefaultMessageStore.this.putMessagePositionInfo(request)</code></strong> 这段代码处理。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>putMessagePositionInfo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DispatchRequest</span> <span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>ConsumeQueue</span> <span style=color:#000>cq</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findConsumeQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueId</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>cq</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putMessagePositionInfoWrapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过topic和queueId找到对应的ConsumeQueue。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>putMessagePositionInfoWrapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DispatchRequest</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>maxRetries</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>30</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>canWrite</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRunningFlags</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isCQWriteable</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>maxRetries</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>canWrite</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>tagsCode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTagsCode</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isExtWriteEnable</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>ConsumeQueueExt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CqExtUnit</span> <span style=color:#000>cqExtUnit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConsumeQueueExt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CqExtUnit</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#000>cqExtUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setFilterBitMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBitMap</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#000>cqExtUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setMsgStoreTime</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStoreTimestamp</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#000>cqExtUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTagsCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTagsCode</span><span style=color:#ce5c00;font-weight:700>());</span>

                <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>extAddr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumeQueueExt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cqExtUnit</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isExtAddr</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>extAddr</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>tagsCode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>extAddr</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Save consume queue extend fail, So just save tagsCode! {}, topic:{}, queueId:{}, offset:{}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cqExtUnit</span><span style=color:#ce5c00;font-weight:700>,</span>
                        <span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>queueId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCommitLogOffset</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putMessagePositionInfo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCommitLogOffset</span><span style=color:#ce5c00;font-weight:700>(),</span>
                <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgSize</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>tagsCode</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumeQueueOffset</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStoreConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getBrokerRole</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>BrokerRole</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SLAVE</span> <span style=color:#ce5c00;font-weight:700>||</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStoreConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isEnableDLegerCommitLog</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStoreCheckpoint</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>setPhysicMsgTimestamp</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStoreTimestamp</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStoreCheckpoint</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>setLogicsMsgTimestamp</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStoreTimestamp</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// XXX: warn and notify me
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[BUG]put commit log position info to &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>topic</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;:&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>queueId</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCommitLogOffset</span><span style=color:#ce5c00;font-weight:700>()</span>
                    <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; failed, retry &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; times&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1000</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// XXX: warn and notify me
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[BUG]consume queue can not write, {} {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>queueId</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRunningFlags</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>makeLogicsQueueError</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面代码通过处理 <strong><code>putMessagePositionInfo</code></strong> 方法处理数据：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>putMessagePositionInfo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>tagsCode</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>cqOffset</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>maxPhysicOffset</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Maybe try to build consume queue repeatedly maxPhysicOffset={} phyOffset={}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>maxPhysicOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>byteBufferIndex</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>flip</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>byteBufferIndex</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>limit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CQ_STORE_UNIT_SIZE</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>byteBufferIndex</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putLong</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>byteBufferIndex</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>byteBufferIndex</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putLong</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tagsCode</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>expectLogicOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cqOffset</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>CQ_STORE_UNIT_SIZE</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#000>MappedFile</span> <span style=color:#000>mappedFile</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mappedFileQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLastMappedFile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expectLogicOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mappedFile</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mappedFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isFirstCreateInQueue</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>cqOffset</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>mappedFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWrotePosition</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>minLogicOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>expectLogicOffset</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mappedFileQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setFlushedWhere</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expectLogicOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mappedFileQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCommittedWhere</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expectLogicOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fillPreBlank</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mappedFile</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>expectLogicOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;fill pre blank space &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>mappedFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getFileName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>expectLogicOffset</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; &#34;</span>
                    <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>mappedFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWrotePosition</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cqOffset</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>currentLogicOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mappedFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWrotePosition</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>mappedFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getFileFromOffset</span><span style=color:#ce5c00;font-weight:700>();</span>

                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expectLogicOffset</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>currentLogicOffset</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Build  consume queue repeatedly, expectLogicOffset: {} currentLogicOffset: {} Topic: {} QID: {} Diff: {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                        <span style=color:#000>expectLogicOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>currentLogicOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>queueId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>expectLogicOffset</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>currentLogicOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>

                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expectLogicOffset</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>currentLogicOffset</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>LOG_ERROR</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span>
                        <span style=color:#4e9a06>&#34;[BUG]logic queue order maybe wrong, expectLogicOffset: {} currentLogicOffset: {} Topic: {} QID: {} Diff: {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                        <span style=color:#000>expectLogicOffset</span><span style=color:#ce5c00;font-weight:700>,</span>
                        <span style=color:#000>currentLogicOffset</span><span style=color:#ce5c00;font-weight:700>,</span>
                        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>topic</span><span style=color:#ce5c00;font-weight:700>,</span>
                        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>queueId</span><span style=color:#ce5c00;font-weight:700>,</span>
                        <span style=color:#000>expectLogicOffset</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>currentLogicOffset</span>
                    <span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>maxPhysicOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>mappedFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>appendMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>byteBufferIndex</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>array</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>后续的数据其实和CommitLog的数据差不多，都是通过MappedFile进行数据落地。</p><h3 id=3-总结>3. 总结</h3><p>总结一下ConsumeQueue生成的过程：</p><ol><li>启动一个ReputMessageService服务线程</li><li>然后根据reputFromOffset去读取本次的CommitLog数据（没有或者有）</li><li>将每条数据包装为DispatchRequest</li><li>DefaultMessageStore.doDispatch的方法进行处理数据，内部主要是通过CommitLogDispatcher的实现来进行处理</li><li>生成完ConsumeQueue纪录后的后续处理</li><li>重复2-4的步骤</li></ol><blockquote><p>每次处理完成一轮后会睡1毫秒的时间。并不是消息生成端发送了消息消费端就能够里面消费数据，而是要经过处理后生成ConsumeQueue才能消费。</p></blockquote><p>上面说了能够消费的数据需要将CommitLog转化成为ConsumeQueue才能进行消费下面就来看一下，进行验证，将 <strong>ReputMessageService</strong> 的睡眠时间改为一分钟代码如下：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getServiceName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; service started&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isStopped</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//Thread.sleep(1);
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//将睡眠时间改为1分钟
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MINUTES</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doReput</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getServiceName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; service has exception. &#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#000>DefaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getServiceName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; service end&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>启动修改后的MQ Broker。</p><p><img src="https://github.com/mxsm/picture/blob/main/rocketmq/ConsumeQueue%E7%9D%A1%E7%9C%A0%E6%97%B6%E9%97%B4%E4%BF%AE%E6%94%B9.gif?raw=true" alt></p><p>然后启动消费者，同时用生产者发送消息：</p><p><img src="https://github.com/mxsm/picture/blob/main/rocketmq/ConsumeQueue%E7%9D%A1%E7%9C%A0%E6%97%B6%E9%97%B4%E4%BF%AE%E6%94%B9-1.gif?raw=true" alt></p><p>看一下两个时间的间隔：</p><p>1623405444983(发送时间)=2021-06-11 17:57:24</p><p>1623405552338(消费时间)=2021-06-11 17:59:12</p><p>通过两个时间发现不是立马进行消费。所以验证了前面的猜测。</p><p><strong>每次处理完成一轮后会睡1毫秒的时间。并不是消息生成端发送了消息消费端就能够里面消费数据，而是要经过处理后生成ConsumeQueue才能消费。</strong></p></div><div class=td-content style=page-break-before:always><h1 id=pg-dfb0d002a8796933e78fa9fb8fb118e1>6 - RocketMQ源码解析-Broker接收拉取消息</h1><blockquote><p>以下源码基于Rocket MQ 4.7.0</p></blockquote><p>引言：Broker对于不同消息有不同的NettyRequestProcessor，对于DefaultMQPushConsumer的pull请求对应的Processor为PullMessageProcessor。</p><h3 id=pullmessageprocessor>PullMessageProcessor</h3><p>通过上面的分析可以知道，处理DefaultMQPushConsumer的pull请求主要是通过 <strong><code>PullMessageProcessor.processRequest</code></strong> 方法来实现的：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param channel
</span><span style=color:#8f5902;font-style:italic>     * @param request 请求的command
</span><span style=color:#8f5902;font-style:italic>     * @param brokerAllowSuspend 是否允许挂起
</span><span style=color:#8f5902;font-style:italic>     * @return
</span><span style=color:#8f5902;font-style:italic>     * @throws RemotingCommandException
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>RemotingCommand</span> <span style=color:#000>processRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Channel</span> <span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RemotingCommand</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>brokerAllowSuspend</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>RemotingCommandException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>RemotingCommand</span> <span style=color:#000>response</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RemotingCommand</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createResponseCommand</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PullMessageResponseHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PullMessageResponseHeader</span> <span style=color:#000>responseHeader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PullMessageResponseHeader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readCustomHeader</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PullMessageRequestHeader</span> <span style=color:#000>requestHeader</span> <span style=color:#ce5c00;font-weight:700>=</span>
            <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PullMessageRequestHeader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>decodeCommandCustomHeader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PullMessageRequestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setOpaque</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOpaque</span><span style=color:#ce5c00;font-weight:700>());</span>

        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;receive PullMessage request command, {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#8f5902;font-style:italic>//判断Broker是否可读
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>PermName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isReadable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getBrokerPermission</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NO_PERMISSION</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setRemark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>format</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;the broker[%s] pulling message is forbidden&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getBrokerIP1</span><span style=color:#ce5c00;font-weight:700>()));</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// 判断consumerGroup是否存在-如果不存在判断是否允许自动创建，可以自动创建就直接创建消费者组(权限控制)
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>SubscriptionGroupConfig</span> <span style=color:#000>subscriptionGroupConfig</span> <span style=color:#ce5c00;font-weight:700>=</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSubscriptionGroupManager</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>findSubscriptionGroupConfig</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>subscriptionGroupConfig</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SUBSCRIPTION_GROUP_NOT_EXIST</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setRemark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>format</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;subscription group [%s] does not exist, %s&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>FAQUrl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>suggestTodo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>FAQUrl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SUBSCRIPTION_GROUP_NOT_EXIST</span><span style=color:#ce5c00;font-weight:700>)));</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// 判断consumerGroup的消费状态是否Enable
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>subscriptionGroupConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isConsumeEnable</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NO_PERMISSION</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setRemark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;subscription group no permission, &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>hasSuspendFlag</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PullSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasSuspendFlag</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSysFlag</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>hasCommitOffsetFlag</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PullSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasCommitOffsetFlag</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSysFlag</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>hasSubscriptionFlag</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PullSysFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasSubscriptionFlag</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSysFlag</span><span style=color:#ce5c00;font-weight:700>());</span>

        <span style=color:#8f5902;font-style:italic>//获取挂起超时时间
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>suspendTimeoutMillisLong</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>hasSuspendFlag</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSuspendTimeoutMillis</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#8f5902;font-style:italic>//判断主题配置是否为空
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>TopicConfig</span> <span style=color:#000>topicConfig</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopicConfigManager</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>selectTopicConfig</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>topicConfig</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;the topic {} not exist, consumer: {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>RemotingHelper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseChannelRemoteAddr</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TOPIC_NOT_EXIST</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setRemark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>format</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;topic[%s] not exist, apply first please! %s&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>FAQUrl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>suggestTodo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>FAQUrl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>APPLY_TOPIC_URL</span><span style=color:#ce5c00;font-weight:700>)));</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>//判断主题是否可读
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>PermName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isReadable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topicConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPerm</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NO_PERMISSION</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setRemark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;the topic[&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;] pulling message is forbidden&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>//判断请求消息队列ID是否合法
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueId</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueId</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>topicConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getReadQueueNums</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>String</span> <span style=color:#000>errorInfo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>format</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;queueId[%d] is illegal, topic:[%s] topicConfig.readQueueNums:[%d] consumer:[%s]&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueId</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>topicConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getReadQueueNums</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remoteAddress</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>errorInfo</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SYSTEM_ERROR</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setRemark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>errorInfo</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#000>SubscriptionData</span> <span style=color:#000>subscriptionData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>ConsumerFilterData</span> <span style=color:#000>consumerFilterData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#8f5902;font-style:italic>// 有设置subscribe flag,表示第一次pull或者需要更新filter
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasSubscriptionFlag</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 获得订阅信息，用于过滤消息
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>subscriptionData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>FilterAPI</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>build</span><span style=color:#ce5c00;font-weight:700>(</span>
                    <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSubscription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getExpressionType</span><span style=color:#ce5c00;font-weight:700>()</span>
                <span style=color:#ce5c00;font-weight:700>);</span>

                <span style=color:#8f5902;font-style:italic>// 是否使用了表达式过滤
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>ExpressionType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTagType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>subscriptionData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getExpressionType</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>consumerFilterData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ConsumerFilterManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>build</span><span style=color:#ce5c00;font-weight:700>(</span>
                        <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSubscription</span><span style=color:#ce5c00;font-weight:700>(),</span>
                        <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getExpressionType</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSubVersion</span><span style=color:#ce5c00;font-weight:700>()</span>
                    <span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>assert</span> <span style=color:#000>consumerFilterData</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Parse the consumer&#39;s subscription[{}] failed, group: {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSubscription</span><span style=color:#ce5c00;font-weight:700>(),</span>
                    <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SUBSCRIPTION_PARSE_FAILED</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setRemark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;parse the consumer&#39;s subscription failed&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 没有设置subscribe flag，表示之前已经订阅过了,对比订阅条件是否一致
</span><span style=color:#8f5902;font-style:italic></span>
            <span style=color:#8f5902;font-style:italic>// 对于同一个ConsumerGroup下的多个consumer客户端，Broker要求订阅参数设置必须要是一致的，要不然会造成数据混乱
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>ConsumerGroupInfo</span> <span style=color:#000>consumerGroupInfo</span> <span style=color:#ce5c00;font-weight:700>=</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerManager</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getConsumerGroupInfo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>consumerGroupInfo</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;the consumer&#39;s group info not exist, group: {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SUBSCRIPTION_NOT_EXIST</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setRemark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;the consumer&#39;s group info not exist&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>FAQUrl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>suggestTodo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>FAQUrl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SAME_GROUP_DIFFERENT_TOPIC</span><span style=color:#ce5c00;font-weight:700>));</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>subscriptionGroupConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isConsumeBroadcastEnable</span><span style=color:#ce5c00;font-weight:700>()</span>
                <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>consumerGroupInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageModel</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>MessageModel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>BROADCASTING</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NO_PERMISSION</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setRemark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;the consumer group[&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;] can not consume by broadcast way&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#000>subscriptionData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>consumerGroupInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findSubscriptionData</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>subscriptionData</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;the consumer&#39;s subscription not exist, group: {}, topic:{}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SUBSCRIPTION_NOT_EXIST</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setRemark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;the consumer&#39;s subscription not exist&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>FAQUrl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>suggestTodo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>FAQUrl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SAME_GROUP_DIFFERENT_TOPIC</span><span style=color:#ce5c00;font-weight:700>));</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>subscriptionData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSubVersion</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSubVersion</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The broker&#39;s subscription is not latest, group: {} {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(),</span>
                    <span style=color:#000>subscriptionData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSubString</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SUBSCRIPTION_NOT_LATEST</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setRemark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;the consumer&#39;s subscription not latest&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>ExpressionType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTagType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>subscriptionData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getExpressionType</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>consumerFilterData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerFilterManager</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span>
                    <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>consumerFilterData</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>FILTER_DATA_NOT_EXIST</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setRemark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The broker&#39;s consumer filter data is not exist!Your expression may be wrong!&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>consumerFilterData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClientVersion</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSubVersion</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The broker&#39;s consumer filter data is not latest, group: {}, topic: {}, serverV: {}, clientV: {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                        <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>consumerFilterData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClientVersion</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSubVersion</span><span style=color:#ce5c00;font-weight:700>());</span>
                    <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>FILTER_DATA_NOT_LATEST</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setRemark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;the consumer&#39;s consumer filter data not latest&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>ExpressionType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTagType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>subscriptionData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getExpressionType</span><span style=color:#ce5c00;font-weight:700>())</span>
            <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isEnablePropertyFilter</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SYSTEM_ERROR</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setRemark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The broker does not support consumer to filter message by &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>subscriptionData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getExpressionType</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>//创建消息过滤器
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>MessageFilter</span> <span style=color:#000>messageFilter</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isFilterSupportRetry</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>messageFilter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ExpressionForRetryMessageFilter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>subscriptionData</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>consumerFilterData</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerFilterManager</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>messageFilter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ExpressionMessageFilter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>subscriptionData</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>consumerFilterData</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerFilterManager</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>//读取消息
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>GetMessageResult</span> <span style=color:#000>getMessageResult</span> <span style=color:#ce5c00;font-weight:700>=</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStore</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span>
                <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueId</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueOffset</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMaxMsgNums</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>messageFilter</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getMessageResult</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setRemark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getMessageResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStatus</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>name</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#000>responseHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setNextBeginOffset</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getMessageResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNextBeginOffset</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#000>responseHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setMinOffset</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getMessageResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMinOffset</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#000>responseHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setMaxOffset</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getMessageResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMaxOffset</span><span style=color:#ce5c00;font-weight:700>());</span>

            <span style=color:#8f5902;font-style:italic>//判断是否建议从slave读取数据---默认为false
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getMessageResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSuggestPullingFromSlave</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>responseHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSuggestWhichBrokerId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>subscriptionGroupConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWhichBrokerWhenConsumeSlowly</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>responseHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSuggestWhichBrokerId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MixAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MASTER_ID</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#204a87;font-weight:700>switch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStoreConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getBrokerRole</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>ASYNC_MASTER</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>SYNC_MASTER</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>SLAVE</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#8f5902;font-style:italic>// 如果当前broker是slave，并且不支持read，则提示客户端从master读
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isSlaveReadEnable</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PULL_RETRY_IMMEDIATELY</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#000>responseHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSuggestWhichBrokerId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MixAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MASTER_ID</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isSlaveReadEnable</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 消费太慢重定向到另外一台机器消费
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getMessageResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSuggestPullingFromSlave</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>responseHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSuggestWhichBrokerId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>subscriptionGroupConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWhichBrokerWhenConsumeSlowly</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#8f5902;font-style:italic>// consume ok
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>responseHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSuggestWhichBrokerId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>subscriptionGroupConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerId</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>responseHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSuggestWhichBrokerId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MixAll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MASTER_ID</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>//将读取的消息状态转换为Response的状态code
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>switch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getMessageResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStatus</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>FOUND</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SUCCESS</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>MESSAGE_WAS_REMOVING</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PULL_RETRY_IMMEDIATELY</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>NO_MATCHED_LOGIC_QUEUE</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>NO_MESSAGE_IN_QUEUE</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueOffset</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PULL_OFFSET_MOVED</span><span style=color:#ce5c00;font-weight:700>);</span>

                        <span style=color:#8f5902;font-style:italic>// XXX: warn and notify me
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;the broker store no queue data, fix the request offset {} to {}, Topic: {} QueueId: {} Consumer Group: {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                            <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueOffset</span><span style=color:#ce5c00;font-weight:700>(),</span>
                            <span style=color:#000>getMessageResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNextBeginOffset</span><span style=color:#ce5c00;font-weight:700>(),</span>
                            <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span>
                            <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueId</span><span style=color:#ce5c00;font-weight:700>(),</span>
                            <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>()</span>
                        <span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PULL_NOT_FOUND</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>NO_MATCHED_MESSAGE</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PULL_RETRY_IMMEDIATELY</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>OFFSET_FOUND_NULL</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PULL_NOT_FOUND</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>OFFSET_OVERFLOW_BADLY</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PULL_OFFSET_MOVED</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#8f5902;font-style:italic>// XXX: warn and notify me
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;the request offset: {} over flow badly, broker max offset: {}, consumer: {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                        <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueOffset</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>getMessageResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMaxOffset</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remoteAddress</span><span style=color:#ce5c00;font-weight:700>());</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>OFFSET_OVERFLOW_ONE</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PULL_NOT_FOUND</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>OFFSET_TOO_SMALL</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PULL_OFFSET_MOVED</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;the request offset too small. group={}, topic={}, requestOffset={}, brokerMinOffset={}, clientIp={}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                        <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueOffset</span><span style=color:#ce5c00;font-weight:700>(),</span>
                        <span style=color:#000>getMessageResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMinOffset</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remoteAddress</span><span style=color:#ce5c00;font-weight:700>());</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>default</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#204a87;font-weight:700>assert</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasConsumeMessageHook</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>ConsumeMessageContext</span> <span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConsumeMessageContext</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTopic</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setQueueId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueId</span><span style=color:#ce5c00;font-weight:700>());</span>

                <span style=color:#000>String</span> <span style=color:#000>owner</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getExtFields</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BrokerStatsManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>COMMERCIAL_OWNER</span><span style=color:#ce5c00;font-weight:700>);</span>

                <span style=color:#204a87;font-weight:700>switch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCode</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SUCCESS</span><span style=color:#ce5c00;font-weight:700>:</span>
                        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>commercialBaseCount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getCommercialBaseCount</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>incValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getMessageResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgCount4Commercial</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>commercialBaseCount</span><span style=color:#ce5c00;font-weight:700>;</span>

                        <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCommercialRcvStats</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BrokerStatsManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>StatsType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RCV_SUCCESS</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCommercialRcvTimes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>incValue</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCommercialRcvSize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getMessageResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBufferTotalSize</span><span style=color:#ce5c00;font-weight:700>());</span>
                        <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCommercialOwner</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>owner</span><span style=color:#ce5c00;font-weight:700>);</span>

                        <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PULL_NOT_FOUND</span><span style=color:#ce5c00;font-weight:700>:</span>
                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>brokerAllowSuspend</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

                            <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCommercialRcvStats</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BrokerStatsManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>StatsType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RCV_EPOLLS</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCommercialRcvTimes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCommercialOwner</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>owner</span><span style=color:#ce5c00;font-weight:700>);</span>

                        <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PULL_RETRY_IMMEDIATELY</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PULL_OFFSET_MOVED</span><span style=color:#ce5c00;font-weight:700>:</span>
                        <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCommercialRcvStats</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BrokerStatsManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>StatsType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RCV_EPOLLS</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCommercialRcvTimes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCommercialOwner</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>owner</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>default</span><span style=color:#ce5c00;font-weight:700>:</span>
                        <span style=color:#204a87;font-weight:700>assert</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>

                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>executeConsumeMessageHookBefore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>//进一步处理返回的结果
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>switch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCode</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SUCCESS</span><span style=color:#ce5c00;font-weight:700>:</span>

                    <span style=color:#8f5902;font-style:italic>//更新topic获取的消息数量信息
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerStatsManager</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>incGroupGetNums</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span>
                        <span style=color:#000>getMessageResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageCount</span><span style=color:#ce5c00;font-weight:700>());</span>

                    <span style=color:#8f5902;font-style:italic>//更新统计的消息大小
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerStatsManager</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>incGroupGetSize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span>
                        <span style=color:#000>getMessageResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBufferTotalSize</span><span style=color:#ce5c00;font-weight:700>());</span>

                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerStatsManager</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>incBrokerGetNums</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getMessageResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageCount</span><span style=color:#ce5c00;font-weight:700>());</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isTransferMsgByHeap</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>beginTimeMills</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStore</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>now</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readGetMessageResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getMessageResult</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueId</span><span style=color:#ce5c00;font-weight:700>());</span>
                        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerStatsManager</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>incGroupGetLatency</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(),</span>
                            <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueId</span><span style=color:#ce5c00;font-weight:700>(),</span>
                            <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStore</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>now</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>beginTimeMills</span><span style=color:#ce5c00;font-weight:700>));</span>
                        <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBody</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>FileRegion</span> <span style=color:#000>fileRegion</span> <span style=color:#ce5c00;font-weight:700>=</span>
                                <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ManyMessageTransfer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>encodeHeader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getMessageResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBufferTotalSize</span><span style=color:#ce5c00;font-weight:700>()),</span> <span style=color:#000>getMessageResult</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>writeAndFlush</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fileRegion</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>addListener</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ChannelFutureListener</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#5c35cc;font-weight:700>@Override</span>
                                <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>operationComplete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ChannelFuture</span> <span style=color:#000>future</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                    <span style=color:#000>getMessageResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>release</span><span style=color:#ce5c00;font-weight:700>();</span>
                                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSuccess</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;transfer many message by pagecache failed, {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remoteAddress</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cause</span><span style=color:#ce5c00;font-weight:700>());</span>
                                    <span style=color:#ce5c00;font-weight:700>}</span>
                                <span style=color:#ce5c00;font-weight:700>}</span>
                            <span style=color:#ce5c00;font-weight:700>});</span>
                        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;transfer many message by pagecache exception&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#000>getMessageResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>release</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>

                        <span style=color:#000>response</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>

                <span style=color:#8f5902;font-style:italic>//没有读取到消息，则hold住请求，有新消息时唤醒
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>//等待超时后还是没读到brokerAllowSuspend=false
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PULL_NOT_FOUND</span><span style=color:#ce5c00;font-weight:700>:</span>

                    <span style=color:#8f5902;font-style:italic>//brokerAllowSuspend=ture 方法传入
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>brokerAllowSuspend</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>hasSuspendFlag</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>pollingTimeMills</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>suspendTimeoutMillisLong</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isLongPollingEnable</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>pollingTimeMills</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getShortPollingTimeMills</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>

                        <span style=color:#000>String</span> <span style=color:#000>topic</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueOffset</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>queueId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueId</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#000>PullRequest</span> <span style=color:#000>pullRequest</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PullRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pollingTimeMills</span><span style=color:#ce5c00;font-weight:700>,</span>
                            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStore</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>now</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>subscriptionData</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>messageFilter</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPullRequestHoldService</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>suspendPullRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>queueId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#000>response</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>

                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PULL_RETRY_IMMEDIATELY</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#8f5902;font-style:italic>// 消费开始的offset不正确
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PULL_OFFSET_MOVED</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStoreConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getBrokerRole</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>BrokerRole</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SLAVE</span>
                        <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStoreConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isOffsetCheckInSlave</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>MessageQueue</span> <span style=color:#000>mq</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MessageQueue</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTopic</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>());</span>
                        <span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setQueueId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueId</span><span style=color:#ce5c00;font-weight:700>());</span>
                        <span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBrokerName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getBrokerName</span><span style=color:#ce5c00;font-weight:700>());</span>

                        <span style=color:#000>OffsetMovedEvent</span> <span style=color:#000>event</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>OffsetMovedEvent</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#000>event</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>());</span>
                        <span style=color:#000>event</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setMessageQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mq</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#000>event</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setOffsetRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueOffset</span><span style=color:#ce5c00;font-weight:700>());</span>
                        <span style=color:#000>event</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setOffsetNew</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getMessageResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNextBeginOffset</span><span style=color:#ce5c00;font-weight:700>());</span>
                        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>generateOffsetMovedEvent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>event</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span>
                            <span style=color:#4e9a06>&#34;PULL_OFFSET_MOVED:correction offset. topic={}, groupId={}, requestOffset={}, newOffset={}, suggestBrokerId={}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                            <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>event</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOffsetRequest</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>event</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOffsetNew</span><span style=color:#ce5c00;font-weight:700>(),</span>
                            <span style=color:#000>responseHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSuggestWhichBrokerId</span><span style=color:#ce5c00;font-weight:700>());</span>
                    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>responseHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSuggestWhichBrokerId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>subscriptionGroupConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerId</span><span style=color:#ce5c00;font-weight:700>());</span>
                        <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PULL_RETRY_IMMEDIATELY</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;PULL_OFFSET_MOVED:none correction. topic={}, groupId={}, requestOffset={}, suggestBrokerId={}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                            <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueOffset</span><span style=color:#ce5c00;font-weight:700>(),</span>
                            <span style=color:#000>responseHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSuggestWhichBrokerId</span><span style=color:#ce5c00;font-weight:700>());</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>

                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>default</span><span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#204a87;font-weight:700>assert</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SYSTEM_ERROR</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setRemark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;store getMessage return null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>storeOffsetEnable</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>brokerAllowSuspend</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>storeOffsetEnable</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>storeOffsetEnable</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>hasCommitOffsetFlag</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>storeOffsetEnable</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>storeOffsetEnable</span>
            <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStoreConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getBrokerRole</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>BrokerRole</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SLAVE</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>storeOffsetEnable</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//持久化储存offerSet
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerOffsetManager</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>commitOffset</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RemotingHelper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseChannelRemoteAddr</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>),</span>
                <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConsumerGroup</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueId</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCommitOffset</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从上面的分析可以知道：根据 <strong><code>Topic、queueId、offfset</code></strong> 以及过滤器从 <strong><code>MessageStore</code></strong> 获取消息。如果成功获取到消息根据配置有两种返回的方式：</p><ol><li><code>ByteBuffer</code>中将数据读取到response中（经过堆）</li><li>netty直接读取<code>ByteBuffer</code>，将消息写给客户端</li></ol><h3 id=defaultmessagestoregetmessage>DefaultMessageStore.getMessage</h3><p>下面来看一下这个方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>GetMessageResult</span> <span style=color:#000>getMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>group</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>queueId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>maxMsgNums</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MessageFilter</span> <span style=color:#000>messageFilter</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shutdown</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;message store has shutdown, so getMessage is forbidden&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>runningFlags</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isReadable</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;message store is not readable, so getMessage is forbidden &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>runningFlags</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getFlagBits</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>beginTime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSystemClock</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>now</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#000>GetMessageStatus</span> <span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>GetMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NO_MESSAGE_IN_QUEUE</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>nextBeginOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>minOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>maxOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#000>GetMessageResult</span> <span style=color:#000>getResult</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>GetMessageResult</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>maxOffsetPy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMaxOffset</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#8f5902;font-style:italic>//找到对应的消费队列
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>ConsumeQueue</span> <span style=color:#000>consumeQueue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>findConsumeQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>queueId</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>consumeQueue</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>minOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>consumeQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMinOffsetInQueue</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>maxOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>consumeQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMaxOffsetInQueue</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>maxOffset</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>GetMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NO_MESSAGE_IN_QUEUE</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>nextBeginOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nextOffsetCorrection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>minOffset</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>GetMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>OFFSET_TOO_SMALL</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>nextBeginOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nextOffsetCorrection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>minOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>maxOffset</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>GetMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>OFFSET_OVERFLOW_ONE</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>nextBeginOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nextOffsetCorrection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>maxOffset</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>GetMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>OFFSET_OVERFLOW_BADLY</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>minOffset</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>nextBeginOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nextOffsetCorrection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>minOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>nextBeginOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nextOffsetCorrection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>maxOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>SelectMappedBufferResult</span> <span style=color:#000>bufferConsumeQueue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>consumeQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getIndexBuffer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bufferConsumeQueue</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>GetMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NO_MATCHED_MESSAGE</span><span style=color:#ce5c00;font-weight:700>;</span>

                        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>nextPhyFileStartOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MIN_VALUE</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>maxPhyOffsetPulling</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>

                        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>maxFilterMessageCount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>max</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>16000</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>maxMsgNums</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>ConsumeQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CQ_STORE_UNIT_SIZE</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>diskFallRecorded</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageStoreConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDiskFallRecorded</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#000>ConsumeQueueExt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CqExtUnit</span> <span style=color:#000>cqExtUnit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConsumeQueueExt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CqExtUnit</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>bufferConsumeQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSize</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>maxFilterMessageCount</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>ConsumeQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CQ_STORE_UNIT_SIZE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>offsetPy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bufferConsumeQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getByteBuffer</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getLong</span><span style=color:#ce5c00;font-weight:700>();</span>
                            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>sizePy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bufferConsumeQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getByteBuffer</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getInt</span><span style=color:#ce5c00;font-weight:700>();</span>
                            <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>tagsCode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bufferConsumeQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getByteBuffer</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getLong</span><span style=color:#ce5c00;font-weight:700>();</span>

                            <span style=color:#000>maxPhyOffsetPulling</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>offsetPy</span><span style=color:#ce5c00;font-weight:700>;</span>

                            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nextPhyFileStartOffset</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MIN_VALUE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offsetPy</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>nextPhyFileStartOffset</span><span style=color:#ce5c00;font-weight:700>)</span>
                                    <span style=color:#204a87;font-weight:700>continue</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>

                            <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isInDisk</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>checkInDiskByCommitOffset</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offsetPy</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>maxOffsetPy</span><span style=color:#ce5c00;font-weight:700>);</span>

                            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTheBatchFull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sizePy</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>maxMsgNums</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBufferTotalSize</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>getResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageCount</span><span style=color:#ce5c00;font-weight:700>(),</span>
                                <span style=color:#000>isInDisk</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>

                            <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>extRet</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>isTagsCodeLegal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>consumeQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isExtAddr</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tagsCode</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#000>extRet</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>consumeQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getExt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tagsCode</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cqExtUnit</span><span style=color:#ce5c00;font-weight:700>);</span>
                                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>extRet</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                    <span style=color:#000>tagsCode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cqExtUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTagsCode</span><span style=color:#ce5c00;font-weight:700>();</span>
                                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                    <span style=color:#8f5902;font-style:italic>// can&#39;t find ext content.Client will filter messages by tag also.
</span><span style=color:#8f5902;font-style:italic></span>                                    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[BUG] can&#39;t find consume queue extend file content!addr={}, offsetPy={}, sizePy={}, topic={}, group={}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                                        <span style=color:#000>tagsCode</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>offsetPy</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sizePy</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>group</span><span style=color:#ce5c00;font-weight:700>);</span>
                                    <span style=color:#000>isTagsCodeLegal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
                                <span style=color:#ce5c00;font-weight:700>}</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>

                            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>messageFilter</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span>
                                <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>messageFilter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isMatchedByConsumeQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isTagsCodeLegal</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>tagsCode</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>extRet</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>cqExtUnit</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBufferTotalSize</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                    <span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>GetMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NO_MATCHED_MESSAGE</span><span style=color:#ce5c00;font-weight:700>;</span>
                                <span style=color:#ce5c00;font-weight:700>}</span>

                                <span style=color:#204a87;font-weight:700>continue</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>

                            <span style=color:#000>SelectMappedBufferResult</span> <span style=color:#000>selectResult</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offsetPy</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sizePy</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>selectResult</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBufferTotalSize</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                    <span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>GetMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MESSAGE_WAS_REMOVING</span><span style=color:#ce5c00;font-weight:700>;</span>
                                <span style=color:#ce5c00;font-weight:700>}</span>

                                <span style=color:#000>nextPhyFileStartOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rollNextFile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offsetPy</span><span style=color:#ce5c00;font-weight:700>);</span>
                                <span style=color:#204a87;font-weight:700>continue</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>

                            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>messageFilter</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span>
                                <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>messageFilter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isMatchedByCommitLog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>selectResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getByteBuffer</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>slice</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBufferTotalSize</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                    <span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>GetMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NO_MATCHED_MESSAGE</span><span style=color:#ce5c00;font-weight:700>;</span>
                                <span style=color:#ce5c00;font-weight:700>}</span>
                                <span style=color:#8f5902;font-style:italic>// release...
</span><span style=color:#8f5902;font-style:italic></span>                                <span style=color:#000>selectResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>release</span><span style=color:#ce5c00;font-weight:700>();</span>
                                <span style=color:#204a87;font-weight:700>continue</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>

                            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>storeStatsService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getGetMessageTransferedMsgCount</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>incrementAndGet</span><span style=color:#ce5c00;font-weight:700>();</span>
                            <span style=color:#000>getResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>selectResult</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>GetMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>FOUND</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#000>nextPhyFileStartOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MIN_VALUE</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>

                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>diskFallRecorded</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>fallBehind</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>maxOffsetPy</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>maxPhyOffsetPulling</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#000>brokerStatsManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>recordDiskFallBehindSize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>group</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>queueId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>fallBehind</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>

                        <span style=color:#000>nextBeginOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>ConsumeQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CQ_STORE_UNIT_SIZE</span><span style=color:#ce5c00;font-weight:700>);</span>

                        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>diff</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>maxOffsetPy</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>maxPhyOffsetPulling</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>memory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StoreUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TOTAL_PHYSICAL_MEMORY_SIZE</span>
                            <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageStoreConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAccessMessageInMemoryMaxRatio</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>100</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>0</span><span style=color:#ce5c00;font-weight:700>));</span>
                        <span style=color:#000>getResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSuggestPullingFromSlave</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>diff</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>memory</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>

                        <span style=color:#000>bufferConsumeQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>release</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>GetMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>OFFSET_FOUND_NULL</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#000>nextBeginOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nextOffsetCorrection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>consumeQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rollNextFile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>));</span>
                    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;consumer request topic: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>topic</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;offset: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; minOffset: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>minOffset</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; maxOffset: &#34;</span>
                        <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>maxOffset</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;, but access logic queue failed.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>GetMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NO_MATCHED_LOGIC_QUEUE</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>nextBeginOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nextOffsetCorrection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>GetMessageStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>FOUND</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>status</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>storeStatsService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getGetMessageTimesTotalFound</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>incrementAndGet</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>storeStatsService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getGetMessageTimesTotalMiss</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>incrementAndGet</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>elapsedTime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSystemClock</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>now</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>beginTime</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>storeStatsService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setGetMessageEntireTimeMax</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elapsedTime</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#000>getResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setStatus</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>status</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>getResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setNextBeginOffset</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nextBeginOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>getResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setMaxOffset</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>maxOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>getResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setMinOffset</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>minOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getResult</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>首先根据topic和queueId找到对应的ConsumeQueue。然后找到对应的MappedFile获取对应数量的数据，然后根据tag进行过滤出来对应的数据。</p><h3 id=挂起请求处理>挂起请求处理</h3><p>之前PullRequest请求处理中有这样一段代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>ResponseCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PULL_NOT_FOUND</span><span style=color:#ce5c00;font-weight:700>:</span>

                    <span style=color:#8f5902;font-style:italic>//brokerAllowSuspend=ture 方法传入
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>brokerAllowSuspend</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>hasSuspendFlag</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>pollingTimeMills</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>suspendTimeoutMillisLong</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isLongPollingEnable</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>pollingTimeMills</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getShortPollingTimeMills</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>

                        <span style=color:#000>String</span> <span style=color:#000>topic</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueOffset</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>queueId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>requestHeader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueId</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#000>PullRequest</span> <span style=color:#000>pullRequest</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PullRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pollingTimeMills</span><span style=color:#ce5c00;font-weight:700>,</span>
                            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStore</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>now</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>subscriptionData</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>messageFilter</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPullRequestHoldService</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>suspendPullRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>queueId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#000>response</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这段代码就是在没有找到Message的时候去挂起请求，通过PullRequestHoldService#suspendPullRequest来挂起请求：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>suspendPullRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>queueId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PullRequest</span> <span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>String</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>buildKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>queueId</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>ManyPullRequest</span> <span style=color:#000>mpr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pullRequestTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>mpr</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>mpr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ManyPullRequest</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>ManyPullRequest</span> <span style=color:#000>prev</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pullRequestTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putIfAbsent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mpr</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prev</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>mpr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>prev</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#000>mpr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addPullRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pullRequest</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>我们是不是在BrokerController启动中看到了PullRequestHoldService(继承ServiceThread)被启动了，所以我们应该去看看PullRequestHoldService做了什么，所以首先去看他的run方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;{} service started&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getServiceName</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isStopped</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>//是否开启了长轮询
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isLongPollingEnable</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>//长轮询等待5s
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>waitForRunning</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>5</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>1000</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                   <span style=color:#8f5902;font-style:italic>//短轮询等待1s this.waitForRunning(this.brokerController.getBrokerConfig().getShortPollingTimeMills());
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#ce5c00;font-weight:700>}</span>

                <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>beginLockTimestamp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>systemClock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>now</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#8f5902;font-style:italic>//检查挂起的请求
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>checkHoldRequest</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>costTime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>systemClock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>now</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>beginLockTimestamp</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>costTime</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>5</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>1000</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[NOTIFYME] check hold request cost {} ms.&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>costTime</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getServiceName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; service has exception. &#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;{} service end&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getServiceName</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过调用 <strong><code>PullRequestHoldService#checkHoldRequest</code></strong> 方法来检查保存在这个里面的数据：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>checkHoldRequest</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pullRequestTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>keySet</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>kArray</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>split</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TOPIC_QUEUEID_SEPARATOR</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>2</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>kArray</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>String</span> <span style=color:#000>topic</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>kArray</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>];</span>
                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>queueId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>kArray</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>]);</span>
                <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStore</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getMaxOffsetInQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>queueId</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>//五秒钟通知一次
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>notifyMessageArriving</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>queueId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;check hold request failed. topic={}, queueId={}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>queueId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>看一下 <strong><code>PullRequestHoldService#notifyMessageArriving</code></strong> 方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>notifyMessageArriving</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>queueId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>maxOffset</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>notifyMessageArriving</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>queueId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>maxOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>notifyMessageArriving</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>queueId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>maxOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Long</span> <span style=color:#000>tagsCode</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>msgStoreTime</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>filterBitMap</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>String</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>buildKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>queueId</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>ManyPullRequest</span> <span style=color:#000>mpr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pullRequestTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mpr</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PullRequest</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>requestList</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mpr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cloneListAndClear</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestList</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PullRequest</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>replayList</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PullRequest</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>

                <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PullRequest</span> <span style=color:#000>request</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>requestList</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>newestOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>maxOffset</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>newestOffset</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPullFromThisOffset</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>newestOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStore</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getMaxOffsetInQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>queueId</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>

                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>newestOffset</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPullFromThisOffset</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>match</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageFilter</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isMatchedByConsumeQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tagsCode</span><span style=color:#ce5c00;font-weight:700>,</span>
                            <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConsumeQueueExt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CqExtUnit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tagsCode</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>msgStoreTime</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>filterBitMap</span><span style=color:#ce5c00;font-weight:700>));</span>
                        <span style=color:#8f5902;font-style:italic>// match by bit map, need eval again when properties is not null.
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>match</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>properties</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>match</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageFilter</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isMatchedByCommitLog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>

                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>match</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPullMessageProcessor</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>executeRequestWhenWakeup</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClientChannel</span><span style=color:#ce5c00;font-weight:700>(),</span>
                                    <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRequestCommand</span><span style=color:#ce5c00;font-weight:700>());</span>
                            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;execute request when wakeup failed.&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>
                            <span style=color:#204a87;font-weight:700>continue</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>

                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSuspendTimestamp</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTimeoutMillis</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPullMessageProcessor</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>executeRequestWhenWakeup</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClientChannel</span><span style=color:#ce5c00;font-weight:700>(),</span>
                                <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRequestCommand</span><span style=color:#ce5c00;font-weight:700>());</span>
                        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;execute request when wakeup failed.&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#204a87;font-weight:700>continue</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>

                    <span style=color:#000>replayList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>

                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>replayList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>mpr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addPullRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>replayList</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过 <strong><code>PullMessageProcessor#executeRequestWhenWakeup</code></strong> 来处理数据。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>executeRequestWhenWakeup</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Channel</span> <span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>RemotingCommand</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>RemotingCommandException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Runnable</span> <span style=color:#000>run</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>RemotingCommand</span> <span style=color:#000>response</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PullMessageProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>processRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>

                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>response</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setOpaque</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOpaque</span><span style=color:#ce5c00;font-weight:700>());</span>
                        <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>markResponseType</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>writeAndFlush</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>addListener</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ChannelFutureListener</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#5c35cc;font-weight:700>@Override</span>
                                <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>operationComplete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ChannelFuture</span> <span style=color:#000>future</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSuccess</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;processRequestWrapper response to {} failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                                            <span style=color:#000>future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>channel</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>remoteAddress</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cause</span><span style=color:#ce5c00;font-weight:700>());</span>
                                        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>());</span>
                                        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>());</span>
                                    <span style=color:#ce5c00;font-weight:700>}</span>
                                <span style=color:#ce5c00;font-weight:700>}</span>
                            <span style=color:#ce5c00;font-weight:700>});</span>
                        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;processRequestWrapper process request over, but response failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>());</span>
                            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>());</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RemotingCommandException</span> <span style=color:#000>e1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;excuteRequestWhenWakeup run&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e1</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>};</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPullMessageExecutor</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>submit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RequestTask</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>最终还是通过 <strong><code>PullMessageProcessor#processRequest</code></strong> 这个方法来处理数据，但是这里的brokerAllowSuspend=false意思就是只会挂起一次，不会无限制的挂起这个请求在没有消息来的时候。到这里就Broker接收完了</p></div><div class=td-content style=page-break-before:always><h1 id=pg-4d09b652a4bc68f5db4484f96fa278db>7 - RocketMQ源码解析-Broker故障恢复</h1><blockquote><p>以下源码基于Rocket MQ 4.7.0</p></blockquote><p>RocketMQ正常退出或者异常退出的时候，如果重新启动那么怎么恢复数据。接下来通过代码来分析这个过程。</p><h3 id=1broker故障恢复>1.Broker故障恢复</h3><p>在broker第一次启动或者重新启动的时候会调用这样的一段代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//BrokerController#initialize 中的方法
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>initialize</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>CloneNotSupportedException</span> <span style=color:#ce5c00;font-weight:700>{</span>
     <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>load</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从上面的代码可以知道，在broker进行初始的时候，会 <strong><code>MessageStore#load</code></strong> 方法，这个方法的默认实现为 <strong>DefaultMessageStore</strong> 。接下来看一下 load方法这里就是Broker恢复的入口：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>load</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//通过判断abort文件是否存在来判断是否正常退出
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>lastExitOK</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTempFileExist</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>scheduleMessageService</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>//解析延迟的等级-可以自己配置
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scheduleMessageService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>load</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>// 加载CommitLog
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>load</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#8f5902;font-style:italic>//加载ConsumeQueue
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>loadConsumeQueue</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>storeCheckpoint</span> <span style=color:#ce5c00;font-weight:700>=</span>
                    <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StoreCheckpoint</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StorePathConfigHelper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStoreCheckpoint</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageStoreConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStorePathRootDir</span><span style=color:#ce5c00;font-weight:700>()));</span>

                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>indexService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>load</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lastExitOK</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#8f5902;font-style:italic>//恢复入口
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>recover</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lastExitOK</span><span style=color:#ce5c00;font-weight:700>);</span>

                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMaxPhyOffset</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allocateMappedFileService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shutdown</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过上面的代码可以知道恢复是通过 <strong><code>recover</code></strong> 方法来处理。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>recover</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>lastExitOK</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//获取ConsumeQueue最大的物理偏移量--这个也是CommitLog中物理偏移量(后续会有测试的打印代码)
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>maxPhyOffsetOfConsumeQueue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>recoverConsumeQueue</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lastExitOK</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//正常退出处理
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>recoverNormally</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>maxPhyOffsetOfConsumeQueue</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//异常退出处理
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>recoverAbnormally</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>maxPhyOffsetOfConsumeQueue</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>recoverTopicQueueTable</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote><p>在RocketMQ的4.7.0版本中CommitLog#recoverAbnormally方法显示为过期，这里暂时就不去分析这个情况。等后续看这里如何处理。</p></blockquote><h3 id=2commitlog和consumequeue的恢复>2.CommitLog和ConsumeQueue的恢复</h3><p>下面来通过添加测试代码的方式说明一下 <strong><code>maxPhyOffsetOfConsumeQueue</code></strong> 到底是什么值。首先能在 <strong><code>recover</code></strong> 中添加如下代码然后打包源码：</p><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/recover1.png?raw=true" alt></p><p>然后启动broker,我这里启动这个值为384</p><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/recover2.png?raw=true" alt></p><p>然后通过客户端在产生一条消息到Broker</p><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/recover3.png?raw=true" alt></p><p>通过监控broker日志(这个也是自己添加的)，存入CommitLog的大小为192字节。</p><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/recover4.png?raw=true" alt></p><p>然后重启Broker发现这个 <strong><code>maxPhyOffsetOfConsumeQueue</code></strong> 变为了 <strong>576</strong> 。<img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/recover5.png?raw=true" alt></p><p>通过这个日志的打印说明了 <strong><code>maxPhyOffsetOfConsumeQueue</code></strong> 为CommitLog日志中的物理偏移量。接下来分一下 <strong><code>CommitLog#recoverNormally</code></strong> 是怎么样来处理的：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>recoverNormally</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>maxPhyOffsetOfConsumeQueue</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//CRC检查在恢复的时候--默认值true
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>checkCRCOnRecover</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessageStoreConfig</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isCheckCRCOnRecover</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>//获取CommitLog的列表    
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MappedFile</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>mappedFiles</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mappedFileQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMappedFiles</span><span style=color:#ce5c00;font-weight:700>();</span>
    	<span style=color:#8f5902;font-style:italic>//非空说明不是第一次启动
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>mappedFiles</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 大于三个CommitLog文件就从最新的三个开始，小于三个就有多少校验多少
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mappedFiles</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
			
            <span style=color:#000>MappedFile</span> <span style=color:#000>mappedFile</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mappedFiles</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>ByteBuffer</span> <span style=color:#000>byteBuffer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mappedFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sliceByteBuffer</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>processOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mappedFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getFileFromOffset</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>mappedFileOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>//每条数据的校验然后返回DispatchRequest
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>DispatchRequest</span> <span style=color:#000>dispatchRequest</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>checkMessageAndReturnSize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>byteBuffer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>checkCRCOnRecover</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMsgSize</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#8f5902;font-style:italic>// 正常数据处理
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSuccess</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>mappedFileOffset</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                
                <span style=color:#8f5902;font-style:italic>//来到文件结尾或者处理完了，或者需要换文件
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSuccess</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>++;</span>
                    <span style=color:#8f5902;font-style:italic>//最新的三个文件都处理完了
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>mappedFiles</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                 
                        <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>//切换文件
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>mappedFile</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mappedFiles</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#000>byteBuffer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mappedFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sliceByteBuffer</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#000>processOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mappedFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getFileFromOffset</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#000>mappedFileOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>

                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#8f5902;font-style:italic>// 终端文件的读取由于错误
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>dispatchRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSuccess</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;recover physics file end, &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>mappedFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getFileName</span><span style=color:#ce5c00;font-weight:700>());</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#000>processOffset</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>mappedFileOffset</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>//设置刷新位置
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mappedFileQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setFlushedWhere</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>processOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>//设置接下来文件的提交位置
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mappedFileQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCommittedWhere</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>processOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>//删除过期的文件
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mappedFileQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>truncateDirtyFiles</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>processOffset</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#8f5902;font-style:italic>//清除ConsumeQueue多余的数据
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>maxPhyOffsetOfConsumeQueue</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>processOffset</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>truncateDirtyLogicFiles</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>processOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// CommitLog日志文件全部删除(特殊情况就是第一次启动)
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mappedFileQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setFlushedWhere</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mappedFileQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCommittedWhere</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>destroyLogics</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面代码有一个两个变量可能不太明白他的数据到底为多少一个是 <strong><code>processOffset、mappedFileOffset</code></strong> 下面来通过添加日志打印的模式来看一下，首先如下图所示添加代码然后打包对应的模块：</p><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/recoverNormally1.png?raw=true" alt></p><p>然后启动Broker看一下对应的值如下图：</p><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/recoverNormally2.png?raw=true" alt></p><p><strong><code>processOffset</code></strong> 启动的时候其实是0，<strong><code>mappedFileOffset</code></strong> 就是每一个CommitLog的处理数据。</p><p>上面主要分为两种正常恢复：</p><ul><li><p><strong><code>存在CommitLog日志文件</code></strong></p><ol><li>检查最新三个文件数据中的每条数据</li><li>设置flushedWhere和committedWhere值</li><li>删除处理过了的CommitLog日志文件。</li></ol></li><li><p><strong><code>不存在CommitLog日志文件(第一次启动或者日志文件被删除)</code></strong></p><p>设置flushedWhere和committedWhere为0并且删除ConsumeQueue文件</p></li></ul><h3 id=3topicqueue的恢复>3.TopicQueue的恢复</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//topic queueId和offset的关系 
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>recoverTopicQueueTable</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#8f5902;font-style:italic>/* topic-queueid */</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Long</span><span style=color:#8f5902;font-style:italic>/* offset */</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>table</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>1024</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>minPhyOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMinOffset</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConcurrentMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ConsumeQueue</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>maps</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumeQueueTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>values</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConsumeQueue</span> <span style=color:#000>logic</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>maps</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>values</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>String</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>logic</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopic</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;-&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>logic</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueueId</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>logic</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMaxOffsetInQueue</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#000>logic</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>correctMinOffset</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>minPhyOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTopicQueueTable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这个里面的关系数据会在CommitLog日志数据保存在如下代码中会用到。 <strong><code>DefaultAppendMessageCallback#doAppend</code></strong> 方法中。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>Long</span> <span style=color:#000>queueOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>CommitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>topicQueueTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#000>ueueOffset</span><span style=color:#ce5c00;font-weight:700>++;</span>

<span style=color:#000>CommitLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>topicQueueTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>queueOffset</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-2e0b99c502e1d6196c2f892af868f2d9>8 - RocketMQ源码解析-Broker存储配置文件说明</h1><blockquote><p>RocketMQ版本4..8.0版本</p></blockquote><h3 id=1-broker-store-config-下面的文件>1. Broker store config 下面的文件</h3><p>在Broker启动后在 <strong><code>$HOME \store\config</code></strong> 路径下面有五个文件分别是：</p><ul><li><strong>consumerFilter.json</strong></li><li><strong>consumerOffset.json</strong></li><li><strong>delayOffset.json</strong></li><li><strong>subscriptionGroup.json</strong></li><li><strong>topics.json</strong></li></ul><h3 id=2-consumerfilterjson>2. consumerFilter.json</h3><h3 id=3-consumeroffsetjson>3. consumerOffset.json</h3><p>记录该broker上针对每个topic的每个consumer group的针对每个queue的消费位移</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>&#34;offsetTable&#34;</span><span style=color:#000;font-weight:700>:{</span>
		<span style=color:#204a87;font-weight:700>&#34;%RETRY%please_rename_unique_group_name@please_rename_unique_group_name&#34;</span><span style=color:#000;font-weight:700>:{</span><span style=color:#a40000>0:0</span>
		<span style=color:#000;font-weight:700>},</span>
		<span style=color:#204a87;font-weight:700>&#34;TopicTest@please_rename_unique_group_name&#34;</span><span style=color:#000;font-weight:700>:{</span><span style=color:#a40000>0:6,1:3,2:3,3:2</span>
		<span style=color:#000;font-weight:700>}</span>
	<span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><h4 id=4-delayoffsetjson>4. delayOffset.json</h4><p>记录该broker延迟队列的消费位移情况，1:1中1表示延迟粒度，1表示位移</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>&#34;offsetTable&#34;</span><span style=color:#000;font-weight:700>:{</span><span style=color:#a40000>1:1</span>
	<span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><h3 id=5-subscriptiongroupjson>5. subscriptionGroup.json</h3><p>记录该broker上各类订阅关系</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>&#34;dataVersion&#34;</span><span style=color:#000;font-weight:700>:{</span>
		<span style=color:#204a87;font-weight:700>&#34;counter&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span>
		<span style=color:#204a87;font-weight:700>&#34;timestamp&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1622907213308</span>
	<span style=color:#000;font-weight:700>},</span>
	<span style=color:#204a87;font-weight:700>&#34;subscriptionGroupTable&#34;</span><span style=color:#000;font-weight:700>:{</span>
		<span style=color:#204a87;font-weight:700>&#34;SELF_TEST_C_GROUP&#34;</span><span style=color:#000;font-weight:700>:{</span>
			<span style=color:#204a87;font-weight:700>&#34;brokerId&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeBroadcastEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeFromMinEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;groupName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;SELF_TEST_C_GROUP&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;notifyConsumerIdsChangedEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;retryMaxTimes&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;retryQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;whichBrokerWhenConsumeSlowly&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span>
		<span style=color:#000;font-weight:700>},</span>
		<span style=color:#204a87;font-weight:700>&#34;CID_ONSAPI_OWNER&#34;</span><span style=color:#000;font-weight:700>:{</span>
			<span style=color:#204a87;font-weight:700>&#34;brokerId&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeBroadcastEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeFromMinEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;groupName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;CID_ONSAPI_OWNER&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;notifyConsumerIdsChangedEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;retryMaxTimes&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;retryQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;whichBrokerWhenConsumeSlowly&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span>
		<span style=color:#000;font-weight:700>},</span>
		<span style=color:#204a87;font-weight:700>&#34;CID_ONSAPI_PERMISSION&#34;</span><span style=color:#000;font-weight:700>:{</span>
			<span style=color:#204a87;font-weight:700>&#34;brokerId&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeBroadcastEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeFromMinEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;groupName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;CID_ONSAPI_PERMISSION&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;notifyConsumerIdsChangedEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;retryMaxTimes&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;retryQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;whichBrokerWhenConsumeSlowly&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span>
		<span style=color:#000;font-weight:700>},</span>
		<span style=color:#204a87;font-weight:700>&#34;please_rename_unique_group_name&#34;</span><span style=color:#000;font-weight:700>:{</span>
			<span style=color:#204a87;font-weight:700>&#34;brokerId&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeBroadcastEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeFromMinEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;groupName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;please_rename_unique_group_name&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;notifyConsumerIdsChangedEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;retryMaxTimes&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;retryQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;whichBrokerWhenConsumeSlowly&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span>
		<span style=color:#000;font-weight:700>},</span>
		<span style=color:#204a87;font-weight:700>&#34;TOOLS_CONSUMER&#34;</span><span style=color:#000;font-weight:700>:{</span>
			<span style=color:#204a87;font-weight:700>&#34;brokerId&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeBroadcastEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeFromMinEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;groupName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;TOOLS_CONSUMER&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;notifyConsumerIdsChangedEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;retryMaxTimes&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;retryQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;whichBrokerWhenConsumeSlowly&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span>
		<span style=color:#000;font-weight:700>},</span>
		<span style=color:#204a87;font-weight:700>&#34;CID_ONS-HTTP-PROXY&#34;</span><span style=color:#000;font-weight:700>:{</span>
			<span style=color:#204a87;font-weight:700>&#34;brokerId&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeBroadcastEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeFromMinEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;groupName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;CID_ONS-HTTP-PROXY&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;notifyConsumerIdsChangedEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;retryMaxTimes&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;retryQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;whichBrokerWhenConsumeSlowly&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span>
		<span style=color:#000;font-weight:700>},</span>
		<span style=color:#204a87;font-weight:700>&#34;FILTERSRV_CONSUMER&#34;</span><span style=color:#000;font-weight:700>:{</span>
			<span style=color:#204a87;font-weight:700>&#34;brokerId&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeBroadcastEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeFromMinEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;groupName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;FILTERSRV_CONSUMER&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;notifyConsumerIdsChangedEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;retryMaxTimes&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;retryQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;whichBrokerWhenConsumeSlowly&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span>
		<span style=color:#000;font-weight:700>},</span>
		<span style=color:#204a87;font-weight:700>&#34;CID_ONSAPI_PULL&#34;</span><span style=color:#000;font-weight:700>:{</span>
			<span style=color:#204a87;font-weight:700>&#34;brokerId&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeBroadcastEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;consumeFromMinEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;groupName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;CID_ONSAPI_PULL&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;notifyConsumerIdsChangedEnable&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;retryMaxTimes&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;retryQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;whichBrokerWhenConsumeSlowly&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span>
		<span style=color:#000;font-weight:700>}</span>
	<span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><h3 id=6-topicsjson>6. topics.json</h3><p>记录该broker上各topic信息，包括queue信息、读写权限</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>&#34;dataVersion&#34;</span><span style=color:#000;font-weight:700>:{</span>
		<span style=color:#204a87;font-weight:700>&#34;counter&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span>
		<span style=color:#204a87;font-weight:700>&#34;timestamp&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1622907213314</span>
	<span style=color:#000;font-weight:700>},</span>
	<span style=color:#204a87;font-weight:700>&#34;topicConfigTable&#34;</span><span style=color:#000;font-weight:700>:{</span>
		<span style=color:#204a87;font-weight:700>&#34;SCHEDULE_TOPIC_XXXX&#34;</span><span style=color:#000;font-weight:700>:{</span>
			<span style=color:#204a87;font-weight:700>&#34;order&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;perm&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;readQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicFilterType&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;SINGLE_TAG&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;SCHEDULE_TOPIC_XXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicSysFlag&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;writeQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>18</span>
		<span style=color:#000;font-weight:700>},</span>
		<span style=color:#204a87;font-weight:700>&#34;TopicTest&#34;</span><span style=color:#000;font-weight:700>:{</span>
			<span style=color:#204a87;font-weight:700>&#34;order&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;perm&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;readQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicFilterType&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;SINGLE_TAG&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;TopicTest&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicSysFlag&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;writeQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>4</span>
		<span style=color:#000;font-weight:700>},</span>
		<span style=color:#204a87;font-weight:700>&#34;SELF_TEST_TOPIC&#34;</span><span style=color:#000;font-weight:700>:{</span>
			<span style=color:#204a87;font-weight:700>&#34;order&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;perm&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;readQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicFilterType&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;SINGLE_TAG&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;SELF_TEST_TOPIC&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicSysFlag&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;writeQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span>
		<span style=color:#000;font-weight:700>},</span>
		<span style=color:#204a87;font-weight:700>&#34;DefaultCluster&#34;</span><span style=color:#000;font-weight:700>:{</span>
			<span style=color:#204a87;font-weight:700>&#34;order&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;perm&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;readQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicFilterType&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;SINGLE_TAG&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;DefaultCluster&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicSysFlag&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;writeQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>16</span>
		<span style=color:#000;font-weight:700>},</span>
		<span style=color:#204a87;font-weight:700>&#34;DefaultCluster_REPLY_TOPIC&#34;</span><span style=color:#000;font-weight:700>:{</span>
			<span style=color:#204a87;font-weight:700>&#34;order&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;perm&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;readQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicFilterType&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;SINGLE_TAG&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;DefaultCluster_REPLY_TOPIC&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicSysFlag&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;writeQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span>
		<span style=color:#000;font-weight:700>},</span>
		<span style=color:#204a87;font-weight:700>&#34;DESKTOP-B7KDPBT&#34;</span><span style=color:#000;font-weight:700>:{</span>
			<span style=color:#204a87;font-weight:700>&#34;order&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;perm&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;readQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicFilterType&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;SINGLE_TAG&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;DESKTOP-B7KDPBT&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicSysFlag&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;writeQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span>
		<span style=color:#000;font-weight:700>},</span>
		<span style=color:#204a87;font-weight:700>&#34;RMQ_SYS_TRANS_HALF_TOPIC&#34;</span><span style=color:#000;font-weight:700>:{</span>
			<span style=color:#204a87;font-weight:700>&#34;order&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;perm&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;readQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicFilterType&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;SINGLE_TAG&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;RMQ_SYS_TRANS_HALF_TOPIC&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicSysFlag&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;writeQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span>
		<span style=color:#000;font-weight:700>},</span>
		<span style=color:#204a87;font-weight:700>&#34;%RETRY%please_rename_unique_group_name&#34;</span><span style=color:#000;font-weight:700>:{</span>
			<span style=color:#204a87;font-weight:700>&#34;order&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;perm&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;readQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicFilterType&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;SINGLE_TAG&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;%RETRY%please_rename_unique_group_name&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicSysFlag&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;writeQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span>
		<span style=color:#000;font-weight:700>},</span>
		<span style=color:#204a87;font-weight:700>&#34;TBW102&#34;</span><span style=color:#000;font-weight:700>:{</span>
			<span style=color:#204a87;font-weight:700>&#34;order&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;perm&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;readQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicFilterType&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;SINGLE_TAG&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;TBW102&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicSysFlag&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;writeQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>8</span>
		<span style=color:#000;font-weight:700>},</span>
		<span style=color:#204a87;font-weight:700>&#34;BenchmarkTest&#34;</span><span style=color:#000;font-weight:700>:{</span>
			<span style=color:#204a87;font-weight:700>&#34;order&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;perm&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;readQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1024</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicFilterType&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;SINGLE_TAG&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;BenchmarkTest&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicSysFlag&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;writeQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1024</span>
		<span style=color:#000;font-weight:700>},</span>
		<span style=color:#204a87;font-weight:700>&#34;OFFSET_MOVED_EVENT&#34;</span><span style=color:#000;font-weight:700>:{</span>
			<span style=color:#204a87;font-weight:700>&#34;order&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;perm&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;readQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicFilterType&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;SINGLE_TAG&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;OFFSET_MOVED_EVENT&#34;</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;topicSysFlag&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
			<span style=color:#204a87;font-weight:700>&#34;writeQueueNums&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span>
		<span style=color:#000;font-weight:700>}</span>
	<span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-73525016293fc3e03673666421e0bb7b>9 - RocketMQ源码解析-Broker 消息Tag过滤</h1><blockquote><p>RocketMQ源码版本4.8.0</p></blockquote><h3 id=1-消息tagcode生成>1. 消息TagCode生成</h3><p>通过 <strong>ReputMessageService</strong> 服务获取commitlog数据。然后通过 <strong><code>CommitLog#checkMessageAndReturnSize</code></strong> 生成tagCode:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>DispatchRequest</span> <span style=color:#000>checkMessageAndReturnSize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nio</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ByteBuffer</span> <span style=color:#000>byteBuffer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>checkCRC</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>readBody</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertiesLength</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>byteBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bytesContent</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>propertiesLength</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>String</span> <span style=color:#000>properties</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bytesContent</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>propertiesLength</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MessageDecoder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CHARSET_UTF8</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>propertiesMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MessageDecoder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>string2messageProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#000>keys</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>propertiesMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageConst</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PROPERTY_KEYS</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#000>uniqKey</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>propertiesMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageConst</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PROPERTY_UNIQ_CLIENT_MESSAGE_ID_KEYIDX</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#000>String</span> <span style=color:#000>tags</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>propertiesMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageConst</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PROPERTY_TAGS</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tags</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>tags</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//生成TagCode
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>tagsCode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MessageExtBrokerInner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>tagsString2tagsCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageExt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseTopicFilterType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sysFlag</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>tags</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>String</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>propertiesMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageConst</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PROPERTY_DELAY_TIME_LEVEL</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TopicValidator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RMQ_SYS_SCHEDULE_TOPIC</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>delayLevel</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span>

                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delayLevel</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getScheduleMessageService</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getMaxDelayLevel</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>delayLevel</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getScheduleMessageService</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getMaxDelayLevel</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#ce5c00;font-weight:700>}</span>

                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delayLevel</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>tagsCode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultMessageStore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getScheduleMessageService</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>computeDeliverTimestamp</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delayLevel</span><span style=color:#ce5c00;font-weight:700>,</span>
                        <span style=color:#000>storeTimestamp</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

 <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MessageExtBrokerInner</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>MessageExt</span> <span style=color:#ce5c00;font-weight:700>{</span>
     <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>tagsString2tagsCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>TopicFilterType</span> <span style=color:#000>filter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>tags</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>tags</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>tags</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>tags</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hashCode</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul><li>DispatchRequest将tag转化为tagCode</li><li>DispatchRequest用于consumeQueue的存储，通过CommitLogDispatcherBuildConsumeQueue保存了tagsCode</li></ul><h3 id=2-消费者订阅主题和tags>2. 消费者订阅主题和Tags</h3><p>Consumer端在订阅消息时除了指定Topic还可以指定TAG，如果一个消息有多个TAG，可以用 <strong>||</strong> 分隔。其中，Consumer端会将这个订阅请求构建成一个 SubscriptionData，发送一个Pull消息的请求给Broker端，看一下消费者代码的实现：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>SubscriptionData</span> <span style=color:#000>buildSubscriptionData</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>consumerGroup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>,</span>
    <span style=color:#000>String</span> <span style=color:#000>subString</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>SubscriptionData</span> <span style=color:#000>subscriptionData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SubscriptionData</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>subscriptionData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTopic</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topic</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>subscriptionData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSubString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>subString</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>subString</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>subString</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SubscriptionData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SUB_ALL</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>subString</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>subscriptionData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSubString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SubscriptionData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SUB_ALL</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>tags</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>subString</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>split</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;\\|\\|&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tags</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>tag</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>tags</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>String</span> <span style=color:#000>trimString</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trim</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>trimString</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>subscriptionData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTagsSet</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>trimString</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#8f5902;font-style:italic>//获取tagCode其实就是hashCode
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>subscriptionData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCodeSet</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>trimString</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hashCode</span><span style=color:#ce5c00;font-weight:700>());</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;subString split error&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>subscriptionData</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=3-broker-tag过滤>3. Broker Tag过滤</h3><p>Broker从CommitLog读取存储消息数据之前，会用消费者发送的SubscriptionData构建一个MessageFilter过滤器。然后传给MessageStore。然后通过MessageStore从 ConsumeQueue读取到一条记录后，会用它记录的消息tag hash(tagCode)值去做过滤，由于在服务端只是根据hashcode进行判断，无法精确对tag原始字符串进行过滤，故在消息消费端拉取到消息后，还需要对消息的原始tag字符串进行比对，如果不同，则丢弃该消息，不进行消息消费。</p></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list"><a class=text-white target=_blank rel="noopener noreferrer" href=https://groups.google.com/u/1/g/ljbmxsm><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=个人掘金主页 aria-label=个人掘金主页><a class=text-white target=_blank rel="noopener noreferrer" href=https://juejin.cn/user/1151943918492855><i class="fab fa-twitter"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/mxsm><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2022 The Docsy Authors All Rights Reserved</small>
<small class=ml-1><a href=https://policies.google.com/privacy target=_blank>隐私政策</a></small><p class=mt-2><a href=/about/>Home</a></p></div></div></div></footer><div><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css><script src=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js></script><script>$("p img").wrap(function(){return'<a data-fancybox="gallery" href="'+$(this).attr('src')+'"></a>'})</script></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/mermaid@8.8.1/dist/mermaid.min.js integrity=sha384-to2w0I1OqmbJ9J6yTnIX+KYU8grNpZoD1dKPLjgEJvMe5L5+/7qvuNa2sQo8WAWj crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/raphael/2.3.0/raphael.min.js integrity="sha512-tBzZQxySO5q5lqwLWfu8Q+o4VkTcRGOeQGVQ0ueJga4A1RKuzmAu5HXDOXLEjpbKyV7ow9ympVoa6wZLEzRzDg==" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.15.0/flowchart.min.js integrity="sha512-6QsSiIybtf8tuZ6xfjRTr2tdtw3Gp4q5RSCh2b6q9seoKEQmhAG1RrCA8F0kXTwivVxRVbp/YF3zOh8rvEAU7Q==" crossorigin=anonymous></script><script src=/js/main.min.b541b310f01941a0abfd76b652b5fb60dac470573775bb5b31ff08fe3f6cea51.js integrity="sha256-tUGzEPAZQaCr/Xa2UrX7YNrEcFc3dbtbMf8I/j9s6lE=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.js></script><script type=text/javascript>docsearch({appId:'JO2SY3WDAC',apiKey:'324ddb3b679c1308e5aa8bf222e07f8b',indexName:'mxsm',inputSelector:'.td-search-input',debug:!1})</script></body></html>