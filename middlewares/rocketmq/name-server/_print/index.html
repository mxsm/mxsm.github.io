<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.83.1"><link rel=canonical type=text/html href=/middlewares/rocketmq/name-server/><link rel=alternate type=application/rss+xml href=/middlewares/rocketmq/name-server/index.xml><meta name=ROBOTS content="INDEX, FOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>RocketMQ Name Server | 蚂蚁背大象</title><meta property="og:title" content="RocketMQ Name Server"><meta property="og:description" content="蚂蚁背大象博客"><meta property="og:type" content="website"><meta property="og:url" content="/middlewares/rocketmq/name-server/"><meta property="og:site_name" content="蚂蚁背大象"><meta itemprop=name content="RocketMQ Name Server"><meta itemprop=description content="蚂蚁背大象博客"><meta name=twitter:card content="summary"><meta name=twitter:title content="RocketMQ Name Server"><meta name=twitter:description content="蚂蚁背大象博客"><link rel=preload href=/scss/main.min.e09cb23c7dff3bf1285aa0294bcdc4ac8194fb3425a99c621e31e7b871315685.css as=style><link href=/scss/main.min.e09cb23c7dff3bf1285aa0294bcdc4ac8194fb3425a99c621e31e7b871315685.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 321.39 78.54"><title id="title19">DUBBO LOGO</title><path class="cls-1" d="M68.46 50.38c0 14.06 11.39 22.11 25.45 22.11s25.45-8.05 25.45-22.11V7.25H68.46zm21.24-28h8.6V31H89.7zm0 22.25h8.6v8.6H89.7zM33.24 7.25H4.06v64H33.24c10.95.0 19.3-7.18 23.29-17.15a45.12 45.12.0 002.38-14.87A45.12 45.12.0 0056.53 24.4C52.84 14.62 44.19 7.25 33.24 7.25zm.43 14.63H30.34a3.44 3.44.0 00-3.44 3.44V53.23a3.44 3.44.0 003.44 3.44h3.33v4.63h-8.3a6.87 6.87.0 01-6.87-6.87V24.12a6.87 6.87.0 016.87-6.87h8.3zM285.51 6.06c-17.05.0-30.88 10.28-30.88 33.21s13.83 33.21 30.88 33.21 30.88-10.28 30.88-33.21S302.56 6.06 285.51 6.06zm7.59 48.36a6.87 6.87.0 01-6.87 6.87h-8.3V56.67h3.33a3.44 3.44.0 003.44-3.44V25.31a3.44 3.44.0 00-3.44-3.44h-3.33V17.25h8.3a6.87 6.87.0 016.87 6.87zm-53.4-17.56A17.39 17.39.0 00227.31 7.25H195.1v64h32.21a19.44 19.44.0 0012.38-34.44zM211.63 61.29h-6.08l18.68-44h6.08zM177 36.85A17.39 17.39.0 00164.65 7.25H132.43v64h32.21A19.44 19.44.0 00177 36.85zM149 61.29h-6.08l18.68-44h6.08z" style="fill:#fff;fill-opacity:1"/></svg></span><span class="text-uppercase font-weight-bold">蚂蚁背大象</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/about/><span>Home</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog/><span>Java</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/spring/><span>Spring</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/middlewares/><span class=active>Middleware</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/><span>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/other/><span>Others</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community/><span>Community</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002 站内搜索…" aria-label=站内搜索… autocomplete=off></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/middlewares/rocketmq/name-server/>Return to the regular view of this page</a>.</p></div><h1 class=title>RocketMQ Name Server</h1><ul><li>1: <a href=#pg-2ec75df1201cddcb51c9549a4a9b6e48>NameServer</a></li><li>2: <a href=#pg-80e16469ef810b0280a6f4324ac46db3>RocketMQ源码解析-NameServer启动</a></li><li>3: <a href=#pg-039627ec513fed111ae3e49aaa0ad4d0>RocketMQ源码解析-NameServer对Broker的管理</a></li></ul><div class=content></div></div><div class=td-content><h1 id=pg-2ec75df1201cddcb51c9549a4a9b6e48>1 - NameServer</h1><h3 id=1-什么是nameserver>1. 什么是NameServer?</h3><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/RocketMQ%E7%89%A9%E7%90%86%E9%83%A8%E7%BD%B2%E5%9B%BE.jpg?raw=true" alt=图解></p><p><strong><code>NameServer</code></strong> 就是一个保存Broker状态的一个服务和Broker管理。</p><p><strong>NameServer 的特点：</strong></p><ul><li><strong>NameServer 和 每一台Broker 服务器保持长连接，并间隔30s检测一次Broker是否存活。</strong></li><li><strong>检测到 Broker右机 ， 则从路由注册表中将其移除 。 但是路由变化不会马上通知消息生产者。— 降低 NameServer实现的复杂性，在消息发送端提供容错机制来保证消息发送的高可用性</strong>。</li><li><strong>NameServer本身的高可用可通过部 署多台 NameServerr服务器来实现，但彼此之间互不通信，也就是 NameServer服务器之间在某一时刻的数据并不会完全相同</strong></li></ul><p><strong>作用</strong>：</p><ul><li><strong>消息生产者 和 消息消费者提供关 于主题 Topic 的路由信息</strong></li><li><strong>NameServer存储路由 的基础信息</strong></li><li><strong>管理 Broker节点，包括路由 注册、路由删除等功能</strong></li></ul><h3 id=2-nameserver-路由注册故障剔除>2. NameServer 路由注册、故障剔除</h3><h4 id=21-nameserver-存储了哪些信息>2.1 NameServer 存储了哪些信息</h4><ul><li>Topic 消息队列路由信息。消息发送时根据路由表进行负 载均衡。</li><li>Broker 基础信息， 包含 brokerName、 所属集群名称 、 主备 Broker 地址</li><li>Broker 集群信息，存储集群中所有 Broker 名称</li><li>Broker 状态信息 。NameServer 每次收到心跳包时会替换该信息</li><li>Broker上的 FilterServer列表，用于类模式消息过滤</li></ul><blockquote><p>RocketMQ 基于订阅发布机制 ， 一个Topic拥有多个消息队列 ，一个Broker为每一主题默认创建 4 个读队列 4 个写队列。多个Broker组成一个集群， BrokerName由相同的多台Broker组成Master-Slave架构。brokerId 为0代表 Master， 大于0表示Slave。 BrokerLivelnfo中的lastUpdateTimestamp 存储上次收到 Broker 心跳包的时间</p></blockquote><h4 id=22-路由注册>2.2 路由注册</h4><p>路由注册的步骤：</p><ul><li><strong>Broker发送心跳包</strong><ul><li>Header<ul><li>Broker地址</li><li>BrokerId, 0:Master; 大于0:slave</li><li>Broker名称</li><li>集群名称</li><li>master地址，初次请求时为空，slave向NameServer注册后返回</li></ul></li><li>Body<ul><li>消息过滤服务器列表</li><li>主题的配置</li></ul></li></ul></li><li><strong>NameServer 心跳包处理</strong><ul><li>路由 注册需要加写锁 ，防止并发修改 RoutelnfoManager 中的路由 表 。Broker 所属 集群是否存在， 如果不存在，则创 建，然 后将 broker 名加入到集群Broker集合中</li><li>维护 BrokerData信息。</li><li>如果Broker为Master，并且BrokerTopic配置信息发生变化或者是初次注册，则需要创建或更新 Topic路由元数据，填充 topicQueueTable， 其实就是为默认主题自动注册路由信息，其中包含 MixAII.DEFAULT TOPIC 的路由信息。 当消息生产者发送主题时，如果该主题未创建并且BrokerConfig 的autoCreateTopicEnable为true时， 将返回MixAII.DEFAULT TOPIC的路由信息。</li><li>更新 BrokerLivelnfo，存活 Broker信息表， BrokeLivelnfo是执行路由删除的重要依据</li><li>注册 Broker 的过滤器 Server地址列表 ，一个 Broker上会关联多个 FilterServer消息过滤服务器</li></ul></li></ul><blockquote><p>NameServer和Broker保持长连接，Broker状态存储在brokerLiveTable中，NameServer收到每一个心跳包将更新brokerLiveTable中关于Broker的状态信息以及路由表(topicQueueTable、brokerAddrTable、
brokerLiveTable、filterServerTable)</p></blockquote><h4 id=23-路由删除>2.3 路由删除</h4><p>对于Broker来说每隔30秒想NameServer发送一个心跳包来维持Broker在NameServer中的状态。</p><p>对于NameServer来说会每隔10秒扫描一次brokerLiveTable状态表，如果发现Broker的lastUpdateTimestamp的时间戳距当前超过120S，这样认为Broker已经失效，移除Broker,关闭与Broker的连接。同时更新对应的信息。</p><p><strong>触发路由删除：</strong></p><ul><li><strong>NameServer定时扫描 brokerLiveTable检测上次心跳包与 当前系统时间的时间差如果时间戳大于 120s，则需要移除该 Broker 信息 。</strong></li><li><strong>Broker在正常被关闭的情况下，会执行 unregisterBroker指令。</strong></li></ul><h4 id=24-路由发现>2.4 路由发现</h4><p>RocketMQ 路由发现是非实时的，NameServer不会主动推送给客户端。而是由客户端定时拉去主题最新的路由。</p><h3 id=3-总结>3. 总结</h3><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/NameServer%E8%B7%AF%E7%94%B1%E6%B3%A8%E5%86%8C%E5%88%A0%E9%99%A4%E5%8F%91%E7%8E%B0%E6%9C%BA%E5%88%B6.jpg?raw=true" alt=图解></p><p>NameServer路由发现与删除机制就介绍到这里了，我们会发现这种设计会存在这样一种情况: NameServer需要等 Broker失效至少 120s才能将该 Broker从路由表中移除掉，那如果在 Broker故障期间，消息生产者 Producer根据主题获取到的路由信息包含已经看机的Broker，会导致消息发送失败，那这种情况 怎么办。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-80e16469ef810b0280a6f4324ac46db3>2 - RocketMQ源码解析-NameServer启动</h1><blockquote><p>以下源码基于Rocket MQ 4.7.0</p></blockquote><h3 id=1-nameserver>1. NameServer</h3><p>NameServer是一个非常简单的Topic路由注册中心，其角色类似Dubbo中的zookeeper，支持Broker的动态注册与发现。主要包括两个功能：</p><ul><li>Broker管理，NameServer接受Broker集群的注册信息并且保存下来作为路由信息的基本数据。然后提供心跳检测机制，检查Broker是否还存活(代码中通过定时扫描BrokerLiveInfo的信息来管理)；</li><li>路由信息管理，每个NameServer将保存关于Broker集群的整个路由信息和用于客户端查询的队列信息。然后Producer和Conumser通过NameServer就可以知道整个Broker集群的路由信息，从而进行消息的投递和消费。</li></ul><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/NameServer%E7%9A%84%E5%8A%9F%E8%83%BD.png?raw=true" alt></p><p>NameServer通常也是集群的方式部署，各实例间相互不进行信息通讯。Broker是向每一台NameServer注册自己的路由信息，所以每一个NameServer实例上面都保存一份完整的路由信息。当某个NameServer因某种原因下线了，Broker仍然可以向其它NameServer同步其路由信息，Producer,Consumer仍然可以动态感知Broker的路由的信息。</p><blockquote><p>NameServer各个实例之间互不通讯</p></blockquote><h3 id=2-源码分析>2. 源码分析</h3><h4 id=21-remoting通信类结构>2.1 Remoting通信类结构</h4><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/RemotingService.png?raw=true" alt></p><h4 id=22-nameserver-启动>2.2 NameServer 启动</h4><p><strong>org.apache.rocketmq.namesrv.NamesrvStartup</strong> 是NameServer的启动类</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>main0</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

     <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>NamesrvController</span> <span style=color:#000>main0</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>NamesrvController</span> <span style=color:#000>controller</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createNamesrvController</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>controller</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>String</span> <span style=color:#000>tip</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;The Name Server boot success. serializeType=&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>RemotingCommand</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSerializeTypeConfigInThisServer</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tip</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;%s%n&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>tip</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>controller</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>exit</span><span style=color:#ce5c00;font-weight:700>(-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过 <strong><code>createNamesrvController</code></strong> 创建 <strong><code>NamesrvController</code></strong></p><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/createNamesrvController.png?raw=true" alt></p><p>NameServer 启动时首先判断是否传入了命令行参数。从代码可以看到有两个参数：</p><ul><li>-c可以指定 NameServer 的配置文件，如果不指定，则使用默认值</li><li>-p 打印 NameServer 的配置参数信息。打印完参数后退出进程</li></ul><p>下面就是打印的配置参数</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>22:06:51.794 <span style=color:#ce5c00;font-weight:700>[</span>main<span style=color:#ce5c00;font-weight:700>]</span> INFO  RocketmqNamesrvConsole - <span style=color:#000>rocketmqHome</span><span style=color:#ce5c00;font-weight:700>=</span>D:<span style=color:#4e9a06>\d</span>ev<span style=color:#4e9a06>\g</span>itproject<span style=color:#4e9a06>\r</span>ocketmq<span style=color:#4e9a06>\d</span>istribution
22:06:51.857 <span style=color:#ce5c00;font-weight:700>[</span>main<span style=color:#ce5c00;font-weight:700>]</span> INFO  RocketmqNamesrvConsole - <span style=color:#000>kvConfigPath</span><span style=color:#ce5c00;font-weight:700>=</span>C:<span style=color:#4e9a06>\U</span>sers<span style=color:#4e9a06>\m</span>xsm<span style=color:#4e9a06>\n</span>amesrv<span style=color:#4e9a06>\k</span>vConfig.json
22:06:51.858 <span style=color:#ce5c00;font-weight:700>[</span>main<span style=color:#ce5c00;font-weight:700>]</span> INFO  RocketmqNamesrvConsole - <span style=color:#000>configStorePath</span><span style=color:#ce5c00;font-weight:700>=</span>C:<span style=color:#4e9a06>\U</span>sers<span style=color:#4e9a06>\m</span>xsm<span style=color:#4e9a06>\n</span>amesrv<span style=color:#4e9a06>\n</span>amesrv.properties
22:06:51.858 <span style=color:#ce5c00;font-weight:700>[</span>main<span style=color:#ce5c00;font-weight:700>]</span> INFO  RocketmqNamesrvConsole - <span style=color:#000>productEnvName</span><span style=color:#ce5c00;font-weight:700>=</span>center
22:06:51.859 <span style=color:#ce5c00;font-weight:700>[</span>main<span style=color:#ce5c00;font-weight:700>]</span> INFO  RocketmqNamesrvConsole - <span style=color:#000>clusterTest</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>
22:06:51.859 <span style=color:#ce5c00;font-weight:700>[</span>main<span style=color:#ce5c00;font-weight:700>]</span> INFO  RocketmqNamesrvConsole - <span style=color:#000>orderMessageEnable</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>
22:06:51.860 <span style=color:#ce5c00;font-weight:700>[</span>main<span style=color:#ce5c00;font-weight:700>]</span> INFO  RocketmqNamesrvConsole - <span style=color:#000>listenPort</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>9876</span>
22:06:51.862 <span style=color:#ce5c00;font-weight:700>[</span>main<span style=color:#ce5c00;font-weight:700>]</span> INFO  RocketmqNamesrvConsole - <span style=color:#000>serverWorkerThreads</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>8</span>
22:06:51.864 <span style=color:#ce5c00;font-weight:700>[</span>main<span style=color:#ce5c00;font-weight:700>]</span> INFO  RocketmqNamesrvConsole - <span style=color:#000>serverCallbackExecutorThreads</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span>
22:06:51.864 <span style=color:#ce5c00;font-weight:700>[</span>main<span style=color:#ce5c00;font-weight:700>]</span> INFO  RocketmqNamesrvConsole - <span style=color:#000>serverSelectorThreads</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>3</span>
22:06:51.864 <span style=color:#ce5c00;font-weight:700>[</span>main<span style=color:#ce5c00;font-weight:700>]</span> INFO  RocketmqNamesrvConsole - <span style=color:#000>serverOnewaySemaphoreValue</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>256</span>
22:06:51.865 <span style=color:#ce5c00;font-weight:700>[</span>main<span style=color:#ce5c00;font-weight:700>]</span> INFO  RocketmqNamesrvConsole - <span style=color:#000>serverAsyncSemaphoreValue</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>64</span>
22:06:51.865 <span style=color:#ce5c00;font-weight:700>[</span>main<span style=color:#ce5c00;font-weight:700>]</span> INFO  RocketmqNamesrvConsole - <span style=color:#000>serverChannelMaxIdleTimeSeconds</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>120</span>
22:06:51.865 <span style=color:#ce5c00;font-weight:700>[</span>main<span style=color:#ce5c00;font-weight:700>]</span> INFO  RocketmqNamesrvConsole - <span style=color:#000>serverSocketSndBufSize</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>65535</span>
22:06:51.865 <span style=color:#ce5c00;font-weight:700>[</span>main<span style=color:#ce5c00;font-weight:700>]</span> INFO  RocketmqNamesrvConsole - <span style=color:#000>serverSocketRcvBufSize</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>65535</span>
22:06:51.865 <span style=color:#ce5c00;font-weight:700>[</span>main<span style=color:#ce5c00;font-weight:700>]</span> INFO  RocketmqNamesrvConsole - <span style=color:#000>serverPooledByteBufAllocatorEnable</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
22:06:51.865 <span style=color:#ce5c00;font-weight:700>[</span>main<span style=color:#ce5c00;font-weight:700>]</span> INFO  RocketmqNamesrvConsole - <span style=color:#000>useEpollNativeSelector</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>
</code></pre></div><p>下面的代码就是在 <strong><code>createNamesrvController</code></strong> 中创建 <strong><code>NamesrvController</code></strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>NamesrvController</span> <span style=color:#000>controller</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NamesrvController</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>namesrvConfig</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nettyServerConfig</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#8f5902;font-style:italic>// remember all configs to prevent discard
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>controller</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConfiguration</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>registerConfig</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><h4 id=23-namesrvcontroller初始化>2.3 NamesrvController初始化</h4><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/NamesrvControllerStart.png?raw=true" alt></p><p><strong><code>NamesrvStartup.start</code></strong> 主要初始化NamesrvController和启动</p><ol><li>调用NamesrvController.initialize方法初始化</li><li>调用NamesrvController.start方法启动</li></ol><blockquote><p>在上图的代码中可以看到还注册了Hook，如果使用kill -9 的方式杀死进程就不会执行Hook中的代码</p></blockquote><h4 id=24-namesrvcontrollerinitialize>2.4 NamesrvController.initialize</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>initialize</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>//从${user.home}/namesrv/kvConfig.json加载配置NameServer的配置
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>kvConfigManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>load</span><span style=color:#ce5c00;font-weight:700>();</span>  <span style=color:#8f5902;font-style:italic>//1
</span><span style=color:#8f5902;font-style:italic></span>		
        <span style=color:#8f5902;font-style:italic>//创建Netty Server
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remotingServer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NettyRemotingServer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nettyServerConfig</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerHousekeepingService</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//2
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#8f5902;font-style:italic>//创建一个固定线程池
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remotingExecutor</span> <span style=color:#ce5c00;font-weight:700>=</span>
            <span style=color:#000>Executors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newFixedThreadPool</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nettyServerConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getServerWorkerThreads</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ThreadFactoryImpl</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;RemotingExecutorThread_&#34;</span><span style=color:#ce5c00;font-weight:700>));</span><span style=color:#8f5902;font-style:italic>//3
</span><span style=color:#8f5902;font-style:italic></span>        
		<span style=color:#8f5902;font-style:italic>////注册NameServer服务接受请求的处理类
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerProcessor</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//4
</span><span style=color:#8f5902;font-style:italic></span>		
        <span style=color:#8f5902;font-style:italic>//定时清理失效的Broker
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scheduledExecutorService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scheduleAtFixedRate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>

            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>NamesrvController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>routeInfoManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scanNotActiveBroker</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SECONDS</span><span style=color:#ce5c00;font-weight:700>);</span>  <span style=color:#8f5902;font-style:italic>//5
</span><span style=color:#8f5902;font-style:italic></span>
        <span style=color:#8f5902;font-style:italic>//定时打印NameServer配置
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scheduledExecutorService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scheduleAtFixedRate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>

            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>NamesrvController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>kvConfigManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printAllPeriodically</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MINUTES</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//6
</span><span style=color:#8f5902;font-style:italic></span>
        <span style=color:#8f5902;font-style:italic>//7
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TlsSystemConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>tlsMode</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>TlsMode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DISABLED</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>//................
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ol><li><p>从${user.home}/namesrv/kvConfig.json加载配置NameServer的配置</p></li><li><p>创建NettyServer来提供服务</p></li><li><p>创建NettyServer执行使用的线程池</p></li><li><p>给NettyServer注入请求处理器</p></li><li><p>创建一个定时清理超时的 Broker 定时任务</p><p>每十秒钟扫描一下Broker的窗台，删除2分钟没有更新状态的Broker,关闭对应的Netty的Channel</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>scanNotActiveBroker</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Iterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BrokerLiveInfo</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>it</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerLiveTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>entrySet</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>iterator</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>it</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasNext</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BrokerLiveInfo</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>it</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>last</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getLastUpdateTimestamp</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>last</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>BROKER_CHANNEL_EXPIRED_TIME</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>//关闭Channel
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>RemotingUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>closeChannel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getChannel</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#000>it</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The broker channel expired, {} {}ms&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getKey</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>BROKER_CHANNEL_EXPIRED_TIME</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>onChannelDestroy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getKey</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getChannel</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li><li><p>创建一个打印 NameServer 配置的定时任务</p><p>每隔10分钟打印一次NameServer的配置参数。即KVConfigManager.configTable变量的内容。</p></li><li><p>SSL的启用</p></li></ol><h4 id=25-namesrvcontrollerregisterprocessor>2.5 NamesrvController.registerProcessor</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//注册接收请求的类
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerProcessor</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>namesrvConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isClusterTest</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>

            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remotingServer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerDefaultProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClusterTestRequestProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>namesrvConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProductEnvName</span><span style=color:#ce5c00;font-weight:700>()),</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remotingExecutor</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>

            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remotingServer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerDefaultProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DefaultRequestProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remotingExecutor</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>默认注入的请求类 <strong><code>DefaultRequestProcessor</code></strong> 。</p><h4 id=26-defaultrequestprocessor>2.6 DefaultRequestProcessor</h4><p>通过 <strong><code>DefaultRequestProcessor.processRequest</code></strong> 方法来处理客户端的请求。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>RemotingCommand</span> <span style=color:#000>processRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ChannelHandlerContext</span> <span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>RemotingCommand</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>RemotingCommandException</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#8f5902;font-style:italic>//打印请求的信息
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;receive request, {} {} {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCode</span><span style=color:#ce5c00;font-weight:700>(),</span>
                <span style=color:#000>RemotingHelper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseChannelRemoteAddr</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>channel</span><span style=color:#ce5c00;font-weight:700>()),</span>
                <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>switch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCode</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PUT_KV_CONFIG</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putKVConfig</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET_KV_CONFIG</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getKVConfig</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DELETE_KV_CONFIG</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>deleteKVConfig</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>QUERY_DATA_VERSION</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>queryBrokerTopicConfig</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>REGISTER_BROKER</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#000>Version</span> <span style=color:#000>brokerVersion</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MQVersion</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value2Version</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getVersion</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>brokerVersion</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ordinal</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>MQVersion</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Version</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>V3_0_11</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ordinal</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerBrokerWithFilterServer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerBroker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>UNREGISTER_BROKER</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unregisterBroker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET_ROUTEINTO_BY_TOPIC</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRouteInfoByTopic</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET_BROKER_CLUSTER_INFO</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBrokerClusterInfo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>WIPE_WRITE_PERM_OF_BROKER</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wipeWritePermOfBroker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET_ALL_TOPIC_LIST_FROM_NAMESERVER</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getAllTopicListFromNameserver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DELETE_TOPIC_IN_NAMESRV</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>deleteTopicInNamesrv</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET_KVLIST_BY_NAMESPACE</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getKVListByNamespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET_TOPICS_BY_CLUSTER</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTopicsByCluster</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET_SYSTEM_TOPIC_LIST_FROM_NS</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSystemTopicListFromNs</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET_UNIT_TOPIC_LIST</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUnitTopicList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET_HAS_UNIT_SUB_TOPIC_LIST</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getHasUnitSubTopicList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET_HAS_UNIT_SUB_UNUNIT_TOPIC_LIST</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getHasUnitSubUnUnitTopicList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>UPDATE_NAMESRV_CONFIG</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>updateConfig</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>RequestCode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET_NAMESRV_CONFIG</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConfig</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>default</span><span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>所有的请求类型定义在 <strong>RequestCode</strong> 中：</p><table><thead><tr><th>RequestCode</th><th>说明</th></tr></thead><tbody><tr><td>PUT_KV_CONFIG</td><td>向Namesrv追加KV配置</td></tr><tr><td>GET_KV_CONFIG</td><td>从Namesrv获取KV配置</td></tr><tr><td>DELETE_KV_CONFIG</td><td>从Namesrv获取KV配置</td></tr><tr><td>QUERY_DATA_VERSION</td><td>获取版本信息</td></tr><tr><td>REGISTER_BROKER</td><td>注册一个Broker，数据都是持久化的，如果存在则覆盖配置</td></tr><tr><td>UNREGISTER_BROKER</td><td>卸载一个Broker，数据都是持久化的</td></tr><tr><td>GET_ROUTEINTO_BY_TOPIC</td><td>根据Topic获取Broker Name、topic配置信息</td></tr><tr><td>GET_BROKER_CLUSTER_INFO</td><td>获取注册到Name Server的所有Broker集群信息-客户端获取</td></tr><tr><td>WIPE_WRITE_PERM_OF_BROKER</td><td>去掉BrokerName的写权限</td></tr><tr><td>GET_ALL_TOPIC_LIST_FROM_NAMESERVER</td><td>从Name Server获取完整Topic列表</td></tr><tr><td>DELETE_TOPIC_IN_NAMESRV</td><td>从Namesrv删除Topic配置</td></tr><tr><td>GET_KVLIST_BY_NAMESPACE</td><td>通过NameSpace获取所有的KV List</td></tr><tr><td>GET_TOPICS_BY_CLUSTER</td><td>获取指定集群下的所有 topic</td></tr><tr><td>GET_SYSTEM_TOPIC_LIST_FROM_NS</td><td>获取所有系统内置 Topic 列表</td></tr><tr><td>GET_UNIT_TOPIC_LIST</td><td>单元化相关 topic</td></tr><tr><td>GET_HAS_UNIT_SUB_TOPIC_LIST</td><td>获取含有单元化订阅组的 Topic 列表</td></tr><tr><td>GET_HAS_UNIT_SUB_UNUNIT_TOPIC_LIST</td><td>获取含有单元化订阅组的非单元化</td></tr><tr><td>UPDATE_NAMESRV_CONFIG</td><td>更新Name Server配置</td></tr><tr><td>GET_NAMESRV_CONFIG</td><td>获取Name Server配置</td></tr></tbody></table><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/RequestCode.png?raw=true" alt></p><blockquote><p>以上RequestCode分为两类：</p><ol><li>路由信息</li><li>NameServer的配置</li></ol></blockquote><h4 id=27-routeinfomanager>2.7 RouteInfoManager</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>RouteInfoManager</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>InternalLogger</span> <span style=color:#000>log</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>InternalLoggerFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLogger</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LoggerName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NAMESRV_LOGGER_NAME</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>BROKER_CHANNEL_EXPIRED_TIME</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1000</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>60</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ReadWriteLock</span> <span style=color:#000>lock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ReentrantReadWriteLock</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#8f5902;font-style:italic>/* topic */</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>QueueData</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>topicQueueTable</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#8f5902;font-style:italic>/* brokerName */</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BrokerData</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>brokerAddrTable</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#8f5902;font-style:italic>/* clusterName */</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#8f5902;font-style:italic>/* brokerName */</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>clusterAddrTable</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#8f5902;font-style:italic>/* brokerAddr */</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BrokerLiveInfo</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>brokerLiveTable</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#8f5902;font-style:italic>/* brokerAddr */</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#8f5902;font-style:italic>/* Filter Server */</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>filterServerTable</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h5 id=topicqueuetable>topicQueueTable</h5><p>key：存储的是topic, value:QueueData的列表。QueueData 的集合 size 等于 Topic 对应的 Broker Master 的个数。下面来看一下QueueData数据结构：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>QueueData</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Comparable</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>QueueData</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>brokerName</span><span style=color:#ce5c00;font-weight:700>;</span>   <span style=color:#8f5902;font-style:italic>//broker 名字
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>readQueueNums</span><span style=color:#ce5c00;font-weight:700>;</span>   <span style=color:#8f5902;font-style:italic>//可读 queue 数
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>writeQueueNums</span><span style=color:#ce5c00;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>//可写 queue 数 
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>perm</span><span style=color:#ce5c00;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>//读写权限
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>topicSynFlag</span><span style=color:#ce5c00;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>//同步标识
</span><span style=color:#8f5902;font-style:italic></span>    
    <span style=color:#8f5902;font-style:italic>//............
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h5 id=brokeraddrtable>brokerAddrTable</h5><p>key：broker的名称</p><p>value: broker的相关信息</p><p>下面来看一下BrokerData数据结构：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BrokerData</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Comparable</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BrokerData</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>cluster</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//集群名称
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>brokerName</span><span style=color:#ce5c00;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>//broker名称
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//brokerId和broker的地址
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Long</span><span style=color:#8f5902;font-style:italic>/* brokerId */</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#8f5902;font-style:italic>/* broker address */</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>brokerAddrs</span><span style=color:#ce5c00;font-weight:700>;</span> 
	
    <span style=color:#8f5902;font-style:italic>//............
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h5 id=clusteraddrtable>clusterAddrTable</h5><p>key存储的是 clusterName 的名称， value 存储的是 brokerName 的集合</p><h5 id=brokerlivetable>brokerLiveTable</h5><p>key 存储的是 brokerAddr(IP:port) 信息，value 存储的是 BrokerLiveInfo 信息，BrokerLiveInfo 中存储了 Broker 的实时状态。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BrokerLiveInfo</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>lastUpdateTimestamp</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//最新更新时间
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>DataVersion</span> <span style=color:#000>dataVersion</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//数据版本
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Channel</span> <span style=color:#000>channel</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>haServerAddr</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>NamesrvController.initialize() 中有一个schedule定时任务，每个10秒钟定时调用 scanNotActiveBroker() 方法进行扫描不活动的 Broker，并把不活动的 Broker 删除掉，就是判断的 这个 lastUpdateTimestamp 这个数据。如果超过两分钟没有更新lastUpdateTimestamp这个值。就认为当前这个Broker不可用。</p><h5 id=filterservertable>filterServerTable</h5><p>key 存储的是 brokerAddr 信息，value 存储的是 Filter Server 信息。Filter Server 是消息的过滤服务器，一个 Broker 可以对应多个 Filter Server。</p><h4 id=28-namesrvcontrollerstart>2.8 NamesrvController.start</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//启动监听服务
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remotingServer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fileWatchService</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fileWatchService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=3-总结>3. 总结</h3><p>通过分析启动流程图如下：</p><p><img src="https://github.com/mxsm/document/blob/master/image/MQ/RocketMQ/NameServerStartProcess.png?raw=true" alt></p></div><div class=td-content style=page-break-before:always><h1 id=pg-039627ec513fed111ae3e49aaa0ad4d0>3 - RocketMQ源码解析-NameServer对Broker的管理</h1><blockquote><p>以下源码基于Rocket MQ 4.8.0</p></blockquote><p>前面的 <a href=https://blog.ljbmxsm.com/middlewares/rocketmq/name-server/rocketmq-analysis-nameserver-start/>RocketMQ源码解析-NameServer启动</a>已经知道NameServer的两大功能：</p><ul><li>Broker管理</li><li>路由管理</li></ul><p>NameServer可以部署多个，相互之间独立，其他角色同时向多个NameServer上报状态信息，从而达到热备份的目的。NameServer本身是无状态的，也就是说NameServer中的Broker、Topic等信息都不会持久化，都是由各个角色定时上报并存储到内存中的（NameServer支持参数的持久化，一般用不到）。</p><p>下面就来结合源码以及项目运行添加打印日志来具体分析一下NameServer是如何对Broker进行管理的。</p><h3 id=1-broker元数据>1. Broker元数据</h3><p>当Broker启动，会向NameServer注册当前broker的信息。在NameServer通过 <strong><code>BrokerData</code></strong> 来保存Broker的元数据信息：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BrokerData</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Comparable</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BrokerData</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>cluster</span><span style=color:#ce5c00;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>//broker集群名称
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>brokerName</span><span style=color:#ce5c00;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>//broker名称
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Long</span><span style=color:#8f5902;font-style:italic>/* brokerId */</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#8f5902;font-style:italic>/* broker address */</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>brokerAddrs</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//broker Id和broker地址的映射关系
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>我们通过打印日志来看一下这个里面的数据具体包含了那些数据，日志添加在 <strong><code>RouteInfoManager#registerBroker</code></strong> 方法中：</p><p><img src="https://github.com/mxsm/picture/blob/main/rocketmq/nameserverborker%E5%85%83%E6%95%B0%E6%8D%AE%E6%B7%BB%E5%8A%A0%E6%97%A5%E5%BF%97.png?raw=true" alt></p><p>添加好后我们配置好broker的配置文件：</p><p><img src="https://github.com/mxsm/picture/blob/main/rocketmq/brokerconfig%E9%85%8D%E7%BD%AE.png?raw=true" alt></p><p>然后首先启动NameServer，再启动broker如下图：</p><p><img src="https://github.com/mxsm/picture/blob/main/rocketmq/brokerdata%E5%85%83%E6%95%B0%E6%8D%AE%E6%89%93%E5%8D%B0%E9%AA%8C%E8%AF%81.gif?raw=true" alt></p><p>打印的元数据如下：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>打印BrokerData元数据信息:<span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;brokerAddrs&#34;</span>:<span style=color:#ce5c00;font-weight:700>{</span>0:<span style=color:#4e9a06>&#34;169.254.144.194:10911&#34;</span><span style=color:#ce5c00;font-weight:700>}</span>,<span style=color:#4e9a06>&#34;brokerName&#34;</span>:<span style=color:#4e9a06>&#34;mxsm-1&#34;</span>,<span style=color:#4e9a06>&#34;cluster&#34;</span>:<span style=color:#4e9a06>&#34;MxsmClusterName&#34;</span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=2-broker存活状态管理>2. Broker存活状态管理</h3><p>Broker的存活状态管理分为两种：</p><ul><li><p><strong>Broker正常下线</strong></p><p>Broker正常下线会给NameServer发送一个 <strong><code>RequestCode.UNREGISTER_BROKER</code></strong> 。然后调用最终调用 <strong><code>RouteInfoManager#unregisterBroker</code></strong> 方法来注销</p></li><li><p><strong>Broker异常下线，NameServer通过定时任务扫描</strong></p><p>定时任务在NameServer启动的时候创建</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scheduledExecutorService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scheduleAtFixedRate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>NamesrvController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>routeInfoManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scanNotActiveBroker</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SECONDS</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>每10秒执行一次。调用 <strong><code>RouteInfoManager#scanNotActiveBroker</code></strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>scanNotActiveBroker</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Iterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BrokerLiveInfo</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>it</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>brokerLiveTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>entrySet</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>iterator</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>it</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasNext</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BrokerLiveInfo</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>it</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>last</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getLastUpdateTimestamp</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>//private final static long BROKER_CHANNEL_EXPIRED_TIME = 1000 * 60 * 2;
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>last</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>BROKER_CHANNEL_EXPIRED_TIME</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>RemotingUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>closeChannel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getChannel</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#000>it</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The broker channel expired, {} {}ms&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getKey</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>BROKER_CHANNEL_EXPIRED_TIME</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>onChannelDestroy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getKey</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getChannel</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过上面的代码可以发现120秒没有更新NameServer中当Broker的状态。后将连接关闭，同时需要清除这些已关闭连接的 broker 的路由信息。这部分则是在<code>onChannelDestroy</code>方法中</p></li></ul><h3 id=3-topic的信息>3. Topic的信息</h3><p>在 <strong><code>RouteInfoManager</code></strong> 类中有一个变量 <strong><code>topicQueueTable</code></strong> 这个变量用来保存Topic和Broker之间的读写队列数和权限。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#8f5902;font-style:italic>/* topic */</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>QueueData</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>topicQueueTable</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>QueueData</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Comparable</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>QueueData</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//broker名称
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>brokerName</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>//读的队列数
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>readQueueNums</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>//写的队列数
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>writeQueueNums</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>//读写权限
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>perm</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>topicSynFlag</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list"><a class=text-white target=_blank rel="noopener noreferrer" href=https://groups.google.com/u/1/g/ljbmxsm><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=个人掘金主页 aria-label=个人掘金主页><a class=text-white target=_blank rel="noopener noreferrer" href=https://juejin.cn/user/1151943918492855><i class="fab fa-twitter"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/mxsm><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2022 The Docsy Authors All Rights Reserved</small>
<small class=ml-1><a href=https://policies.google.com/privacy target=_blank>隐私政策</a></small><p class=mt-2><a href=/about/>Home</a></p></div></div></div></footer><div><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css><script src=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js></script><script>$("p img").wrap(function(){return'<a data-fancybox="gallery" href="'+$(this).attr('src')+'"></a>'})</script></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/mermaid@8.8.1/dist/mermaid.min.js integrity=sha384-to2w0I1OqmbJ9J6yTnIX+KYU8grNpZoD1dKPLjgEJvMe5L5+/7qvuNa2sQo8WAWj crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/raphael/2.3.0/raphael.min.js integrity="sha512-tBzZQxySO5q5lqwLWfu8Q+o4VkTcRGOeQGVQ0ueJga4A1RKuzmAu5HXDOXLEjpbKyV7ow9ympVoa6wZLEzRzDg==" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.15.0/flowchart.min.js integrity="sha512-6QsSiIybtf8tuZ6xfjRTr2tdtw3Gp4q5RSCh2b6q9seoKEQmhAG1RrCA8F0kXTwivVxRVbp/YF3zOh8rvEAU7Q==" crossorigin=anonymous></script><script src=/js/main.min.b541b310f01941a0abfd76b652b5fb60dac470573775bb5b31ff08fe3f6cea51.js integrity="sha256-tUGzEPAZQaCr/Xa2UrX7YNrEcFc3dbtbMf8I/j9s6lE=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.js></script><script type=text/javascript>docsearch({appId:'JO2SY3WDAC',apiKey:'324ddb3b679c1308e5aa8bf222e07f8b',indexName:'mxsm',inputSelector:'.td-search-input',debug:!1})</script></body></html>