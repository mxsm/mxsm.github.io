<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.83.1"><link rel=canonical type=text/html href=/spring-framework/><link rel=alternate type=application/rss+xml href=/spring-framework/index.xml><meta name=ROBOTS content="INDEX, FOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Spring Framework | 蚂蚁背大象</title><meta property="og:title" content="Spring Framework"><meta property="og:description" content="蚂蚁背大象博客"><meta property="og:type" content="website"><meta property="og:url" content="/spring-framework/"><meta property="og:site_name" content="蚂蚁背大象"><meta itemprop=name content="Spring Framework"><meta itemprop=description content="蚂蚁背大象博客"><meta name=twitter:card content="summary"><meta name=twitter:title content="Spring Framework"><meta name=twitter:description content="蚂蚁背大象博客"><link rel=preload href=/scss/main.min.e09cb23c7dff3bf1285aa0294bcdc4ac8194fb3425a99c621e31e7b871315685.css as=style><link href=/scss/main.min.e09cb23c7dff3bf1285aa0294bcdc4ac8194fb3425a99c621e31e7b871315685.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 321.39 78.54"><title id="title19">DUBBO LOGO</title><path class="cls-1" d="M68.46 50.38c0 14.06 11.39 22.11 25.45 22.11s25.45-8.05 25.45-22.11V7.25H68.46zm21.24-28h8.6V31H89.7zm0 22.25h8.6v8.6H89.7zM33.24 7.25H4.06v64H33.24c10.95.0 19.3-7.18 23.29-17.15a45.12 45.12.0 002.38-14.87A45.12 45.12.0 0056.53 24.4C52.84 14.62 44.19 7.25 33.24 7.25zm.43 14.63H30.34a3.44 3.44.0 00-3.44 3.44V53.23a3.44 3.44.0 003.44 3.44h3.33v4.63h-8.3a6.87 6.87.0 01-6.87-6.87V24.12a6.87 6.87.0 016.87-6.87h8.3zM285.51 6.06c-17.05.0-30.88 10.28-30.88 33.21s13.83 33.21 30.88 33.21 30.88-10.28 30.88-33.21S302.56 6.06 285.51 6.06zm7.59 48.36a6.87 6.87.0 01-6.87 6.87h-8.3V56.67h3.33a3.44 3.44.0 003.44-3.44V25.31a3.44 3.44.0 00-3.44-3.44h-3.33V17.25h8.3a6.87 6.87.0 016.87 6.87zm-53.4-17.56A17.39 17.39.0 00227.31 7.25H195.1v64h32.21a19.44 19.44.0 0012.38-34.44zM211.63 61.29h-6.08l18.68-44h6.08zM177 36.85A17.39 17.39.0 00164.65 7.25H132.43v64h32.21A19.44 19.44.0 00177 36.85zM149 61.29h-6.08l18.68-44h6.08z" style="fill:#fff;fill-opacity:1"/></svg></span><span class="text-uppercase font-weight-bold">蚂蚁背大象</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/about/><span>Home</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog/><span>Java</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/spring/><span>Spring</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/middlewares/><span>Middleware</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/><span>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/other/><span>Others</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community/><span>Community</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002 站内搜索…" aria-label=站内搜索… autocomplete=off></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/spring-framework/>Return to the regular view of this page</a>.</p></div><h1 class=title>Spring Framework</h1><ul><li>1: <a href=#pg-90df947ee63a185a279e4d8c55a89209>Spring framework核心源码分析</a></li><ul><li>1.1: <a href=#pg-14d3332f4bff2e60fa8489a31e8d9650>Spring ApplicationContext源码解析</a></li><li>1.2: <a href=#pg-289a8749d7e1546045048447bd1210c1>AnnotationConfigApplicationContext源码解析</a></li><li>1.3: <a href=#pg-17c0acff0e1aafa06a377a7137ea33ca>RootBeanDefinition、ChildBeanDefinition、GenericBeanDefinition的区别</a></li><li>1.4: <a href=#pg-2caccf5b289e1209701c45f1441bb710>SpringBean循环依赖源码解析</a></li><li>1.5: <a href=#pg-0daf754d096d45688a6b1c2f570fe4ad>BeanPostProcessor讲解</a></li><li>1.6: <a href=#pg-fc39ad1be2759add85e4fdc5bf720481>BeanFactoryPostProcessor详解</a></li><li>1.7: <a href=#pg-91273e5f54a98b662481a8819ba6a8b8>ConfigurationClassPostProcessor源码解析</a></li><li>1.8: <a href=#pg-acb12be2c385f1c475156c9455ad6bc8>EnableTransactionManagement注解解析来看AOP</a></li><li>1.9: <a href=#pg-38018db3a0c618ec1942128421bd538f>Spring事务处理源码解析</a></li><li>1.10: <a href=#pg-a1cc39c86d11d869ef0a1ddc3cd7a874>Spring BeanPostProcessor执行顺序问题</a></li><li>1.11: <a href=#pg-39956fecc6d59f75d50963ba50e5e36a>Spring BeanFactoryPostProcessor执行顺序</a></li><li>1.12: <a href=#pg-2615c35b44fb6aeca773448025d3bf0f>BeanDefinition详解</a></li><li>1.13: <a href=#pg-abb7fad47b98204f5f6de5a9e8c54ac7>FactoryBean解析</a></li><li>1.14: <a href=#pg-e1d5790d737f798c0bb85785310337f2>Spring 生命周期</a></li><li>1.15: <a href=#pg-62c29b6f4d5e06f0614612c6a8964b80>BeanPostProcessor相关接口执行的方法</a></li><li>1.16: <a href=#pg-10c05e17c6be4f5167e0f8d9453d3407>Spring XML解析源码分析</a></li><li>1.17: <a href=#pg-454fafdb77c733b3d299b306329bd698>ClassPathXmlApplicationContext源码解析</a></li><li>1.18: <a href=#pg-791724054e8b5e939d8acc2be33472ab>doGetBean源码详解</a></li><li>1.19: <a href=#pg-dd9401b6ddf29fb70c6b2bdbf4a95e87>Spring Environment源码解析</a></li><li>1.20: <a href=#pg-2b171ac5fb8183ede5f1596b9887bac7>Spring中的Aware接口</a></li><li>1.21: <a href=#pg-82e1ce9fe3b5bbf0a1f47502a6efa2d7>Spring懒加载源码分析</a></li><li>1.22: <a href=#pg-65df0f64929033bf15b2d78139bd7a6d>Spring Event源码解析</a></li></ul><li>2: <a href=#pg-b653ad2f4e320e70e346c261d955ef79>Spring framework注解源码分析</a></li><ul><li>2.1: <a href=#pg-695935ff0bfbe0f2c238fcb68c3df0c3>Spring注解源码解析之-Autowired和Value</a></li><li>2.2: <a href=#pg-c8474c1505aab37e3c0c5c83e70ab818>spring注解源码解析之-Conditional</a></li><li>2.3: <a href=#pg-761d50c98cba02db1ead1d87e662790a>spring注解源码解析之-配置类注解</a></li><li>2.4: <a href=#pg-ad70ba79c485f9a0ef7697bee60b61d3></a></li><li>2.5: <a href=#pg-ecd58b2fb8515423e24d130e8b86d39e>Spring 注解解析顺序问题</a></li></ul><li>3: <a href=#pg-b67a84fc05c6c115957264660090c5e5>Spring framework Web</a></li><ul><li>3.1: <a href=#pg-3e5a172ebf59caee94c0ec24b4cd505c>深入了解WebApplicationInitializer是消除web.xml和springMVC的配置文件</a></li><li>3.2: <a href=#pg-159c8af60548b430c8c80fb041539a9c>Spring Web Context</a></li><li>3.3: <a href=#pg-2387078ff36b1ea96419cd7e49b5213c>ContextLoaderListener 源码分析</a></li><li>3.4: <a href=#pg-5bf9830d34c6f98ad218f7463014dc07>DispatcherServlet源码解析</a></li><li>3.5: <a href=#pg-86323df96176318d20347df112c2d8b8>RequestMappingHandlerAdapter源码分析</a></li></ul><li>4: <a href=#pg-74fe028b96d5028ff22b2f8a3f0fb26f>Spring framework自定义组件</a></li><ul><li>4.1: <a href=#pg-eee53f697176ba708c020f01a315d2f2>Spring如何自定义注解</a></li><li>4.2: <a href=#pg-d2df516e5940451ccde777d7fa16302e>Spring中的拓展原理实战</a></li><li>4.3: <a href=#pg-63daf4c3918e0827e10abe8ef6f0c982>如何自定义Spring xml Namespace</a></li><li>4.4: <a href=#pg-d9d3185ccb310af3074e989938732c03>Spring常用的拓展接口</a></li><li>4.5: <a href=#pg-9ef6c7c8e05cf224ed7e5b6d5784a4be>如何自定义Spring Enable注解</a></li><li>4.6: <a href=#pg-e9b562fd3c588f2ec24576edf98bdb90>基于Spring AOP自定义注解</a></li><li>4.7: <a href=#pg-290f19e8499fc5e37b1f625753d48ff7>Spring AOP+SpEL实现自定义模板记录日志</a></li><li>4.8: <a href=#pg-f0d137fc30ad03cd1d45c5cf75629dca>Spring如何解析自定义xml的源码解析</a></li><li>4.9: <a href=#pg-195638b3db3755434ef544b2442bd7a0>Spring中常用的工具类</a></li></ul><li>5: <a href=#pg-05e6f9829372f89023d299050eb42fe1>Spring Framework经验心得</a></li><ul><li>5.1: <a href=#pg-fd7ac9428e5086b0e31d32cf06cbb46d>Spring中那些容易混淆的类开发中该如何选择?</a></li><li>5.2: <a href=#pg-a39748a6b9c4bcc2d5ad12e417ca3f60>Spring框架中接口命名的艺术</a></li></ul><li>6: <a href=#pg-ac130328e68324a2d22762551ddb452b>Spring AOP</a></li><ul><li>6.1: <a href=#pg-558555ab5c968a88d9feed5056d11420>Spring AOP 源码解析</a></li><li>6.2: <a href=#pg-807b0f7da57723e93dc2a6125709842a>Spring AOP Apis</a></li><li>6.3: <a href=#pg-ce28d61df8b9d6bc324acecea0a0316a>Spring依赖注入时，什么时候会创建代理类</a></li><li>6.4: <a href=#pg-7eb10bd6dd8654757eef56a3b2f75658>Spring AOP应用之Spring事务管理</a></li><li>6.5: <a href=#pg-cef5de8587a30a40ec12e9e6e8ebbd48>Spring AOP应用之EnableAsync</a></li></ul><li>7: <a href=#pg-3cd9b40bbb171ac1d2c0c44255ebae82>spring framework使用过程中的问题</a></li><ul></ul></ul><div class=content><p>Spring framework源码解析，自定义组件使用过程中的问题。</p><h2 id=spring-framework-blog>Spring Framework Blog</h2><p>spring framework源码解析，自定义组件等等</p></div></div><div class=td-content style=page-break-before:always><h1 id=pg-90df947ee63a185a279e4d8c55a89209>1 - Spring framework核心源码分析</h1></div><div class=td-content><h1 id=pg-14d3332f4bff2e60fa8489a31e8d9650>1.1 - Spring ApplicationContext源码解析</h1><h3 id=1-applicationcontext源码解析>1. ApplicationContext源码解析</h3><p>在Spring框架的使用过程中见得最多的一个类就是 <strong><code>ApplicationContext</code></strong> 这个类贯穿了整个Spring的开发。下面来看一下该类的一些定义：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>ApplicationContext</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>EnvironmentCapable</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ListableBeanFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>HierarchicalBeanFactory</span><span style=color:#ce5c00;font-weight:700>,</span>
		<span style=color:#000>MessageSource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ApplicationEventPublisher</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ResourcePatternResolver</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#000>String</span> <span style=color:#000>getId</span><span style=color:#ce5c00;font-weight:700>();</span>

	<span style=color:#000>String</span> <span style=color:#000>getApplicationName</span><span style=color:#ce5c00;font-weight:700>();</span>

	<span style=color:#000>String</span> <span style=color:#000>getDisplayName</span><span style=color:#ce5c00;font-weight:700>();</span>

	<span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>getStartupDate</span><span style=color:#ce5c00;font-weight:700>();</span>

	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#000>ApplicationContext</span> <span style=color:#000>getParent</span><span style=color:#ce5c00;font-weight:700>();</span>

	<span style=color:#000>AutowireCapableBeanFactory</span> <span style=color:#000>getAutowireCapableBeanFactory</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从定义可以看出来，继承了 <strong><code>EnvironmentCapable</code></strong> , <strong><code>ListableBeanFactory</code></strong> , <strong><code>HierarchicalBeanFactory</code></strong> ,
<strong><code>MessageSource</code></strong> , <strong><code>ApplicationEventPublisher</code></strong> , <strong><code>ResourcePatternResolver</code></strong> 继承都是一些基础的接口。</p><ul><li><strong>BeanDefinitionRegistry</strong></li></ul><p>这个接口主要用来注册Bean的定义到Spring容器的上下文中，把Java类抽象为 <em><strong><code>BeanDefinition</code></strong></em></p><ul><li><strong>SingletonBeanRegistry</strong></li></ul><p>Bean的单例模式注册</p><ul><li><strong>BeanFactory</strong></li></ul><p>主要用来获取Bean， BeanFactory实现了这BeanDefinitionRegistry和SingletonBeanRegistry两个，把Bean的定义和Bean的管理结合起来。</p><ul><li><strong>Environment</strong></li></ul><p>获取环境变量，和环境配置相关的</p><ul><li><strong>MessageSource</strong></li></ul><p>spring的国际化处理</p><ul><li><strong>ApplicationEventPublisher</strong></li></ul><p>Spring时间发布，和事件相关的接口</p><ul><li><strong>ResourcePatternResolver</strong></li></ul><p>资源的处理</p><p>对于 <strong><code>ApplicationContext</code></strong> 的实现主要在 <strong>Java</strong> 的开发项目中有四个：</p><ul><li>ClassPathXmlApplicationContext</li><li>AnnotationConfigApplicationContext</li><li>XmlWebApplicationContext</li><li>AnnotationConfigWebApplicationContext</li></ul><pre><code class=language-mermaid data-lang=mermaid>graph LR
   
    B[Application] --&gt; C[XML]
    B[Application] --&gt; D[Annotation]
    C --&gt;C1[XmlWebApplicationContext]
    C --&gt;C2[ClassPathXmlApplicationContext]
    D --&gt;D1[AnnotationConfigApplicationContext]
    D --&gt;D2[AnnotationConfigWebApplicationContext]
</code></pre><blockquote><p>上面的四个实现大体能够分成两大类：</p><ul><li>对以前传统的XML配置的支持从xml读取配置</li><li>对注解的支持，主要通过注解来实现xml中的配置功能</li></ul></blockquote><p>下面看一下Application的继承关系：</p><p><img src="https://github.com/mxsm/document/blob/master/image/Spring/Springframework/ApplicationContext.png?raw=true" alt=图></p></div><div class=td-content style=page-break-before:always><h1 id=pg-289a8749d7e1546045048447bd1210c1>1.2 - AnnotationConfigApplicationContext源码解析</h1><h3 id=1-annotationconfigapplicationcontext>1. AnnotationConfigApplicationContext</h3><p>对于Application的实现是不同的，现在来分析一下常用的注解的实现。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AnnotationConfigApplicationContext</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>GenericApplicationContext</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>AnnotationConfigRegistry</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>//注解读取器
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>AnnotatedBeanDefinitionReader</span> <span style=color:#000>reader</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>//class path 扫码器
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ClassPathBeanDefinitionScanner</span> <span style=color:#000>scanner</span><span style=color:#ce5c00;font-weight:700>;</span>

	<span style=color:#8f5902;font-style:italic>//默认的构造方法
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>AnnotationConfigApplicationContext</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AnnotatedBeanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scanner</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassPathBeanDefinitionScanner</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>


	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>AnnotationConfigApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DefaultListableBeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AnnotatedBeanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scanner</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassPathBeanDefinitionScanner</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>


	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>AnnotationConfigApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;...</span> <span style=color:#000>annotatedClasses</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#000>register</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>annotatedClasses</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>refresh</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#8f5902;font-style:italic>//设置扫描包
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>AnnotationConfigApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>basePackages</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#000>scan</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>basePackages</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>refresh</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#ce5c00;font-weight:700>}</span>


	<span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setEnvironment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurableEnvironment</span> <span style=color:#000>environment</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setEnvironment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>environment</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setEnvironment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>environment</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scanner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setEnvironment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>environment</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>


	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setBeanNameGenerator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanNameGenerator</span> <span style=color:#000>beanNameGenerator</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBeanNameGenerator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanNameGenerator</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scanner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBeanNameGenerator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanNameGenerator</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>getBeanFactory</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>registerSingleton</span><span style=color:#ce5c00;font-weight:700>(</span>
				<span style=color:#000>AnnotationConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONFIGURATION_BEAN_NAME_GENERATOR</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanNameGenerator</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>


	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setScopeMetadataResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ScopeMetadataResolver</span> <span style=color:#000>scopeMetadataResolver</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setScopeMetadataResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>scopeMetadataResolver</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scanner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setScopeMetadataResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>scopeMetadataResolver</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>


	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>register</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;...</span> <span style=color:#000>annotatedClasses</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>notEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>annotatedClasses</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;At least one annotated class must be specified&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>register</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>annotatedClasses</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>


	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>scan</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>basePackages</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>notEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>basePackages</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;At least one base package must be specified&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scanner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scan</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>basePackages</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	
	<span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>,</span>
			<span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>Supplier</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>supplier</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinitionCustomizer</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>customizers</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>supplier</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>customizers</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote><p>从Spring的源码可以看出来，主要通过 this.scanner.scan(basePackages); 扫描对应的基础包下面的类来实现注入</p></blockquote><h3 id=2-classpathbeandefinitionscanner源码的分析>2. ClassPathBeanDefinitionScanner源码的分析</h3><p>通过这个类来扫描指定的class path下面的类的实例加载到Spring的容器中。并将符合过滤条件的类注册到IOC 容器内</p><blockquote><p>Mybatis 的Mapper注册器(ClassPathMapperScanner) 是同过继承ClassPathBeanDefinitionScanner,并且自定义了过滤器规则来实现的。具体的 调用过程并不会在这里说明，只是想在这里描述ClassPathBeanDefinitionScanner是如何 扫描 和 注册BeanDefinition的。</p></blockquote><p>过滤器分为两种：</p><ol><li>包含过滤器&ndash;includeFilters</li><li>排除过滤器&ndash;excludeFilters</li></ol><table><thead><tr><th>过滤器类型</th><th>示例表达式</th><th>备注</th><th>Spring中的实现类</th></tr></thead><tbody><tr><td>annotation</td><td>org.springframework.stereotype.Component</td><td>在目标组件的类型级别出现注解</td><td>AnnotationTypeFilter</td></tr><tr><td>assignable</td><td>指定的类或者接口</td><td>在目标组件指定类火灾接口</td><td>AssignableTypeFilter</td></tr><tr><td>AspectJ type</td><td>aspectj 表达式</td><td>满足aspectj 表达式的</td><td>AspectJTypeFilter</td></tr><tr><td>正则表达式</td><td>org.example.Default.*</td><td>类名满足正则表达式的</td><td>RegexPatternTypeFilter</td></tr><tr><td>custom</td><td>com.mxsm.MyTypeFilter</td><td>继承Spring的TypeFilter接口</td><td>TypeFilter</td></tr></tbody></table><p>从上面可以看出来Spring实现的有四个：AnnotationTypeFilter、AssignableTypeFilter、AspectJTypeFilter、RegexPatternTypeFilter。可以根据需要自行拓展</p><p>看一下默认的ClassPathBeanDefinitionScanner使用的默认includeFilters过滤器，(ClassPathScanningCandidateComponentProvider)</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerDefaultFilters</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
	    <span style=color:#8f5902;font-style:italic>//注解Component是其中一个
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>includeFilters</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AnnotationTypeFilter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Component</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>));</span>
		<span style=color:#000>ClassLoader</span> <span style=color:#000>cl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ClassPathScanningCandidateComponentProvider</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#8f5902;font-style:italic>//以及下面对JSR的规范的支持，如果没有对应的注解直接略过也不报错
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>includeFilters</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AnnotationTypeFilter</span><span style=color:#ce5c00;font-weight:700>(</span>
					<span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Annotation</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#000>ClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;javax.annotation.ManagedBean&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cl</span><span style=color:#ce5c00;font-weight:700>)),</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>));</span>
			<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;JSR-250 &#39;javax.annotation.ManagedBean&#39; found and supported for component scanning&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassNotFoundException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>// JSR-250 1.1 API (as included in Java EE 6) not available - simply skip.
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>includeFilters</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AnnotationTypeFilter</span><span style=color:#ce5c00;font-weight:700>(</span>
					<span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Annotation</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#000>ClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;javax.inject.Named&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cl</span><span style=color:#ce5c00;font-weight:700>)),</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>));</span>
			<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;JSR-330 &#39;javax.inject.Named&#39; annotation found and supported for component scanning&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassNotFoundException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>// JSR-330 API not available - simply skip.
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>扫描主要使用scan方法</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>scan</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>basePackages</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>beanCountAtScanStart</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinitionCount</span><span style=color:#ce5c00;font-weight:700>();</span>
        
        <span style=color:#8f5902;font-style:italic>//扫码配置基本 packages下面的类
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>doScan</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>basePackages</span><span style=color:#ce5c00;font-weight:700>);</span>

		<span style=color:#8f5902;font-style:italic>// 默认的情况下注入注解配置处理器--ConfigurationClassPostProcessor,
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#8f5902;font-style:italic>//AutowiredAnnotationBeanPostProcessor等Spring.自定义的处理器
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#8f5902;font-style:italic>//下面会分析一下这个工具类的这个方法
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>includeAnnotationConfig</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>AnnotationConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerAnnotationConfigProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinitionCount</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>beanCountAtScanStart</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过上面可以看出来主要是两个方法：</p><ul><li><p><strong>doScan</strong></p><p>这个主要用于Spring扫描输入的基本包下面的以及子包下面的类</p></li><li><p><strong>AnnotationConfigUtils.registerAnnotationConfigProcessors</strong></p><p>注入一些处理注解的配置的Processors，比如处理的注解：Autowired， Value等注解</p></li></ul><h4 id=21-classpathbeandefinitionscannerdoscan-方法的源码分析>2.1 ClassPathBeanDefinitionScanner#doScan 方法的源码分析</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>doScan</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>basePackages</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>notEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>basePackages</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;At least one base package must be specified&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>beanDefinitions</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
		<span style=color:#8f5902;font-style:italic>//加载不同的路径下面的包
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>basePackage</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>basePackages</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		    <span style=color:#8f5902;font-style:italic>//获取包下面的候选组件--过滤出来符合条件的，在AnnotationConfigApplicationContext
</span><span style=color:#8f5902;font-style:italic></span>		    <span style=color:#8f5902;font-style:italic>//创建的使用的默认的过滤器(包含过滤器和排除过滤器)
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinition</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>candidates</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>findCandidateComponents</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>basePackage</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinition</span> <span style=color:#000>candidate</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>candidates</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#8f5902;font-style:italic>//设置SCOP
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>ScopeMetadata</span> <span style=color:#000>scopeMetadata</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scopeMetadataResolver</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolveScopeMetadata</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setScope</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>scopeMetadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getScopeName</span><span style=color:#ce5c00;font-weight:700>());</span>
				<span style=color:#8f5902;font-style:italic>//生成bean name
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>String</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanNameGenerator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>generateBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#8f5902;font-style:italic>//处理普通的bean
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidate</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>AbstractBeanDefinition</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>postProcessBeanDefinition</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>AbstractBeanDefinition</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#8f5902;font-style:italic>// 处理注解类的Bean
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidate</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>AnnotatedBeanDefinition</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>AnnotationConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>processCommonDefinitionAnnotations</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>AnnotatedBeanDefinition</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#8f5902;font-style:italic>//判断beanName是否存在于Spring容器中
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>checkCandidate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>BeanDefinitionHolder</span> <span style=color:#000>definitionHolder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#8f5902;font-style:italic>//根据proxyMode是否创建代理
</span><span style=color:#8f5902;font-style:italic></span>					<span style=color:#000>definitionHolder</span> <span style=color:#ce5c00;font-weight:700>=</span>
							<span style=color:#000>AnnotationConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applyScopedProxyMode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>scopeMetadata</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>definitionHolder</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#000>beanDefinitions</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>definitionHolder</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#000>registerBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>definitionHolder</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>beanDefinitions</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这里来分析一下ClassPathScanningCandidateComponentProvider#findCandidateComponents方法，该方法的作用就是把basePackage下面的Java类转换为Spring的BeanDefinition</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinition</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>findCandidateComponents</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>basePackage</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>componentsIndex</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>indexSupportsIncludeFilters</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>addCandidateComponentsFromIndex</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>componentsIndex</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>basePackage</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>scanCandidateComponents</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>basePackage</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#8f5902;font-style:italic>//一下代码去除了Spring源码中的一些非必要的代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinition</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>scanCandidateComponents</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>basePackage</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinition</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>candidates</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
		<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>// 例如：classpath*:com.mxsm/**/*.class
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>String</span> <span style=color:#000>packageSearchPath</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ResourcePatternResolver</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CLASSPATH_ALL_URL_PREFIX</span> <span style=color:#ce5c00;font-weight:700>+</span>
					<span style=color:#000>resolveBasePackage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>basePackage</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#39;/&#39;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resourcePattern</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#8f5902;font-style:italic>//将指定package以及子包下面的类转化为Resource[]
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>Resource</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>resources</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getResourcePatternResolver</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getResources</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>packageSearchPath</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Resource</span> <span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>resources</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isReadable</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#8f5902;font-style:italic>//将Class的信息存储到MetadataReader中
</span><span style=color:#8f5902;font-style:italic></span>						<span style=color:#000>MetadataReader中</span> <span style=color:#000>metadataReader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getMetadataReaderFactory</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getMetadataReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
						<span style=color:#8f5902;font-style:italic>//调用过滤器来处理metadataReader--默认的是包含component
</span><span style=color:#8f5902;font-style:italic></span>						<span style=color:#8f5902;font-style:italic>//注解的类
</span><span style=color:#8f5902;font-style:italic></span>						<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isCandidateComponent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadataReader</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#8f5902;font-style:italic>//转化为扫描定义
</span><span style=color:#8f5902;font-style:italic></span>							<span style=color:#000>ScannedGenericBeanDefinition</span> <span style=color:#000>sbd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ScannedGenericBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadataReader</span><span style=color:#ce5c00;font-weight:700>);</span>
							<span style=color:#000>sbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
							<span style=color:#000>sbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
							<span style=color:#8f5902;font-style:italic>//再次判断 如果是实体类 返回true,如果是抽象类，但是抽象方法 被 @Lookup 注解注释返回true
</span><span style=color:#8f5902;font-style:italic></span>							<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isCandidateComponent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sbd</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
								<span style=color:#000>candidates</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sbd</span><span style=color:#ce5c00;font-weight:700>);</span>
							<span style=color:#ce5c00;font-weight:700>}</span>
							<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#8f5902;font-style:italic>//日志打印
</span><span style=color:#8f5902;font-style:italic></span>							<span style=color:#ce5c00;font-weight:700>}</span>
						<span style=color:#ce5c00;font-weight:700>}</span>
						<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
						    <span style=color:#8f5902;font-style:italic>//日志打印
</span><span style=color:#8f5902;font-style:italic></span>						<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionStoreException</span><span style=color:#ce5c00;font-weight:700>(</span>
								<span style=color:#4e9a06>&#34;Failed to read candidate component class: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#8f5902;font-style:italic>//日志打印
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IOException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionStoreException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;I/O failure during classpath scanning&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>candidates</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>


</code></pre></div><h4 id=22-annotationconfigutilsregisterannotationconfigprocessors源码分析>2.2 AnnotationConfigUtils.registerAnnotationConfigProcessors源码分析</h4><p>这个方法主要用于注册一些注解配置处理器例如注解：<strong>@Configuration</strong> 等等。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>registerAnnotationConfigProcessors</span><span style=color:#ce5c00;font-weight:700>(</span>
			<span style=color:#000>BeanDefinitionRegistry</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>Object</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

		<span style=color:#000>DefaultListableBeanFactory</span> <span style=color:#000>beanFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>unwrapDefaultListableBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDependencyComparator</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>AnnotationAwareOrderComparator</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setDependencyComparator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AnnotationAwareOrderComparator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>INSTANCE</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAutowireCandidateResolver</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>ContextAnnotationAutowireCandidateResolver</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAutowireCandidateResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ContextAnnotationAutowireCandidateResolver</span><span style=color:#ce5c00;font-weight:700>());</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>beanDefs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>8</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#8f5902;font-style:italic>//往Spring容器中注入ConfigurationClassPostProcessor -- 处理注解Configuration配置等等
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>RootBeanDefinition</span> <span style=color:#000>def</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurationClassPostProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>beanDefs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registerPostProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>));</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
        
        <span style=color:#8f5902;font-style:italic>//处理Autowired和Value注解以及javax.inject.Inject(JSR-330)注解的处理器
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>RootBeanDefinition</span> <span style=color:#000>def</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AutowiredAnnotationBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>beanDefs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registerPostProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>));</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>// 对 JSR-250 通用规范注解的处理.
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>jsr250Present</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>COMMON_ANNOTATION_PROCESSOR_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>RootBeanDefinition</span> <span style=color:#000>def</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CommonAnnotationBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>beanDefs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registerPostProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>COMMON_ANNOTATION_PROCESSOR_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>));</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>// 对JPA注解的注解处理
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>jpaPresent</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PERSISTENCE_ANNOTATION_PROCESSOR_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>RootBeanDefinition</span> <span style=color:#000>def</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>();</span>
			<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBeanClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PERSISTENCE_ANNOTATION_PROCESSOR_CLASS_NAME</span><span style=color:#ce5c00;font-weight:700>,</span>
						<span style=color:#000>AnnotationConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>()));</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassNotFoundException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span>
						<span style=color:#4e9a06>&#34;Cannot load optional framework class: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>PERSISTENCE_ANNOTATION_PROCESSOR_CLASS_NAME</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>beanDefs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registerPostProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>PERSISTENCE_ANNOTATION_PROCESSOR_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>));</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
        
        <span style=color:#8f5902;font-style:italic>//事件监听方法处理器
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>EVENT_LISTENER_PROCESSOR_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>RootBeanDefinition</span> <span style=color:#000>def</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>EventListenerMethodProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>beanDefs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registerPostProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>EVENT_LISTENER_PROCESSOR_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>));</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>//默认事件监听方法的处理
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>EVENT_LISTENER_FACTORY_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>RootBeanDefinition</span> <span style=color:#000>def</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DefaultEventListenerFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>beanDefs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registerPostProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>EVENT_LISTENER_FACTORY_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>));</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>beanDefs</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote><p>大部分Processor分为两类：<br>1 实现了 <strong>BeanPostProcessor</strong> 接口，主要用来处理Java类内部的注解。例如： @Value<br>2 实现了 <strong>BeanFactoryPostProcessor</strong> 接口，主要用来处理Java类上面的注解。例如：@Configuration</p></blockquote><p>通过这样的就把对应的注解都处理了。达到了和XML配置一样的效果。对于其中的类的代码会有专门的笔记对其进行详细的分析。</p><h3 id=3-总结加载过程>3 总结加载过程</h3><p>通过上面的源码对Spring的AnnotationConfigApplicationContext源码分析来总结一下对于注解的这个加载过程</p><ol><li><strong>创建AnnotationConfigApplicationContext的对象，设置需要加载的basePackages</strong></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-17c0acff0e1aafa06a377a7137ea33ca>1.3 - RootBeanDefinition、ChildBeanDefinition、GenericBeanDefinition的区别</h1><p>从RootBeanDefinition、ChildBeanDefinition、GenericBeanDefinition类图看一下：
<img src="https://github.com/mxsm/picture/blob/main/spring/RootBeanDefinition_uml.png?raw=true" alt=类图></p><p>本质上来说是没有太大的区别它们都继承了 AbstractBeanDefinition 、在它们各自的类中、并没有什么太大的特殊的逻辑、某种程度上来说、它们可以说是差别非常小的</p><ul><li>RootBeanDefinition可以单独作为一个BeanDefinition，也可以作为其他BeanDefinition的父类。但是他不能作为其他BeanDefinition的子类（可以去看源码，在setParentName的时候，会抛出一个异常）</li><li>ChildBeanDefinition相当于一个子类，不可以单独存在，必须要依赖一个父BeanDetintion。（最大的区别他的parentName属性是通过构造方法设置的，而且并没有提供一个无参构造方法给我们。)</li><li>GenericBeanDefinition是首选的</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-2caccf5b289e1209701c45f1441bb710>1.4 - SpringBean循环依赖源码解析</h1><h3 id=1-什么是spring-bean的循环依赖>1. 什么是Spring Bean的循环依赖</h3><p>两个或者两个以上的bean互相持有对方、最终形成 <strong>闭环</strong> 。如下图：</p><p><img src="https://github.com/mxsm/document/blob/master/image/Spring/Springframework/SpringBean%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8.png?raw=true" alt></p><p>A、B、C三个Bean形成了循环依赖。</p><p>Spring中循环依赖的场景有：</p><ol><li>构造函数循环依赖</li><li>Field属性循环依赖</li></ol><h3 id=2-怎么检查循环依赖>2. 怎么检查循环依赖</h3><p>检测循环依赖相对比较容易，Bean在创建的时候可以给该Bean打标，如果递归调用回来发现正在创建中的话，即说明了循环依赖了。</p><h3 id=3-spring怎么解决循环依赖>3. Spring怎么解决循环依赖</h3><p>在分析Spring源码中如何解决循环依赖的过程中前，我们先了解一下Spring的Bean的创建过程。简化后主要分为三个主要的步骤：</p><p><img src="https://github.com/mxsm/document/blob/master/image/Spring/Springframework/bean%E5%88%9B%E5%BB%BA%E7%9A%84%E4%B8%89%E4%B8%AA%E4%B8%BB%E8%A6%81%E6%AD%A5%E9%AA%A4.png?raw=true" alt></p><ol><li><strong>实例化</strong></li><li><strong>实例化好的Bean填充属性</strong></li><li><strong>初始化</strong></li></ol><blockquote><p>Bean的实例化和初始化的区别？</p><p>Java有以下几种方式创建类对象：</p><ul><li>利用new关键字</li><li>利用反射Class.newInstance</li><li>利用Constructor.newIntance(相比Class.newInstance多了有参和私有构造函数)</li><li>利用Cloneable/Object.clone()</li><li>利用反序列化</li></ul><p>这些都是讲的实例化。而初始化是Class实例化后的具体对象才来进行初始化。</p><p><strong><code>简单的说：实例化针对的是Class,而初始化针对的是实例对象。</code></strong></p></blockquote><h4 id=31-spring循环依赖解决的源码解析--52x的源码版本>3.1 Spring循环依赖解决的源码解析&ndash;5.2.X的源码版本</h4><p>Spring主要是通过缓存不同状态下的Bean来解决循环依赖的问题，下面看一下 <strong><code>DefaultSingletonBeanRegistry</code></strong> 类中的三个缓存变量：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#8f5902;font-style:italic>/** 单例对象缓存 */</span>
	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>singletonObjects</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConcurrentHashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>256</span><span style=color:#ce5c00;font-weight:700>);</span>

	<span style=color:#8f5902;font-style:italic>/** 单例对象工厂缓存 */</span>
	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>singletonFactories</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>16</span><span style=color:#ce5c00;font-weight:700>);</span>

	<span style=color:#8f5902;font-style:italic>/** 提前暴露对象缓存 */</span>
	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>earlySingletonObjects</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>16</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>三个缓存的作用简单说明：</p><table><thead><tr><th>缓存</th><th>作用</th></tr></thead><tbody><tr><td>singletonObjects</td><td>用于存放完全初始化好的 bean，从该缓存中取出的 bean 可以直接使用</td></tr><tr><td>singletonFactories</td><td>存放原始的 bean 对象（尚未填充属性），用于解决循环依赖</td></tr><tr><td>earlySingletonObjects</td><td>提前暴光的单例对象的Cache，用于解决循环依赖（没有init）</td></tr></tbody></table><p>下面来看一下创建Bean实例的主要一个方法 <strong>AbstractBeanFactory#doGetBean</strong>：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>T</span> <span style=color:#000>doGetBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>,</span>
			<span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>typeCheckOnly</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>

		<span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>transformedBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>

		<span style=color:#8f5902;font-style:italic>// 检查单例缓存是否有手动注册的单例
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>Object</span> <span style=color:#000>sharedInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sharedInstance</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>args</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>//删除日志打印代码
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sharedInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>//判断是否在创建中
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isPrototypeCurrentlyInCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCurrentlyInCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>

			<span style=color:#8f5902;font-style:italic>// 检查parentBeanFactory是否存在调用parentBeanFactory的getBean方法
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>BeanFactory</span> <span style=color:#000>parentBeanFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getParentBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentBeanFactory</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>containsBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#8f5902;font-style:italic>// Not found -&gt; check parent.
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>String</span> <span style=color:#000>nameToLookup</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>originalBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentBeanFactory</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>AbstractBeanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>AbstractBeanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>parentBeanFactory</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>doGetBean</span><span style=color:#ce5c00;font-weight:700>(</span>
							<span style=color:#000>nameToLookup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>typeCheckOnly</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#8f5902;font-style:italic>// Delegation to parent with explicit args.
</span><span style=color:#8f5902;font-style:italic></span>					<span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>parentBeanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nameToLookup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requiredType</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#8f5902;font-style:italic>// No args -&gt; delegate to standard getBean method.
</span><span style=color:#8f5902;font-style:italic></span>					<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>parentBeanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nameToLookup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>parentBeanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nameToLookup</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>

			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>typeCheckOnly</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>markBeanAsCreated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>

			<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getMergedLocalBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#000>checkMergedBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>

				<span style=color:#8f5902;font-style:italic>// 确保当前bean依赖的bean的初始化
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>dependsOn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDependsOn</span><span style=color:#ce5c00;font-weight:700>();</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dependsOn</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>dep</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>dependsOn</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isDependent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>dep</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
							<span style=color:#8f5902;font-style:italic>//抛错BeanCreationException
</span><span style=color:#8f5902;font-style:italic></span>						<span style=color:#ce5c00;font-weight:700>}</span>
						<span style=color:#000>registerDependentBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dep</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
						<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
							<span style=color:#000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dep</span><span style=color:#ce5c00;font-weight:700>);</span>
						<span style=color:#ce5c00;font-weight:700>}</span>
						<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NoSuchBeanDefinitionException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
							<span style=color:#8f5902;font-style:italic>//抛错BeanCreationException
</span><span style=color:#8f5902;font-style:italic></span>						<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#ce5c00;font-weight:700>}</span>

				<span style=color:#8f5902;font-style:italic>// 创建Bean--单例模式、原型模式、根据Scop来创建三种
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>sharedInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
							<span style=color:#8f5902;font-style:italic>//关键方法
</span><span style=color:#8f5902;font-style:italic></span>							<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
							<span style=color:#8f5902;font-style:italic>//删除了部分无关紧要的代码
</span><span style=color:#8f5902;font-style:italic></span>					<span style=color:#ce5c00;font-weight:700>});</span>
					<span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sharedInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>

				<span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isPrototype</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#8f5902;font-style:italic>// It&#39;s a prototype -&gt; create a new instance.
</span><span style=color:#8f5902;font-style:italic></span>					<span style=color:#000>Object</span> <span style=color:#000>prototypeInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
					<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#000>beforePrototypeCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
						<span style=color:#000>prototypeInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#000>afterPrototypeCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prototypeInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>

				<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>String</span> <span style=color:#000>scopeName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getScope</span><span style=color:#ce5c00;font-weight:700>();</span>
					<span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Scope</span> <span style=color:#000>scope</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scopes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>scopeName</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>scope</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;No Scope registered for scope name &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>scopeName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#000>Object</span> <span style=color:#000>scopedInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>scope</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
							<span style=color:#000>beforePrototypeCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
							<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
								<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
							<span style=color:#ce5c00;font-weight:700>}</span>
							<span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
								<span style=color:#000>afterPrototypeCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
							<span style=color:#ce5c00;font-weight:700>}</span>
						<span style=color:#ce5c00;font-weight:700>});</span>
						<span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>scopedInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IllegalStateException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#8f5902;font-style:italic>//抛错BeanCreationException
</span><span style=color:#8f5902;font-style:italic></span>					<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>cleanupAfterBeanCreationFailure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>// 检查所需的类型是否与实际bean实例的类型匹配
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requiredType</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>T</span> <span style=color:#000>convertedBean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getTypeConverter</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>convertIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>convertedBean</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanNotOfRequiredTypeException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>());</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>convertedBean</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TypeMismatchException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#8f5902;font-style:italic>//抛错BeanNotOfRequiredTypeException
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>下面我们用流程图来梳理一下这一段代码的逻辑：</p><p><img src="https://github.com/mxsm/picture/blob/main/spring/spring%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E8%A7%A3%E5%86%B3%E6%B5%81%E7%A8%8B%E5%9B%BE.png?raw=true" alt></p><p>通过上面的源码可以看出来 <em><strong><code>Object sharedInstance = getSingleton(beanName)</code></strong></em> 调用获取是否在缓存中存在。看一下代码</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#5c35cc;font-weight:700>@Nullable</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>allowEarlyReference</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>//从 singletonObjects 获取实例，singletonObjects 中的实例都是准备好的 bean 实例，可以直接使用
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Object</span> <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#8f5902;font-style:italic>// 判断 beanName 对应的 bean 是否正在创建中
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>isSingletonCurrentlyInCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonObjects</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>//// 从 earlySingletonObjects 中获取提前曝光的 bean
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlySingletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>allowEarlyReference</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#8f5902;font-style:italic>// 获取相应的 bean 工厂
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>singletonFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonFactories</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonFactory</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>// 提前曝光 bean 实例（raw bean），用于解决循环依赖
</span><span style=color:#8f5902;font-style:italic></span>						<span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>singletonFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#8f5902;font-style:italic>// 将 singletonObject 放入earlySingletonObjects缓存中，并将 singletonFactory 从缓存中移除
</span><span style=color:#8f5902;font-style:italic></span>						<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlySingletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>singletonObject</span><span style=color:#ce5c00;font-weight:700>);</span>
						<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonFactories</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>singletonObject</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>看一下单例模式的创建的 <em><strong><code>AbstractAutowireCapableBeanFactory#createBean</code></strong></em> 方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanCreationException</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>//删除部分无关紧要的代码
</span><span style=color:#8f5902;font-style:italic></span>
		<span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbdToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>resolvedClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveBeanClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolvedClass</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasBeanClass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClassName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>mbdToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBeanClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolvedClass</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

			<span style=color:#8f5902;font-style:italic>//准备方法重写
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prepareMethodOverrides</span><span style=color:#ce5c00;font-weight:700>();</span>
			
    		<span style=color:#8f5902;font-style:italic>//执行InstantiationAwareBeanPostProcessor#postProcessBeforeInstantiation的方法
</span><span style=color:#8f5902;font-style:italic></span>    		<span style=color:#8f5902;font-style:italic>//如果bean不等于NULL还会执行BeanPostProcessor#postProcessAfterInitialization
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>Object</span> <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveBeforeInstantiation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#8f5902;font-style:italic>//创建Bean
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>Object</span> <span style=color:#000>beanInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>doCreateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>

	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从代码可以看出来如果存在 <em><strong><code>InstantiationAwareBeanPostProcessor</code></strong></em> 处理器，调用 <strong><code>InstantiationAwareBeanPostProcessor#postProcessBeforeInstantiation</code></strong> 方法。如果该方法执行的返回的Bean是空就调用 <em><strong><code>AbstractAutowireCapableBeanFactory#doCreateBean</code></strong></em> 方法。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-0daf754d096d45688a6b1c2f570fe4ad>1.5 - BeanPostProcessor讲解</h1><blockquote><p>Spring Framework版本 5.3.4</p></blockquote><h3 id=1-beanpostprocessor是干什么的>1. BeanPostProcessor是干什么的？</h3><p>BeanPostProcessor接口作用是：如果我们需要在Spring容器完成Bean的实例化、配置和其他的初始化前后添加一些自己的逻辑处理，我们就可以定义一个或者多个BeanPostProcessor接口的实现，然后注册到容器中。(类似于拦截器和过滤器)。<br>BeanPostProcessor分为三大类如下图：
<img src="https://github.com/mxsm/picture/blob/main/spring/BeanPostProcessor%E5%88%86%E7%B1%BB.png?raw=true" alt=图></p><ul><li>实例化</li><li>初始化</li><li>销毁</li></ul><blockquote><p>Bean实例化会执行 <strong>InstantiationAwareBeanPostProcessor</strong> 、 <strong>SmartInstantiationAwareBeanPostProcessor</strong> 这两类处理器，Bean实例化后每个bean就会通过 <strong>BeanPostProcessor</strong> 、 <strong>MergedBeanDefinitionPostProcessor</strong> 实现的类的处理。Bean销毁会通过 <strong>DestructionAwareBeanPostProcessor</strong> 处理器。</p></blockquote><p>Spring Bean的实例化图解：</p><p><img src="https://github.com/mxsm/document/blob/master/image/Spring/Springframework/bean%E5%AE%9E%E4%BE%8B%E5%8C%96%E8%BF%87%E7%A8%8B.png?raw=true" alt=图></p><p>在检查完 <strong>Aware</strong> 接口后，就开始调用 <strong>BeanPostProcessor</strong> 进行前置处理后后置处理。下面来看一下Spring中的几类继承：</p><ul><li><p>AOP相关的</p><p><img src="https://github.com/mxsm/document/blob/master/image/Spring/Springframework/BeanPostProcessor-aop.png?raw=true" alt=图></p></li><li><p>bean 和 context相关的</p><p><img src="https://github.com/mxsm/document/blob/master/image/Spring/Springframework/BeanPostProcessor-core.png?raw=true" alt=图></p></li><li><p>Spring Boot相关的实现</p><p><img src="https://github.com/mxsm/document/blob/master/image/Spring/Springframework/BeanPostProcessor-springboot.png?raw=true" alt=图></p></li></ul><p>BeanPostProcessor是在Bean实例化后，在自定义初始化方法前后执行。</p><h3 id=2-beanpostprocessor>2. BeanPostProcessor</h3><p>处理器定义了Bean <strong><code>初始化</code></strong> 前后执行的方法。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>BeanPostProcessor</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#8f5902;font-style:italic>//自定义初始化方法之前执行
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#204a87;font-weight:700>default</span> <span style=color:#000>Object</span> <span style=color:#000>postProcessBeforeInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#8f5902;font-style:italic>//自定义初始化方法之后执行
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#204a87;font-weight:700>default</span> <span style=color:#000>Object</span> <span style=color:#000>postProcessAfterInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote><p>代码示例地址：https://github.com/mxsm/spring-sample/tree/master/spring-beanPostProcessor</p></blockquote><p>代码演示：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyBeanPostProcessor</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>BeanPostProcessor</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>postProcessBeforeInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span> <span style=color:#4e9a06>&#34; ----before----- &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>


    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>postProcessAfterInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span> <span style=color:#4e9a06>&#34; ----after----- &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TestBean</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>init</span><span style=color:#ce5c00;font-weight:700>(){</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;TestBean---init()&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;test&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;beans</span> <span style=color:#c4a000>xmlns=</span><span style=color:#4e9a06>&#34;http://www.springframework.org/schema/beans&#34;</span>
       <span style=color:#c4a000>xmlns:xsi=</span><span style=color:#4e9a06>&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
       <span style=color:#c4a000>xmlns:context=</span><span style=color:#4e9a06>&#34;http://www.springframework.org/schema/context&#34;</span>
       <span style=color:#c4a000>xsi:schemaLocation=</span><span style=color:#4e9a06>&#34;http://www.springframework.org/schema/beans
</span><span style=color:#4e9a06>        https://www.springframework.org/schema/beans/spring-beans.xsd
</span><span style=color:#4e9a06>        http://www.springframework.org/schema/context
</span><span style=color:#4e9a06>        https://www.springframework.org/schema/context/spring-context.xsd&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>

    <span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;testBean&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;com.github.mxsm.bean.TestBean&#34;</span> <span style=color:#c4a000>init-method=</span><span style=color:#4e9a06>&#34;init&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>

    <span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;com.github.mxsm.processor.MyBeanPostProcessor&#34;</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;myBeanPostProcessor&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>

<span style=color:#204a87;font-weight:700>&lt;/beans&gt;</span>
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ApplicationBoot</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span> <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#000>ApplicationContext</span> <span style=color:#000>applicationContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;application.xml&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>TestBean</span> <span style=color:#000>testBean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TestBean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>testBean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>

    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><img src="https://github.com/mxsm/document/blob/master/image/Spring/Springframework/BeanPostProcessor%E4%BB%A3%E7%A0%81%E6%BC%94%E7%A4%BA.png?raw=true" alt=图示></p><p>通过代码可以看出来执行结果。</p><h3 id=3-instantiationawarebeanpostprocessor>3. <strong>InstantiationAwareBeanPostProcessor</strong></h3><p>该处理器定义了Bean <strong><code>实例化</code></strong> 前后执行的方法。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>InstantiationAwareBeanPostProcessor</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BeanPostProcessor</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//实例化之前
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#204a87;font-weight:700>default</span> <span style=color:#000>Object</span> <span style=color:#000>postProcessBeforeInstantiation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span> 
        <span style=color:#8f5902;font-style:italic>//这里可以自定义代理类
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>//实例化后-但是执行在初始化之前
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>postProcessAfterInstantiation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>//处理bean的Properties值
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#204a87;font-weight:700>default</span> <span style=color:#000>PropertyValues</span> <span style=color:#000>postProcessProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PropertyValues</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span>
			<span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>

		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=4destructionawarebeanpostprocessor>4.DestructionAwareBeanPostProcessor</h3><p>该处理器了销毁Bean之前的操作。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>DestructionAwareBeanPostProcessor</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BeanPostProcessor</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#8f5902;font-style:italic>//bean销毁之前
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>postProcessBeforeDestruction</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span><span style=color:#ce5c00;font-weight:700>;</span>

	<span style=color:#8f5902;font-style:italic>//bean是否需要销毁
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>requiresDestruction</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div><h3 id=5-看一下spring自身的实现>5. 看一下Spring自身的实现</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ApplicationContextAwareProcessor</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>BeanPostProcessor</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ConfigurableApplicationContext</span> <span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>;</span>

	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>StringValueResolver</span> <span style=color:#000>embeddedValueResolver</span><span style=color:#ce5c00;font-weight:700>;</span>


	<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>	 * Create a new ApplicationContextAwareProcessor for the given context.
</span><span style=color:#8f5902;font-style:italic>	 */</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ApplicationContextAwareProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurableApplicationContext</span> <span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>embeddedValueResolver</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>EmbeddedValueResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanFactory</span><span style=color:#ce5c00;font-weight:700>());</span>
	<span style=color:#ce5c00;font-weight:700>}</span>


	<span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>postProcessBeforeInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>AccessControlContext</span> <span style=color:#000>acc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>

		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSecurityManager</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
				<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>EnvironmentAware</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>bean</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>EmbeddedValueResolverAware</span> <span style=color:#ce5c00;font-weight:700>||</span>
						<span style=color:#000>bean</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>ResourceLoaderAware</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>bean</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>ApplicationEventPublisherAware</span> <span style=color:#ce5c00;font-weight:700>||</span>
						<span style=color:#000>bean</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>MessageSourceAware</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>bean</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>ApplicationContextAware</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>acc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanFactory</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getAccessControlContext</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>acc</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doPrivileged</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>PrivilegedAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>invokeAwareInterfaces</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>acc</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>invokeAwareInterfaces</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>invokeAwareInterfaces</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Aware</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>EnvironmentAware</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>EnvironmentAware</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>setEnvironment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>());</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>EmbeddedValueResolverAware</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>EmbeddedValueResolverAware</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>setEmbeddedValueResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>embeddedValueResolver</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>ResourceLoaderAware</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ResourceLoaderAware</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>setResourceLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationContext</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>ApplicationEventPublisherAware</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ApplicationEventPublisherAware</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>setApplicationEventPublisher</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationContext</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>MessageSourceAware</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>MessageSourceAware</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>setMessageSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationContext</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>ApplicationContextAware</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ApplicationContextAware</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>setApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationContext</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>postProcessAfterInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>当前类主要用来处理继承了 <strong><code>Aware</code></strong> 接口类。然后根据 <strong><code>Aware</code></strong> 接口的不同实现设置对应的接口对象</p><h3 id=6-beanpostprocessor-spring源码分析>6. BeanPostProcessor Spring源码分析</h3><p>首先明确一点 <strong><code>BeanPostProcessor</code></strong> 实现的类都是Spring容器中的一个Bean。在 <strong><code>AbstractApplicationContext#refresh</code></strong> 是最重要的一个方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>refresh</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IllegalStateException</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>startupShutdownMonitor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#8f5902;font-style:italic>//省了部分代码
</span><span style=color:#8f5902;font-style:italic></span>
			<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
				
				<span style=color:#8f5902;font-style:italic>//省了部分代码
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#8f5902;font-style:italic>// Register bean processors that intercept bean creation.
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>registerBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

			  <span style=color:#8f5902;font-style:italic>//省了部分代码
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#ce5c00;font-weight:700>}</span>

			<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				
			<span style=color:#ce5c00;font-weight:700>}</span>

			<span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#8f5902;font-style:italic>//省了部分代码
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#8f5902;font-style:italic>//通过PostProcessorRegistrationDelegate类的静态方法处理
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>PostProcessorRegistrationDelegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>下面看一下 <strong><code>PostProcessorRegistrationDelegate.registerBeanPostProcessors(beanFactory, this);</code></strong> 方法</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span>
			<span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>AbstractApplicationContext</span> <span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

		<span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>postProcessorNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanNamesForType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>

		<span style=color:#8f5902;font-style:italic>// Register BeanPostProcessorChecker that logs an info message when
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#8f5902;font-style:italic>// a bean is created during BeanPostProcessor instantiation, i.e. when
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#8f5902;font-style:italic>// a bean is not eligible for getting processed by all BeanPostProcessors.
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>beanProcessorTargetCount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanPostProcessorCount</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>postProcessorNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanPostProcessorChecker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanProcessorTargetCount</span><span style=color:#ce5c00;font-weight:700>));</span>

		<span style=color:#8f5902;font-style:italic>//处理分为三类：1 PriorityOrdered实现 2 Ordered 第三类就是普通的
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>priorityOrderedPostProcessors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
		<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>internalPostProcessors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
		<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>orderedPostProcessorNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
		<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>nonOrderedPostProcessorNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>ppName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>postProcessorNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTypeMatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>PriorityOrdered</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>BeanPostProcessor</span> <span style=color:#000>pp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#000>priorityOrderedPostProcessors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pp</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pp</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>MergedBeanDefinitionPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>internalPostProcessors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pp</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTypeMatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Ordered</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>orderedPostProcessorNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>nonOrderedPostProcessorNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>// 处理PriorityOrdered实现
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>sortPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>priorityOrderedPostProcessors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>registerBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>priorityOrderedPostProcessors</span><span style=color:#ce5c00;font-weight:700>);</span>

		<span style=color:#8f5902;font-style:italic>// 处理 Ordered实现.
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>orderedPostProcessors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>ppName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>orderedPostProcessorNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>BeanPostProcessor</span> <span style=color:#000>pp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>orderedPostProcessors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pp</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pp</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>MergedBeanDefinitionPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>internalPostProcessors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pp</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#000>sortPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>orderedPostProcessors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>registerBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>orderedPostProcessors</span><span style=color:#ce5c00;font-weight:700>);</span>

		<span style=color:#8f5902;font-style:italic>// 处理正常的
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>nonOrderedPostProcessors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>ppName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>nonOrderedPostProcessorNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>BeanPostProcessor</span> <span style=color:#000>pp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>nonOrderedPostProcessors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pp</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pp</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>MergedBeanDefinitionPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>internalPostProcessors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pp</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#000>registerBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nonOrderedPostProcessors</span><span style=color:#ce5c00;font-weight:700>);</span>

		<span style=color:#8f5902;font-style:italic>//注册MergedBeanDefinitionPostProcessor
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>sortPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>internalPostProcessors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>registerBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>internalPostProcessors</span><span style=color:#ce5c00;font-weight:700>);</span>

		<span style=color:#8f5902;font-style:italic>// Re-register post-processor for detecting inner beans as ApplicationListeners,
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#8f5902;font-style:italic>// moving it to the end of the processor chain (for picking up proxies etc).
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ApplicationListenerDetector</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>));</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过该方法将 <strong><code>BeanPostProcessor</code></strong> 的以上几种实现类都注册到Spring中。</p><p>然后在生成Bean的时候去执行， <strong><code>AbstractAutowireCapableBeanFactory.createBean</code></strong> 创建Bean</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span>
			<span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanCreationException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        	
        	<span style=color:#8f5902;font-style:italic>//省略代码
</span><span style=color:#8f5902;font-style:italic></span>        
        	<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>// 执行实例化之前方法.
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>Object</span> <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveBeforeInstantiation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>          
            <span style=color:#8f5902;font-style:italic>//省略代码    
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>resolveBeforeInstantiation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>Object</span> <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>FALSE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beforeInstantiationResolved</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSynthetic</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>hasInstantiationAwareBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>targetType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>determineTargetType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>targetType</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>//执行InstantiationAwareBeanPostProcessor#postProcessBeforeInstantiation(实例化之前方法)
</span><span style=color:#8f5902;font-style:italic></span>					<span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>applyBeanPostProcessorsBeforeInstantiation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>targetType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>//执行InstantiationAwareBeanPostProcessor#postProcessAfterInitialization(初始化后的方法)
</span><span style=color:#8f5902;font-style:italic></span>						<span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>applyBeanPostProcessorsAfterInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beforeInstantiationResolved</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过代码可以知道 <strong><code>resolveBeforeInstantiation</code></strong> 方法执行实例化之前的方法。如果实例化之前的方法返回了对应Bean那么直接执行初始化后的方法。实例化 <strong><code>InstantiationAwareBeanPostProcessor#postProcessBeforeInstantiation</code></strong> 方法执行返回Bean为空就调用 <strong><code>AbstractAutowireCapableBeanFactory#doCreateBean</code></strong> 方法。在这个方法里面有如下几个重要的方法：</p><ul><li><p><strong>AbstractAutowireCapableBeanFactory#applyMergedBeanDefinitionPostProcessors</strong> 方法</p><p>执行 <strong><code>MergedBeanDefinitionPostProcessor#postProcessMergedBeanDefinition</code></strong> 方法</p></li><li><p><strong>AbstractAutowireCapableBeanFactory#populateBean</strong> 方法</p><p>执行 <strong><code>InstantiationAwareBeanPostProcessor#postProcessAfterInstantiation</code></strong> 方法，如果前面方法返回true，执行 <strong><code>InstantiationAwareBeanPostProcessor#postProcessProperties</code></strong> 方法</p></li><li><p><strong>AbstractAutowireCapableBeanFactory#initializeBean</strong> 方法</p><p>执行 <strong><code>BeanPostProcessor#postProcessBeforeInitialization</code></strong> 方法，然后执行 <strong><code>AbstractAutowireCapableBeanFactory#invokeInitMethods</code></strong> 方法(包括实现了InitializingBean接口的方法或者有注解@PostConstruct的方法)，然后执行 <strong><code>BeanPostProcessor#postProcessAfterInitialization</code></strong></p></li></ul><p><img src="https://github.com/mxsm/picture/blob/main/spring/BeanPostProcessor%E7%BB%A7%E6%89%BF%E6%96%B9%E6%B3%95%E6%89%A7%E8%A1%8C%E7%9A%84%E6%B5%81%E7%A8%8B.png?raw=true" alt=图></p><h3 id=7-总结>7. 总结</h3><p><strong>BeanPostProcessor 主要用来处理Bean内部的注解。比如Spring自己实现的@Autowired、@Value， @EJB，@WebServiceRef，@PostConstruct，@PreDestroy等</strong></p><blockquote><ol><li>自定义类似于@Value，@Autowired的注解，主要用于Java类变量或者方法上的注解</li><li>主要用于处理Bean内部的注解实现，主要是变量或者方法上面的注解</li></ol></blockquote><p>参考文档：</p><ul><li><a href=https://cloud.tencent.com/developer/article/1409273>https://cloud.tencent.com/developer/article/1409273</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-fc39ad1be2759add85e4fdc5bf720481>1.6 - BeanFactoryPostProcessor详解</h1><h3 id=1-beanfactorypostprocessor继承关系>1. BeanFactoryPostProcessor继承关系</h3><p><img src="https://github.com/mxsm/document/blob/master/image/Spring/Springframework/BeanFactoryPostProcessor.png?raw=true" alt=图></p><p><strong><code>BeanFactoryPostProcessor</code></strong> 主要用来处理注入Bean到BeanFactory中以及Bean类上面的注解，比如 <strong>@Configuration</strong></p><ul><li><p><strong>PropertySourcesPlaceholderConfigurer和 PropertyPlaceholderConfigurer</strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//xml context 元素解析
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ContextNamespaceHandler</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>NamespaceHandlerSupport</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>init</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>registerBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;property-placeholder&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PropertyPlaceholderBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#000>registerBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;property-override&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PropertyOverrideBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#000>registerBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;annotation-config&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AnnotationConfigBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#000>registerBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;component-scan&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ComponentScanBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#000>registerBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;load-time-weaver&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LoadTimeWeaverBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#000>registerBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;spring-configured&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SpringConfiguredBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#000>registerBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;mbean-export&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MBeanExportBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#000>registerBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;mbean-server&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MBeanServerBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>());</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PropertyPlaceholderBeanDefinitionParser</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractPropertyLoadingBeanDefinitionParser</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>SYSTEM_PROPERTIES_MODE_ATTRIBUTE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;system-properties-mode&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>

	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>SYSTEM_PROPERTIES_MODE_DEFAULT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;ENVIRONMENT&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>


	<span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>getBeanClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Element</span> <span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// As of Spring 3.1, the default value of system-properties-mode has changed from
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// &#39;FALLBACK&#39; to &#39;ENVIRONMENT&#39;. This latter value indicates that resolution of
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// placeholders against system properties is a function of the Environment and
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// its current set of PropertySources.
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SYSTEM_PROPERTIES_MODE_DEFAULT</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SYSTEM_PROPERTIES_MODE_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>PropertySourcesPlaceholderConfigurer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>

      <span style=color:#8f5902;font-style:italic>// The user has explicitly specified a value for system-properties-mode: revert to
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// PropertyPlaceholderConfigurer to ensure backward compatibility with 3.0 and earlier.
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>PropertyPlaceholderConfigurer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>doParse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Element</span> <span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ParserContext</span> <span style=color:#000>parserContext</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinitionBuilder</span> <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doParse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parserContext</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>);</span>

      <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addPropertyValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;ignoreUnresolvablePlaceholders&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
              <span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>valueOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;ignore-unresolvable&#34;</span><span style=color:#ce5c00;font-weight:700>)));</span>

      <span style=color:#000>String</span> <span style=color:#000>systemPropertiesModeName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SYSTEM_PROPERTIES_MODE_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasLength</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>systemPropertiesModeName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
              <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>systemPropertiesModeName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SYSTEM_PROPERTIES_MODE_DEFAULT</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addPropertyValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;systemPropertiesModeName&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;SYSTEM_PROPERTIES_MODE_&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>systemPropertiesModeName</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>

      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;value-separator&#34;</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addPropertyValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;valueSeparator&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;value-separator&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;trim-values&#34;</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addPropertyValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;trimValues&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;trim-values&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;null-value&#34;</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addPropertyValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;nullValue&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;null-value&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这类加载了。</p></li><li><p><strong>ConfigurationClassPostProcessor</strong></p><p>这个类注入分为两种：</p><ul><li><p>XML的情况下注入</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ContextNamespaceHandler</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>NamespaceHandlerSupport</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>init</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>registerBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;property-placeholder&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PropertyPlaceholderBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>registerBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;property-override&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PropertyOverrideBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#8f5902;font-style:italic>//这个类注入
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>registerBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;annotation-config&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AnnotationConfigBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#8f5902;font-style:italic>//这个类注入
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>registerBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;component-scan&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ComponentScanBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>registerBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;load-time-weaver&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LoadTimeWeaverBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>registerBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;spring-configured&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SpringConfiguredBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>registerBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;mbean-export&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MBeanExportBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>registerBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;mbean-server&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MBeanServerBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li><li><p>注解的情况下注入</p><blockquote><p>AnnotationConfigUtils.registerAnnotationConfigProcessors(parserContext.getRegistry(), source);这个方法里面注入了</p></blockquote><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>registerAnnotationConfigProcessors</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#000>BeanDefinitionRegistry</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>Object</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#000>DefaultListableBeanFactory</span> <span style=color:#000>beanFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>unwrapDefaultListableBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDependencyComparator</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>AnnotationAwareOrderComparator</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setDependencyComparator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AnnotationAwareOrderComparator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>INSTANCE</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAutowireCandidateResolver</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>ContextAnnotationAutowireCandidateResolver</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAutowireCandidateResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ContextAnnotationAutowireCandidateResolver</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>beanDefs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>8</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//注入ConfigurationClassPostProcessor
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>def</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurationClassPostProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>beanDefs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registerPostProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>def</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AutowiredAnnotationBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>beanDefs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registerPostProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// Check for JSR-250 support, and if present add the CommonAnnotationBeanPostProcessor.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>jsr250Present</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>COMMON_ANNOTATION_PROCESSOR_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>def</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CommonAnnotationBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>beanDefs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registerPostProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>COMMON_ANNOTATION_PROCESSOR_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// Check for JPA support, and if present add the PersistenceAnnotationBeanPostProcessor.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>jpaPresent</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PERSISTENCE_ANNOTATION_PROCESSOR_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>def</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBeanClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PERSISTENCE_ANNOTATION_PROCESSOR_CLASS_NAME</span><span style=color:#ce5c00;font-weight:700>,</span>
                        <span style=color:#000>AnnotationConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>()));</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassNotFoundException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span>
                        <span style=color:#4e9a06>&#34;Cannot load optional framework class: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>PERSISTENCE_ANNOTATION_PROCESSOR_CLASS_NAME</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>beanDefs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registerPostProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>PERSISTENCE_ANNOTATION_PROCESSOR_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>EVENT_LISTENER_PROCESSOR_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>def</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>EventListenerMethodProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>beanDefs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registerPostProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>EVENT_LISTENER_PROCESSOR_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>EVENT_LISTENER_FACTORY_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>def</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DefaultEventListenerFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>beanDefs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registerPostProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>EVENT_LISTENER_FACTORY_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>beanDefs</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div></li></ul></li></ul><p>在Spring源码中主要可以关注一下上面的三个实现类。</p><blockquote><p>主要关注下面这两个接口：</p><p><strong>BeanFactoryPostProcessor</strong></p><p><strong>BeanDefinitionRegistryPostProcessor</strong> (可以注入bean)</p></blockquote><h3 id=2-beanfactorypostprocessor在spring中如何工作的源码分析>2. BeanFactoryPostProcessor在Spring中如何工作的源码分析</h3><p>首先我们应该知道，<strong>不管是什么在Spring的容器中都是一个Bean</strong> ，经过bean的扫描或者xml定义后加载。代码首先会在这里进入：</p><blockquote><p>AbstractApplicationContext#refresh#invokeBeanFactoryPostProcessors 方法中来处理</p></blockquote><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>invokeBeanFactoryPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//这个方法主要处理实现了BeanFactoryPostProcessor接口的java类
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>PostProcessorRegistrationDelegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invokeBeanFactoryPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getBeanFactoryPostProcessors</span><span style=color:#ce5c00;font-weight:700>());</span>

		<span style=color:#8f5902;font-style:italic>// Detect a LoadTimeWeaver and prepare for weaving, if found in the meantime
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#8f5902;font-style:italic>// (e.g. through an @Bean method registered by ConfigurationClassPostProcessor)
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTempClassLoader</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LOAD_TIME_WEAVER_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LoadTimeWeaverAwareProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>));</span>
			<span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTempClassLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ContextTypeMatchClassLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClassLoader</span><span style=color:#ce5c00;font-weight:700>()));</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong><code>PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, getBeanFactoryPostProcessors())</code></strong> 这个方法主要处理BeanFactoryPostProcessor实现的类。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>invokeBeanFactoryPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span>
			<span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanFactoryPostProcessor</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>beanFactoryPostProcessors</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>


		<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>processedBeans</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>

		<span style=color:#8f5902;font-style:italic>//判断BeanFactory是否为BeanDefinitionRegistry的实例(BeanDefinitionRegistry可以注入bean)
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>BeanDefinitionRegistry</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>BeanDefinitionRegistry</span> <span style=color:#000>registry</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionRegistry</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>;</span>

			<span style=color:#8f5902;font-style:italic>//存放实现BeanFactoryPostProcessor的实例
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanFactoryPostProcessor</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>regularPostProcessors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>

			<span style=color:#8f5902;font-style:italic>//存放实现BeanDefinitionRegistryPostProcessor
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinitionRegistryPostProcessor</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>registryProcessors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>

			<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanFactoryPostProcessor</span> <span style=color:#000>postProcessor</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>beanFactoryPostProcessors</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

				<span style=color:#8f5902;font-style:italic>//分类存放BeanDefinitionRegistryPostProcessor 和 BeanFactoryPostProcessor
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>postProcessor</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>BeanDefinitionRegistryPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>BeanDefinitionRegistryPostProcessor</span> <span style=color:#000>registryProcessor</span> <span style=color:#ce5c00;font-weight:700>=</span>
							<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionRegistryPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>postProcessor</span><span style=color:#ce5c00;font-weight:700>;</span>
					<span style=color:#8f5902;font-style:italic>//执行postProcessBeanDefinitionRegistry方法
</span><span style=color:#8f5902;font-style:italic></span>					<span style=color:#000>registryProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>postProcessBeanDefinitionRegistry</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#000>registryProcessors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registryProcessor</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>regularPostProcessors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>postProcessor</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>


			<span style=color:#8f5902;font-style:italic>//处理当前BeanDefinitionRegistryPostProcessor实现类
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinitionRegistryPostProcessor</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>currentRegistryProcessors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>

			<span style=color:#8f5902;font-style:italic>// 首先执行实现了PriorityOrdered的BeanDefinitionRegistryPostProcessor实现类
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#8f5902;font-style:italic>// 在beanFacotry中通过BeanDefinitionRegistryPostProcessor类型获取名称
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>postProcessorNames</span> <span style=color:#ce5c00;font-weight:700>=</span>
					<span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanNamesForType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionRegistryPostProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>ppName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>postProcessorNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

				<span style=color:#8f5902;font-style:italic>//过滤出来PriorityOrdered的实现类
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTypeMatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>PriorityOrdered</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>currentRegistryProcessors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinitionRegistryPostProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>));</span>
					<span style=color:#000>processedBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#8f5902;font-style:italic>//排序按照PriorityOrdered
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>sortPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentRegistryProcessors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>registryProcessors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentRegistryProcessors</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#8f5902;font-style:italic>//执行BeanDefinitionRegistryPostProcessor#postProcessBeanDefinitionRegistry()方法
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>invokeBeanDefinitionRegistryPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentRegistryProcessors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>currentRegistryProcessors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>

			<span style=color:#8f5902;font-style:italic>// 执行BeanDefinitionRegistryPostProcessors实现了Ordered接口的类.
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>postProcessorNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanNamesForType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionRegistryPostProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>ppName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>postProcessorNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>processedBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTypeMatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Ordered</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>currentRegistryProcessors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinitionRegistryPostProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>));</span>
					<span style=color:#000>processedBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#000>sortPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentRegistryProcessors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>registryProcessors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentRegistryProcessors</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>invokeBeanDefinitionRegistryPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentRegistryProcessors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>currentRegistryProcessors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>

			<span style=color:#8f5902;font-style:italic>// 最后执行那些实现了BeanDefinitionRegistryPostProcessor类的
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>reiterate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>reiterate</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>reiterate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
				<span style=color:#000>postProcessorNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanNamesForType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionRegistryPostProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>ppName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>postProcessorNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>processedBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#000>currentRegistryProcessors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinitionRegistryPostProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>));</span>
						<span style=color:#000>processedBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>);</span>
						<span style=color:#000>reiterate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#000>sortPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentRegistryProcessors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#000>registryProcessors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentRegistryProcessors</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#000>invokeBeanDefinitionRegistryPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentRegistryProcessors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#000>currentRegistryProcessors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>
			<span style=color:#ce5c00;font-weight:700>}</span>


			<span style=color:#8f5902;font-style:italic>//调用BeanFactoryPostProcessor的postProcessBeanFactory
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>invokeBeanFactoryPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registryProcessors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>invokeBeanFactoryPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>regularPostProcessors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>//直接调用postProcessor#postProcessBeanFactory
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>invokeBeanFactoryPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactoryPostProcessors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>//下面处理的是实现了BeanFactoryPostProcessor的类
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>postProcessorNames</span> <span style=color:#ce5c00;font-weight:700>=</span>
				<span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanNamesForType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanFactoryPostProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>

		<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>		 * 三种：
</span><span style=color:#8f5902;font-style:italic>		 * 1 实现了PriorityOrdered 和 BeanFactoryPostProcessor
</span><span style=color:#8f5902;font-style:italic>		 * 2 实现了Ordered 和 BeanFactoryPostProcessor
</span><span style=color:#8f5902;font-style:italic>		 * 3 只实现了BeanFactoryPostProcessor
</span><span style=color:#8f5902;font-style:italic>		 */</span>
		<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanFactoryPostProcessor</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>priorityOrderedPostProcessors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
		<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>orderedPostProcessorNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
		<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>nonOrderedPostProcessorNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>ppName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>postProcessorNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>processedBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#8f5902;font-style:italic>// 如果是BeanDefinitionRegistryPostProcessor处理过的就什么也不做
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTypeMatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>PriorityOrdered</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#8f5902;font-style:italic>//保存实现了PriorityOrdered接口的BeanFactoryPostProcessor
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>priorityOrderedPostProcessors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanFactoryPostProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>));</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTypeMatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Ordered</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#8f5902;font-style:italic>//保存实现了Ordered接口的BeanFactoryPostProcessor
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>orderedPostProcessorNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#8f5902;font-style:italic>//正常的接口
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>nonOrderedPostProcessorNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>//对priorityOrderedPostProcessors进行排序
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>sortPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>priorityOrderedPostProcessors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#8f5902;font-style:italic>//执行BeanFactoryPostProcessor#postProcessBeanFactory()方法
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>invokeBeanFactoryPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>priorityOrderedPostProcessors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

		<span style=color:#8f5902;font-style:italic>// 执行完实现了Ordered接口的BeanFactoryPostProcessor
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanFactoryPostProcessor</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>orderedPostProcessors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>postProcessorName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>orderedPostProcessorNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>orderedPostProcessors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>postProcessorName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanFactoryPostProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>));</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#000>sortPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>orderedPostProcessors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>invokeBeanFactoryPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>orderedPostProcessors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

		<span style=color:#8f5902;font-style:italic>// 执行完剩下的BeanFactoryPostProcessor(没有实现Ordered和PriorityOrdered接口)
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanFactoryPostProcessor</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>nonOrderedPostProcessors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>postProcessorName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>nonOrderedPostProcessorNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>nonOrderedPostProcessors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>postProcessorName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanFactoryPostProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>));</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#000>invokeBeanFactoryPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nonOrderedPostProcessors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>


		<span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clearMetadataCache</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过上面的代码可以看出来，<strong><code>AbstractApplicationContext#refresh#invokeBeanFactoryPostProcessors</code></strong> 这个方法主要用来执行 <strong><code>BeanFactoryPostProcessor</code></strong> 和 <strong><code>BeanDefinitionRegistryPostProcessor</code></strong> 这两个类的接口。 <strong><code>BeanDefinitionRegistryPostProcessor</code></strong> 继承了 <strong><code>BeanFactoryPostProcessor</code></strong> 接口。从这里可以看出来Spring容器是如何调用这两个类的。这两个类执行的顺序</p><ul><li><strong>BeanDefinitionRegistryPostProcessor#postProcessBeanDefinitionRegistry</strong></li><li><strong>BeanFactoryPostProcessor#postProcessBeanFactory</strong></li></ul><h3 id=3-总结>3. 总结</h3><p><strong><code>BeanFactoryPostProcessor</code></strong> 的实现类主要处理类上面的注解比如：</p><ul><li>@Configuration</li><li>@Order</li><li>@Component</li><li>@PropertySources</li><li>@ComponentScans</li><li>@ComponentScan</li><li>@Import</li><li>@ImportResource</li><li>@Bean(类内部方法上)</li></ul><p>处理顺序图：</p><p><img src="https://github.com/mxsm/picture/blob/main/spring/BeanFactoryPostProcessor%E5%B8%B8%E7%94%A8%E6%B3%A8%E8%A7%A3%E5%A4%84%E7%90%86%E9%A1%BA%E5%BA%8F.png?raw=true" alt></p><p><a href=https://blog.ljbmxsm.com/springframework/core-source-analysis/configurationclasspostprocesso/>ConfigurationClassPostProcessor详解</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-91273e5f54a98b662481a8819ba6a8b8>1.7 - ConfigurationClassPostProcessor源码解析</h1><h3 id=1-configurationclasspostprocessor>1. ConfigurationClassPostProcessor</h3><p>这个类主要用来处理Spring中的配置注解，Spring的配置注解主要包含一下几个：</p><ol><li><strong>@Configuration</strong></li><li><strong>@Component</strong></li><li><strong>@PropertySources、@PropertySource</strong></li><li><strong>@ComponentScan 、 @ComponentScans</strong></li><li><strong>@Import</strong></li><li><strong>@ImportResource</strong></li><li><strong>@Bean</strong></li></ol><p>以上七个是Spring最常见的配置类注解，下面来分析一下每一个注解在Spring中的实现。</p><h3 id=2-configurationclasspostprocessor源码分析>2. ConfigurationClassPostProcessor源码分析</h3><p><strong><code>ConfigurationClassPostProcessor</code></strong> 主要是通过 <strong>AnnotationConfigUtils#registerAnnotationConfigProcessors</strong> 方法注入 <strong><code>ConfigurationClassPostProcessor</code></strong> 的 <strong><code>BeanDefinition</code></strong> 。下面看一下 <strong><code>ConfigurationClassPostProcessor</code></strong> 源码</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ConfigurationClassPostProcessor</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>BeanDefinitionRegistryPostProcessor</span><span style=color:#ce5c00;font-weight:700>,</span>
		<span style=color:#000>PriorityOrdered</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ResourceLoaderAware</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanClassLoaderAware</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>EnvironmentAware</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 省略里面的代码 这里看一下定义		    
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过上面可以看到实现了 <strong>BeanDefinitionRegistryPostProcessor</strong> 这个接口。这个接口是Spring中的一个很重要的 <strong>BeanFactoryPostProcessor</strong> 继承。下面具体看一下里面的两个重要的方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ConfigurationClassPostProcessor</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>BeanDefinitionRegistryPostProcessor</span><span style=color:#ce5c00;font-weight:700>,</span>
		<span style=color:#000>PriorityOrdered</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ResourceLoaderAware</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanClassLoaderAware</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>EnvironmentAware</span> <span style=color:#ce5c00;font-weight:700>{</span>
    
    <span style=color:#8f5902;font-style:italic>//BeanDefinitionRegistryPostProcessor的方法实现
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>postProcessBeanDefinitionRegistry</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionRegistry</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>registryId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>identityHashCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registriesPostProcessed</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registryId</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span>
					<span style=color:#4e9a06>&#34;postProcessBeanDefinitionRegistry already called on this post-processor against &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>factoriesPostProcessed</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registryId</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span>
					<span style=color:#4e9a06>&#34;postProcessBeanFactory already called on this post-processor against &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registriesPostProcessed</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registryId</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>//关键性的方法--处理配置Bean定义
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>processConfigBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	
	<span style=color:#8f5902;font-style:italic>//BeanFactoryPostProcessor的方法实现
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>postProcessBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>factoryId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>identityHashCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>factoriesPostProcessed</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>factoryId</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span>
					<span style=color:#4e9a06>&#34;postProcessBeanFactory already called on this post-processor against &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>factoriesPostProcessed</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>factoryId</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registriesPostProcessed</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>factoryId</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
		    <span style=color:#8f5902;font-style:italic>//关键性的方法
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>processConfigBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>BeanDefinitionRegistry</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#000>enhanceConfigurationClasses</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ImportAwareBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>));</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>下面看一下 <strong><code>processConfigBeanDefinitions</code></strong> 方法</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>processConfigBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionRegistry</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>configCandidates</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
		<span style=color:#8f5902;font-style:italic>//从Spring容器中获取注册的BeanDefinition名称
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>candidateNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinitionNames</span><span style=color:#ce5c00;font-weight:700>();</span>

		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>candidateNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

			<span style=color:#8f5902;font-style:italic>//获取beanName对应的BeanDefinition
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>BeanDefinition</span> <span style=color:#000>beanDef</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#8f5902;font-style:italic>//排除ConfigurationClassPostProcessor
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDef</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurationClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONFIGURATION_CLASS_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Bean definition has already been processed as a configuration class: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanDef</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#8f5902;font-style:italic>//判断是否包含Configuration注解然后判断是否包含
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurationClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>checkConfigurationClassCandidate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDef</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>metadataReaderFactory</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>configCandidates</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDef</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>));</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#8f5902;font-style:italic>// 如果没有发现Configuration直接返回
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configCandidates</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>// 处理包含了@Order注解
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>configCandidates</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sort</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>bd1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bd2</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ConfigurationClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOrder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinition</span><span style=color:#ce5c00;font-weight:700>());</span>
			<span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ConfigurationClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOrder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinition</span><span style=color:#ce5c00;font-weight:700>());</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compare</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i2</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>});</span>


		<span style=color:#000>SingletonBeanRegistry</span> <span style=color:#000>sbr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registry</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>SingletonBeanRegistry</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>sbr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SingletonBeanRegistry</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>localBeanNameGeneratorSet</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>BeanNameGenerator</span> <span style=color:#000>generator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanNameGenerator</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>sbr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span>
						<span style=color:#000>AnnotationConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONFIGURATION_BEAN_NAME_GENERATOR</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>generator</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>componentScanBeanNameGenerator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>;</span>
					<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>importBeanNameGenerator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>;</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>environment</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>environment</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StandardEnvironment</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>// ConfigurationClassParser解析每一个带有@Configuration注解的类
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>ConfigurationClassParser</span> <span style=color:#000>parser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConfigurationClassParser</span><span style=color:#ce5c00;font-weight:700>(</span>
				<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>metadataReaderFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>problemReporter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>environment</span><span style=color:#ce5c00;font-weight:700>,</span>
				<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resourceLoader</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>componentScanBeanNameGenerator</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>

		<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>candidates</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>configCandidates</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ConfigurationClass</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>alreadyParsed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>configCandidates</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#204a87;font-weight:700>do</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//解析包含有Configuration注解的类
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidates</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>validate</span><span style=color:#ce5c00;font-weight:700>();</span>

			<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ConfigurationClass</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>configClasses</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConfigurationClasses</span><span style=color:#ce5c00;font-weight:700>());</span>
			<span style=color:#000>configClasses</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>removeAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>alreadyParsed</span><span style=color:#ce5c00;font-weight:700>);</span>

			<span style=color:#8f5902;font-style:italic>// 读取创建解析后的BeanDefinition到上下文Context中
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reader</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConfigurationClassBeanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>(</span>
						<span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sourceExtractor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resourceLoader</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>environment</span><span style=color:#ce5c00;font-weight:700>,</span>
						<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>importBeanNameGenerator</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getImportRegistry</span><span style=color:#ce5c00;font-weight:700>());</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClasses</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>alreadyParsed</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClasses</span><span style=color:#ce5c00;font-weight:700>);</span>

			<span style=color:#000>candidates</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinitionCount</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>candidateNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>newCandidateNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinitionNames</span><span style=color:#ce5c00;font-weight:700>();</span>
				<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>oldCandidateNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>asList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidateNames</span><span style=color:#ce5c00;font-weight:700>));</span>
				<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>alreadyParsedClasses</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
				<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurationClass</span> <span style=color:#000>configurationClass</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>alreadyParsed</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>alreadyParsedClasses</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configurationClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getClassName</span><span style=color:#ce5c00;font-weight:700>());</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>candidateName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>newCandidateNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>oldCandidateNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidateName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#000>BeanDefinition</span> <span style=color:#000>bd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidateName</span><span style=color:#ce5c00;font-weight:700>);</span>
						<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurationClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>checkConfigurationClassCandidate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>metadataReaderFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
								<span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>alreadyParsedClasses</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClassName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
							<span style=color:#000>candidates</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>candidateName</span><span style=color:#ce5c00;font-weight:700>));</span>
						<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#000>candidateNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newCandidateNames</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>candidates</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>());</span>

		<span style=color:#8f5902;font-style:italic>//注册ImportRegistry作为一个Bean去支持ImportAware导入@Configuration类
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sbr</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>sbr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IMPORT_REGISTRY_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>sbr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IMPORT_REGISTRY_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getImportRegistry</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>metadataReaderFactory</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>CachingMetadataReaderFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>// Clear cache in externally provided MetadataReaderFactory; this is a no-op
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#8f5902;font-style:italic>// for a shared cache since it&#39;ll be cleared by the ApplicationContext.
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>CachingMetadataReaderFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>metadataReaderFactory</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>clearCache</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=21-configurationclassparser对象的分析>2.1 ConfigurationClassParser对象的分析</h4><p><em><strong>ConfigurationClassParser</strong></em> 主要分为几个部分：</p><ul><li><strong>@Component注解的解析</strong></li><li><strong>@PropertySources、@PropertySource 注解的解析</strong></li><li><strong>@ComponentScans.class, @ComponentScan.class注解的解析</strong></li><li><strong>@Import注解的解析</strong></li><li><strong>@ImportResource注解的解析</strong></li><li><strong>@Configuration配置类中@Bean注解的解析</strong></li></ul><p><em><strong>ConfigurationClassParser</strong></em> 主要是解析 <em><strong>@Configuration</strong></em> 注解类上或者类里面的这些注解下面来逐一分析。</p><p>解析 <strong><code>@Configuration</code></strong> 主要是通过 <strong><code>ConfigurationClassParser</code></strong> 对象的parse方法来进行解析</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>configCandidates</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionHolder</span> <span style=color:#000>holder</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>configCandidates</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>BeanDefinition</span> <span style=color:#000>bd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>holder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinition</span><span style=color:#ce5c00;font-weight:700>();</span>
			<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>AnnotatedBeanDefinition</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				    <span style=color:#8f5902;font-style:italic>//解析处理AnnotatedBeanDefinition
</span><span style=color:#8f5902;font-style:italic></span>					<span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>(((</span><span style=color:#000>AnnotatedBeanDefinition</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>holder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanName</span><span style=color:#ce5c00;font-weight:700>());</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>AbstractBeanDefinition</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>AbstractBeanDefinition</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>hasBeanClass</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
				    <span style=color:#8f5902;font-style:italic>//解析处理AbstractBeanDefinition
</span><span style=color:#8f5902;font-style:italic></span>					<span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>(((</span><span style=color:#000>AbstractBeanDefinition</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getBeanClass</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>holder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanName</span><span style=color:#ce5c00;font-weight:700>());</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClassName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>holder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanName</span><span style=color:#ce5c00;font-weight:700>());</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionStoreException</span><span style=color:#ce5c00;font-weight:700>(</span>
						<span style=color:#4e9a06>&#34;Failed to parse configuration class [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClassName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#8f5902;font-style:italic>//处理实现了DeferredImportSelector接口的类
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>deferredImportSelectorHandler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>process</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过上面的代码发现主要是通过调用 parse方法进行接下来的处理</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>String</span> <span style=color:#000>className</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>className</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;No bean class name for configuration class bean definition&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>MetadataReader</span> <span style=color:#000>reader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>metadataReaderFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadataReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>className</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>processConfigurationClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConfigurationClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>reader</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>));</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>processConfigurationClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConfigurationClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>));</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AnnotationMetadata</span> <span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>processConfigurationClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConfigurationClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>));</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>parse方法有三个重载的方法，三个重写方法都是调用 <strong>processConfigurationClass</strong> 方法，接下来开始分析一下这个方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>		<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>processConfigurationClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurationClass</span> <span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>conditionEvaluator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shouldSkip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>ConfigurationPhase</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PARSE_CONFIGURATION</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>//判断配置类是否存在
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>ConfigurationClass</span> <span style=color:#000>existingClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configurationClasses</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>existingClass</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

			<span style=color:#8f5902;font-style:italic>//判断configClass是Import注解
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isImported</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>existingClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isImported</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#8f5902;font-style:italic>//已经存在的ConfigurationClass合并新ConfigurationClass的导入者
</span><span style=color:#8f5902;font-style:italic></span>					<span style=color:#000>existingClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mergeImportedBy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#8f5902;font-style:italic>// 注册过无需再次注册
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#8f5902;font-style:italic>// 找到显式bean定义，可能替换导入
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#8f5902;font-style:italic>// 删除旧的configClass
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configurationClasses</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>knownSuperclasses</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>values</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>removeIf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>equals</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>// 递归地处理配置类及其父类
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>SourceClass</span> <span style=color:#000>sourceClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>asSourceClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>do</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>sourceClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>doProcessConfigurationClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sourceClass</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#8f5902;font-style:italic>//保存已经处理过的configClass
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configurationClasses</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>看一下 <strong><code>doProcessConfigurationClass</code></strong> 的方法</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SourceClass</span> <span style=color:#000>doProcessConfigurationClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurationClass</span> <span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SourceClass</span> <span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>)</span>
			<span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>

		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isAnnotated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Component</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>// 递归处理成员内部内，处理带@Component注解的类
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>processMemberClasses</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>// 处理任何@PropertySource的类
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AnnotationAttributes</span> <span style=color:#000>propertySource</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>AnnotationConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>attributesForRepeatable</span><span style=color:#ce5c00;font-weight:700>(</span>
				<span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>PropertySources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span>
				<span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>springframework</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>annotation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PropertySource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>environment</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>ConfigurableEnvironment</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#8f5902;font-style:italic>//处理属性
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>processPropertySource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertySource</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Ignoring @PropertySource annotation on [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getClassName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span>
						<span style=color:#4e9a06>&#34;]. Reason: Environment must implement ConfigurableEnvironment&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>//处理任何 @ComponentScan的类
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>AnnotationAttributes</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>componentScans</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>AnnotationConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>attributesForRepeatable</span><span style=color:#ce5c00;font-weight:700>(</span>
				<span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>ComponentScans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ComponentScan</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>componentScans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
				<span style=color:#ce5c00;font-weight:700>!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>conditionEvaluator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shouldSkip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>ConfigurationPhase</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>REGISTER_BEAN</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AnnotationAttributes</span> <span style=color:#000>componentScan</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>componentScans</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#8f5902;font-style:italic>// The config class is annotated with @ComponentScan -&gt; perform the scan immediately
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>scannedBeanDefinitions</span> <span style=color:#ce5c00;font-weight:700>=</span>
						<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>componentScanParser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>componentScan</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getClassName</span><span style=color:#ce5c00;font-weight:700>());</span>
				<span style=color:#8f5902;font-style:italic>// Check the set of scanned definitions for any further config classes and parse recursively if needed
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionHolder</span> <span style=color:#000>holder</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>scannedBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>BeanDefinition</span> <span style=color:#000>bdCand</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>holder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinition</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getOriginatingBeanDefinition</span><span style=color:#ce5c00;font-weight:700>();</span>
					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bdCand</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#000>bdCand</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>holder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinition</span><span style=color:#ce5c00;font-weight:700>();</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurationClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>checkConfigurationClassCandidate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bdCand</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>metadataReaderFactory</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bdCand</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClassName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>holder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanName</span><span style=color:#ce5c00;font-weight:700>());</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>// 处理任何@Import注解的类
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>processImports</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getImports</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>

		<span style=color:#8f5902;font-style:italic>//处理任何@ImportResource注解的类
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>AnnotationAttributes</span> <span style=color:#000>importResource</span> <span style=color:#ce5c00;font-weight:700>=</span>
				<span style=color:#000>AnnotationConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>attributesFor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>ImportResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>importResource</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>resources</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>importResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;locations&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BeanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>readerClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>importResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;reader&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>resources</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>String</span> <span style=color:#000>resolvedResource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>environment</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolveRequiredPlaceholders</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addImportedResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolvedResource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>readerClass</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>


		<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MethodMetadata</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>beanMethods</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>retrieveBeanMethodMetadata</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MethodMetadata</span> <span style=color:#000>methodMetadata</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>beanMethods</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addBeanMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methodMetadata</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>));</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>// 处理实现的所有接口中@Bean注解的方法，去上面的处理方法一样，但不是抽象方法，
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#8f5902;font-style:italic>// 因为java8中接口有默认方法和其他具体方法，这里只会处理这些方法的@Bean注解
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>processInterfaces</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>);</span>

		<span style=color:#8f5902;font-style:italic>// 处理父类
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>hasSuperClass</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>

			<span style=color:#000>String</span> <span style=color:#000>superclass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getSuperClassName</span><span style=color:#ce5c00;font-weight:700>();</span>
			<span style=color:#8f5902;font-style:italic>// java包的父类和已经处理过的父类不处理
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>superclass</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>superclass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>startsWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;java&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
					<span style=color:#ce5c00;font-weight:700>!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>knownSuperclasses</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>superclass</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#8f5902;font-style:italic>// 标记父类已经处理过
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>knownSuperclasses</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>superclass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#8f5902;font-style:italic>// 返回父类的SourceClass再次进行递归处理
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSuperClass</span><span style=color:#ce5c00;font-weight:700>();</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#8f5902;font-style:italic>// 没有父类处理完成
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h5 id=211--component注解的处理>2.1.1 @Component注解的处理</h5><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//判断@configuration注解的类上面是否包含有@Component注解 
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isAnnotated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Component</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#000>processMemberClasses</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h5 id=212-propertysourcespropertysource-注解的解析>2.1.2 @PropertySources、@PropertySource 注解的解析</h5><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AnnotationAttributes</span> <span style=color:#000>propertySource</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>AnnotationConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>attributesForRepeatable</span><span style=color:#ce5c00;font-weight:700>(</span>
				<span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>PropertySources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span>
				<span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>springframework</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>annotation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PropertySource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>environment</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>ConfigurableEnvironment</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>processPropertySource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertySource</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#8f5902;font-style:italic>//省略打印日志
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h5 id=213-componentscansclass-componentscanclass注解的解析>2.1.3 @ComponentScans.class, @ComponentScan.class注解的解析</h5><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>		<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>AnnotationAttributes</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>componentScans</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>AnnotationConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>attributesForRepeatable</span><span style=color:#ce5c00;font-weight:700>(</span>
				<span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>ComponentScans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ComponentScan</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>componentScans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
				<span style=color:#ce5c00;font-weight:700>!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>conditionEvaluator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shouldSkip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>ConfigurationPhase</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>REGISTER_BEAN</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AnnotationAttributes</span> <span style=color:#000>componentScan</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>componentScans</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#8f5902;font-style:italic>//添加有@ComponentScan注解的类 -&gt; 立刻扫描
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>scannedBeanDefinitions</span> <span style=color:#ce5c00;font-weight:700>=</span>
						<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>componentScanParser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>componentScan</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getClassName</span><span style=color:#ce5c00;font-weight:700>());</span>
				<span style=color:#8f5902;font-style:italic>//检查已扫描的定义集以获得更多的配置类，并在需要时进行递归解析
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionHolder</span> <span style=color:#000>holder</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>scannedBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>BeanDefinition</span> <span style=color:#000>bdCand</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>holder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinition</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getOriginatingBeanDefinition</span><span style=color:#ce5c00;font-weight:700>();</span>
					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bdCand</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#000>bdCand</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>holder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinition</span><span style=color:#ce5c00;font-weight:700>();</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#8f5902;font-style:italic>//判断是否有配置@Configuration，然后递归调用解析
</span><span style=color:#8f5902;font-style:italic></span>					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurationClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>checkConfigurationClassCandidate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bdCand</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>metadataReaderFactory</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bdCand</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClassName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>holder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanName</span><span style=color:#ce5c00;font-weight:700>());</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h5 id=214-import注解的解析>2.1.4 @Import注解的解析</h5><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// Process any @Import annotations
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>processImports</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getImports</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>processImports</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurationClass</span> <span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SourceClass</span> <span style=color:#000>currentSourceClass</span><span style=color:#ce5c00;font-weight:700>,</span>
			<span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>SourceClass</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>importCandidates</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>checkForCircularImports</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>importCandidates</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>checkForCircularImports</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>isChainedImportOnStack</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>problemReporter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CircularImportProblem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>importStack</span><span style=color:#ce5c00;font-weight:700>));</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>importStack</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>push</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SourceClass</span> <span style=color:#000>candidate</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>importCandidates</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAssignable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ImportSelector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#8f5902;font-style:italic>// 处理ImportSelector实现类
</span><span style=color:#8f5902;font-style:italic></span>						<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>candidateClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>loadClass</span><span style=color:#ce5c00;font-weight:700>();</span>
						<span style=color:#000>ImportSelector</span> <span style=color:#000>selector</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ParserStrategyUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instantiateClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidateClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ImportSelector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span>
								<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>environment</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resourceLoader</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
						<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>selector</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>DeferredImportSelector</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#8f5902;font-style:italic>//判断是否为DeferredImportSelector的实现--延迟处理
</span><span style=color:#8f5902;font-style:italic></span>							<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>deferredImportSelectorHandler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>handle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DeferredImportSelector</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>selector</span><span style=color:#ce5c00;font-weight:700>);</span>
						<span style=color:#ce5c00;font-weight:700>}</span>
						<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
							<span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>importClassNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>selector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>selectImports</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentSourceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>());</span>
							<span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>SourceClass</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>importSourceClasses</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>asSourceClasses</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>importClassNames</span><span style=color:#ce5c00;font-weight:700>);</span>
							<span style=color:#000>processImports</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>currentSourceClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>importSourceClasses</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
						<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAssignable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ImportBeanDefinitionRegistrar</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#8f5902;font-style:italic>//ImportBeanDefinitionRegistrar接口实现的的处理
</span><span style=color:#8f5902;font-style:italic></span>						<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>candidateClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>loadClass</span><span style=color:#ce5c00;font-weight:700>();</span>
						<span style=color:#000>ImportBeanDefinitionRegistrar</span> <span style=color:#000>registrar</span> <span style=color:#ce5c00;font-weight:700>=</span>
								<span style=color:#000>ParserStrategyUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instantiateClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidateClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ImportBeanDefinitionRegistrar</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span>
										<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>environment</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resourceLoader</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
						<span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addImportBeanDefinitionRegistrar</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registrar</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>currentSourceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>());</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#8f5902;font-style:italic>// 当做Config类来处理
</span><span style=color:#8f5902;font-style:italic></span>						<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>importStack</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerImport</span><span style=color:#ce5c00;font-weight:700>(</span>
								<span style=color:#000>currentSourceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getClassName</span><span style=color:#ce5c00;font-weight:700>());</span>
						<span style=color:#000>processConfigurationClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>asConfigClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>));</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionStoreException</span><span style=color:#ce5c00;font-weight:700>(</span>
						<span style=color:#4e9a06>&#34;Failed to process import candidates for configuration class [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
						<span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getClassName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>importStack</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pop</span><span style=color:#ce5c00;font-weight:700>();</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h5 id=215-importresource注解的解析>2.1.5 @ImportResource注解的解析</h5><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>		<span style=color:#000>AnnotationAttributes</span> <span style=color:#000>importResource</span> <span style=color:#ce5c00;font-weight:700>=</span>
				<span style=color:#000>AnnotationConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>attributesFor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>ImportResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>importResource</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>resources</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>importResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;locations&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BeanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>readerClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>importResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;reader&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>resources</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>String</span> <span style=color:#000>resolvedResource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>environment</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolveRequiredPlaceholders</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addImportedResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolvedResource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>readerClass</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h5 id=216-configuration配置类中bean注解的解析>2.1.6 @Configuration配置类中@Bean注解的解析</h5><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MethodMetadata</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>beanMethods</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>retrieveBeanMethodMetadata</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MethodMetadata</span> <span style=color:#000>methodMetadata</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>beanMethods</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addBeanMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methodMetadata</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>));</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=3-终结>3. 终结</h3><ul><li>@Import自定义注解的时候可以放在Bean上面</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-acb12be2c385f1c475156c9455ad6bc8>1.8 - EnableTransactionManagement注解解析来看AOP</h1><blockquote><p>基于spring 5.3.5版本源码分析</p></blockquote><h3 id=1-enabletransactionmanagement注解>1. EnableTransactionManagement注解</h3><p>EnableXXX类的注解主要依赖于@Import注解进行拓展。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Target</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TYPE</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Retention</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RetentionPolicy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RUNTIME</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Documented</span>
<span style=color:#5c35cc;font-weight:700>@Import</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TransactionManagementConfigurationSelector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#5c35cc;font-weight:700>@interface</span> <span style=color:#000>EnableTransactionManagement</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>proxyTargetClass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>

	<span style=color:#000>AdviceMode</span> <span style=color:#000>mode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>default</span> <span style=color:#000>AdviceMode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PROXY</span><span style=color:#ce5c00;font-weight:700>;</span>

	<span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>order</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>default</span> <span style=color:#000>Ordered</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>LOWEST_PRECEDENCE</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div><p>通过代码可以知道，主要的逻辑都是通过 <em><strong>TransactionManagementConfigurationSelector</strong></em> 来实现的。</p><h3 id=2-transactionmanagementconfigurationselector类>2. TransactionManagementConfigurationSelector类</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TransactionManagementConfigurationSelector</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AdviceModeImportSelector</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>EnableTransactionManagement</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>selectImports</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AdviceMode</span> <span style=color:#000>adviceMode</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>switch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>adviceMode</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>PROXY</span><span style=color:#ce5c00;font-weight:700>:</span>
				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>AutoProxyRegistrar</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>(),</span>
						<span style=color:#000>ProxyTransactionManagementConfiguration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()};</span>
			<span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>ASPECTJ</span><span style=color:#ce5c00;font-weight:700>:</span>
				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>determineTransactionAspectClass</span><span style=color:#ce5c00;font-weight:700>()};</span>
			<span style=color:#204a87;font-weight:700>default</span><span style=color:#ce5c00;font-weight:700>:</span>
				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>determineTransactionAspectClass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;javax.transaction.Transactional&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getClass</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>?</span>
				<span style=color:#000>TransactionManagementConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>JTA_TRANSACTION_ASPECT_CONFIGURATION_CLASS_NAME</span> <span style=color:#ce5c00;font-weight:700>:</span>
				<span style=color:#000>TransactionManagementConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TRANSACTION_ASPECT_CONFIGURATION_CLASS_NAME</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>有代码可以看出来该类继承 <em><strong>AdviceModeImportSelector</strong></em> 类。分为了两种情况根据AdviceMode</p><ul><li><strong>AdviceMode.PROXY</strong><br>这个也是默认情况，主要使用的是JDK代理实现通知</li><li><strong>AdviceMode.ASPECTJ</strong><br>使用ASPECTJ来实现通知</li></ul><h3 id=3-autoproxyregistrar类>3. AutoProxyRegistrar类</h3><p>AutoProxyRegistrar类实现了ImportBeanDefinitionRegistrar接口。通过获取EnableTransactionManagement注解的值来确定使用何种模式以及何种代理来实现Aop.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AutoProxyRegistrar</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>ImportBeanDefinitionRegistrar</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AnnotationMetadata</span> <span style=color:#000>importingClassMetadata</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinitionRegistry</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>candidateFound</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>annTypes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>importingClassMetadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAnnotationTypes</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>annType</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>annTypes</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>AnnotationAttributes</span> <span style=color:#000>candidate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>AnnotationConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>attributesFor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>importingClassMetadata</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>annType</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidate</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>continue</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#000>Object</span> <span style=color:#000>mode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;mode&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>Object</span> <span style=color:#000>proxyTargetClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;proxyTargetClass&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mode</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>proxyTargetClass</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>AdviceMode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>mode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
					<span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>proxyTargetClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>candidateFound</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
				<span style=color:#8f5902;font-style:italic>//设置代理创建者AutoProxyCreator
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mode</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>AdviceMode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PROXY</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>AopConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerAutoProxyCreatorIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#8f5902;font-style:italic>//设置使用代理的方式
</span><span style=color:#8f5902;font-style:italic></span>					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>proxyTargetClass</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#000>AopConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forceAutoProxyCreatorToUseClassProxying</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
						<span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul><li><p>注入InfrastructureAdvisorAutoProxyCreator到Spring容器</p><p>该类是一个InstantiationAwareBeanPostProcessor实现类。通过postProcessBeforeInstantiation方法或者postProcessAfterInitialization来创建代理。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//AbstractAutoProxyCreator#postProcessAfterInitialization
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>postProcessAfterInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>Object</span> <span style=color:#000>cacheKey</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getCacheKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlyProxyReferences</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>wrapIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>AbstractAutoProxyCreator#wrapIfNecessary用来创建代理对象如果有advice的情况</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>wrapIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasLength</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>targetSourcedBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>FALSE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>advisedBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isInfrastructureClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>shouldSkip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>advisedBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>FALSE</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>

      <span style=color:#8f5902;font-style:italic>// 获取回调拦截器（AOP核心：代理和回调拦截器）
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>specificInterceptors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getAdvicesAndAdvisorsForBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>specificInterceptors</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>DO_NOT_PROXY</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>advisedBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TRUE</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>Object</span> <span style=color:#000>proxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createProxy</span><span style=color:#ce5c00;font-weight:700>(</span>
                  <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>specificInterceptors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SingletonTargetSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>));</span>
          <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>proxyTypes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>());</span>
          <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>

      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>advisedBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>FALSE</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li><li><p>设置代理方式，false为jdk代理，true为cglib代理</p></li></ul><blockquote><p>在代理加入了切面的实现</p></blockquote><h3 id=4-proxytransactionmanagementconfiguration类>4. ProxyTransactionManagementConfiguration类</h3><p>这个配主要管理配置代理事务</p><ul><li>创建TransactionAttributeSource对象</li><li>创建TransactionInterceptor，依赖TransactionAttributeSource</li><li>创建BeanFactoryTransactionAttributeSourceAdvisor属性通知器。依赖创建TransactionAttributeSource、创建TransactionInterceptor。</li></ul><h4 id=41-annotationtransactionattributesource类>4.1 AnnotationTransactionAttributeSource类</h4><p>方法主要用来解析注解@Transactional。同时还兼容了jta和ejb。Spring的@Transactional解析类 <em><strong>SpringTransactionAnnotationParser</strong></em></p><blockquote><p>默认AnnotationTransactionAttributeSource的创建为只能公共方法能够使用@Transactional注解</p></blockquote><h4 id=42-transactioninterceptor类>4.2 TransactionInterceptor类</h4><p>主要处理@Transactional注解切面，执行方法的处理。</p><h3 id=5-事务执行逻辑>5 事务执行逻辑</h3><p>事务执行分为两步：</p><ol><li>代理对象创建</li><li>代理对象执行方法</li></ol><h4 id=51-代理对象创建>5.1 代理对象创建</h4><p>在 <em><strong>AbstractAutoProxyCreator</strong></em> 类继承了 <em><strong>SmartInstantiationAwareBeanPostProcessor</strong></em> 通过 <em><strong>AbstractAutoProxyCreator#postProcessAfterInitialization</strong></em> 来创建代理对象。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>postProcessAfterInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>Object</span> <span style=color:#000>cacheKey</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getCacheKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlyProxyReferences</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		    <span style=color:#8f5902;font-style:italic>//创建代理
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>wrapIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>wrapIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
	
	<span style=color:#8f5902;font-style:italic>//省略部分代码
</span><span style=color:#8f5902;font-style:italic></span>
	<span style=color:#8f5902;font-style:italic>//获取要代理类是否含有切面-创建代理
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>specificInterceptors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getAdvicesAndAdvisorsForBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>specificInterceptors</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>DO_NOT_PROXY</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>advisedBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TRUE</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#8f5902;font-style:italic>//创建代理
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>Object</span> <span style=color:#000>proxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createProxy</span><span style=color:#ce5c00;font-weight:700>(</span>
				<span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>specificInterceptors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SingletonTargetSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>));</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>proxyTypes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>advisedBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>FALSE</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过在代理类中设置切面的数据，然后创建代理类为后续的执行提供切面的功能。</p><h4 id=52-代理对象执行方法>5.2 代理对象执行方法</h4><p>代理类的执行我们首先要了解代理类是如何创建的。首先来了解一下Spring中AOP代理的类图结构：<br><img src="https://github.com/mxsm/picture/blob/main/spring/aopproxy%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB%E5%9B%BE.png?raw=true" alt=image></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>AopProxy</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#000>Object</span> <span style=color:#000>getProxy</span><span style=color:#ce5c00;font-weight:700>();</span>

	<span style=color:#000>Object</span> <span style=color:#000>getProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>ClassLoader</span> <span style=color:#000>classLoader</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div><p>这个就是创建代理的接口。下面来看一下实现用CglibAopProxy举例分析，代理创建就是cglib的标准创建方式。然后通过设置类的Callback来将切面结合到里面。看一下代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>ClassLoader</span> <span style=color:#000>classLoader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#8f5902;font-style:italic>//省略部分代码
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Enhancer</span> <span style=color:#000>enhancer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createEnhancer</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>classLoader</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>enhancer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setClassLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>classLoader</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>classLoader</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>SmartClassLoader</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
				<span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>SmartClassLoader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>classLoader</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>isClassReloadable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>proxySuperClass</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>enhancer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setUseCache</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#000>enhancer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSuperclass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>proxySuperClass</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#000>enhancer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setInterfaces</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AopProxyUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>completeProxiedInterfaces</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>advised</span><span style=color:#ce5c00;font-weight:700>));</span>
	<span style=color:#000>enhancer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setNamingPolicy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SpringNamingPolicy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>INSTANCE</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#000>enhancer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setStrategy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassLoaderAwareGeneratorStrategy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>classLoader</span><span style=color:#ce5c00;font-weight:700>));</span>
	
	<span style=color:#8f5902;font-style:italic>//重要方法：获取Callback
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Callback</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>callbacks</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getCallbacks</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rootClass</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>types</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[</span><span style=color:#000>callbacks</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>];</span>
	<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>types</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>types</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>callbacks</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	 <span style=color:#8f5902;font-style:italic>//设置CallbackFilter
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>enhancer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCallbackFilter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ProxyCallbackFilter</span><span style=color:#ce5c00;font-weight:700>(</span>
			<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>advised</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConfigurationOnlyCopy</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fixedInterceptorMap</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fixedInterceptorOffset</span><span style=color:#ce5c00;font-weight:700>));</span>
	<span style=color:#000>enhancer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCallbackTypes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>types</span><span style=color:#ce5c00;font-weight:700>);</span>
	
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>createProxyClassAndInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>enhancer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>callbacks</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面比较重要的一个方法就是 <em><strong>getCallbacks</strong></em> 方法。主要用来创建代理对象的Callback(这里主要是cglib的MethodInterceptor)：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>Callback</span> <span style=color:#000>aopInterceptor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DynamicAdvisedInterceptor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>advised</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>创建了一个动态通知拦截器。 <em><strong>DynamicAdvisedInterceptor</strong></em> 是 CglibAopProxy 内部静态类。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>FixedChainStaticTargetInterceptor</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>MethodInterceptor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Serializable</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//省略代码
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#5c35cc;font-weight:700>@Nullable</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>intercept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Method</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MethodProxy</span> <span style=color:#000>methodProxy</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>
    
    	<span style=color:#8f5902;font-style:italic>//省略了部分无关紧要的代码
</span><span style=color:#8f5902;font-style:italic></span>    
    	<span style=color:#000>Object</span> <span style=color:#000>oldProxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    	<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>setProxyContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    	<span style=color:#000>Object</span> <span style=color:#000>target</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    	<span style=color:#000>TargetSource</span> <span style=color:#000>targetSource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>advised</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTargetSource</span><span style=color:#ce5c00;font-weight:700>();</span>
    
    	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>advised</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>exposeProxy</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    		<span style=color:#8f5902;font-style:italic>// Make invocation available if necessary.
</span><span style=color:#8f5902;font-style:italic></span>    		<span style=color:#000>oldProxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>AopContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCurrentProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>);</span>
    		<span style=color:#000>setProxyContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    	<span style=color:#ce5c00;font-weight:700>}</span>
    	<span style=color:#8f5902;font-style:italic>// Get as late as possible to minimize the time we &#34;own&#34; the target, in case it comes from a pool...
</span><span style=color:#8f5902;font-style:italic></span>    	<span style=color:#000>target</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>targetSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTarget</span><span style=color:#ce5c00;font-weight:700>();</span>
    	<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>targetClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>target</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>target</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
    	<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>chain</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>advised</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInterceptorsAndDynamicInterceptionAdvice</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>targetClass</span><span style=color:#ce5c00;font-weight:700>);</span>
    	<span style=color:#000>Object</span> <span style=color:#000>retVal</span><span style=color:#ce5c00;font-weight:700>;</span>
    	<span style=color:#8f5902;font-style:italic>// Check whether we only have one InvokerInterceptor: that is,
</span><span style=color:#8f5902;font-style:italic></span>    	<span style=color:#8f5902;font-style:italic>// no real advice, but just reflective invocation of the target.
</span><span style=color:#8f5902;font-style:italic></span>    	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>chain</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>Modifier</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isPublic</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getModifiers</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
    		<span style=color:#8f5902;font-style:italic>//跳过代理直接在线目标类的方法
</span><span style=color:#8f5902;font-style:italic></span>    		<span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>argsToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>AopProxyUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>adaptArgumentsIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
    		<span style=color:#000>retVal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>methodProxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>target</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>argsToUse</span><span style=color:#ce5c00;font-weight:700>);</span>
    	<span style=color:#ce5c00;font-weight:700>}</span>
    	<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
    		<span style=color:#8f5902;font-style:italic>//创建一个cglib方法Invocation去执行
</span><span style=color:#8f5902;font-style:italic></span>    		<span style=color:#000>retVal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CglibMethodInvocation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>target</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>targetClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>chain</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>methodProxy</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>proceed</span><span style=color:#ce5c00;font-weight:700>();</span>
    	<span style=color:#ce5c00;font-weight:700>}</span>
    	<span style=color:#000>retVal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>processReturnType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>target</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>retVal</span><span style=color:#ce5c00;font-weight:700>);</span>
    	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>retVal</span><span style=color:#ce5c00;font-weight:700>;</span>
    	
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>创建的 <strong>CglibMethodInvocation</strong> 最终是执行了 <strong>ReflectiveMethodInvocation#proceed</strong> 方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#5c35cc;font-weight:700>@Nullable</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>proceed</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentInterceptorIndex</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>interceptorsAndDynamicMethodMatchers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>invokeJoinpoint</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#000>Object</span> <span style=color:#000>interceptorOrInterceptionAdvice</span> <span style=color:#ce5c00;font-weight:700>=</span>
			<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>interceptorsAndDynamicMethodMatchers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(++</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentInterceptorIndex</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>interceptorOrInterceptionAdvice</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>InterceptorAndDynamicMethodMatcher</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>InterceptorAndDynamicMethodMatcher</span> <span style=color:#000>dm</span> <span style=color:#ce5c00;font-weight:700>=</span>
				<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterceptorAndDynamicMethodMatcher</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>interceptorOrInterceptionAdvice</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>targetClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>targetClass</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>targetClass</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaringClass</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dm</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>methodMatcher</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>matches</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>targetClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>arguments</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>dm</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>interceptor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>proceed</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
	    <span style=color:#8f5902;font-style:italic>//执行实现了MethodInterceptor接口的方法
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>MethodInterceptor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>interceptorOrInterceptionAdvice</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这里对于@Transactional注解来说 ((MethodInterceptor) interceptorOrInterceptionAdvice).invoke(this) 这行代码里面的 MethodInterceptor实现就是前面在 <em><strong>ProxyTransactionManagementConfiguration</strong></em> 里面实例化的 <em><strong>TransactionInterceptor</strong></em> 类。在这个类里面包含了处理整个事务</p><h3 id=6-总结>6. 总结</h3><p><img src="https://github.com/mxsm/picture/blob/main/spring/%E4%BA%8B%E5%8A%A1%E4%BB%A3%E7%90%86%E5%88%9B%E5%BB%BA.png?raw=true" alt></p></div><div class=td-content style=page-break-before:always><h1 id=pg-38018db3a0c618ec1942128421bd538f>1.9 - Spring事务处理源码解析</h1><blockquote><p>基于spring 5.3.5版本源码分析</p></blockquote><p>事务处理的逻辑主要在 <em><strong>MethodInterceptor</strong></em> 中，下面通过源码来解析Spring是如何处理事务的。</p><h3 id=1-入口方法methodinterceptorinvoke>1. 入口方法MethodInterceptor#invoke</h3><p>这个方法是事务执行的入口:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#5c35cc;font-weight:700>@Nullable</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MethodInvocation</span> <span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>targetClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getThis</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>AopUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTargetClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getThis</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
    
    <span style=color:#8f5902;font-style:italic>//事务处理的主要逻辑
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>invokeWithinTransaction</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethod</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>targetClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CoroutinesInvocationCallback</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#5c35cc;font-weight:700>@Override</span>
		<span style=color:#5c35cc;font-weight:700>@Nullable</span>
		<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>proceedWithInvocation</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>proceed</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#5c35cc;font-weight:700>@Override</span>
		<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getTarget</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getThis</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#5c35cc;font-weight:700>@Override</span>
		<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>getArguments</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getArguments</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>});</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=2-transactionaspectsupportinvokewithintransaction方法>2. TransactionAspectSupport#invokeWithinTransaction方法</h3><p>这个方法主要包含了两部分：</p><ul><li>响应式编程事务支持(ReactiveTransactionManager类添加与Spring5.2版本)</li><li>标准的的事务支持</li></ul><p>响应式后续分析。我们来分析一下标准的事务支持：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 重点：是否需要创建事务
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>TransactionInfo</span> <span style=color:#000>txInfo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createTransactionIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ptm</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>txAttr</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>joinpointIdentification</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#000>Object</span> <span style=color:#000>retVal</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#8f5902;font-style:italic>// 这是一个around advice: 调用链中的下一个拦截器.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// 这通常会导致调用目标对象.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>retVal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>proceedWithInvocation</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#8f5902;font-style:italic>// 事务的异常处理
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>completeTransactionAfterThrowing</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>txInfo</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//清理事务的信息
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>cleanupTransactionInfo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>txInfo</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>retVal</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>vavrPresent</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>VavrDelegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isVavrTry</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>retVal</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#8f5902;font-style:italic>// Set rollback-only in case of Vavr failure matching our rollback rules...
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>TransactionStatus</span> <span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>txInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTransactionStatus</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>txAttr</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>retVal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>VavrDelegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evaluateTryFailure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>retVal</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>txAttr</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>status</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#8f5902;font-style:italic>//提交事务
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>commitTransactionAfterReturning</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>txInfo</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>retVal</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><p>事务主要是通过 <em><strong>TransactionAspectSupport#createTransactionIfNecessary</strong></em> 方法获取，然后执行目标方法获取方法返回结果。如果有问题处理问题，根据情况(配置的事务传递性和事务回滚的Execption)是否对事务进行回滚。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>TransactionInfo</span> <span style=color:#000>createTransactionIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>PlatformTransactionManager</span> <span style=color:#000>tm</span><span style=color:#ce5c00;font-weight:700>,</span>
		<span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>TransactionAttribute</span> <span style=color:#000>txAttr</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>joinpointIdentification</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#8f5902;font-style:italic>// 处理txAttr没有名字的情况
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>txAttr</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>txAttr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>txAttr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DelegatingTransactionAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>txAttr</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#5c35cc;font-weight:700>@Override</span>
			<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>joinpointIdentification</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>};</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#000>TransactionStatus</span> <span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>txAttr</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tm</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>//重点：通过PlatformTransactionManager管理获取事务状态
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tm</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTransaction</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>txAttr</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Skipping transactional joinpoint [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>joinpointIdentification</span> <span style=color:#ce5c00;font-weight:700>+</span>
						<span style=color:#4e9a06>&#34;] because no transaction manager has been configured&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#8f5902;font-style:italic>//将TransactionStatus包装成TransactionInfo
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>prepareTransactionInfo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tm</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>txAttr</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>joinpointIdentification</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>status</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=3-事务传播>3. 事务传播</h3><p>在通过注解@Transactional管理事务的时候需要配置Propagation的值。默认为Propagation.REQUIRED,下面来看一下AbstractPlatformTransactionManager#getTransaction。方法主要逻辑为两个：</p><ol><li>存在事务如何处理</li><li>没有存在事务如何处理</li></ol><p>这里就涉及到了根据事务的传播方式来处理事务。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>TransactionStatus</span> <span style=color:#000>getTransaction</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>TransactionDefinition</span> <span style=color:#000>definition</span><span style=color:#ce5c00;font-weight:700>)</span>
		<span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>TransactionException</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#8f5902;font-style:italic>// Use defaults if no transaction definition given.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>TransactionDefinition</span> <span style=color:#000>def</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>definition</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>definition</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>TransactionDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>withDefaults</span><span style=color:#ce5c00;font-weight:700>());</span>

	<span style=color:#000>Object</span> <span style=color:#000>transaction</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>doGetTransaction</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>debugEnabled</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>();</span>

	<span style=color:#8f5902;font-style:italic>//重点：判断是否存在事务
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isExistingTransaction</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>transaction</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>// 存在事务 -&gt; 检查 propagation 来决定如何处理.
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>handleExistingTransaction</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>transaction</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>debugEnabled</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#8f5902;font-style:italic>//重点： 下面就是处理没有事务，根据propagation决定如何处理
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTimeout</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>TransactionDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TIMEOUT_DEFAULT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InvalidTimeoutException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Invalid transaction timeout&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTimeout</span><span style=color:#ce5c00;font-weight:700>());</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPropagationBehavior</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>TransactionDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PROPAGATION_MANDATORY</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalTransactionStateException</span><span style=color:#ce5c00;font-weight:700>(</span>
				<span style=color:#4e9a06>&#34;No existing transaction found for transaction marked with propagation &#39;mandatory&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPropagationBehavior</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>TransactionDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PROPAGATION_REQUIRED</span> <span style=color:#ce5c00;font-weight:700>||</span>
			<span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPropagationBehavior</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>TransactionDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PROPAGATION_REQUIRES_NEW</span> <span style=color:#ce5c00;font-weight:700>||</span>
			<span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPropagationBehavior</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>TransactionDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PROPAGATION_NESTED</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>SuspendedResourcesHolder</span> <span style=color:#000>suspendedResources</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>suspend</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>debugEnabled</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Creating new transaction with name [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>startTransaction</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>transaction</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>debugEnabled</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>suspendedResources</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RuntimeException</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>Error</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>resume</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>suspendedResources</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>// Create &#34;empty&#34; transaction: no actual transaction, but potentially synchronization.
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getIsolationLevel</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>TransactionDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ISOLATION_DEFAULT</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isWarnEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Custom isolation level specified but no actual transaction initiated; &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
					<span style=color:#4e9a06>&#34;isolation level will effectively be ignored: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>newSynch</span>
</code></pre></div><h4 id=31-当前存在事务的传播属性>3.1 当前存在事务的传播属性</h4><p>方法主要是 AbstractPlatformTransactionManager#handleExistingTransaction：</p><ul><li><p>NEVER</p><p>存在事务就报错</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>definition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPropagationBehavior</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>TransactionDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PROPAGATION_NEVER</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalTransactionStateException</span><span style=color:#ce5c00;font-weight:700>(</span>
          <span style=color:#4e9a06>&#34;Existing transaction found for transaction marked with propagation &#39;never&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li><li><p>NOT_SUPPORTED</p><p>把当前事务挂起,强制不在事务中运行</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>definition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPropagationBehavior</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>TransactionDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PROPAGATION_NOT_SUPPORTED</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#8f5902;font-style:italic>//挂起当前事务
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Object</span> <span style=color:#000>suspendedResources</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>suspend</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>transaction</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>newSynchronization</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getTransactionSynchronization</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>SYNCHRONIZATION_ALWAYS</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>prepareTransactionStatus</span><span style=color:#ce5c00;font-weight:700>(</span>
          <span style=color:#000>definition</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>newSynchronization</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>debugEnabled</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>suspendedResources</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li><li><p>REQUIRES_NEW</p><p>挂起当前事务，创建一个新事务</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>definition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPropagationBehavior</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>TransactionDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PROPAGATION_REQUIRES_NEW</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#8f5902;font-style:italic>//挂起已有事务
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>SuspendedResourcesHolder</span> <span style=color:#000>suspendedResources</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>suspend</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>transaction</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>//开启一个新的事务
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>startTransaction</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>definition</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>transaction</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>debugEnabled</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>suspendedResources</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RuntimeException</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>Error</span> <span style=color:#000>beginEx</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>resumeAfterBeginException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>transaction</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>suspendedResources</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beginEx</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>beginEx</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li><li><p>NESTED</p><p>在当前事务中创建一个嵌套事务</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>definition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPropagationBehavior</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>TransactionDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PROPAGATION_NESTED</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//判断是否允许嵌套事务
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>isNestedTransactionAllowed</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NestedTransactionNotSupportedException</span><span style=color:#ce5c00;font-weight:700>(</span>
              <span style=color:#4e9a06>&#34;Transaction manager does not allow nested transactions by default - &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
              <span style=color:#4e9a06>&#34;specify &#39;nestedTransactionAllowed&#39; property with value &#39;true&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>useSavepointForNestedTransaction</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 已存在的事务创建savepoint通过TransactionStatus的SavepointManager API来实现
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>//通常使用JDBC 3.0保存点。从不激活Spring同步
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>DefaultTransactionStatus</span> <span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span>
              <span style=color:#000>prepareTransactionStatus</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>definition</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>transaction</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>debugEnabled</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>status</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createAndHoldSavepoint</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>status</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>//JTA通过提交和回滚
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>startTransaction</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>definition</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>transaction</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>debugEnabled</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li><li><p>REQUIRED、SUPPORTS、MANDATORY</p><p>这三个都是使用当前事务</p></li></ul><h4 id=32-不存在事务的传播性>3.2 不存在事务的传播性</h4><ul><li><p>MANDATORY</p><p>抛异常</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPropagationBehavior</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>TransactionDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PROPAGATION_MANDATORY</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalTransactionStateException</span><span style=color:#ce5c00;font-weight:700>(</span>
          <span style=color:#4e9a06>&#34;No existing transaction found for transaction marked with propagation &#39;mandatory&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li><li><p>REQUIRED、REQUIRES_NEW、NESTED</p><p>新建事务</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPropagationBehavior</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>TransactionDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PROPAGATION_REQUIRED</span> <span style=color:#ce5c00;font-weight:700>||</span>
      <span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPropagationBehavior</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>TransactionDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PROPAGATION_REQUIRES_NEW</span> <span style=color:#ce5c00;font-weight:700>||</span>
      <span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPropagationBehavior</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>TransactionDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PROPAGATION_NESTED</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#000>SuspendedResourcesHolder</span> <span style=color:#000>suspendedResources</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>suspend</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>startTransaction</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>transaction</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>debugEnabled</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>suspendedResources</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RuntimeException</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>Error</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>resume</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>suspendedResources</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li><li><p>SUPPORTS、NOT_SUPPORTED、NEVER</p><p>以非事务的方式运行</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#8f5902;font-style:italic>// Create &#34;empty&#34; transaction: no actual transaction, but potentially synchronization.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>newSynchronization</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getTransactionSynchronization</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>SYNCHRONIZATION_ALWAYS</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>prepareTransactionStatus</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>newSynchronization</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>debugEnabled</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li></ul><h3 id=4-事务类型传播终结>4. 事务类型传播终结</h3><table><thead><tr><th style=text-align:left></th><th style=text-align:center>不存在事务</th><th style=text-align:center>存在事务</th></tr></thead><tbody><tr><td style=text-align:left>REQUIRED</td><td style=text-align:center>新建事务</td><td style=text-align:center>使用当前事务</td></tr><tr><td style=text-align:left>REQUIRES_NEW</td><td style=text-align:center>新建事务</td><td style=text-align:center>挂起当前事务，创建一个新的事务</td></tr><tr><td style=text-align:left>NESTED</td><td style=text-align:center>新建事务</td><td style=text-align:center>在当前事务中创建一个嵌套事务</td></tr><tr><td style=text-align:left>MANDATORY</td><td style=text-align:center>抛异常</td><td style=text-align:center>使用当前事务</td></tr><tr><td style=text-align:left>SUPPORTS</td><td style=text-align:center>非事务运行</td><td style=text-align:center>使用当前事务</td></tr><tr><td style=text-align:left>NOT_SUPPORTED</td><td style=text-align:center>非事务运行</td><td style=text-align:center>挂起当前事务，强制不在事务中运行</td></tr><tr><td style=text-align:left>NEVER</td><td style=text-align:center>非事务运行</td><td style=text-align:center>抛异常</td></tr></tbody></table><h3 id=5-事务回滚>5. 事务回滚</h3><p>当设置了事务如果存在执行方法出现错误，就会对事务进行回滚。下面看一下 <strong><code>TransactionAspectSupport#completeTransactionAfterThrowing</code></strong> 方法主要负责回滚事务：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>completeTransactionAfterThrowing</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>TransactionInfo</span> <span style=color:#000>txInfo</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>txInfo</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>txInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTransactionStatus</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>txInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>transactionAttribute</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>txInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>transactionAttribute</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rollbackOn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#8f5902;font-style:italic>//回滚事务
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>txInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTransactionManager</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>rollback</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>txInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTransactionStatus</span><span style=color:#ce5c00;font-weight:700>());</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TransactionSystemException</span> <span style=color:#000>ex2</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Application exception overridden by rollback exception&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#000>ex2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>initApplicationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex2</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RuntimeException</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>Error</span> <span style=color:#000>ex2</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Application exception overridden by rollback exception&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex2</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>//不想回滚当前exception提交事务
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>txInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTransactionManager</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>commit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>txInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTransactionStatus</span><span style=color:#ce5c00;font-weight:700>());</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TransactionSystemException</span> <span style=color:#000>ex2</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Application exception overridden by commit exception&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#000>ex2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>initApplicationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex2</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RuntimeException</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>Error</span> <span style=color:#000>ex2</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Application exception overridden by commit exception&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex2</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=6-事务提交>6. 事务提交</h3><p>当方法执行完成，需要提交事务，提交是由 <strong><code>TransactionAspectSupport#commitTransactionAfterReturning</code></strong> 处理事务提交：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>commitTransactionAfterReturning</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>TransactionInfo</span> <span style=color:#000>txInfo</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>txInfo</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>txInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTransactionStatus</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>txInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTransactionManager</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>commit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>txInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTransactionStatus</span><span style=color:#ce5c00;font-weight:700>());</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-a1cc39c86d11d869ef0a1ddc3cd7a874>1.10 - Spring BeanPostProcessor执行顺序问题</h1><blockquote><p>Spring Framework版本：5.3.x</p></blockquote><p><strong><code>BeanPostProcessor</code></strong> 在Spring框架中举足轻重，还有很多继承的类。</p><p><strong>作用：管理Bean的生命周期：Bean实例化&mdash;>Bean初始化&mdash;>Bean使用中&mdash;>Bean销毁</strong></p><p>在Spring 容器初始化的时候就会存在这些类执行的一个先后的问题，今天我们就把这些类的执行先后顺序进行梳理。</p><h3 id=1-beanpostprocessor的分类>1. BeanPostProcessor的分类</h3><p><strong><code>BeanPostProcessor</code></strong> 作为顶层接口会有很多的继承接口和实现类，下图就是分类：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/spring/BeanPostProcessor%E5%88%86%E9%97%A8%E5%88%AB%E7%B1%BB.png alt=BeanPostProcessor分门别类></p><p>如上图所示包括 <strong>BeanPostProcessor</strong> 在内，一共有五个接口类。分成了三个功能模块。</p><ul><li>Bean实例化这要由InstantiationAwareBeanPostProcessor、SmartInstantiationAwareBeanPostProcessor负责。</li><li>Bean初始化由BeanPostProcessor、MergedBeanDefinitionPostProcessor两个接口负责</li><li>Bean销毁由DestructionAwareBeanPostProcessor接口负责</li></ul><p>从分类可以看出来这个五个接口分别对应Bean的三个阶段：实例化、初始化、以及销毁。那么各个阶段里面的执行顺序是怎么样的我们接着往下分析</p><h3 id=2-接口的执行顺序>2. 接口的执行顺序</h3><p>BeanPostProcessor主要负责Bean的生命周期，那么我们从获取Bean的接口入手看获取到Bean的过程中需要执行那些接口。跟踪代码最终跟踪到了 AbstractBeanFactory#doGetBean方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//AbstractBeanFactory#doGetBean
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#000>sharedInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>// Explicitly remove instance from singleton cache: It might have been put there
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#8f5902;font-style:italic>// eagerly by the creation process, to allow for circular reference resolution.
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#8f5902;font-style:italic>// Also remove any beans that received a temporary reference to the bean.
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>destroySingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>});</span>
	<span style=color:#000>beanInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sharedInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在这个当中有一个 <strong>createBean</strong> 方法。从名称可以知道是用来创建Bean的(实例化)。在这个方法里面主要有三段重要代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>doCreateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span>
		<span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanCreationException</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#8f5902;font-style:italic>//省略部分代码
</span><span style=color:#8f5902;font-style:italic></span>
	<span style=color:#8f5902;font-style:italic>// Allow post-processors to modify the merged bean definition.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>postProcessingLock</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>postProcessed</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>applyMergedBeanDefinitionPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
						<span style=color:#4e9a06>&#34;Post-processing of merged bean definition failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>postProcessed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	

	<span style=color:#8f5902;font-style:italic>// Initialize the bean instance.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Object</span> <span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>populateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>instanceWrapper</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>initializeBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>exposedObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>BeanCreationException</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(((</span><span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getBeanName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span>
					<span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Initialization of bean failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#8f5902;font-style:italic>// Register bean as disposable.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>registerDisposableBeanIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionValidationException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span>
				<span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Invalid destruction signature&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>exposedObject</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这段代码涵盖了上面五个接口的四个分别是：InstantiationAwareBeanPostProcessor、SmartInstantiationAwareBeanPostProcessor、BeanPostProcessor、MergedBeanDefinitionPostProcessor。唯一的Bean的销毁，Bean的销毁是随着Spring容器销毁而销毁的。整个执行的流程和步骤如下图：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/spring/BeanPostProcessor%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F.png alt=BeanPostProcessor执行顺序></p><p>从上图的执行顺序可以看出来：</p><ul><li>接口之间的执行顺序不是严格按照: <strong>实例化->初始化->销毁</strong> 这样的严格顺序来进行。接口方法之间的顺序会有穿插的情况。</li><li><strong>InstantiationAwareBeanPostProcessor#postProcessBeforeInstantiation</strong> 方法执行如果返回了对应的Bean的实例，后续的接口都不会执行了。 <strong><code>这里我们可以加入自定义的类。典型的例子就是动态代理的实现，可以继承当前接口并且在改方法中实现动态代理。这样在Spring 容器中的实例就是一个动态代理实例。</code></strong></li><li><strong>DestructionAwareBeanPostProcessor</strong> 接口一般情况下是不会执行，只有当Spring容器销毁就会触发容器里面类的销毁机制。</li><li>同一种类型接口如果有继承 PriorityOrdered 和Ordered进行排序。</li></ul><blockquote><p>Tips: 对于基于BeanPostProcessor自定义开发来说，主要用于自定义方法或者属性类上面的注解。这里举两个Spring的例子：<strong>AutowiredAnnotationBeanPostProcessor</strong> 处理@Autowired， @Value注解， <strong>AsyncAnnotationBeanPostProcessor</strong> 处理 @Async注解。这些注解都是在属性上或者方法上面。</p></blockquote><h3 id=3-总结>3. 总结</h3><ul><li><strong>BeanPostProcessor</strong> 接口主要是启动的时候添加到Spring容器中提供给后续的使用</li><li><strong>BeanPostProcessor</strong> 接口执行主要发生在获取Bean的流程中(Bean的生命周期)</li><li>自定义开发可以参照Spring已有的实现，能够更加明了的知道如何进行进一步拓展使用</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-39956fecc6d59f75d50963ba50e5e36a>1.11 - Spring BeanFactoryPostProcessor执行顺序</h1><h3 id=1-前言>1. 前言</h3><p>在之前的文章《<a href=https://blog.ljbmxsm.com/spring-framework/core-source-analysis/spring-beanpostprocessor-order/>Spring BeanPostProcessor执行顺序问题</a>》介绍过 <strong><code>BeanPostProcessor</code></strong> ， 使用Spring框架的人可能会注意到这样一个类 <strong><code>BeanFactoryPostProcessor</code></strong> 和 <strong><code>BeanPostProcessor</code></strong> 名称很接近。下面来看一下**<code>BeanFactoryPostProcessor</code>** 的作用。</p><p><strong>BeanFactoryPostProcessor：</strong> Spring Bean Factory的前置处理器，允许自定义修改应用上下文的Bean的定义。同时可以调整上下文的底层bean工厂的bean属性值。常用的拓展接口如下：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/spring/%E5%B8%B8%E7%94%A8%E7%9A%84%E6%8B%93%E5%B1%95%E6%8E%A5%E5%8F%A3%E7%B1%BB.png alt=常用的拓展接口类></p><p>类之间的继承关系如下：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/spring/image-20220201120007663.png alt=image-20220201120007663></p><p>上面存在两个重要的接口：</p><ul><li><strong>BeanFactoryPostProcessor</strong></li><li><strong>BeanDefinitionRegistryPostProcessor</strong></li></ul><p>接下来着重分析这两个接口的作用</p><h3 id=2接口的执行顺序>2.接口的执行顺序</h3><p>接下来从 <strong><code>BeanFactoryPostProcessor</code></strong> 和 <strong><code>BeanDefinitionRegistryPostProcessor</code></strong> 实现类注入和执行顺序来看。</p><h4 id=21-接口实现类在哪里注入>2.1 接口实现类在哪里注入？</h4><p>用现在最常用的注解上下文来解析，通过 <strong>AnnotationConfigApplicationContext</strong> 源码发现，属性 <strong>AnnotatedBeanDefinitionReader</strong> 实例化有这样一段代码：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/spring/image-20220201123122834.png alt=image-20220201123122834></p><p>跟进代码 <strong>AnnotationConfigUtils#registerAnnotationConfigProcessors</strong> 发现</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/spring/image-20220201165201280.png alt=image-20220201165201280></p><ol><li>将 <strong>ConfigurationClassPostProcessor</strong> 类的定义注册到了Spring容器中。</li></ol><p>到这里就是 <strong><code>BeanFactoryPostProcessor</code></strong> 和 <strong><code>BeanDefinitionRegistryPostProcessor</code></strong> 的接口的实现类注册到Spring容器</p><h4 id=22-接口的执行顺序>2.2 接口的执行顺序</h4><p>通过 <strong>AnnotationConfigApplicationContext</strong> 源码发现在 refresh 方法中有执行 <strong>BeanFactoryPostProcessor</strong> 。最终调用的是调用了父类的 <strong><code>AbstractApplicationContext#refresh</code></strong> 方法，在方法中有这样一段代码：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/spring/image-20220201170035512.png alt=image-20220201170035512></p><ol><li>这里就是执行 <strong>BeanFactoryPostProcessor</strong></li></ol><p>我们看一下里面 <strong><code>BeanFactoryPostProcessor</code></strong> 和 <strong><code>BeanDefinitionRegistryPostProcessor</code></strong> 接口的执行顺序，分析源码可以知道是通过 <strong><code>PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors</code></strong> 来执行，分为以下几个执行部分：</p><p><strong>执行BeanDefinitionRegistryPostProcessor：</strong></p><ul><li><p>从Spring容器中获取**<code>BeanFactoryPostProcessor</code>** 和 **<code>BeanDefinitionRegistryPostProcessor</code>** 的实现类</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/spring/image-20220201170822680.png alt=image-20220201170822680></p><blockquote><p>Tips: 如果是BeanDefinitionRegistryPostProcessor的实现类同时执行BeanDefinitionRegistryPostProcessor#postProcessBeanDefinitionRegistry方法</p></blockquote></li><li><p>首先执行 <strong>BeanDefinitionRegistryPostProcessors#postProcessBeanDefinitionRegistry</strong> 实现了 <strong>PriorityOrdered</strong> 接口的</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/spring/image-20220201173137323.png alt=image-20220201173137323></p></li><li><p>然后执行 <strong>BeanDefinitionRegistryPostProcessors#postProcessBeanDefinitionRegistry</strong> 实现了 <strong>Ordered</strong> 接口的</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/spring/image-20220201173224200.png alt=image-20220201173224200></p></li><li><p>在执行剩下的 <strong>BeanDefinitionRegistryPostProcessors#postProcessBeanDefinitionRegistry</strong></p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/spring/image-20220201173343336.png alt=image-20220201173343336></p></li><li><p>接着执行 <strong>BeanDefinitionRegistryPostProcessor#postProcessBeanFactory</strong> 方法和 <strong>BeanFactoryPostProcessor#postProcessBeanFactory</strong> 方法</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/spring/image-20220201173753538.png alt=image-20220201173753538></p></li></ul><p><strong>执行BeanFactoryPostProcessor执行：</strong></p><ul><li><p>执行 <strong>BeanFactoryPostProcessor#postProcessBeanFactory</strong> 实现了 <strong>PriorityOrdered</strong> 接口的</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>sortPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>priorityOrderedPostProcessors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>invokeBeanFactoryPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>priorityOrderedPostProcessors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div></li><li><p>执行 <strong>BeanFactoryPostProcessor#postProcessBeanFactory</strong> 实现了 <strong>Ordered</strong> 接口的</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanFactoryPostProcessor</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>orderedPostProcessors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>orderedPostProcessorNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>());</span>
<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>postProcessorName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>orderedPostProcessorNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#000>orderedPostProcessors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>postProcessorName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanFactoryPostProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>));</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#000>sortPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>orderedPostProcessors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>invokeBeanFactoryPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>orderedPostProcessors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div></li><li><p>执行剩下的 <strong>BeanFactoryPostProcessor#postProcessBeanFactory</strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanFactoryPostProcessor</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>nonOrderedPostProcessors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>nonOrderedPostProcessorNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>());</span>
<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>postProcessorName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>nonOrderedPostProcessorNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#000>nonOrderedPostProcessors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>postProcessorName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanFactoryPostProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>));</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#000>invokeBeanFactoryPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nonOrderedPostProcessors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div></li></ul><p>通过上面的代码分析总结一下 <strong><code>BeanFactoryPostProcessor</code></strong> 和 <strong><code>BeanDefinitionRegistryPostProcessor</code></strong> 执行顺序，如下图所示：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/spring/BeanFactoryPostProcessor%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B%E5%9B%BE.png alt=BeanFactoryPostProcessor执行流程图></p><ol><li>首先应该执行 <strong>BeanDefinitionRegistryPostProcessor#postProcessBeanDefinitionRegistry</strong> 方法</li><li>然后执行 <strong>BeanDefinitionRegistryPostProcessor#postProcessBeanFactory</strong> 方法</li><li>最后执行 <strong>BeanFactoryPostProcessor#postProcessBeanFactory</strong> 方法</li></ol><blockquote><p>Tips: BeanDefinitionRegistryPostProcessor和BeanFactoryPostProcessor的执行还和PriorityOrdered以及Ordered有关。</p></blockquote><h3 id=3-总结>3. 总结</h3><p><strong><code>BeanFactoryPostProcessor</code></strong> 和 <strong><code>BeanDefinitionRegistryPostProcessor</code></strong> 可通过Spring原生的实现来做一些用户自定义的拓展，例如 <strong>ConfigurationClassPostProcessor</strong> 可以受到启发我们可以自定义一些配置在类上面的注解，例如自定义和@Component类似的注解。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-2615c35b44fb6aeca773448025d3bf0f>1.12 - BeanDefinition详解</h1><h3 id=1-beandefinition的继承图>1. BeanDefinition的继承图</h3><p><img src="https://github.com/mxsm/document/blob/master/image/Spring/Springframework/BeanDefinition.png?raw=true" alt=图解></p><p>BeanDefinition其实就是对Bean的一种抽象：
Spring中的Bean抽象&mdash;&mdash;&ndash;BeanDefinition
Bean的属性操作抽象&mdash;&mdash;&ndash;AttributeAccessor(属性存取器)对属性进行操作
Bean的元数据项抽象&mdash;&mdash;&ndash;BeanMetadataElement（Bean的元数据）</p><h3 id=2-attributeaccessor属性存取器的源码解析>2. AttributeAccessor属性存取器的源码解析</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>AttributeAccessor</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#8f5902;font-style:italic>//设置属性
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>Object</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>

	<span style=color:#8f5902;font-style:italic>//获取属性
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#000>Object</span> <span style=color:#000>getAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>

	<span style=color:#8f5902;font-style:italic>//删除属性
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#000>Object</span> <span style=color:#000>removeAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>

	<span style=color:#8f5902;font-style:italic>//判断属性name是否存在
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>hasAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>//获取属性列表
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>attributeNames</span><span style=color:#ce5c00;font-weight:700>();</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>AttributeAccessor实现的抽象方法是AttributeAccessorSupport，这里面对接口所有的方法都进行了实现。</p><h3 id=3-beanmetadataelement源码解析>3. BeanMetadataElement源码解析</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>BeanMetadataElement</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#8f5902;font-style:italic>//元数据元素的配置的源bean对象
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#204a87;font-weight:700>default</span> <span style=color:#000>Object</span> <span style=color:#000>getSource</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>BeanMetadataAttribute实现了BeanMetadataElement接口。</p><h3 id=4-beanmetadataelement和attributeaccessor关联>4. BeanMetadataElement和AttributeAccessor关联</h3><p>通过 BeanMetadataAttributeAccessor 类整合对Bean的操作AttributeAccessor以及BeanMetadataElement</p><h3 id=5beandifinition源码分析>5.BeanDifinition源码分析</h3><p><strong><code>BeanDifinition</code></strong> 其实就是一个接口，描述一个bean的实例，包括属性值，构造方法参数值和继承自它的类的更多信息以及一些依赖信息，懒加载等等。BeanDefinition仅仅是一个最简单的接口，主要功能是允许BeanFactoryPostProcessor 例如PropertyPlaceHolderConfigure 能够检索并修改属性值和别的bean的元数据。下面来分析一下源码</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>BeanDefinition</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AttributeAccessor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanMetadataElement</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>	 * 标准单例作用域的作用域标识符：“singleton”。
</span><span style=color:#8f5902;font-style:italic>	 * 对于扩展的bean工厂可能支持更多的作用域。
</span><span style=color:#8f5902;font-style:italic>	 * 注意：在Spring中默认的创建的对象就是单例模式
</span><span style=color:#8f5902;font-style:italic>	 */</span>
	<span style=color:#000>String</span> <span style=color:#000>SCOPE_SINGLETON</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ConfigurableBeanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SCOPE_SINGLETON</span><span style=color:#ce5c00;font-weight:700>;</span>

	<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>	 * 标准原型作用域的范围标识符：“prototype”。
</span><span style=color:#8f5902;font-style:italic>	 * 对于扩展的bean工厂可能支持更多的作用域。
</span><span style=color:#8f5902;font-style:italic>	 */</span>
	<span style=color:#000>String</span> <span style=color:#000>SCOPE_PROTOTYPE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ConfigurableBeanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SCOPE_PROTOTYPE</span><span style=color:#ce5c00;font-weight:700>;</span>


	<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>	 * 表示BeanDefinition是应用程序主要部分的角色提示。 通常对应于用户定义的bean。
</span><span style=color:#8f5902;font-style:italic>	 */</span>
	<span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ROLE_APPLICATION</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>

	<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>	 * 表示BeanDefinition是某些大型配置的支持部分的角色提示，通常是一个外部ComponentDefinition
</span><span style=color:#8f5902;font-style:italic>	 * 当查看某个特定的ComponentDefinition时，认为bean非常重要，以便在查看应用程序的整体配置时能够意识到这一点。
</span><span style=color:#8f5902;font-style:italic>	 * 注意：实际上就是说，我这个Bean是用户的，是从配置文件中过来的
</span><span style=color:#8f5902;font-style:italic>	 */</span>
	<span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ROLE_SUPPORT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>

	<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>	 * 角色提示表明一个BeanDefinition是提供一个完全背后的角色，并且与最终用户没有关系。
</span><span style=color:#8f5902;font-style:italic>	 * 这个提示用于注册完全是ComponentDefinition内部工作的一部分的bean
</span><span style=color:#8f5902;font-style:italic>	 * 注意：这Bean是Spring内部的和使用的用户没有关系
</span><span style=color:#8f5902;font-style:italic>	 */</span>
	<span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ROLE_INFRASTRUCTURE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>;</span>


	<span style=color:#8f5902;font-style:italic>// Modifiable attributes
</span><span style=color:#8f5902;font-style:italic></span>
	<span style=color:#8f5902;font-style:italic>//如果父类存在，设置这个bean定义的父定义的名称
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setParentName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>String</span> <span style=color:#000>parentName</span><span style=color:#ce5c00;font-weight:700>);</span>

	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#000>String</span> <span style=color:#000>getParentName</span><span style=color:#ce5c00;font-weight:700>();</span>

	<span style=color:#8f5902;font-style:italic>//指定此bean定义的bean类名称。
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>//类名称可以在bean factory后期处理中修改，通常用它的解析变体替换原来的类名称。
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setBeanClassName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>String</span> <span style=color:#000>beanClassName</span><span style=color:#ce5c00;font-weight:700>);</span>

	<span style=color:#8f5902;font-style:italic>//返回此bean定义的当前bean类名称。
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>//需要注意的是，这不一定是在运行时使用的实际类名，以防子类定义覆盖/继承其父类的类名。
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>//此外，这可能只是调用工厂方法的类，或者它 在调用方法的工厂bean引用的情况下甚至可能是空的。
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>//因此，不要认为这是在运行时定义的bean类型，而只是将其用于在单独的bean定义级别进行解析。
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#000>String</span> <span style=color:#000>getBeanClassName</span><span style=color:#ce5c00;font-weight:700>();</span>

	<span style=color:#8f5902;font-style:italic>//设置和获取scope
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setScope</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>String</span> <span style=color:#000>scope</span><span style=color:#ce5c00;font-weight:700>);</span>

	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#000>String</span> <span style=color:#000>getScope</span><span style=color:#ce5c00;font-weight:700>();</span>

	<span style=color:#8f5902;font-style:italic>//设置是否需要懒加载 ---- 默认是非懒加载在Spring的默认实现过程
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setLazyInit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>lazyInit</span><span style=color:#ce5c00;font-weight:700>);</span>

	<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isLazyInit</span><span style=color:#ce5c00;font-weight:700>();</span>

	<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>	 *
</span><span style=color:#8f5902;font-style:italic>	 * 设置当前beand依赖,需要被初始化这些依赖bean,beanFacotryb保证首先初始化这些依赖的bean
</span><span style=color:#8f5902;font-style:italic>	 */</span>
	<span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setDependsOn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>dependsOn</span><span style=color:#ce5c00;font-weight:700>);</span>

	<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>	 *获取依赖bean的名称
</span><span style=color:#8f5902;font-style:italic>	 */</span>
	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>getDependsOn</span><span style=color:#ce5c00;font-weight:700>();</span>

	<span style=color:#8f5902;font-style:italic>//设置这个bean是否是获得自动装配到其他bean的候选人。
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>//需要注意是，此标志旨在仅影响基于类型的自动装配。---默认是按照类型进行装配
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>//它不会影响按名称的显式引用，即使指定的bean没有标记为autowire候选，也可以解决这个问题。
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>//因此，如果名称匹配，通过名称的自动装配将注入一个bean。
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setAutowireCandidate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>autowireCandidate</span><span style=color:#ce5c00;font-weight:700>);</span>

	<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>	 * 返回这个bean是否是自动装配到其他bean的候选者。就是是否在其他类中使用autowired来注入当前Bean的
</span><span style=color:#8f5902;font-style:italic>	 */</span>
	<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isAutowireCandidate</span><span style=color:#ce5c00;font-weight:700>();</span>

	<span style=color:#8f5902;font-style:italic>//是否为主候选bean    使用注解：@Primary
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setPrimary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>primary</span><span style=color:#ce5c00;font-weight:700>);</span>

	<span style=color:#8f5902;font-style:italic>//返回这个bean是否是主要的autowire候选者。
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isPrimary</span><span style=color:#ce5c00;font-weight:700>();</span>

	<span style=color:#8f5902;font-style:italic>//指定要使用的工厂bean（如果有的话）。 这是调用指定的工厂方法的bean的名称
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setFactoryBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>String</span> <span style=color:#000>factoryBeanName</span><span style=color:#ce5c00;font-weight:700>);</span>

	<span style=color:#8f5902;font-style:italic>//返回工厂bean的名字，如果有的话。
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#000>String</span> <span style=color:#000>getFactoryBeanName</span><span style=color:#ce5c00;font-weight:700>();</span>

	<span style=color:#8f5902;font-style:italic>//如果有的话，指定工厂方法。
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>//这个方法先将通过构造函数参数被调用，或者如果参数，将调用该方法的无参数构造。
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>//方法将在指定的工厂bean（如果有的话）上被调用，或者作为本地bean类的静态方法被调用
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setFactoryMethodName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>String</span> <span style=color:#000>factoryMethodName</span><span style=color:#ce5c00;font-weight:700>);</span>

	<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>	 * 返回工厂方法如果有的话
</span><span style=color:#8f5902;font-style:italic>	 */</span>
	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#000>String</span> <span style=color:#000>getFactoryMethodName</span><span style=color:#ce5c00;font-weight:700>();</span>

	<span style=color:#8f5902;font-style:italic>//返回此bean的构造函数参数值。
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>ConstructorArgumentValues</span> <span style=color:#000>getConstructorArgumentValues</span><span style=color:#ce5c00;font-weight:700>();</span>

	<span style=color:#8f5902;font-style:italic>//判断是否有构造函数参数--5.1版本开始
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>hasConstructorArgumentValues</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>getConstructorArgumentValues</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#8f5902;font-style:italic>//获取普通属性集合
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>MutablePropertyValues</span> <span style=color:#000>getPropertyValues</span><span style=color:#ce5c00;font-weight:700>();</span>

	<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>	 * 判断是否有PropertyValues
</span><span style=color:#8f5902;font-style:italic>	 * @since 5.0.2
</span><span style=color:#8f5902;font-style:italic>	 */</span>
	<span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>hasPropertyValues</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>getPropertyValues</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#8f5902;font-style:italic>//设置和获取初始化方法的名称--从5.1版本开始
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setInitMethodName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>String</span> <span style=color:#000>initMethodName</span><span style=color:#ce5c00;font-weight:700>);</span>

	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#000>String</span> <span style=color:#000>getInitMethodName</span><span style=color:#ce5c00;font-weight:700>();</span>


	<span style=color:#8f5902;font-style:italic>//设置和获取Destroy方法的名称  -- 从5.1版本开始
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setDestroyMethodName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>String</span> <span style=color:#000>destroyMethodName</span><span style=color:#ce5c00;font-weight:700>);</span>

	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#000>String</span> <span style=color:#000>getDestroyMethodName</span><span style=color:#ce5c00;font-weight:700>();</span>


	<span style=color:#8f5902;font-style:italic>//设置和获取角色
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setRole</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>role</span><span style=color:#ce5c00;font-weight:700>);</span>

	<span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>getRole</span><span style=color:#ce5c00;font-weight:700>();</span>


	<span style=color:#8f5902;font-style:italic>//设置和获取人可以读的描述--人可以理解的描述 从5.1版本开始
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setDescription</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>String</span> <span style=color:#000>description</span><span style=color:#ce5c00;font-weight:700>);</span>

	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#000>String</span> <span style=color:#000>getDescription</span><span style=color:#ce5c00;font-weight:700>();</span>


	<span style=color:#8f5902;font-style:italic>//判断是否为单例
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isSingleton</span><span style=color:#ce5c00;font-weight:700>();</span>

	<span style=color:#8f5902;font-style:italic>//判断是否为原型
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isPrototype</span><span style=color:#ce5c00;font-weight:700>();</span>

	<span style=color:#8f5902;font-style:italic>//判断是否为抽象Bean，如果是就不能实例化
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isAbstract</span><span style=color:#ce5c00;font-weight:700>();</span>

	<span style=color:#8f5902;font-style:italic>//返回BeanDefinition的资源描述
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#000>String</span> <span style=color:#000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>();</span>

	<span style=color:#8f5902;font-style:italic>//返回原始的BeanDefinition如果没有返回null
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#000>BeanDefinition</span> <span style=color:#000>getOriginatingBeanDefinition</span><span style=color:#ce5c00;font-weight:700>();</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-abb7fad47b98204f5f6de5a9e8c54ac7>1.13 - FactoryBean解析</h1><h3 id=spring-factorybean应用>Spring FactoryBean应用</h3><p>Spring中的Bean有两种：</p><ul><li><p>普通的bean</p></li><li><p>工厂Bean也就是实现了FactoryBean</p><p>FactoryBean跟普通Bean不同，其返回的对象不是指定类的一个实例，而是该FactoryBean的getObject方法所返回的对象。</p></li></ul><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>FactoryBean</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#000>T</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>;</span>

	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>getObjectType</span><span style=color:#ce5c00;font-weight:700>();</span>

	<span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isSingleton</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=应用场景>应用场景</h3><p>FactoryBean 通常是用来创建比较复杂的bean，一般的bean 直接用xml配置即可，但如果一个bean的创建过程中涉及到很多其他的bean 和复杂的逻辑，用xml配置比较困难，这时可以考虑用FactoryBean</p><h3 id=应用案例>应用案例</h3><p>很多开源项目在集成Spring 时都使用到FactoryBean，比如 <a href="https://link.jianshu.com/?t=https://github.com/mybatis/mybatis-3">MyBatis3</a> 提供 mybatis-spring项目中的 <code>org.mybatis.spring.SqlSessionFactoryBean</code></p><blockquote><p>项目地址：</p><p><a href=https://github.com/mybatis/spring/blob/master/src/main/java/org/mybatis/spring/SqlSessionFactoryBean.java>https://github.com/mybatis/spring/blob/master/src/main/java/org/mybatis/spring/SqlSessionFactoryBean.java</a></p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-e1d5790d737f798c0bb85785310337f2>1.14 - Spring 生命周期</h1><h3 id=1-spring-bean的生命周期>1. Spring Bean的生命周期</h3><pre><code class=language-flow data-lang=flow>st=&gt;start: 加载BeanDefination
circularCondition=&gt;condition: 获取依赖并且判断不是循环依赖
beforeInstantiation=&gt;operation: 实例化之前调用InstantiationAwareBeanPostProcessor#postProcessBeforeInstantiation方法
CandidateConstructors=&gt;operation: 调用构造函数自动装配SmartInstantiationAwareBeanPostProcessor#determineCandidateConstructors方法
afterInstantiation=&gt;operation: 调用InstantiationAwareBeanPostProcessor#postProcessAfterInstantiation方法
postProcessProperties=&gt;operation: 调用InstantiationAwareBeanPostProcessor#postProcessProperties方法
instantiateBean=&gt;operation: 实例化完成Bean
mergedBeanDefinitionPostProcessor=&gt;operation: bean定义合并调用MergedBeanDefinitionPostProcessor#postProcessMergedBeanDefinition方法
invokeAwareMethods=&gt;operation: 执行BeanNameAware,BeanClassLoaderAware,BeanFactoryAware的相关方法
BeanPostProcessorBeforeInitialization=&gt;operation: 执行BeanPostProcessor#postProcessBeforeInitialization方法
invokeInitMethods=&gt;operation: 执行初始化方法InitializingBean#afterPropertiesSet(实现了InitializingBean)或者使用了注解PostConstruct或者在xml中定义了Init方法
BeanPostProcessorsAfterInitialization=&gt;operation: 调用初始化后的方法BeanPostProcessor#postProcessAfterInitialization
earlySingletonExposure=&gt;operation: 饥饿加载Bean的属性
registerDisposableBeanIfNecessary=&gt;operation: 继承了DisposableBean和定义了destroy方法来注入
e=&gt;end

st-&gt;circularCondition

circularCondition(yes)-&gt;beforeInstantiation-&gt;CandidateConstructors-&gt;afterInstantiation-&gt;postProcessProperties-&gt;instantiateBean-&gt;mergedBeanDefinitionPostProcessor-&gt;invokeAwareMethods-&gt;BeanPostProcessorBeforeInitialization-&gt;invokeInitMethods-&gt;BeanPostProcessorsAfterInitialization-&gt;earlySingletonExposure-&gt;registerDisposableBeanIfNecessary-&gt;e

circularCondition(no)-&gt;e
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-62c29b6f4d5e06f0614612c6a8964b80>1.15 - BeanPostProcessor相关接口执行的方法</h1><h3 id=1-beanpostprocessor相关接口>1. BeanPostProcessor相关接口</h3><ul><li><strong>InstantiationAwareBeanPostProcessor</strong></li><li><strong>DestructionAwareBeanPostProcessor</strong></li><li><strong>MergedBeanDefinitionPostProcessor</strong></li><li><strong>SmartInstantiationAwareBeanPostProcessor</strong></li></ul><p>四个继承接口加上 <em><strong><code>BeanPostProcessor</code></strong></em> 一共五个接口。看一下这五个接口的方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>BeanPostProcessor</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#204a87;font-weight:700>default</span> <span style=color:#000>Object</span> <span style=color:#000>postProcessBeforeInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#204a87;font-weight:700>default</span> <span style=color:#000>Object</span> <span style=color:#000>postProcessAfterInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>InstantiationAwareBeanPostProcessor</strong> 、 <strong>DestructionAwareBeanPostProcessor</strong>、 <strong>MergedBeanDefinitionPostProcessor</strong> 继承了 <strong>BeanPostProcessor</strong> ：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>InstantiationAwareBeanPostProcessor</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BeanPostProcessor</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#204a87;font-weight:700>default</span> <span style=color:#000>Object</span> <span style=color:#000>postProcessBeforeInstantiation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>postProcessAfterInstantiation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#8f5902;font-style:italic>//@since 5.1
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#204a87;font-weight:700>default</span> <span style=color:#000>PropertyValues</span> <span style=color:#000>postProcessProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PropertyValues</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span>
			<span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>

		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>DestructionAwareBeanPostProcessor</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BeanPostProcessor</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>postProcessBeforeDestruction</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>requiresDestruction</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>MergedBeanDefinitionPostProcessor</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BeanPostProcessor</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>postProcessMergedBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RootBeanDefinition</span> <span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>beanType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
	
		<span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>resetBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>SmartInstantiationAwareBeanPostProcessor</strong> 继承了 <strong>InstantiationAwareBeanPostProcessor</strong> 接口。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>SmartInstantiationAwareBeanPostProcessor</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>InstantiationAwareBeanPostProcessor</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#204a87;font-weight:700>default</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>predictBeanType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#204a87;font-weight:700>default</span> <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>determineCandidateConstructors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span>
			<span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>

		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>default</span> <span style=color:#000>Object</span> <span style=color:#000>getEarlyBeanReference</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=2-beanpostprocessor相关接口执行顺序>2. BeanPostProcessor相关接口执行顺序</h3><ol><li>InstantiationAwareBeanPostProcessor#postProcessBeforeInstantiation</li><li>MergedBeanDefinitionPostProcessor#postProcessMergedBeanDefinition</li><li>SmartInstantiationAwareBeanPostProcessor#getEarlyBeanReference</li><li>InstantiationAwareBeanPostProcessor#postProcessAfterInstantiation</li><li>InstantiationAwareBeanPostProcessor#postProcessProperties</li><li>BeanPostProcessor#postProcessBeforeInitialization</li><li>BeanPostProcessor#postProcessAfterInitialization</li><li>DestructionAwareBeanPostProcessor#requiresDestruction</li><li>DestructionAwareBeanPostProcessor#postProcessBeforeDestruction</li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-10c05e17c6be4f5167e0f8d9453d3407>1.16 - Spring XML解析源码分析</h1><h3 id=1-spring-xml解析>1. Spring XML解析</h3><p>在Spring的配置中XML是一个很重要的配置方案，下面来分析一下Spring是如何把定义在XML中的数据类加载到Spring容器中的。</p><h3 id=2-abstractapplicationcontextobtainfreshbeanfactory>2. AbstractApplicationContext#obtainFreshBeanFactory</h3><p>在<strong>AbstractApplicationContext</strong> 抽象类中通过 <strong><code>obtainFreshBeanFactory</code></strong> 的方法来加载XML中的定义的Bean。下面来看一下方法**<code>obtainFreshBeanFactory</code>** 的代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>obtainFreshBeanFactory</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>refreshBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过上面的代码可以看到，方法中只有两个方法：</p><ul><li><p><strong>refreshBeanFactory</strong></p><p>刷新BeanFactory,加载XML</p></li><li><p><strong>getBeanFactory</strong></p><p>返回BeanFactory的引用</p></li></ul><p>在<strong>AbstractApplicationContext</strong> 中<strong>refreshBeanFactory</strong> 是一个抽象的方法，实现主要是有子类实现，对于XML而言，<strong><code>AbstractRefreshableApplicationContext</code></strong> 实现了该方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>refreshBeanFactory</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    	<span style=color:#8f5902;font-style:italic>//如果存在BeanFactory首先对之前的进行处理
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasBeanFactory</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>destroyBeans</span><span style=color:#ce5c00;font-weight:700>();</span>
			<span style=color:#000>closeBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//创建BeanFactory
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>DefaultListableBeanFactory</span> <span style=color:#000>beanFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#8f5902;font-style:italic>//设置序列化ID
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSerializationId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getId</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#8f5902;font-style:italic>//设置是否允许循环引用 和 bean的定义覆盖
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>customizeBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 加载bean的定义到Spring容器
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanFactoryMonitor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IOException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ApplicationContextException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;I/O error parsing bean definition source for &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>getDisplayName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过上面的代码分析可以看到Spring容器加载XML中的定义通过 <strong><code>loadBeanDefinitions</code></strong> 方法，在<strong>AbstractRefreshableApplicationContext</strong> 中是一个抽象的方法。实现在子类中，对于XML的加载Bean的定义实现在 <strong><code>AbstractXmlApplicationContext</code></strong> 类中：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DefaultListableBeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>// 为BeanFactory创建一个 XmlBeanDefinitionReader.
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>XmlBeanDefinitionReader</span> <span style=color:#000>beanDefinitionReader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>XmlBeanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

		<span style=color:#8f5902;font-style:italic>//beanDefinitionReader设置参数
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>beanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setEnvironment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#000>beanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setResourceLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>beanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setEntityResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ResourceEntityResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>));</span>

		<span style=color:#8f5902;font-style:italic>//初始化XML BeanDefinitionReader
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>initBeanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>//加载Bean定义
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>XML的文件的读取是通过<strong>XmlBeanDefinitionReader</strong> 来进行读取数据。在<strong>AbstractXmlApplicationContext</strong> 类中有一个**<code>loadBeanDefinitions(XmlBeanDefinitionReader reader)</code>** 方法来进行加载XML文件中Bean的定义。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XmlBeanDefinitionReader</span> <span style=color:#000>reader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//获取配置的Resource进行加载
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>Resource</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>configResources</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getConfigResources</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configResources</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>reader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configResources</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//获取配置的地址进行加载--（用ClassPathXmlApplicationContext创建填入application.xml的就是通过这个地方加载）
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>configLocations</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getConfigLocations</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configLocations</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>reader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configLocations</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>所以接下来主要加载都是通过**<code>XmlBeanDefinitionReader#loadBeanDefinitions</code>** 方法来加载XML中的Bean的定义。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>locations</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>locations</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Location array must not be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>location</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>locations</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong><code>XmlBeanDefinitionReader#loadBeanDefinitions</code></strong> 调用了父类的方法 <strong><code>AbstractBeanDefinitionReader#loadBeanDefinitions</code></strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Resource</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>actualResources</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>ResourceLoader</span> <span style=color:#000>resourceLoader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getResourceLoader</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resourceLoader</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionStoreException</span><span style=color:#ce5c00;font-weight:700>(</span>
					<span style=color:#4e9a06>&#34;Cannot load bean definitions from location [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>location</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]: no ResourceLoader available&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resourceLoader</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>ResourcePatternResolver</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>// Resource pattern matching available.
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>Resource</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>resources</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ResourcePatternResolver</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>resourceLoader</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getResources</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resources</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>actualResources</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>Collections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>actualResources</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resources</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTraceEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Loaded &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; bean definitions from location pattern [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>location</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IOException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionStoreException</span><span style=color:#ce5c00;font-weight:700>(</span>
						<span style=color:#4e9a06>&#34;Could not resolve bean definition resource pattern [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>location</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>// Can only load single resources by absolute URL.
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>Resource</span> <span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resourceLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>location</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>actualResources</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>actualResources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTraceEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Loaded &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; bean definitions from location [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>location</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在 <strong><code>loadBeanDefinitions</code></strong> 实现在XML中是通过 <strong><code>XmlBeanDefinitionReader</code></strong> 中实现</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>EncodedResource</span> <span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;EncodedResource must not be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTraceEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Loading XML bean definitions from &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>EncodedResource</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>currentResources</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resourcesCurrentlyBeingLoaded</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentResources</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>currentResources</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resourcesCurrentlyBeingLoaded</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentResources</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>currentResources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionStoreException</span><span style=color:#ce5c00;font-weight:700>(</span>
					<span style=color:#4e9a06>&#34;Detected cyclic loading of &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>encodedResource</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; - check your import definitions!&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>InputStream</span> <span style=color:#000>inputStream</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResource</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getInputStream</span><span style=color:#ce5c00;font-weight:700>();</span>
			<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>InputSource</span> <span style=color:#000>inputSource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InputSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputStream</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getEncoding</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>inputSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setEncoding</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getEncoding</span><span style=color:#ce5c00;font-weight:700>());</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#8f5902;font-style:italic>//加载xml中的Bean定义
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>doLoadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputSource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResource</span><span style=color:#ce5c00;font-weight:700>());</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>inputStream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IOException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionStoreException</span><span style=color:#ce5c00;font-weight:700>(</span>
					<span style=color:#4e9a06>&#34;IOException parsing XML document from &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResource</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>currentResources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentResources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resourcesCurrentlyBeingLoaded</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>();</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div><p>通过上面的代码可以看出来 <strong><code>doLoadBeanDefinitions</code></strong> 主要通过这个方法加载XML中的Bean定义</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>doLoadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InputSource</span> <span style=color:#000>inputSource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Resource</span> <span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>)</span>
			<span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#ce5c00;font-weight:700>{</span>

			<span style=color:#8f5902;font-style:italic>//读取 xml document
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>Document</span> <span style=color:#000>doc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>doLoadDocument</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputSource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
    		<span style=color:#8f5902;font-style:italic>//往Spring容器中注册 Bean定义
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>registerBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>doc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Loaded &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; bean definitions from &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>;</span>
    		<span style=color:#8f5902;font-style:italic>// 省略了try catch模块
</span><span style=color:#8f5902;font-style:italic></span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong><code>XmlBeanDefinitionReader#registerBeanDefinitions(doc, resource)</code></strong> 方法就是加载类的定义</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>registerBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Document</span> <span style=color:#000>doc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Resource</span> <span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>BeanDefinitionDocumentReader</span> <span style=color:#000>documentReader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createBeanDefinitionDocumentReader</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>countBefore</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getRegistry</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getBeanDefinitionCount</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>//注册Bean
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>documentReader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>doc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>createReaderContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>));</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getRegistry</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getBeanDefinitionCount</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>countBefore</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div><p><strong><code>BeanDefinitionDocumentReader#registerBeanDefinitions</code></strong> 进行注册，而 <strong><code>registerBeanDefinitions</code></strong> 方法的实现在 <strong>DefaultBeanDefinitionDocumentReader</strong> 类</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Document</span> <span style=color:#000>doc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>XmlReaderContext</span> <span style=color:#000>readerContext</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readerContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>readerContext</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#000>doRegisterBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>doc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDocumentElement</span><span style=color:#ce5c00;font-weight:700>());</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>doRegisterBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Element</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

		<span style=color:#000>BeanDefinitionParserDelegate</span> <span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>delegate</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>delegate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createDelegate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getReaderContext</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>);</span>

		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDefaultNamespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>String</span> <span style=color:#000>profileSpec</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PROFILE_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasText</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>profileSpec</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>specifiedProfiles</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>tokenizeToStringArray</span><span style=color:#ce5c00;font-weight:700>(</span>
						<span style=color:#000>profileSpec</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinitionParserDelegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MULTI_VALUE_ATTRIBUTE_DELIMITERS</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#8f5902;font-style:italic>// We cannot use Profiles.of(...) since profile expressions are not supported
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#8f5902;font-style:italic>// in XML config. See SPR-12458 for details.
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>getReaderContext</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>acceptsProfiles</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>specifiedProfiles</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Skipped XML bean definition file due to specified profiles [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>profileSpec</span> <span style=color:#ce5c00;font-weight:700>+</span>
								<span style=color:#4e9a06>&#34;] not matching: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>getReaderContext</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getResource</span><span style=color:#ce5c00;font-weight:700>());</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#000>preProcessXml</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>//解析Bean的定义
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>parseBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>delegate</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>postProcessXml</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>);</span>

		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>delegate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>分析一下 <strong>parseBeanDefinitions(root, this.delegate)</strong> 方法中是如何进行数据解析：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>parseBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Element</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinitionParserDelegate</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//判断是否为默认的命名空间 http://www.springframework.org/schema/beans
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDefaultNamespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>NodeList</span> <span style=color:#000>nl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildNodes</span><span style=color:#ce5c00;font-weight:700>();</span>
			<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>nl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLength</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>Node</span> <span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>item</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Element</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>Element</span> <span style=color:#000>ele</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Element</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#8f5902;font-style:italic>//判断是否是自定义的命名空间
</span><span style=color:#8f5902;font-style:italic></span>					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDefaultNamespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>//解析默认的命名空间
</span><span style=color:#8f5902;font-style:italic></span>						<span style=color:#000>parseDefaultElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>//解析自定义的命名空间
</span><span style=color:#8f5902;font-style:italic></span>						<span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseCustomElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseCustomElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>parseDefaultElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Element</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinitionParserDelegate</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//解析import
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nodeNameEquals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IMPORT_ELEMENT</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>importBeanDefinitionResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//解析alias
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nodeNameEquals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ALIAS_ELEMENT</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>processAliasRegistration</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//解析bean
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nodeNameEquals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BEAN_ELEMENT</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>processBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//解析beans
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nodeNameEquals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>NESTED_BEANS_ELEMENT</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>// recurse
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>doRegisterBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>分析一下如何处理自定义的XML通过 <strong>BeanDefinitionParserDelegate#parseCustomElement</strong> 方法</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BeanDefinition</span> <span style=color:#000>parseCustomElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Element</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>parseCustomElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BeanDefinition</span> <span style=color:#000>parseCustomElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Element</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>BeanDefinition</span> <span style=color:#000>containingBd</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//获取命名空间的URI
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>String</span> <span style=color:#000>namespaceUri</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getNamespaceURI</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>namespaceUri</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//获取处理命名空间的NamespaceHandler--
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>NamespaceHandler</span> <span style=color:#000>handler</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readerContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNamespaceHandlerResolver</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>resolve</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>namespaceUri</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handler</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Unable to locate Spring NamespaceHandler for XML schema namespace [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>namespaceUri</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ParserContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readerContext</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>containingBd</span><span style=color:#ce5c00;font-weight:700>));</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-454fafdb77c733b3d299b306329bd698>1.17 - ClassPathXmlApplicationContext源码解析</h1><h3 id=1-classpathxmlapplicationcontext源码解析>1. ClassPathXmlApplicationContext源码解析</h3><p>从名称可以看出来这个 <strong>ApplicationContext</strong> 主要负责Class Path 的xml对Spring 框架的解析</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ClassPathXmlApplicationContext</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractXmlApplicationContext</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Resource</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>configResources</span><span style=color:#ce5c00;font-weight:700>;</span>

	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationContext</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>configLocation</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>configLocation</span><span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>configLocations</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configLocations</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>configLocations</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>ApplicationContext</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>)</span>
			<span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>

		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configLocations</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>configLocations</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>refresh</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configLocations</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>refresh</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span>
			<span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>configLocations</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>refresh</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>ApplicationContext</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>)</span>
			<span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>

		<span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>setConfigLocations</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configLocations</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>refresh</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>refresh</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
    
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>paths</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>paths</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>paths</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>ApplicationContext</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>)</span>
			<span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>

		<span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>paths</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Path array must not be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Class argument must not be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configResources</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Resource</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>paths</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>];</span>
		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>paths</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configResources</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassPathResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>paths</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#000>refresh</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#ce5c00;font-weight:700>}</span>


	<span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Resource</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>getConfigResources</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configResources</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从上面的代码可以看出来主要就是几个 <strong><code>ClassPathXmlApplicationContext</code></strong> 的构造函数。构造函数的主要目的是为了读取配置文件。通过获取到 <strong><code>Resource</code></strong> (在Spring中所有的配置文件都被抽象成了一个资源)。主要的通过调用 <strong><code>refresh()</code></strong> 方法。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AbstractApplicationContext</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>DefaultResourceLoader</span>
		<span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>ConfigurableApplicationContext</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>refresh</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IllegalStateException</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>startupShutdownMonitor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>//准备刷新当前 ApplicationContext.
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>prepareRefresh</span><span style=color:#ce5c00;font-weight:700>();</span>

			<span style=color:#8f5902;font-style:italic>// 告诉子类去刷新内部的Bean Factory--bean的解析和加载Bean的定义
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>beanFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>obtainFreshBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>


			<span style=color:#8f5902;font-style:italic>//准备 bean factory 能使用当前的context
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>prepareBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

			<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#8f5902;font-style:italic>//允许在上下文子类中对bean工厂进行后处理
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>postProcessBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

				<span style=color:#8f5902;font-style:italic>//调用 factory processors在当前 context 注册为Beans
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>invokeBeanFactoryPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

				<span style=color:#8f5902;font-style:italic>//注册Bean的后置处理器
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>registerBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

				<span style=color:#8f5902;font-style:italic>// 为当前context初始化消息资源 .
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>initMessageSource</span><span style=color:#ce5c00;font-weight:700>();</span>

				<span style=color:#8f5902;font-style:italic>// 初始化事件多路通道.
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>initApplicationEventMulticaster</span><span style=color:#ce5c00;font-weight:700>();</span>

				<span style=color:#8f5902;font-style:italic>// 初始化其他特殊的beans在特殊context子类
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>onRefresh</span><span style=color:#ce5c00;font-weight:700>();</span>

				<span style=color:#8f5902;font-style:italic>// 检查和注册监听
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>registerListeners</span><span style=color:#ce5c00;font-weight:700>();</span>

				<span style=color:#8f5902;font-style:italic>//实例化所有的剩下的单例(非懒加载初始化)
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>finishBeanFactoryInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

				<span style=color:#8f5902;font-style:italic>//发布匹配事件.
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>finishRefresh</span><span style=color:#ce5c00;font-weight:700>();</span>
			<span style=color:#ce5c00;font-weight:700>}</span>

			<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isWarnEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Exception encountered during context initialization - &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
							<span style=color:#4e9a06>&#34;cancelling refresh attempt: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>

				<span style=color:#8f5902;font-style:italic>// Destroy already created singletons to avoid dangling resources.
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>destroyBeans</span><span style=color:#ce5c00;font-weight:700>();</span>

				<span style=color:#8f5902;font-style:italic>// Reset &#39;active&#39; flag.
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>cancelRefresh</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>

				<span style=color:#8f5902;font-style:italic>// Propagate exception to caller.
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>

			<span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#8f5902;font-style:italic>// Reset common introspection caches in Spring&#39;s core, since we
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#8f5902;font-style:italic>// might not ever need metadata for singleton beans anymore...
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>resetCommonCaches</span><span style=color:#ce5c00;font-weight:700>();</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>看一下上面代码的流程图解：</p><p><img src="https://github.com/mxsm/document/blob/master/image/Spring/Springframework/AbstractApplicationContextReflash%E8%87%AA%E8%A1%8C%E6%B5%81%E7%A8%8B%E5%9B%BE.png?raw=true" alt></p><p>上面代码省略了其他方法。接下来一个个来解析方法：</p><ul><li><p><strong><code>prepareRefresh()</code></strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>prepareRefresh</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#8f5902;font-style:italic>// 首先标记为active状态
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>startupDate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>closed</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>active</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>

	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTraceEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Refreshing &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Refreshing &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>getDisplayName</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#8f5902;font-style:italic>// 在context中初始化任何有占位符的资源----由AbstractApplicationContext的子类实现
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>initPropertySources</span><span style=color:#ce5c00;font-weight:700>();</span>

	<span style=color:#8f5902;font-style:italic>//验证一些必须有的属性
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>validateRequiredProperties</span><span style=color:#ce5c00;font-weight:700>();</span>

	<span style=color:#8f5902;font-style:italic>// 存储准备刷新 ApplicationListeners...
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlyApplicationListeners</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlyApplicationListeners</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationListeners</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 重置本地的
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationListeners</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationListeners</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlyApplicationListeners</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlyApplicationEvents</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>看一下在 <strong>prepareRefresh</strong> 方法中的几个主要的方法：</p><ul><li><strong><code>initPropertySources()</code></strong> 该方法主要用于初始化属性资源在子类中进行实现。对于不同的子类实现的方式不同。对于现在我们研究的是 <strong><code>ClassPathXmlApplicationContext</code></strong> 。通过代码研究发现在这个类中是没有实现的。</li></ul></li><li><p><strong><code>ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory()</code></strong></p><p>接下来看一下 <strong><code>obtainFreshBeanFactory</code></strong> 方法的代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>obtainFreshBeanFactory</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>refreshBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>包含了两个方法分别是：</p><ol><li><p><strong>refreshBeanFactory &mdash; 抽象方法由子类(AbstractRefreshableApplicationContext)实现</strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>refreshBeanFactory</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
       <span style=color:#8f5902;font-style:italic>//判断是否有BeanFactory
</span><span style=color:#8f5902;font-style:italic></span>       <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasBeanFactory</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
           <span style=color:#000>destroyBeans</span><span style=color:#ce5c00;font-weight:700>();</span>
           <span style=color:#000>closeBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
       <span style=color:#ce5c00;font-weight:700>}</span>
       <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//重新创建BeanFactory
</span><span style=color:#8f5902;font-style:italic></span>           <span style=color:#000>DefaultListableBeanFactory</span> <span style=color:#000>beanFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
           <span style=color:#8f5902;font-style:italic>//设置序列化ID
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSerializationId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getId</span><span style=color:#ce5c00;font-weight:700>());</span>
           <span style=color:#000>customizeBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>//加载Bean的定义---这里就是加载定义Spring Bean 的定义加载到 BeanFactory
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//这个方法是一个抽象方法由子类实现
</span><span style=color:#8f5902;font-style:italic></span>           <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
           <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanFactoryMonitor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>;</span>
           <span style=color:#ce5c00;font-weight:700>}</span>
       <span style=color:#ce5c00;font-weight:700>}</span>
       <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IOException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
           <span style=color:#8f5902;font-style:italic>//省略。。。。 抛出错误
</span><span style=color:#8f5902;font-style:italic></span>       <span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>对于 <strong><code>ClassPathXmlApplicationContext</code></strong> 这个方法的实现的子类是 <strong><code>AbstractXmlApplicationContext</code></strong> 下面来粗略分析一下这个类的实现：</p><ul><li><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#5c35cc;font-weight:700>@Override</span>
     <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DefaultListableBeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>//创建一个XML对应的定义Reader
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>XmlBeanDefinitionReader</span> <span style=color:#000>beanDefinitionReader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>XmlBeanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

         <span style=color:#8f5902;font-style:italic>//设置 Environment ResourceLoader EntityResolver
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>beanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setEnvironment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>());</span>
         <span style=color:#000>beanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setResourceLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#000>beanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setEntityResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ResourceEntityResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>));</span>

         <span style=color:#8f5902;font-style:italic>//初始化Reader
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>initBeanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>//加载Bean的定义
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>);</span>
     <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li></ul></li><li><p><strong>getBeanFactory &mdash; 抽象方法由子类(AbstractRefreshableApplicationContext)实现</strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java></code></pre></div></li></ol><p>@Override
public final ConfigurableListableBeanFactory getBeanFactory() {</p><pre><code>
   synchronized (this.beanFactoryMonitor) {
       if (this.beanFactory == null) {
           throw new IllegalStateException(&quot;BeanFactory not initialized or already closed - &quot; +
                   &quot;call 'refresh' before accessing beans via the ApplicationContext&quot;);
       }
       return this.beanFactory;
   }
}
</code></pre><pre><code>
</code></pre></li><li><p><strong><code>prepareBeanFactory(beanFactory)</code></strong></p><p>主要对bean Factory 进行设置</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>prepareBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 设置Bean的类加载器.
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBeanClassLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#8f5902;font-style:italic>//设置Bean表达式解析器
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBeanExpressionResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StandardBeanExpressionResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClassLoader</span><span style=color:#ce5c00;font-weight:700>()));</span>
      <span style=color:#8f5902;font-style:italic>//设置属性
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addPropertyEditorRegistrar</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ResourceEditorRegistrar</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>()));</span>

      <span style=color:#8f5902;font-style:italic>// 添加Context上下文处理 *Aware处理器
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ApplicationContextAwareProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>//设置忽略*Aware依赖--上面的ApplicationContextAwareProcessor已经处理了
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ignoreDependencyInterface</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>EnvironmentAware</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ignoreDependencyInterface</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>EmbeddedValueResolverAware</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ignoreDependencyInterface</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResourceLoaderAware</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ignoreDependencyInterface</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationEventPublisherAware</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ignoreDependencyInterface</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageSourceAware</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ignoreDependencyInterface</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationContextAware</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>

      <span style=color:#8f5902;font-style:italic>// 设置特殊类型对应的bean.beanFactory对应刚刚获取的BeanFactory
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>//ResourceLoader, ApplicationEventPublisher, ApplicationContext这3个接口对应的bean都设置为当前的Spring容器
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerResolvableDependency</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerResolvableDependency</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResourceLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerResolvableDependency</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationEventPublisher</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerResolvableDependency</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>

      <span style=color:#8f5902;font-style:italic>// 注册ApplicationListenerDetector，用于发现实现了ApplicationListener接口的bean
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ApplicationListenerDetector</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>));</span>

      <span style=color:#8f5902;font-style:italic>// Detect a LoadTimeWeaver and prepare for weaving, if found.
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LOAD_TIME_WEAVER_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LoadTimeWeaverAwareProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>));</span>
          <span style=color:#8f5902;font-style:italic>// Set a temporary ClassLoader for type matching.
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTempClassLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ContextTypeMatchClassLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClassLoader</span><span style=color:#ce5c00;font-weight:700>()));</span>
      <span style=color:#ce5c00;font-weight:700>}</span>

      <span style=color:#8f5902;font-style:italic>// 注册默认的 environment beans
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsLocalBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ENVIRONMENT_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ENVIRONMENT_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsLocalBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SYSTEM_PROPERTIES_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SYSTEM_PROPERTIES_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getSystemProperties</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsLocalBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SYSTEM_ENVIRONMENT_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SYSTEM_ENVIRONMENT_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getSystemEnvironment</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li><li><p><strong><code>postProcessBeanFactory(beanFactory)</code></strong></p><p>在 <strong><code>ClassPathXmlApplicationContext</code></strong> 中 <strong><code>postProcessBeanFactory</code></strong> 只是一个空的实现</p></li><li><p><strong><code>invokeBeanFactoryPostProcessors(beanFactory)</code></strong></p><p>实例化和执行所有的注册的 <strong><code>BeanFactoryPostProcessor</code></strong> 如果实现了 <strong><code>Ordered</code></strong> 或者 <strong><code>PriorityOrdered</code></strong> 需要遵循</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>invokeBeanFactoryPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//处理后置Bean Factory 处理器
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>PostProcessorRegistrationDelegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invokeBeanFactoryPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getBeanFactoryPostProcessors</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTempClassLoader</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LOAD_TIME_WEAVER_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LoadTimeWeaverAwareProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>));</span>
          <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTempClassLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ContextTypeMatchClassLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClassLoader</span><span style=color:#ce5c00;font-weight:700>()));</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在上面的方法主要是通过： <strong><code>PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, getBeanFactoryPostProcessors())</code></strong> 来进行</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>invokeBeanFactoryPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span>
          <span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanFactoryPostProcessor</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>beanFactoryPostProcessors</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

      <span style=color:#8f5902;font-style:italic>//首先执行BeanDefinitionRegistryPostProcessor
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>processedBeans</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>

      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>BeanDefinitionRegistry</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>BeanDefinitionRegistry</span> <span style=color:#000>registry</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionRegistry</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>;</span>
          <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanFactoryPostProcessor</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>regularPostProcessors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
          <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinitionRegistryPostProcessor</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>registryProcessors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>

          <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanFactoryPostProcessor</span> <span style=color:#000>postProcessor</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>beanFactoryPostProcessors</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>postProcessor</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>BeanDefinitionRegistryPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                  <span style=color:#8f5902;font-style:italic>//调用处理BeanDefinitionRegistryPostProcessor
</span><span style=color:#8f5902;font-style:italic></span>                  <span style=color:#000>BeanDefinitionRegistryPostProcessor</span> <span style=color:#000>registryProcessor</span> <span style=color:#ce5c00;font-weight:700>=</span>
                          <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionRegistryPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>postProcessor</span><span style=color:#ce5c00;font-weight:700>;</span>
                  <span style=color:#000>registryProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>postProcessBeanDefinitionRegistry</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
                  <span style=color:#000>registryProcessors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registryProcessor</span><span style=color:#ce5c00;font-weight:700>);</span>
              <span style=color:#ce5c00;font-weight:700>}</span>
              <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                  <span style=color:#000>regularPostProcessors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>postProcessor</span><span style=color:#ce5c00;font-weight:700>);</span>
              <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#ce5c00;font-weight:700>}</span>


          <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinitionRegistryPostProcessor</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>currentRegistryProcessors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>

          <span style=color:#8f5902;font-style:italic>// 首先执行 BeanDefinitionRegistryPostProcessors 实现了 PriorityOrdered.
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>postProcessorNames</span> <span style=color:#ce5c00;font-weight:700>=</span>
                  <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanNamesForType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionRegistryPostProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>ppName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>postProcessorNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTypeMatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>PriorityOrdered</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                  <span style=color:#000>currentRegistryProcessors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinitionRegistryPostProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>));</span>
                  <span style=color:#000>processedBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>);</span>
              <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#000>sortPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentRegistryProcessors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>registryProcessors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentRegistryProcessors</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>invokeBeanDefinitionRegistryPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentRegistryProcessors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>currentRegistryProcessors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>

          <span style=color:#8f5902;font-style:italic>// 接下来执行 BeanDefinitionRegistryPostProcessors 实现 Ordered.
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>postProcessorNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanNamesForType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionRegistryPostProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>ppName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>postProcessorNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>processedBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTypeMatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Ordered</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                  <span style=color:#000>currentRegistryProcessors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinitionRegistryPostProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>));</span>
                  <span style=color:#000>processedBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>);</span>
              <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#000>sortPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentRegistryProcessors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>registryProcessors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentRegistryProcessors</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>invokeBeanDefinitionRegistryPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentRegistryProcessors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>currentRegistryProcessors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>

          <span style=color:#8f5902;font-style:italic>// 执行剩下的所有的 BeanDefinitionRegistryPostProcessors
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>reiterate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
          <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>reiterate</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#000>reiterate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
              <span style=color:#000>postProcessorNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanNamesForType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionRegistryPostProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
              <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>ppName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>postProcessorNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>processedBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                      <span style=color:#000>currentRegistryProcessors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinitionRegistryPostProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>));</span>
                      <span style=color:#000>processedBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>);</span>
                      <span style=color:#000>reiterate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
                  <span style=color:#ce5c00;font-weight:700>}</span>
              <span style=color:#ce5c00;font-weight:700>}</span>
              <span style=color:#000>sortPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentRegistryProcessors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
              <span style=color:#000>registryProcessors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentRegistryProcessors</span><span style=color:#ce5c00;font-weight:700>);</span>
              <span style=color:#000>invokeBeanDefinitionRegistryPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentRegistryProcessors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
              <span style=color:#000>currentRegistryProcessors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#ce5c00;font-weight:700>}</span>

          <span style=color:#8f5902;font-style:italic>//执行回调方法 postProcessBeanFactory
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>invokeBeanFactoryPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registryProcessors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>invokeBeanFactoryPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>regularPostProcessors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>

      <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// Invoke factory processors registered with the context instance.
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>invokeBeanFactoryPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactoryPostProcessors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>

      <span style=color:#8f5902;font-style:italic>// Do not initialize FactoryBeans here: We need to leave all regular beans
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// uninitialized to let the bean factory post-processors apply to them!
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>postProcessorNames</span> <span style=color:#ce5c00;font-weight:700>=</span>
              <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanNamesForType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanFactoryPostProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>

      <span style=color:#8f5902;font-style:italic>//处理PriorityOrdered 和 Ordered 的类
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanFactoryPostProcessor</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>priorityOrderedPostProcessors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
      <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>orderedPostProcessorNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
      <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>nonOrderedPostProcessorNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>ppName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>postProcessorNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>processedBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#8f5902;font-style:italic>// skip - already processed in first phase above
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTypeMatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>PriorityOrdered</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#000>priorityOrderedPostProcessors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanFactoryPostProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>));</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTypeMatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Ordered</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#000>orderedPostProcessorNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#000>nonOrderedPostProcessorNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>

      <span style=color:#8f5902;font-style:italic>// 首先执行 BeanFactoryPostProcessors 实现了 PriorityOrdered.
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>sortPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>priorityOrderedPostProcessors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>invokeBeanFactoryPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>priorityOrderedPostProcessors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

      <span style=color:#8f5902;font-style:italic>// 执行 BeanFactoryPostProcessors 实现了 Ordered.
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanFactoryPostProcessor</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>orderedPostProcessors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>orderedPostProcessorNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>postProcessorName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>orderedPostProcessorNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>orderedPostProcessors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>postProcessorName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanFactoryPostProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>sortPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>orderedPostProcessors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>invokeBeanFactoryPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>orderedPostProcessors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

      <span style=color:#8f5902;font-style:italic>// 最后执行所有的 BeanFactoryPostProcessors.
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanFactoryPostProcessor</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>nonOrderedPostProcessors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>nonOrderedPostProcessorNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>postProcessorName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>nonOrderedPostProcessorNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>nonOrderedPostProcessors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>postProcessorName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanFactoryPostProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>invokeBeanFactoryPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nonOrderedPostProcessors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clearMetadataCache</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li><li><p><strong><code>registerBeanPostProcessors(beanFactory)</code></strong></p><p>注册Bean <strong><code>PostProcessor</code></strong> 处理器。代码如下：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>PostProcessorRegistrationDelegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从上面可以看出来就一行代码，调用了 <strong><code>PostProcessorRegistrationDelegate.registerBeanPostProcessors(beanFactory, this)</code></strong> 静态方法</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span>
          <span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>AbstractApplicationContext</span> <span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

      <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>postProcessorNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanNamesForType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>beanProcessorTargetCount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanPostProcessorCount</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>postProcessorNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanPostProcessorChecker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanProcessorTargetCount</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>priorityOrderedPostProcessors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
      <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>internalPostProcessors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
      <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>orderedPostProcessorNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
      <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>nonOrderedPostProcessorNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>ppName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>postProcessorNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTypeMatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>PriorityOrdered</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#000>BeanPostProcessor</span> <span style=color:#000>pp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
              <span style=color:#000>priorityOrderedPostProcessors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pp</span><span style=color:#ce5c00;font-weight:700>);</span>
              <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pp</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>MergedBeanDefinitionPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                  <span style=color:#000>internalPostProcessors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pp</span><span style=color:#ce5c00;font-weight:700>);</span>
              <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTypeMatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Ordered</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#000>orderedPostProcessorNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#000>nonOrderedPostProcessorNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>sortPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>priorityOrderedPostProcessors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>registerBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>priorityOrderedPostProcessors</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>orderedPostProcessors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>orderedPostProcessorNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>ppName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>orderedPostProcessorNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>BeanPostProcessor</span> <span style=color:#000>pp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>orderedPostProcessors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pp</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pp</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>MergedBeanDefinitionPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#000>internalPostProcessors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pp</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>sortPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>orderedPostProcessors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>registerBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>orderedPostProcessors</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>nonOrderedPostProcessors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>nonOrderedPostProcessorNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>ppName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>nonOrderedPostProcessorNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>BeanPostProcessor</span> <span style=color:#000>pp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ppName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>nonOrderedPostProcessors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pp</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pp</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>MergedBeanDefinitionPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#000>internalPostProcessors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pp</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>registerBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nonOrderedPostProcessors</span><span style=color:#ce5c00;font-weight:700>);</span>


      <span style=color:#000>sortPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>internalPostProcessors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>registerBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>internalPostProcessors</span><span style=color:#ce5c00;font-weight:700>);</span>


      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ApplicationListenerDetector</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>));</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这段代码和 <strong><code>BeanFactoryPostProcessor</code></strong> 处理差不多。</p></li><li><p><strong><code>initMessageSource()</code></strong></p><p>初始化消息源</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>initMessageSource</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>beanFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>//判断是否存在Bean名称为messageSource
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsLocalBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MESSAGE_SOURCE_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageSource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MESSAGE_SOURCE_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MessageSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#8f5902;font-style:italic>// Make MessageSource aware of parent MessageSource.
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageSource</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>HierarchicalMessageSource</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#000>HierarchicalMessageSource</span> <span style=color:#000>hms</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HierarchicalMessageSource</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageSource</span><span style=color:#ce5c00;font-weight:700>;</span>
              <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hms</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParentMessageSource</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                  <span style=color:#000>hms</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setParentMessageSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getInternalParentMessageSource</span><span style=color:#ce5c00;font-weight:700>());</span>
              <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTraceEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Using MessageSource [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageSource</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//BeanFactory 不存在直接建立
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>DelegatingMessageSource</span> <span style=color:#000>dms</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DelegatingMessageSource</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#000>dms</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setParentMessageSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getInternalParentMessageSource</span><span style=color:#ce5c00;font-weight:700>());</span>
          <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageSource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>dms</span><span style=color:#ce5c00;font-weight:700>;</span>
          <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MESSAGE_SOURCE_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageSource</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTraceEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;No &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>MESSAGE_SOURCE_BEAN_NAME</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; bean, using [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageSource</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li><li><p><strong><code>initApplicationEventMulticaster()</code></strong></p><p>初始化广播事件</p></li><li><p><strong><code>onRefresh()</code></strong></p></li><li><p><strong><code>registerListeners()</code></strong></p><p>注册系统里的监听者，看一下这个方法的代码:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerListeners</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 注册特定的静态的监听器
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationListener</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>listener</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>getApplicationListeners</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>getApplicationEventMulticaster</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>addApplicationListener</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>listener</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>

      <span style=color:#8f5902;font-style:italic>//获取监听器的Bean的名称
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>listenerBeanNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getBeanNamesForType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationListener</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>listenerBeanName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>listenerBeanNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>getApplicationEventMulticaster</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>addApplicationListenerBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>listenerBeanName</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>

      <span style=color:#8f5902;font-style:italic>// Publish early application events now that we finally have a multicaster...
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ApplicationEvent</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>earlyEventsToProcess</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlyApplicationEvents</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlyApplicationEvents</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>earlyEventsToProcess</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationEvent</span> <span style=color:#000>earlyEvent</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>earlyEventsToProcess</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#000>getApplicationEventMulticaster</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>multicastEvent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>earlyEvent</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li><li><p><strong><code>finishBeanFactoryInitialization(beanFactory)</code></strong></p><p>初始化剩下的单例Bean</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>finishBeanFactoryInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CONVERSION_SERVICE_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
              <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTypeMatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CONVERSION_SERVICE_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ConversionService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setConversionService</span><span style=color:#ce5c00;font-weight:700>(</span>
                  <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CONVERSION_SERVICE_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ConversionService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasEmbeddedValueResolver</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addEmbeddedValueResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>strVal</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>resolvePlaceholders</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>strVal</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#ce5c00;font-weight:700>}</span>

      <span style=color:#8f5902;font-style:italic>//包含Aware中的
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>weaverAwareNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanNamesForType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LoadTimeWeaverAware</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>weaverAwareName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>weaverAwareNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>weaverAwareName</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>

      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTempClassLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>

      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>freezeConfiguration</span><span style=color:#ce5c00;font-weight:700>();</span>

      <span style=color:#8f5902;font-style:italic>// 实例化单例Bean
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>preInstantiateSingletons</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li><li><p><strong><code>finishRefresh()</code></strong></p><p>完成最后的刷新</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>finishRefresh</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// Clear context-level resource caches (such as ASM metadata from scanning).
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>clearResourceCaches</span><span style=color:#ce5c00;font-weight:700>();</span>

      <span style=color:#8f5902;font-style:italic>// Initialize lifecycle processor for this context.
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>initLifecycleProcessor</span><span style=color:#ce5c00;font-weight:700>();</span>

      <span style=color:#8f5902;font-style:italic>// Propagate refresh to lifecycle processor first.
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>getLifecycleProcessor</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>onRefresh</span><span style=color:#ce5c00;font-weight:700>();</span>

      <span style=color:#8f5902;font-style:italic>// Publish the final event.
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>publishEvent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ContextRefreshedEvent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>));</span>

      <span style=color:#8f5902;font-style:italic>// Participate in LiveBeansView MBean, if active.
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>LiveBeansView</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-791724054e8b5e939d8acc2be33472ab>1.18 - doGetBean源码详解</h1><h3 id=1-dogetbean方法源码解析>1. doGetBean方法源码解析</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>T</span> <span style=color:#000>doGetBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>,</span>
			<span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>typeCheckOnly</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>

		<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>		 * 通过name获取BeanName,这里不能使用name作为beanName：
</span><span style=color:#8f5902;font-style:italic>		 * 1. name可能是别名，通过方法转换为具体的实例名称
</span><span style=color:#8f5902;font-style:italic>		 * 2. name可能会以&amp;开头，表明调用者想获取FactoryBean本身，而非FactoryBean创建bean
</span><span style=color:#8f5902;font-style:italic>		 *    FactoryBean 的实现类和其他的 bean 存储方式是一致的，即 &lt;beanName, bean&gt;，
</span><span style=color:#8f5902;font-style:italic>		 *    beanName 中是没有 &amp; 这个字符的。所以我们需要将 name 的首字符 &amp; 移除，这样才能从
</span><span style=color:#8f5902;font-style:italic>		 *    缓存里取到 FactoryBean 实例。
</span><span style=color:#8f5902;font-style:italic>		 *
</span><span style=color:#8f5902;font-style:italic>		 */</span>
		<span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>transformedBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>

		<span style=color:#8f5902;font-style:italic>// 从缓存中获取bean
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>Object</span> <span style=color:#000>sharedInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>

		<span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>		 * 如果 sharedInstance = null，则说明缓存里没有对应的实例，表明这个实例还没创建。
</span><span style=color:#8f5902;font-style:italic>		 *( BeanFactory 并不会在一开始就将所有的单例 bean 实例化好，而是在调用 getBean 获取bean 时再实例化，也就是懒加载)。
</span><span style=color:#8f5902;font-style:italic>		 * getBean 方法有很多重载，比如 getBean(String name, Object... args)，我们在首次获取
</span><span style=color:#8f5902;font-style:italic>		 * 某个 bean 时，可以传入用于初始化 bean 的参数数组（args），BeanFactory 会根据这些参数
</span><span style=color:#8f5902;font-style:italic>		 * 去匹配合适的构造方法构造 bean 实例。当然，如果单例 bean 早已创建好，这里的 args 就没有
</span><span style=color:#8f5902;font-style:italic>		 * 用了，BeanFactory 不会多次实例化单例 bean。
</span><span style=color:#8f5902;font-style:italic>		 */</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sharedInstance</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>args</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTraceEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isSingletonCurrentlyInCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Returning eagerly cached instance of singleton bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span>
							<span style=color:#4e9a06>&#34;&#39; that is not fully initialized yet - a consequence of a circular reference&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Returning cached instance of singleton bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>

			<span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>			 * 如果 sharedInstance 是普通的单例 bean，下面的方法会直接返回。但如果
</span><span style=color:#8f5902;font-style:italic>			 * sharedInstance 是 FactoryBean 类型的，则需调用 getObject 工厂方法获取真正的
</span><span style=color:#8f5902;font-style:italic>			 * bean 实例。如果用户想获取 FactoryBean 本身，这里也不会做特别的处理，直接返回
</span><span style=color:#8f5902;font-style:italic>			 * 即可。毕竟 FactoryBean 的实现类本身也是一种 bean，只不过具有一点特殊的功能而已。
</span><span style=color:#8f5902;font-style:italic>			 */</span>
			<span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sharedInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>		 * 如果上面的条件不满足，则表明 sharedInstance 可能为空，此时 beanName 对应的 bean
</span><span style=color:#8f5902;font-style:italic>		 * 实例可能还未创建。这里还存在另一种可能，如果当前容器有父容器，beanName 对应的 bean 实例
</span><span style=color:#8f5902;font-style:italic>		 * 可能是在父容器中被创建了，所以在创建实例前，需要先去父容器里检查一下。
</span><span style=color:#8f5902;font-style:italic>		 */</span>
		<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>// BeanFactory 不缓存 Prototype 类型的 bean，无法处理该类型 bean 的循环依赖问题
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//判断是否存在循环依赖
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isPrototypeCurrentlyInCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCurrentlyInCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>

			<span style=color:#8f5902;font-style:italic>// 如果 sharedInstance = null，则到父容器中查找 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>BeanFactory</span> <span style=color:#000>parentBeanFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getParentBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentBeanFactory</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>containsBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#8f5902;font-style:italic>// Not found -&gt; check parent.
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>String</span> <span style=color:#000>nameToLookup</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>originalBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentBeanFactory</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>AbstractBeanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>AbstractBeanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>parentBeanFactory</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>doGetBean</span><span style=color:#ce5c00;font-weight:700>(</span>
							<span style=color:#000>nameToLookup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>typeCheckOnly</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#8f5902;font-style:italic>// Delegation to parent with explicit args.
</span><span style=color:#8f5902;font-style:italic></span>					<span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>parentBeanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nameToLookup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requiredType</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#8f5902;font-style:italic>// No args -&gt; delegate to standard getBean method.
</span><span style=color:#8f5902;font-style:italic></span>					<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>parentBeanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nameToLookup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>parentBeanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nameToLookup</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>

			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>typeCheckOnly</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>markBeanAsCreated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>

			<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#8f5902;font-style:italic>// 合并父 BeanDefinition 与子 BeanDefinition
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getMergedLocalBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#000>checkMergedBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>

				<span style=color:#8f5902;font-style:italic>// 检查是否有 dependsOn 依赖，如果有则先初始化所依赖的 bean
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>dependsOn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDependsOn</span><span style=color:#ce5c00;font-weight:700>();</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dependsOn</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>dep</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>dependsOn</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

						<span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>						 * 检测是否存在 depends-on 循环依赖，若存在则抛异常。比如 A 依赖 B，
</span><span style=color:#8f5902;font-style:italic>						 * B 又依赖 A，他们的配置如下：
</span><span style=color:#8f5902;font-style:italic>						 *   &lt;bean id=&#34;beanA&#34; class=&#34;BeanA&#34; depends-on=&#34;beanB&#34;&gt;
</span><span style=color:#8f5902;font-style:italic>						 *   &lt;bean id=&#34;beanB&#34; class=&#34;BeanB&#34; depends-on=&#34;beanA&#34;&gt;
</span><span style=color:#8f5902;font-style:italic>						 *
</span><span style=color:#8f5902;font-style:italic>						 * beanA 要求 beanB 在其之前被创建，但 beanB 又要求 beanA 先于它
</span><span style=color:#8f5902;font-style:italic>						 * 创建。这个时候形成了循环，对于 depends-on 循环，Spring 会直接
</span><span style=color:#8f5902;font-style:italic>						 * 抛出异常
</span><span style=color:#8f5902;font-style:italic>						 */</span>

						<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isDependent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>dep</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
							<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
									<span style=color:#4e9a06>&#34;Circular depends-on relationship between &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; and &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>dep</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
						<span style=color:#ce5c00;font-weight:700>}</span>
						<span style=color:#8f5902;font-style:italic>// 注册依赖记录
</span><span style=color:#8f5902;font-style:italic></span>						<span style=color:#000>registerDependentBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dep</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
						<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
							<span style=color:#8f5902;font-style:italic>// 加载 depends-on 依赖
</span><span style=color:#8f5902;font-style:italic></span>							<span style=color:#000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dep</span><span style=color:#ce5c00;font-weight:700>);</span>
						<span style=color:#ce5c00;font-weight:700>}</span>
						<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NoSuchBeanDefinitionException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
							<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
									<span style=color:#4e9a06>&#34;&#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; depends on missing bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>dep</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
						<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#ce5c00;font-weight:700>}</span>

				<span style=color:#8f5902;font-style:italic>// 创建 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>

					<span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>					 * 这里并没有直接调用 createBean 方法创建 bean 实例，而是通过
</span><span style=color:#8f5902;font-style:italic>					 * getSingleton(String, ObjectFactory) 方法获取 bean 实例。
</span><span style=color:#8f5902;font-style:italic>					 * getSingleton(String, ObjectFactory) 方法会在内部调用
</span><span style=color:#8f5902;font-style:italic>					 * ObjectFactory 的 getObject() 方法创建 bean，并会在创建完成后，
</span><span style=color:#8f5902;font-style:italic>					 * 将 bean 放入缓存中。
</span><span style=color:#8f5902;font-style:italic>					 */</span>

					<span style=color:#000>sharedInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
							<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
						<span style=color:#ce5c00;font-weight:700>}</span>
						<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
							<span style=color:#8f5902;font-style:italic>// Explicitly remove instance from singleton cache: It might have been put there
</span><span style=color:#8f5902;font-style:italic></span>							<span style=color:#8f5902;font-style:italic>// eagerly by the creation process, to allow for circular reference resolution.
</span><span style=color:#8f5902;font-style:italic></span>							<span style=color:#8f5902;font-style:italic>// Also remove any beans that received a temporary reference to the bean.
</span><span style=color:#8f5902;font-style:italic></span>							<span style=color:#000>destroySingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
							<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
						<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#ce5c00;font-weight:700>});</span>
					<span style=color:#8f5902;font-style:italic>// 如果 bean 是 FactoryBean 类型，则调用工厂方法获取真正的 bean 实例。否则直接返回 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>					<span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sharedInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#8f5902;font-style:italic>// 创建 prototype 类型的 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isPrototype</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#8f5902;font-style:italic>// It&#39;s a prototype -&gt; create a new instance.
</span><span style=color:#8f5902;font-style:italic></span>					<span style=color:#000>Object</span> <span style=color:#000>prototypeInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
					<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#000>beforePrototypeCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
						<span style=color:#000>prototypeInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#000>afterPrototypeCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prototypeInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#8f5902;font-style:italic>// 创建其他类型的 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>String</span> <span style=color:#000>scopeName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getScope</span><span style=color:#ce5c00;font-weight:700>();</span>
					<span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Scope</span> <span style=color:#000>scope</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scopes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>scopeName</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>scope</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;No Scope registered for scope name &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>scopeName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#000>Object</span> <span style=color:#000>scopedInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>scope</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
							<span style=color:#000>beforePrototypeCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
							<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
								<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
							<span style=color:#ce5c00;font-weight:700>}</span>
							<span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
								<span style=color:#000>afterPrototypeCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
							<span style=color:#ce5c00;font-weight:700>}</span>
						<span style=color:#ce5c00;font-weight:700>});</span>
						<span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>scopedInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IllegalStateException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
								<span style=color:#4e9a06>&#34;Scope &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>scopeName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; is not active for the current thread; consider &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
								<span style=color:#4e9a06>&#34;defining a scoped proxy for this bean if you intend to refer to it from a singleton&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
								<span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>cleanupAfterBeanCreationFailure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>// Check if required type matches the type of the actual bean instance.
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requiredType</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>T</span> <span style=color:#000>convertedBean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getTypeConverter</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>convertIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>convertedBean</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanNotOfRequiredTypeException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>());</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>convertedBean</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TypeMismatchException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTraceEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Failed to convert bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; to required type &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
							<span style=color:#000>ClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQualifiedName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanNotOfRequiredTypeException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>());</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从源码分析一下 <strong><code>doGetBean</code></strong> 的执行流程如下：</p><ol><li><p><strong>转换beanName</strong></p><blockquote><p>传入的name参数可能是别名，也可能是FactoryBean，索引还需要进行一系列解析</p></blockquote><ul><li>去除FactoryBean的修饰符，也就是如果name=也就是如果name = &ldquo;&factoryBean&rdquo;，那么会首先去除&而使name = &ldquo;factoryBean&rdquo;</li><li>将别名alias转换为最终指向的beanName，比如别名A执行名称为B的bean，而B没有指向任何其他的bean，即为最终的bean，则返回B;但是如果B又指向C，而是C是最终的bean，则返回C。</li></ul></li><li><p><strong>尝试从缓存中获取原始单例</strong></p><blockquote><p><strong>这就是Spring的IOC，首先尝试从缓存中加载单例模式</strong></p></blockquote></li><li><h4 id=检测是否为factorybean并获取bean以及初始化后处理>检测是否为FactoryBean并获取Bean以及初始化后处理</h4><blockquote><p>在doGetBean方法中频繁出现getObjectForBeanInstance方法，它主要完成对获取的Bean Instance进行检测是否为FactoryBean，如果是FactoryBean则通过工厂方法获取Bean以及初始化后处理</p></blockquote></li><li><h4 id=创建单例bean>创建单例Bean</h4><blockquote><p>如果缓存中没有单例Bean的缓存，则需要从头开始创建单例Bean，这主要是重载getSingleton的重载方法来实现单例Bean的加载。</p></blockquote></li><li><h4 id=原型模式的依赖检查>原型模式的依赖检查</h4><blockquote><p>只有单例模式才会尝试解决循环依赖，如果存在A中有B的属性，B中有A的属性，那么当依赖注入的时候看，就会产生当A还未创建完的时候因为对于B的创建再次返回创建A，造成循环依赖，也就是情况：isPrototypeCurrentlyInCreation(beanName)判断为true</p></blockquote></li><li><p><strong>处理 depends-on 依赖</strong></p></li><li><p><strong>创建并缓存 bean</strong></p></li><li><p><strong>调用 getObjectForBeanInstance 方法，并按 name 规则返回相应的 bean 实例</strong></p></li><li><p><strong>按需转换 bean 类型，并返回转换后的 bean 实例</strong></p></li></ol><h3 id=2-方法的源码解析>2. 方法的源码解析</h3><p>接下来逐步分析每一个方法</p><h4 id=21-transformedbeanname>2.1 transformedBeanName</h4><p><strong><code>transformedBeanName(name)</code></strong> <strong><code>beanName</code></strong> 的转换，之前分析过由于 <strong><code>name</code></strong> 可能是 <strong><code>FactoryBean</code></strong> 或者普通的 Bean的别名所以需要转换。</p><blockquote><p>name可能是FactoryBean或者是beanName的别名，用当前这个方法来进行转换成真正的beanName来进行后续的操作</p></blockquote><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>String</span> <span style=color:#000>transformedBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#8f5902;font-style:italic>//BeanFactoryUtils.transformedBeanName(name)处理 FactoryBean 类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>canonicalName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanFactoryUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>transformedBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>));</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>//FactoryBean转换
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>String</span> <span style=color:#000>transformedBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    	<span style=color:#8f5902;font-style:italic>//判空
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;&#39;name&#39; must not be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    	<span style=color:#8f5902;font-style:italic>//判断是否已 &amp; 开头是否为FactoryBean
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>startsWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>FACTORY_BEAN_PREFIX</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>transformedBeanNameCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>computeIfAbsent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>do</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>substring</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>FACTORY_BEAN_PREFIX</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>());</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>startsWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>FACTORY_BEAN_PREFIX</span><span style=color:#ce5c00;font-weight:700>));</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>});</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>//将别名处理成BeanName
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>canonicalName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>String</span> <span style=color:#000>canonicalName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#8f5902;font-style:italic>// Handle aliasing...
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>String</span> <span style=color:#000>resolvedName</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#204a87;font-weight:700>do</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>resolvedName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>aliasMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>canonicalName</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolvedName</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>canonicalName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolvedName</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolvedName</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>canonicalName</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div><p>从上面可以看出来 <strong>transformedBeanName</strong> 方法主要是用来处理beanName。</p><h4 id=22-getsingletonbeanname>2.2 getSingleton(beanName)</h4><p><strong><code>getSingleton(beanName)</code></strong> 主要从缓存中获取bean。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>allowEarlyReference</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//从缓存Map中获取
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>Object</span> <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>isSingletonCurrentlyInCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonObjects</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>//从earlySingletonObjects获取bean
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlySingletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>allowEarlyReference</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>singletonFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonFactories</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonFactory</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>singletonFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>();</span>
						<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlySingletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>singletonObject</span><span style=color:#ce5c00;font-weight:700>);</span>
						<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonFactories</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>singletonObject</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=23-abstractbeanfactorygetobjectforbeaninstance方法>2.3 AbstractBeanFactory#getObjectForBeanInstance方法</h4><p>通过给定的bean实例获取对象，返回的bean为自己或者是FactoryBean创建的对象。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span>
			<span style=color:#000>Object</span> <span style=color:#000>beanInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

		<span style=color:#8f5902;font-style:italic>//判断name是否为Bean FactoryBean的引用
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanFactoryUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isFactoryDereference</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanInstance</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>NullBean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>beanInstance</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!(</span><span style=color:#000>beanInstance</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>FactoryBean</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanIsNotAFactoryException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>transformedBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>beanInstance</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>());</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>//现在beanInstance可能是普通的bena或者FactoryBean，如果是普通的Bean直接返回实例
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!(</span><span style=color:#000>beanInstance</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>FactoryBean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>BeanFactoryUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isFactoryDereference</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>beanInstance</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>//如果是FactoryBean，使用FactoryBean来创建一个bean实例
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>Object</span> <span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getCachedObjectForFactoryBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>// Return bean instance from factory.
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>FactoryBean</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>factory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>FactoryBean</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>beanInstance</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#8f5902;font-style:italic>// Caches object obtained from FactoryBean if it is a singleton.
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>containsBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getMergedLocalBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>synthetic</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSynthetic</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#8f5902;font-style:italic>//这里从FactoryBean中获取创建的Bean
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectFromFactoryBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>factory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>synthetic</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote><p>FactoryBean创建的Bean的名称FactoryBean本身作为一个Bean在Spring容器中是用是否包含 <strong><code>&</code></strong> 前缀来区分的。</p></blockquote><h4 id=24--创建单例bean-defaultsingletonbeanregistrygetsingleton>2.4 创建单例Bean DefaultSingletonBeanRegistry#getSingleton</h4><p>在bean的创建过程，通过判断 <strong><code>scope</code></strong> 来判断创建的Bean的类型</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>//创建单例
</span><span style=color:#8f5902;font-style:italic></span>					<span style=color:#000>sharedInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
							<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
						<span style=color:#ce5c00;font-weight:700>}</span>
						<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
							<span style=color:#000>destroySingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
							<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
						<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#ce5c00;font-weight:700>});</span>
					<span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sharedInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过上面可以看出主要是通过调用 <strong><code>DefaultSingletonBeanRegistry#getSingleton</code></strong> 来创建Bean</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>		<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>singletonFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Bean name must not be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonObjects</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>//从缓存中获取Bean
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>Object</span> <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

				<span style=color:#000>beforeSingletonCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>newSingleton</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
				<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>recordSuppressedExceptions</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>suppressedExceptions</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>recordSuppressedExceptions</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>suppressedExceptions</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#8f5902;font-style:italic>//创建Bean
</span><span style=color:#8f5902;font-style:italic></span>					<span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>singletonFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>();</span>
					<span style=color:#000>newSingleton</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IllegalStateException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#8f5902;font-style:italic>//从缓存中获取
</span><span style=color:#8f5902;font-style:italic></span>					<span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanCreationException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>recordSuppressedExceptions</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>suppressedException</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>suppressedExceptions</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
							<span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addRelatedCause</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>suppressedException</span><span style=color:#ce5c00;font-weight:700>);</span>
						<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>recordSuppressedExceptions</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>suppressedExceptions</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#000>afterSingletonCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>newSingleton</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>addSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>singletonObject</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>singletonObject</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面的主要一行代码 <strong><code>singletonObject = singletonFactory.getObject();</code></strong> 来获取，也就是代码中执行的 <strong><code>createBean(beanName, mbd, args)</code></strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>sharedInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#8f5902;font-style:italic>//这里才是真正的调用创建Bean
</span><span style=color:#8f5902;font-style:italic></span>							<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
						<span style=color:#ce5c00;font-weight:700>}</span>
						<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
							<span style=color:#000>destroySingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
							<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
						<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#ce5c00;font-weight:700>});</span>
</code></pre></div><p><strong><code>createbean</code></strong> 是 <strong><code>AbstractBeanFactory</code></strong> 类的一个抽象方法，实现看具体的子类。 抽象子类 <strong><code>AbstractAutowireCapableBeanFactory</code></strong> 对 <strong><code>createBean</code></strong> 方法进行了实现。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span>
			<span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanCreationException</span> <span style=color:#ce5c00;font-weight:700>{</span>


		<span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbdToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>;</span>

		<span style=color:#8f5902;font-style:italic>//确定并加载bean的class
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>resolvedClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveBeanClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolvedClass</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasBeanClass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClassName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>mbdToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBeanClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolvedClass</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>// 准备需要的方法
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prepareMethodOverrides</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionValidationException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionStoreException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span>
					<span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Validation of method overrides failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>// 给InstantiationAwareBeanPostProcessor返回一个代理对象而不是真正的对象
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#8f5902;font-style:italic>// 这里主要处理的InstantiationAwareBeanPostProcessor，处理对象的实例化
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>Object</span> <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveBeforeInstantiation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
					<span style=color:#4e9a06>&#34;BeanPostProcessor before instantiation of bean failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>//创建真正的bean
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>Object</span> <span style=color:#000>beanInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>doCreateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>

			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>beanInstance</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanCreationException</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>ImplicitlyAppearedSingletonException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span>
					<span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Unexpected exception during bean creation&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Object bean = resolveBeforeInstantiation(beanName, mbdToUse) 上面的这段代码是需要关注的，这个主要用来处理实现了InstantiationAwareBeanPostProcessor接口的类</strong></p></blockquote><p>在对于不是实现代理类似通过调用 <strong><code>doCreateBean</code></strong> 方法来创建对象的：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>doCreateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span>
			<span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanCreationException</span> <span style=color:#ce5c00;font-weight:700>{</span>

		<span style=color:#8f5902;font-style:italic>// 实例化 bean.
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>BeanWrapper</span> <span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>factoryBeanInstanceCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>instanceWrapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWrappedInstance</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>beanType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>instanceWrapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWrappedClass</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanType</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>NullBean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolvedTargetType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanType</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>// 下面开始处理 Bean实现的 BeanPostProcessor
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>postProcessingLock</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>postProcessed</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#8f5902;font-style:italic>//处理实现了MergedBeanDefinitionPostProcessor接口的
</span><span style=color:#8f5902;font-style:italic></span>					<span style=color:#000>applyMergedBeanDefinitionPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
							<span style=color:#4e9a06>&#34;Post-processing of merged bean definition failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>postProcessed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>//循环引用的处理
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>earlySingletonExposure</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allowCircularReferences</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
				<span style=color:#000>isSingletonCurrentlyInCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>));</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>earlySingletonExposure</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>addSingletonFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>getEarlyBeanReference</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>));</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>// 初始化Bean
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>Object</span> <span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//处理InstantiationAwareBeanPostProcessor的postProcessAfterInstantiation
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>populateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>instanceWrapper</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#8f5902;font-style:italic>//初始化Bean -- 包含处理 BeanPostProcessor的实现以及init方法
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>initializeBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>exposedObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>BeanCreationException</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(((</span><span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getBeanName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span>
						<span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Initialization of bean failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>earlySingletonExposure</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>Object</span> <span style=color:#000>earlySingletonReference</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>earlySingletonReference</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>earlySingletonReference</span><span style=color:#ce5c00;font-weight:700>;</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allowRawInjectionDespiteWrapping</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>hasDependentBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>dependentBeans</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getDependentBeans</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>actualDependentBeans</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>dependentBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>dependentBean</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>dependentBeans</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>removeSingletonIfCreatedForTypeCheckOnly</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dependentBean</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
							<span style=color:#000>actualDependentBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dependentBean</span><span style=color:#ce5c00;font-weight:700>);</span>
						<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>actualDependentBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCurrentlyInCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
								<span style=color:#4e9a06>&#34;Bean with name &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; has been injected into other beans [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
								<span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>collectionToCommaDelimitedString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>actualDependentBeans</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span>
								<span style=color:#4e9a06>&#34;] in its raw version as part of a circular reference, but has eventually been &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
								<span style=color:#4e9a06>&#34;wrapped. This means that said other beans do not use the final version of the &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
								<span style=color:#4e9a06>&#34;bean. This is often the result of over-eager type matching - consider using &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
								<span style=color:#4e9a06>&#34;&#39;getBeanNamesOfType&#39; with the &#39;allowEagerInit&#39; flag turned off, for example.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>// 处理实现了DisposableBean接口的bean
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>registerDisposableBeanIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionValidationException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span>
					<span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Invalid destruction signature&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>exposedObject</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong><code>exposedObject = initializeBean(beanName, exposedObject, mbd)</code></strong> 这个方法主要执行了我们实现的 BeanPostProcessor。</p><p>BeanPostProcessor的Bean被单独保存对象的私有变量</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-dd9401b6ddf29fb70c6b2bdbf4a95e87>1.19 - Spring Environment源码解析</h1><h3 id=environment关系图>Environment关系图</h3><p><img src="https://github.com/mxsm/document/blob/master/image/Spring/Springframework/Environment.png?raw=true" alt=图></p><p>从上图可以看出来 <strong><code>Environment</code></strong> 主要有三个实现类：</p><ul><li><p><strong>MockEnvironment</strong></p><p>用于mock的</p></li><li><p><strong>StandardEnvironment</strong></p><p>标准的环境</p></li><li><p><strong>StandardServletEnvironment</strong></p><p>用于web的环境</p></li></ul><h3 id=分析一下常用的standardenvironment>分析一下常用的StandardEnvironment</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Environment</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>PropertyResolver</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#8f5902;font-style:italic>//获取配置文件
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>getActiveProfiles</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#8f5902;font-style:italic>//获取默认的配置文件
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>getDefaultProfiles</span><span style=color:#ce5c00;font-weight:700>();</span>
	
    <span style=color:#8f5902;font-style:italic>//是否接受配置文件
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>acceptsProfiles</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Profiles</span> <span style=color:#000>profiles</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>//看一下接口 PropertyResolver
</span><span style=color:#8f5902;font-style:italic>//PropertyResolver 主要是获取对应的Properties值，String或者进行数据类型转换后的值
</span><span style=color:#8f5902;font-style:italic>//同时会处理占位符的数据
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>PropertyResolver</span>  <span style=color:#ce5c00;font-weight:700>{</span>

	
	<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>containsProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>


	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#000>String</span> <span style=color:#000>getProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>

	<span style=color:#000>String</span> <span style=color:#000>getProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>defaultValue</span><span style=color:#ce5c00;font-weight:700>);</span>


	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>T</span> <span style=color:#000>getProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>targetType</span><span style=color:#ce5c00;font-weight:700>);</span>


	<span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>T</span> <span style=color:#000>getProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>targetType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>T</span> <span style=color:#000>defaultValue</span><span style=color:#ce5c00;font-weight:700>);</span>


	<span style=color:#000>String</span> <span style=color:#000>getRequiredProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>;</span>


	<span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>T</span> <span style=color:#000>getRequiredProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>targetType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>;</span>


	<span style=color:#000>String</span> <span style=color:#000>resolvePlaceholders</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>);</span>


	<span style=color:#000>String</span> <span style=color:#000>resolveRequiredPlaceholders</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><img src="https://github.com/mxsm/document/blob/master/image/Spring/Springframework/PropertyResolver.png?raw=true" alt=图></p><p>看一下StandardEnvironment的代码</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>StandardEnvironment</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractEnvironment</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#8f5902;font-style:italic>//系统的property名称
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>SYSTEM_ENVIRONMENT_PROPERTY_SOURCE_NAME</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;systemEnvironment&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>

	<span style=color:#8f5902;font-style:italic>//JVM的property名称
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>SYSTEM_PROPERTIES_PROPERTY_SOURCE_NAME</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;systemProperties&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>


	<span style=color:#8f5902;font-style:italic>//把系统的Properties和JVM的Properties存入
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//此方法在父类的构造函数中进行调用
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>customizePropertySources</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MutablePropertySources</span> <span style=color:#000>propertySources</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>propertySources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addLast</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MapPropertySource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SYSTEM_PROPERTIES_PROPERTY_SOURCE_NAME</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getSystemProperties</span><span style=color:#ce5c00;font-weight:700>()));</span>
		<span style=color:#000>propertySources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addLast</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SystemEnvironmentPropertySource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SYSTEM_ENVIRONMENT_PROPERTY_SOURCE_NAME</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getSystemEnvironment</span><span style=color:#ce5c00;font-weight:700>()));</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-2b171ac5fb8183ede5f1596b9887bac7>1.20 - Spring中的Aware接口</h1><h4 id=1-applicationcontextaware>1. ApplicationContextAware</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>ApplicationContextAware</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationContext</span> <span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=2-beannameaware>2. BeanNameAware</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>BeanNameAware</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=3-applicationeventpublisheraware>3. ApplicationEventPublisherAware</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>ApplicationEventPublisherAware</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Aware</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setApplicationEventPublisher</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationEventPublisher</span> <span style=color:#000>applicationEventPublisher</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=4-beanclassloaderaware>4. BeanClassLoaderAware</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>BeanClassLoaderAware</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Aware</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setBeanClassLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassLoader</span> <span style=color:#000>classLoader</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=5-beanfactoryaware>5. BeanFactoryAware</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>BeanFactoryAware</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Aware</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=6-bootstrapcontextaware>6. BootstrapContextAware</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>BootstrapContextAware</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Aware</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setBootstrapContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BootstrapContext</span> <span style=color:#000>bootstrapContext</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=7-loadtimeweaveraware>7. LoadTimeWeaverAware</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>LoadTimeWeaverAware</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Aware</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setLoadTimeWeaver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LoadTimeWeaver</span> <span style=color:#000>loadTimeWeaver</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=8-messagesourceaware>8. MessageSourceAware</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>MessageSourceAware</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Aware</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setMessageSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageSource</span> <span style=color:#000>messageSource</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=9-notificationpublisheraware>9. NotificationPublisherAware</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>NotificationPublisherAware</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Aware</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setNotificationPublisher</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NotificationPublisher</span> <span style=color:#000>notificationPublisher</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=10-resourceloaderaware>10. ResourceLoaderAware</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>ResourceLoaderAware</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Aware</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setResourceLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResourceLoader</span> <span style=color:#000>resourceLoader</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=11-servletconfigaware>11. ServletConfigAware</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>ServletConfigAware</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Aware</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setServletConfig</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ServletConfig</span> <span style=color:#000>servletConfig</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=12-servletcontextaware>12. ServletContextAware</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>ServletContextAware</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Aware</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setServletContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ServletContext</span> <span style=color:#000>servletContext</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-82e1ce9fe3b5bbf0a1f47502a6efa2d7>1.21 - Spring懒加载源码分析</h1><h3 id=1-什么是懒加载>1 什么是懒加载</h3><p>Spring中有一个概念叫做懒加载，那么什么是懒加载？<strong>就是在需要用到的时候加载类</strong>。</p><h3 id=2-spring是如何处理懒加载>2 Spring是如何处理懒加载。</h3><p>对于Spring中的一个bean如何判断是否为懒加载Bean。分为两种情况：</p><ul><li><p><strong>Bean的定义由XML完成</strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;addressBean&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;com.fh.spring.Address&#34;</span> <span style=color:#c4a000>lazy-init=</span><span style=color:#4e9a06>&#34;true&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</code></pre></div></li><li><p><strong>Bean的定义由注解完成</strong></p><p>@Lazy注解，对于类和类的变量值使用了@Lazy注解说明这个是懒加载</p></li></ul><h3 id=3-分析lazy的实现源码>3 分析@Lazy的实现源码</h3><p>@Lazy注解主要使用在两个地方：</p><ol><li>类上面&ndash;配合@Component注解使用</li><li>类的私有变量上面&ndash;配合@Autowired注解使用</li></ol><h4 id=31-分析lazy在类上>3.1 分析@Lazy在类上</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>
<span style=color:#5c35cc;font-weight:700>@Component</span>
<span style=color:#5c35cc;font-weight:700>@Lazy</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ServiceTest</span> <span style=color:#ce5c00;font-weight:700>{</span>
 <span style=color:#8f5902;font-style:italic>//.......省略其他的代码   
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如上示例代码，@Lazy的位置在ServiceTest上面。在Spring扫描对应的包下面的类，解析未BeanDefinition的时候，对应的BeanDefinition#isLazyInit方法返回为true，说明这个BeanDefinition实现的是懒加载。
那么我看一下在DefaultListableBeanFactory#preInstantiateSingletons方法</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>preInstantiateSingletons</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    
    <span style=color:#8f5902;font-style:italic>//省略了部分代码
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>beanNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>RootBeanDefinition</span> <span style=color:#000>bd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getMergedLocalBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#8f5902;font-style:italic>//bd.isLazyInit() 如果是true就执行下面的代码
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAbstract</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isLazyInit</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
			    <span style=color:#8f5902;font-style:italic>//  省略Spring源码中的代码
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过上面的代码可以知道，在容器启动的时候，加了 <strong><code>@Lazy</code></strong> 的类不会进行实例化。</p><h4 id=32-分析lazy在类的私有变量上面>3.2 分析@Lazy在类的私有变量上面</h4><p><strong>@Lazy</strong> 搭配 <strong>@Autowired</strong> 使用， <strong>@Autowired</strong> 的处理类是 <strong><code>AutowiredAnnotationBeanPostProcessor</code></strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AutowiredFieldElement</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>InjectionMetadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>InjectedElement</span> <span style=color:#ce5c00;font-weight:700>{</span>

		<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>required</span><span style=color:#ce5c00;font-weight:700>;</span>

		<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>cached</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>

		<span style=color:#5c35cc;font-weight:700>@Nullable</span>
		<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Object</span> <span style=color:#000>cachedFieldValue</span><span style=color:#ce5c00;font-weight:700>;</span>

		<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>AutowiredFieldElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Field</span> <span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>required</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>required</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>required</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#5c35cc;font-weight:700>@Override</span>
		<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>inject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>PropertyValues</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>Field</span> <span style=color:#000>field</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Field</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>member</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#000>Object</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cached</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolvedCachedArgument</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cachedFieldValue</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>DependencyDescriptor</span> <span style=color:#000>desc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DependencyDescriptor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>required</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#000>desc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setContainingClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>());</span>
				<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>autowiredBeanNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>state</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;No BeanFactory available&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#000>TypeConverter</span> <span style=color:#000>typeConverter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTypeConverter</span><span style=color:#ce5c00;font-weight:700>();</span>
				<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>//这个方法主要用来处理方法
</span><span style=color:#8f5902;font-style:italic></span>					<span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolveDependency</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>desc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>autowiredBeanNames</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>typeConverter</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>UnsatisfiedDependencyException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InjectionPoint</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cached</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>required</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
							<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cachedFieldValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>desc</span><span style=color:#ce5c00;font-weight:700>;</span>
							<span style=color:#000>registerDependentBeans</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>autowiredBeanNames</span><span style=color:#ce5c00;font-weight:700>);</span>
							<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>autowiredBeanNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
								<span style=color:#000>String</span> <span style=color:#000>autowiredBeanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>autowiredBeanNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>iterator</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>();</span>
								<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>autowiredBeanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
										<span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTypeMatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>autowiredBeanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getType</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
									<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cachedFieldValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ShortcutDependencyDescriptor</span><span style=color:#ce5c00;font-weight:700>(</span>
											<span style=color:#000>desc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>autowiredBeanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getType</span><span style=color:#ce5c00;font-weight:700>());</span>
								<span style=color:#ce5c00;font-weight:700>}</span>
							<span style=color:#ce5c00;font-weight:700>}</span>
						<span style=color:#ce5c00;font-weight:700>}</span>
						<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
							<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cachedFieldValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
						<span style=color:#ce5c00;font-weight:700>}</span>
						<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cached</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>ReflectionUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>makeAccessible</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>看一下value = beanFactory.resolveDependency(desc, beanName, autowiredBeanNames, typeConverter)这段代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>resolveDependency</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DependencyDescriptor</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>String</span> <span style=color:#000>requestingBeanName</span><span style=color:#ce5c00;font-weight:700>,</span>
			<span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>autowiredBeanNames</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>TypeConverter</span> <span style=color:#000>typeConverter</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>

		<span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>initParameterNameDiscovery</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getParameterNameDiscoverer</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Optional</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDependencyType</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>createOptionalDependency</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestingBeanName</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDependencyType</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>||</span>
				<span style=color:#000>ObjectProvider</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDependencyType</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DependencyObjectProvider</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestingBeanName</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>javaxInjectProviderClass</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDependencyType</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Jsr330Factory</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>createDependencyProvider</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestingBeanName</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//处理包含有@Lazy注解的
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>Object</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getAutowireCandidateResolver</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getLazyResolutionProxyIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span>
					<span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestingBeanName</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>doResolveDependency</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestingBeanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>autowiredBeanNames</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>typeConverter</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote><p>DefaultListableBeanFactory 默认为 private AutowireCandidateResolver autowireCandidateResolver = new SimpleAutowireCandidateResolver();对于注解类的在AnnotationConfigUtils进行了设置，AnnotationConfigUtils#registerAnnotationConfigProcessors方法中。if (!(beanFactory.getAutowireCandidateResolver() instanceof ContextAnnotationAutowireCandidateResolver)) { beanFactory.setAutowireCandidateResolver(new ContextAnnotationAutowireCandidateResolver());}进行了设置</p></blockquote><p>分析一下 <strong><code>ContextAnnotationAutowireCandidateResolver#getLazyResolutionProxyIfNecessary</code></strong> 的方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getLazyResolutionProxyIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DependencyDescriptor</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    	<span style=color:#8f5902;font-style:italic>//判断是否为懒加载
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isLazy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>buildLazyResolutionProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>下面来 <strong><code>buildLazyResolutionProxy</code></strong> 方法，创建代理类：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>buildLazyResolutionProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>DependencyDescriptor</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>state</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getBeanFactory</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>DefaultListableBeanFactory</span><span style=color:#ce5c00;font-weight:700>,</span>
				<span style=color:#4e9a06>&#34;BeanFactory needs to be a DefaultListableBeanFactory&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>DefaultListableBeanFactory</span> <span style=color:#000>beanFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DefaultListableBeanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>getBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#000>TargetSource</span> <span style=color:#000>ts</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TargetSource</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#5c35cc;font-weight:700>@Override</span>
			<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>getTargetClass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDependencyType</span><span style=color:#ce5c00;font-weight:700>();</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#5c35cc;font-weight:700>@Override</span>
			<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isStatic</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#5c35cc;font-weight:700>@Override</span>
			<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getTarget</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>Object</span> <span style=color:#000>target</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doResolveDependency</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>target</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getTargetClass</span><span style=color:#ce5c00;font-weight:700>();</span>
					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Collections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>emptyMap</span><span style=color:#ce5c00;font-weight:700>();</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Collections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>emptyList</span><span style=color:#ce5c00;font-weight:700>();</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Collections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>emptySet</span><span style=color:#ce5c00;font-weight:700>();</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NoSuchBeanDefinitionException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResolvableType</span><span style=color:#ce5c00;font-weight:700>(),</span>
							<span style=color:#4e9a06>&#34;Optional dependency not present for lazy injection point&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>target</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#5c35cc;font-weight:700>@Override</span>
			<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>releaseTarget</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>target</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>};</span>
		<span style=color:#000>ProxyFactory</span> <span style=color:#000>pf</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ProxyFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#000>pf</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTargetSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ts</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>dependencyType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDependencyType</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dependencyType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInterface</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>pf</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addInterface</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dependencyType</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>pf</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClassLoader</span><span style=color:#ce5c00;font-weight:700>());</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-65df0f64929033bf15b2d78139bd7a6d>1.22 - Spring Event源码解析</h1><h3 id=1-spring事件机制>1. Spring事件机制</h3><p>事件驱动模型通常也被理解成观察者模式或者发布/订阅模型</p><h4 id=11-基本概念>1.1 基本概念</h4><p>Spring的事件驱动模型主要由三部分组成:</p><ul><li><p><strong>事件</strong></p><p>ApplicationEvent，继承自JDK的EventObject，所有事件将继承它，并通过source得到事件源</p></li><li><p><strong>事件发布者</strong></p><p>ApplicationEventPublisher(发布)及ApplicationEventMulticaster(广播)接口，使用这个接口，我们的Service就拥有了发布事件的能力。</p></li><li><p><strong>事件订阅者</strong></p><p>ApplicationListener，继承自JDK的EventListener，所有监听器将继承它</p></li></ul><h3 id=2-spring源码分析事件驱动过程>2. Spring源码分析事件驱动过程</h3><p>在 <strong><code>AbstractApplicationContext#refresh</code></strong> 方法中有一个 <strong><code>initApplicationEventMulticaster</code></strong> 方法来初始化事件的多通道。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>initApplicationEventMulticaster</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>beanFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsLocalBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>APPLICATION_EVENT_MULTICASTER_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationEventMulticaster</span> <span style=color:#ce5c00;font-weight:700>=</span>
					<span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>APPLICATION_EVENT_MULTICASTER_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ApplicationEventMulticaster</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTraceEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Using ApplicationEventMulticaster [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationEventMulticaster</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationEventMulticaster</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SimpleApplicationEventMulticaster</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>APPLICATION_EVENT_MULTICASTER_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationEventMulticaster</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTraceEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;No &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>APPLICATION_EVENT_MULTICASTER_BEAN_NAME</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; bean, using &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
						<span style=color:#4e9a06>&#34;[&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationEventMulticaster</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getSimpleName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过上面的代码可以看出来， <strong><code>ApplicationEventMulticaster</code></strong> 接口在Spring中的一个实现就是 <strong><code>SimpleApplicationEventMulticaster</code></strong> 。</p><p>通过 <strong><code>ApplicationContextAwareProcessor</code></strong> 来处理 <strong><code>ApplicationEventPublisherAware</code></strong> 事件发表。在 <strong><code>AbstractApplicationContext#prepareBeanFactory</code></strong> 方法中有这样一段代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerResolvableDependency</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationEventPublisher</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>把 <strong><code>ApplicationContext</code></strong> 作为 <strong><code>ApplicationEventPublisher</code></strong> ，因为 <strong><code>ApplicationContext</code></strong> 的实现类同样也实现了 <strong><code>ApplicationEventPublisher</code></strong> 接口。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-b653ad2f4e320e70e346c261d955ef79>2 - Spring framework注解源码分析</h1><h2 id=1-spring-framework注解>1 Spring Framework注解</h2><p><img src="https://github.com/mxsm/picture/blob/main/spring/spring-framework%E6%B3%A8%E8%A7%A3%E5%85%A8%E5%9B%BE.png?raw=true" alt=Spring注解></p></div><div class=td-content><h1 id=pg-695935ff0bfbe0f2c238fcb68c3df0c3>2.1 - Spring注解源码解析之-Autowired和Value</h1><h3 id=1-autowired和value注解>1. @Autowired和@Value注解</h3><blockquote><p>源码版本Spring5.2.X</p></blockquote><p>首先来看一下这两个注解的源码</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Target</span><span style=color:#ce5c00;font-weight:700>({</span><span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONSTRUCTOR</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>METHOD</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PARAMETER</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>FIELD</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ANNOTATION_TYPE</span><span style=color:#ce5c00;font-weight:700>})</span>
<span style=color:#5c35cc;font-weight:700>@Retention</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RetentionPolicy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RUNTIME</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Documented</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#5c35cc;font-weight:700>@interface</span> <span style=color:#000>Autowired</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>required</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@Target</span><span style=color:#ce5c00;font-weight:700>({</span><span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>FIELD</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>METHOD</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PARAMETER</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ANNOTATION_TYPE</span><span style=color:#ce5c00;font-weight:700>})</span>
<span style=color:#5c35cc;font-weight:700>@Retention</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RetentionPolicy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RUNTIME</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Documented</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#5c35cc;font-weight:700>@interface</span> <span style=color:#000>Value</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#000>String</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div><p>从上面的源码可以看出来两个注解都可以用于 <strong><code>方法、参数、变量、注解类型</code></strong> 。<strong><code>@Autowired</code></strong> 还能用于构造函数。通过这个类使用的地方可以看出来，主要用于类的内部。所以主要是通过 <strong><code>BeanPostProcessor</code></strong> 来处理这两个注解。</p><h3 id=2-注解处理类autowiredannotationbeanpostprocessor源码解析>2. 注解处理类AutowiredAnnotationBeanPostProcessor源码解析</h3><p>首先看 <em><strong><code>AutowiredAnnotationBeanPostProcessor</code></strong></em> 是如何注入到上下文中的。通过代码发现主要是有 <strong><code>AnnotationConfigUtils#registerAnnotationConfigProcessors</code></strong> 注入到上下文中的。看一下源码</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>registerAnnotationConfigProcessors</span><span style=color:#ce5c00;font-weight:700>(</span>
			<span style=color:#000>BeanDefinitionRegistry</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>Object</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

		<span style=color:#000>DefaultListableBeanFactory</span> <span style=color:#000>beanFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>unwrapDefaultListableBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>//省略代码
</span><span style=color:#8f5902;font-style:italic></span>
        <span style=color:#8f5902;font-style:italic>//注入AutowiredAnnotationBeanPostProcessor类的定义
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>RootBeanDefinition</span> <span style=color:#000>def</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AutowiredAnnotationBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>beanDefs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registerPostProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>));</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#8f5902;font-style:italic>//省略代码
</span><span style=color:#8f5902;font-style:italic></span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>beanDefs</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>下面来看一下 <strong><code>AutowiredAnnotationBeanPostProcessor</code></strong> 源码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AutowiredAnnotationBeanPostProcessor</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>InstantiationAwareBeanPostProcessorAdapter</span>
		<span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>MergedBeanDefinitionPostProcessor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>PriorityOrdered</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanFactoryAware</span> <span style=color:#ce5c00;font-weight:700>{</span>
    
    <span style=color:#8f5902;font-style:italic>//省略代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong><code>AutowiredAnnotationBeanPostProcessor</code></strong> 继承了 <strong><code>InstantiationAwareBeanPostProcessorAdapter</code></strong> 类（这个类是BeanPostProcessor的实现）。然后还实现了其他的三个接口。</p><p>首先来看一下这个类的构造函数：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>AutowiredAnnotationBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>autowiredAnnotationTypes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Autowired</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>autowiredAnnotationTypes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Value</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>autowiredAnnotationTypes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Annotation</span><span style=color:#ce5c00;font-weight:700>&gt;)</span>
					<span style=color:#000>ClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;javax.inject.Inject&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>AutowiredAnnotationBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>()));</span>
			<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;JSR-330 &#39;javax.inject.Inject&#39; annotation found and supported for autowiring&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassNotFoundException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>// JSR-330 API not available - simply skip.
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从这个构造函数可以看出来主要处理 <strong>@Autowired、@Value、javax.inject.Inject</strong> 。 第三个是javax。这就是对 JSR-330 标准的支持。通过调用 <strong><code>postProcessProperties</code></strong> 方法来处理以上的三个注解</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>PropertyValues</span> <span style=color:#000>postProcessProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PropertyValues</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>InjectionMetadata</span> <span style=color:#000>metadata</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>findAutowiringMetadata</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>inject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanCreationException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Injection of autowired dependencies failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>主要是通过 <strong><code>findAutowiringMetadata</code></strong> 方法来获取自动注入元数据。以及通过 <strong><code>InjectionMetadata#inject</code></strong> 方法来注入元数据。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>InjectionMetadata</span> <span style=color:#000>findAutowiringMetadata</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>PropertyValues</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>// Fall back to class name as cache key, for backwards compatibility with custom callers.
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>String</span> <span style=color:#000>cacheKey</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasLength</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#8f5902;font-style:italic>// 从缓存中获取注入元数据
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>InjectionMetadata</span> <span style=color:#000>metadata</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>injectionMetadataCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#8f5902;font-style:italic>//判断是否需要刷新
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InjectionMetadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>needsRefresh</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>injectionMetadataCache</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>metadata</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>injectionMetadataCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InjectionMetadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>needsRefresh</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadata</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#8f5902;font-style:italic>//创建注入元数据
</span><span style=color:#8f5902;font-style:italic></span>					<span style=color:#000>metadata</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>buildAutowiringMetadata</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#8f5902;font-style:italic>//缓存注入元数据
</span><span style=color:#8f5902;font-style:italic></span>					<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>injectionMetadataCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>源代码可以看出来主要是有两个方法：</p><ul><li><p><strong>InjectionMetadata.needsRefresh</strong></p><p>判断从缓存中获取的注入元数据是否需要刷新：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>needsRefresh</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>InjectionMetadata</span> <span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadata</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>targetClass</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li><li><p><strong>buildAutowiringMetadata</strong></p><p>创建自动注入的元数据</p></li></ul><p>下面来看一下 <strong><code>buildAutowiringMetadata</code></strong> 的源码是如何创建自动注入元数据的。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>InjectionMetadata</span> <span style=color:#000>buildAutowiringMetadata</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>//判断是否包含 @Autowired @Value 或者@Inject注解
</span><span style=color:#8f5902;font-style:italic></span>       <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>AnnotationUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isCandidateClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>autowiredAnnotationTypes</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>InjectionMetadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>EMPTY</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>InjectionMetadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>InjectedElement</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>elements</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
		<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>targetClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>;</span>

		<span style=color:#204a87;font-weight:700>do</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>InjectionMetadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>InjectedElement</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>currElements</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
			<span style=color:#8f5902;font-style:italic>//通过反射获取targetClass
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>ReflectionUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doWithLocalFields</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>targetClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>field</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>MergedAnnotation</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>ann</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>findAutowiredAnnotation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ann</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Modifier</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isStatic</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getModifiers</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInfoEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
							<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Autowired annotation is not supported on static fields: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>);</span>
						<span style=color:#ce5c00;font-weight:700>}</span>
						<span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>required</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>determineRequiredStatus</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ann</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#000>currElements</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AutowiredFieldElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>required</span><span style=color:#ce5c00;font-weight:700>));</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>});</span>

			<span style=color:#000>ReflectionUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doWithLocalMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>targetClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>Method</span> <span style=color:#000>bridgedMethod</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>BridgeMethodResolver</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findBridgedMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>BridgeMethodResolver</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isVisibilityBridgeMethodPair</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bridgedMethod</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#000>MergedAnnotation</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>ann</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>findAutowiredAnnotation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bridgedMethod</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ann</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMostSpecificMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Modifier</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isStatic</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getModifiers</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInfoEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
							<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Autowired annotation is not supported on static methods: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>);</span>
						<span style=color:#ce5c00;font-weight:700>}</span>
						<span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterCount</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInfoEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
							<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Autowired annotation should only be used on methods with parameters: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
									<span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>);</span>
						<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>required</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>determineRequiredStatus</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ann</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#000>PropertyDescriptor</span> <span style=color:#000>pd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>BeanUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findPropertyForMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bridgedMethod</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#000>currElements</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AutowiredMethodElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>required</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pd</span><span style=color:#ce5c00;font-weight:700>));</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>});</span>

			<span style=color:#000>elements</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>currElements</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>targetClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>targetClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSuperclass</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>targetClass</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>targetClass</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>

		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>InjectionMetadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forElements</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elements</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过上面的代码可以看出来处理主要分成了两类：</p><ul><li>处理类的字段上面的注解</li><li>处理方法上面注解</li></ul><p>根据处理的不同的数据创建两个不同的自动注入元素。字段的创建 <strong><code>AutowiredFieldElement</code></strong> 、 方法上面的注解创建 <strong><code>AutowiredMethodElement</code></strong> 。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AutowiredFieldElement</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>InjectionMetadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>InjectedElement</span> <span style=color:#ce5c00;font-weight:700>{</span>
 <span style=color:#8f5902;font-style:italic>//省略代码   
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AutowiredMethodElement</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>InjectionMetadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>InjectedElement</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//省略代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>以上两个都是内部类。都继承了 <strong><code>InjectionMetadata.InjectedElement</code></strong> 的接口。根据不同类型创建好以后通过调用：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>InjectionMetadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forElements</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elements</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>创建返回数据。也就是调用 <strong><code>findAutowiringMetadata</code></strong> 方法中的 <strong><code>buildAutowiringMetadata</code></strong> 方法。在前面分析过</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>processInjection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanCreationException</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>clazz</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#000>InjectionMetadata</span> <span style=color:#000>metadata</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>findAutowiringMetadata</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//这里就是注入数据。
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>inject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanCreationException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span>
					<span style=color:#4e9a06>&#34;Injection of autowired dependencies failed for class [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>clazz</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这里可以分一下 <em><strong><code>InjectionMetadata#inject</code></strong></em> 方法</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>inject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>target</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>PropertyValues</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>InjectedElement</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>checkedElements</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>checkedElements</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>InjectedElement</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>elementsToIterate</span> <span style=color:#ce5c00;font-weight:700>=</span>
				<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>checkedElements</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>checkedElements</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>injectedElements</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>elementsToIterate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InjectedElement</span> <span style=color:#000>element</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>elementsToIterate</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTraceEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Processing injected element of bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#8f5902;font-style:italic>//主要是InjectedElement#inject来处理
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>inject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>target</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>最终是通过调用 <em><strong><code>InjectedElement#inject</code></strong></em> 方法来注入。下面来分析一下 <strong>AutowiredFieldElement</strong> 和 <strong>AutowiredMethodElement</strong> 的实现。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AutowiredFieldElement</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>InjectionMetadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>InjectedElement</span> <span style=color:#ce5c00;font-weight:700>{</span>

		<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>required</span><span style=color:#ce5c00;font-weight:700>;</span>

		<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>cached</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>

		<span style=color:#5c35cc;font-weight:700>@Nullable</span>
		<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Object</span> <span style=color:#000>cachedFieldValue</span><span style=color:#ce5c00;font-weight:700>;</span>

		<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>AutowiredFieldElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Field</span> <span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>required</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>required</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>required</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#5c35cc;font-weight:700>@Override</span>
		<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>inject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>PropertyValues</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>Field</span> <span style=color:#000>field</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Field</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>member</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#000>Object</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#8f5902;font-style:italic>//第一次不会进入因为cached默认为false
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cached</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolvedCachedArgument</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cachedFieldValue</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#8f5902;font-style:italic>//创建一个依赖的描述
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>DependencyDescriptor</span> <span style=color:#000>desc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DependencyDescriptor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>required</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#000>desc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setContainingClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>());</span>
				<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>autowiredBeanNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>state</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;No BeanFactory available&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#8f5902;font-style:italic>//获取类型转换器
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>TypeConverter</span> <span style=color:#000>typeConverter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTypeConverter</span><span style=color:#ce5c00;font-weight:700>();</span>
				<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#8f5902;font-style:italic>//获取值
</span><span style=color:#8f5902;font-style:italic></span>					<span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolveDependency</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>desc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>autowiredBeanNames</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>typeConverter</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>UnsatisfiedDependencyException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InjectionPoint</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#8f5902;font-style:italic>//处理依赖注入的数据
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cached</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>required</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
							<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cachedFieldValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>desc</span><span style=color:#ce5c00;font-weight:700>;</span>
							<span style=color:#000>registerDependentBeans</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>autowiredBeanNames</span><span style=color:#ce5c00;font-weight:700>);</span>
							<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>autowiredBeanNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
								<span style=color:#000>String</span> <span style=color:#000>autowiredBeanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>autowiredBeanNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>iterator</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>();</span>
								<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>autowiredBeanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
										<span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTypeMatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>autowiredBeanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getType</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
									<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cachedFieldValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ShortcutDependencyDescriptor</span><span style=color:#ce5c00;font-weight:700>(</span>
											<span style=color:#000>desc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>autowiredBeanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getType</span><span style=color:#ce5c00;font-weight:700>());</span>
								<span style=color:#ce5c00;font-weight:700>}</span>
							<span style=color:#ce5c00;font-weight:700>}</span>
						<span style=color:#ce5c00;font-weight:700>}</span>
						<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
							<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cachedFieldValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
						<span style=color:#ce5c00;font-weight:700>}</span>
						<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cached</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#8f5902;font-style:italic>//在Value不为空的情况下通过反射设置值
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>ReflectionUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>makeAccessible</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><em><strong><code>AutowiredMethodElement</code></strong></em> 的实现和 <em><strong><code>AutowiredFieldElement</code></strong></em> 实现差不多。</p><h3 id=3-自定义拓展>3. 自定义拓展</h3><p>自定义的拓展可以参考一下几个项目：</p><ul><li><a href=https://github.com/mxsm/spring-sample/tree/master/mxsm-nacos>自定义的Nacos的拓展项目地址</a></li><li><a href=https://github.com/nacos-group/nacos-spring-project>阿里巴巴的Nacos项目Spring拓展</a></li></ul><p>第一个项目是自己写的，类似于@Value注解。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-c8474c1505aab37e3c0c5c83e70ab818>2.2 - spring注解源码解析之-Conditional</h1><h3 id=1-conditional注解的作用>1. Conditional注解的作用</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Target</span><span style=color:#ce5c00;font-weight:700>({</span><span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TYPE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>METHOD</span><span style=color:#ce5c00;font-weight:700>})</span>
<span style=color:#5c35cc;font-weight:700>@Retention</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RetentionPolicy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RUNTIME</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Documented</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#5c35cc;font-weight:700>@interface</span> <span style=color:#000>Conditional</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Condition</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>();</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@FunctionalInterface</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Condition</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>matches</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConditionContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>AnnotatedTypeMetadata</span> <span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>一个是注解、一个是接口。</p><h3 id=2-从源码解析conditional如何发挥作用>2. 从源码解析Conditional如何发挥作用</h3><p>通过源码分析注解 <strong>Conditional</strong> 主要在三个类中。 <strong>AnnotatedBeanDefinitionReader</strong> 、 <strong>ClassPathScanningCandidateComponentProvider</strong> 、 <strong>ConditionEvaluator</strong> 。通过进一步分析发现 <strong>AnnotatedBeanDefinitionReader、ClassPathScanningCandidateComponentProvider</strong> 中都包含了 <strong><code>ConditionEvaluator</code></strong> 类的变量。<strong><code>AnnotatedBeanDefinitionReader</code></strong> 主要用来读取注解的BeanDefinition，而 <strong><code>ClassPathScanningCandidateComponentProvider</code></strong> 主要由 <strong><code>ClassPathBeanDefinitionScanner</code></strong> 继承，该类主要用来扫描class path 的BeanDefinition。下面通过分析一下 <strong><code>ClassPathBeanDefinitionScanner</code></strong> 源码来看一下如何发挥作用的，看一下 <strong><code>ClassPathBeanDefinitionScanner#doScan</code></strong> 方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>doScan</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>basePackages</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    
    <span style=color:#8f5902;font-style:italic>//省略部分代码
</span><span style=color:#8f5902;font-style:italic></span>    
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>basePackage</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>basePackages</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//这个方法来找到候选的BeanDefinition
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinition</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>candidates</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>findCandidateComponents</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>basePackage</span><span style=color:#ce5c00;font-weight:700>);</span>
        
        <span style=color:#8f5902;font-style:italic>//生路部分代码
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>那么再来看一下 <strong>ClassPathScanningCandidateComponentProvider#findCandidateComponents</strong> 方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinition</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>findCandidateComponents</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>basePackage</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>componentsIndex</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>indexSupportsIncludeFilters</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>addCandidateComponentsFromIndex</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>componentsIndex</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>basePackage</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>scanCandidateComponents</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>basePackage</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>进一步分析上面的 <strong>scanCandidateComponents</strong> 和 <strong>addCandidateComponentsFromIndex</strong> 方法发现，这两个方法中都调用了同一个方法 <strong>ClassPathScanningCandidateComponentProvider#isCandidateComponent</strong> ：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isCandidateComponent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MetadataReader</span> <span style=color:#000>metadataReader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
	    <span style=color:#8f5902;font-style:italic>//excludeFilters排除
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TypeFilter</span> <span style=color:#000>tf</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>excludeFilters</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tf</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>match</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadataReader</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getMetadataReaderFactory</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TypeFilter</span> <span style=color:#000>tf</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>includeFilters</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tf</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>match</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadataReader</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getMetadataReaderFactory</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			    <span style=color:#8f5902;font-style:italic>//这个方法就是Conditional注解的实现
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>isConditionMatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadataReader</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isConditionMatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MetadataReader</span> <span style=color:#000>metadataReader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>conditionEvaluator</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>conditionEvaluator</span> <span style=color:#ce5c00;font-weight:700>=</span>
					<span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConditionEvaluator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getRegistry</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>environment</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resourcePatternResolver</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>conditionEvaluator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shouldSkip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadataReader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAnnotationMetadata</span><span style=color:#ce5c00;font-weight:700>());</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过代码分析可以看出来最后是通过调用 <em><strong><code>ConditionEvaluator#shouldSkip</code></strong></em> 的方法来实现的。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>shouldSkip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AnnotatedTypeMetadata</span> <span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>shouldSkip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>shouldSkip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>AnnotatedTypeMetadata</span> <span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>ConfigurationPhase</span> <span style=color:#000>phase</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		
		<span style=color:#8f5902;font-style:italic>//判断是否有注解Conditional
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadata</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAnnotated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Conditional</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>//判断配置解析的类型
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>phase</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			
			<span style=color:#8f5902;font-style:italic>//配置类的类型
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadata</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>AnnotationMetadata</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
					<span style=color:#000>ConfigurationClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isConfigurationCandidate</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>AnnotationMetadata</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>shouldSkip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ConfigurationPhase</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PARSE_CONFIGURATION</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#8f5902;font-style:italic>//bean注册类型
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>shouldSkip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ConfigurationPhase</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>REGISTER_BEAN</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Condition</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>conditions</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>conditionClasses</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>getConditionClasses</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>conditionClass</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>conditionClasses</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>Condition</span> <span style=color:#000>condition</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getCondition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>conditionClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>());</span>
				<span style=color:#000>conditions</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>condition</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#000>AnnotationAwareOrderComparator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sort</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>conditions</span><span style=color:#ce5c00;font-weight:700>);</span>

		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Condition</span> <span style=color:#000>condition</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>conditions</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>ConfigurationPhase</span> <span style=color:#000>requiredPhase</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>condition</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>ConfigurationCondition</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>requiredPhase</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ConfigurationCondition</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>condition</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getConfigurationPhase</span><span style=color:#ce5c00;font-weight:700>();</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#8f5902;font-style:italic>//调用Condition#matches接口来判断是否加载该类
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>requiredPhase</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>requiredPhase</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>phase</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>condition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>matches</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过源码解析就知道了注解@Conditional配合Condition接口在Spring容器中进行条件化加载Bean。这个在SpringBoot中被广泛的应用。</p><blockquote><p>这个条件加载Bean和策略模式差不多。通过不同的策略来加载不同的Bean</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-761d50c98cba02db1ead1d87e662790a>2.3 - spring注解源码解析之-配置类注解</h1><h3 id=1-spring配置类注解>1. Spring配置类注解</h3><p>在Spring中的配置类主要包含五个注解：</p><ul><li><strong>Component</strong></li><li><strong>ComponentScan</strong></li><li><strong>Import</strong></li><li><strong>ImportResource</strong></li><li><strong>Configuration</strong></li></ul><h3 id=2-spring配置类注解源码解析>2. Spring配置类注解源码解析</h3><p>配置类注解主要是由 <em><strong><code>ConfigurationClassPostProcessor</code></strong></em> 来处理。下面看一下源码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ConfigurationClassPostProcessor</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>BeanDefinitionRegistryPostProcessor</span><span style=color:#ce5c00;font-weight:700>,</span>
		<span style=color:#000>PriorityOrdered</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ResourceLoaderAware</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanClassLoaderAware</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>EnvironmentAware</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//省略各种代码		    
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>实现了 <strong>BeanDefinitionRegistryPostProcessor</strong> 接口。该接口是 <strong>BeanFactoryPostProcessor</strong> 继承而来。这个接口主要用来处理类上面的注解。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>postProcessBeanDefinitionRegistry</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionRegistry</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>registryId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>identityHashCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registriesPostProcessed</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registryId</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span>
					<span style=color:#4e9a06>&#34;postProcessBeanDefinitionRegistry already called on this post-processor against &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>factoriesPostProcessed</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registryId</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span>
					<span style=color:#4e9a06>&#34;postProcessBeanFactory already called on this post-processor against &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registriesPostProcessed</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registryId</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>//处理方法
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>processConfigBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div><p>通过源码可以看出来主要是通过 <strong><em>ConfigurationClassPostProcessor</em>#processConfigBeanDefinitions</strong> 方法处理。下面来看一下方法 <em><strong>processConfigBeanDefinitions</strong></em> 源码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>processConfigBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionRegistry</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>configCandidates</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
    <span style=color:#8f5902;font-style:italic>//获取Bean的定义名称
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>candidateNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinitionNames</span><span style=color:#ce5c00;font-weight:700>();</span>
	
	<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>candidateNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>BeanDefinition</span> <span style=color:#000>beanDef</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDef</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurationClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONFIGURATION_CLASS_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//省略打印日志
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#8f5902;font-style:italic>//判断是否为ConfigurationClass
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurationClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>checkConfigurationClassCandidate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDef</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>metadataReaderFactory</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>configCandidates</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDef</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>));</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#8f5902;font-style:italic>//省略后续处理代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过代码发现主要是通过 <em><strong>ConfigurationClassUtils.checkConfigurationClassCandidate</strong></em> 方法来校验是否为 <strong>ConfigurationClass</strong> 。那么来研究一下方法 <strong>checkConfigurationClassCandidate</strong> ：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>checkConfigurationClassCandidate</span><span style=color:#ce5c00;font-weight:700>(</span>
			<span style=color:#000>BeanDefinition</span> <span style=color:#000>beanDef</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MetadataReaderFactory</span> <span style=color:#000>metadataReaderFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//省略部分代码
</span><span style=color:#8f5902;font-style:italic></span>    
    <span style=color:#8f5902;font-style:italic>//获取是否Configuration修饰的类
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>config</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAnnotationAttributes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>config</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>FALSE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;proxyBeanMethods&#34;</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>beanDef</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CONFIGURATION_CLASS_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CONFIGURATION_CLASS_FULL</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#8f5902;font-style:italic>//判断是否为Component、ComponentScan、Import、ImportResource中的一个
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>config</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>isConfigurationCandidate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>beanDef</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CONFIGURATION_CLASS_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CONFIGURATION_CLASS_LITE</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#8f5902;font-style:italic>//省略部分代码
</span><span style=color:#8f5902;font-style:italic></span>	
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>//isConfigurationCandidate源码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isConfigurationCandidate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AnnotationMetadata</span> <span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>// 判断是否为接口
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInterface</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>// 是否为Component、ComponentScan、Import、ImportResource配置类中的一个
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>indicator</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>candidateIndicators</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAnnotated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>indicator</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>// 查询是否有被@Bean注解修复的方法
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasAnnotatedMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//省略日志打印
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过源码分析可以发现配置Class分为两类：</p><ul><li><p><strong>full configurationClass</strong></p><p>Spring中称为full configurationClass,这个是由注解@Configuration注解修饰的。</p></li><li><p><strong>lite configurationClass</strong></p><p>Spring中称为lite configurationClass，也就是轻量级的配置类，由注解@Component、@ComponentScan、@Import、@ImportResource</p></li></ul><p>在来看一下 <em><em>ConfigurationClassPostProcessor</em>#<em>processConfigBeanDefinitions</em></em>* 中是如何来处理configurationClass：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>processConfigBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionRegistry</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    
    <span style=color:#8f5902;font-style:italic>//省略代码
</span><span style=color:#8f5902;font-style:italic></span>    
    <span style=color:#8f5902;font-style:italic>//configCandidates的处理代码如下
</span><span style=color:#8f5902;font-style:italic></span>    
    <span style=color:#8f5902;font-style:italic>//ConfigurationClassParser处理类来处理configCandidates
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>ConfigurationClassParser</span> <span style=color:#000>parser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConfigurationClassParser</span><span style=color:#ce5c00;font-weight:700>(</span>
				<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>metadataReaderFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>problemReporter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>environment</span><span style=color:#ce5c00;font-weight:700>,</span>
				<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resourceLoader</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>componentScanBeanNameGenerator</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>

		<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>candidates</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>configCandidates</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ConfigurationClass</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>alreadyParsed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>configCandidates</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#204a87;font-weight:700>do</span> <span style=color:#ce5c00;font-weight:700>{</span>
		    <span style=color:#8f5902;font-style:italic>//解析candidates
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidates</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>validate</span><span style=color:#ce5c00;font-weight:700>();</span>
            
            <span style=color:#8f5902;font-style:italic>//获取解析后的配置类
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ConfigurationClass</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>configClasses</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConfigurationClasses</span><span style=color:#ce5c00;font-weight:700>());</span>
			<span style=color:#000>configClasses</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>removeAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>alreadyParsed</span><span style=color:#ce5c00;font-weight:700>);</span>

			<span style=color:#8f5902;font-style:italic>// 创建解析后的配置类Bean
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reader</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConfigurationClassBeanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>(</span>
						<span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sourceExtractor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resourceLoader</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>environment</span><span style=color:#ce5c00;font-weight:700>,</span>
						<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>importBeanNameGenerator</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getImportRegistry</span><span style=color:#ce5c00;font-weight:700>());</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClasses</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>alreadyParsed</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClasses</span><span style=color:#ce5c00;font-weight:700>);</span>

			<span style=color:#000>candidates</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>
			<span style=color:#8f5902;font-style:italic>//循环处理
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinitionCount</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>candidateNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>newCandidateNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinitionNames</span><span style=color:#ce5c00;font-weight:700>();</span>
				<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>oldCandidateNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>asList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidateNames</span><span style=color:#ce5c00;font-weight:700>));</span>
				<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>alreadyParsedClasses</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
				<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurationClass</span> <span style=color:#000>configurationClass</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>alreadyParsed</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>alreadyParsedClasses</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configurationClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getClassName</span><span style=color:#ce5c00;font-weight:700>());</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>candidateName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>newCandidateNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>oldCandidateNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidateName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#000>BeanDefinition</span> <span style=color:#000>bd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidateName</span><span style=color:#ce5c00;font-weight:700>);</span>
						<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurationClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>checkConfigurationClassCandidate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>metadataReaderFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
								<span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>alreadyParsedClasses</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClassName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
							<span style=color:#000>candidates</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>candidateName</span><span style=color:#ce5c00;font-weight:700>));</span>
						<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#000>candidateNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newCandidateNames</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>candidates</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>());</span>    
    
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过代码分析上面的代码主要处理ConfigurationClass是通过 <em><strong>ConfigurationClassParser</strong></em> 解析器来处理。下面看一下解析器的 <em><strong>ConfigurationClassParser#parse</strong></em> 方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>configCandidates</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionHolder</span> <span style=color:#000>holder</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>configCandidates</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>BeanDefinition</span> <span style=color:#000>bd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>holder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinition</span><span style=color:#ce5c00;font-weight:700>();</span>
			<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>AnnotatedBeanDefinition</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>(((</span><span style=color:#000>AnnotatedBeanDefinition</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>holder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanName</span><span style=color:#ce5c00;font-weight:700>());</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>AbstractBeanDefinition</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>AbstractBeanDefinition</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>hasBeanClass</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>(((</span><span style=color:#000>AbstractBeanDefinition</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getBeanClass</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>holder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanName</span><span style=color:#ce5c00;font-weight:700>());</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClassName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>holder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanName</span><span style=color:#ce5c00;font-weight:700>());</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionStoreException</span><span style=color:#ce5c00;font-weight:700>(</span>
						<span style=color:#4e9a06>&#34;Failed to parse configuration class [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClassName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//处理DeferredImportSelector接口
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>deferredImportSelectorHandler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>process</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过上面代码可以看出来主要是分为两部分：</p><ul><li><p><strong>ConfigurationClassParser#parse ConfigurationClass解析</strong></p><p>ConfigurationClassParser#parse是一个空壳方法，当中调用了一个 ConfigurationClassParser#processConfigurationClass方法</p></li><li><p><strong>DeferredImportSelector接口的处理</strong></p></li></ul><p>下面来分析一下 <strong>ConfigurationClassParser#processConfigurationClass</strong> 方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>processConfigurationClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurationClass</span> <span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//条件加载的判定之前有分析过@Conditional注解
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>conditionEvaluator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shouldSkip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>ConfigurationPhase</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PARSE_CONFIGURATION</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#000>ConfigurationClass</span> <span style=color:#000>existingClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configurationClasses</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>//省略部分代码
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>SourceClass</span> <span style=color:#000>sourceClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>asSourceClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>do</span> <span style=color:#ce5c00;font-weight:700>{</span>
		    <span style=color:#8f5902;font-style:italic>//处理ConfigurationClass
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>sourceClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>doProcessConfigurationClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sourceClass</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>

		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configurationClasses</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>代码分析可以看出来主要是通过 <em><strong>doProcessConfigurationClass</strong></em> 方法来处理ConfigurationClass类：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SourceClass</span> <span style=color:#000>doProcessConfigurationClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurationClass</span> <span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SourceClass</span> <span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>)</span>
			<span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>

		<span style=color:#8f5902;font-style:italic>//@Component注解处理
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isAnnotated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Component</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>processMemberClasses</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>// @PropertySource注解处理
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AnnotationAttributes</span> <span style=color:#000>propertySource</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>AnnotationConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>attributesForRepeatable</span><span style=color:#ce5c00;font-weight:700>(</span>
				<span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>PropertySources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span>
				<span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>springframework</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>annotation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PropertySource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>environment</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>ConfigurableEnvironment</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>processPropertySource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertySource</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#8f5902;font-style:italic>//省略日志打印
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#8f5902;font-style:italic>// @ComponentScan 注解处理
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>AnnotationAttributes</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>componentScans</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>AnnotationConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>attributesForRepeatable</span><span style=color:#ce5c00;font-weight:700>(</span>
				<span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>ComponentScans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ComponentScan</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>componentScans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
				<span style=color:#ce5c00;font-weight:700>!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>conditionEvaluator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shouldSkip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>ConfigurationPhase</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>REGISTER_BEAN</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AnnotationAttributes</span> <span style=color:#000>componentScan</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>componentScans</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#8f5902;font-style:italic>// The config class is annotated with @ComponentScan -&gt; perform the scan immediately
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>scannedBeanDefinitions</span> <span style=color:#ce5c00;font-weight:700>=</span>
						<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>componentScanParser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>componentScan</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getClassName</span><span style=color:#ce5c00;font-weight:700>());</span>
				<span style=color:#8f5902;font-style:italic>// Check the set of scanned definitions for any further config classes and parse recursively if needed
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionHolder</span> <span style=color:#000>holder</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>scannedBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>BeanDefinition</span> <span style=color:#000>bdCand</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>holder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinition</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getOriginatingBeanDefinition</span><span style=color:#ce5c00;font-weight:700>();</span>
					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bdCand</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#000>bdCand</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>holder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinition</span><span style=color:#ce5c00;font-weight:700>();</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurationClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>checkConfigurationClassCandidate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bdCand</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>metadataReaderFactory</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bdCand</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClassName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>holder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanName</span><span style=color:#ce5c00;font-weight:700>());</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>// @Import 注解处理
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>processImports</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getImports</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#8f5902;font-style:italic>// @ImportResource 注解处理
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>AnnotationAttributes</span> <span style=color:#000>importResource</span> <span style=color:#ce5c00;font-weight:700>=</span>
				<span style=color:#000>AnnotationConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>attributesFor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>ImportResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>importResource</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>resources</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>importResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;locations&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BeanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>readerClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>importResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;reader&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>resources</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>String</span> <span style=color:#000>resolvedResource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>environment</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolveRequiredPlaceholders</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addImportedResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolvedResource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>readerClass</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>// @Bean 注解方法处理
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MethodMetadata</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>beanMethods</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>retrieveBeanMethodMetadata</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MethodMetadata</span> <span style=color:#000>methodMetadata</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>beanMethods</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addBeanMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methodMetadata</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>));</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>// 处理默认的接口方法
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>processInterfaces</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>);</span>

		<span style=color:#8f5902;font-style:italic>// 处理父类
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>hasSuperClass</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>String</span> <span style=color:#000>superclass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getSuperClassName</span><span style=color:#ce5c00;font-weight:700>();</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>superclass</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>superclass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>startsWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;java&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
					<span style=color:#ce5c00;font-weight:700>!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>knownSuperclasses</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>superclass</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>knownSuperclasses</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>superclass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#8f5902;font-style:italic>// Superclass found, return its annotation metadata and recurse
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSuperClass</span><span style=color:#ce5c00;font-weight:700>();</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>		
</code></pre></div><p>通上面的代码可以发现主要处理了这样几个注解：</p><ul><li><strong>@Component注解处理</strong></li><li><strong>@PropertySource注解处理</strong></li><li><strong>@ComponentScan 注解处理</strong></li><li><strong>@Import 注解处理</strong></li><li><strong>@ImportResource 注解处理</strong></li><li><strong>@Bean 注解方法处理</strong></li><li><strong>处理默认的接口方法</strong></li><li><strong>处理父类</strong></li></ul><p>分析到这里就可以看出来， <em><strong>ConfigurationClassPostProcessor</strong></em> 类主要是处理一下的几个注解： <strong>Component、PropertySources、PropertySource、ComponentScans、ComponentScan、Import、ImportResource、Bean</strong> 。</p><h3 id=3-configurationclasspostprocessor如何注入到spring-application中>3. ConfigurationClassPostProcessor如何注入到Spring Application中</h3><p>通过 <strong>AnnotationConfigUtils</strong> 类中的静态方法 <strong>registerAnnotationConfigProcessors</strong> 注入：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME</span> <span style=color:#ce5c00;font-weight:700>=</span>
			<span style=color:#4e9a06>&#34;org.springframework.context.annotation.internalConfigurationAnnotationProcessor&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#8f5902;font-style:italic>//
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>RootBeanDefinition</span> <span style=color:#000>def</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurationClassPostProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>beanDefs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registerPostProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>));</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-ad70ba79c485f9a0ef7697bee60b61d3>2.4 -</h1><blockquote><p>基于Spring 5.4.2版本分析</p></blockquote><h3 id=1-component概要>1. @Component概要</h3><p>Spring中有一个重要的注解那就是 <strong><code>@Component</code></strong> 。对于Spring中不同场景下使用的注解例如：<strong><code>@Repository</code></strong> 、<strong><code>@Service</code></strong> 、 <strong><code>@Controller</code></strong> 都是通过 <strong><code>@Component</code></strong> 注解衍生出来的。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Target</span><span style=color:#ce5c00;font-weight:700>({</span><span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TYPE</span><span style=color:#ce5c00;font-weight:700>})</span>
<span style=color:#5c35cc;font-weight:700>@Retention</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RetentionPolicy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RUNTIME</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Documented</span>
<span style=color:#5c35cc;font-weight:700>@Component</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#5c35cc;font-weight:700>@interface</span> <span style=color:#000>Service</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#5c35cc;font-weight:700>@AliasFor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>annotation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Component</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span>
	<span style=color:#000>String</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>default</span> <span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在这里代码中还看到一个重要的注解来实现派生： <strong><code>@AliasFor</code></strong> 。</p><h3 id=2-component入口>2. @Component入口</h3><p>不论是现在Spring流行的注解方式还是以前的老式的XML配置方式都有一个入口。这里就只分析注解模式。</p><p>对于XML配置的方式可以从下面的代码中找到入口：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ContextNamespaceHandler</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>NamespaceHandlerSupport</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>init</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>registerBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;property-placeholder&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PropertyPlaceholderBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#000>registerBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;property-override&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PropertyOverrideBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#000>registerBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;annotation-config&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AnnotationConfigBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#000>registerBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;component-scan&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ComponentScanBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#000>registerBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;load-time-weaver&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LoadTimeWeaverBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#000>registerBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;spring-configured&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SpringConfiguredBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#000>registerBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;mbean-export&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MBeanExportBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#000>registerBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;mbean-server&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MBeanServerBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>());</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>对于注解方式</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>AnnotationConfigApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>basePackages</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#000>scan</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>basePackages</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>refresh</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>可以看一下 <strong><code>AnnotationConfigApplicationContext</code></strong> 类。</p><p>不管是注解方式还是XML方式最终都是通过 <strong><code>ClassPathBeanDefinitionScanner</code></strong> 类来将包含有 <strong><code>@Component</code></strong> 注解的类定义加载到Spring容器里面。</p><h3 id=3-classpathbeandefinitionscanner解析>3. ClassPathBeanDefinitionScanner解析</h3><p><strong><code>ClassPathBeanDefinitionScanner</code></strong> 作用主要是扫描带有 <strong><code>@Component</code></strong> 注解的类并实现注册。下面来看一下 <strong><code>ClassPathBeanDefinitionScanner#doScan</code></strong> 方法。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>doScan</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>basePackages</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>notEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>basePackages</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;At least one base package must be specified&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>beanDefinitions</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
	<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>basePackage</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>basePackages</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//找基础包下面的候选的Component
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinition</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>candidates</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>findCandidateComponents</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>basePackage</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>//下面是对加载的Component做进一步处理
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinition</span> <span style=color:#000>candidate</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>candidates</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>ScopeMetadata</span> <span style=color:#000>scopeMetadata</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scopeMetadataResolver</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolveScopeMetadata</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setScope</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>scopeMetadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getScopeName</span><span style=color:#ce5c00;font-weight:700>());</span>
			<span style=color:#000>String</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanNameGenerator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>generateBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidate</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>AbstractBeanDefinition</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>postProcessBeanDefinition</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>AbstractBeanDefinition</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidate</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>AnnotatedBeanDefinition</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>AnnotationConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>processCommonDefinitionAnnotations</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>AnnotatedBeanDefinition</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>checkCandidate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>BeanDefinitionHolder</span> <span style=color:#000>definitionHolder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#000>definitionHolder</span> <span style=color:#ce5c00;font-weight:700>=</span>
						<span style=color:#000>AnnotationConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applyScopedProxyMode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>scopeMetadata</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>definitionHolder</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#000>beanDefinitions</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>definitionHolder</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#000>registerBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>definitionHolder</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>beanDefinitions</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过上面的代码可以看出来主要是通过 <strong><code>ClassPathScanningCandidateComponentProvider#findCandidateComponents</code></strong> 来实现加载</p><h3 id=4-findcandidatecomponents解析>4. findCandidateComponents解析</h3><p>findCandidateComponents方法属于ClassPathScanningCandidateComponentProvider#findCandidateComponents。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinition</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>findCandidateComponents</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>basePackage</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>componentsIndex</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>indexSupportsIncludeFilters</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>addCandidateComponentsFromIndex</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>componentsIndex</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>basePackage</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>scanCandidateComponents</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>basePackage</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinition</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>scanCandidateComponents</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>basePackage</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinition</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>candidates</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
	<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>String</span> <span style=color:#000>packageSearchPath</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ResourcePatternResolver</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CLASSPATH_ALL_URL_PREFIX</span> <span style=color:#ce5c00;font-weight:700>+</span>
				<span style=color:#000>resolveBasePackage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>basePackage</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#39;/&#39;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resourcePattern</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#000>Resource</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>resources</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getResourcePatternResolver</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getResources</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>packageSearchPath</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#8f5902;font-style:italic>//省略了部分打印的代码
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Resource</span> <span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>resources</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isReadable</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>MetadataReader</span> <span style=color:#000>metadataReader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getMetadataReaderFactory</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getMetadataReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isCandidateComponent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadataReader</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#000>ScannedGenericBeanDefinition</span> <span style=color:#000>sbd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ScannedGenericBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadataReader</span><span style=color:#ce5c00;font-weight:700>);</span>
						<span style=color:#000>sbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
						<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isCandidateComponent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sbd</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>

							<span style=color:#000>candidates</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sbd</span><span style=color:#ce5c00;font-weight:700>);</span>
						<span style=color:#ce5c00;font-weight:700>}</span>

					<span style=color:#ce5c00;font-weight:700>}</span>

				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionStoreException</span><span style=color:#ce5c00;font-weight:700>(</span>
							<span style=color:#4e9a06>&#34;Failed to read candidate component class: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>

			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IOException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionStoreException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;I/O failure during classpath scanning&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>candidates</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>该方法主要还是从基础包中获取组件。从代码分析一下大概的思路：</p><ol><li>根据基础包拼装扫描的路径正则表达式。</li><li>获取路径下面的 <strong><code>.class</code></strong> 文件包装成 <strong><code>Resource</code></strong> 数组。</li><li>将 <strong><code>.class</code></strong> 文件包装成 <strong><code>Resource</code></strong> 处理成 <strong><code>MetadataReader</code></strong></li><li>判断 <strong><code>MetadataReader</code></strong> 是否为候选组件</li><li>判断 <strong><code>ScannedGenericBeanDefinition</code></strong> 是否为候选组件，<strong><code>ScannedGenericBeanDefinition</code></strong> 由 <strong><code>MetadataReader</code></strong> 构建。</li></ol><p>判断是否为候选组件通过 <strong><code>ClassPathScanningCandidateComponentProvider#isCandidateComponent</code></strong> 方法。</p><h3 id=5-iscandidatecomponent方法解析>5. isCandidateComponent方法解析</h3><p><strong><code>isCandidateComponent</code></strong> 方法在 <strong><code>ClassPathScanningCandidateComponentProvider#isCandidateComponent</code></strong> 类中。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isCandidateComponent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MetadataReader</span> <span style=color:#000>metadataReader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#8f5902;font-style:italic>//省略部分代码
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TypeFilter</span> <span style=color:#000>tf</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>includeFilters</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//判断是否为@Component注解修饰
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tf</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>match</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadataReader</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getMetadataReaderFactory</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>isConditionMatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadataReader</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在 <strong><code>ClassPathScanningCandidateComponentProvider</code></strong> 初始化的时候回只设置了 <strong><code>@Component</code></strong> 注解。并没有看到 <strong><code>@Repository</code></strong> 、<strong><code>@Service</code></strong> 、 <strong><code>@Controller</code></strong> 这些。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//ClassPathScanningCandidateComponentProvider#registerDefaultFilters
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerDefaultFilters</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>includeFilters</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AnnotationTypeFilter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Component</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>));</span>
	<span style=color:#000>ClassLoader</span> <span style=color:#000>cl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ClassPathScanningCandidateComponentProvider</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>includeFilters</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AnnotationTypeFilter</span><span style=color:#ce5c00;font-weight:700>(</span>
				<span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Annotation</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#000>ClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;javax.annotation.ManagedBean&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cl</span><span style=color:#ce5c00;font-weight:700>)),</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>));</span>
		<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;JSR-250 &#39;javax.annotation.ManagedBean&#39; found and supported for component scanning&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassNotFoundException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>// JSR-250 1.1 API (as included in Java EE 6) not available - simply skip.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>includeFilters</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AnnotationTypeFilter</span><span style=color:#ce5c00;font-weight:700>(</span>
				<span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Annotation</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#000>ClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;javax.inject.Named&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cl</span><span style=color:#ce5c00;font-weight:700>)),</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>));</span>
		<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;JSR-330 &#39;javax.inject.Named&#39; annotation found and supported for component scanning&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassNotFoundException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>// JSR-330 API not available - simply skip.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>前面说过 <strong><code>@Repository</code></strong> 、<strong><code>@Service</code></strong> 、 <strong><code>@Controller</code></strong> 都是通过 <strong><code>@Component</code></strong> 派生来的。</p><h3 id=6-component派生过程解析>6. @Component派生过程解析</h3><p>在 <strong><code>ClassPathScanningCandidateComponentProvider#scanCandidateComponents</code></strong> 有这样一段代码</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>MetadataReader</span> <span style=color:#000>metadataReader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getMetadataReaderFactory</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getMetadataReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MetadataReaderFactory</span> <span style=color:#000>getMetadataReaderFactory</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>metadataReaderFactory</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>metadataReaderFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CachingMetadataReaderFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>metadataReaderFactory</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这一段代码主要是为了获取 <strong><code>MetadataReader</code></strong> 。该接口定义了获取当前类注解的元数据和当前类的元数据。在Spring框架中唯一的实现就是 <strong><code>SimpleMetadataReader</code></strong> 。下面来看一下 <strong><code>SimpleMetadataReader</code></strong> 类的构造函数：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>SimpleMetadataReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Resource</span> <span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>ClassLoader</span> <span style=color:#000>classLoader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#000>SimpleAnnotationMetadataReadingVisitor</span> <span style=color:#000>visitor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SimpleAnnotationMetadataReadingVisitor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>classLoader</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#000>getClassReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>accept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>visitor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>PARSING_OPTIONS</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>annotationMetadata</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>visitor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在构造函数中有两个类：</p><ul><li><p><strong>SimpleAnnotationMetadataReadingVisitor</strong></p><p>主要用于访问注解</p><p><img src="https://github.com/mxsm/picture/blob/main/spring/ClassVisitor.png?raw=true" alt></p></li><li><p><strong>ClassReader</strong></p><p>类读取器，基于ASM框架实现的。</p></li></ul><p>这里我们还可以看一下类的元数据类的继承关系：</p><p><img src="https://github.com/mxsm/picture/blob/main/spring/ClassMetadata.png?raw=true" alt></p><p>在 <strong>SimpleMetadataReader</strong> 类的构造函数中有这样一段代码 <strong>getClassReader(resource).accept(visitor, PARSING_OPTIONS);</strong> 主要是用来类上面的注解。包括注解上面的注解。</p><blockquote><p>getClassReader(resource).accept(visitor, PARSING_OPTIONS)这段代码就是实现了注解派生的关键</p></blockquote><h3 id=7-猜想验证>7. 猜想验证</h3><p>首先写一个Controller</p><p><img src="https://github.com/mxsm/picture/blob/main/spring/%E9%AA%8C%E8%AF%81%E7%8C%9C%E6%83%B31.png?raw=true" alt></p><p>然后在 IDEA设置条件断点：</p><p><img src="https://github.com/mxsm/picture/blob/main/spring/%E9%AA%8C%E8%AF%81%E7%8C%9C%E6%83%B32.png?raw=true" alt></p><p>看一下metadata变量：</p><p><img src="https://github.com/mxsm/picture/blob/main/spring/%E9%AA%8C%E8%AF%81%E7%8C%9C%E6%83%B33.png?raw=true" alt></p><p>然后看一下变量值annotations:</p><p><img src="https://github.com/mxsm/picture/blob/main/spring/%E9%AA%8C%E8%AF%81%E7%8C%9C%E6%83%B34.png?raw=true" alt></p><p>这里可以看出来已经读取到了 <strong><code>AsyncController</code></strong> 类上面的注解，然后在变量中有一个mappings的变量下面来看一下：</p><p><img src="https://github.com/mxsm/picture/blob/main/spring/%E9%AA%8C%E8%AF%81%E7%8C%9C%E6%83%B35.png?raw=true" alt></p><p>这个里面就包含了除了Java的注解以外的所有注解。（这里由于页面的关系不能完全展示）</p><h3 id=8-总结>8. 总结</h3><ul><li>@Component是spring注解的基础</li><li>ClassPathBeanDefinitionScanner扫描制定基础包下面的包含@Component注解</li><li>通过ClassReader（基于ASM实现）来读取类上面所有的注解。</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-ecd58b2fb8515423e24d130e8b86d39e>2.5 - Spring 注解解析顺序问题</h1><p>在之前的Spring相关文章当中分析过 <strong>BeanPostProcessor</strong> 接口执行顺序问题，今天突然想到在Spring框架中常用的注解也不少。那么注解的解析到底是一个什么样的先后顺序呢？今天就通过源码来分析总结一下Spring常用注解的解析顺序，注解使用的时候应该注意什么？</p><h3 id=1-spring-常用注解>1. Spring 常用注解</h3><p>这里我将Spring常用注解按照添加的位置分成了两类：</p><ul><li>添加在类上</li><li>添加在类的属性或者方法上面</li></ul><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/spring/Spring%E5%B8%B8%E7%94%A8%E6%B3%A8%E8%A7%A3-%E4%BF%AE%E9%A5%B0%E7%B1%BB.jpeg alt=Spring常用注解-修饰类></p><ul><li><p><strong>Bean创建相关的注解</strong></p><p>Bean创建，定义的核心注解就是 <strong><code>@Component</code></strong> 。而 <strong>@Service、@Repository、@Controller</strong> 三个只是 <strong>@Component</strong> 的不同语义下的延伸。本质上还是@Component。 <strong>@Bean</strong> 是配合 <strong>@Configuration</strong> 注解使用的另一类注解。功能和 <strong>@Component</strong> 相似但是对一下创建完全有开发者来创建。</p></li><li><p><strong>配置相关注解</strong></p><p><strong>@Configuration</strong> 毋庸置疑是除了 <strong>@Component</strong> 注解意外最重要的注解之一。原因是很多其他的注解都是依赖 <strong>@Configuration</strong> 注解才能发挥作用。例如上图标号3、4、5、6那些注解都是依赖了它才能发挥作用。修饰的类被当做配置类。</p></li><li><p><strong>属性相关注解</strong></p><p>将注解将properties配置文件中的值存储到Spring的 Environment中</p></li><li><p><strong>扫描相关注解</strong></p><p>根据配置的基础扫描包的路径扫描@Component注解类</p></li><li><p><strong>导入注解</strong></p><p>这个注解算是一个辅助注解，导入一些被@Configuration修饰或者实现了 ImportSelector, ImportBeanDefinitionRegistrar接口的类，或者被 @Component修饰的类。</p></li><li><p><strong>导入资源相关注解</strong></p><p>用于导入Spring的配置文件。</p></li></ul><h3 id=2-类修饰注解解析顺序分析>2. 类修饰注解解析顺序分析</h3><p>Spring注解应用上下文的入口为 <strong><code>AnnotationConfigApplicationContext</code></strong> ，用一段代码作为切入：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>ApplicationContext</span> <span style=color:#000>applicationContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AnnotationConfigApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;com.github.mxsm&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>根据这段代码来逐一分析这些注解的解析，以及解析的顺序。</p><h4 id=21-component注解解析>2.1 @Component注解解析</h4><p><strong>ClassPathBeanDefinitionScanner#scan</strong> 方法负责扫描基础包下面的带有 <strong>@Component</strong> 流程图如下：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/spring/%E6%B3%A8%E8%A7%A3Component%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B%E5%9B%BE.png alt=注解Component解析流程图></p><p>这里也通过设置 <strong>ClassPathBeanDefinitionScanner</strong> 的 includeFilters(TypeFilter) 和excludeFilters(TypeFilter)来判断哪些是Bean哪些需要排除。</p><h4 id=22-configuration注解解析>2.2 @Configuration注解解析</h4><p><strong>@Configuration</strong> 注解的解析主要由 <strong>ConfigurationClassPostProcessor</strong> 负责解析。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//ConfigurationClassPostProcessor#processConfigBeanDefinitions
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>processConfigBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionRegistry</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    
    	<span style=color:#8f5902;font-style:italic>//从Spring容器中获取包含了@Configuration注解的类
</span><span style=color:#8f5902;font-style:italic></span>       <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>candidateNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>BeanDefinition</span> <span style=color:#000>beanDef</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDef</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurationClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONFIGURATION_CLASS_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Bean definition has already been processed as a configuration class: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanDef</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurationClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>checkConfigurationClassCandidate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDef</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>metadataReaderFactory</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>configCandidates</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDef</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>));</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
    	
    	<span style=color:#8f5902;font-style:italic>//没有配置@Configuration的BeanDefinition直接返回不往下解析了
</span><span style=color:#8f5902;font-style:italic></span>       <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configCandidates</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
    
	<span style=color:#8f5902;font-style:italic>//省略了部分代码
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>ConfigurationClassParser</span> <span style=color:#000>parser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConfigurationClassParser</span><span style=color:#ce5c00;font-weight:700>(</span>
				<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>metadataReaderFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>problemReporter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>environment</span><span style=color:#ce5c00;font-weight:700>,</span>
				<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resourceLoader</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>componentScanBeanNameGenerator</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidates</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>validate</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从Spring容器中获取包含了@Configuration注解的类放在列表中。<strong><code>ConfigurationClassParser</code></strong> 负责后续的解析。</p><blockquote><p>Tips：如果包含了@Order注解，会对类进行排序</p></blockquote><p>解析完成@Configuration注解后，解析和@Configuration有依赖的注解。</p><blockquote><p>Tips: <strong>ConfigurationClassUtils.checkConfigurationClassCandidate</strong> 这段代码是检查 BeanDefinition是否包含了@Configuration注解，如果没有那么configCandidates就不会往里面放入BeanDefinition。同时configCandidates如果是空的那么也不需要进行后续解析。</p><p>也就是说：如果没有一个类配置了@Configuration注解，那么依赖@Configuration注解的@PropertySource、@ComponentScan、@Import、@ImportResource、@Bean注解都不会起作用也不被解析</p></blockquote><h4 id=23-其他注解解析>2.3 其他注解解析</h4><p>依赖@Configuration的其他注解都是由 <strong>ConfigurationClassParser#doProcessConfigurationClass</strong> 进行解析,通过代码发现解析的顺序：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//ConfigurationClassParser#doProcessConfigurationClass
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#5c35cc;font-weight:700>@Nullable</span>
<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SourceClass</span> <span style=color:#000>doProcessConfigurationClass</span><span style=color:#ce5c00;font-weight:700>(</span>
		<span style=color:#000>ConfigurationClass</span> <span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SourceClass</span> <span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Predicate</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>filter</span><span style=color:#ce5c00;font-weight:700>)</span>
		<span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#8f5902;font-style:italic>//省略部分代码
</span><span style=color:#8f5902;font-style:italic></span>
	<span style=color:#8f5902;font-style:italic>// Process any @PropertySource annotations (1)
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AnnotationAttributes</span> <span style=color:#000>propertySource</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>AnnotationConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>attributesForRepeatable</span><span style=color:#ce5c00;font-weight:700>(</span>
			<span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>PropertySources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span>
			<span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>springframework</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>annotation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PropertySource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>environment</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>ConfigurableEnvironment</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>processPropertySource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertySource</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#8f5902;font-style:italic>// Process any @ComponentScan annotations (2)
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>AnnotationAttributes</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>componentScans</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>AnnotationConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>attributesForRepeatable</span><span style=color:#ce5c00;font-weight:700>(</span>
			<span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>ComponentScans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ComponentScan</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>componentScans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
			<span style=color:#ce5c00;font-weight:700>!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>conditionEvaluator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shouldSkip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>ConfigurationPhase</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>REGISTER_BEAN</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AnnotationAttributes</span> <span style=color:#000>componentScan</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>componentScans</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>// The config class is annotated with @ComponentScan -&gt; perform the scan immediately
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>scannedBeanDefinitions</span> <span style=color:#ce5c00;font-weight:700>=</span>
					<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>componentScanParser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>componentScan</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getClassName</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#8f5902;font-style:italic>// Process any @Import annotations (3)
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>processImports</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getImports</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>filter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>

	<span style=color:#8f5902;font-style:italic>// Process any @ImportResource annotations (4)
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>AnnotationAttributes</span> <span style=color:#000>importResource</span> <span style=color:#ce5c00;font-weight:700>=</span>
			<span style=color:#000>AnnotationConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>attributesFor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>ImportResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>importResource</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>resources</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>importResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;locations&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BeanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>readerClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>importResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;reader&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>resources</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>String</span> <span style=color:#000>resolvedResource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>environment</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolveRequiredPlaceholders</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addImportedResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolvedResource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>readerClass</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#8f5902;font-style:italic>// Process individual @Bean methods (5)
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MethodMetadata</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>beanMethods</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>retrieveBeanMethodMetadata</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MethodMetadata</span> <span style=color:#000>methodMetadata</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>beanMethods</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addBeanMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methodMetadata</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>));</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#8f5902;font-style:italic>// Process default methods on interfaces
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>processInterfaces</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>);</span>

	<span style=color:#8f5902;font-style:italic>// No superclass -&gt; processing is complete
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面代码中的标号揭示了解析顺序：</p><p>（1）解析@PropertySource</p><p>（2）解析@ComponentScan</p><p>（3）解析@Import</p><p>（4）解析@ImportResource</p><p>（5）解析@Bean</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/spring/ConfigurationClassParser%E8%A7%A3%E6%9E%90%E6%B3%A8%E8%A7%A3%E7%9A%84%E9%A1%BA%E5%BA%8F.png alt=ConfigurationClassParser解析注解的顺序></p><p>在解析 @ComponentScan注解和@Import注解的时候如果扫描或者导入的类又存在@Configuration注解就会再一次重复执行@Configuration注解的解析流程。</p><p>通过上面分析可以总结出整体的一个解析顺序和流程如下图所示：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/spring/Spring%E5%B8%B8%E7%94%A8%E7%B1%BB%E6%B3%A8%E8%A7%A3%E7%9A%84%E8%A7%A3%E6%9E%90%E5%85%88%E5%90%8E%E9%A1%BA%E5%BA%8F.png alt=Spring常用类注解的解析先后顺序></p><h3 id=3-修饰属性或者方法注解解析顺序分析>3. 修饰属性或者方法注解解析顺序分析</h3><p>通过对Spring源码的分析可以知道处理 <strong><code>@Value</code></strong> 和 <strong><code>@Autowired</code></strong> 注解主要由 <strong><code>AutowiredAnnotationBeanPostProcessor</code></strong> 来实现。研究源码发现， <strong><code>@Value</code></strong> 和 <strong><code>@Autowired</code></strong> 注解都可以归结为一类注解：自动装配注解，只是 <strong><code>@Value</code></strong> 装配的是基本类型或者包装类型以及String类型的数据， 而 <strong><code>@Autowired</code></strong> 自动装配的是对象。</p><p>所以 <strong><code>@Value</code></strong> 和 <strong><code>@Autowired</code></strong> 没有严格意义上的前后顺序。</p><h3 id=4-总结>4. 总结</h3><ul><li><strong>Spring 中@Component注解是很多注解的元注解(定义的注解被@Component修饰)，例如@Service只是不同语义的定义而已，本质上都是@Component注解，包括@Configuration注解</strong></li><li><strong>@PropertySource、@ComponentScan、@Import、@ImportResource、@Bean单独是没办法使用，从上面的解析顺序分析可以得出结论，如果一个类上面配置了这五个注解但是没有配置@Configuration注解，这些注解都没办法起作用。要想起作用必须和@Configuration搭配使用。这个是最重要的一点</strong></li><li><strong>@ComponentScan会重新执行ClassPathBeanDefinitionScanner#scan扫描，会在走一遍解析的流程</strong></li><li><strong>@Import如果导入了包含@Configuration注解的类也同样会走一遍@Configuration的解析流程</strong></li></ul><p><strong>在注解使用的时候注意有依赖关系的需要搭配使用单独使用会没有效果。</strong></p></div><div class=td-content style=page-break-before:always><h1 id=pg-b67a84fc05c6c115957264660090c5e5>3 - Spring framework Web</h1></div><div class=td-content><h1 id=pg-3e5a172ebf59caee94c0ec24b4cd505c>3.1 - 深入了解WebApplicationInitializer是消除web.xml和springMVC的配置文件</h1><h3 id=1-servlet3x规范一些知识>1. Servlet3.x规范一些知识</h3><h4 id=11-java-servlet3x的相关规范>1.1 java Servlet3.x的相关规范</h4><p>可以参看：<a href=https://github.com/mxsm/document/blob/master/Spring/Springframework/Spring-web%E5%88%86%E6%9E%90/Servlet3.1.md>Servlet相关笔记</a><br>在Servlet的规范中有两种方式来实现 <em><strong>ServletContext</strong></em> 的初始化，通过XML的配置文件或者通过编程的方式来进行初始化。<br>注解和XML都是可拔插的组件，通过不同的方式来实现不同需求，</p><blockquote><p>ServletContainerInitializer 类通过 jar services API 查找。对于每一个应用，应用启动时，由容器创建一个ServletContainerInitializer 实例。 框架提供的 ServletContainerInitializer 实现必须绑定在 jar 包 的
META-INF/services 目录中的一个叫做 javax.servlet.ServletContainerInitializer 的文件，根据 jar services API，指定 ServletContainerInitializer 的实现。除 ServletContainerInitializer 外，我们还有一个注解—HandlesTypes。在 ServletContainerInitializer 实现上的
HandlesTypes 注解用于表示感兴趣的一些类，它们可能指定了 HandlesTypes 的 value 中的注解（类型、方法或自动级别的注解），或者是其类型的超类继承/实现了这些类之一。无论是否设置了 metadata-complete，HandlesTypes 注解将应用。当检测一个应用的类看是否它们匹配 ServletContainerInitializer 的 HandlesTypes 指定的条件时，如果应用的一个或多个可选的 JAR 包缺失，容器可能遇到类装载问题。由于容器不能决定是否这些类型的类装载失败
将阻止应用正常工作，它必须忽略它们，同时也提供一个将记录它们的配置选项。
如果 ServletContainerInitializer 实现没有@HandlesTypes注解，或如果没有匹配任何指定的 HandlesType，那
么它会为每个应用使用 null 值的集合调用一次。这将允许 initializer 基于应用中可用的资源决定是否需要初始化 Servlet/Filter。在任何 Servlet Listener 的事件被触发之前，当应用正在启动时，ServletContainerInitializer 的 onStartup 方法将被调用。ServletContainerInitializer’s 的 onStartup 得到一个类的Set，其或者继承/实现 initializer 表示感兴趣的类，或者它是使用指定在@HandlesTypes 注解中的任意类注解的。</p></blockquote><h3 id=2-springservletcontainerinitializer介绍>2. SpringServletContainerInitializer介绍</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@HandlesTypes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>WebApplicationInitializer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SpringServletContainerInitializer</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>ServletContainerInitializer</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>onStartup</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>webAppInitializerClasses</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ServletContext</span> <span style=color:#000>servletContext</span><span style=color:#ce5c00;font-weight:700>)</span>
			<span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>ServletException</span> <span style=color:#ce5c00;font-weight:700>{</span>

		<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>WebApplicationInitializer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>initializers</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>

		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>webAppInitializerClasses</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>waiClass</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>webAppInitializerClasses</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#8f5902;font-style:italic>// Be defensive: Some servlet containers provide us with invalid classes,
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#8f5902;font-style:italic>// no matter what @HandlesTypes says...
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>waiClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInterface</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>Modifier</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAbstract</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>waiClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getModifiers</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
						<span style=color:#000>WebApplicationInitializer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAssignableFrom</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>waiClass</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#000>initializers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>WebApplicationInitializer</span><span style=color:#ce5c00;font-weight:700>)</span>
								<span style=color:#000>ReflectionUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>accessibleConstructor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>waiClass</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>());</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ServletException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Failed to instantiate WebApplicationInitializer class&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>initializers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>//打印日志
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

	    <span style=color:#8f5902;font-style:italic>//打印日志
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>AnnotationAwareOrderComparator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sort</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>initializers</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>WebApplicationInitializer</span> <span style=color:#000>initializer</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>initializers</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		    <span style=color:#8f5902;font-style:italic>//调用WebApplicationInitializer的方法onStartup
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>initializer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>onStartup</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>servletContext</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><em><strong>SpringServletContainerInitializer</strong></em> 继承了 <em><strong>ServletContainerInitializer</strong></em> 在对应的jar包下面的 <em><strong>META-INF.services</strong></em> 下面有一个文件 <em><strong>javax.servlet.ServletContainerInitializer</strong></em> 内容如下：</p><blockquote><p>org.springframework.web.SpringServletContainerInitializer</p></blockquote><p>通过SPI就能加载 <em><strong>SpringServletContainerInitializer</strong></em> 类，然后通过定义在上面的 <em><strong>@HandlesTypes</strong></em> 注解。根据配置的类 <em><strong>WebApplicationInitializer</strong></em> 来加载。通过 <em><strong>WebApplicationInitializer</strong></em> 来把Servlet和Spring结合起来。</p><h3 id=3-webapplicationinitializer介绍>3. WebApplicationInitializer介绍</h3><p><img src="https://github.com/mxsm/document/blob/master/image/Spring/Springframework/WebApplicationInitializer.png?raw=true" alt=继承关系></p><p>从上面可以看出来 <em><strong><code>WebApplicationInitializer</code></strong></em> 有三个继承实现类，三个抽象的类单一继承。下面分析一下下面的几个初始化类：</p><ul><li><p><strong>WebApplicationInitializer</strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>WebApplicationInitializer</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#8f5902;font-style:italic>//启动方法
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>onStartup</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ServletContext</span> <span style=color:#000>servletContext</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>ServletException</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在 <em><strong>WebApplicationInitializer</strong></em> 中只有一个方法，在 <em><strong>SpringServletContainerInitializer</strong></em> 类中调用了这个 <strong><code>onStartup</code></strong> 方法。</p></li><li><p><strong>AbstractContextLoaderInitializer</strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AbstractContextLoaderInitializer</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>WebApplicationInitializer</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#8f5902;font-style:italic>/** Logger available to subclasses. */</span>
	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Log</span> <span style=color:#000>logger</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>LogFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getClass</span><span style=color:#ce5c00;font-weight:700>());</span>


	<span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>onStartup</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ServletContext</span> <span style=color:#000>servletContext</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>ServletException</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>registerContextLoaderListener</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>servletContext</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>//添加ContextLoaderListener到ServletContext
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerContextLoaderListener</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ServletContext</span> <span style=color:#000>servletContext</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>WebApplicationContext</span> <span style=color:#000>rootAppContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createRootApplicationContext</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rootAppContext</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>ContextLoaderListener</span> <span style=color:#000>listener</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ContextLoaderListener</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rootAppContext</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>listener</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setContextInitializers</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getRootApplicationContextInitializers</span><span style=color:#ce5c00;font-weight:700>());</span>
          <span style=color:#000>servletContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addListener</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>listener</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>//打印日志
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#8f5902;font-style:italic>//创建Spring的WebApplicationContext
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#000>WebApplicationContext</span> <span style=color:#000>createRootApplicationContext</span><span style=color:#ce5c00;font-weight:700>();</span>


	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>ApplicationContextInitializer</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>getRootApplicationContextInitializers</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li><li><p><strong>AbstractDispatcherServletInitializer</strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AbstractDispatcherServletInitializer</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractContextLoaderInitializer</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#8f5902;font-style:italic>//默认的Servlet名称
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>DEFAULT_SERVLET_NAME</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;dispatcher&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>


	<span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>onStartup</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ServletContext</span> <span style=color:#000>servletContext</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>ServletException</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>onStartup</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>servletContext</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>//注册DispatcherServlet
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>registerDispatcherServlet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>servletContext</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#8f5902;font-style:italic>//注册注册DispatcherServlet的方法
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerDispatcherServlet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ServletContext</span> <span style=color:#000>servletContext</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>String</span> <span style=color:#000>servletName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getServletName</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasLength</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>servletName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;getServletName() must not return null or empty&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>//抽象方法createServletApplicationContext由使用者自己实现
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>WebApplicationContext</span> <span style=color:#000>servletAppContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createServletApplicationContext</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>servletAppContext</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;createServletApplicationContext() must not return null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

      <span style=color:#000>FrameworkServlet</span> <span style=color:#000>dispatcherServlet</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createDispatcherServlet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>servletAppContext</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dispatcherServlet</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;createDispatcherServlet(WebApplicationContext) must not return null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>dispatcherServlet</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setContextInitializers</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getServletApplicationContextInitializers</span><span style=color:#ce5c00;font-weight:700>());</span>

      <span style=color:#000>ServletRegistration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Dynamic</span> <span style=color:#000>registration</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>servletContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addServlet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>servletName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>dispatcherServlet</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registration</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Failed to register servlet with name &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>servletName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;. &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                  <span style=color:#4e9a06>&#34;Check if there is another servlet registered under the same name.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>

      <span style=color:#000>registration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setLoadOnStartup</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>registration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getServletMappings</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#000>registration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAsyncSupported</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isAsyncSupported</span><span style=color:#ce5c00;font-weight:700>());</span>

      <span style=color:#000>Filter</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>filters</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getServletFilters</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>ObjectUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>filters</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Filter</span> <span style=color:#000>filter</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>filters</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#000>registerServletFilter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>servletContext</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>filter</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>

      <span style=color:#000>customizeRegistration</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registration</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * Return the name under which the {@link DispatcherServlet} will be registered.
</span><span style=color:#8f5902;font-style:italic>   * Defaults to {@link #DEFAULT_SERVLET_NAME}.
</span><span style=color:#8f5902;font-style:italic>   * @see #registerDispatcherServlet(ServletContext)
</span><span style=color:#8f5902;font-style:italic>   */</span>
	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>String</span> <span style=color:#000>getServletName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>DEFAULT_SERVLET_NAME</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * Create a servlet application context to be provided to the {@code DispatcherServlet}.
</span><span style=color:#8f5902;font-style:italic>   * &lt;p&gt;The returned context is delegated to Spring&#39;s
</span><span style=color:#8f5902;font-style:italic>   * {@link DispatcherServlet#DispatcherServlet(WebApplicationContext)}. As such,
</span><span style=color:#8f5902;font-style:italic>   * it typically contains controllers, view resolvers, locale resolvers, and other
</span><span style=color:#8f5902;font-style:italic>   * web-related beans.
</span><span style=color:#8f5902;font-style:italic>   * @see #registerDispatcherServlet(ServletContext)
</span><span style=color:#8f5902;font-style:italic>   */</span>
	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#000>WebApplicationContext</span> <span style=color:#000>createServletApplicationContext</span><span style=color:#ce5c00;font-weight:700>();</span>

	<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * Create a {@link DispatcherServlet} (or other kind of {@link FrameworkServlet}-derived
</span><span style=color:#8f5902;font-style:italic>   * dispatcher) with the specified {@link WebApplicationContext}.
</span><span style=color:#8f5902;font-style:italic>   * &lt;p&gt;Note: This allows for any {@link FrameworkServlet} subclass as of 4.2.3.
</span><span style=color:#8f5902;font-style:italic>   * Previously, it insisted on returning a {@link DispatcherServlet} or subclass thereof.
</span><span style=color:#8f5902;font-style:italic>   */</span>
	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>FrameworkServlet</span> <span style=color:#000>createDispatcherServlet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>WebApplicationContext</span> <span style=color:#000>servletAppContext</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DispatcherServlet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>servletAppContext</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * Specify application context initializers to be applied to the servlet-specific
</span><span style=color:#8f5902;font-style:italic>   * application context that the {@code DispatcherServlet} is being created with.
</span><span style=color:#8f5902;font-style:italic>   * @since 4.2
</span><span style=color:#8f5902;font-style:italic>   * @see #createServletApplicationContext()
</span><span style=color:#8f5902;font-style:italic>   * @see DispatcherServlet#setContextInitializers
</span><span style=color:#8f5902;font-style:italic>   * @see #getRootApplicationContextInitializers()
</span><span style=color:#8f5902;font-style:italic>   */</span>
	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>ApplicationContextInitializer</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>getServletApplicationContextInitializers</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * Specify the servlet mapping(s) for the {@code DispatcherServlet} &amp;mdash;
</span><span style=color:#8f5902;font-style:italic>   * for example {@code &#34;/&#34;}, {@code &#34;/app&#34;}, etc.
</span><span style=color:#8f5902;font-style:italic>   * @see #registerDispatcherServlet(ServletContext)
</span><span style=color:#8f5902;font-style:italic>   */</span>
	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>getServletMappings</span><span style=color:#ce5c00;font-weight:700>();</span>

	<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * Specify filters to add and map to the {@code DispatcherServlet}.
</span><span style=color:#8f5902;font-style:italic>   * @return an array of filters or {@code null}
</span><span style=color:#8f5902;font-style:italic>   * @see #registerServletFilter(ServletContext, Filter)
</span><span style=color:#8f5902;font-style:italic>   */</span>
	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Filter</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>getServletFilters</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * Add the given filter to the ServletContext and map it to the
</span><span style=color:#8f5902;font-style:italic>   * {@code DispatcherServlet} as follows:
</span><span style=color:#8f5902;font-style:italic>   * &lt;ul&gt;
</span><span style=color:#8f5902;font-style:italic>   * &lt;li&gt;a default filter name is chosen based on its concrete type
</span><span style=color:#8f5902;font-style:italic>   * &lt;li&gt;the {@code asyncSupported} flag is set depending on the
</span><span style=color:#8f5902;font-style:italic>   * return value of {@link #isAsyncSupported() asyncSupported}
</span><span style=color:#8f5902;font-style:italic>   * &lt;li&gt;a filter mapping is created with dispatcher types {@code REQUEST},
</span><span style=color:#8f5902;font-style:italic>   * {@code FORWARD}, {@code INCLUDE}, and conditionally {@code ASYNC} depending
</span><span style=color:#8f5902;font-style:italic>   * on the return value of {@link #isAsyncSupported() asyncSupported}
</span><span style=color:#8f5902;font-style:italic>   * &lt;/ul&gt;
</span><span style=color:#8f5902;font-style:italic>   * &lt;p&gt;If the above defaults are not suitable or insufficient, override this
</span><span style=color:#8f5902;font-style:italic>   * method and register filters directly with the {@code ServletContext}.
</span><span style=color:#8f5902;font-style:italic>   * @param servletContext the servlet context to register filters with
</span><span style=color:#8f5902;font-style:italic>   * @param filter the filter to be registered
</span><span style=color:#8f5902;font-style:italic>   * @return the filter registration
</span><span style=color:#8f5902;font-style:italic>   */</span>
	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>FilterRegistration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Dynamic</span> <span style=color:#000>registerServletFilter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ServletContext</span> <span style=color:#000>servletContext</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Filter</span> <span style=color:#000>filter</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>String</span> <span style=color:#000>filterName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Conventions</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getVariableName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>filter</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>Dynamic</span> <span style=color:#000>registration</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>servletContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addFilter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>filterName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>filter</span><span style=color:#ce5c00;font-weight:700>);</span>

      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registration</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>counter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
          <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registration</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>counter</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>100</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                  <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Failed to register filter with name &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>filterName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;. &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                          <span style=color:#4e9a06>&#34;Check if there is another filter registered under the same name.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
              <span style=color:#ce5c00;font-weight:700>}</span>
              <span style=color:#000>registration</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>servletContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addFilter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>filterName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;#&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>counter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>filter</span><span style=color:#ce5c00;font-weight:700>);</span>
              <span style=color:#000>counter</span><span style=color:#ce5c00;font-weight:700>++;</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>

      <span style=color:#000>registration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAsyncSupported</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isAsyncSupported</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#000>registration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addMappingForServletNames</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getDispatcherTypes</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getServletName</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>registration</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>EnumSet</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>DispatcherType</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getDispatcherTypes</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isAsyncSupported</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>?</span>
              <span style=color:#000>EnumSet</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>of</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DispatcherType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>REQUEST</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>DispatcherType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>FORWARD</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>DispatcherType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>INCLUDE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>DispatcherType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ASYNC</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span>
              <span style=color:#000>EnumSet</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>of</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DispatcherType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>REQUEST</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>DispatcherType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>FORWARD</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>DispatcherType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>INCLUDE</span><span style=color:#ce5c00;font-weight:700>));</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * A single place to control the {@code asyncSupported} flag for the
</span><span style=color:#8f5902;font-style:italic>   * {@code DispatcherServlet} and all filters added via {@link #getServletFilters()}.
</span><span style=color:#8f5902;font-style:italic>   * &lt;p&gt;The default value is &#34;true&#34;.
</span><span style=color:#8f5902;font-style:italic>   */</span>
	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isAsyncSupported</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * Optionally perform further registration customization once
</span><span style=color:#8f5902;font-style:italic>   * {@link #registerDispatcherServlet(ServletContext)} has completed.
</span><span style=color:#8f5902;font-style:italic>   * @param registration the {@code DispatcherServlet} registration to be customized
</span><span style=color:#8f5902;font-style:italic>   * @see #registerDispatcherServlet(ServletContext)
</span><span style=color:#8f5902;font-style:italic>   */</span>
	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>customizeRegistration</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ServletRegistration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Dynamic</span> <span style=color:#000>registration</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li><li><p><strong>AbstractAnnotationConfigDispatcherServletInitializer</strong></p></li></ul><h3 id=4-springwebapplicationinitializer消除配置文件源码分析>4. Spring+WebApplicationInitializer消除配置文件源码分析</h3><h3 id=5-spring的例子>5. Spring的例子</h3></div><div class=td-content style=page-break-before:always><h1 id=pg-159c8af60548b430c8c80fb041539a9c>3.2 - Spring Web Context</h1><h3 id=1-spring-web-contexts>1. Spring Web Contexts</h3><p>当我们在Web项目中使用Spring的时候我们有几种方式去组织application contexts，接下来我们将分析大部分的提供。</p><h3 id=2-root-web-application-context>2. Root Web Application Context</h3><p>每一个Spring webapp有一个与他生命周期相关联的application context: root web application context</p><p>这个上下文随着应用的启动而启动，随着引用的销毁而销毁，这个由servlet context listener来实现。这个上下文在web Application中总是一个 <em>WebApplicationContext</em> 实例。这个接口继承了 <em>ApplicationContext</em> 同时能够访问到 <em>ServletContext</em> 。</p><h4 id=21-contextloaderlistener>2.1 <em>ContextLoaderListener</em></h4><p>web应用程序是由一个监听器 <em>org.springframework.web.context.ContextLoaderListener</em> 来管理。这个监听器是Spring模块中的一部分， <strong>默认情况下加载XML application context 从/WEB-INF/applicationContext.xml.</strong> 然而这种默认情况是可用改变的。</p><h4 id=22-使用-webxml-和-xml-application-context>2.2 使用 web.xml 和 XML Application Context</h4><p>web.xml</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;listener&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;listener-class&gt;</span>
        org.springframework.web.context.ContextLoaderListener
    <span style=color:#204a87;font-weight:700>&lt;/listener-class&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/listener&gt;</span>
</code></pre></div><p>我们可以使用contextConfigLocation参数指定XML上下文配置的另一个位置:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;context-param&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;param-name&gt;</span>contextConfigLocation<span style=color:#204a87;font-weight:700>&lt;/param-name&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;param-value&gt;</span>/WEB-INF/rootApplicationContext.xml<span style=color:#204a87;font-weight:700>&lt;/param-value&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/context-param&gt;</span>
</code></pre></div><p>多个的情况：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;context-param&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;param-name&gt;</span>contextConfigLocation<span style=color:#204a87;font-weight:700>&lt;/param-name&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;param-value&gt;</span>/WEB-INF/context1.xml, /WEB-INF/context2.xml<span style=color:#204a87;font-weight:700>&lt;/param-value&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/context-param&gt;</span>
</code></pre></div><p>或者使用通配符：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;context-param&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;param-name&gt;</span>contextConfigLocation<span style=color:#204a87;font-weight:700>&lt;/param-name&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;param-value&gt;</span>/WEB-INF/*-context.xml<span style=color:#204a87;font-weight:700>&lt;/param-value&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/context-param&gt;</span>
</code></pre></div><h4 id=23-webxml-和-java-application-context>2.3 web.xml 和 Java Application Context</h4><p>除了默认XmlWebApplicationContext,看如何使用注解：</p><p>我们使用 <em>contextClass</em> 参数来告诉监听器使用那种类型的context实例：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;context-param&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;param-name&gt;</span>contextClass<span style=color:#204a87;font-weight:700>&lt;/param-name&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;param-value&gt;</span>
        org.springframework.web.context.support.AnnotationConfigWebApplicationContext
    <span style=color:#204a87;font-weight:700>&lt;/param-value&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/context-param&gt;</span>
</code></pre></div><p>由于 <em>AnnotationConfigWebApplicationContext</em> 没有默认的配置所以我们必须提供一个：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;context-param&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;param-name&gt;</span>contextConfigLocation<span style=color:#204a87;font-weight:700>&lt;/param-name&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;param-value&gt;</span>
        com.baeldung.contexts.config.RootApplicationConfig,
        com.baeldung.contexts.config.NormalWebAppConfig
    <span style=color:#204a87;font-weight:700>&lt;/param-value&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/context-param&gt;</span>
</code></pre></div><p>或者我们告诉Context去扫描一个或者多个package</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;context-param&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;param-name&gt;</span>contextConfigLocation<span style=color:#204a87;font-weight:700>&lt;/param-name&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;param-value&gt;</span>org.baeldung.bean.config<span style=color:#204a87;font-weight:700>&lt;/param-value&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/context-param&gt;</span>
</code></pre></div><h4 id=24-servlet3x-可编程配置>2.4 Servlet3.X 可编程配置</h4><p>Servlet3.X的配置文件web.xml是可选的。此外，用户还可以访问一个API，该API允许以编程方式定义基于servlet的应用程序的每个元素spring-web模块利用这些特性，并在应用程序启动时提供API来注册应用程序的组件。Spring扫描应用程序的类路径寻找 <em>org.springframework.web.WebApplicationInitializer</em> 类的实例。通过执行 <em>void onStartup(ServletContext servletContext) throws ServletException</em> 方法来调用application启动。</p><h4 id=25-servlet-3x-和-xml-application-context>2.5 Servlet 3.x 和 XML Application Context</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ApplicationInitializer</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>WebApplicationInitializer</span> <span style=color:#ce5c00;font-weight:700>{</span>
     
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>onStartup</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ServletContext</span> <span style=color:#000>servletContext</span><span style=color:#ce5c00;font-weight:700>)</span> 
      <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>ServletException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//...
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>只需要实现 <em>WebApplicationInitializer</em> 接口；</p><p>首先我们来创建一个root context,第一行是我们前面遇到的contextClass参数的显式版本，我们使用它来决定使用哪个特定的上下文实现:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-reStructuredText data-lang=reStructuredText>XmlWebApplicationContext rootContext = new XmlWebApplicationContext();<span style=color:#a40000>
</span></code></pre></div><p>接下来是参数 <em>contextConfigLocation</em> 定义加载bean定义：</p><pre><code>rootContext.setConfigLocations(&quot;/WEB-INF/rootApplicationContext.xml&quot;);
</code></pre><p>接下来是为ServletContext添加监听器</p><pre><code>servletContext.addListener(new ContextLoaderListener(rootContext));
</code></pre><h4 id=26-servlet-3x-和-java-application-context>2.6 Servlet 3.x 和 Java Application Context</h4><p>使用 <em>AnnotationConfigWebApplicationContext</em></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AnnotationsBasedApplicationInitializer</span> 
  <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractContextLoaderInitializer</span> <span style=color:#ce5c00;font-weight:700>{</span>
  
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>WebApplicationContext</span> <span style=color:#000>createRootApplicationContext</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>AnnotationConfigWebApplicationContext</span> <span style=color:#000>rootContext</span>
          <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AnnotationConfigWebApplicationContext</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>rootContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>register</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RootApplicationConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>rootContext</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在这里，我们可以看到我们不再需要注册ContextLoaderListener,还要注意register方法的使用，它是特定于AnnotationConfigWebApplicationContext的，而不是更通用的setConfigLocations:通过调用它，我们可以用上下文注册单个@Configuration注释的类，从而避免了包扫描。</p><h3 id=3-dispatcher-servlet-contexts>3. Dispatcher Servlet Contexts</h3><p><strong>Spring MVC applications有至少一个Dispatcher Servlet 配置</strong> 这个Servlet处理接受请求，分发给适当的控制器方法然后返回对应的视图。</p><p>每一个 <strong>DispatcherServlet</strong> 有关联的application context. 在这样的上下文中定义的bean配置servlet并定义MVC对象，如控制器和视图解析器。</p><h4 id=31-webxml-和-xml-application-context>3.1 web.xml 和 XML Application Context</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;servlet&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;servlet-name&gt;</span>normal-webapp<span style=color:#204a87;font-weight:700>&lt;/servlet-name&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;servlet-class&gt;</span>
        org.springframework.web.servlet.DispatcherServlet
    <span style=color:#204a87;font-weight:700>&lt;/servlet-class&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;load-on-startup&gt;</span>1<span style=color:#204a87;font-weight:700>&lt;/load-on-startup&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/servlet&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;servlet-mapping&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;servlet-name&gt;</span>normal-webapp<span style=color:#204a87;font-weight:700>&lt;/servlet-name&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;url-pattern&gt;</span>/api/*<span style=color:#204a87;font-weight:700>&lt;/url-pattern&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/servlet-mapping&gt;</span>
</code></pre></div><p>如果没有另外指定，servlet的名称将用于确定要加载的XML文件,在例子中我们将使用 <em>WEB-INF/normal-webapp-servlet.xml</em>. 配置文件。</p><p>我们也可指定配置文件：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;servlet&gt;</span>
    ...
    <span style=color:#204a87;font-weight:700>&lt;init-param&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;param-name&gt;</span>contextConfigLocation<span style=color:#204a87;font-weight:700>&lt;/param-name&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;param-value&gt;</span>/WEB-INF/normal/*.xml<span style=color:#204a87;font-weight:700>&lt;/param-value&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/init-param&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/servlet&gt;</span>
</code></pre></div><h4 id=32-webxml-和-java-application-context>3.2 web.xml 和 Java Application Context</h4><p>当我们想要使用另一种类型的上下文时，我们继续使用ContextLoaderListener。也就是说，我们指定了一个contextClass参数和一个合适的contextConfigLocation:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;servlet&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;servlet-name&gt;</span>normal-webapp-annotations<span style=color:#204a87;font-weight:700>&lt;/servlet-name&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;servlet-class&gt;</span>
        org.springframework.web.servlet.DispatcherServlet
    <span style=color:#204a87;font-weight:700>&lt;/servlet-class&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;init-param&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;param-name&gt;</span>contextClass<span style=color:#204a87;font-weight:700>&lt;/param-name&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;param-value&gt;</span>
            org.springframework.web.context.support.AnnotationConfigWebApplicationContext
        <span style=color:#204a87;font-weight:700>&lt;/param-value&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/init-param&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;init-param&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;param-name&gt;</span>contextConfigLocation<span style=color:#204a87;font-weight:700>&lt;/param-name&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;param-value&gt;</span>com.baeldung.contexts.config.NormalWebAppConfig<span style=color:#204a87;font-weight:700>&lt;/param-value&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/init-param&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;load-on-startup&gt;</span>1<span style=color:#204a87;font-weight:700>&lt;/load-on-startup&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/servlet&gt;</span>
</code></pre></div><h4 id=33-servlet-3x-和-xml-application-context>3.3 Servlet 3.x 和 XML Application Context</h4><p>创建一个WebApplicationInitializer和一个XML的applications context,去实现onStartup方法</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>XmlWebApplicationContext</span> <span style=color:#000>normalWebAppContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>XmlWebApplicationContext</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#000>normalWebAppContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setConfigLocation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/WEB-INF/normal-webapp-servlet.xml&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>ServletRegistration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Dynamic</span> <span style=color:#000>normal</span><span style=color:#ce5c00;font-weight:700>/=</span> <span style=color:#000>servletContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addServlet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;normal-webapp&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DispatcherServlet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>normalWebAppContext</span><span style=color:#ce5c00;font-weight:700>));</span>
<span style=color:#000>normal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setLoadOnStartup</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>normal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/api/*&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><h4 id=34-servlet-3x-和-java-application-context>3.4 Servlet 3.x 和 Java Application Context</h4><p>这一次我们配置一个注解上下文实现WebApplicationInitializer: AbstractDispatcherServletInitializer。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>WebApplicationContext</span> <span style=color:#000>createServletApplicationContext</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
  
    <span style=color:#000>AnnotationConfigWebApplicationContext</span> <span style=color:#000>secureWebAppContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AnnotationConfigWebApplicationContext</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>secureWebAppContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>register</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SecureWebAppConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>secureWebAppContext</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
 
<span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>getServletMappings</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#4e9a06>&#34;/s/api/*&#34;</span> <span style=color:#ce5c00;font-weight:700>};</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><a href=https://www.baeldung.com/spring-web-contexts>https://www.baeldung.com/spring-web-contexts</a></p><p><a href=https://www.nonelonely.com/article/1552475062917>https://www.nonelonely.com/article/1552475062917</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-2387078ff36b1ea96419cd7e49b5213c>3.3 - ContextLoaderListener 源码分析</h1><h3 id=1-contextloaderlistener类>1. ContextLoaderListener类</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ContextLoaderListener</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ContextLoader</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>ServletContextListener</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//....... 省略代码
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>contextInitialized</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ServletContextEvent</span> <span style=color:#000>event</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>initWebApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>event</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getServletContext</span><span style=color:#ce5c00;font-weight:700>());</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>继承了 <em>ContextLoader</em> (Spring的类)，实现了 <em><strong>ServletContextListener</strong></em> 接口(Servlet3.1的监听接口)。<br>通过调用 <em>contextInitialized</em> 方法来初始化Spring上下文</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>WebApplicationContext</span> <span style=color:#000>initWebApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ServletContext</span> <span style=color:#000>servletContext</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>servletContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>WebApplicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		  <span style=color:#8f5902;font-style:italic>//抛异常
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#000>servletContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>log</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Initializing Spring root WebApplicationContext&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>Log</span> <span style=color:#000>logger</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>LogFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ContextLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInfoEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Root WebApplicationContext: initialization started&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>startTime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>//判断上下文是否为空
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>context</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			   <span style=color:#8f5902;font-style:italic>//创建Spring上下文
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>context</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createWebApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>servletContext</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>context</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>ConfigurableWebApplicationContext</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>ConfigurableWebApplicationContext</span> <span style=color:#000>cwac</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurableWebApplicationContext</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>context</span><span style=color:#ce5c00;font-weight:700>;</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>cwac</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isActive</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#8f5902;font-style:italic>// The context has not yet been refreshed -&gt; provide services such as
</span><span style=color:#8f5902;font-style:italic></span>					<span style=color:#8f5902;font-style:italic>// setting the parent context, setting the application context id, etc
</span><span style=color:#8f5902;font-style:italic></span>					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cwac</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParent</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#8f5902;font-style:italic>// The context instance was injected without an explicit parent -&gt;
</span><span style=color:#8f5902;font-style:italic></span>						<span style=color:#8f5902;font-style:italic>// determine parent for root web application context, if any.
</span><span style=color:#8f5902;font-style:italic></span>						<span style=color:#000>ApplicationContext</span> <span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>loadParentContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>servletContext</span><span style=color:#ce5c00;font-weight:700>);</span>
						<span style=color:#000>cwac</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setParent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#000>configureAndRefreshWebApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cwac</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>servletContext</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#8f5902;font-style:italic>//把上下文设置到servlet上下文中
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>servletContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>WebApplicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>context</span><span style=color:#ce5c00;font-weight:700>);</span>

			<span style=color:#000>ClassLoader</span> <span style=color:#000>ccl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getContextClassLoader</span><span style=color:#ce5c00;font-weight:700>();</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ccl</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>ContextLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>currentContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>context</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ccl</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>currentContextPerThread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ccl</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>

			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInfoEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>elapsedTime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>startTime</span><span style=color:#ce5c00;font-weight:700>;</span>
				<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Root WebApplicationContext initialized in &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>elapsedTime</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; ms&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>

			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>context</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RuntimeException</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>Error</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Context initialization failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>servletContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>WebApplicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过createWebApplicationContext(servletContext)方法来创建WebApplicationContext：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>WebApplicationContext</span> <span style=color:#000>createWebApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ServletContext</span> <span style=color:#000>sc</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//加载对应的类
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>contextClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>determineContextClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sc</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>ConfigurableWebApplicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAssignableFrom</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>contextClass</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
		    <span style=color:#8f5902;font-style:italic>//抛异常
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#8f5902;font-style:italic>//实例化对象
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurableWebApplicationContext</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>BeanUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instantiateClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>contextClass</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>determineContextClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ServletContext</span> <span style=color:#000>servletContext</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//获取 servletContext 中的 contextClass 参数值
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>String</span> <span style=color:#000>contextClassName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>servletContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInitParameter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CONTEXT_CLASS_PARAM</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#8f5902;font-style:italic>//如果没有设置contextClass值
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>contextClassName</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>ClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>contextClassName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDefaultClassLoader</span><span style=color:#ce5c00;font-weight:700>());</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassNotFoundException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#8f5902;font-style:italic>//没有找到抛异常
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
		    <span style=color:#8f5902;font-style:italic>//默认加载的是XmlWebApplicationContext--配置在ContextLoader.properties文件中
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>contextClassName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>defaultStrategies</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>WebApplicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>
			<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>ClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>contextClassName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ContextLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>());</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassNotFoundException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			  	<span style=color:#8f5902;font-style:italic>//没有找到抛异常
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过上面的分析看出以及结合之前的 <a href=https://github.com/mxsm/document/blob/master/Spring/Springframework/Spring-web%E5%88%86%E6%9E%90/Spring%20Web%20Context.md>Spring Web Contexts</a> 的文章讲的如何配置不同的Spirng Context。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-5bf9830d34c6f98ad218f7463014dc07>3.4 - DispatcherServlet源码解析</h1><h3 id=1-dispatcherservlet是什么>1. DispatcherServlet是什么？</h3><p>从本质上是说DispatcherServlet就是一个Servlet规范的实现。也就是一个Servlet！</p><h3 id=2-dispatcherservlet在spring中的继承关系>2. DispatcherServlet在Spring中的继承关系</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DispatcherServlet</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>FrameworkServlet</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//省略代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>FrameworkServlet</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>HttpServletBean</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>ApplicationContextAware</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//省略代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>HttpServletBean</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>HttpServlet</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>EnvironmentCapable</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>EnvironmentAware</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//省略代码    
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div><p>从上面的关系可以看出来 <em>HttpServletBean</em> 继承了Servlet API的 <em>HttpServlet</em> ，然后 <em>FrameworkServlet</em> 继承了
<em>HttpServletBean</em>， 最后 <em>DispatcherServlet</em> 继承了 <em>FrameworkServlet</em> 。</p><h3 id=3-源码分析>3. 源码分析</h3><p>由于DispatcherServlet是一个Servlet那么就从Servlet的方法入手。Servlet完成实例化以后首先调用的就是init方法。在GenericServlet类中init()方法实现为空，在HttpServletBean重写</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>init</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>ServletException</span> <span style=color:#ce5c00;font-weight:700>{</span>

		<span style=color:#8f5902;font-style:italic>// Set bean properties from init parameters.
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>PropertyValues</span> <span style=color:#000>pvs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ServletConfigPropertyValues</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getServletConfig</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>requiredProperties</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>BeanWrapper</span> <span style=color:#000>bw</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PropertyAccessorFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forBeanPropertyAccess</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#000>ResourceLoader</span> <span style=color:#000>resourceLoader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ServletContextResourceLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getServletContext</span><span style=color:#ce5c00;font-weight:700>());</span>
				<span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerCustomEditor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Resource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ResourceEditor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resourceLoader</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>()));</span>
				<span style=color:#000>initBeanWrapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setPropertyValues</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isErrorEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Failed to set bean properties on servlet &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>getServletName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>// 该方法在HttpServletBean类中实现为空--主要由子类进行实现
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>initServletBean</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>下面看一下initServletBean方法在FrameworkServlet中的实现：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>initServletBean</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>ServletException</span> <span style=color:#ce5c00;font-weight:700>{</span>
		
		<span style=color:#8f5902;font-style:italic>//省略日志打印
</span><span style=color:#8f5902;font-style:italic></span>
		<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
		    <span style=color:#8f5902;font-style:italic>//初始化webApplicationContext
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>webApplicationContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>initWebApplicationContext</span><span style=color:#ce5c00;font-weight:700>();</span>
			<span style=color:#8f5902;font-style:italic>//初始化initFrameworkServlet-- 默认实现为空
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>initFrameworkServlet</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ServletException</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>RuntimeException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Context initialization failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>//省略日志打印
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从上面可以看出来主要是初始化webApplicationContext，通过调用initWebApplicationContext()方法。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>WebApplicationContext</span> <span style=color:#000>initWebApplicationContext</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//获取ServletContext中的属性值为WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE对象的值
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#8f5902;font-style:italic>//如果有ContextLoaderListner的情况设置的
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>WebApplicationContext</span> <span style=color:#000>rootContext</span> <span style=color:#ce5c00;font-weight:700>=</span>
				<span style=color:#000>WebApplicationContextUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWebApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getServletContext</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#000>WebApplicationContext</span> <span style=color:#000>wac</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>webApplicationContext</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>// A context instance was injected at construction time -&gt; use it
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>wac</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>webApplicationContext</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wac</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>ConfigurableWebApplicationContext</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>ConfigurableWebApplicationContext</span> <span style=color:#000>cwac</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurableWebApplicationContext</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>wac</span><span style=color:#ce5c00;font-weight:700>;</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>cwac</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isActive</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
				
					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cwac</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParent</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#000>cwac</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setParent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rootContext</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#8f5902;font-style:italic>//刷新WebApplicationContext
</span><span style=color:#8f5902;font-style:italic></span>					<span style=color:#000>configureAndRefreshWebApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cwac</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wac</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		    <span style=color:#8f5902;font-style:italic>//根据contextAttribute属性查找WebApplicationContext
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>wac</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>findWebApplicationContext</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wac</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>// 如果上面都没有创建一个
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>wac</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createWebApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rootContext</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>refreshEventReceived</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		
			<span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>onRefreshMonitor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			   <span style=color:#8f5902;font-style:italic>//触发onRefresh方法去做一些其他的事情
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>onRefresh</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wac</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>publishContext</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>// Publish the context as a servlet context attribute.
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>String</span> <span style=color:#000>attrName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getServletContextAttributeName</span><span style=color:#ce5c00;font-weight:700>();</span>
			<span style=color:#000>getServletContext</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>setAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>attrName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>wac</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>wac</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>分析一下createWebApplicationContext(rootContext)方法，configureAndRefreshWebApplicationContext(cwac);在分析一下createWebApplicationContext中也有调用：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>WebApplicationContext</span> <span style=color:#000>createWebApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>ApplicationContext</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>//获取contextClass,如果没有设置contextClass默认是XmlWebApplicationContext
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>contextClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getContextClass</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>ConfigurableWebApplicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAssignableFrom</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>contextClass</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>//不是继承关系抛错
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#ce5c00;font-weight:700>}</span>
		
		<span style=color:#8f5902;font-style:italic>//实例化数据
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>ConfigurableWebApplicationContext</span> <span style=color:#000>wac</span> <span style=color:#ce5c00;font-weight:700>=</span>
				<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurableWebApplicationContext</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>BeanUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instantiateClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>contextClass</span><span style=color:#ce5c00;font-weight:700>);</span>

		<span style=color:#000>wac</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setEnvironment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#000>wac</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setParent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#8f5902;font-style:italic>//contextConfigLocation设置配置文件或者扫描包的路径,根据不同的Context来匹配
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>String</span> <span style=color:#000>configLocation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getContextConfigLocation</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configLocation</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>wac</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setConfigLocation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configLocation</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		
		<span style=color:#8f5902;font-style:italic>//配置刷新--调用了Spring core 的refresh方法
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>configureAndRefreshWebApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wac</span><span style=color:#ce5c00;font-weight:700>);</span>

		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>wac</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>创建完成Spring application context后开始FrameworkServlet#refresh方法这个方法是一个抽象的方法在子类中实现，也就是在DispatcherServlet中实现：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>onRefresh</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>initStrategies</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#8f5902;font-style:italic>//初始化一些请求过程中的策略
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>initStrategies</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>initMultipartResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>initLocaleResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>initThemeResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>initHandlerMappings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>initHandlerAdapters</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>initHandlerExceptionResolvers</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>initRequestToViewNameTranslator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>initViewResolvers</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>initFlashMapManager</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>对于方法initStrategies主要做了这9件事情。</p><ul><li><p>initMultipartResolver</p><p>初始化MultipartResolver，用于处理文件上传服务，如果有文件上传，那么就会将当前的HttpServletRequest包装成DefaultMultipartHttpServletRequest，并且将每个上传的内容封装成CommonsMultipartFile对象。需要在dispatcherServlet-servlet.xml中配置文件上传解析器。</p></li><li><p>initLocaleResolver</p><p>用于处理应用的国际化问题，本地化解析策略。</p></li><li><p>initThemeResolver</p><p>用于定义一个主题</p></li><li><p>initHandlerMapping</p><p>用于定义请求映射关系</p></li><li><p>initHandlerAdapters</p><p>用于根据Handler的类型定义不同的处理规则</p></li><li><p>initHandlerExceptionResolvers</p><p>当Handler处理出错后，会通过此将错误日志记录在log文件中，默认实现类是SimpleMappingExceptionResolver</p></li><li><p>initRequestToViewNameTranslators</p><p>将指定的ViewName按照定义的RequestToViewNameTranslators替换成想要的格式</p></li><li><p>initViewResolvers</p><p>用于将View解析成页面</p></li><li><p>initFlashMapManager</p><p>用于生成FlashMap管理器</p></li></ul><h3 id=4-service方法的分析>4. service方法的分析</h3><p><em>service</em> 方法主要是处理在HTTP请求，在 <em>FrameworkServlet</em> 中重写了 <em>HttpServlet</em> 方法中的 <em>service</em> 方法。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>HttpServletResponse</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>)</span>
			<span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>ServletException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>

		<span style=color:#000>HttpMethod</span> <span style=color:#000>httpMethod</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>HttpMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolve</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethod</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#8f5902;font-style:italic>//PATCH方法或者为null的处理
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>httpMethod</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>HttpMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PATCH</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>httpMethod</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>processRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
		    <span style=color:#8f5902;font-style:italic>//调用HttpServlet的方法--处理其他的HTTP方法
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>service</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><em>doGet、doPost、doPut、doDelete、doOptions、doTrace</em> 方法中共同调用了 <em>processRequest</em> 方法。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>processRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>HttpServletResponse</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>)</span>
			<span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>ServletException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>

		<span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>startTime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#000>Throwable</span> <span style=color:#000>failureCause</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>

		<span style=color:#000>LocaleContext</span> <span style=color:#000>previousLocaleContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>LocaleContextHolder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLocaleContext</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#8f5902;font-style:italic>//获取Locale
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>LocaleContext</span> <span style=color:#000>localeContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>buildLocaleContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>

		<span style=color:#000>RequestAttributes</span> <span style=color:#000>previousAttributes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RequestContextHolder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRequestAttributes</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#8f5902;font-style:italic>//获取Servlet请求属性
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>ServletRequestAttributes</span> <span style=color:#000>requestAttributes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>buildRequestAttributes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>previousAttributes</span><span style=color:#ce5c00;font-weight:700>);</span>
        
        <span style=color:#8f5902;font-style:italic>//异步管理
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>WebAsyncManager</span> <span style=color:#000>asyncManager</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>WebAsyncUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAsyncManager</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>asyncManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerCallableInterceptor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>FrameworkServlet</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RequestBindingInterceptor</span><span style=color:#ce5c00;font-weight:700>());</span>

		<span style=color:#000>initContextHolders</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>localeContext</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestAttributes</span><span style=color:#ce5c00;font-weight:700>);</span>

		<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
		    <span style=color:#8f5902;font-style:italic>//调用子类的doService
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>doService</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ServletException</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>IOException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>failureCause</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>failureCause</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NestedServletException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Request processing failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
		    <span style=color:#8f5902;font-style:italic>//释放Context
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>resetContextHolders</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>previousLocaleContext</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>previousAttributes</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestAttributes</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>requestAttributes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>requestCompleted</span><span style=color:#ce5c00;font-weight:700>();</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#000>logResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>failureCause</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>asyncManager</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>publishRequestHandledEvent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>startTime</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>failureCause</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div><p>通过调用DispatcherServlet#doService方法来处理外部发来服务器的HTTP请求，</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>doService</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>HttpServletResponse</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>logRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>

		<span style=color:#8f5902;font-style:italic>// Keep a snapshot of the request attributes in case of an include,
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#8f5902;font-style:italic>// to be able to restore the original attributes after the include.
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>attributesSnapshot</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>WebUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isIncludeRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>attributesSnapshot</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
			<span style=color:#000>Enumeration</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>attrNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttributeNames</span><span style=color:#ce5c00;font-weight:700>();</span>
			<span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>attrNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasMoreElements</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>String</span> <span style=color:#000>attrName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>attrNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nextElement</span><span style=color:#ce5c00;font-weight:700>();</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cleanupAfterInclude</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>attrName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>startsWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DEFAULT_STRATEGIES_PREFIX</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>attributesSnapshot</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>attrName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>attrName</span><span style=color:#ce5c00;font-weight:700>));</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>// 让框架能够处理和查看WebApplicationContext中的对象
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>WEB_APPLICATION_CONTEXT_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getWebApplicationContext</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LOCALE_RESOLVER_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>localeResolver</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>THEME_RESOLVER_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>themeResolver</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>THEME_SOURCE_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getThemeSource</span><span style=color:#ce5c00;font-weight:700>());</span>

		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>flashMapManager</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>FlashMap</span> <span style=color:#000>inputFlashMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>flashMapManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>retrieveAndUpdate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputFlashMap</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>INPUT_FLASH_MAP_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Collections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unmodifiableMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputFlashMap</span><span style=color:#ce5c00;font-weight:700>));</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>OUTPUT_FLASH_MAP_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FlashMap</span><span style=color:#ce5c00;font-weight:700>());</span>
			<span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>FLASH_MAP_MANAGER_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>flashMapManager</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
		    <span style=color:#8f5902;font-style:italic>//最重要的方法：分发请求处理
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>doDispatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>WebAsyncUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAsyncManager</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>isConcurrentHandlingStarted</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#8f5902;font-style:italic>// Restore the original attribute snapshot, in case of an include.
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>attributesSnapshot</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>restoreAttributesAfterInclude</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>attributesSnapshot</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>doDispatch方法用来分发请求：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>doDispatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>HttpServletResponse</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>HttpServletRequest</span> <span style=color:#000>processedRequest</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#000>HandlerExecutionChain</span> <span style=color:#000>mappedHandler</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>multipartRequestParsed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>

		<span style=color:#000>WebAsyncManager</span> <span style=color:#000>asyncManager</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>WebAsyncUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAsyncManager</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>

		<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>ModelAndView</span> <span style=color:#000>mv</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#000>Exception</span> <span style=color:#000>dispatchException</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>

			<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
			    <span style=color:#8f5902;font-style:italic>//检查是否为文件上传请求
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>processedRequest</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>checkMultipart</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#000>multipartRequestParsed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>processedRequest</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>

				<span style=color:#8f5902;font-style:italic>// 获取当前请求的处理器.
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>mappedHandler</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>processedRequest</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mappedHandler</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>noHandlerFound</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>processedRequest</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
				<span style=color:#ce5c00;font-weight:700>}</span>

				<span style=color:#8f5902;font-style:italic>// 获取当前请求的处理适配器
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>HandlerAdapter</span> <span style=color:#000>ha</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getHandlerAdapter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mappedHandler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getHandler</span><span style=color:#ce5c00;font-weight:700>());</span>

				<span style=color:#8f5902;font-style:italic>// Process last-modified header, if supported by the handler.
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>String</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethod</span><span style=color:#ce5c00;font-weight:700>();</span>
				<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isGet</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;GET&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isGet</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#4e9a06>&#34;HEAD&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>lastModified</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ha</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLastModified</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mappedHandler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ServletWebRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>checkNotModified</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lastModified</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>isGet</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>mappedHandler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applyPreHandle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>processedRequest</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#8f5902;font-style:italic>//实际执行的处理器
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>mv</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ha</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>handle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>processedRequest</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mappedHandler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getHandler</span><span style=color:#ce5c00;font-weight:700>());</span>

				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>asyncManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isConcurrentHandlingStarted</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#8f5902;font-style:italic>//应用默认的视图名称
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>applyDefaultViewName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>processedRequest</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mv</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#000>mappedHandler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applyPostHandle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>processedRequest</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mv</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>dispatchException</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>err</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#8f5902;font-style:italic>// As of 4.3, we&#39;re processing Errors thrown from handler methods as well,
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#8f5902;font-style:italic>// making them available for @ExceptionHandler methods and other scenarios.
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>dispatchException</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NestedServletException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Handler dispatch failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>err</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#000>processDispatchResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>processedRequest</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mappedHandler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mv</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>dispatchException</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>triggerAfterCompletion</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>processedRequest</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mappedHandler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>err</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>triggerAfterCompletion</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>processedRequest</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mappedHandler</span><span style=color:#ce5c00;font-weight:700>,</span>
					<span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NestedServletException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Handler processing failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>err</span><span style=color:#ce5c00;font-weight:700>));</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>asyncManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isConcurrentHandlingStarted</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#8f5902;font-style:italic>// Instead of postHandle and afterCompletion
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mappedHandler</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>mappedHandler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applyAfterConcurrentHandlingStarted</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>processedRequest</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#8f5902;font-style:italic>// Clean up any resources used by a multipart request.
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>multipartRequestParsed</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>cleanupMultipart</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>processedRequest</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><em>getHandler</em> 获取处理器执行器处理链，然后 <em>getHandlerAdapter</em> 获取处理器适配器。 <em>applyPreHandle</em> 执行。从上面的有两个几个重要的方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//获取执行链
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>mappedHandler</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>processedRequest</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#8f5902;font-style:italic>//获取执行适配器
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>HandlerAdapter</span> <span style=color:#000>ha</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getHandlerAdapter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mappedHandler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getHandler</span><span style=color:#ce5c00;font-weight:700>());</span>

<span style=color:#8f5902;font-style:italic>//调用链执行--前置HandlerInterceptor
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>mappedHandler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applyPreHandle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>processedRequest</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>)</span>

<span style=color:#8f5902;font-style:italic>//实际处理
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>mv</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ha</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>handle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>processedRequest</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mappedHandler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getHandler</span><span style=color:#ce5c00;font-weight:700>());</span>

<span style=color:#8f5902;font-style:italic>//调用链执行--后置HandlerInterceptor
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>mappedHandler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applyPostHandle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>processedRequest</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mv</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>接下来一个个来分析上面的方法：</p><p><em><strong><code>mappedHandler = getHandler(processedRequest)</code></strong></em> 方法的分析，看一下源代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>HandlerExecutionChain</span> <span style=color:#000>getHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>handlerMappings</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//从handlerMappings获取HandlerMapping的实现
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HandlerMapping</span> <span style=color:#000>mapping</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>handlerMappings</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>//从HandlerMapping实现中获取处理执行调用链
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>HandlerExecutionChain</span> <span style=color:#000>handler</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mapping</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handler</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>;</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote><p>HandlerMapping默认实现加载有三个：</p><ol><li>RequestMappingHandlerMapping</li><li>BeanNameUrlHandlerMapping</li><li>SimpleUrlHandlerMapping</li></ol></blockquote><p>默认加载的 <em><strong><code>RequestMappingHandlerMapping</code></strong></em> ，看一下如何获取 <strong><code>HandlerExecutionChain</code></strong> 调用链。 调用的方法 <strong><code>AbstractHandlerMapping#getHandler</code></strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>HandlerExecutionChain</span> <span style=color:#000>getHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//获取内部处理器
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>Object</span> <span style=color:#000>handler</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getHandlerInternal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handler</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//如果为空获取默认处理器
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>handler</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getDefaultHandler</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handler</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#8f5902;font-style:italic>// Bean name or resolved handler?
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handler</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>String</span> <span style=color:#000>handlerName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#000>handler</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>obtainApplicationContext</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handlerName</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#000>HandlerExecutionChain</span> <span style=color:#000>executionChain</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getHandlerExecutionChain</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>

		<span style=color:#8f5902;font-style:italic>//省了日志打印
</span><span style=color:#8f5902;font-style:italic></span>
        <span style=color:#8f5902;font-style:italic>//跨域的配置
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CorsUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isCorsRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>CorsConfiguration</span> <span style=color:#000>globalConfig</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>corsConfigurationSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCorsConfiguration</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>CorsConfiguration</span> <span style=color:#000>handlerConfig</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getCorsConfiguration</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>CorsConfiguration</span> <span style=color:#000>config</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>globalConfig</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>globalConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>combine</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handlerConfig</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>handlerConfig</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>executionChain</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getCorsHandlerExecutionChain</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>executionChain</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>executionChain</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后就是获取 <strong><code>HandlerAdapter ha = getHandlerAdapter(mappedHandler.getHandler())</code></strong> 适配器。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>HandlerAdapter</span> <span style=color:#000>getHandlerAdapter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>ServletException</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>handlerAdapters</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>//获取处理适配器
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HandlerAdapter</span> <span style=color:#000>adapter</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>handlerAdapters</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>adapter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>supports</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>adapter</span><span style=color:#ce5c00;font-weight:700>;</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ServletException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;No adapter for handler [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>handler</span> <span style=color:#ce5c00;font-weight:700>+</span>
				<span style=color:#4e9a06>&#34;]: The DispatcherServlet configuration needs to include a HandlerAdapter that supports this handler&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>适配器默认加载的 <strong><code>RequestMappingHandlerAdapter</code></strong> 适配器。 <strong><code>mappedHandler.applyPreHandle(processedRequest, response)</code></strong> 处理 <strong><code>HandlerInterceptor</code></strong> 的 <em><strong><code>preHandle</code></strong></em> 方法。然后 <strong><code>mv = ha.handle(processedRequest, response, mappedHandler.getHandler())</code></strong> 调用 <strong><code>HandlerAdapter</code></strong> 的 <strong><code>handle</code></strong> 方法。 <strong><code>mappedHandler.applyPostHandle(processedRequest, response, mv);</code></strong> 接下来执行 <strong><code>HandlerInterceptor</code></strong> 的 <em><strong><code>postHandle</code></strong></em>。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-86323df96176318d20347df112c2d8b8>3.5 - RequestMappingHandlerAdapter源码分析</h1><h3 id=1-requestmappinghandleradapter初始化>1. RequestMappingHandlerAdapter初始化</h3><p>首先看一下构造函数</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>RequestMappingHandlerAdapter</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageConverters</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageConverters</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ByteArrayHttpMessageConverter</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageConverters</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringHttpMessageConverter</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageConverters</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SourceHttpMessageConverter</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;());</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Error</span> <span style=color:#000>err</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>// Ignore when no TransformerFactory implementation is available
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>messageConverters</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AllEncompassingFormHttpMessageConverter</span><span style=color:#ce5c00;font-weight:700>());</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>构造函数主要初始化了四个 <em><strong>HttpMessageConverter</strong></em> 。由于实现了 <em><strong>InitializingBean</strong></em> 接口下面来看 <em><strong>afterPropertiesSet</strong></em> 方法中的实现。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>afterPropertiesSet</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>// 处理ControllerAdvice注解
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>initControllerAdviceCache</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#8f5902;font-style:italic>//参数解析器初始化
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>argumentResolvers</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>HandlerMethodArgumentResolver</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>resolvers</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getDefaultArgumentResolvers</span><span style=color:#ce5c00;font-weight:700>();</span>
			<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>argumentResolvers</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HandlerMethodArgumentResolverComposite</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>addResolvers</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		
		<span style=color:#8f5902;font-style:italic>//初始化绑定参数解析器--跟Servlet相关的InitBinder注解
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>initBinderArgumentResolvers</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>HandlerMethodArgumentResolver</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>resolvers</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getDefaultInitBinderArgumentResolvers</span><span style=color:#ce5c00;font-weight:700>();</span>
			<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>initBinderArgumentResolvers</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HandlerMethodArgumentResolverComposite</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>addResolvers</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		
		<span style=color:#8f5902;font-style:italic>//返回值参数解析
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>returnValueHandlers</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>HandlerMethodReturnValueHandler</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>handlers</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getDefaultReturnValueHandlers</span><span style=color:#ce5c00;font-weight:700>();</span>
			<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>returnValueHandlers</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HandlerMethodReturnValueHandlerComposite</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>addHandlers</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handlers</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><em><strong>initControllerAdviceCache</strong></em> 方法主要用来处理包含 <em><strong>@ControllerAdvice</strong></em> 注解(@ControllerAdvice或者@RestControllerAdvice)</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>initControllerAdviceCache</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getApplicationContext</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//获取带有@ControllerAdvice注解的bean
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ControllerAdviceBean</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>adviceBeans</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ControllerAdviceBean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findAnnotatedBeans</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getApplicationContext</span><span style=color:#ce5c00;font-weight:700>());</span>

		<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>requestResponseBodyAdviceBeans</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>

		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ControllerAdviceBean</span> <span style=color:#000>adviceBean</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>adviceBeans</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>beanType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>adviceBean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanType</span><span style=color:#ce5c00;font-weight:700>();</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanType</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Unresolvable type for ControllerAdviceBean: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>adviceBean</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>attrMethods</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MethodIntrospector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>selectMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MODEL_ATTRIBUTE_METHODS</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>attrMethods</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>modelAttributeAdviceCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>adviceBean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>attrMethods</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>binderMethods</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MethodIntrospector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>selectMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>INIT_BINDER_METHODS</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>binderMethods</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>initBinderAdviceCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>adviceBean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>binderMethods</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#8f5902;font-style:italic>//RequestBodyAdvice接口和ResponseBodyAdvice接口
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RequestBodyAdvice</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAssignableFrom</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>ResponseBodyAdvice</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAssignableFrom</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanType</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>requestResponseBodyAdviceBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>adviceBean</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>requestResponseBodyAdviceBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>requestResponseBodyAdvice</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestResponseBodyAdviceBeans</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#8f5902;font-style:italic>//省略日志打印
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><em><strong>getDefaultArgumentResolvers</strong></em> 方法获取方法参数解析器，这些主要用来处理Controller的方法的解析，构造 <em><strong>HandlerMethodArgumentResolverComposite</strong></em></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>HandlerMethodArgumentResolver</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getDefaultArgumentResolvers</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>HandlerMethodArgumentResolver</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>resolvers</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>

		<span style=color:#8f5902;font-style:italic>// 处理RequestParam注解
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RequestParamMethodArgumentResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getBeanFactory</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>));</span>
		<span style=color:#8f5902;font-style:italic>//处理RequestParam注解参数为Map
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RequestParamMapMethodArgumentResolver</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#8f5902;font-style:italic>//处理PathVariable注解
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PathVariableMethodArgumentResolver</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#8f5902;font-style:italic>//处理PathVariable注解 参数为Map
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PathVariableMapMethodArgumentResolver</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#8f5902;font-style:italic>//处理MatrixVariable注解
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MatrixVariableMethodArgumentResolver</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#8f5902;font-style:italic>//处理MatrixVariable注解 参数为Map
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MatrixVariableMapMethodArgumentResolver</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ServletModelAttributeMethodProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>));</span>
		<span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RequestResponseBodyMethodProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getMessageConverters</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>requestResponseBodyAdvice</span><span style=color:#ce5c00;font-weight:700>));</span>
		<span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RequestPartMethodArgumentResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getMessageConverters</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>requestResponseBodyAdvice</span><span style=color:#ce5c00;font-weight:700>));</span>
		<span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RequestHeaderMethodArgumentResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getBeanFactory</span><span style=color:#ce5c00;font-weight:700>()));</span>
		<span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RequestHeaderMapMethodArgumentResolver</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ServletCookieValueMethodArgumentResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getBeanFactory</span><span style=color:#ce5c00;font-weight:700>()));</span>
		<span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ExpressionValueMethodArgumentResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getBeanFactory</span><span style=color:#ce5c00;font-weight:700>()));</span>
		<span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SessionAttributeMethodArgumentResolver</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RequestAttributeMethodArgumentResolver</span><span style=color:#ce5c00;font-weight:700>());</span>
		
		<span style=color:#8f5902;font-style:italic>// 基本类型解决
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ServletRequestMethodArgumentResolver</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ServletResponseMethodArgumentResolver</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HttpEntityMethodProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getMessageConverters</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>requestResponseBodyAdvice</span><span style=color:#ce5c00;font-weight:700>));</span>
		<span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RedirectAttributesMethodArgumentResolver</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ModelMethodProcessor</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MapMethodProcessor</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ErrorsMethodArgumentResolver</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SessionStatusMethodArgumentResolver</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>UriComponentsBuilderMethodArgumentResolver</span><span style=color:#ce5c00;font-weight:700>());</span>

		<span style=color:#8f5902;font-style:italic>// 自定义解决器
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getCustomArgumentResolvers</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getCustomArgumentResolvers</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>// 设置默认解决器
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RequestParamMethodArgumentResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getBeanFactory</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>));</span>
		<span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ServletModelAttributeMethodProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>));</span>

		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><em><strong>getDefaultInitBinderArgumentResolvers</strong></em> 绑定的是 <strong>@<em>InitBinder</em></strong> 处理。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>HandlerMethodArgumentResolver</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getDefaultInitBinderArgumentResolvers</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>HandlerMethodArgumentResolver</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>resolvers</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>

		<span style=color:#8f5902;font-style:italic>// 基本注解的参数的解决
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RequestParamMethodArgumentResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getBeanFactory</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>));</span>
		<span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RequestParamMapMethodArgumentResolver</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PathVariableMethodArgumentResolver</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PathVariableMapMethodArgumentResolver</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MatrixVariableMethodArgumentResolver</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MatrixVariableMapMethodArgumentResolver</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ExpressionValueMethodArgumentResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getBeanFactory</span><span style=color:#ce5c00;font-weight:700>()));</span>
		<span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SessionAttributeMethodArgumentResolver</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RequestAttributeMethodArgumentResolver</span><span style=color:#ce5c00;font-weight:700>());</span>

		<span style=color:#8f5902;font-style:italic>// 基本类型的参数解决
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ServletRequestMethodArgumentResolver</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ServletResponseMethodArgumentResolver</span><span style=color:#ce5c00;font-weight:700>());</span>

		<span style=color:#8f5902;font-style:italic>// Custom arguments
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getCustomArgumentResolvers</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getCustomArgumentResolvers</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>// Catch-all
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RequestParamMethodArgumentResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getBeanFactory</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>));</span>

		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>resolvers</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><em><strong>getDefaultReturnValueHandlers</strong></em> 返回值的处理。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>HandlerMethodReturnValueHandler</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getDefaultReturnValueHandlers</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>HandlerMethodReturnValueHandler</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>handlers</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>

		<span style=color:#8f5902;font-style:italic>// 单一的返回值类型
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>handlers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ModelAndViewMethodReturnValueHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#000>handlers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ModelMethodProcessor</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#000>handlers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ViewMethodReturnValueHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#000>handlers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ResponseBodyEmitterReturnValueHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getMessageConverters</span><span style=color:#ce5c00;font-weight:700>(),</span>
				<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reactiveAdapterRegistry</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>taskExecutor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contentNegotiationManager</span><span style=color:#ce5c00;font-weight:700>));</span>
		<span style=color:#000>handlers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StreamingResponseBodyReturnValueHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#000>handlers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HttpEntityMethodProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getMessageConverters</span><span style=color:#ce5c00;font-weight:700>(),</span>
				<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contentNegotiationManager</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>requestResponseBodyAdvice</span><span style=color:#ce5c00;font-weight:700>));</span>
		<span style=color:#000>handlers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HttpHeadersReturnValueHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#000>handlers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CallableMethodReturnValueHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#000>handlers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DeferredResultMethodReturnValueHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#000>handlers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AsyncTaskMethodReturnValueHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanFactory</span><span style=color:#ce5c00;font-weight:700>));</span>
	   <span style=color:#8f5902;font-style:italic>// 基本注解类型返回值
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>handlers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ModelAttributeMethodProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>));</span>
		<span style=color:#8f5902;font-style:italic>//这个需要重点关注一下--ResponseBody注解
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>handlers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RequestResponseBodyMethodProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getMessageConverters</span><span style=color:#ce5c00;font-weight:700>(),</span>
				<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contentNegotiationManager</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>requestResponseBodyAdvice</span><span style=color:#ce5c00;font-weight:700>));</span>

		<span style=color:#8f5902;font-style:italic>// 多值返回值类型
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>handlers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ViewNameMethodReturnValueHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#000>handlers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MapMethodProcessor</span><span style=color:#ce5c00;font-weight:700>());</span>

		<span style=color:#8f5902;font-style:italic>// 自定义返回值
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getCustomReturnValueHandlers</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>handlers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getCustomReturnValueHandlers</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>// Catch-all
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>CollectionUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getModelAndViewResolvers</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>handlers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ModelAndViewResolverMethodReturnValueHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getModelAndViewResolvers</span><span style=color:#ce5c00;font-weight:700>()));</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>handlers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ModelAttributeMethodProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>));</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>handlers</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><em><strong>invokeHandlerMethod</strong></em> 处理请求的数据</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>ModelAndView</span> <span style=color:#000>invokeHandlerMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span>
			<span style=color:#000>HttpServletResponse</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>HandlerMethod</span> <span style=color:#000>handlerMethod</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>

		<span style=color:#000>ServletWebRequest</span> <span style=color:#000>webRequest</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ServletWebRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>WebDataBinderFactory</span> <span style=color:#000>binderFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getDataBinderFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handlerMethod</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>ModelFactory</span> <span style=color:#000>modelFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getModelFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handlerMethod</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>binderFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>//通过ServletInvocableHandlerMethod来执行
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>ServletInvocableHandlerMethod</span> <span style=color:#000>invocableMethod</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createInvocableHandlerMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handlerMethod</span><span style=color:#ce5c00;font-weight:700>);</span>
			
			<span style=color:#8f5902;font-style:italic>//设置Controller方法的处理器
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>argumentResolvers</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>invocableMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setHandlerMethodArgumentResolvers</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>argumentResolvers</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			
			<span style=color:#8f5902;font-style:italic>//设置Controller返回值处理器
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>returnValueHandlers</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>invocableMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setHandlerMethodReturnValueHandlers</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>returnValueHandlers</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#000>invocableMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setDataBinderFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>binderFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>invocableMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setParameterNameDiscoverer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parameterNameDiscoverer</span><span style=color:#ce5c00;font-weight:700>);</span>

			<span style=color:#000>ModelAndViewContainer</span> <span style=color:#000>mavContainer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ModelAndViewContainer</span><span style=color:#ce5c00;font-weight:700>();</span>
			<span style=color:#000>mavContainer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAllAttributes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RequestContextUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInputFlashMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>));</span>
			<span style=color:#000>modelFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>initModel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>webRequest</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mavContainer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>invocableMethod</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>mavContainer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setIgnoreDefaultModelOnRedirect</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ignoreDefaultModelOnRedirect</span><span style=color:#ce5c00;font-weight:700>);</span>

			<span style=color:#000>AsyncWebRequest</span> <span style=color:#000>asyncWebRequest</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>WebAsyncUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createAsyncWebRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>asyncWebRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTimeout</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>asyncRequestTimeout</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>WebAsyncManager</span> <span style=color:#000>asyncManager</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>WebAsyncUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAsyncManager</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>asyncManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTaskExecutor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>taskExecutor</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>asyncManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAsyncWebRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>asyncWebRequest</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>asyncManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerCallableInterceptors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>callableInterceptors</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>asyncManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerDeferredResultInterceptors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>deferredResultInterceptors</span><span style=color:#ce5c00;font-weight:700>);</span>

			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>asyncManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasConcurrentResult</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>Object</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>asyncManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConcurrentResult</span><span style=color:#ce5c00;font-weight:700>();</span>
				<span style=color:#000>mavContainer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ModelAndViewContainer</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>asyncManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConcurrentResultContext</span><span style=color:#ce5c00;font-weight:700>()[</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>];</span>
				<span style=color:#000>asyncManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clearConcurrentResult</span><span style=color:#ce5c00;font-weight:700>();</span>
				<span style=color:#000>LogFormatUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>traceDebug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>traceOn</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>String</span> <span style=color:#000>formatted</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>LogFormatUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>formatValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>traceOn</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;Resume with async result [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>formatted</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
				<span style=color:#ce5c00;font-weight:700>});</span>
				<span style=color:#000>invocableMethod</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>invocableMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wrapConcurrentResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#8f5902;font-style:italic>//处理数据
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>invocableMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invokeAndHandle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>webRequest</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mavContainer</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>asyncManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isConcurrentHandlingStarted</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>

			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getModelAndView</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mavContainer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>modelFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>webRequest</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>webRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>requestCompleted</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>最后的处理主要通过 <em><strong>ServletInvocableHandlerMethod</strong></em> 来处理。下面来分析一下方法 <em><strong>invokeAndHandle</strong></em></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>invokeAndHandle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ServletWebRequest</span> <span style=color:#000>webRequest</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ModelAndViewContainer</span> <span style=color:#000>mavContainer</span><span style=color:#ce5c00;font-weight:700>,</span>
			<span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>providedArgs</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
			
        <span style=color:#8f5902;font-style:italic>//执行Controller方法返回值
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>Object</span> <span style=color:#000>returnValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>invokeForRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>webRequest</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mavContainer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>providedArgs</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>setResponseStatus</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>webRequest</span><span style=color:#ce5c00;font-weight:700>);</span>

		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>returnValue</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isRequestNotModified</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>webRequest</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>getResponseStatus</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>mavContainer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isRequestHandled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>disableContentCachingIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>webRequest</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#000>mavContainer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setRequestHandled</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasText</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getResponseStatusReason</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>mavContainer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setRequestHandled</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#000>mavContainer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setRequestHandled</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>state</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>returnValueHandlers</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;No return value handlers&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
		    <span style=color:#8f5902;font-style:italic>//处理返回值
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>returnValueHandlers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>handleReturnValue</span><span style=color:#ce5c00;font-weight:700>(</span>
					<span style=color:#000>returnValue</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getReturnValueType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>returnValue</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>mavContainer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>webRequest</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		    <span style=color:#8f5902;font-style:italic>//省略日志打印
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><em><strong>InvocableHandlerMethod#invokeForRequest</strong></em> 处理请求方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>invokeForRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NativeWebRequest</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>ModelAndViewContainer</span> <span style=color:#000>mavContainer</span><span style=color:#ce5c00;font-weight:700>,</span>
			<span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>providedArgs</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//处理Controller方法的参数数据值
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getMethodArgumentValues</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mavContainer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>providedArgs</span><span style=color:#ce5c00;font-weight:700>);</span>
	    <span style=color:#8f5902;font-style:italic>//打印日志省略
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>doInvoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	
	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>getMethodArgumentValues</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NativeWebRequest</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>ModelAndViewContainer</span> <span style=color:#000>mavContainer</span><span style=color:#ce5c00;font-weight:700>,</span>
			<span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>providedArgs</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#8f5902;font-style:italic>//获取方法的参数
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>MethodParameter</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>parameters</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getMethodParameters</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ObjectUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameters</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>EMPTY_ARGS</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
        
		<span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>parameters</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>];</span>
		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>parameters</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>MethodParameter</span> <span style=color:#000>parameter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parameters</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>];</span>
			<span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>initParameterNameDiscovery</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parameterNameDiscoverer</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>findProvidedArgument</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>providedArgs</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>continue</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#8f5902;font-style:italic>//判断参数是否支持--HandlerMethodArgumentResolver接口
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolvers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>supportsParameter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>formatArgumentError</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;No suitable resolver&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
			    <span style=color:#8f5902;font-style:italic>//执行HandlerMethodArgumentResolver#resolveArgument方法将request中的请求的参数设置到Controller的方法
</span><span style=color:#8f5902;font-style:italic></span>			    <span style=color:#8f5902;font-style:italic>//设置到参数上--这里可以自定义
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolvers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolveArgument</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mavContainer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dataBinderFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			    <span style=color:#8f5902;font-style:italic>//省略日志打印
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>返回值处理</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>returnValueHandlers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>handleReturnValue</span><span style=color:#ce5c00;font-weight:700>(</span>
					<span style=color:#000>returnValue</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getReturnValueType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>returnValue</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>mavContainer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>webRequest</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>返回值处理调用的是复合类 <em><strong>HandlerMethodReturnValueHandlerComposite#handleReturnValue</strong></em> 这个方法。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>handleReturnValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>Object</span> <span style=color:#000>returnValue</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MethodParameter</span> <span style=color:#000>returnType</span><span style=color:#ce5c00;font-weight:700>,</span>
			<span style=color:#000>ModelAndViewContainer</span> <span style=color:#000>mavContainer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>NativeWebRequest</span> <span style=color:#000>webRequest</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        
        <span style=color:#8f5902;font-style:italic>//选取对应的HandlerMethodReturnValueHandler的实现来处理
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>HandlerMethodReturnValueHandler</span> <span style=color:#000>handler</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>selectHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>returnValue</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>returnType</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handler</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Unknown return value type: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>returnType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterType</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#8f5902;font-style:italic>//处理返回值
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>handleReturnValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>returnValue</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>returnType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mavContainer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>webRequest</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-74fe028b96d5028ff22b2f8a3f0fb26f>4 - Spring framework自定义组件</h1></div><div class=td-content><h1 id=pg-eee53f697176ba708c020f01a315d2f2>4.1 - Spring如何自定义注解</h1><h3 id=1-自定义注解分类>1 自定义注解分类</h3></div><div class=td-content style=page-break-before:always><h1 id=pg-d2df516e5940451ccde777d7fa16302e>4.2 - Spring中的拓展原理实战</h1><h3 id=1-spring拓展分类>1. Spring拓展分类</h3><p>Spring在Java框架中有着不可撼动的地位，只要是Java开发者就没有不用的。对于这样一个优秀的框架可拓展性是必不可少的。这里通过分析Spring的原理然后根据工作中的需要基于Spring的一些常用的拓展：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/spring/custom/Spring%E4%B8%AD%E7%9A%84%E6%8B%93%E5%B1%95.png alt=Spring中的拓展></p><blockquote><p><a href=https://spring.io/>Spring官网</a></p><p><a href=https://github.com/spring-projects/spring-framework>Spring Framework Github</a></p></blockquote><p>拓展分类：</p><ul><li><p><strong>XML Schema拓展</strong></p><p>在Spring中有除了比较常见的标签 bean、aop标签以外，还可以通过自定义XSD然后和Spring的拓展接口实现自定义</p></li><li><p><strong>自定义注解</strong></p><p>首先要明白自定义注解有什么好处：</p><ul><li>自定义注解能够通过注解很好的表达我们这个注解表干的事情，例如：@Log这个在Spring中没有这个注解，通过注解我们很好猜到这个是用来记录日志的。在Spring Web中的注解@RestController</li><li>能够在Spring的原有的注解上做一些额外的功能</li></ul></li><li><p><strong>AOP拓展</strong></p><p>对于AOP拓展，Spring中已经有了几个例子：<strong><code>@Transactional</code></strong> <strong><code>@Async</code></strong> <strong><code>@Cacheable</code></strong> ，这几个都是AOP拓展的体现，但是在实际的工作中远远不止这些拓展。例如：日志记录，方法调用时间统计等等</p><blockquote><p>Async原理源码分析可以阅读 《<a href=https://juejin.cn/post/7045587358174937101>Spring AOP应用之EnableAsync</a>》</p><p>Transactional原理源码分析可以阅读 《<a href=https://juejin.cn/post/7040748897915895821>Spring AOP应用之Spring事务管理</a>》</p></blockquote></li><li><p><strong>校验拓展</strong></p><p>在web项目中，有一类注解像：@NotBlank 这一类注解，这些只是Java本身提供的，Spring给了支持。但是例如判断是不是电子邮件、电话号码等等都需要自定义。(严格意义上来说这只能是Spring对校验的一种支持)</p></li><li><p><strong>其他拓展</strong></p><p>对一些接口拓展，例如Aware接口拓展等等</p></li></ul><h3 id=2-为什么要拓展自定义>2. 为什么要拓展(自定义)？</h3><p>拓展自定义的意义在哪里？从代码可读性上来说能够让使用者更加清楚明白当前的组件是干什么的，从解决问题的角度来说更好的解决每个具体业务的问题。实现个性化定制。</p><p>接下来通过一系列文章进行分门别类，从原理到实际编写代码来实现以上的这些拓展。结合工作中的一些实际需求对拓展做一些实现！同时把Spring的拓展进行分门别类。在更新完成Spring拓展的系列后还会继续更新Spring Boot的相关拓展以及源码分析的文章。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-63daf4c3918e0827e10abe8ef6f0c982>4.3 - 如何自定义Spring xml Namespace</h1><p>在Spring XML配置文件中除了Spring 默认的Namespace，今天我们来看一下如何自定义Namespace</p><h3 id=1-spring自定义xml的namespace原理>1. Spring自定义XML的Namespace原理</h3><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/spring/custom/%E8%87%AA%E5%AE%9A%E4%B9%89xml%20schema.png alt="自定义xml schema"></p><p>整个Spring容器启动的时候流程还是一样，但是在加载Bean的定义的时候，XML配置文件调用的是 <strong>AbstractXmlApplicationContext#loadBeanDefinitions</strong> 方法来加载XML中的Bean的定义。然后通过 <strong>XmlBeanDefinitionReader</strong> 从设置的默认位置或者指定位置的xml解析成为Document到内存。<strong>BeanDefinitionDocumentReader</strong> 负责解析 XML Document中每个 Element。</p><blockquote><p>整个过程会读取META-INF/spring.schemas文件中配置的Namespace和XSD文件的对应关系进行校验</p></blockquote><p>在解析的过程中会去判断是Spring默认的Namespace还是用户自定义Namespace</p><ul><li><p>Spring 默认Element处理</p><p>默认的Element: import,alias,bean,beans,这些都是由 <strong>DefaultBeanDefinitionDocumentReader</strong> 提供默认解析</p></li><li><p>自定义的Element处理</p><p>通过获取配置在 <strong>META-INF/spring.handlers</strong> 文件中对应Namespace的处理类。这个Namespace的处理类实现 <strong>NamespaceHandler或者NamespaceHandlerSupport</strong> 。</p></li></ul><p>然后调用NamespaceHandler具体实例的NamespaceHandler#parse方法对Element进行解析。</p><h3 id=2-spring自定义xml的namespace实战>2. Spring自定义XML的Namespace实战</h3><p>定义一个和Spring默认的bean拥有相同功能的Element,这个Element可以叫：<strong>mxsmBean</strong>, 具体的步骤如下图：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/spring/custom/Spring%20%E8%87%AA%E5%AE%9A%E4%B9%89XML%20Namespace%E6%AD%A5%E9%AA%A4.png alt="Spring 自定义XML Namespace步骤"></p><h4 id=21-xsd定义>2.1 XSD定义</h4><p>通过XSD文件定义mxsmBean需要有哪些属性。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-16&#34; ?&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;xsd:schema</span> <span style=color:#c4a000>xmlns=</span><span style=color:#4e9a06>&#34;https://github.com/mxsm/schema/mxsm&#34;</span>  <span style=color:#a40000>(1)</span>
            <span style=color:#c4a000>xmlns:xsd=</span><span style=color:#4e9a06>&#34;http://www.w3.org/2001/XMLSchema&#34;</span>  
            <span style=color:#c4a000>targetNamespace=</span><span style=color:#4e9a06>&#34;https://github.com/mxsm/schema/mxsm&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  (2)

    <span style=color:#204a87;font-weight:700>&lt;xsd:import</span> <span style=color:#c4a000>namespace=</span><span style=color:#4e9a06>&#34;http://www.springframework.org/schema/beans&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>

    <span style=color:#204a87;font-weight:700>&lt;xsd:element</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;mxsmBean&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;xsd:complexType&gt;</span>
            <span style=color:#204a87;font-weight:700>&lt;xsd:attribute</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;name&#34;</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;xsd:string&#34;</span> <span style=color:#c4a000>use=</span><span style=color:#4e9a06>&#34;required&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
            <span style=color:#204a87;font-weight:700>&lt;xsd:attribute</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;class&#34;</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;xsd:string&#34;</span> <span style=color:#c4a000>use=</span><span style=color:#4e9a06>&#34;required&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;/xsd:complexType&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/xsd:element&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/xsd:schema&gt;</span>
</code></pre></div><p>(1)和(2)是加自己的Namescape,XSD存放的位置如下：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/spring/custom/image-20220119221646852.png alt=image-20220119221646852></p><h4 id=22-编写namespacehandler接口实现>2.2 编写NamespaceHandler接口实现</h4><p>这个接口主要是用来处理我们对应的Element。例如在 <a href=https://github.com/mxsm/schema/mxsm>https://github.com/mxsm/schema/mxsm</a> 下面我只是定义application这个Element所以就只需要解析这一个就可以了。</p><blockquote><p>NamespaceHandlerSupport是实现了部分NamespaceHandler接口的抽象方法，一般情况下我们实现NamespaceHandlerSupport类</p></blockquote><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MxsmSchemaHandler</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>NamespaceHandlerSupport</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>init</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>registerBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;mxsmBean&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MxsmBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#8f5902;font-style:italic>//如果有多个Element就调用多个
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MxsmBeanDefinitionParser</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>BeanDefinitionParser</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BeanDefinition</span> <span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Element</span> <span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ParserContext</span> <span style=color:#000>parserContext</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>String</span> <span style=color:#000>aClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;class&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>aClass</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>BeanDefinitionBuilder</span> <span style=color:#000>beanDefinitionBuilder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>BeanDefinitionBuilder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>genericBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>aClass</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>AbstractBeanDefinition</span> <span style=color:#000>beanDefinition</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanDefinitionBuilder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinition</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>parserContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRegistry</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>registerBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>每一个对应的标签对应一个解析类，解析类实现 <strong>BeanDefinitionParser</strong> 接口。</p><h4 id=23-配置meta-infspringschemas和meta-infspringhandlers文件配置>2.3 配置META-INF/spring.schemas和META-INF/spring.handlers文件配置</h4><p><strong>spring.schemas作用</strong>：配置自定义Namespace的xsd文件的存放位置</p><pre><code class=language-properties data-lang=properties>https\://github.com/mxsm/schema/mxsm/mxsm.xsd=com/github/mxsm/xml/xsd/mxsm.xsd
</code></pre><p>spring.handlers作用：配置自定义Namespace对应的NamespaceHandler</p><pre><code class=language-properties data-lang=properties>https\://github.com/mxsm/schema/mxsm=com.github.mxsm.handler.MxsmSchemaHandler
</code></pre><p>在项目中存放的位置如图：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/spring/custom/image-20220119221852581.png alt=image-20220119221852581></p><h4 id=24-spring-applicationxml文件中引入自定义的element>2.4 Spring application.xml文件中引入自定义的Element</h4><p>创建Spring应用的xml文件。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;beans</span> <span style=color:#c4a000>xmlns=</span><span style=color:#4e9a06>&#34;http://www.springframework.org/schema/beans&#34;</span>
       <span style=color:#c4a000>xmlns:xsi=</span><span style=color:#4e9a06>&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
       <span style=color:#c4a000>xmlns:mxsm=</span><span style=color:#4e9a06>&#34;https://github.com/mxsm/schema/mxsm&#34;</span>  <span style=color:#a40000>(1)</span>
       <span style=color:#c4a000>xmlns:context=</span><span style=color:#4e9a06>&#34;http://www.springframework.org/schema/context&#34;</span>
       <span style=color:#c4a000>xsi:schemaLocation=</span><span style=color:#4e9a06>&#34;http://www.springframework.org/schema/beans
</span><span style=color:#4e9a06>        https://www.springframework.org/schema/beans/spring-beans.xsd
</span><span style=color:#4e9a06>        https://github.com/mxsm/schema/mxsm  (2)
</span><span style=color:#4e9a06>        https://github.com/mxsm/schema/mxsm/mxsm.xsd  (3)
</span><span style=color:#4e9a06>        http://www.springframework.org/schema/context
</span><span style=color:#4e9a06>        https://www.springframework.org/schema/context/spring-context.xsd&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>

        <span style=color:#204a87;font-weight:700>&lt;mxsm:mxsmBean</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;com.github.mxsm.bean.MxsmBeanTest&#34;</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;test&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>

<span style=color:#204a87;font-weight:700>&lt;/beans&gt;</span>
</code></pre></div><p>(1)、(2)，(3) 这三处在使用的时候需要加上。到这里为止，自定义的步骤都已经完成了。接下来就是进行验证我们能不能把这个类注入到Spring 容器中。这里我们写一段测试代码来检验：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>App</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span> <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>ApplicationContext</span> <span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;application.xml&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>//System.out.println(context.getBean(&#34;aaaa&#34;,String.class));
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>MxsmBeanTest</span> <span style=color:#000>test</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;test&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MxsmBeanTest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>MxsmBeanTest</span> <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MxsmBeanTest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>==</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后运行看一下结果：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/spring/custom/image-20220119223247306.png alt=image-20220119223247306></p><p>从运行结果来看能够获取到 <strong>MxsmBeanTest</strong> 对应的实例，并且获取的还是单例。那么说明在我们创建默认的时候注册到Spring容器中的定义获取的类实例默认是已单例的形式。</p><blockquote><p>完整代码地址：https://github.com/mxsm/spring-sample/tree/master/namespace-handler</p></blockquote><h3 id=3-总结>3. 总结</h3><ul><li>在自定义拓展前，首先你要知道你拓展的Element是干什么用的，然后在根据用途来进行解析。比如我上面这个mxsmBean就是为了实现一个简化版本的和Spring默认的Bean类似的功能。</li><li>Namespace的XSD文件的编写，需要了解XSD的编写(教程参考：https://www.w3school.com.cn/schema/schema_example.asp)</li><li>在接口层面需要实现NamespaceHandler以及BeanDefinitionParser接口，两者搭配以前使用。</li><li>在文件META-INF/spring.schemas和META-INF/spring.handlers中添加对应配置，Spring会默认加载这两个文件中的配置进行解析。</li><li>在Spring的xml配置文件中导入对应自定义的Namespace。</li></ul><p>上面就是整个自定义命名空间的过程，步骤以及Spring怎么样去解析。如果想了解更多的细节可以去Spring的网站(<a href=https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#xsd-schemas>https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#xsd-schemas</a>)了解。同时Spring自己也实现了一些例如 util（spring-util.xsd）。可以通过这些来学习。这样能够更好的明白和理解自定义的这个过程。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-d9d3185ccb310af3074e989938732c03>4.4 - Spring常用的拓展接口</h1><ul><li><p>Spring框架是一个拓展性很好的框架，在平时的开发中我们也会进行一些拓展。那么来看一下常用的拓展类：</p><p><img src="https://github.com/mxsm/picture/blob/main/spring/Spring%E5%B8%B8%E8%A7%81%E7%9A%84%E6%8B%93%E5%B1%95%E6%8E%A5%E5%8F%A3.png?raw=true" alt></p><p>这里把拓展接口分成了四大类</p><h3 id=1-导入类拓展接口>1. 导入类拓展接口</h3><ul><li><p>ImportAware</p><p>从Spring的源码注释来看<code>ImportAware</code>接口是需要和<code>@Import</code>一起使用的。通过<code>@Import</code>导入的配置类如果实现了<code>ImportAware</code>接口就可以获取到导入该配置类接口的数据配置。同时需要搭配 <strong><code>@Configuration注解</code></strong></p><p>例如Spring实现的注解**<code>@ EnableAsync</code>** 中的 **<code>ProxyAsyncConfiguration</code>** 就实现了。</p></li><li><p>ImportSelector，DeferredImportSelector</p><p>动态导入配置类,例如Spring的实现：<strong><code>@ EnableAsync</code></strong></p></li><li><p>ImportBeanDefinitionRegistrar</p><p>可以实现自己的注解管理自己的Bean。例如Spring注解： <strong><code>@EnableAspectJAutoProxy</code></strong></p></li></ul><blockquote><p>Tips： 以上的接口都是搭配 @Import、@Configuration使用的。 例如用来实现自定义的Enablexxx功能</p></blockquote><h3 id=2-aop相关接口>2. AOP相关接口</h3><p>对于AOP记住三点就好，Advisor、Advice、Pointcut。所以Spring提供了三个对应的接口来给使用者拓展实现。</p><ul><li><p>StaticMethodMatcherPointcut</p><p>切点实现</p></li><li><p>AbstractBeanFactoryPointcutAdvisor</p><p>通知器实现</p></li><li><p>MethodInterceptor</p><p>切面实现</p></li></ul><h3 id=3-bean后置处理器接口>3. Bean后置处理器接口</h3><p>对于Bean的后置处理器接口主要都是实现了 <strong><code>BeanPostProcessor</code></strong> 接口</p><ul><li>SmartInstantiationAwareBeanPostProcessor</li><li>InstantiationAwareBeanPostProcessor</li><li>DestructionAwareBeanPostProcessor</li><li>MergedBeanDefinitionPostProcessor</li></ul><p>就是来自定义Bean的管理和对Bean进行功能增强。例如Spring AOP的实现就是实现了 <strong><code>SmartInstantiationAwareBeanPostProcessor</code></strong> 接口。实现自定义注解就可以使用当前的这些处理器来实现。</p><h3 id=4-aware类型接口>4. Aware类型接口</h3><p>aware类型接口比较多，主要的作用就是在继承了相对应的aware接口的Bean里面可以获取到相对应的aware对象。这里平时日常的开发过程中使用的比较多的：</p><ul><li>ApplicationContextAware</li><li>BeanNameAware</li><li>ApplicationEventPublisherAware</li><li>BeanClassLoaderAware</li><li>BeanFactoryAware</li><li>NotificationPublisherAware</li><li>EnvironmentAware</li></ul><p>其他的在自定义拓展的过程中使用的频率都没用那么的高</p><h3 id=5-使用小技巧>5. 使用小技巧</h3><p>对于上面这么多拓展的接口如何使用，下面有一些自己在开发过程中的一些小心得：</p><ul><li>参照Spring源码的实现进行拓展，这个准没错。Spring本身实现的源码就是一个很好的例子。例如你要自己开发一个 <strong><code>@EnableXXXX</code></strong> 的注解功能。那么你可以参照一下Spring源码中实现的 <strong><code>@EnableAsync、@EnableTransactionManagement</code></strong> 等一些注解来作为参照</li><li>参照一些开源系统的Spring支持系列框架，这里面有很多基于Spring的自定义注解实现。这些例子也给自己去拓展平时工作中的注解等做了很好的参考和例子。比如：例如 <a href=https://github.com/nacos-group/nacos-spring-project>Nacos Spring 项目</a></li></ul></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-9ef6c7c8e05cf224ed7e5b6d5784a4be>4.5 - 如何自定义Spring Enable注解</h1><p>Spring中有这样一类注解以Enable开头，例如：<strong>@EnableAsync、@EnableWebMvc、@EnableTransactionManagement</strong> 等等，这三个是在工作中见的比较多也比较常见的一个。从注解字面上的意思来看，主要用于开启某项功能，例如：<strong>@EnableTransactionManagement</strong> 注解是开启事务管理，然后搭配 <strong>@Transactional</strong> 注解使用。在工作过程中仅仅是Spring提供的注解是完全不够的，所以需要我们进行自定义Enable类型注解，来开启某一个功能，然后搭配对应的注解来使用。这里先讲如何自定义Enable类型的注解，后面结合拓展AOP类型注解进行搭配使用。</p><h3 id=1-enable注解原理解析>1. @Enable注解原理解析</h3><p>@Enable类型注解原理解析流程如下图：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/spring/custom/Enable%E5%8E%9F%E7%90%86%20.png alt="Enable原理 "></p><p>从@Enable注解的解析流程图可以分析一下原理：</p><ul><li>注解的解析的入口在 <strong>ConfigurationClassPostProcessor</strong> ，这个类是 <strong>BeanDefinitionRegistryPostProcessor</strong> 接口的实现，而<strong>BeanDefinitionRegistryPostProcessor</strong> 接口继承了<strong>BeanFactoryPostProcessor</strong> 。(Spring容器启动就会调用<strong>BeanFactoryPostProcessor</strong> 一系列相关的继承和实现实例的方法)</li><li><strong>ConfigurationClassPostProcessor</strong> 从Spring容器中获取被 <strong>@Configuration</strong> 修饰的类，然后交给新建的 <strong>ConfigurationClassParser</strong> 实例处理。</li><li><strong>ConfigurationClassParser</strong> 负责处理 <strong>@Component、@PropertySources、@PropertySource、@ComponentScans、@ComponentScan、@ImportResource、@Configuration修饰的类方法上面的@Bean、@Import</strong>。</li><li><strong>@Import</strong> 作为 <strong>@Enable</strong> 注解的入口，<strong>@Import</strong> 导入的配置类需要实现 <strong>DeferredImportSelector、ImportSelector、ImportBeanDefinitionRegistrar</strong> 三个当中的一个,以这三个类往Spring容器中注入自己实现功能相关的类来达到我们自己的功能实现的目的</li></ul><p>通过Spring解析配置了@Configuration的类，然后解析类上面配置了@Import的注解配置 value 值的接口，这些类都是实现了<strong>DeferredImportSelector、ImportSelector、ImportBeanDefinitionRegistrar</strong> 这三个接口中的一个。执行了三个接口的实现这里就已经完成了我们自定义的类注册到Spring容器。</p><blockquote><p>Tpis:在自定义Enable用到的Spring原生的注解以及接口</p><ul><li><p>注解</p><p>@Configuration、@Import</p></li><li><p>接口</p><p>DeferredImportSelector、ImportSelector、ImportBeanDefinitionRegistrar</p></li></ul></blockquote><h3 id=2-自定义enable注解实战>2. 自定义@Enable注解实战</h3><p>自定义一个@EnableLog注解，功能：用来是否允许来进行日志记录。自定义需要如下几个步骤：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/spring/custom/Enable%E8%87%AA%E5%AE%9A%E4%B9%89%E6%AD%A5%E9%AA%A4.png alt=Enable自定义步骤></p><h4 id=21-定义enable注解>2.1 定义@Enable注解</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Documented</span>
<span style=color:#5c35cc;font-weight:700>@Target</span><span style=color:#ce5c00;font-weight:700>({</span><span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TYPE</span><span style=color:#ce5c00;font-weight:700>})</span>
<span style=color:#5c35cc;font-weight:700>@Retention</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RetentionPolicy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RUNTIME</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Inherited</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#5c35cc;font-weight:700>@interface</span> <span style=color:#000>EnableLog</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * use asynchronization method to record log
</span><span style=color:#8f5902;font-style:italic>     * @return
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>async</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * log name
</span><span style=color:#8f5902;font-style:italic>     * @return
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#000>String</span> <span style=color:#000>loggerName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>default</span> <span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>proxyTargetClass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>注解里面的属性可以根据实现的功能自己定义。</p><h4 id=22-实现接口>2.2 实现接口</h4><p>需要实现三个接口中的任意一个：</p><ul><li><strong>ImportSelector</strong></li><li><strong>DeferredImportSelector</strong></li><li><strong>ImportBeanDefinitionRegistrar</strong></li></ul><p><strong>ImportSelector</strong>和<strong>DeferredImportSelector</strong>接口算是一类接口执行的时间不同而已。<strong>ImportBeanDefinitionRegistrar</strong> 往Spring容器中注入BeanDefinition。这三个接口选择看实现功能的需要。我们这里使用的 <strong>ImportSelector</strong> (这个也是最常用的)：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>LogImportSelector</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>ImportSelector</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Select and return the names of which class(es) should be imported based on the {@link AnnotationMetadata} of the
</span><span style=color:#8f5902;font-style:italic>     * importing @{@link Configuration} class.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param importingClassMetadata
</span><span style=color:#8f5902;font-style:italic>     * @return the class names, or an empty array if none
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>selectImports</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AnnotationMetadata</span> <span style=color:#000>importingClassMetadata</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#000>AnnotationAttributes</span> <span style=color:#000>attributes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>AnnotationAttributes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fromMap</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#000>importingClassMetadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAnnotationAttributes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>EnableLog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>attributes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBoolean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;value&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]{</span><span style=color:#000>LogConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>LogImportBeanDefinitionRegistrar</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()};</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>];</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这里往Spring容器中注入了一个 <strong>LogConfig</strong> 的配置类，以及一个 <strong>LogImportBeanDefinitionRegistrar</strong> 类。</p><ul><li><strong>LogConfig</strong>： 主要用来配置记录日志的AOP相关的类实例</li><li><strong>LogImportBeanDefinitionRegistrar</strong>：开启AOP的处理，以及Spring在日志处理过程中使用的代理方式</li></ul><blockquote><p>代码具体会在基于AOP拓展的时候进行讲解</p></blockquote><h4 id=23-自定义注解增加import注解>2.3 自定义注解增加@Import注解</h4><p>上面自定义的 <strong>@EnableLog</strong> 注解只是定义一个普通的注解，那么要如何跟Spring相结合，这就需要用到 <strong>@Import</strong> 注解。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Documented</span>
<span style=color:#5c35cc;font-weight:700>@Target</span><span style=color:#ce5c00;font-weight:700>({</span><span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TYPE</span><span style=color:#ce5c00;font-weight:700>})</span>
<span style=color:#5c35cc;font-weight:700>@Retention</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RetentionPolicy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RUNTIME</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Inherited</span>
<span style=color:#5c35cc;font-weight:700>@Import</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LogImportSelector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#5c35cc;font-weight:700>@interface</span> <span style=color:#000>EnableLog</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//省略部分代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>增加(1)位置的代码。这里就把自定义的注解和Spring框架结合一起。到这里自定义 <strong>@EnableLog</strong> 完成了。</p><h4 id=24-配合configuration使用>2.4 配合@Configuration使用</h4><p>在使用自定义的Enable注解需要搭配Spring原生的 <strong>@Configuration</strong> 进行使用(原理已经在上面介绍)</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@EnableLog</span>
<span style=color:#5c35cc;font-weight:700>@Configuration</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>EnableLogConfig</span> <span style=color:#ce5c00;font-weight:700>{</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如上代码这样就可以使用了。</p><blockquote><p>Tips: 如果是SpringBoot项目，可以直接放在@SpringBootApplication注解的类上面，有人会问为什么放在这里可以呢？原因就是 @SpringBootConfiguration注解上面配置了 @Configuration 注解。原因就在这里@SpringBootApplication就相当于一个@Configuration注解，所以我们自定义的Enable注解可以直接放在@SpringBootApplication，当然也可以自定义一个用@Configuration修饰的类上面。</p></blockquote><p>代码会在后续的文章给出来。这里涉及到AOP的拓展。</p><h3 id=3-总结>3. 总结</h3><ul><li>Enable类型的注解从Spring原生的和自己拓展的来看，相当于一个开关。增加这个注解就开启了一个功能，需要搭配其他的注解来使用，例如：@EnableAsync搭配@Async注解，@EnableTransactionManagement搭配@Transactional注解使用</li><li>Enable类型注解生效需要搭配@Configuration注解</li><li>Enable类型注解的实现需要搭配注解@Import导入，功能实现需要实现<strong>DeferredImportSelector、ImportSelector、ImportBeanDefinitionRegistrar</strong> 三个接口中一个。</li></ul><p>将Spring的原生注解和一些特定的拓展接口实现自定义Enable类型注解。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-e9b562fd3c588f2ec24576edf98bdb90>4.6 - 基于Spring AOP自定义注解</h1><p>Spring AOP在Spring项目中有了很多自己的应用，例如@EnableAsync和@Async就是AOP的体现，那么我们如何自己在Spring AOP的原理下自定义自己的注解。</p><h3 id=1-基于spring-aop自定义注解原理>1. 基于Spring AOP自定义注解原理</h3><p>Spring AOP基于动态代理来实现，默认如果使用接口的，用JDK提供的动态代理实现，如果是类则使用CGLIB实现。通过@EnableAspectJAutoProxy开启AOP（同时开启对AspectJ的支持）。</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/spring/custom/%E5%9F%BA%E4%BA%8EAOP%E6%B3%A8%E8%A7%A3%E8%87%AA%E5%AE%9A%E4%B9%89.png alt=基于AOP注解自定义></p><ul><li>@EnableAspectJAutoProxy启动Spring AOP</li><li>Spring AOP分为两种实现：<ul><li>基于AspectJ注解</li><li>基于Spring AOP思想，也就是<strong>Advice</strong> 、 <strong>Pointcut</strong> 、 <strong>Advisor</strong> 这个三个，对应MethodInterceptor、AbstractBeanFactoryPointcutAdvisor、StaticMethodMatcherPointcut 三个类。</li></ul></li><li>在Spring容器启动后生成对应的代理类，在执行方法的时候根据切面来执行对应的方法</li></ul><h3 id=2-代码实战>2. 代码实战</h3><p>将@Enable类型的注解与AOP拓展的接口相结合完成一个完整的功能。</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/spring/custom/%E5%9F%BA%E4%BA%8EAOP%E6%B3%A8%E8%A7%A3%E8%87%AA%E5%AE%9A%E4%B9%89%E6%AD%A5%E9%AA%A4.png alt=基于AOP注解自定义步骤></p><h4 id=21-定义enable注解>2.1 定义@Enable注解</h4><p>结合上一篇文章《<a href=https://juejin.cn/post/7055288159042535460>如何自定义Spring Enable注解</a>》的@EnableLog的功能</p><h4 id=22-定义切面注解>2.2 定义切面注解</h4><p>定义一个@Log注解，功能：用来记录日志</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Documented</span>
<span style=color:#5c35cc;font-weight:700>@Target</span><span style=color:#ce5c00;font-weight:700>({</span><span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>METHOD</span><span style=color:#ce5c00;font-weight:700>})</span>
<span style=color:#5c35cc;font-weight:700>@Retention</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RetentionPolicy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RUNTIME</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Inherited</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#5c35cc;font-weight:700>@interface</span> <span style=color:#000>Log</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * log template
</span><span style=color:#8f5902;font-style:italic>     * @return
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#000>String</span> <span style=color:#000>template</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>default</span> <span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
    
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=23-实现aop的三个接口>2.3 实现AOP的三个接口</h4><p><strong>MethodInterceptor</strong> 是动态类的方法拦截器，用来拦截执行方法。这里就是AOP动态类的增强</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>LogAdvice</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>MethodInterceptor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanFactoryAware</span> <span style=color:#ce5c00;font-weight:700>{</span>
    
    <span style=color:#8f5902;font-style:italic>//省略了部分代码
</span><span style=color:#8f5902;font-style:italic></span>    
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MethodInvocation</span> <span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#000>Method</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethod</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>execute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getThis</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getArguments</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Object</span> <span style=color:#000>execute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MethodInvocation</span> <span style=color:#000>invoker</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>target</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Method</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>LogWorker</span> <span style=color:#000>worker</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LogWorker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>target</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>async</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>logExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>submit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>worker</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>worker</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>run</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//e.printStackTrace();
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Failure to record logs!&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>invoker</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>proceed</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>主要是实现 <strong>invoke</strong> 方法，这里实现了日志记录的方法。和调用目标类的返回执行结果。</p><p><strong>StaticMethodMatcherPointcut</strong> 切入点的实现类：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>LogPointcut</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>StaticMethodMatcherPointcut</span><span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>matches</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Method</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>targetClass</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>AnnotatedElementUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasAnnotation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这里决定了切入点，代码表示了当方法被注解@Log标注了就是匹配到了切入点</p><p><strong>AbstractBeanFactoryPointcutAdvisor</strong> ：通知器用来组织 Advice 和 Pointcut</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>LogAdvisor</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractBeanFactoryPointcutAdvisor</span><span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Pointcut</span> <span style=color:#000>logPointcut</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>LogAdvisor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Pointcut</span> <span style=color:#000>logPointcut</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>logPointcut</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>logPointcut</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Get the Pointcut that drives this advisor.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Pointcut</span> <span style=color:#000>getPointcut</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>logPointcut</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这三个接口实现后把 <strong>Advice</strong> 、 <strong>Pointcut</strong> 、 <strong>Advisor</strong> 三者组织起来，然后注册到Spring IOC容器。</p><h4 id=24-使用切面注解在需要的方法类>2.4 使用切面注解在需要的方法(类)</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@SpringBootApplication</span>
<span style=color:#5c35cc;font-weight:700>@EnableLog</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Application</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>SpringApplication</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>run</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Application</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@Component</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Test</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>(){</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1111</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#5c35cc;font-weight:700>@Log</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>template</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;用户${#user.name}信息：${@test.getName(#user)}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>addUser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>User</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>){</span>

        <span style=color:#204a87;font-weight:700>return</span>  <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>User</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>){</span>

        <span style=color:#204a87;font-weight:700>return</span>  <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>首先在SpringBoot启动类上加入 <strong>@EnableLog</strong> 然后在需要记录的类的方法上加上 <strong>@Log</strong></p><blockquote><p>AOP注解定义代码：https://github.com/mxsm/mxsm-log4j</p><p>测试代码：https://github.com/mxsm/spring-sample/tree/spring-5.3.x/spring-boot</p></blockquote><p>这里是基于Spring AOP接口来实现自定义接口的功能实现，在Spring中还有可以根据AspectJ注解来实现。这里就不详细讲解。想要了解的同学可以在<a href=https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#aop>Spring官网 AOP</a> 的 <strong>Aspect Oriented Programming with Spring</strong> 章节查看。所以基于Spring AOP的注解定义就有两种方式。</p><h3 id=3-总结>3. 总结</h3><ul><li>基于AspectJ的定义实现比较简单，无需搭配自定义的@Enablexxx注解使用，只需要用@EnableAspectJAutoProxy(完成了我们自定义@Enablexxx的注解)开启AOP即可。</li><li>基于Spring AOP定义注解底层是基于动态代理。Spring动态代理可以选择JDK或者Cglib</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-290f19e8499fc5e37b1f625753d48ff7>4.7 - Spring AOP+SpEL实现自定义模板记录日志</h1><p>「这是我参与2022首次更文挑战的第20天，活动详情查看：<a href=https://juejin.cn/post/7052884569032392740>2022首次更文挑战</a>」</p><h3 id=1-前言>1. 前言</h3><p>开发项目中的日志记录是必不可少的，对于非业务项目日志记录的一般是关键信息例如项目启动的配置信息等等，而对于业务系统，那记录的主要是请求的接口的数据。这种情况如果以硬编码的方式，业务代码有改动就同时需要改动日志。同时如果不需要记录日志就需要删除所有的日志记录代码。今天我们用Spring AOP+SpEL 来实现自定义模板记录日志：</p><p><img src=E:%5Cdownload%5C%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95%E5%AE%9E%E7%8E%B0.png alt=日志记录实现></p><h3 id=2-mxsmlog定义>2. @MxsmLog定义</h3><p><img src=E:%5Cdownload@MxsmLog.png alt=@MxsmLog></p><p><strong>@MxsmLog</strong> 包含两个属性：</p><ol><li><strong>template</strong></li></ol><p>用户可以自定义日志记录模板，模板符合SpEL表达式。就可以被SpEL进行解析。</p><ol start=2><li><p><strong>operateType</strong></p><p>修饰的方法的操作类型，默认为 <strong>UNKNOWN</strong>，operateType的取值如下：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>OperateType</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>UNKNOWN</span><span style=color:#ce5c00;font-weight:700>,</span>
    <span style=color:#000>ADD</span><span style=color:#ce5c00;font-weight:700>,</span>
    <span style=color:#000>DELETE</span><span style=color:#ce5c00;font-weight:700>,</span>
    <span style=color:#000>UPDATE</span><span style=color:#ce5c00;font-weight:700>,</span>
    <span style=color:#000>SEARCH</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote><p>Tips: 包含了接口的主要是个操作增删改查，因为也可用于非Controller类上面，所以增加了一个默认的UNKNOWN</p></blockquote></li></ol><p>代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Documented</span>
<span style=color:#5c35cc;font-weight:700>@Target</span><span style=color:#ce5c00;font-weight:700>({</span><span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>METHOD</span><span style=color:#ce5c00;font-weight:700>})</span>
<span style=color:#5c35cc;font-weight:700>@Retention</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RetentionPolicy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RUNTIME</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Inherited</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#5c35cc;font-weight:700>@interface</span> <span style=color:#000>Log</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * log template
</span><span style=color:#8f5902;font-style:italic>     * @return
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#000>String</span> <span style=color:#000>template</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>default</span> <span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @return
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#000>OperateType</span> <span style=color:#000>operateType</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>default</span> <span style=color:#000>OperateType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>UNKNOWN</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=3-enablemxsmlog>3. @EnableMxsmLog</h3><p><img src=E:%5Cdownload@EnableMxsmLog.png alt=@EnableMxsmLog></p><p><strong>@EnableMxsmLog</strong> 包含是个属性：</p><ol><li><strong>value是否开启日志记录，默认为true</strong></li><li><strong>async是否开启同步的方式记录日志</strong></li><li><strong>loggerName logger的名称，这样可以设置不同的logger</strong></li><li><strong>proxyTargetClass使用jdk还是cglib作为代理实现</strong></li></ol><p>代码:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Documented</span>
<span style=color:#5c35cc;font-weight:700>@Target</span><span style=color:#ce5c00;font-weight:700>({</span><span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TYPE</span><span style=color:#ce5c00;font-weight:700>})</span>
<span style=color:#5c35cc;font-weight:700>@Retention</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RetentionPolicy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RUNTIME</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Inherited</span>
<span style=color:#5c35cc;font-weight:700>@Import</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LogImportSelector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#5c35cc;font-weight:700>@interface</span> <span style=color:#000>EnableMxsmLog</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * use asynchronization method to record log
</span><span style=color:#8f5902;font-style:italic>     * @return
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>async</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * log name
</span><span style=color:#8f5902;font-style:italic>     * @return
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#000>String</span> <span style=color:#000>loggerName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>default</span> <span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>proxyTargetClass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=4-spring-aopspel实现解析模板>4. Spring AOP+SpEL实现解析模板</h3><p>主要的逻辑都在AOP的实现和SpEL的解析。AOP主要负责拦截执行方法上标注了**@MxsmLog** 的，然后获取注解中的模板信息，把模板信息给到SpEL进行模板解析。最后由日志进行打印出来。</p><h4 id=41-aop实现>4.1 AOP实现</h4><p><strong>Enable</strong> 类型的注解主要是配合 <strong>@Import</strong> 注解来实现，如上的 <strong>@EnableMxsmLog</strong> 注解用 <strong>@Import</strong> 导入了 <strong><code>LogImportSelector</code></strong> 这个类实现了 <strong>ImportSelector</strong> 接口：</p><p><img src=C:%5CUsers%5Cmxsm%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220205142108722.png alt=image-20220205142108722></p><p>在上图标注的地方导入了AOP的实现。</p><blockquote><p>Tips: 如果对AOP不是很了解可以看一下《<a href=https://juejin.cn/post/7055664320616595492>基于Spring AOP自定义注解</a>》</p></blockquote><p><img src=C:%5CUsers%5Cmxsm%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220205142138055.png alt=image-20220205142138055></p><ul><li><strong>LogAdvisor实现了AbstractBeanFactoryPointcutAdvisor类</strong></li><li><strong>LogAdvice实现了MethodInterceptor接口</strong></li><li><strong>LogPointcut实现了StaticMethodMatcherPointcut类</strong></li></ul><p>上面三个被实现的类组成Spring中的AOP,这里也就完成了AOP的除了模板解析的所有功能。</p><p><strong><code>LogImportBeanDefinitionRegistrar</code></strong> 类负责注册生成代理的类的处理：</p><p><img src=C:%5CUsers%5Cmxsm%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220205143450758.png alt=image-20220205143450758></p><p>有部分人很可能会发现这段代码好像和 <strong><code>AutoProxyRegistrar</code></strong> 里面的代码相似。没错就是差不多因为都是利用AOP来实现的功能。这里主要是在获取类的时候自动创建代理类。</p><h4 id=42-spel实现解析模板>4.2 SpEL实现解析模板</h4><p>模板解析主要是用了Spring SpEL表达式来实现的。</p><p><img src=C:%5CUsers%5Cmxsm%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220205144154908.png alt=image-20220205144154908></p><p>模板的解析，因为考虑到有可能是异步的情况所以，这里抽象了一个 <strong>LogWorker</strong> 来执行日志解析和记录。</p><p><img src=C:%5CUsers%5Cmxsm%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220205144312893.png alt=image-20220205144312893></p><p>在这个 <strong>LogWorker#run</strong> 方法里实现了模板的绩效和日志的记录。</p><h4 id=43-错误处理>4.3 错误处理</h4><p>如下代码所示：</p><p><img src=C:%5CUsers%5Cmxsm%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220205144619676.png alt=image-20220205144619676></p><p>如果日志解析和记录错误的情况下不会影响到整个业务的执行。</p><h3 id=5-案例演示>5. 案例演示</h3><p>增加maven依赖：</p><pre><code>&lt;dependency&gt;
    &lt;groupId&gt;com.github.mxsm&lt;/groupId&gt;
    &lt;artifactId&gt;mxsm-log&lt;/artifactId&gt;
    &lt;version&gt;1.0.0&lt;/version&gt;
&lt;/dependency&gt;
</code></pre><p>编写测试类：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@RestController</span>
<span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/log&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AsyncController</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Autowired</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Test</span> <span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@PostMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/user&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>currentTime1</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@RequestParam</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>required</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#5c35cc;font-weight:700>@RequestBody</span> <span style=color:#000>User</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>){</span>
         <span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addUser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@Component</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Test</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>(){</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1111</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@MxsmLog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>template</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;用户名称${#user.name}信息：${@test.getName(#user)}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>addUser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>User</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>){</span>
        <span style=color:#204a87;font-weight:700>return</span>  <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>User</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>){</span>
        <span style=color:#204a87;font-weight:700>return</span>  <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>启动开始测试：</p><p><img src=C:%5CUsers%5Cmxsm%5CDesktop%5Cpic%5C%E8%87%AA%E5%AE%9A%E4%B9%89%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95%E6%B5%8B%E8%AF%95.gif alt=自定义日志记录测试></p><p>从这里可以看到已经可以使用了</p><blockquote><p>Tips: jar包已经发布到maven中央仓库</p><p>源码地址：https://github.com/mxsm/mxsm-log4j</p><p>测试代码地址：https://github.com/mxsm/spring-sample/tree/master/spring-boot</p></blockquote><h3 id=6-总结>6 总结</h3><p>这个只是实现了一个初步的只能说可以用。后续会基于这个实现更多的功能以及优化其实用性。能够直接用于生产！</p><p><strong>不足：</strong></p><ul><li>依赖的Spring的版本较高，需要Spring5以上</li><li>异步的线程池配置没有给到用户自定义</li></ul><blockquote><p>我是蚂蚁背大象，文章对你有帮助可以点个赞关注，关注我，你的点赞、关注是我前进的动力，文章有不正确的地方请您斧正留言评论~谢谢！</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-f0d137fc30ad03cd1d45c5cf75629dca>4.8 - Spring如何解析自定义xml的源码解析</h1><h3 id=1-spring如何加载自定义的xml-element>1. Spring如何加载自定义的xml Element</h3><p>下面来通过代码的Debug来看Spring是如何加载自定义的xml Element</p><blockquote><p>代码：<a href=https://github.com/mxsm/spring-sample/tree/master/namespace-handler>https://github.com/mxsm/spring-sample/tree/master/namespace-handler</a></p></blockquote><h3 id=2-namespacehandler的继承关系>2. NamespaceHandler的继承关系</h3><p>首先看一下 <strong><code>NamespaceHandler</code></strong> 的继承关系</p><p><img src="https://github.com/mxsm/document/blob/master/image/Spring/Springframework/NamespaceHandler.png?raw=true" alt=图></p><p>从上图可以看出来几个比较熟悉的：</p><ul><li><p>AopNamespaceHandler</p><p><strong>aop</strong> 的 <strong>Element</strong> 处理</p></li><li><p>TxNamespaceHandler</p><p>事务的处理节点</p></li></ul><p>在继承过程中抽象类 <strong><code>NamespaceHandlerSupport</code></strong> 实现了 <strong><code>NamespaceHandler</code></strong> 。自定义也是主要通过 <strong><code>NamespaceHandlerSupport</code></strong> 实现这个抽象类。</p><h3 id=3-如何加载使用namespacehandler的实现类>3. 如何加载使用NamespaceHandler的实现类</h3><p>在 <strong>Spring</strong> 中定义了一个 <strong><code>NamespaceHandlerResolver</code></strong> 接口用来解析 <strong><code>NamespaceHandler</code></strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@FunctionalInterface</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>NamespaceHandlerResolver</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>	 * Resolve the namespace URI and return the located {@link NamespaceHandler}
</span><span style=color:#8f5902;font-style:italic>	 * implementation.
</span><span style=color:#8f5902;font-style:italic>	 * @param namespaceUri the relevant namespace URI
</span><span style=color:#8f5902;font-style:italic>	 * @return the located {@link NamespaceHandler} (may be {@code null})
</span><span style=color:#8f5902;font-style:italic>	 */</span>
	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#000>NamespaceHandler</span> <span style=color:#000>resolve</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>namespaceUri</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这个接口就一个人方法，方法的参数传入的是命名空间的Uri。在 Spring中实现了这个接口的只有一个类 <strong><code>DefaultNamespaceHandlerResolver</code></strong> 。下面一下这类的代码实现(主要关注一下resolve方法)：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DefaultNamespaceHandlerResolver</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>NamespaceHandlerResolver</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>	 * 空间URI和处理器对应关系存放的文件(自定义同样会被加载)
</span><span style=color:#8f5902;font-style:italic>	 */</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>DEFAULT_HANDLER_MAPPINGS_LOCATION</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;META-INF/spring.handlers&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>


	<span style=color:#8f5902;font-style:italic>/** Logger available to subclasses. */</span>
	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Log</span> <span style=color:#000>logger</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>LogFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getClass</span><span style=color:#ce5c00;font-weight:700>());</span>

	<span style=color:#8f5902;font-style:italic>/** ClassLoader to use for NamespaceHandler classes. */</span>
	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ClassLoader</span> <span style=color:#000>classLoader</span><span style=color:#ce5c00;font-weight:700>;</span>

	<span style=color:#8f5902;font-style:italic>/** Resource location to search for. */</span>
	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>handlerMappingsLocation</span><span style=color:#ce5c00;font-weight:700>;</span>

	<span style=color:#8f5902;font-style:italic>/** Stores the mappings from namespace URI to NamespaceHandler class name / instance. */</span>
	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>handlerMappings</span><span style=color:#ce5c00;font-weight:700>;</span>


	<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>	 * Create a new {@code DefaultNamespaceHandlerResolver} using the
</span><span style=color:#8f5902;font-style:italic>	 * default mapping file location.
</span><span style=color:#8f5902;font-style:italic>	 * &lt;p&gt;This constructor will result in the thread context ClassLoader being used
</span><span style=color:#8f5902;font-style:italic>	 * to load resources.
</span><span style=color:#8f5902;font-style:italic>	 * @see #DEFAULT_HANDLER_MAPPINGS_LOCATION
</span><span style=color:#8f5902;font-style:italic>	 */</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>DefaultNamespaceHandlerResolver</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>DEFAULT_HANDLER_MAPPINGS_LOCATION</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>	 * Create a new {@code DefaultNamespaceHandlerResolver} using the
</span><span style=color:#8f5902;font-style:italic>	 * default mapping file location.
</span><span style=color:#8f5902;font-style:italic>	 * @param classLoader the {@link ClassLoader} instance used to load mapping resources
</span><span style=color:#8f5902;font-style:italic>	 * (may be {@code null}, in which case the thread context ClassLoader will be used)
</span><span style=color:#8f5902;font-style:italic>	 * @see #DEFAULT_HANDLER_MAPPINGS_LOCATION
</span><span style=color:#8f5902;font-style:italic>	 */</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>DefaultNamespaceHandlerResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>ClassLoader</span> <span style=color:#000>classLoader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>classLoader</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>DEFAULT_HANDLER_MAPPINGS_LOCATION</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>


	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>DefaultNamespaceHandlerResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>ClassLoader</span> <span style=color:#000>classLoader</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>handlerMappingsLocation</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handlerMappingsLocation</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Handler mappings location must not be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>classLoader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>classLoader</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>classLoader</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>ClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDefaultClassLoader</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>handlerMappingsLocation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>handlerMappingsLocation</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>


	<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>	 * 解析传入的命名空间的URI
</span><span style=color:#8f5902;font-style:italic>	 */</span>
	<span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>NamespaceHandler</span> <span style=color:#000>resolve</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>namespaceUri</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>handlerMappings</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getHandlerMappings</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#000>Object</span> <span style=color:#000>handlerOrClassName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>handlerMappings</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>namespaceUri</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handlerOrClassName</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handlerOrClassName</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>NamespaceHandler</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NamespaceHandler</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>handlerOrClassName</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>String</span> <span style=color:#000>className</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>handlerOrClassName</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>handlerClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>className</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>classLoader</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>NamespaceHandler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAssignableFrom</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handlerClass</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FatalBeanException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Class [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>className</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;] for namespace [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>namespaceUri</span> <span style=color:#ce5c00;font-weight:700>+</span>
							<span style=color:#4e9a06>&#34;] does not implement the [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>NamespaceHandler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;] interface&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#000>NamespaceHandler</span> <span style=color:#000>namespaceHandler</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NamespaceHandler</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>BeanUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instantiateClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handlerClass</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#8f5902;font-style:italic>//调用init方法--所以在实现 NamespaceHandlerSupport只需要
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>//实现init方法原因就在这里
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>namespaceHandler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>init</span><span style=color:#ce5c00;font-weight:700>();</span>
				<span style=color:#000>handlerMappings</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>namespaceUri</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>namespaceHandler</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>namespaceHandler</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassNotFoundException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FatalBeanException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Could not find NamespaceHandler class [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>className</span> <span style=color:#ce5c00;font-weight:700>+</span>
						<span style=color:#4e9a06>&#34;] for namespace [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>namespaceUri</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LinkageError</span> <span style=color:#000>err</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FatalBeanException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Unresolvable class definition for NamespaceHandler class [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
						<span style=color:#000>className</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;] for namespace [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>namespaceUri</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>err</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>	 * 获取META-INF/spring.handlers里面的对应的命名空间URI和空间处理器的
</span><span style=color:#8f5902;font-style:italic>	 * 对应的关系
</span><span style=color:#8f5902;font-style:italic>	 */</span>
	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getHandlerMappings</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>handlerMappings</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>handlerMappings</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handlerMappings</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>handlerMappings</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>handlerMappings</span><span style=color:#ce5c00;font-weight:700>;</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handlerMappings</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTraceEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Loading NamespaceHandler mappings from [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>handlerMappingsLocation</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#000>Properties</span> <span style=color:#000>mappings</span> <span style=color:#ce5c00;font-weight:700>=</span>
								<span style=color:#000>PropertiesLoaderUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>loadAllProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>handlerMappingsLocation</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>classLoader</span><span style=color:#ce5c00;font-weight:700>);</span>
						<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTraceEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
							<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Loaded NamespaceHandler mappings: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>mappings</span><span style=color:#ce5c00;font-weight:700>);</span>
						<span style=color:#ce5c00;font-weight:700>}</span>
						<span style=color:#000>handlerMappings</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConcurrentHashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>mappings</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>());</span>
						<span style=color:#000>CollectionUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mergePropertiesIntoMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mappings</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>handlerMappings</span><span style=color:#ce5c00;font-weight:700>);</span>
						<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>handlerMappings</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>handlerMappings</span><span style=color:#ce5c00;font-weight:700>;</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IOException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span>
								<span style=color:#4e9a06>&#34;Unable to load NamespaceHandler mappings from location [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>handlerMappingsLocation</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>handlerMappings</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>


	<span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;NamespaceHandlerResolver using mappings &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>getHandlerMappings</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过断点的方式来看一下整个调用方法的调用如下图：</p><p><img src="https://github.com/mxsm/document/blob/master/image/Spring/Springframework/Spring%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8B%93%E5%B1%95xml%E8%B0%83%E7%94%A8%E9%93%BE.png?raw=true" alt=图></p><p>下面来分一下整个调用链的过程，上面断点打在 <strong><code>DefaultNamespaceHandlerResolver</code></strong> 的 <strong><code>resolve</code></strong> 方法的下面这段代码处</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>handlerMappings</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>namespaceUri</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>namespaceHandler</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><blockquote><p>细心的话可能你会发现debug的过程中，如果你xml中包含 bean这个节点你会发现并不会走到你的断点这个地方来这个是为什么呢？(答案会在下面的分析过程中给出来)</p><p>Debug的代码在上面已经给出来了。</p></blockquote><p>在调用过程中有一个 <strong><code>DefaultBeanDefinitionDocumentReader</code></strong> 类。通过上图可以看出调用了这样一段方法</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>parseBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Element</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinitionParserDelegate</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//判断是否为http://www.springframework.org/schema/beans默认的空间
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDefaultNamespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>NodeList</span> <span style=color:#000>nl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildNodes</span><span style=color:#ce5c00;font-weight:700>();</span>
			<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>nl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLength</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>Node</span> <span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>item</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Element</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>Element</span> <span style=color:#000>ele</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Element</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#8f5902;font-style:italic>//判断是否为默认的命名空间
</span><span style=color:#8f5902;font-style:italic></span>					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDefaultNamespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#000>parseDefaultElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>//自定义的命名空间--用户自定义的和Spring AOP等等
</span><span style=color:#8f5902;font-style:italic></span>						<span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseCustomElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseCustomElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div><blockquote><p>上面的方法给出了为什么没有进入 <strong>DefaultNamespaceHandlerResolver</strong> 中，因为只有http://www.springframework.org/schema/bean才是默认的命名空间</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-195638b3db3755434ef544b2442bd7a0>4.9 - Spring中常用的工具类</h1><h3 id=spring常用的工具类说明>Spring常用的工具类说明</h3><table><thead><tr><th style=text-align:center>工具类名称</th><th style=text-align:center>使用说明</th><th style=text-align:center>例子</th></tr></thead><tbody><tr><td style=text-align:center>AnnotationUtils</td><td style=text-align:center>注解相关的工具类</td><td style=text-align:center></td></tr><tr><td style=text-align:center>ReflectionUtils</td><td style=text-align:center>反射工具类</td><td style=text-align:center></td></tr><tr><td style=text-align:center></td><td style=text-align:center></td><td style=text-align:center></td></tr><tr><td style=text-align:center></td><td style=text-align:center></td><td style=text-align:center></td></tr><tr><td style=text-align:center></td><td style=text-align:center></td><td style=text-align:center></td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-05e6f9829372f89023d299050eb42fe1>5 - Spring Framework经验心得</h1></div><div class=td-content><h1 id=pg-fd7ac9428e5086b0e31d32cf06cbb46d>5.1 - Spring中那些容易混淆的类开发中该如何选择?</h1><p>Spring在使用过程中会发现有很多那些名字相近的拓展接口。这些接口有的实现的功能区别很大有的区别较小。下面就来总结下一下Spring中那些容易混淆的类，同时说一下作用以及拓展应用。</p><blockquote><p>Spring版本：5.3.x</p></blockquote><h3 id=1--beanfactorypostprocessor与beanpostprocessor>1. BeanFactoryPostProcessor与BeanPostProcessor</h3><p>BeanFactoryPostProcessor与BeanPostProcessor因为名字很相近稍微不注意就会认为是一样的。其实这个两个是两个完全不一样的接口</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/spring/experience/BeanFactoryPostProcessor%E4%B8%8EBeanPostProcessor.png alt=BeanFactoryPostProcessor与BeanPostProcessor></p><h4 id=11-beanfactorypostprocessor>1.1 BeanFactoryPostProcessor</h4><p><strong>作用：</strong> BeanFactory的后置处理器，允许自定义修改应用上下文的Bean的定义。同时可以调整上下文的底层bean工厂的bean属性值。</p><p><strong>执行时间：</strong> Spring 上下文刷新的时候执行</p><p><strong>自定义拓展：</strong> 可以用来自定义修饰类的注解,比如自定义一个@Component</p><h4 id=12-beanpostprocessor>1.2 BeanPostProcessor</h4><p><strong>作用：</strong> Bean的后置处理器，允许自定义修改新bean实例——例如，检查标记接口或用代理包装bean。(动态代理)</p><p><strong>执行时间：</strong> 从Spring 容器中获取Bean的时候</p><p><strong>自定义拓展：</strong> 可以用来自定义修饰类熟悉的注解像@Value</p><h3 id=2-importbeandefinitionregistrar和importselector>2. ImportBeanDefinitionRegistrar和ImportSelector</h3><p>ImportBeanDefinitionRegistrar和ImportSelector主要搭配注解@Import使用，在一些自定义拓展的过程中可能会发现有的人使用的是ImportBeanDefinitionRegistrar实现类，有的使用的是ImportSelector使用类。所以在使用的时候就很疑惑到底使用哪个？</p><h4 id=21-importbeandefinitionregistrar>2.1 ImportBeanDefinitionRegistrar</h4><p>看一下接口源码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>ImportBeanDefinitionRegistrar</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AnnotationMetadata</span> <span style=color:#000>importingClassMetadata</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinitionRegistry</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>,</span>
			<span style=color:#000>BeanNameGenerator</span> <span style=color:#000>importBeanNameGenerator</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

		<span style=color:#000>registerBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>importingClassMetadata</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AnnotationMetadata</span> <span style=color:#000>importingClassMetadata</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinitionRegistry</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>ImportBeanDefinitionRegistrar#registerBeanDefinitions</strong> 方法参数有一个<strong>BeanDefinitionRegistry</strong> ，说明在<strong>ImportBeanDefinitionRegistrar</strong> 实现可以直接往Spring容器中注册Bean的定义。同时也可以获取到 @Import修饰的注解。</p><h4 id=22-importselector>2.2 ImportSelector</h4><p>ImportSelector只能选择性的往导入需要的类名称，如果导入的类是ImportBeanDefinitionRegistrar或者ImportSelector会进行进一步处理，如果导入的是普通的类会将类包装为 <strong><code>ConfigurationClass</code></strong> 存放在ConfigurationClassParser类的configurationClasses属性中。在处理ConfigurationClassParser#parse结束后会将ConfigurationClassParser类的configurationClasses属性中没有加载的配置类定义加载到Spring容器中，如下图：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/spring/experience/image-20220204011652184.png alt=image-20220204011652184></p><p><strong>在搭配@Import注解使用的时候到底使用哪一个看自定义过程中是否需要往Spring容器中自己注册Bean的定义，ImportBeanDefinitionRegistrar和ImportSelector两者功能类似有互补的情况</strong></p><blockquote><p>Tips: ImportSelector导入的类是否标注了@Configuration注解最终都会当做配置类加载到Spring容器</p></blockquote><h3 id=3-importselector和deferredimportselector>3. ImportSelector和DeferredImportSelector</h3><p>ImportSelector和DeferredImportSelector两个的作用是一样的，都是导入类到Spring容器中，不同之处在于执行的时间不同。ImportSelector先执行，DeferredImportSelector后执行。我们从代码层面来看一下：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/spring/experience/image-20220204111609644.png alt=image-20220204111609644></p><p>在<strong>ConfigurationClassParser#parse</strong> 方法中有这样一段代码如上图，前面的parse方法中执行的是 <strong>ImportSelector</strong> ，如果遇到 <strong>DeferredImportSelector</strong> 就会存放到属性 <strong><code>deferredImportSelectorHandler</code></strong> 在对 @Configuration注解解析完成后再一次执行 <strong>DeferredImportSelector</strong> 的实现类。</p><p><strong>两个的功能基本上一样只是执行的时间不同，有延迟的作用。所以在使用的时候根据自定义拓展的使用者来定</strong></p><h3 id=4-factorybean和beanfactory>4. FactoryBean和BeanFactory</h3><p>这个两个类稍微不注意就要搞混了。单词都一样只是顺序变了一下。其实这是两个完全不同的功能两个类。</p><h4 id=41-factorybean>4.1 FactoryBean</h4><p>Spring中的Bean有两种：</p><ul><li><p>普通的bean</p></li><li><p>工厂Bean也就是实现了FactoryBean</p><p>FactoryBean跟普通Bean不同，其返回的对象不是指定类的一个实例，而是该FactoryBean的getObject方法所返回的对象。</p></li></ul><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>FactoryBean</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#000>String</span> <span style=color:#000>OBJECT_TYPE_ATTRIBUTE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;factoryBeanObjectType&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>

	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#000>T</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>;</span>

	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>getObjectType</span><span style=color:#ce5c00;font-weight:700>();</span>

	<span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isSingleton</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>FactoryBean 通常是用来创建比较复杂的bean，一般的bean 直接用xml配置即可或者使用注解，但如果一个bean的创建过程中涉及到很多其他的bean 和复杂的逻辑，用xml配置比较困难，这时可以考虑用FactoryBean</p><p>很多开源项目在集成Spring 时都使用到FactoryBean，比如 <a href="https://link.jianshu.com/?t=https://github.com/mybatis/mybatis-3">MyBatis3</a> 提供 mybatis-spring项目中的 <code>org.mybatis.spring.SqlSessionFactoryBean</code></p><blockquote><p>项目地址：https://github.com/mybatis/spring/blob/master/src/main/java/org/mybatis/spring/SqlSessionFactoryBean.java</p></blockquote><h4 id=42-beanfactory>4.2 BeanFactory</h4><p><strong>BeanFactory</strong> 是Spring Bean容器的顶级接口接口。</p><blockquote><p>文章对你有帮助可以点个赞关注我，你的点赞、关注是我前进的动力，文章有不正确的地方请您斧正留言评论~谢谢！</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-a39748a6b9c4bcc2d5ad12e417ca3f60>5.2 - Spring框架中接口命名的艺术</h1><p>在Spring中有对外的拓展接口或者是内部的接口有很多。这些接口命名有一些规律。以后自己的代码也可以参照Spring的接口命名方式来进行命名。</p><h4 id=applicationcontext和configurableapplicationcontext>ApplicationContext和ConfigurableApplicationContext</h4><p>这两个接口代表了普通接口和 <strong><code>Configurable</code></strong> 前缀的接口。带 <strong><code>Configurable</code></strong> 前缀的表示可以配置，那么可以配置一些什么东西呢？下面来看一下接口的源码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//	ConfigurableApplicationContext
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setParent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>ApplicationContext</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setEnvironment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurableEnvironment</span> <span style=color:#000>environment</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>addBeanFactoryPostProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanFactoryPostProcessor</span> <span style=color:#000>postProcessor</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>addApplicationListener</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationListener</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>listener</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>addProtocolResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ProtocolResolver</span> <span style=color:#000>resolver</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>这一类接口增加了可配置的方法但是又不是仅仅局限于增加可配置的方法，如下面的代码</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//ConfigurableApplicationContext
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>refresh</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerShutdownHook</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-ac130328e68324a2d22762551ddb452b>6 - Spring AOP</h1></div><div class=td-content><h1 id=pg-558555ab5c968a88d9feed5056d11420>6.1 - Spring AOP 源码解析</h1><blockquote><p>Spring framework版本 5.3.x</p></blockquote><h3 id=1-基本概念>1. 基本概念</h3><p>AOP 是面向切面｜面向方面编程的简称，Aspect-Oriented Programming。 Aspect 是一种模块化机制，是用来描述分散在对象，类，函数中的横切关注点。</p><ul><li><strong>基础</strong>： 待增强对象或者目标对象</li><li><strong>切面</strong>： 包含对基础的增强应用</li><li><strong>配置</strong>： 可以看成一种编织，通过在AOP体系中提供这个配置环境，将基础和切面结合起来，从而完成切面对目标对象的编织实现</li><li><strong>Advice（通知）</strong>： 定义在连接点做什么，为切面增强提供织入接口。在Spring AOP 中，它主要描述Spring AOP 围绕方法调用而注入的切面行为。</li><li><strong>Pointcut（切点）</strong>：决定Advice通知应该作用于哪个连接点，也就是说通过Pointcut来定义需要增强的方法集合。</li><li><strong>Advisor（通知器）</strong>：完成对目标方法的切面增强设计（advice）和关注点的设计以后，需要一个对象把它们结合起来，完成这个作用的就是Advisor（通知器）。通过Advisor ，可以定义应该使用那个通知并在哪个关注点使用它。</li></ul><p><img src="https://github.com/mxsm/picture/blob/main/spring/aop/Pointcut,Advice,Advisor%E4%B8%89%E8%80%85%E4%B9%8B%E9%97%B4%E7%9A%84%E5%85%B3%E7%B3%BB.png?raw=true" alt></p><h3 id=2-源码解析>2. 源码解析</h3><blockquote><p>源码解析以注解为分析</p></blockquote><p>通过 <strong><code>@EnableAspectJAutoProxy</code></strong> 注解开开启AOP:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Target</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TYPE</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Retention</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RetentionPolicy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RUNTIME</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Documented</span>
<span style=color:#5c35cc;font-weight:700>@Import</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AspectJAutoProxyRegistrar</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#5c35cc;font-weight:700>@interface</span> <span style=color:#000>EnableAspectJAutoProxy</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>	 * false:表示使用java代理
</span><span style=color:#8f5902;font-style:italic>	 * true：表示使用cglib代理
</span><span style=color:#8f5902;font-style:italic>	 */</span>
	<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>proxyTargetClass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>

	<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>	 * 代理的暴露方式,解决内部调用不能使用代理的场景，默认为false
</span><span style=color:#8f5902;font-style:italic>	 */</span>
	<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>exposeProxy</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>注解使用 <strong><code>@Import</code></strong> 注解引入了 <strong><code>AspectJAutoProxyRegistrar</code></strong> 类，接下来跟踪一下 <strong><code>AspectJAutoProxyRegistrar</code></strong> 类</p><h4 id=21-aspectjautoproxyregistrar源码解析>2.1 AspectJAutoProxyRegistrar源码解析</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AspectJAutoProxyRegistrar</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>ImportBeanDefinitionRegistrar</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span>
			<span style=color:#000>AnnotationMetadata</span> <span style=color:#000>importingClassMetadata</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinitionRegistry</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		
        <span style=color:#8f5902;font-style:italic>//注册AnnotationAwareAspectJAutoProxyCreator
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>AopConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerAspectJAnnotationAutoProxyCreatorIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
		
        <span style=color:#8f5902;font-style:italic>//读取配置的注解EnableAspectJAutoProxy属性
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>AnnotationAttributes</span> <span style=color:#000>enableAspectJAutoProxy</span> <span style=color:#ce5c00;font-weight:700>=</span>
				<span style=color:#000>AnnotationConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>attributesFor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>importingClassMetadata</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>EnableAspectJAutoProxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>enableAspectJAutoProxy</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>enableAspectJAutoProxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBoolean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;proxyTargetClass&#34;</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>AopConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forceAutoProxyCreatorToUseClassProxying</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>enableAspectJAutoProxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBoolean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;exposeProxy&#34;</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>AopConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forceAutoProxyCreatorToExposeProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过源代码发现 <strong><code>AspectJAutoProxyRegistrar</code></strong> 实现了 <strong><code>ImportBeanDefinitionRegistrar</code></strong> 接口，在Spring容器启动的时候会调用 <strong><code>ImportBeanDefinitionRegistrar#registerBeanDefinitions</code></strong> 方法来注入 <strong><code>AnnotationAwareAspectJAutoProxyCreator</code></strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>AopConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerAspectJAnnotationAutoProxyCreatorIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><blockquote><p>注册的Bean名称为:org.springframework.aop.config.internalAutoProxyCreator</p></blockquote><p>最终调用的是 <strong><code>AopConfigUtils#registerOrEscalateApcAsRequired</code></strong> 方法</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Nullable</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>BeanDefinition</span> <span style=color:#000>registerOrEscalateApcAsRequired</span><span style=color:#ce5c00;font-weight:700>(</span>
		<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>cls</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinitionRegistry</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>Object</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;BeanDefinitionRegistry must not be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AUTO_PROXY_CREATOR_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>BeanDefinition</span> <span style=color:#000>apcDefinition</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AUTO_PROXY_CREATOR_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>cls</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>apcDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClassName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>currentPriority</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>findPriorityForClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>apcDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClassName</span><span style=color:#ce5c00;font-weight:700>());</span>
			<span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>requiredPriority</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>findPriorityForClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentPriority</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>requiredPriority</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>apcDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBeanClassName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#000>RootBeanDefinition</span> <span style=color:#000>beanDefinition</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPropertyValues</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;order&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Ordered</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>HIGHEST_PRECEDENCE</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setRole</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ROLE_INFRASTRUCTURE</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AUTO_PROXY_CREATOR_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>到这里 <strong><code>AnnotationAwareAspectJAutoProxyCreator</code></strong> 类注册完成。接下来看 <strong><code>AnnotationAwareAspectJAutoProxyCreator</code></strong> 是如何创建代理类的。</p><h4 id=22-annotationawareaspectjautoproxycreator源码解析>2.2 AnnotationAwareAspectJAutoProxyCreator源码解析</h4><p>首先看一下类的继承关系：</p><p><img src="https://github.com/mxsm/picture/blob/main/spring/aop/AnnotationAwareAspectJAutoProxyCreator.png?raw=true" alt></p><p>通过继承关系发现实现了 <strong><code>SmartInstantiationAwareBeanPostProcessor，BeanFactoryAware，InstantiationAwareBeanPostProcessor，BeanPostProcessor</code></strong>。 下面看一下接口执行的方式：</p><p><img src="https://github.com/mxsm/picture/blob/main/spring/aop/AOP%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B%E5%9B%BE.png?raw=true" alt></p><p><strong><code>AbstractAutoProxyCreator</code></strong> 重写了 <strong><code>BeanPostProcessor#postProcessAfterInitialization方法 和InstantiationAwareBeanPostProcessor#postProcessBeforeInstantiation方法</code></strong> ,接下来详细分析一下这个两个方法：</p><h5 id=221-abstractautoproxycreatorpostprocessbeforeinstantiation>2.2.1 AbstractAutoProxyCreator#postProcessBeforeInstantiation</h5><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>postProcessBeforeInstantiation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>//获取bean的key
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Object</span> <span style=color:#000>cacheKey</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getCacheKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#8f5902;font-style:italic>//判断bean是否已经处理过了，处理了的会放在targetSourcedBeans
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasLength</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>targetSourcedBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>//判断是否包含了advise
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>advisedBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#8f5902;font-style:italic>//判断类型和是否应该跳过
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isInfrastructureClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>shouldSkip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>advisedBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>FALSE</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		
		<span style=color:#000>TargetSource</span> <span style=color:#000>targetSource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getCustomTargetSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>targetSource</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasLength</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>targetSourcedBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#8f5902;font-style:italic>//获取通知和通知器
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>specificInterceptors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getAdvicesAndAdvisorsForBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>targetSource</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#8f5902;font-style:italic>//创建代理
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>Object</span> <span style=color:#000>proxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>specificInterceptors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>targetSource</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>proxyTypes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>());</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h5 id=221-abstractautoproxycreatorpostprocessafterinitialization>2.2.1 AbstractAutoProxyCreator#postProcessAfterInitialization</h5><p>看一下这个方法的调用链：</p><p><img src="https://github.com/mxsm/picture/blob/main/spring/aop/AbstractAutoProxyCreator%23postProcessAfterInitialization%E8%B0%83%E7%94%A8%E9%93%BE.png?raw=true" alt></p><p>下面看一下 <strong><code>AbstractAutoProxyCreator#postProcessAfterInitialization</code></strong> 方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>postProcessAfterInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>Object</span> <span style=color:#000>cacheKey</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getCacheKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlyProxyReferences</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//包装成代理类
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>wrapIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>主要生成代理类的方法是 <code>wrapIfNecessary</code> 下面来看一下具体实现：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>wrapIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    
   	<span style=color:#8f5902;font-style:italic>//创建代理类的前面校验和检测
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasLength</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>targetSourcedBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>FALSE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>advisedBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//判断是否生成代理对象
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isInfrastructureClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>shouldSkip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>advisedBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>FALSE</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#8f5902;font-style:italic>// 获取通知和通知器
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>specificInterceptors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getAdvicesAndAdvisorsForBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>specificInterceptors</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>DO_NOT_PROXY</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>advisedBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TRUE</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>//创建代理对象
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>Object</span> <span style=color:#000>proxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createProxy</span><span style=color:#ce5c00;font-weight:700>(</span>
				<span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>specificInterceptors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SingletonTargetSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>));</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>proxyTypes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>advisedBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>FALSE</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong><code>getAdvicesAndAdvisorsForBean</code></strong> 方法最终调用的是 <strong><code>AbstractAdvisorAutoProxyCreator#getAdvicesAndAdvisorsForBean</code></strong> 方法,进一步调用的是**<code>AbstractAdvisorAutoProxyCreator#findEligibleAdvisors</code>** 方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Advisor</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>findEligibleAdvisors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//查找候选的Advisor
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Advisor</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>candidateAdvisors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>findCandidateAdvisors</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>//过滤出来可用的
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Advisor</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>eligibleAdvisors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>findAdvisorsThatCanApply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidateAdvisors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#000>extendAdvisors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>eligibleAdvisors</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>eligibleAdvisors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>eligibleAdvisors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sortAdvisors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>eligibleAdvisors</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>eligibleAdvisors</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul><li><p><strong>findCandidateAdvisors</strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a40000>#</span><span style=color:#000>AnnotationAwareAspectJAutoProxyCreator实现类</span>
<span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Advisor</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>findCandidateAdvisors</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#8f5902;font-style:italic>// 根据父类规则查找所有的Spring advisor
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Advisor</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>advisors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findCandidateAdvisors</span><span style=color:#ce5c00;font-weight:700>();</span>

	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>aspectJAdvisorsBuilder</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//查找所有的Aspect（标注了注解的@Aspect的Bean) 并且解析
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>advisors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>aspectJAdvisorsBuilder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>buildAspectJAdvisors</span><span style=color:#ce5c00;font-weight:700>());</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>advisors</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li><li><p><strong>findAdvisorsThatCanApply</strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Advisor</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>findAdvisorsThatCanApply</span><span style=color:#ce5c00;font-weight:700>(</span>
      <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Advisor</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>candidateAdvisors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#000>ProxyCreationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCurrentProxiedBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>AopUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findAdvisorsThatCanApply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidateAdvisors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>ProxyCreationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCurrentProxiedBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li></ul><p>到这里这两个方法就分析完成了。当获取到了通知和通知器就开始创建代理对象</p><h5 id=222-abstractautoproxycreatorcreateproxy创建代理类>2.2.2 AbstractAutoProxyCreator#createProxy创建代理类</h5><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>createProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
		<span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>specificInterceptors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TargetSource</span> <span style=color:#000>targetSource</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanFactory</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>ConfigurableListableBeanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>AutoProxyUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>exposeTargetClass</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ConfigurableListableBeanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#8f5902;font-style:italic>//创建代理工厂
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>ProxyFactory</span> <span style=color:#000>proxyFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ProxyFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#000>proxyFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>copyFrom</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>//判断使用jdk代理还是CGLIB代理
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>proxyFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isProxyTargetClass</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>// Explicit handling of JDK proxy targets (for introduction advice scenarios)
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isProxyClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>// Must allow for introductions; can&#39;t just set interfaces to the proxy&#39;s interfaces only.
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>ifc</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInterfaces</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>proxyFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addInterface</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ifc</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>// No proxyTargetClass flag enforced, let&#39;s apply our default checks...
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>shouldProxyTargetClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>proxyFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setProxyTargetClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>evaluateProxyInterfaces</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>proxyFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	
    <span style=color:#8f5902;font-style:italic>//加入通知器
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Advisor</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>advisors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>buildAdvisors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>specificInterceptors</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#000>proxyFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAdvisors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>advisors</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#000>proxyFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTargetSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>targetSource</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#000>customizeProxyFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>proxyFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

	<span style=color:#000>proxyFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setFrozen</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>freezeProxy</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>advisorsPreFiltered</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>proxyFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setPreFiltered</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#8f5902;font-style:italic>// Use original ClassLoader if bean class not locally loaded in overriding class loader
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>ClassLoader</span> <span style=color:#000>classLoader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getProxyClassLoader</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>classLoader</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>SmartClassLoader</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>classLoader</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>classLoader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>SmartClassLoader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>classLoader</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getOriginalClassLoader</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//创建代理对象
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>proxyFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>classLoader</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=3-spring-创建bean的简易流程>3. Spring 创建Bean的简易流程</h3><p><img src="https://github.com/mxsm/picture/blob/main/spring/aop/Spring%20Bean%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B.png?raw=true" alt></p><p>Bean的获取主要是通过BeanFactory获取，但是创建工作主要有BeanPostProcessor完成。代理类的创建就是通过 <strong>AbstractAutoProxyCreator</strong> 类执行实现</p><p>postProcessBeforeInstantiation 方法和 postProcessAfterInitialization 方法来对改变创建对象和对对象进行增强实现代理。</p><h3 id=4-总结>4. 总结</h3><p>Spring AOP的整个启动过程：</p><ul><li>创建 <strong><code>BeanFactoryAdvisorRetrievalHelperAdapter</code></strong> 类(通知器检索适配器)和 <strong><code>BeanFactoryAspectJAdvisorsBuilderAdapter</code></strong> 类</li><li>调用 <strong><code>AbstractAutoProxyCreator#postProcessBeforeInstantiation</code></strong> 方法查找所有的Advisor和切面，将切面构建成Advisor</li><li>调用 <strong><code>AbstractAutoProxyCreator#postProcessAfterInitialization</code></strong> 方法，从缓存取出所有的将所有的增强器，创建代理工厂，并织入增强器，创建代理对象</li></ul><blockquote><p>Tips: 主要是通过实现 postProcessBeforeInstantiation 和 postProcessAfterInitialization 这两个方法来判断是否创建代理对象和如何创建代理</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-807b0f7da57723e93dc2a6125709842a>6.2 - Spring AOP Apis</h1><p>一起养成写作习惯！这是我参与「掘金日新计划 · 4 月更文挑战」的第12天，<a href=https://juejin.cn/post/7080800226365145118>点击查看活动详情</a>。</p><blockquote><p>Spring framework版本 5.3.x</p></blockquote><p>Spring AOP我们用注解比较多，今天我们来看一点不一样的。如何通过API来实现。</p><h3 id=1--pointcut-api>1. Pointcut API</h3><p>先看一下在Spring框架中的继承关系：</p><p><img src="https://github.com/mxsm/picture/blob/main/spring/aop/Pointcut%E7%BB%A7%E6%89%BF%E5%9B%BE.png?raw=true" alt></p><p><strong><code>org.springframework.aop.Pointcut</code></strong> 核心接口用来通知特定的类和方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Pointcut</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#000>ClassFilter</span> <span style=color:#000>getClassFilter</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#000>MethodMatcher</span> <span style=color:#000>getMethodMatcher</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>将Pointcut接口分成两个部分，允许重用类和方法匹配部分以及细粒度的组合操作(例如与另一个方法匹配器执行“联合”)。ClassFilter接口用于将切入点限制为一组给定的目标类。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>ClassFilter</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>matches</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>MethodMatcher接口通常更重要,接口定义如下：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>MethodMatcher</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>matches</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Method</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>targetClass</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isRuntime</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>matches</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Method</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>targetClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>Spring提供了有用的切入点超类来帮助您实现自己的切入点。因为静态切入点是最有用的，所以您可能应该子类化StaticMethodMatcherPointcut。这只需要实现一个抽象方法(尽管您可以覆盖其他方法来定制行为)。下面的示例展示了如何创建StaticMethodMatcherPointcut的子类:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>LogPointcut</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>StaticMethodMatcherPointcut</span><span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>matches</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Method</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>targetClass</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>AnnotatedElementUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasAnnotation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote><p>Tips: 通常我们自定义切入点的话也是通过继承StaticMethodMatcherPointcut类来实现。</p><p>例子参考github项目：https://github.com/mxsm/mxsm-log4j.git</p></blockquote><h3 id=2-advice-api>2. Advice API</h3><p>Advice的继承关系：</p><p><img src="https://github.com/mxsm/picture/blob/main/spring/aop/Advice%E7%BB%A7%E6%89%BF%E5%9B%BE.png?raw=true" alt></p><p>每一个Advice都是一个Spring Bean。通知实例可以在所有被通知对象之间共享，也可以对每个被通知对象唯一。这对应于每个类或每个实例的通知。</p><h4 id=21-spring-advice-类型>2.1 Spring Advice 类型</h4><p><img src="https://github.com/mxsm/picture/blob/main/spring/aop/Advice%E7%B1%BB%E5%9E%8B.png?raw=true" alt></p><p>advice类型分成上面五类，平时用的比较多的是 <strong><code>Intercepter</code></strong> 和 <strong><code>MethodInterceptor</code></strong> 。</p><h3 id=3-advisor-api>3. Advisor API</h3><p>在Spring中，Advisor是一个方面，它只包含一个与切入点表达式关联的通知对象。除了介绍的特殊情况外，任何advisor都可以与任何Advice一起使用。<strong><code>org.springframework.aop.support.DefaultPointcutAdvisor</code></strong> 是最常用的类在Spring中。</p><p>使用<code>ProxyFactoryBean</code> 创建AOP代理</p><p>参考文档：</p><ul><li><a href=https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#aop-api>https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#aop-api</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-ce28d61df8b9d6bc324acecea0a0316a>6.3 - Spring依赖注入时，什么时候会创建代理类</h1><blockquote><p>用到的代码地址：https://github.com/mxsm/spring-sample/tree/spring-5.3.x/spring-proxy</p></blockquote><h3 id=1-现象>1. 现象</h3><p>第一种情况：</p><p><img src="https://github.com/mxsm/picture/blob/main/spring/aop/proxy1.png?raw=true" alt></p><p>第二种情况：</p><p><img src="https://github.com/mxsm/picture/blob/main/spring/aop/proxy2.png?raw=true" alt></p><p>第三种情况：</p><p><img src="https://github.com/mxsm/picture/blob/main/spring/aop/proxy3.png?raw=true" alt></p><h3 id=2-现象说明>2. 现象说明</h3><p>第一种是最常见的在普通的Spring应用中，会发现 <strong><code>UserService</code></strong> 和 <strong><code>TeacherService</code></strong> 都没有创建代理。这个就是最常见的使用方式。</p><p>第二种是使用了 <strong><code>@EnableAspectJAutoProxy</code></strong> 注解开启了Spring AOP， 发现**<code>UserService</code>** 使用的是JDK代理，**<code>TeacherService</code>** 使用的是CGLIB代理</p><p>第三种是使用了 <strong><code>@EnableAspectJAutoProxy(proxyTargetClass = true)</code></strong> ，会发现 <strong><code>UserService</code></strong> 和 <strong><code>TeacherService</code></strong> 都使用的是CGlib代理</p><p>现象总结：在没有开启AOP的情况下是不会创建代理的，在使用了 <strong><code>@EnableAspectJAutoProxy</code></strong> 默认的情况下接口的代理使用的是JDK代理实现，类的代理使用的CGLIB（jdk不能实现类的代理）。 <strong><code>@EnableAspectJAutoProxy(proxyTargetClass = true)</code></strong> 强制使用CGLIB代理。</p><h3 id=3-源码分析>3. 源码分析</h3><h4 id=31-上面时候会使用代理类>3.1 上面时候会使用代理类</h4><p>通过之前的《Spring AOP 源码解析》可以知道，注解方式下的AOP的创建代理类主要的类是： <strong><code>AnnotationAwareAspectJAutoProxyCreator</code></strong> ，这个类重写了 <strong><code>initBeanFactory</code></strong> 和 <strong><code>findCandidateAdvisors</code></strong> 两个方法：</p><p><strong>initBeanFactory方法</strong>：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>initBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>initBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>aspectJAdvisorFactory</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>aspectJAdvisorFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ReflectiveAspectJAdvisorFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>aspectJAdvisorsBuilder</span> <span style=color:#ce5c00;font-weight:700>=</span>
			<span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanFactoryAspectJAdvisorsBuilderAdapter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>aspectJAdvisorFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>功能：</p><ul><li><p>新建了ReflectiveAspectJAdvisorFactory</p></li><li><p>新建了BeanFactoryAspectJAdvisorsBuilderAdapter</p><p>用来将包含了 <strong><code>@Aspect</code></strong> 注解的Bean构建成一个Advisor</p></li></ul><p><strong>findCandidateAdvisors:</strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Advisor</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>findCandidateAdvisors</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#8f5902;font-style:italic>// Add all the Spring advisors found according to superclass rules.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Advisor</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>advisors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findCandidateAdvisors</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#8f5902;font-style:italic>// Build Advisors for all AspectJ aspects in the bean factory.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>aspectJAdvisorsBuilder</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>advisors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>aspectJAdvisorsBuilder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>buildAspectJAdvisors</span><span style=color:#ce5c00;font-weight:700>());</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>advisors</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>功能：</p><ul><li>查找候选的Advisor(实现了Advisor接口的)</li><li>将 AspectJ的构建成Advisor(@Aspec, @Before等等相关的Aspect的注解解析构建成Advisor)</li></ul><blockquote><p>Tips: 上面的第二种和第三种就是通过自己定义的Advisor来实现的。没有使用Spring的注解例如：@Transactional (事务管理注解)。如果嫌麻烦也可以用这个注解或者其他的AOP的注解来观察上面的三种情况。</p></blockquote><p>所以从上面的代码就能看出来就能知道是否使用代理就是看是否开启了 Spring AOP， 同时对应的类是否包含Aop需要处理的逻辑。例如上面自定义的 <strong><code>@Log</code></strong> 注解或者AspectJ的相关注解。</p><h4 id=32-如何选择jdk代理和cglib代理>3.2 如何选择JDK代理和Cglib代理</h4><p><strong><code>@EnableAspectJAutoProxy(proxyTargetClass = true)</code></strong> 强制使用Cglib代理。但是默认的情况下是怎么样的，我们还是根据看一下源码来分析一下。在创建代理类的时候在 <strong><code>AbstractAutoProxyCreator#createProxy</code></strong> 方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>createProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
		<span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>specificInterceptors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TargetSource</span> <span style=color:#000>targetSource</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanFactory</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>ConfigurableListableBeanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>AutoProxyUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>exposeTargetClass</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ConfigurableListableBeanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#000>ProxyFactory</span> <span style=color:#000>proxyFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ProxyFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#000>proxyFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>copyFrom</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#8f5902;font-style:italic>//设置强制使用Cglib代理
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>proxyFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isProxyTargetClass</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>// Explicit handling of JDK proxy targets (for introduction advice scenarios)
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isProxyClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>// Must allow for introductions; can&#39;t just set interfaces to the proxy&#39;s interfaces only.
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>ifc</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInterfaces</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>proxyFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addInterface</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ifc</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>// 没有proxyTargetClass强制的情况下判断是否使用Cglib代理，这里根据是代理接口还是代理类
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>shouldProxyTargetClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>proxyFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setProxyTargetClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//评估代理接口
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>evaluateProxyInterfaces</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>proxyFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#000>Advisor</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>advisors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>buildAdvisors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>specificInterceptors</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#000>proxyFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAdvisors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>advisors</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#000>proxyFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTargetSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>targetSource</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#000>customizeProxyFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>proxyFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

	<span style=color:#000>proxyFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setFrozen</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>freezeProxy</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>advisorsPreFiltered</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>proxyFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setPreFiltered</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#8f5902;font-style:italic>// Use original ClassLoader if bean class not locally loaded in overriding class loader
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>ClassLoader</span> <span style=color:#000>classLoader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getProxyClassLoader</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>classLoader</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>SmartClassLoader</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>classLoader</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>classLoader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>SmartClassLoader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>classLoader</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getOriginalClassLoader</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//创建代理类
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>proxyFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>classLoader</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ol><li>根据 <strong><code>proxyTargetClass</code></strong> 标记来判断是否强制使用Cglib来创建代理</li><li>如果没有设置 <strong><code>proxyTargetClass=true</code></strong> 就根据是代理接口还是代理类来动态处理选择代理方式</li><li>创建代理类返回</li></ol><h3 id=4-总结>4. 总结</h3><ul><li>在没有开启AOP的时候如果不自己定义是不会使用和创建代理类。 也就是使用我们平时使用的不同类实例</li><li><strong><code>@EnableAspectJAutoProxy(proxyTargetClass = true)</code></strong> 强制所有的方式都使用Cglib进行代理</li><li><strong><code>@EnableAspectJAutoProxy</code></strong> 默认情况下会根据情况来判断是否创建代理类，和用Jdk代理实现还是Cglib实现</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-7eb10bd6dd8654757eef56a3b2f75658>6.4 - Spring AOP应用之Spring事务管理</h1><blockquote><p>Spring framework版本 5.3.x</p></blockquote><h3 id=1-核心对象的关系>1. 核心对象的关系</h3><p><img src="https://github.com/mxsm/picture/blob/main/spring/aop/%E4%BA%8B%E5%8A%A1%E7%9B%B8%E5%85%B3%E7%B1%BB%E7%9A%84%E5%8A%9F%E8%83%BD%E5%9B%BE.png?raw=true" alt=//tu></p><p>如上图可以看出来注解 <strong><code>@EnableTransactionManagement</code></strong> 负责开启事务管理，然后通过 <strong><code>TransactionManagementConfigurationSelector</code></strong> 注入下面两个类：</p><ul><li><p>AutoProxyRegistrar</p><p>负责创建代理类</p></li><li><p>ProxyTransactionManagementConfiguration</p><p>负责创建事务管理的逻辑(Spring AOP)</p><ul><li><p>BeanFactoryTransactionAttributeSourceAdvisor</p><p>Spring AOP中的Advisor</p></li><li><p>TransactionAttributeSource</p><p>Spring AOP中的Pointcut</p></li><li><p>TransactionInterceptor</p><p>Spring AOP中的advice</p></li></ul></li></ul><p>这样就能看得出来事务管理其实就是Spring AOP的一个应用实现。</p><h3 id=2-注解事务运行流程>2. 注解事务运行流程</h3><p>Spring注解事务管理运行流程图：</p><p><img src="https://github.com/mxsm/picture/blob/main/spring/aop/%E4%BA%8B%E5%8A%A1%E5%90%AF%E5%8A%A8%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B.png?raw=true" alt></p><h3 id=3-源码解析>3. 源码解析</h3><p>源码从事务管理AOP的三个组件来分析，下面就会分别是：</p><ul><li>[TransactionAttributeSource (Poincut)](#3.1 TransactionAttributeSource 源码解析)</li><li>[TransactionInterceptor(Advice)](#3.2 TransactionInterceptor源码解析)</li><li>BeanFactoryTransactionAttributeSourceAdvisor(Advisor)</li></ul><h4 id=31-transactionattributesource-源码解析>3.1 TransactionAttributeSource 源码解析</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AnnotationTransactionAttributeSource</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractFallbackTransactionAttributeSource</span>
		<span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Serializable</span> <span style=color:#ce5c00;font-weight:700>{</span>
    
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>publicMethodsOnly</span><span style=color:#ce5c00;font-weight:700>;</span>
    
	<span style=color:#8f5902;font-style:italic>//省略代码
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>AnnotationTransactionAttributeSource</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>AnnotationTransactionAttributeSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>publicMethodsOnly</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>publicMethodsOnly</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>publicMethodsOnly</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>jta12Present</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>ejb3Present</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>annotationParsers</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>annotationParsers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SpringTransactionAnnotationParser</span><span style=color:#ce5c00;font-weight:700>());</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>jta12Present</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>annotationParsers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>JtaTransactionAnnotationParser</span><span style=color:#ce5c00;font-weight:700>());</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ejb3Present</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>annotationParsers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Ejb3TransactionAnnotationParser</span><span style=color:#ce5c00;font-weight:700>());</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>annotationParsers</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Collections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SpringTransactionAnnotationParser</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>查看 <strong><code>ProxyTransactionManagementConfiguration</code></strong> 创建 <strong><code>AnnotationTransactionAttributeSource</code></strong> 是使用的无参构造函数。</p><blockquote><p>Tips: 这里调用的是AnnotationTransactionAttributeSource(boolean publicMethodsOnly) 构造函数。这里也就是事务管理只能处理public方法</p></blockquote><p>里面最重要的类就是 <strong><code>SpringTransactionAnnotationParser</code></strong> 注释解析类，其他两个是为了支持java的其他规范。主要的作用就是用来判断当前执行的方法或者类是否包含 <strong><code>@javax.transaction.Transactional，@javax.ejb.TransactionAttribute， @org.springframework.transaction.annotation.Transactional</code></strong> 注解。</p><p>看到这里就会有人问了不是说好的 <strong><code>TransactionAttributeSource</code></strong> 相当于 <strong><code>Pointcut</code></strong> 也没用看到实现了 <strong><code>Pointcut</code></strong> 接口。别急下面来看一下 <strong><code>ProxyTransactionManagementConfiguration</code></strong> 类中有这样的一段代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#5c35cc;font-weight:700>@Bean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>TransactionManagementConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TRANSACTION_ADVISOR_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>)</span>
	<span style=color:#5c35cc;font-weight:700>@Role</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ROLE_INFRASTRUCTURE</span><span style=color:#ce5c00;font-weight:700>)</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BeanFactoryTransactionAttributeSourceAdvisor</span> <span style=color:#000>transactionAdvisor</span><span style=color:#ce5c00;font-weight:700>(</span>
			<span style=color:#000>TransactionAttributeSource</span> <span style=color:#000>transactionAttributeSource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TransactionInterceptor</span> <span style=color:#000>transactionInterceptor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

		<span style=color:#000>BeanFactoryTransactionAttributeSourceAdvisor</span> <span style=color:#000>advisor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanFactoryTransactionAttributeSourceAdvisor</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#000>advisor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTransactionAttributeSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>transactionAttributeSource</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>advisor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAdvice</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>transactionInterceptor</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>enableTx</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>advisor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setOrder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>enableTx</span><span style=color:#ce5c00;font-weight:700>.&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000>getNumber</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;order&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>advisor</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>将 <strong><code>TransactionAttributeSource</code></strong> 的实现类设置为 <strong><code>BeanFactoryTransactionAttributeSourceAdvisor</code></strong> 的一个属性。(这里其实就是AnnotationTransactionAttributeSource的实例)。下面看一下 <strong><code>BeanFactoryTransactionAttributeSourceAdvisor</code></strong> 类里面有这样的一段代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>TransactionAttributeSourcePointcut</span> <span style=color:#000>pointcut</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TransactionAttributeSourcePointcut</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#5c35cc;font-weight:700>@Override</span>
		<span style=color:#5c35cc;font-weight:700>@Nullable</span>
		<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>TransactionAttributeSource</span> <span style=color:#000>getTransactionAttributeSource</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>transactionAttributeSource</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>};</span>
</code></pre></div><p>这不就变成了 <strong><code>Pointcut</code></strong> 了。不是直接继承了接口 <strong><code>Pointcut</code></strong> 而是通过上面代码的方式间接的变成Poincut。看一下**<code>TransactionAttributeSourcePointcut</code>** 代码</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TransactionAttributeSourcePointcut</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>StaticMethodMatcherPointcut</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Serializable</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#8f5902;font-style:italic>//省略代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过包装了 <strong><code>AnnotationTransactionAttributeSource</code></strong> 变成 Pointcut</p><h4 id=32-transactioninterceptor源码解析>3.2 TransactionInterceptor源码解析</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TransactionInterceptor</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>TransactionAspectSupport</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>MethodInterceptor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Serializable</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//省略代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从上面可以看到实现了接口 <strong><code>MethodInterceptor</code></strong> ，那么主要的逻辑就在 <strong><code>MethodInterceptor#invoke</code></strong> 方法中。 TransactionInterceptor实现了 invoke 接口：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#5c35cc;font-weight:700>@Nullable</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MethodInvocation</span> <span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#8f5902;font-style:italic>//获取到目标类
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>targetClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getThis</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>AopUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTargetClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getThis</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>

	<span style=color:#8f5902;font-style:italic>// Adapt to TransactionAspectSupport&#39;s invokeWithinTransaction...
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>invokeWithinTransaction</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethod</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>targetClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CoroutinesInvocationCallback</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#5c35cc;font-weight:700>@Override</span>
		<span style=color:#5c35cc;font-weight:700>@Nullable</span>
		<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>proceedWithInvocation</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>proceed</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#5c35cc;font-weight:700>@Override</span>
		<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getTarget</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getThis</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#5c35cc;font-weight:700>@Override</span>
		<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>getArguments</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getArguments</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>});</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>找到调用的目标类，然后调用 <strong><code>TransactionAspectSupport</code></strong> 类的 <strong><code>invokeWithinTransaction</code></strong> 方法。 这个方法也是主要的处理逻辑：</p><p><img src="https://github.com/mxsm/picture/blob/main/spring/aop/TransactionAspectSupport%23invokeWithinTransaction%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B.png?raw=true" alt></p><p>根据 <strong><code>TransactionAttributeSource</code></strong> 来决定使用 <strong><code>ReactiveTransactionManager</code></strong> 还是 <strong><code>PlatformTransactionManager</code></strong> （这里只分析PlatformTransactionManager）。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>TransactionInfo</span> <span style=color:#000>txInfo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createTransactionIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ptm</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>txAttr</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>joinpointIdentification</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>根据 PlatformTransactionManager，TransactionAttributeSource和切入点方法去处理事务管理如何创建，下面看一下 TransactionAspectSupport#createTransactionIfNecessary方法，里面有一段代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>TransactionInfo</span> <span style=color:#000>createTransactionIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>PlatformTransactionManager</span> <span style=color:#000>tm</span><span style=color:#ce5c00;font-weight:700>,</span>
			<span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>TransactionAttribute</span> <span style=color:#000>txAttr</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>joinpointIdentification</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>//省略部分代码
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>TransactionStatus</span> <span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>txAttr</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tm</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>//这段代码
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tm</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTransaction</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>txAttr</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
				
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>prepareTransactionInfo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tm</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>txAttr</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>joinpointIdentification</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>status</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>事务管理器根据 <strong><code>TransactionAttributeSource</code></strong> 获取事务状态 <strong><code>TransactionStatus</code></strong> 。</p><p><strong><code>status = tm.getTransaction(txAttr)</code></strong> 这段代码里面说明了根据注解 <strong><code>@Transactional</code></strong> 当中的属性如何创建事务，最好包装成 <strong><code>TransactionStatus</code></strong> 。下面来分析这一段代码，由 <strong><code>AbstractPlatformTransactionManager</code></strong> 实现了方法 <strong><code>getTransaction</code></strong> 。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>TransactionStatus</span> <span style=color:#000>getTransaction</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>TransactionDefinition</span> <span style=color:#000>definition</span><span style=color:#ce5c00;font-weight:700>)</span>
			<span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>TransactionException</span> <span style=color:#ce5c00;font-weight:700>{</span>

		<span style=color:#8f5902;font-style:italic>// 没有事务定义给出就使用默认的
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>TransactionDefinition</span> <span style=color:#000>def</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>definition</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>definition</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>TransactionDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>withDefaults</span><span style=color:#ce5c00;font-weight:700>());</span>

        <span style=color:#8f5902;font-style:italic>//获取事务
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>Object</span> <span style=color:#000>transaction</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>doGetTransaction</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>debugEnabled</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>();</span>
		
        <span style=color:#8f5902;font-style:italic>//判断事务是否存在
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isExistingTransaction</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>transaction</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>// Existing transaction found -&gt; check propagation behavior to find out how to behave.
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>handleExistingTransaction</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>transaction</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>debugEnabled</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>// 检查新的事务配置
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTimeout</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>TransactionDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TIMEOUT_DEFAULT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InvalidTimeoutException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Invalid transaction timeout&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTimeout</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>// No existing transaction found -&gt; check propagation behavior to find out how to proceed.
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPropagationBehavior</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>TransactionDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PROPAGATION_MANDATORY</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalTransactionStateException</span><span style=color:#ce5c00;font-weight:700>(</span>
					<span style=color:#4e9a06>&#34;No existing transaction found for transaction marked with propagation &#39;mandatory&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPropagationBehavior</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>TransactionDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PROPAGATION_REQUIRED</span> <span style=color:#ce5c00;font-weight:700>||</span>
				<span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPropagationBehavior</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>TransactionDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PROPAGATION_REQUIRES_NEW</span> <span style=color:#ce5c00;font-weight:700>||</span>
				<span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPropagationBehavior</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>TransactionDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PROPAGATION_NESTED</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>SuspendedResourcesHolder</span> <span style=color:#000>suspendedResources</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>suspend</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>debugEnabled</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Creating new transaction with name [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>startTransaction</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>transaction</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>debugEnabled</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>suspendedResources</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RuntimeException</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>Error</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>resume</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>suspendedResources</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>// Create &#34;empty&#34; transaction: no actual transaction, but potentially synchronization.
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getIsolationLevel</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>TransactionDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ISOLATION_DEFAULT</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isWarnEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Custom isolation level specified but no actual transaction initiated; &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
						<span style=color:#4e9a06>&#34;isolation level will effectively be ignored: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>newSynchronization</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getTransactionSynchronization</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>SYNCHRONIZATION_ALWAYS</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>prepareTransactionStatus</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>newSynchronization</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>debugEnabled</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面就是根据设置的事务的传播行为来对事务作出处理。事务的传播行为如下：</p><ul><li><p>@Transactional(propagation=Propagation.REQUIRED) ：如果有事务, 那么加入事务, 没有的话新建一个(默认情况下)</p></li><li><p>@Transactional(propagation=Propagation.NOT_SUPPORTED) ：以非事务方式执行，如果存在当前事务，则挂起当前事务</p></li><li><p>@Transactional(propagation=Propagation.REQUIRES_NEW) ：不管是否存在事务,都创建一个新的事务,原来的挂起,新的执行完毕,继续执行老的事务</p></li><li><p>@Transactional(propagation=Propagation.MANDATORY) ：必须在一个已有的事务中执行,否则抛出异常</p></li><li><p>@Transactional(propagation=Propagation.NEVER) ：以非事务方式执行，如果存在事务则抛出异常。</p></li><li><p>@Transactional(propagation=Propagation.SUPPORTS) ：如果其他bean调用这个方法,在其他bean中声明事务,那就用事务.如果其他bean没有声明事务,那就不用事务.</p></li><li><p>@Transactional(propagation=Propagation.NESTED) ： 如果当前存在事务，则在嵌套事务内执行。如果当前没有事务，则进行PROPAGATION_REQUIRED类似的操作。</p></li></ul><p>创建完成 <strong><code>TransactionInfo</code></strong> 后就开始执行业务逻辑方法，如果执行业务逻辑报错那么就执行：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>completeTransactionAfterThrowing</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>txInfo</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>然后在 finally 代码块中执行：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>cleanupTransactionInfo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>txInfo</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>清除事务的信息，提交事务。到这里整个事务就基本上完成了。</p><h4 id=33-beanfactorytransactionattributesourceadvisor源码解析>3.3 BeanFactoryTransactionAttributeSourceAdvisor源码解析</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BeanFactoryTransactionAttributeSourceAdvisor</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractBeanFactoryPointcutAdvisor</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>TransactionAttributeSource</span> <span style=color:#000>transactionAttributeSource</span><span style=color:#ce5c00;font-weight:700>;</span>

	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>TransactionAttributeSourcePointcut</span> <span style=color:#000>pointcut</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TransactionAttributeSourcePointcut</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#5c35cc;font-weight:700>@Override</span>
		<span style=color:#5c35cc;font-weight:700>@Nullable</span>
		<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>TransactionAttributeSource</span> <span style=color:#000>getTransactionAttributeSource</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>transactionAttributeSource</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>};</span>


	<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>	 * Set the transaction attribute source which is used to find transaction
</span><span style=color:#8f5902;font-style:italic>	 * attributes. This should usually be identical to the source reference
</span><span style=color:#8f5902;font-style:italic>	 * set on the transaction interceptor itself.
</span><span style=color:#8f5902;font-style:italic>	 * @see TransactionInterceptor#setTransactionAttributeSource
</span><span style=color:#8f5902;font-style:italic>	 */</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setTransactionAttributeSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TransactionAttributeSource</span> <span style=color:#000>transactionAttributeSource</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>transactionAttributeSource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>transactionAttributeSource</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>	 * Set the {@link ClassFilter} to use for this pointcut.
</span><span style=color:#8f5902;font-style:italic>	 * Default is {@link ClassFilter#TRUE}.
</span><span style=color:#8f5902;font-style:italic>	 */</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setClassFilter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassFilter</span> <span style=color:#000>classFilter</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pointcut</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setClassFilter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>classFilter</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Pointcut</span> <span style=color:#000>getPointcut</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pointcut</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这个类比较简单就是将Advice和Pointcut组装成Advisor</p><h3 id=4-总结>4. 总结</h3><p>Spring事务管理底层使用的是AOP的原理来实现。结合数据库的事务来的。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-cef5de8587a30a40ec12e9e6e8ebbd48>6.5 - Spring AOP应用之EnableAsync</h1><blockquote><p>Spring framework版本 5.3.x</p></blockquote><h3 id=1-异步核心类>1. 异步核心类</h3><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/spring/aop/EnableAsync%E5%85%B3%E7%B3%BB.png alt=EnableAsync关系></p><ul><li><p><strong>@EnableAsync</strong></p><p>开启Spring的异步功能</p></li><li><p><strong>AsyncConfigurationSelector</strong></p><p>导入异步功能的配置和处理相关的类</p></li><li><p><strong>ProxyAsyncConfiguration</strong></p><p>代理异步配置类，设置了执行线程池、异步错误的处理器，以及AOP相关的三个类</p></li><li><p><strong>AsyncAnnotationBeanPostProcessor</strong></p><p>处理标记了@Async类和方法（也就是Spring AOP）</p></li><li><p><strong>AOP的三大组件</strong></p><p>AsyncAnnotationAdvisor、AnnotationMatchingPointcut、AnnotationAsyncExecutionInterceptor</p></li></ul><h3 id=2-源码分析>2. 源码分析</h3><h4 id=21-enableasync源码解析>2.1 @EnableAsync源码解析</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Target</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TYPE</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Retention</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RetentionPolicy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RUNTIME</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Documented</span>
<span style=color:#5c35cc;font-weight:700>@Import</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AsyncConfigurationSelector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#5c35cc;font-weight:700>@interface</span> <span style=color:#000>EnableAsync</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#8f5902;font-style:italic>//设置自定义的注解
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Annotation</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>annotation</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>default</span> <span style=color:#000>Annotation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>;</span>
	
	<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>proxyTargetClass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>

	<span style=color:#000>AdviceMode</span> <span style=color:#000>mode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>default</span> <span style=color:#000>AdviceMode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PROXY</span><span style=color:#ce5c00;font-weight:700>;</span>

	<span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>order</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>default</span> <span style=color:#000>Ordered</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>LOWEST_PRECEDENCE</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从上面可以看出主要使用了 <strong><code>AsyncConfigurationSelector</code></strong> 来导入选择导入配置类，下面来看一下</p><h4 id=22-asyncconfigurationselector源码解析>2.2 AsyncConfigurationSelector源码解析</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AsyncConfigurationSelector</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AdviceModeImportSelector</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>EnableAsync</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>ASYNC_EXECUTION_ASPECT_CONFIGURATION_CLASS_NAME</span> <span style=color:#ce5c00;font-weight:700>=</span>
			<span style=color:#4e9a06>&#34;org.springframework.scheduling.aspectj.AspectJAsyncConfiguration&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>

	<span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#5c35cc;font-weight:700>@Nullable</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>selectImports</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AdviceMode</span> <span style=color:#000>adviceMode</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>switch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>adviceMode</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>PROXY</span><span style=color:#ce5c00;font-weight:700>:</span>
				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>ProxyAsyncConfiguration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()};</span>
			<span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>ASPECTJ</span><span style=color:#ce5c00;font-weight:700>:</span>
				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>ASYNC_EXECUTION_ASPECT_CONFIGURATION_CLASS_NAME</span><span style=color:#ce5c00;font-weight:700>};</span>
			<span style=color:#204a87;font-weight:700>default</span><span style=color:#ce5c00;font-weight:700>:</span>
				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在这里主要导入了配置 <strong><code>ProxyAsyncConfiguration</code></strong> 。这个类主要的作用也是导入配置类。接着来看一下配置类。</p><h4 id=23-proxyasyncconfiguration源码解析>2.3 ProxyAsyncConfiguration源码解析</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Configuration</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>proxyBeanMethods</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Role</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ROLE_INFRASTRUCTURE</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ProxyAsyncConfiguration</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractAsyncConfiguration</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#5c35cc;font-weight:700>@Bean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>TaskManagementConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ASYNC_ANNOTATION_PROCESSOR_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>)</span>
	<span style=color:#5c35cc;font-weight:700>@Role</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ROLE_INFRASTRUCTURE</span><span style=color:#ce5c00;font-weight:700>)</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>AsyncAnnotationBeanPostProcessor</span> <span style=color:#000>asyncAdvisor</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>enableAsync</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;@EnableAsync annotation metadata was not injected&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>AsyncAnnotationBeanPostProcessor</span> <span style=color:#000>bpp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AsyncAnnotationBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#000>bpp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>executor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>exceptionHandler</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Annotation</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>customAsyncAnnotation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>enableAsync</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;annotation&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>customAsyncAnnotation</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>AnnotationUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDefaultValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>EnableAsync</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;annotation&#34;</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>bpp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAsyncAnnotationType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>customAsyncAnnotation</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#000>bpp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setProxyTargetClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>enableAsync</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBoolean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;proxyTargetClass&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
		<span style=color:#000>bpp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setOrder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>enableAsync</span><span style=color:#ce5c00;font-weight:700>.&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000>getNumber</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;order&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bpp</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong><code>ProxyAsyncConfiguration</code></strong> 配置继承了 <strong><code>AbstractAsyncConfiguration</code></strong> 。整个主要做了三件事情：</p><ul><li><p>ProxyAsyncConfiguration创建了AsyncAnnotationBeanPostProcessor。AsyncAnnotationBeanPostProcessor主要用来实现AOP</p></li><li><p>AbstractAsyncConfiguration主要设置了异步执行的线程池Executor，和执行报错没有捕捉到的错误的处理器 AsyncUncaughtExceptionHandler</p><p>Executor和AsyncUncaughtExceptionHandler可以通过AsyncConfigurer来进行配置。</p><blockquote><p>Tpis: AsyncConfigurer只能配置一个</p></blockquote></li></ul><h4 id=24-asyncannotationbeanpostprocessor源码解析>2.4 AsyncAnnotationBeanPostProcessor源码解析</h4><p>在类中有这样的一段代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

		<span style=color:#000>AsyncAnnotationAdvisor</span> <span style=color:#000>advisor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AsyncAnnotationAdvisor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>executor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>exceptionHandler</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>asyncAnnotationType</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>advisor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAsyncAnnotationType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>asyncAnnotationType</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#000>advisor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>advisor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>advisor</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div><p>创建一个 <strong><code>AsyncAnnotationAdvisor</code></strong> 。看一下使用的构造函数：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AsyncAnnotationAdvisor</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractPointcutAdvisor</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>BeanFactoryAware</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Advice</span> <span style=color:#000>advice</span><span style=color:#ce5c00;font-weight:700>;</span>

	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Pointcut</span> <span style=color:#000>pointcut</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#8f5902;font-style:italic>//省略了部分代码
</span><span style=color:#8f5902;font-style:italic></span>    
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>AsyncAnnotationAdvisor</span><span style=color:#ce5c00;font-weight:700>(</span>
			<span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>Supplier</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Executor</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>Supplier</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>AsyncUncaughtExceptionHandler</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>exceptionHandler</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

		<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Annotation</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>asyncAnnotationTypes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>asyncAnnotationTypes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Async</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>asyncAnnotationTypes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Annotation</span><span style=color:#ce5c00;font-weight:700>&gt;)</span>
					<span style=color:#000>ClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;javax.ejb.Asynchronous&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>AsyncAnnotationAdvisor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>()));</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassNotFoundException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>// If EJB 3.1 API not present, simply ignore.
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>advice</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>buildAdvice</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>exceptionHandler</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pointcut</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>buildPointcut</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>asyncAnnotationTypes</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从代码可以看出来有两个属性 Advice和Pointcut两个属性加上类本身就是 AOP的三大标准组件。</p><p>设置异步Spring定义注解@Async和javax.ejb.Asynchronous注解。</p><p><strong><code>buildAdvice</code></strong> 用来创建 <strong><code>Advice</code></strong> :</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Advice</span> <span style=color:#000>buildAdvice</span><span style=color:#ce5c00;font-weight:700>(</span>
			<span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>Supplier</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Executor</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>Supplier</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>AsyncUncaughtExceptionHandler</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>exceptionHandler</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

		<span style=color:#000>AnnotationAsyncExecutionInterceptor</span> <span style=color:#000>interceptor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AnnotationAsyncExecutionInterceptor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>interceptor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>exceptionHandler</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>interceptor</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong><code>buildPointcut</code></strong> 来创建 <strong><code>Pointcut</code></strong> :</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Pointcut</span> <span style=color:#000>buildPointcut</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Annotation</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>asyncAnnotationTypes</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>ComposablePointcut</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Annotation</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>asyncAnnotationType</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>asyncAnnotationTypes</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//创建类的Pointcut
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>Pointcut</span> <span style=color:#000>cpc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AnnotationMatchingPointcut</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>asyncAnnotationType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>//创建方法的Pointcut
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>Pointcut</span> <span style=color:#000>mpc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AnnotationMatchingPointcut</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>asyncAnnotationType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ComposablePointcut</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cpc</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>union</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cpc</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>union</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mpc</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>Pointcut</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TRUE</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong><code>Pointcut</code></strong> 分成两类：</p><ul><li>@Async放在类上面</li><li>@Async放在方法上面</li></ul><p>创建完成 <strong><code>AsyncAnnotationAdvisor</code></strong> 后然后设置自定义的异步注解和创建 <strong><code>Pointcut</code></strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setAsyncAnnotationType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Annotation</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>asyncAnnotationType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>asyncAnnotationType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;&#39;asyncAnnotationType&#39; must not be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Annotation</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>asyncAnnotationTypes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
   <span style=color:#000>asyncAnnotationTypes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>asyncAnnotationType</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pointcut</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>buildPointcut</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>asyncAnnotationTypes</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>到这里基本上就完成Advisor的创建。下面就是看如何创建代理类。</p><h4 id=25--abstractadvisingbeanpostprocessorpostprocessafterinitialization创建代理类>2.5 AbstractAdvisingBeanPostProcessor#postProcessAfterInitialization创建代理类</h4><p>和前面的 <strong><code>@EnableAspectJAutoProxy</code></strong> 注解一样都是通过 <strong><code>postProcessAfterInitialization</code></strong> 方法来实现代理类：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>postProcessAfterInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>advisor</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>bean</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>AopInfrastructureBean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>// Ignore AOP infrastructure such as scoped proxies.
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>//判断是否继承了Advised接口
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Advised</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>Advised</span> <span style=color:#000>advised</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Advised</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>advised</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isFrozen</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>isEligible</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AopUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTargetClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#8f5902;font-style:italic>// Add our local Advisor to the existing proxy&#39;s Advisor chain...
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beforeExistingAdvisors</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>advised</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAdvisor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>advisor</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>advised</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAdvisor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>advisor</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		
        <span style=color:#8f5902;font-style:italic>//判断是bean是否符合条件
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isEligible</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>ProxyFactory</span> <span style=color:#000>proxyFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>prepareProxyFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>proxyFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isProxyTargetClass</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>evaluateProxyInterfaces</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>proxyFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#000>proxyFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAdvisor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>advisor</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>customizeProxyFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>proxyFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

			<span style=color:#8f5902;font-style:italic>// Use original ClassLoader if bean class not locally loaded in overriding class loader
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>ClassLoader</span> <span style=color:#000>classLoader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getProxyClassLoader</span><span style=color:#ce5c00;font-weight:700>();</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>classLoader</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>SmartClassLoader</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>classLoader</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>classLoader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>SmartClassLoader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>classLoader</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getOriginalClassLoader</span><span style=color:#ce5c00;font-weight:700>();</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>proxyFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>classLoader</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>// No proxy needed.
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面有两个判断：</p><ul><li>判断是否是 <strong><code>Advised</code></strong> 的实例如果是并且没有冻结并且符合条件的目标类那么将Advisor添加到 Adviced类</li><li>如果是符合条件的类（符合条件：被@Async和配置在 @EnableAsync 的 annotation 属性中的注解）</li></ul><p>这里就完成代理类生成。</p><h4 id=26-异步方法如何执行>2.6 异步方法如何执行</h4><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/spring/aop/image-20211225182531669.png alt=image-20211225182531669></p><p>如上图的类关系图，<strong><code>AsyncExecutionInterceptor</code></strong> 实现了 <strong><code>MethodInterceptor#invoke</code></strong> 方法。</p><p>下面来看一下这个实现方法的代码（AsyncExecutionInterceptor#invoke）：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MethodInvocation</span> <span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>targetClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getThis</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>AopUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTargetClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getThis</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>Method</span> <span style=color:#000>specificMethod</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMostSpecificMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethod</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>targetClass</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Method</span> <span style=color:#000>userDeclaredMethod</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>BridgeMethodResolver</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findBridgedMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>specificMethod</span><span style=color:#ce5c00;font-weight:700>);</span>

		<span style=color:#000>AsyncTaskExecutor</span> <span style=color:#000>executor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>determineAsyncExecutor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userDeclaredMethod</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>executor</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span>
					<span style=color:#4e9a06>&#34;No executor specified and no default executor set on AsyncExecutionInterceptor either&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#000>Callable</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>task</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>Object</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>proceed</span><span style=color:#ce5c00;font-weight:700>();</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ExecutionException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>handleError</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCause</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>userDeclaredMethod</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getArguments</span><span style=color:#ce5c00;font-weight:700>());</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>handleError</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>userDeclaredMethod</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getArguments</span><span style=color:#ce5c00;font-weight:700>());</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>};</span>

		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>doSubmit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethod</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getReturnType</span><span style=color:#ce5c00;font-weight:700>());</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从代码可以看出来有这样几个步骤</p><ul><li>根据执行的方法的具体配置来决定到底使用哪个线程池</li><li>构建 Callable 任务</li><li>提交任务给线程执行</li></ul><h3 id=3-总结>3. 总结</h3><p>对于Spring异步来说，总体的原理还是利用Spring AOP作为基础来实现。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-3cd9b40bbb171ac1d2c0c44255ebae82>7 - spring framework使用过程中的问题</h1></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list"><a class=text-white target=_blank rel="noopener noreferrer" href=https://groups.google.com/u/1/g/ljbmxsm><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=个人掘金主页 aria-label=个人掘金主页><a class=text-white target=_blank rel="noopener noreferrer" href=https://juejin.cn/user/1151943918492855><i class="fab fa-twitter"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/mxsm><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2022 The Docsy Authors All Rights Reserved</small>
<small class=ml-1><a href=https://policies.google.com/privacy target=_blank>隐私政策</a></small><p class=mt-2><a href=/about/>Home</a></p></div></div></div></footer><div><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css><script src=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js></script><script>$("p img").wrap(function(){return'<a data-fancybox="gallery" href="'+$(this).attr('src')+'"></a>'})</script></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/mermaid@8.8.1/dist/mermaid.min.js integrity=sha384-to2w0I1OqmbJ9J6yTnIX+KYU8grNpZoD1dKPLjgEJvMe5L5+/7qvuNa2sQo8WAWj crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/raphael/2.3.0/raphael.min.js integrity="sha512-tBzZQxySO5q5lqwLWfu8Q+o4VkTcRGOeQGVQ0ueJga4A1RKuzmAu5HXDOXLEjpbKyV7ow9ympVoa6wZLEzRzDg==" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.15.0/flowchart.min.js integrity="sha512-6QsSiIybtf8tuZ6xfjRTr2tdtw3Gp4q5RSCh2b6q9seoKEQmhAG1RrCA8F0kXTwivVxRVbp/YF3zOh8rvEAU7Q==" crossorigin=anonymous></script><script src=/js/main.min.b541b310f01941a0abfd76b652b5fb60dac470573775bb5b31ff08fe3f6cea51.js integrity="sha256-tUGzEPAZQaCr/Xa2UrX7YNrEcFc3dbtbMf8I/j9s6lE=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.js></script><script type=text/javascript>docsearch({appId:'JO2SY3WDAC',apiKey:'324ddb3b679c1308e5aa8bf222e07f8b',indexName:'mxsm',inputSelector:'.td-search-input',debug:!1})</script></body></html>