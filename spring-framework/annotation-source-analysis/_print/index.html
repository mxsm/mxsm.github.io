<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.83.1"><link rel=canonical type=text/html href=/spring-framework/annotation-source-analysis/><link rel=alternate type=application/rss+xml href=/spring-framework/annotation-source-analysis/index.xml><meta name=ROBOTS content="INDEX, FOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Spring framework注解源码分析 | 蚂蚁背大象</title><meta property="og:title" content="Spring framework注解源码分析"><meta property="og:description" content="蚂蚁背大象博客"><meta property="og:type" content="website"><meta property="og:url" content="/spring-framework/annotation-source-analysis/"><meta property="og:site_name" content="蚂蚁背大象"><meta itemprop=name content="Spring framework注解源码分析"><meta itemprop=description content="蚂蚁背大象博客"><meta name=twitter:card content="summary"><meta name=twitter:title content="Spring framework注解源码分析"><meta name=twitter:description content="蚂蚁背大象博客"><link rel=preload href=/scss/main.min.e09cb23c7dff3bf1285aa0294bcdc4ac8194fb3425a99c621e31e7b871315685.css as=style><link href=/scss/main.min.e09cb23c7dff3bf1285aa0294bcdc4ac8194fb3425a99c621e31e7b871315685.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 321.39 78.54"><title id="title19">DUBBO LOGO</title><path class="cls-1" d="M68.46 50.38c0 14.06 11.39 22.11 25.45 22.11s25.45-8.05 25.45-22.11V7.25H68.46zm21.24-28h8.6V31H89.7zm0 22.25h8.6v8.6H89.7zM33.24 7.25H4.06v64H33.24c10.95.0 19.3-7.18 23.29-17.15a45.12 45.12.0 002.38-14.87A45.12 45.12.0 0056.53 24.4C52.84 14.62 44.19 7.25 33.24 7.25zm.43 14.63H30.34a3.44 3.44.0 00-3.44 3.44V53.23a3.44 3.44.0 003.44 3.44h3.33v4.63h-8.3a6.87 6.87.0 01-6.87-6.87V24.12a6.87 6.87.0 016.87-6.87h8.3zM285.51 6.06c-17.05.0-30.88 10.28-30.88 33.21s13.83 33.21 30.88 33.21 30.88-10.28 30.88-33.21S302.56 6.06 285.51 6.06zm7.59 48.36a6.87 6.87.0 01-6.87 6.87h-8.3V56.67h3.33a3.44 3.44.0 003.44-3.44V25.31a3.44 3.44.0 00-3.44-3.44h-3.33V17.25h8.3a6.87 6.87.0 016.87 6.87zm-53.4-17.56A17.39 17.39.0 00227.31 7.25H195.1v64h32.21a19.44 19.44.0 0012.38-34.44zM211.63 61.29h-6.08l18.68-44h6.08zM177 36.85A17.39 17.39.0 00164.65 7.25H132.43v64h32.21A19.44 19.44.0 00177 36.85zM149 61.29h-6.08l18.68-44h6.08z" style="fill:#fff;fill-opacity:1"/></svg></span><span class="text-uppercase font-weight-bold">蚂蚁背大象</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/about/><span>Home</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog/><span>Java</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/spring/><span>Spring</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/middlewares/><span>Middleware</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/><span>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/other/><span>Others</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community/><span>Community</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002 站内搜索…" aria-label=站内搜索… autocomplete=off></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/spring-framework/annotation-source-analysis/>Return to the regular view of this page</a>.</p></div><h1 class=title>Spring framework注解源码分析</h1><ul><li>1: <a href=#pg-695935ff0bfbe0f2c238fcb68c3df0c3>Spring注解源码解析之-Autowired和Value</a></li><li>2: <a href=#pg-c8474c1505aab37e3c0c5c83e70ab818>spring注解源码解析之-Conditional</a></li><li>3: <a href=#pg-761d50c98cba02db1ead1d87e662790a>spring注解源码解析之-配置类注解</a></li><li>4: <a href=#pg-ad70ba79c485f9a0ef7697bee60b61d3></a></li><li>5: <a href=#pg-ecd58b2fb8515423e24d130e8b86d39e>Spring 注解解析顺序问题</a></li></ul><div class=content><h2 id=1-spring-framework注解>1 Spring Framework注解</h2><p><img src="https://github.com/mxsm/picture/blob/main/spring/spring-framework%E6%B3%A8%E8%A7%A3%E5%85%A8%E5%9B%BE.png?raw=true" alt=Spring注解></p></div></div><div class=td-content><h1 id=pg-695935ff0bfbe0f2c238fcb68c3df0c3>1 - Spring注解源码解析之-Autowired和Value</h1><h3 id=1-autowired和value注解>1. @Autowired和@Value注解</h3><blockquote><p>源码版本Spring5.2.X</p></blockquote><p>首先来看一下这两个注解的源码</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Target</span><span style=color:#ce5c00;font-weight:700>({</span><span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONSTRUCTOR</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>METHOD</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PARAMETER</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>FIELD</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ANNOTATION_TYPE</span><span style=color:#ce5c00;font-weight:700>})</span>
<span style=color:#5c35cc;font-weight:700>@Retention</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RetentionPolicy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RUNTIME</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Documented</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#5c35cc;font-weight:700>@interface</span> <span style=color:#000>Autowired</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>required</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@Target</span><span style=color:#ce5c00;font-weight:700>({</span><span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>FIELD</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>METHOD</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PARAMETER</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ANNOTATION_TYPE</span><span style=color:#ce5c00;font-weight:700>})</span>
<span style=color:#5c35cc;font-weight:700>@Retention</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RetentionPolicy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RUNTIME</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Documented</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#5c35cc;font-weight:700>@interface</span> <span style=color:#000>Value</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#000>String</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div><p>从上面的源码可以看出来两个注解都可以用于 <strong><code>方法、参数、变量、注解类型</code></strong> 。<strong><code>@Autowired</code></strong> 还能用于构造函数。通过这个类使用的地方可以看出来，主要用于类的内部。所以主要是通过 <strong><code>BeanPostProcessor</code></strong> 来处理这两个注解。</p><h3 id=2-注解处理类autowiredannotationbeanpostprocessor源码解析>2. 注解处理类AutowiredAnnotationBeanPostProcessor源码解析</h3><p>首先看 <em><strong><code>AutowiredAnnotationBeanPostProcessor</code></strong></em> 是如何注入到上下文中的。通过代码发现主要是有 <strong><code>AnnotationConfigUtils#registerAnnotationConfigProcessors</code></strong> 注入到上下文中的。看一下源码</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>registerAnnotationConfigProcessors</span><span style=color:#ce5c00;font-weight:700>(</span>
			<span style=color:#000>BeanDefinitionRegistry</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>Object</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

		<span style=color:#000>DefaultListableBeanFactory</span> <span style=color:#000>beanFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>unwrapDefaultListableBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>//省略代码
</span><span style=color:#8f5902;font-style:italic></span>
        <span style=color:#8f5902;font-style:italic>//注入AutowiredAnnotationBeanPostProcessor类的定义
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>RootBeanDefinition</span> <span style=color:#000>def</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AutowiredAnnotationBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>beanDefs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registerPostProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>));</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#8f5902;font-style:italic>//省略代码
</span><span style=color:#8f5902;font-style:italic></span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>beanDefs</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>下面来看一下 <strong><code>AutowiredAnnotationBeanPostProcessor</code></strong> 源码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AutowiredAnnotationBeanPostProcessor</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>InstantiationAwareBeanPostProcessorAdapter</span>
		<span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>MergedBeanDefinitionPostProcessor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>PriorityOrdered</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanFactoryAware</span> <span style=color:#ce5c00;font-weight:700>{</span>
    
    <span style=color:#8f5902;font-style:italic>//省略代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong><code>AutowiredAnnotationBeanPostProcessor</code></strong> 继承了 <strong><code>InstantiationAwareBeanPostProcessorAdapter</code></strong> 类（这个类是BeanPostProcessor的实现）。然后还实现了其他的三个接口。</p><p>首先来看一下这个类的构造函数：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>AutowiredAnnotationBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>autowiredAnnotationTypes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Autowired</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>autowiredAnnotationTypes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Value</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>autowiredAnnotationTypes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Annotation</span><span style=color:#ce5c00;font-weight:700>&gt;)</span>
					<span style=color:#000>ClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;javax.inject.Inject&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>AutowiredAnnotationBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>()));</span>
			<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;JSR-330 &#39;javax.inject.Inject&#39; annotation found and supported for autowiring&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassNotFoundException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>// JSR-330 API not available - simply skip.
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从这个构造函数可以看出来主要处理 <strong>@Autowired、@Value、javax.inject.Inject</strong> 。 第三个是javax。这就是对 JSR-330 标准的支持。通过调用 <strong><code>postProcessProperties</code></strong> 方法来处理以上的三个注解</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>PropertyValues</span> <span style=color:#000>postProcessProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PropertyValues</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>InjectionMetadata</span> <span style=color:#000>metadata</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>findAutowiringMetadata</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>inject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanCreationException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Injection of autowired dependencies failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>主要是通过 <strong><code>findAutowiringMetadata</code></strong> 方法来获取自动注入元数据。以及通过 <strong><code>InjectionMetadata#inject</code></strong> 方法来注入元数据。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>InjectionMetadata</span> <span style=color:#000>findAutowiringMetadata</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>PropertyValues</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>// Fall back to class name as cache key, for backwards compatibility with custom callers.
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>String</span> <span style=color:#000>cacheKey</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasLength</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#8f5902;font-style:italic>// 从缓存中获取注入元数据
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>InjectionMetadata</span> <span style=color:#000>metadata</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>injectionMetadataCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#8f5902;font-style:italic>//判断是否需要刷新
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InjectionMetadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>needsRefresh</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>injectionMetadataCache</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>metadata</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>injectionMetadataCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InjectionMetadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>needsRefresh</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadata</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#8f5902;font-style:italic>//创建注入元数据
</span><span style=color:#8f5902;font-style:italic></span>					<span style=color:#000>metadata</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>buildAutowiringMetadata</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#8f5902;font-style:italic>//缓存注入元数据
</span><span style=color:#8f5902;font-style:italic></span>					<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>injectionMetadataCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>源代码可以看出来主要是有两个方法：</p><ul><li><p><strong>InjectionMetadata.needsRefresh</strong></p><p>判断从缓存中获取的注入元数据是否需要刷新：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>needsRefresh</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>InjectionMetadata</span> <span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadata</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>targetClass</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li><li><p><strong>buildAutowiringMetadata</strong></p><p>创建自动注入的元数据</p></li></ul><p>下面来看一下 <strong><code>buildAutowiringMetadata</code></strong> 的源码是如何创建自动注入元数据的。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>InjectionMetadata</span> <span style=color:#000>buildAutowiringMetadata</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>//判断是否包含 @Autowired @Value 或者@Inject注解
</span><span style=color:#8f5902;font-style:italic></span>       <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>AnnotationUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isCandidateClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>autowiredAnnotationTypes</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>InjectionMetadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>EMPTY</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>InjectionMetadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>InjectedElement</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>elements</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
		<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>targetClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>;</span>

		<span style=color:#204a87;font-weight:700>do</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>InjectionMetadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>InjectedElement</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>currElements</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
			<span style=color:#8f5902;font-style:italic>//通过反射获取targetClass
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>ReflectionUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doWithLocalFields</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>targetClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>field</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>MergedAnnotation</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>ann</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>findAutowiredAnnotation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ann</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Modifier</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isStatic</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getModifiers</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInfoEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
							<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Autowired annotation is not supported on static fields: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>);</span>
						<span style=color:#ce5c00;font-weight:700>}</span>
						<span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>required</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>determineRequiredStatus</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ann</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#000>currElements</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AutowiredFieldElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>required</span><span style=color:#ce5c00;font-weight:700>));</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>});</span>

			<span style=color:#000>ReflectionUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doWithLocalMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>targetClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>Method</span> <span style=color:#000>bridgedMethod</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>BridgeMethodResolver</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findBridgedMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>BridgeMethodResolver</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isVisibilityBridgeMethodPair</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bridgedMethod</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#000>MergedAnnotation</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>ann</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>findAutowiredAnnotation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bridgedMethod</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ann</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMostSpecificMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Modifier</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isStatic</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getModifiers</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInfoEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
							<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Autowired annotation is not supported on static methods: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>);</span>
						<span style=color:#ce5c00;font-weight:700>}</span>
						<span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterCount</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInfoEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
							<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Autowired annotation should only be used on methods with parameters: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
									<span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>);</span>
						<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>required</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>determineRequiredStatus</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ann</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#000>PropertyDescriptor</span> <span style=color:#000>pd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>BeanUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findPropertyForMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bridgedMethod</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#000>currElements</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AutowiredMethodElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>required</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pd</span><span style=color:#ce5c00;font-weight:700>));</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>});</span>

			<span style=color:#000>elements</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>currElements</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>targetClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>targetClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSuperclass</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>targetClass</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>targetClass</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>

		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>InjectionMetadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forElements</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elements</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过上面的代码可以看出来处理主要分成了两类：</p><ul><li>处理类的字段上面的注解</li><li>处理方法上面注解</li></ul><p>根据处理的不同的数据创建两个不同的自动注入元素。字段的创建 <strong><code>AutowiredFieldElement</code></strong> 、 方法上面的注解创建 <strong><code>AutowiredMethodElement</code></strong> 。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AutowiredFieldElement</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>InjectionMetadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>InjectedElement</span> <span style=color:#ce5c00;font-weight:700>{</span>
 <span style=color:#8f5902;font-style:italic>//省略代码   
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AutowiredMethodElement</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>InjectionMetadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>InjectedElement</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//省略代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>以上两个都是内部类。都继承了 <strong><code>InjectionMetadata.InjectedElement</code></strong> 的接口。根据不同类型创建好以后通过调用：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>InjectionMetadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forElements</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elements</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>创建返回数据。也就是调用 <strong><code>findAutowiringMetadata</code></strong> 方法中的 <strong><code>buildAutowiringMetadata</code></strong> 方法。在前面分析过</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>processInjection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanCreationException</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>clazz</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#000>InjectionMetadata</span> <span style=color:#000>metadata</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>findAutowiringMetadata</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//这里就是注入数据。
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>inject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanCreationException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span>
					<span style=color:#4e9a06>&#34;Injection of autowired dependencies failed for class [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>clazz</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这里可以分一下 <em><strong><code>InjectionMetadata#inject</code></strong></em> 方法</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>inject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>target</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>PropertyValues</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>InjectedElement</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>checkedElements</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>checkedElements</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>InjectedElement</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>elementsToIterate</span> <span style=color:#ce5c00;font-weight:700>=</span>
				<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>checkedElements</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>checkedElements</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>injectedElements</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>elementsToIterate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InjectedElement</span> <span style=color:#000>element</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>elementsToIterate</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTraceEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Processing injected element of bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#8f5902;font-style:italic>//主要是InjectedElement#inject来处理
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>inject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>target</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>最终是通过调用 <em><strong><code>InjectedElement#inject</code></strong></em> 方法来注入。下面来分析一下 <strong>AutowiredFieldElement</strong> 和 <strong>AutowiredMethodElement</strong> 的实现。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AutowiredFieldElement</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>InjectionMetadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>InjectedElement</span> <span style=color:#ce5c00;font-weight:700>{</span>

		<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>required</span><span style=color:#ce5c00;font-weight:700>;</span>

		<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>cached</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>

		<span style=color:#5c35cc;font-weight:700>@Nullable</span>
		<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Object</span> <span style=color:#000>cachedFieldValue</span><span style=color:#ce5c00;font-weight:700>;</span>

		<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>AutowiredFieldElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Field</span> <span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>required</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>required</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>required</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#5c35cc;font-weight:700>@Override</span>
		<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>inject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>PropertyValues</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>Field</span> <span style=color:#000>field</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Field</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>member</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#000>Object</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#8f5902;font-style:italic>//第一次不会进入因为cached默认为false
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cached</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolvedCachedArgument</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cachedFieldValue</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#8f5902;font-style:italic>//创建一个依赖的描述
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>DependencyDescriptor</span> <span style=color:#000>desc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DependencyDescriptor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>required</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#000>desc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setContainingClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>());</span>
				<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>autowiredBeanNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>state</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;No BeanFactory available&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#8f5902;font-style:italic>//获取类型转换器
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>TypeConverter</span> <span style=color:#000>typeConverter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTypeConverter</span><span style=color:#ce5c00;font-weight:700>();</span>
				<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#8f5902;font-style:italic>//获取值
</span><span style=color:#8f5902;font-style:italic></span>					<span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolveDependency</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>desc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>autowiredBeanNames</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>typeConverter</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>UnsatisfiedDependencyException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InjectionPoint</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#8f5902;font-style:italic>//处理依赖注入的数据
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cached</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>required</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
							<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cachedFieldValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>desc</span><span style=color:#ce5c00;font-weight:700>;</span>
							<span style=color:#000>registerDependentBeans</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>autowiredBeanNames</span><span style=color:#ce5c00;font-weight:700>);</span>
							<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>autowiredBeanNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
								<span style=color:#000>String</span> <span style=color:#000>autowiredBeanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>autowiredBeanNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>iterator</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>();</span>
								<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>autowiredBeanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
										<span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTypeMatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>autowiredBeanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getType</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
									<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cachedFieldValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ShortcutDependencyDescriptor</span><span style=color:#ce5c00;font-weight:700>(</span>
											<span style=color:#000>desc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>autowiredBeanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getType</span><span style=color:#ce5c00;font-weight:700>());</span>
								<span style=color:#ce5c00;font-weight:700>}</span>
							<span style=color:#ce5c00;font-weight:700>}</span>
						<span style=color:#ce5c00;font-weight:700>}</span>
						<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
							<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cachedFieldValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
						<span style=color:#ce5c00;font-weight:700>}</span>
						<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cached</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#8f5902;font-style:italic>//在Value不为空的情况下通过反射设置值
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>ReflectionUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>makeAccessible</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><em><strong><code>AutowiredMethodElement</code></strong></em> 的实现和 <em><strong><code>AutowiredFieldElement</code></strong></em> 实现差不多。</p><h3 id=3-自定义拓展>3. 自定义拓展</h3><p>自定义的拓展可以参考一下几个项目：</p><ul><li><a href=https://github.com/mxsm/spring-sample/tree/master/mxsm-nacos>自定义的Nacos的拓展项目地址</a></li><li><a href=https://github.com/nacos-group/nacos-spring-project>阿里巴巴的Nacos项目Spring拓展</a></li></ul><p>第一个项目是自己写的，类似于@Value注解。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-c8474c1505aab37e3c0c5c83e70ab818>2 - spring注解源码解析之-Conditional</h1><h3 id=1-conditional注解的作用>1. Conditional注解的作用</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Target</span><span style=color:#ce5c00;font-weight:700>({</span><span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TYPE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>METHOD</span><span style=color:#ce5c00;font-weight:700>})</span>
<span style=color:#5c35cc;font-weight:700>@Retention</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RetentionPolicy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RUNTIME</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Documented</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#5c35cc;font-weight:700>@interface</span> <span style=color:#000>Conditional</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Condition</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>();</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@FunctionalInterface</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Condition</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>matches</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConditionContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>AnnotatedTypeMetadata</span> <span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>一个是注解、一个是接口。</p><h3 id=2-从源码解析conditional如何发挥作用>2. 从源码解析Conditional如何发挥作用</h3><p>通过源码分析注解 <strong>Conditional</strong> 主要在三个类中。 <strong>AnnotatedBeanDefinitionReader</strong> 、 <strong>ClassPathScanningCandidateComponentProvider</strong> 、 <strong>ConditionEvaluator</strong> 。通过进一步分析发现 <strong>AnnotatedBeanDefinitionReader、ClassPathScanningCandidateComponentProvider</strong> 中都包含了 <strong><code>ConditionEvaluator</code></strong> 类的变量。<strong><code>AnnotatedBeanDefinitionReader</code></strong> 主要用来读取注解的BeanDefinition，而 <strong><code>ClassPathScanningCandidateComponentProvider</code></strong> 主要由 <strong><code>ClassPathBeanDefinitionScanner</code></strong> 继承，该类主要用来扫描class path 的BeanDefinition。下面通过分析一下 <strong><code>ClassPathBeanDefinitionScanner</code></strong> 源码来看一下如何发挥作用的，看一下 <strong><code>ClassPathBeanDefinitionScanner#doScan</code></strong> 方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>doScan</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>basePackages</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    
    <span style=color:#8f5902;font-style:italic>//省略部分代码
</span><span style=color:#8f5902;font-style:italic></span>    
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>basePackage</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>basePackages</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//这个方法来找到候选的BeanDefinition
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinition</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>candidates</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>findCandidateComponents</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>basePackage</span><span style=color:#ce5c00;font-weight:700>);</span>
        
        <span style=color:#8f5902;font-style:italic>//生路部分代码
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>那么再来看一下 <strong>ClassPathScanningCandidateComponentProvider#findCandidateComponents</strong> 方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinition</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>findCandidateComponents</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>basePackage</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>componentsIndex</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>indexSupportsIncludeFilters</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>addCandidateComponentsFromIndex</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>componentsIndex</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>basePackage</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>scanCandidateComponents</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>basePackage</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>进一步分析上面的 <strong>scanCandidateComponents</strong> 和 <strong>addCandidateComponentsFromIndex</strong> 方法发现，这两个方法中都调用了同一个方法 <strong>ClassPathScanningCandidateComponentProvider#isCandidateComponent</strong> ：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isCandidateComponent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MetadataReader</span> <span style=color:#000>metadataReader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
	    <span style=color:#8f5902;font-style:italic>//excludeFilters排除
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TypeFilter</span> <span style=color:#000>tf</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>excludeFilters</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tf</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>match</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadataReader</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getMetadataReaderFactory</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TypeFilter</span> <span style=color:#000>tf</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>includeFilters</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tf</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>match</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadataReader</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getMetadataReaderFactory</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			    <span style=color:#8f5902;font-style:italic>//这个方法就是Conditional注解的实现
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>isConditionMatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadataReader</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isConditionMatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MetadataReader</span> <span style=color:#000>metadataReader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>conditionEvaluator</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>conditionEvaluator</span> <span style=color:#ce5c00;font-weight:700>=</span>
					<span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConditionEvaluator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getRegistry</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>environment</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resourcePatternResolver</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>conditionEvaluator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shouldSkip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadataReader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAnnotationMetadata</span><span style=color:#ce5c00;font-weight:700>());</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过代码分析可以看出来最后是通过调用 <em><strong><code>ConditionEvaluator#shouldSkip</code></strong></em> 的方法来实现的。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>shouldSkip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AnnotatedTypeMetadata</span> <span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>shouldSkip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>shouldSkip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>AnnotatedTypeMetadata</span> <span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>ConfigurationPhase</span> <span style=color:#000>phase</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		
		<span style=color:#8f5902;font-style:italic>//判断是否有注解Conditional
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadata</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAnnotated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Conditional</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>//判断配置解析的类型
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>phase</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			
			<span style=color:#8f5902;font-style:italic>//配置类的类型
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadata</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>AnnotationMetadata</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
					<span style=color:#000>ConfigurationClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isConfigurationCandidate</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>AnnotationMetadata</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>shouldSkip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ConfigurationPhase</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PARSE_CONFIGURATION</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#8f5902;font-style:italic>//bean注册类型
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>shouldSkip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ConfigurationPhase</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>REGISTER_BEAN</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Condition</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>conditions</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>conditionClasses</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>getConditionClasses</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>conditionClass</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>conditionClasses</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>Condition</span> <span style=color:#000>condition</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getCondition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>conditionClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>());</span>
				<span style=color:#000>conditions</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>condition</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#000>AnnotationAwareOrderComparator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sort</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>conditions</span><span style=color:#ce5c00;font-weight:700>);</span>

		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Condition</span> <span style=color:#000>condition</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>conditions</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>ConfigurationPhase</span> <span style=color:#000>requiredPhase</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>condition</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>ConfigurationCondition</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>requiredPhase</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ConfigurationCondition</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>condition</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getConfigurationPhase</span><span style=color:#ce5c00;font-weight:700>();</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#8f5902;font-style:italic>//调用Condition#matches接口来判断是否加载该类
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>requiredPhase</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>requiredPhase</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>phase</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>condition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>matches</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过源码解析就知道了注解@Conditional配合Condition接口在Spring容器中进行条件化加载Bean。这个在SpringBoot中被广泛的应用。</p><blockquote><p>这个条件加载Bean和策略模式差不多。通过不同的策略来加载不同的Bean</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-761d50c98cba02db1ead1d87e662790a>3 - spring注解源码解析之-配置类注解</h1><h3 id=1-spring配置类注解>1. Spring配置类注解</h3><p>在Spring中的配置类主要包含五个注解：</p><ul><li><strong>Component</strong></li><li><strong>ComponentScan</strong></li><li><strong>Import</strong></li><li><strong>ImportResource</strong></li><li><strong>Configuration</strong></li></ul><h3 id=2-spring配置类注解源码解析>2. Spring配置类注解源码解析</h3><p>配置类注解主要是由 <em><strong><code>ConfigurationClassPostProcessor</code></strong></em> 来处理。下面看一下源码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ConfigurationClassPostProcessor</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>BeanDefinitionRegistryPostProcessor</span><span style=color:#ce5c00;font-weight:700>,</span>
		<span style=color:#000>PriorityOrdered</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ResourceLoaderAware</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanClassLoaderAware</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>EnvironmentAware</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//省略各种代码		    
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>实现了 <strong>BeanDefinitionRegistryPostProcessor</strong> 接口。该接口是 <strong>BeanFactoryPostProcessor</strong> 继承而来。这个接口主要用来处理类上面的注解。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>postProcessBeanDefinitionRegistry</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionRegistry</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>registryId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>identityHashCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registriesPostProcessed</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registryId</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span>
					<span style=color:#4e9a06>&#34;postProcessBeanDefinitionRegistry already called on this post-processor against &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>factoriesPostProcessed</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registryId</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span>
					<span style=color:#4e9a06>&#34;postProcessBeanFactory already called on this post-processor against &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registriesPostProcessed</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registryId</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>//处理方法
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>processConfigBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div><p>通过源码可以看出来主要是通过 <strong><em>ConfigurationClassPostProcessor</em>#processConfigBeanDefinitions</strong> 方法处理。下面来看一下方法 <em><strong>processConfigBeanDefinitions</strong></em> 源码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>processConfigBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionRegistry</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>configCandidates</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
    <span style=color:#8f5902;font-style:italic>//获取Bean的定义名称
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>candidateNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinitionNames</span><span style=color:#ce5c00;font-weight:700>();</span>
	
	<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>candidateNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>BeanDefinition</span> <span style=color:#000>beanDef</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDef</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurationClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONFIGURATION_CLASS_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//省略打印日志
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#8f5902;font-style:italic>//判断是否为ConfigurationClass
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurationClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>checkConfigurationClassCandidate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDef</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>metadataReaderFactory</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>configCandidates</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDef</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>));</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#8f5902;font-style:italic>//省略后续处理代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过代码发现主要是通过 <em><strong>ConfigurationClassUtils.checkConfigurationClassCandidate</strong></em> 方法来校验是否为 <strong>ConfigurationClass</strong> 。那么来研究一下方法 <strong>checkConfigurationClassCandidate</strong> ：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>checkConfigurationClassCandidate</span><span style=color:#ce5c00;font-weight:700>(</span>
			<span style=color:#000>BeanDefinition</span> <span style=color:#000>beanDef</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MetadataReaderFactory</span> <span style=color:#000>metadataReaderFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//省略部分代码
</span><span style=color:#8f5902;font-style:italic></span>    
    <span style=color:#8f5902;font-style:italic>//获取是否Configuration修饰的类
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>config</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAnnotationAttributes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>config</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>FALSE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;proxyBeanMethods&#34;</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>beanDef</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CONFIGURATION_CLASS_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CONFIGURATION_CLASS_FULL</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#8f5902;font-style:italic>//判断是否为Component、ComponentScan、Import、ImportResource中的一个
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>config</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>isConfigurationCandidate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>beanDef</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CONFIGURATION_CLASS_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CONFIGURATION_CLASS_LITE</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#8f5902;font-style:italic>//省略部分代码
</span><span style=color:#8f5902;font-style:italic></span>	
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>//isConfigurationCandidate源码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isConfigurationCandidate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AnnotationMetadata</span> <span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>// 判断是否为接口
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInterface</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>// 是否为Component、ComponentScan、Import、ImportResource配置类中的一个
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>indicator</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>candidateIndicators</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAnnotated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>indicator</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>// 查询是否有被@Bean注解修复的方法
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>metadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasAnnotatedMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//省略日志打印
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过源码分析可以发现配置Class分为两类：</p><ul><li><p><strong>full configurationClass</strong></p><p>Spring中称为full configurationClass,这个是由注解@Configuration注解修饰的。</p></li><li><p><strong>lite configurationClass</strong></p><p>Spring中称为lite configurationClass，也就是轻量级的配置类，由注解@Component、@ComponentScan、@Import、@ImportResource</p></li></ul><p>在来看一下 <em><em>ConfigurationClassPostProcessor</em>#<em>processConfigBeanDefinitions</em></em>* 中是如何来处理configurationClass：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>processConfigBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionRegistry</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    
    <span style=color:#8f5902;font-style:italic>//省略代码
</span><span style=color:#8f5902;font-style:italic></span>    
    <span style=color:#8f5902;font-style:italic>//configCandidates的处理代码如下
</span><span style=color:#8f5902;font-style:italic></span>    
    <span style=color:#8f5902;font-style:italic>//ConfigurationClassParser处理类来处理configCandidates
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>ConfigurationClassParser</span> <span style=color:#000>parser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConfigurationClassParser</span><span style=color:#ce5c00;font-weight:700>(</span>
				<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>metadataReaderFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>problemReporter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>environment</span><span style=color:#ce5c00;font-weight:700>,</span>
				<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resourceLoader</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>componentScanBeanNameGenerator</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>

		<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>candidates</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>configCandidates</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ConfigurationClass</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>alreadyParsed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>configCandidates</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#204a87;font-weight:700>do</span> <span style=color:#ce5c00;font-weight:700>{</span>
		    <span style=color:#8f5902;font-style:italic>//解析candidates
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidates</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>validate</span><span style=color:#ce5c00;font-weight:700>();</span>
            
            <span style=color:#8f5902;font-style:italic>//获取解析后的配置类
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ConfigurationClass</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>configClasses</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConfigurationClasses</span><span style=color:#ce5c00;font-weight:700>());</span>
			<span style=color:#000>configClasses</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>removeAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>alreadyParsed</span><span style=color:#ce5c00;font-weight:700>);</span>

			<span style=color:#8f5902;font-style:italic>// 创建解析后的配置类Bean
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reader</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConfigurationClassBeanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>(</span>
						<span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sourceExtractor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resourceLoader</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>environment</span><span style=color:#ce5c00;font-weight:700>,</span>
						<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>importBeanNameGenerator</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getImportRegistry</span><span style=color:#ce5c00;font-weight:700>());</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClasses</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>alreadyParsed</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClasses</span><span style=color:#ce5c00;font-weight:700>);</span>

			<span style=color:#000>candidates</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>
			<span style=color:#8f5902;font-style:italic>//循环处理
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinitionCount</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>candidateNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>newCandidateNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinitionNames</span><span style=color:#ce5c00;font-weight:700>();</span>
				<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>oldCandidateNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>asList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidateNames</span><span style=color:#ce5c00;font-weight:700>));</span>
				<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>alreadyParsedClasses</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
				<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurationClass</span> <span style=color:#000>configurationClass</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>alreadyParsed</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>alreadyParsedClasses</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configurationClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getClassName</span><span style=color:#ce5c00;font-weight:700>());</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>candidateName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>newCandidateNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>oldCandidateNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidateName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#000>BeanDefinition</span> <span style=color:#000>bd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidateName</span><span style=color:#ce5c00;font-weight:700>);</span>
						<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurationClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>checkConfigurationClassCandidate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>metadataReaderFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
								<span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>alreadyParsedClasses</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClassName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
							<span style=color:#000>candidates</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>candidateName</span><span style=color:#ce5c00;font-weight:700>));</span>
						<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#000>candidateNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newCandidateNames</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>candidates</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>());</span>    
    
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过代码分析上面的代码主要处理ConfigurationClass是通过 <em><strong>ConfigurationClassParser</strong></em> 解析器来处理。下面看一下解析器的 <em><strong>ConfigurationClassParser#parse</strong></em> 方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>configCandidates</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionHolder</span> <span style=color:#000>holder</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>configCandidates</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>BeanDefinition</span> <span style=color:#000>bd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>holder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinition</span><span style=color:#ce5c00;font-weight:700>();</span>
			<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>AnnotatedBeanDefinition</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>(((</span><span style=color:#000>AnnotatedBeanDefinition</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>holder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanName</span><span style=color:#ce5c00;font-weight:700>());</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>AbstractBeanDefinition</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>AbstractBeanDefinition</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>hasBeanClass</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>(((</span><span style=color:#000>AbstractBeanDefinition</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getBeanClass</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>holder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanName</span><span style=color:#ce5c00;font-weight:700>());</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClassName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>holder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanName</span><span style=color:#ce5c00;font-weight:700>());</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionStoreException</span><span style=color:#ce5c00;font-weight:700>(</span>
						<span style=color:#4e9a06>&#34;Failed to parse configuration class [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClassName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//处理DeferredImportSelector接口
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>deferredImportSelectorHandler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>process</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过上面代码可以看出来主要是分为两部分：</p><ul><li><p><strong>ConfigurationClassParser#parse ConfigurationClass解析</strong></p><p>ConfigurationClassParser#parse是一个空壳方法，当中调用了一个 ConfigurationClassParser#processConfigurationClass方法</p></li><li><p><strong>DeferredImportSelector接口的处理</strong></p></li></ul><p>下面来分析一下 <strong>ConfigurationClassParser#processConfigurationClass</strong> 方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>processConfigurationClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurationClass</span> <span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//条件加载的判定之前有分析过@Conditional注解
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>conditionEvaluator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shouldSkip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>ConfigurationPhase</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PARSE_CONFIGURATION</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#000>ConfigurationClass</span> <span style=color:#000>existingClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configurationClasses</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>//省略部分代码
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>SourceClass</span> <span style=color:#000>sourceClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>asSourceClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>do</span> <span style=color:#ce5c00;font-weight:700>{</span>
		    <span style=color:#8f5902;font-style:italic>//处理ConfigurationClass
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>sourceClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>doProcessConfigurationClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sourceClass</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>

		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configurationClasses</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>代码分析可以看出来主要是通过 <em><strong>doProcessConfigurationClass</strong></em> 方法来处理ConfigurationClass类：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SourceClass</span> <span style=color:#000>doProcessConfigurationClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurationClass</span> <span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SourceClass</span> <span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>)</span>
			<span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>

		<span style=color:#8f5902;font-style:italic>//@Component注解处理
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isAnnotated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Component</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>processMemberClasses</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>// @PropertySource注解处理
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AnnotationAttributes</span> <span style=color:#000>propertySource</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>AnnotationConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>attributesForRepeatable</span><span style=color:#ce5c00;font-weight:700>(</span>
				<span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>PropertySources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span>
				<span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>springframework</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>annotation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PropertySource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>environment</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>ConfigurableEnvironment</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>processPropertySource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertySource</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#8f5902;font-style:italic>//省略日志打印
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#8f5902;font-style:italic>// @ComponentScan 注解处理
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>AnnotationAttributes</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>componentScans</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>AnnotationConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>attributesForRepeatable</span><span style=color:#ce5c00;font-weight:700>(</span>
				<span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>ComponentScans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ComponentScan</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>componentScans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
				<span style=color:#ce5c00;font-weight:700>!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>conditionEvaluator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shouldSkip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>ConfigurationPhase</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>REGISTER_BEAN</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AnnotationAttributes</span> <span style=color:#000>componentScan</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>componentScans</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#8f5902;font-style:italic>// The config class is annotated with @ComponentScan -&gt; perform the scan immediately
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>scannedBeanDefinitions</span> <span style=color:#ce5c00;font-weight:700>=</span>
						<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>componentScanParser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>componentScan</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getClassName</span><span style=color:#ce5c00;font-weight:700>());</span>
				<span style=color:#8f5902;font-style:italic>// Check the set of scanned definitions for any further config classes and parse recursively if needed
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionHolder</span> <span style=color:#000>holder</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>scannedBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>BeanDefinition</span> <span style=color:#000>bdCand</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>holder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinition</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getOriginatingBeanDefinition</span><span style=color:#ce5c00;font-weight:700>();</span>
					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bdCand</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#000>bdCand</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>holder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinition</span><span style=color:#ce5c00;font-weight:700>();</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurationClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>checkConfigurationClassCandidate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bdCand</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>metadataReaderFactory</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bdCand</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClassName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>holder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanName</span><span style=color:#ce5c00;font-weight:700>());</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>// @Import 注解处理
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>processImports</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getImports</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#8f5902;font-style:italic>// @ImportResource 注解处理
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>AnnotationAttributes</span> <span style=color:#000>importResource</span> <span style=color:#ce5c00;font-weight:700>=</span>
				<span style=color:#000>AnnotationConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>attributesFor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>ImportResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>importResource</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>resources</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>importResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;locations&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BeanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>readerClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>importResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;reader&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>resources</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>String</span> <span style=color:#000>resolvedResource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>environment</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolveRequiredPlaceholders</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addImportedResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolvedResource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>readerClass</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>// @Bean 注解方法处理
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MethodMetadata</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>beanMethods</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>retrieveBeanMethodMetadata</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MethodMetadata</span> <span style=color:#000>methodMetadata</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>beanMethods</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addBeanMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methodMetadata</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>));</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#8f5902;font-style:italic>// 处理默认的接口方法
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>processInterfaces</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>);</span>

		<span style=color:#8f5902;font-style:italic>// 处理父类
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>hasSuperClass</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>String</span> <span style=color:#000>superclass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getSuperClassName</span><span style=color:#ce5c00;font-weight:700>();</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>superclass</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>superclass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>startsWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;java&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
					<span style=color:#ce5c00;font-weight:700>!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>knownSuperclasses</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>superclass</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>knownSuperclasses</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>superclass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#8f5902;font-style:italic>// Superclass found, return its annotation metadata and recurse
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSuperClass</span><span style=color:#ce5c00;font-weight:700>();</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>		
</code></pre></div><p>通上面的代码可以发现主要处理了这样几个注解：</p><ul><li><strong>@Component注解处理</strong></li><li><strong>@PropertySource注解处理</strong></li><li><strong>@ComponentScan 注解处理</strong></li><li><strong>@Import 注解处理</strong></li><li><strong>@ImportResource 注解处理</strong></li><li><strong>@Bean 注解方法处理</strong></li><li><strong>处理默认的接口方法</strong></li><li><strong>处理父类</strong></li></ul><p>分析到这里就可以看出来， <em><strong>ConfigurationClassPostProcessor</strong></em> 类主要是处理一下的几个注解： <strong>Component、PropertySources、PropertySource、ComponentScans、ComponentScan、Import、ImportResource、Bean</strong> 。</p><h3 id=3-configurationclasspostprocessor如何注入到spring-application中>3. ConfigurationClassPostProcessor如何注入到Spring Application中</h3><p>通过 <strong>AnnotationConfigUtils</strong> 类中的静态方法 <strong>registerAnnotationConfigProcessors</strong> 注入：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME</span> <span style=color:#ce5c00;font-weight:700>=</span>
			<span style=color:#4e9a06>&#34;org.springframework.context.annotation.internalConfigurationAnnotationProcessor&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#8f5902;font-style:italic>//
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>RootBeanDefinition</span> <span style=color:#000>def</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurationClassPostProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>beanDefs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registerPostProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>def</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>));</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-ad70ba79c485f9a0ef7697bee60b61d3>4 -</h1><blockquote><p>基于Spring 5.4.2版本分析</p></blockquote><h3 id=1-component概要>1. @Component概要</h3><p>Spring中有一个重要的注解那就是 <strong><code>@Component</code></strong> 。对于Spring中不同场景下使用的注解例如：<strong><code>@Repository</code></strong> 、<strong><code>@Service</code></strong> 、 <strong><code>@Controller</code></strong> 都是通过 <strong><code>@Component</code></strong> 注解衍生出来的。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Target</span><span style=color:#ce5c00;font-weight:700>({</span><span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TYPE</span><span style=color:#ce5c00;font-weight:700>})</span>
<span style=color:#5c35cc;font-weight:700>@Retention</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RetentionPolicy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RUNTIME</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Documented</span>
<span style=color:#5c35cc;font-weight:700>@Component</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#5c35cc;font-weight:700>@interface</span> <span style=color:#000>Service</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#5c35cc;font-weight:700>@AliasFor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>annotation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Component</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span>
	<span style=color:#000>String</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>default</span> <span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在这里代码中还看到一个重要的注解来实现派生： <strong><code>@AliasFor</code></strong> 。</p><h3 id=2-component入口>2. @Component入口</h3><p>不论是现在Spring流行的注解方式还是以前的老式的XML配置方式都有一个入口。这里就只分析注解模式。</p><p>对于XML配置的方式可以从下面的代码中找到入口：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ContextNamespaceHandler</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>NamespaceHandlerSupport</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>init</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>registerBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;property-placeholder&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PropertyPlaceholderBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#000>registerBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;property-override&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PropertyOverrideBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#000>registerBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;annotation-config&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AnnotationConfigBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#000>registerBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;component-scan&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ComponentScanBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#000>registerBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;load-time-weaver&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LoadTimeWeaverBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#000>registerBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;spring-configured&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SpringConfiguredBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#000>registerBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;mbean-export&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MBeanExportBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#000>registerBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;mbean-server&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MBeanServerBeanDefinitionParser</span><span style=color:#ce5c00;font-weight:700>());</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>对于注解方式</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>AnnotationConfigApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>basePackages</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#000>scan</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>basePackages</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>refresh</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>可以看一下 <strong><code>AnnotationConfigApplicationContext</code></strong> 类。</p><p>不管是注解方式还是XML方式最终都是通过 <strong><code>ClassPathBeanDefinitionScanner</code></strong> 类来将包含有 <strong><code>@Component</code></strong> 注解的类定义加载到Spring容器里面。</p><h3 id=3-classpathbeandefinitionscanner解析>3. ClassPathBeanDefinitionScanner解析</h3><p><strong><code>ClassPathBeanDefinitionScanner</code></strong> 作用主要是扫描带有 <strong><code>@Component</code></strong> 注解的类并实现注册。下面来看一下 <strong><code>ClassPathBeanDefinitionScanner#doScan</code></strong> 方法。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>doScan</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>basePackages</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>notEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>basePackages</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;At least one base package must be specified&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>beanDefinitions</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
	<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>basePackage</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>basePackages</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//找基础包下面的候选的Component
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinition</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>candidates</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>findCandidateComponents</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>basePackage</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>//下面是对加载的Component做进一步处理
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinition</span> <span style=color:#000>candidate</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>candidates</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>ScopeMetadata</span> <span style=color:#000>scopeMetadata</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scopeMetadataResolver</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolveScopeMetadata</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setScope</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>scopeMetadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getScopeName</span><span style=color:#ce5c00;font-weight:700>());</span>
			<span style=color:#000>String</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanNameGenerator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>generateBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidate</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>AbstractBeanDefinition</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>postProcessBeanDefinition</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>AbstractBeanDefinition</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidate</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>AnnotatedBeanDefinition</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>AnnotationConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>processCommonDefinitionAnnotations</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>AnnotatedBeanDefinition</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>checkCandidate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>BeanDefinitionHolder</span> <span style=color:#000>definitionHolder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#000>definitionHolder</span> <span style=color:#ce5c00;font-weight:700>=</span>
						<span style=color:#000>AnnotationConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applyScopedProxyMode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>scopeMetadata</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>definitionHolder</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#000>beanDefinitions</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>definitionHolder</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#000>registerBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>definitionHolder</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>beanDefinitions</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过上面的代码可以看出来主要是通过 <strong><code>ClassPathScanningCandidateComponentProvider#findCandidateComponents</code></strong> 来实现加载</p><h3 id=4-findcandidatecomponents解析>4. findCandidateComponents解析</h3><p>findCandidateComponents方法属于ClassPathScanningCandidateComponentProvider#findCandidateComponents。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinition</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>findCandidateComponents</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>basePackage</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>componentsIndex</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>indexSupportsIncludeFilters</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>addCandidateComponentsFromIndex</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>componentsIndex</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>basePackage</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>scanCandidateComponents</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>basePackage</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinition</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>scanCandidateComponents</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>basePackage</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinition</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>candidates</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
	<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>String</span> <span style=color:#000>packageSearchPath</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ResourcePatternResolver</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CLASSPATH_ALL_URL_PREFIX</span> <span style=color:#ce5c00;font-weight:700>+</span>
				<span style=color:#000>resolveBasePackage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>basePackage</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#39;/&#39;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resourcePattern</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#000>Resource</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>resources</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getResourcePatternResolver</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getResources</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>packageSearchPath</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#8f5902;font-style:italic>//省略了部分打印的代码
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Resource</span> <span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>resources</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isReadable</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>MetadataReader</span> <span style=color:#000>metadataReader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getMetadataReaderFactory</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getMetadataReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isCandidateComponent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadataReader</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#000>ScannedGenericBeanDefinition</span> <span style=color:#000>sbd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ScannedGenericBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadataReader</span><span style=color:#ce5c00;font-weight:700>);</span>
						<span style=color:#000>sbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
						<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isCandidateComponent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sbd</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>

							<span style=color:#000>candidates</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sbd</span><span style=color:#ce5c00;font-weight:700>);</span>
						<span style=color:#ce5c00;font-weight:700>}</span>

					<span style=color:#ce5c00;font-weight:700>}</span>

				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionStoreException</span><span style=color:#ce5c00;font-weight:700>(</span>
							<span style=color:#4e9a06>&#34;Failed to read candidate component class: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>

			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IOException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionStoreException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;I/O failure during classpath scanning&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>candidates</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>该方法主要还是从基础包中获取组件。从代码分析一下大概的思路：</p><ol><li>根据基础包拼装扫描的路径正则表达式。</li><li>获取路径下面的 <strong><code>.class</code></strong> 文件包装成 <strong><code>Resource</code></strong> 数组。</li><li>将 <strong><code>.class</code></strong> 文件包装成 <strong><code>Resource</code></strong> 处理成 <strong><code>MetadataReader</code></strong></li><li>判断 <strong><code>MetadataReader</code></strong> 是否为候选组件</li><li>判断 <strong><code>ScannedGenericBeanDefinition</code></strong> 是否为候选组件，<strong><code>ScannedGenericBeanDefinition</code></strong> 由 <strong><code>MetadataReader</code></strong> 构建。</li></ol><p>判断是否为候选组件通过 <strong><code>ClassPathScanningCandidateComponentProvider#isCandidateComponent</code></strong> 方法。</p><h3 id=5-iscandidatecomponent方法解析>5. isCandidateComponent方法解析</h3><p><strong><code>isCandidateComponent</code></strong> 方法在 <strong><code>ClassPathScanningCandidateComponentProvider#isCandidateComponent</code></strong> 类中。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isCandidateComponent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MetadataReader</span> <span style=color:#000>metadataReader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#8f5902;font-style:italic>//省略部分代码
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TypeFilter</span> <span style=color:#000>tf</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>includeFilters</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//判断是否为@Component注解修饰
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tf</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>match</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadataReader</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getMetadataReaderFactory</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>isConditionMatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metadataReader</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在 <strong><code>ClassPathScanningCandidateComponentProvider</code></strong> 初始化的时候回只设置了 <strong><code>@Component</code></strong> 注解。并没有看到 <strong><code>@Repository</code></strong> 、<strong><code>@Service</code></strong> 、 <strong><code>@Controller</code></strong> 这些。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//ClassPathScanningCandidateComponentProvider#registerDefaultFilters
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerDefaultFilters</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>includeFilters</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AnnotationTypeFilter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Component</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>));</span>
	<span style=color:#000>ClassLoader</span> <span style=color:#000>cl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ClassPathScanningCandidateComponentProvider</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>includeFilters</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AnnotationTypeFilter</span><span style=color:#ce5c00;font-weight:700>(</span>
				<span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Annotation</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#000>ClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;javax.annotation.ManagedBean&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cl</span><span style=color:#ce5c00;font-weight:700>)),</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>));</span>
		<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;JSR-250 &#39;javax.annotation.ManagedBean&#39; found and supported for component scanning&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassNotFoundException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>// JSR-250 1.1 API (as included in Java EE 6) not available - simply skip.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>includeFilters</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AnnotationTypeFilter</span><span style=color:#ce5c00;font-weight:700>(</span>
				<span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Annotation</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#000>ClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;javax.inject.Named&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cl</span><span style=color:#ce5c00;font-weight:700>)),</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>));</span>
		<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;JSR-330 &#39;javax.inject.Named&#39; annotation found and supported for component scanning&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassNotFoundException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>// JSR-330 API not available - simply skip.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>前面说过 <strong><code>@Repository</code></strong> 、<strong><code>@Service</code></strong> 、 <strong><code>@Controller</code></strong> 都是通过 <strong><code>@Component</code></strong> 派生来的。</p><h3 id=6-component派生过程解析>6. @Component派生过程解析</h3><p>在 <strong><code>ClassPathScanningCandidateComponentProvider#scanCandidateComponents</code></strong> 有这样一段代码</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>MetadataReader</span> <span style=color:#000>metadataReader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getMetadataReaderFactory</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getMetadataReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MetadataReaderFactory</span> <span style=color:#000>getMetadataReaderFactory</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>metadataReaderFactory</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>metadataReaderFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CachingMetadataReaderFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>metadataReaderFactory</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这一段代码主要是为了获取 <strong><code>MetadataReader</code></strong> 。该接口定义了获取当前类注解的元数据和当前类的元数据。在Spring框架中唯一的实现就是 <strong><code>SimpleMetadataReader</code></strong> 。下面来看一下 <strong><code>SimpleMetadataReader</code></strong> 类的构造函数：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>SimpleMetadataReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Resource</span> <span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>ClassLoader</span> <span style=color:#000>classLoader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#000>SimpleAnnotationMetadataReadingVisitor</span> <span style=color:#000>visitor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SimpleAnnotationMetadataReadingVisitor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>classLoader</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#000>getClassReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>accept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>visitor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>PARSING_OPTIONS</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>annotationMetadata</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>visitor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在构造函数中有两个类：</p><ul><li><p><strong>SimpleAnnotationMetadataReadingVisitor</strong></p><p>主要用于访问注解</p><p><img src="https://github.com/mxsm/picture/blob/main/spring/ClassVisitor.png?raw=true" alt></p></li><li><p><strong>ClassReader</strong></p><p>类读取器，基于ASM框架实现的。</p></li></ul><p>这里我们还可以看一下类的元数据类的继承关系：</p><p><img src="https://github.com/mxsm/picture/blob/main/spring/ClassMetadata.png?raw=true" alt></p><p>在 <strong>SimpleMetadataReader</strong> 类的构造函数中有这样一段代码 <strong>getClassReader(resource).accept(visitor, PARSING_OPTIONS);</strong> 主要是用来类上面的注解。包括注解上面的注解。</p><blockquote><p>getClassReader(resource).accept(visitor, PARSING_OPTIONS)这段代码就是实现了注解派生的关键</p></blockquote><h3 id=7-猜想验证>7. 猜想验证</h3><p>首先写一个Controller</p><p><img src="https://github.com/mxsm/picture/blob/main/spring/%E9%AA%8C%E8%AF%81%E7%8C%9C%E6%83%B31.png?raw=true" alt></p><p>然后在 IDEA设置条件断点：</p><p><img src="https://github.com/mxsm/picture/blob/main/spring/%E9%AA%8C%E8%AF%81%E7%8C%9C%E6%83%B32.png?raw=true" alt></p><p>看一下metadata变量：</p><p><img src="https://github.com/mxsm/picture/blob/main/spring/%E9%AA%8C%E8%AF%81%E7%8C%9C%E6%83%B33.png?raw=true" alt></p><p>然后看一下变量值annotations:</p><p><img src="https://github.com/mxsm/picture/blob/main/spring/%E9%AA%8C%E8%AF%81%E7%8C%9C%E6%83%B34.png?raw=true" alt></p><p>这里可以看出来已经读取到了 <strong><code>AsyncController</code></strong> 类上面的注解，然后在变量中有一个mappings的变量下面来看一下：</p><p><img src="https://github.com/mxsm/picture/blob/main/spring/%E9%AA%8C%E8%AF%81%E7%8C%9C%E6%83%B35.png?raw=true" alt></p><p>这个里面就包含了除了Java的注解以外的所有注解。（这里由于页面的关系不能完全展示）</p><h3 id=8-总结>8. 总结</h3><ul><li>@Component是spring注解的基础</li><li>ClassPathBeanDefinitionScanner扫描制定基础包下面的包含@Component注解</li><li>通过ClassReader（基于ASM实现）来读取类上面所有的注解。</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-ecd58b2fb8515423e24d130e8b86d39e>5 - Spring 注解解析顺序问题</h1><p>在之前的Spring相关文章当中分析过 <strong>BeanPostProcessor</strong> 接口执行顺序问题，今天突然想到在Spring框架中常用的注解也不少。那么注解的解析到底是一个什么样的先后顺序呢？今天就通过源码来分析总结一下Spring常用注解的解析顺序，注解使用的时候应该注意什么？</p><h3 id=1-spring-常用注解>1. Spring 常用注解</h3><p>这里我将Spring常用注解按照添加的位置分成了两类：</p><ul><li>添加在类上</li><li>添加在类的属性或者方法上面</li></ul><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/spring/Spring%E5%B8%B8%E7%94%A8%E6%B3%A8%E8%A7%A3-%E4%BF%AE%E9%A5%B0%E7%B1%BB.jpeg alt=Spring常用注解-修饰类></p><ul><li><p><strong>Bean创建相关的注解</strong></p><p>Bean创建，定义的核心注解就是 <strong><code>@Component</code></strong> 。而 <strong>@Service、@Repository、@Controller</strong> 三个只是 <strong>@Component</strong> 的不同语义下的延伸。本质上还是@Component。 <strong>@Bean</strong> 是配合 <strong>@Configuration</strong> 注解使用的另一类注解。功能和 <strong>@Component</strong> 相似但是对一下创建完全有开发者来创建。</p></li><li><p><strong>配置相关注解</strong></p><p><strong>@Configuration</strong> 毋庸置疑是除了 <strong>@Component</strong> 注解意外最重要的注解之一。原因是很多其他的注解都是依赖 <strong>@Configuration</strong> 注解才能发挥作用。例如上图标号3、4、5、6那些注解都是依赖了它才能发挥作用。修饰的类被当做配置类。</p></li><li><p><strong>属性相关注解</strong></p><p>将注解将properties配置文件中的值存储到Spring的 Environment中</p></li><li><p><strong>扫描相关注解</strong></p><p>根据配置的基础扫描包的路径扫描@Component注解类</p></li><li><p><strong>导入注解</strong></p><p>这个注解算是一个辅助注解，导入一些被@Configuration修饰或者实现了 ImportSelector, ImportBeanDefinitionRegistrar接口的类，或者被 @Component修饰的类。</p></li><li><p><strong>导入资源相关注解</strong></p><p>用于导入Spring的配置文件。</p></li></ul><h3 id=2-类修饰注解解析顺序分析>2. 类修饰注解解析顺序分析</h3><p>Spring注解应用上下文的入口为 <strong><code>AnnotationConfigApplicationContext</code></strong> ，用一段代码作为切入：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>ApplicationContext</span> <span style=color:#000>applicationContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AnnotationConfigApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;com.github.mxsm&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>根据这段代码来逐一分析这些注解的解析，以及解析的顺序。</p><h4 id=21-component注解解析>2.1 @Component注解解析</h4><p><strong>ClassPathBeanDefinitionScanner#scan</strong> 方法负责扫描基础包下面的带有 <strong>@Component</strong> 流程图如下：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/spring/%E6%B3%A8%E8%A7%A3Component%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B%E5%9B%BE.png alt=注解Component解析流程图></p><p>这里也通过设置 <strong>ClassPathBeanDefinitionScanner</strong> 的 includeFilters(TypeFilter) 和excludeFilters(TypeFilter)来判断哪些是Bean哪些需要排除。</p><h4 id=22-configuration注解解析>2.2 @Configuration注解解析</h4><p><strong>@Configuration</strong> 注解的解析主要由 <strong>ConfigurationClassPostProcessor</strong> 负责解析。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//ConfigurationClassPostProcessor#processConfigBeanDefinitions
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>processConfigBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionRegistry</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    
    	<span style=color:#8f5902;font-style:italic>//从Spring容器中获取包含了@Configuration注解的类
</span><span style=color:#8f5902;font-style:italic></span>       <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>candidateNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>BeanDefinition</span> <span style=color:#000>beanDef</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDef</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurationClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONFIGURATION_CLASS_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Bean definition has already been processed as a configuration class: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanDef</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurationClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>checkConfigurationClassCandidate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDef</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>metadataReaderFactory</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>configCandidates</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDef</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>));</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
    	
    	<span style=color:#8f5902;font-style:italic>//没有配置@Configuration的BeanDefinition直接返回不往下解析了
</span><span style=color:#8f5902;font-style:italic></span>       <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configCandidates</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
    
	<span style=color:#8f5902;font-style:italic>//省略了部分代码
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>ConfigurationClassParser</span> <span style=color:#000>parser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConfigurationClassParser</span><span style=color:#ce5c00;font-weight:700>(</span>
				<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>metadataReaderFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>problemReporter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>environment</span><span style=color:#ce5c00;font-weight:700>,</span>
				<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resourceLoader</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>componentScanBeanNameGenerator</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidates</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>validate</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从Spring容器中获取包含了@Configuration注解的类放在列表中。<strong><code>ConfigurationClassParser</code></strong> 负责后续的解析。</p><blockquote><p>Tips：如果包含了@Order注解，会对类进行排序</p></blockquote><p>解析完成@Configuration注解后，解析和@Configuration有依赖的注解。</p><blockquote><p>Tips: <strong>ConfigurationClassUtils.checkConfigurationClassCandidate</strong> 这段代码是检查 BeanDefinition是否包含了@Configuration注解，如果没有那么configCandidates就不会往里面放入BeanDefinition。同时configCandidates如果是空的那么也不需要进行后续解析。</p><p>也就是说：如果没有一个类配置了@Configuration注解，那么依赖@Configuration注解的@PropertySource、@ComponentScan、@Import、@ImportResource、@Bean注解都不会起作用也不被解析</p></blockquote><h4 id=23-其他注解解析>2.3 其他注解解析</h4><p>依赖@Configuration的其他注解都是由 <strong>ConfigurationClassParser#doProcessConfigurationClass</strong> 进行解析,通过代码发现解析的顺序：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//ConfigurationClassParser#doProcessConfigurationClass
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#5c35cc;font-weight:700>@Nullable</span>
<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SourceClass</span> <span style=color:#000>doProcessConfigurationClass</span><span style=color:#ce5c00;font-weight:700>(</span>
		<span style=color:#000>ConfigurationClass</span> <span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SourceClass</span> <span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Predicate</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>filter</span><span style=color:#ce5c00;font-weight:700>)</span>
		<span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#8f5902;font-style:italic>//省略部分代码
</span><span style=color:#8f5902;font-style:italic></span>
	<span style=color:#8f5902;font-style:italic>// Process any @PropertySource annotations (1)
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AnnotationAttributes</span> <span style=color:#000>propertySource</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>AnnotationConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>attributesForRepeatable</span><span style=color:#ce5c00;font-weight:700>(</span>
			<span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>PropertySources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span>
			<span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>springframework</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>annotation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PropertySource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>environment</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>ConfigurableEnvironment</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>processPropertySource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertySource</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#8f5902;font-style:italic>// Process any @ComponentScan annotations (2)
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>AnnotationAttributes</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>componentScans</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>AnnotationConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>attributesForRepeatable</span><span style=color:#ce5c00;font-weight:700>(</span>
			<span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>ComponentScans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ComponentScan</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>componentScans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
			<span style=color:#ce5c00;font-weight:700>!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>conditionEvaluator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shouldSkip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>ConfigurationPhase</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>REGISTER_BEAN</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AnnotationAttributes</span> <span style=color:#000>componentScan</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>componentScans</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>// The config class is annotated with @ComponentScan -&gt; perform the scan immediately
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>scannedBeanDefinitions</span> <span style=color:#ce5c00;font-weight:700>=</span>
					<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>componentScanParser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>componentScan</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getClassName</span><span style=color:#ce5c00;font-weight:700>());</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#8f5902;font-style:italic>// Process any @Import annotations (3)
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>processImports</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getImports</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>filter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>

	<span style=color:#8f5902;font-style:italic>// Process any @ImportResource annotations (4)
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>AnnotationAttributes</span> <span style=color:#000>importResource</span> <span style=color:#ce5c00;font-weight:700>=</span>
			<span style=color:#000>AnnotationConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>attributesFor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetadata</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>ImportResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>importResource</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>resources</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>importResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;locations&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BeanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>readerClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>importResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;reader&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>resources</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>String</span> <span style=color:#000>resolvedResource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>environment</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolveRequiredPlaceholders</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addImportedResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolvedResource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>readerClass</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#8f5902;font-style:italic>// Process individual @Bean methods (5)
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MethodMetadata</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>beanMethods</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>retrieveBeanMethodMetadata</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MethodMetadata</span> <span style=color:#000>methodMetadata</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>beanMethods</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addBeanMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methodMetadata</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>));</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#8f5902;font-style:italic>// Process default methods on interfaces
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>processInterfaces</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sourceClass</span><span style=color:#ce5c00;font-weight:700>);</span>

	<span style=color:#8f5902;font-style:italic>// No superclass -&gt; processing is complete
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面代码中的标号揭示了解析顺序：</p><p>（1）解析@PropertySource</p><p>（2）解析@ComponentScan</p><p>（3）解析@Import</p><p>（4）解析@ImportResource</p><p>（5）解析@Bean</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/spring/ConfigurationClassParser%E8%A7%A3%E6%9E%90%E6%B3%A8%E8%A7%A3%E7%9A%84%E9%A1%BA%E5%BA%8F.png alt=ConfigurationClassParser解析注解的顺序></p><p>在解析 @ComponentScan注解和@Import注解的时候如果扫描或者导入的类又存在@Configuration注解就会再一次重复执行@Configuration注解的解析流程。</p><p>通过上面分析可以总结出整体的一个解析顺序和流程如下图所示：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/spring/Spring%E5%B8%B8%E7%94%A8%E7%B1%BB%E6%B3%A8%E8%A7%A3%E7%9A%84%E8%A7%A3%E6%9E%90%E5%85%88%E5%90%8E%E9%A1%BA%E5%BA%8F.png alt=Spring常用类注解的解析先后顺序></p><h3 id=3-修饰属性或者方法注解解析顺序分析>3. 修饰属性或者方法注解解析顺序分析</h3><p>通过对Spring源码的分析可以知道处理 <strong><code>@Value</code></strong> 和 <strong><code>@Autowired</code></strong> 注解主要由 <strong><code>AutowiredAnnotationBeanPostProcessor</code></strong> 来实现。研究源码发现， <strong><code>@Value</code></strong> 和 <strong><code>@Autowired</code></strong> 注解都可以归结为一类注解：自动装配注解，只是 <strong><code>@Value</code></strong> 装配的是基本类型或者包装类型以及String类型的数据， 而 <strong><code>@Autowired</code></strong> 自动装配的是对象。</p><p>所以 <strong><code>@Value</code></strong> 和 <strong><code>@Autowired</code></strong> 没有严格意义上的前后顺序。</p><h3 id=4-总结>4. 总结</h3><ul><li><strong>Spring 中@Component注解是很多注解的元注解(定义的注解被@Component修饰)，例如@Service只是不同语义的定义而已，本质上都是@Component注解，包括@Configuration注解</strong></li><li><strong>@PropertySource、@ComponentScan、@Import、@ImportResource、@Bean单独是没办法使用，从上面的解析顺序分析可以得出结论，如果一个类上面配置了这五个注解但是没有配置@Configuration注解，这些注解都没办法起作用。要想起作用必须和@Configuration搭配使用。这个是最重要的一点</strong></li><li><strong>@ComponentScan会重新执行ClassPathBeanDefinitionScanner#scan扫描，会在走一遍解析的流程</strong></li><li><strong>@Import如果导入了包含@Configuration注解的类也同样会走一遍@Configuration的解析流程</strong></li></ul><p><strong>在注解使用的时候注意有依赖关系的需要搭配使用单独使用会没有效果。</strong></p></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list"><a class=text-white target=_blank rel="noopener noreferrer" href=https://groups.google.com/u/1/g/ljbmxsm><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=个人掘金主页 aria-label=个人掘金主页><a class=text-white target=_blank rel="noopener noreferrer" href=https://juejin.cn/user/1151943918492855><i class="fab fa-twitter"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/mxsm><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2022 The Docsy Authors All Rights Reserved</small>
<small class=ml-1><a href=https://policies.google.com/privacy target=_blank>隐私政策</a></small><p class=mt-2><a href=/about/>Home</a></p></div></div></div></footer><div><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css><script src=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js></script><script>$("p img").wrap(function(){return'<a data-fancybox="gallery" href="'+$(this).attr('src')+'"></a>'})</script></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/mermaid@8.8.1/dist/mermaid.min.js integrity=sha384-to2w0I1OqmbJ9J6yTnIX+KYU8grNpZoD1dKPLjgEJvMe5L5+/7qvuNa2sQo8WAWj crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/raphael/2.3.0/raphael.min.js integrity="sha512-tBzZQxySO5q5lqwLWfu8Q+o4VkTcRGOeQGVQ0ueJga4A1RKuzmAu5HXDOXLEjpbKyV7ow9ympVoa6wZLEzRzDg==" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.15.0/flowchart.min.js integrity="sha512-6QsSiIybtf8tuZ6xfjRTr2tdtw3Gp4q5RSCh2b6q9seoKEQmhAG1RrCA8F0kXTwivVxRVbp/YF3zOh8rvEAU7Q==" crossorigin=anonymous></script><script src=/js/main.min.b541b310f01941a0abfd76b652b5fb60dac470573775bb5b31ff08fe3f6cea51.js integrity="sha256-tUGzEPAZQaCr/Xa2UrX7YNrEcFc3dbtbMf8I/j9s6lE=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.js></script><script type=text/javascript>docsearch({appId:'JO2SY3WDAC',apiKey:'324ddb3b679c1308e5aa8bf222e07f8b',indexName:'mxsm',inputSelector:'.td-search-input',debug:!1})</script></body></html>