<!doctype html>
<html class="docs-version-current" lang="cn" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v0.0.0-4192">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script>!function(e,t,a,n,g){e[n]=e[n]||[],e[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var m=t.getElementsByTagName(a)[0],r=t.createElement(a);r.async=!0,r.src="https://www.googletagmanager.com/gtm.js?id=GTM-TKMGCBC",m.parentNode.insertBefore(r,m)}(window,document,"script","dataLayer")</script>
<link rel="search" type="application/opensearchdescription+xml" title="mxsm(蚂蚁背大象)" href="/cn/opensearch.xml"><title data-react-helmet="true">AutoSwitchHAService-source-code-analysis | mxsm(蚂蚁背大象)</title><meta data-react-helmet="true" property="og:url" content="https://blog.ljbmxsm.com/cn/docs/rocketmq5/store/AutoSwitchHAService-source-code-analysis"><meta data-react-helmet="true" name="docsearch:language" content="cn"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" name="og:image" content="https://ionicframework.com/docs/img/meta/open-graph.png"><meta data-react-helmet="true" name="twitter:image" content="https://ionicframework.com/docs/img/meta/open-graph.png"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="twitter:domain" content="ionicframework.com"><meta data-react-helmet="true" name="twitter:site" content="@ionicframework"><meta data-react-helmet="true" name="twitter:creator" content="ionicframework"><meta data-react-helmet="true" name="fb:page_id" content="1321836767955949"><meta data-react-helmet="true" name="og:type" content="website"><meta data-react-helmet="true" name="og:site_name" content="Ionic Framework Docs"><meta data-react-helmet="true" property="og:title" content="AutoSwitchHAService-source-code-analysis | mxsm(蚂蚁背大象)"><meta data-react-helmet="true" name="description" content="持续创作，加速成长！这是我参与「掘金日新计划 · 10 月更文挑战」的第7天，点击查看活动详情"><meta data-react-helmet="true" property="og:description" content="持续创作，加速成长！这是我参与「掘金日新计划 · 10 月更文挑战」的第7天，点击查看活动详情"><link data-react-helmet="true" rel="shortcut icon" href="/cn/img/meta/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://blog.ljbmxsm.com/cn/docs/rocketmq5/store/AutoSwitchHAService-source-code-analysis"><link data-react-helmet="true" rel="alternate" href="https://blog.ljbmxsm.com/cn/docs/rocketmq5/store/AutoSwitchHAService-source-code-analysis" hreflang="cn"><link data-react-helmet="true" rel="alternate" href="https://blog.ljbmxsm.com/docs/rocketmq5/store/AutoSwitchHAService-source-code-analysis" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://blog.ljbmxsm.com/docs/rocketmq5/store/AutoSwitchHAService-source-code-analysis" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://O9QSL985BS-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/cn/assets/css/styles.aeab913d.css">
<link rel="preload" href="/cn/assets/js/runtime~main.b1ab60ee.js" as="script">
<link rel="preload" href="/cn/assets/js/main.802037d2.js" as="script">
</head>
<body>
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TKMGCBC" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" target="_self" href="/cn/"><div class="navbar__logo"><img src="/cn/logos/ionic-text-docs-dark.svg" alt="Site Logo" class="themedImage_TMUO themedImage--light_4Vu1" height="28" width="139"><img src="/cn/logos/ionic-text-docs-light.svg" alt="Site Logo" class="themedImage_TMUO themedImage--dark_uzRr" height="28" width="139"></div></a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link">RocketMQ</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/cn/docs/rocketmq/rocketmq5">RocketMQ 5.0</a></li><li><a class="dropdown__link" href="/cn/docs/">RocketMQ 4.X</a></li><li><a href="https://github.com/apache/rocketmq" target="_blank" class="dropdown__link"><span>RocketMQ GitHub<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li><a href="https://rocketmq.apache.org/" target="_blank" class="dropdown__link"><span>RocketMQ official website<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link">Spring</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/cn/docs/">Spring Framework</a></li><li><a class="dropdown__link" href="/cn/docs/">Spring Boot</a></li><li><a class="dropdown__link" href="/cn/docs/">Spring Cloud</a></li><li><a href="https://spring.io/" target="_blank" class="dropdown__link"><span>Spring official website<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link">Java</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/cn/docs/">Java SE</a></li><li><a class="dropdown__link" href="/cn/docs/">Java Web</a></li></ul></div><a position="left" href="/cn/intro/upgrading-to-ionic-6" class="cta">Ionic v6.0.0 Upgrade Guide<svg xmlns="http://www.w3.org/2000/svg" class="ionicon" viewBox="0 0 512 512" width="12" height="12"><title>Arrow Forward</title><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="48" d="M268 112l144 144-144 144M392 256H100"></path></svg></a></div><div class="navbar__items navbar__items--right"><div class="searchBox_NKBi"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link navbar__link--community">Community</a><ul class="dropdown__menu"><li><a href="https://ionicframework.com/community" target="_blank" class="dropdown__link"><span>Community Hub<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li><a href="https://forum.ionicframework.com/" target="_blank" class="dropdown__link"><span>Forum<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li><a href="https://www.meetup.com/topics/ionic-framework/" target="_blank" class="dropdown__link"><span>Meetups<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li><a href="https://blog.ionicframework.com/" target="_blank" class="dropdown__link"><span>Blog<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li><a href="https://twitter.com/ionicframework" target="_blank" class="dropdown__link"><span>Twitter<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link navbar__link--support">Support</a><ul class="dropdown__menu"><li><a href="https://ionicframework.com/support" target="_blank" class="dropdown__link"><span>Help Center<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li><a href="https://ionic.zendesk.com/" target="_blank" class="dropdown__link"><span>Customer Support<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li><a href="https://ionicframework.com/advisory" target="_blank" class="dropdown__link"><span>Enterprise Advisory<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div position="right" class="separator"></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link icon-link language navbar__item"><span><svg viewBox="0 0 20 20" width="20" height="20" aria-hidden="true" class="iconLanguage_EbrZ"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>中文</span></span></a><ul class="dropdown__menu"><li><a href="/cn/docs/rocketmq5/store/AutoSwitchHAService-source-code-analysis" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">中文</a></li><li><a href="/docs/rocketmq5/store/AutoSwitchHAService-source-code-analysis" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">English</a></li><li><a href="https://ionicframework.com/translate" target="_blank" class="dropdown__link"><span>Translate<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><a position="right" class="icon-link navbar__item" href="https://twitter.com/Ionicframework" target="_blank"><img src="/cn/logos/twitter.svg" alt="twitter logo"></a><a position="right" class="icon-link navbar__item" href="https://github.com/mxsm" target="_blank"><img src="/cn/logos/github.svg" alt="github logo"></a><a position="right" class="icon-link navbar__item" href="https://ionic.link/discord" target="_blank"><img src="/cn/logos/discord.svg" alt="discord logo"></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">🌜</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">🌞</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_GMj9"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" target="_self" href="/cn/"><div class="navbar__logo"><img src="/cn/logos/ionic-text-docs-dark.svg" alt="Site Logo" class="themedImage_TMUO themedImage--light_4Vu1" height="28" width="139"><img src="/cn/logos/ionic-text-docs-light.svg" alt="Site Logo" class="themedImage_TMUO themedImage--dark_uzRr" height="28" width="139"></div></a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link">RocketMQ</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/cn/docs/rocketmq/rocketmq5">RocketMQ 5.0</a></li><li><a class="dropdown__link" href="/cn/docs/">RocketMQ 4.X</a></li><li><a href="https://github.com/apache/rocketmq" target="_blank" class="dropdown__link"><span>RocketMQ GitHub<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li><a href="https://rocketmq.apache.org/" target="_blank" class="dropdown__link"><span>RocketMQ official website<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link">Spring</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/cn/docs/">Spring Framework</a></li><li><a class="dropdown__link" href="/cn/docs/">Spring Boot</a></li><li><a class="dropdown__link" href="/cn/docs/">Spring Cloud</a></li><li><a href="https://spring.io/" target="_blank" class="dropdown__link"><span>Spring official website<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link">Java</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/cn/docs/">Java SE</a></li><li><a class="dropdown__link" href="/cn/docs/">Java Web</a></li></ul></div><a position="left" href="/cn/intro/upgrading-to-ionic-6" class="cta">Ionic v6.0.0 Upgrade Guide<svg xmlns="http://www.w3.org/2000/svg" class="ionicon" viewBox="0 0 512 512" width="12" height="12"><title>Arrow Forward</title><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="48" d="M268 112l144 144-144 144M392 256H100"></path></svg></a></div><div class="navbar__items navbar__items--right"><div class="searchBox_NKBi"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link navbar__link--community">Community</a><ul class="dropdown__menu"><li><a href="https://ionicframework.com/community" target="_blank" class="dropdown__link"><span>Community Hub<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li><a href="https://forum.ionicframework.com/" target="_blank" class="dropdown__link"><span>Forum<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li><a href="https://www.meetup.com/topics/ionic-framework/" target="_blank" class="dropdown__link"><span>Meetups<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li><a href="https://blog.ionicframework.com/" target="_blank" class="dropdown__link"><span>Blog<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li><a href="https://twitter.com/ionicframework" target="_blank" class="dropdown__link"><span>Twitter<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link navbar__link--support">Support</a><ul class="dropdown__menu"><li><a href="https://ionicframework.com/support" target="_blank" class="dropdown__link"><span>Help Center<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li><a href="https://ionic.zendesk.com/" target="_blank" class="dropdown__link"><span>Customer Support<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li><a href="https://ionicframework.com/advisory" target="_blank" class="dropdown__link"><span>Enterprise Advisory<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div position="right" class="separator"></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link icon-link language navbar__item"><span><svg viewBox="0 0 20 20" width="20" height="20" aria-hidden="true" class="iconLanguage_EbrZ"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>中文</span></span></a><ul class="dropdown__menu"><li><a href="/cn/docs/rocketmq5/store/AutoSwitchHAService-source-code-analysis" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">中文</a></li><li><a href="/docs/rocketmq5/store/AutoSwitchHAService-source-code-analysis" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">English</a></li><li><a href="https://ionicframework.com/translate" target="_blank" class="dropdown__link"><span>Translate<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><a position="right" class="icon-link navbar__item" href="https://twitter.com/Ionicframework" target="_blank"><img src="/cn/logos/twitter.svg" alt="twitter logo"></a><a position="right" class="icon-link navbar__item" href="https://github.com/mxsm" target="_blank"><img src="/cn/logos/github.svg" alt="github logo"></a><a position="right" class="icon-link navbar__item" href="https://ionic.link/discord" target="_blank"><img src="/cn/logos/discord.svg" alt="discord logo"></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">🌜</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">🌞</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><main class="docMainContainer_Q970 docMainContainerEnhanced_ipQ4"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_MGa7"><div class="docItemContainer_PQH2"><article><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_psec"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>AutoSwitchHAService-source-code-analysis</h1></header><p>持续创作，加速成长！这是我参与「掘金日新计划 · 10 月更文挑战」的第7天，<a href="https://juejin.cn/post/7147654075599978532" target="_blank" rel="noopener noreferrer">点击查看活动详情</a></p><p>RocketMQ5.0实现了主备自主切换其中AutoSwitchHAService作为其中一个重要的组件实现了当中的很多功能：</p><p><img src="E:%5Cdownload%5CAutoSwitchHAService.png" alt="AutoSwitchHAService"></p><p>下面就来分析这些功能的实现。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="1-autoswitchhaservice工作流程">1. AutoSwitchHAService工作流程<a aria-hidden="true" class="hash-link" href="#1-autoswitchhaservice工作流程" title="Direct link to heading">​</a></h2><p>首先来看一下AutoSwitchHAService的工作流程，图如下：</p><p>![AutoSwitchHAService work flow]<!-- -->(E:\download\AutoSwitchHAService work flow.png)</p><p>主要分为几块：</p><ul><li>AutoSwitchHAService初始化</li><li>AutoSwitchHAService启动，包括：AutoSwitchAcceptSocketService、GroupTransferService、HAConnectionStateNotificationService服务。</li><li>Broker启动等待注册到DLedger Controller的返回结果，根据结果来判断Broker change role。</li><li>Broker角色为Master的时候主要是将Master的CommitLog数据传输到Slave, Slave主要的功能就是通过HAClient处理Master传输的数据。</li></ul><p>Broker Master和Slave的分工合作从而实现了Broker的CommitLog数据传输到Slave的功能。从而达到高可用和主备切换的目的。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="2-autoswitchhaservice初始化和启动">2. AutoSwitchHAService初始化和启动<a aria-hidden="true" class="hash-link" href="#2-autoswitchhaservice初始化和启动" title="Direct link to heading">​</a></h2><p><strong><code>AutoSwitchHAService</code></strong> 实现了 <strong><code>DefaultHAService</code></strong> ，也就是在RocketMQ4.x的高可用基础上实现了主备切换的功能。初始化在<strong><code>AutoSwitchHAService#init</code></strong> 方法中：</p><p><img src="C:%5CUsers%5Cmxsm%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20221021230106244.png" alt="image-20221021230106244"></p><p>启动的过程主要在<strong><code>DefaultHAService#start</code></strong> 方法中，干了一下几件事情：</p><ul><li><p><strong>AutoSwitchAcceptSocketService服务的启动</strong></p><p>这个服务的作用是用来监听Slave Client的链接，当Slave的Client连接到Master后，会将连接包装成AutoSwitchHAConnection存入列表中。这个服务主要是Broker Master会用到</p></li><li><p><strong>GroupTransferService服务启动</strong></p><p>判断CommitLog是否已经同步到Slave，这个也只有Master会用到</p></li><li><p><strong>HAConnectionStateNotificationService服务启动</strong></p></li></ul><p><img src="C:%5CUsers%5Cmxsm%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20221021230424825.png" alt="image-20221021230424825"></p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="3-autoswitchhaservice-change-role">3. AutoSwitchHAService change role<a aria-hidden="true" class="hash-link" href="#3-autoswitchhaservice-change-role" title="Direct link to heading">​</a></h2><p>Broker的角色是Master还是Slave是由选主组件 <strong><code>DLedger Controller（controller模块)）</code></strong> 决定。接收到选主通知的Broker会根据master address和自身的address进行判断来决定是调用 <strong><code>AutoSwitchHAService #changeToMaster</code></strong> 还是 <strong><code>AutoSwitchHAService#changeToSlave</code></strong> 。</p><blockquote><p>Tips: Broker的选主可以参照<a href="https://juejin.cn/post/7156202204104392717" target="_blank" rel="noopener noreferrer">《RocketMQ5.0主备自动切换模式Broker选主详解》</a></p></blockquote><h3 class="anchor anchorWithStickyNavbar_y2LR" id="31--change-to-master">3.1  Change to Master<a aria-hidden="true" class="hash-link" href="#31--change-to-master" title="Direct link to heading">​</a></h3><p><strong><code>ReplicasManager#changeToMaster</code></strong> 是接收DLedger Controller选主后返回的一个入口：</p><p><img src="C:%5CUsers%5Cmxsm%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20221021224605394.png" alt="image-20221021224605394"></p><p>下面看一下 <strong><code>AutoSwitchHAService#changeToMaster</code></strong> 的处理流程：</p><p>![Broker Change to Master]<!-- -->(E:\download\Broker Change to Master.png)</p><p>从Broker Change to Master的流程图可以看出来整个过程分为一下几个步骤：</p><ul><li>DLedger Controller负责选主，然后通知对应的Broker,Borker将角色设置为Master</li><li>设置为Master的时候首先要删除原先Broker持有的Slave client(Slave 是没有持有AutoSwitchHAConnection)，与此同时如果AutoSwitchHAClient不为空的情况shutdown。</li><li>Broker本地脏数据清理：CommitLog的脏数据、consume queue 的脏数据，也就是本地数据对齐</li><li>根据Master Epoch对齐本地的Epoch数据，同时将新增的Epoch数据写入Checkpoint文件中</li><li>等待Consume queue dispatch完成， 恢复Consume Queue到内存</li></ul><p>通过以上的几个步骤就完成了Broker的Role设置。</p><blockquote><p>Tips: 设置Broker的角色一定是 <strong>SYNC_MASTER</strong> 主要是因为需要实现高可用减少消息丢失</p></blockquote><h3 class="anchor anchorWithStickyNavbar_y2LR" id="32--change-to-slave">3.2  Change to Slave<a aria-hidden="true" class="hash-link" href="#32--change-to-slave" title="Direct link to heading">​</a></h3><p>Broker设置为Slave的流程和设置为Master的流程大体上都差不多：</p><p><img src="C:%5CUsers%5Cmxsm%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20221021225018262.png" alt="image-20221021225018262"></p><p>功能的实现都是通过<strong><code>AutoSwitchHAService</code></strong></p><p><img src="C:%5CUsers%5Cmxsm%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20221021225341031.png" alt="image-20221021225341031"></p><p>对于 <strong><code>AutoSwitchHAClient</code></strong> 是如何与 Master进行建立连接和工作的大家可以参照 <a href="https://juejin.cn/post/7155374918983483422" target="_blank" rel="noopener noreferrer">《RocketMQ5.0源码分析-高可用组件AutoSwitchHAClient图文详解》</a> 。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="4-transfer-commitlog-data">4 Transfer CommitLog Data<a aria-hidden="true" class="hash-link" href="#4-transfer-commitlog-data" title="Direct link to heading">​</a></h2><p>将Master Broker的数据传输到Slave Broker这个重要也是最主要的目的。与此同时来实现Broker的高可用。从上面可以知道当Slave和Master完成HANDSHAKE后。Master就进入了TRANSFER状态也就是数据传输的状态，此时Master会将数据通过 <strong><code>AutoSwitchHAConnection</code></strong> 传输给 Slave。传输格式:</p><p>![Transfer Message]<!-- -->(E:\download\Transfer Message.png)</p><blockquote><p>Note: 每一次数据的传输不能跨Epoch进行传输，每一次传输的数据epoch都是相同的。</p></blockquote><h2 class="anchor anchorWithStickyNavbar_y2LR" id="5-总结">5. 总结<a aria-hidden="true" class="hash-link" href="#5-总结" title="Direct link to heading">​</a></h2><p>RocketMQ5.0主备自主切换是在RocketMQ4.x的基础上增加了epoch等一些设计，同时依赖DLedger实现选主。 <strong><code>ReplicasManager</code></strong> 主要负责接口对外，<strong><code>AutoSwitchHAService</code></strong> 提供实际的服务编排，将不同的服务编排起来实现整个功能。</p><blockquote><p>我是蚂蚁背大象(GitHub:mxsm)，文章对你有帮助点赞关注我，文章有不正确的地方请您斧正留言评论~谢谢!</p></blockquote></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://crowdin.com/project/ionic-docs" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg" class="icon-edit iconEdit_PItR"><path d="M7 0C3.13438 0 0 3.21563 0 7.17813C0 10.35 2.00625 13.0375 4.7875 13.9875C4.83125 13.9969 4.86875 14 4.90625 14C5.16563 14 5.26562 13.8094 5.26562 13.6438C5.26562 13.4719 5.25938 13.0219 5.25625 12.4219C4.99375 12.4812 4.75938 12.5063 4.55 12.5063C3.20313 12.5063 2.89687 11.4594 2.89687 11.4594C2.57812 10.6313 2.11875 10.4094 2.11875 10.4094C1.50938 9.98125 2.11562 9.96875 2.1625 9.96875H2.16563C2.86875 10.0312 3.2375 10.7125 3.2375 10.7125C3.5875 11.325 4.05625 11.4969 4.475 11.4969C4.80312 11.4969 5.1 11.3906 5.275 11.3094C5.3375 10.8469 5.51875 10.5312 5.71875 10.35C4.16563 10.1688 2.53125 9.55313 2.53125 6.80312C2.53125 6.01875 2.80312 5.37813 3.25 4.87813C3.17812 4.69688 2.9375 3.96563 3.31875 2.97813C3.31875 2.97813 3.36875 2.9625 3.475 2.9625C3.72812 2.9625 4.3 3.05937 5.24375 3.71562C5.80312 3.55625 6.4 3.47812 6.99687 3.475C7.59062 3.47812 8.19063 3.55625 8.75 3.71562C9.69375 3.05937 10.2656 2.9625 10.5188 2.9625C10.625 2.9625 10.675 2.97813 10.675 2.97813C11.0563 3.96563 10.8156 4.69688 10.7437 4.87813C11.1906 5.38125 11.4625 6.02187 11.4625 6.80312C11.4625 9.55937 9.825 10.1656 8.26562 10.3438C8.51562 10.5656 8.74063 11.0031 8.74063 11.6719C8.74063 12.6313 8.73125 13.4062 8.73125 13.6406C8.73125 13.8094 8.82812 14 9.0875 14C9.125 14 9.16875 13.9969 9.2125 13.9875C11.9969 13.0375 14 10.3469 14 7.17813C14 3.21563 10.8656 0 7 0Z" fill="currentColor"></path></svg>Edit this page</a></div><div class="col lastUpdated_mt2f"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div><div class="spacer"></div></div><div class="end"><div class="toc-wrapper"><h2>Contents</h2><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-autoswitchhaservice工作流程" class="table-of-contents__link toc-highlight">1. AutoSwitchHAService工作流程</a></li><li><a href="#2-autoswitchhaservice初始化和启动" class="table-of-contents__link toc-highlight">2. AutoSwitchHAService初始化和启动</a></li><li><a href="#3-autoswitchhaservice-change-role" class="table-of-contents__link toc-highlight">3. AutoSwitchHAService change role</a><ul><li><a href="#31--change-to-master" class="table-of-contents__link toc-highlight">3.1  Change to Master</a></li><li><a href="#32--change-to-slave" class="table-of-contents__link toc-highlight">3.2  Change to Slave</a></li></ul></li><li><a href="#4-transfer-commitlog-data" class="table-of-contents__link toc-highlight">4 Transfer CommitLog Data</a></li><li><a href="#5-总结" class="table-of-contents__link toc-highlight">5. 总结</a></li></ul></div><a href="https://crowdin.com/project/ionic-docs" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg" class="icon-edit iconEdit_PItR"><path d="M7 0C3.13438 0 0 3.21563 0 7.17813C0 10.35 2.00625 13.0375 4.7875 13.9875C4.83125 13.9969 4.86875 14 4.90625 14C5.16563 14 5.26562 13.8094 5.26562 13.6438C5.26562 13.4719 5.25938 13.0219 5.25625 12.4219C4.99375 12.4812 4.75938 12.5063 4.55 12.5063C3.20313 12.5063 2.89687 11.4594 2.89687 11.4594C2.57812 10.6313 2.11875 10.4094 2.11875 10.4094C1.50938 9.98125 2.11562 9.96875 2.1625 9.96875H2.16563C2.86875 10.0312 3.2375 10.7125 3.2375 10.7125C3.5875 11.325 4.05625 11.4969 4.475 11.4969C4.80312 11.4969 5.1 11.3906 5.275 11.3094C5.3375 10.8469 5.51875 10.5312 5.71875 10.35C4.16563 10.1688 2.53125 9.55313 2.53125 6.80312C2.53125 6.01875 2.80312 5.37813 3.25 4.87813C3.17812 4.69688 2.9375 3.96563 3.31875 2.97813C3.31875 2.97813 3.36875 2.9625 3.475 2.9625C3.72812 2.9625 4.3 3.05937 5.24375 3.71562C5.80312 3.55625 6.4 3.47812 6.99687 3.475C7.59062 3.47812 8.19063 3.55625 8.75 3.71562C9.69375 3.05937 10.2656 2.9625 10.5188 2.9625C10.625 2.9625 10.675 2.97813 10.675 2.97813C11.0563 3.96563 10.8156 4.69688 10.7437 4.87813C11.1906 5.38125 11.4625 6.02187 11.4625 6.80312C11.4625 9.55937 9.825 10.1656 8.26562 10.3438C8.51562 10.5656 8.74063 11.0031 8.74063 11.6719C8.74063 12.6313 8.73125 13.4062 8.73125 13.6406C8.73125 13.8094 8.82812 14 9.0875 14C9.125 14 9.16875 13.9969 9.2125 13.9875C11.9969 13.0375 14 10.3469 14 7.17813C14 3.21563 10.8656 0 7 0Z" fill="currentColor"></path></svg>Edit this page</a></div></div></div></div></main></div></div></div><footer class="footer"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">版权所有 © 2022 mxsm(蚂蚁背大象). 使用 Docusaurus 构建.</div></div></div></footer></div>
<script src="/cn/assets/js/runtime~main.b1ab60ee.js"></script>
<script src="/cn/assets/js/main.802037d2.js"></script>
</body>
</html>