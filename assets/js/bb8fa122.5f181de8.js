"use strict";(self.webpackChunkmxsm_website=self.webpackChunkmxsm_website||[]).push([[3359],{3291:(t,n,e)=>{e.r(n),e.d(n,{assets:()=>c,contentTitle:()=>r,default:()=>g,frontMatter:()=>i,metadata:()=>o,toc:()=>l});var s=e(4848),a=e(8453);const i={title:"spring\u6ce8\u89e3\u6e90\u7801\u89e3\u6790\u4e4b-\u914d\u7f6e\u7c7b\u6ce8\u89e3",linkTitle:"spring\u6ce8\u89e3\u6e90\u7801\u89e3\u6790\u4e4b-\u914d\u7f6e\u7c7b\u6ce8\u89e3",date:new Date("2018-03-09T00:00:00.000Z"),weight:3},r=void 0,o={id:"spring/spring-framework/annotation-source-analysis/config-annotation",title:"spring\u6ce8\u89e3\u6e90\u7801\u89e3\u6790\u4e4b-\u914d\u7f6e\u7c7b\u6ce8\u89e3",description:"1. Spring\u914d\u7f6e\u7c7b\u6ce8\u89e3",source:"@site/docs/spring/spring-framework/annotation-source-analysis/config-annotation.md",sourceDirName:"spring/spring-framework/annotation-source-analysis",slug:"/spring/spring-framework/annotation-source-analysis/config-annotation",permalink:"/docs/spring/spring-framework/annotation-source-analysis/config-annotation",draft:!1,unlisted:!1,editUrl:"https://github.com/mxsm/mxsm-website/edit/develop/docs/spring/spring-framework/annotation-source-analysis/config-annotation.md",tags:[],version:"current",lastUpdatedBy:"mxsm",lastUpdatedAt:1720344793e3,frontMatter:{title:"spring\u6ce8\u89e3\u6e90\u7801\u89e3\u6790\u4e4b-\u914d\u7f6e\u7c7b\u6ce8\u89e3",linkTitle:"spring\u6ce8\u89e3\u6e90\u7801\u89e3\u6790\u4e4b-\u914d\u7f6e\u7c7b\u6ce8\u89e3",date:"2018-03-09T00:00:00.000Z",weight:3}},c={},l=[{value:"1. Spring\u914d\u7f6e\u7c7b\u6ce8\u89e3",id:"1-spring\u914d\u7f6e\u7c7b\u6ce8\u89e3",level:3},{value:"2. Spring\u914d\u7f6e\u7c7b\u6ce8\u89e3\u6e90\u7801\u89e3\u6790",id:"2-spring\u914d\u7f6e\u7c7b\u6ce8\u89e3\u6e90\u7801\u89e3\u6790",level:3},{value:"3. ConfigurationClassPostProcessor\u5982\u4f55\u6ce8\u5165\u5230Spring Application\u4e2d",id:"3-configurationclasspostprocessor\u5982\u4f55\u6ce8\u5165\u5230spring-application\u4e2d",level:3}];function d(t){const n={code:"code",em:"em",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...t.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h3,{id:"1-spring\u914d\u7f6e\u7c7b\u6ce8\u89e3",children:"1. Spring\u914d\u7f6e\u7c7b\u6ce8\u89e3"}),"\n",(0,s.jsx)(n.p,{children:"\u5728Spring\u4e2d\u7684\u914d\u7f6e\u7c7b\u4e3b\u8981\u5305\u542b\u4e94\u4e2a\u6ce8\u89e3\uff1a"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"Component"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"ComponentScan"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"Import"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"ImportResource"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"Configuration"})}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"2-spring\u914d\u7f6e\u7c7b\u6ce8\u89e3\u6e90\u7801\u89e3\u6790",children:"2. Spring\u914d\u7f6e\u7c7b\u6ce8\u89e3\u6e90\u7801\u89e3\u6790"}),"\n",(0,s.jsxs)(n.p,{children:["\u914d\u7f6e\u7c7b\u6ce8\u89e3\u4e3b\u8981\u662f\u7531 ",(0,s.jsx)(n.em,{children:(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"ConfigurationClassPostProcessor"})})})," \u6765\u5904\u7406\u3002\u4e0b\u9762\u770b\u4e00\u4e0b\u6e90\u7801\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:"public class ConfigurationClassPostProcessor implements BeanDefinitionRegistryPostProcessor,\n\t\tPriorityOrdered, ResourceLoaderAware, BeanClassLoaderAware, EnvironmentAware {\n    //\u7701\u7565\u5404\u79cd\u4ee3\u7801\t\t    \n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u5b9e\u73b0\u4e86 ",(0,s.jsx)(n.strong,{children:"BeanDefinitionRegistryPostProcessor"})," \u63a5\u53e3\u3002\u8be5\u63a5\u53e3\u662f ",(0,s.jsx)(n.strong,{children:"BeanFactoryPostProcessor"})," \u7ee7\u627f\u800c\u6765\u3002\u8fd9\u4e2a\u63a5\u53e3\u4e3b\u8981\u7528\u6765\u5904\u7406\u7c7b\u4e0a\u9762\u7684\u6ce8\u89e3\u3002"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'\t@Override\n\tpublic void postProcessBeanDefinitionRegistry(BeanDefinitionRegistry registry) {\n\t\tint registryId = System.identityHashCode(registry);\n\t\tif (this.registriesPostProcessed.contains(registryId)) {\n\t\t\tthrow new IllegalStateException(\n\t\t\t\t\t"postProcessBeanDefinitionRegistry already called on this post-processor against " + registry);\n\t\t}\n\t\tif (this.factoriesPostProcessed.contains(registryId)) {\n\t\t\tthrow new IllegalStateException(\n\t\t\t\t\t"postProcessBeanFactory already called on this post-processor against " + registry);\n\t\t}\n\t\tthis.registriesPostProcessed.add(registryId);\n        //\u5904\u7406\u65b9\u6cd5\n\t\tprocessConfigBeanDefinitions(registry);\n\t}\n\n'})}),"\n",(0,s.jsxs)(n.p,{children:["\u901a\u8fc7\u6e90\u7801\u53ef\u4ee5\u770b\u51fa\u6765\u4e3b\u8981\u662f\u901a\u8fc7 ",(0,s.jsxs)(n.strong,{children:[(0,s.jsx)(n.em,{children:"ConfigurationClassPostProcessor"}),"#processConfigBeanDefinitions"]})," \u65b9\u6cd5\u5904\u7406\u3002\u4e0b\u9762\u6765\u770b\u4e00\u4e0b\u65b9\u6cd5 ",(0,s.jsx)(n.em,{children:(0,s.jsx)(n.strong,{children:"processConfigBeanDefinitions"})})," \u6e90\u7801\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:"public void processConfigBeanDefinitions(BeanDefinitionRegistry registry) {\n    List<BeanDefinitionHolder> configCandidates = new ArrayList<>();\n    //\u83b7\u53d6Bean\u7684\u5b9a\u4e49\u540d\u79f0\n\tString[] candidateNames = registry.getBeanDefinitionNames();\n\t\n\tfor (String beanName : candidateNames) {\n\t\tBeanDefinition beanDef = registry.getBeanDefinition(beanName);\n\t\tif (beanDef.getAttribute(ConfigurationClassUtils.CONFIGURATION_CLASS_ATTRIBUTE) != null) {\n            //\u7701\u7565\u6253\u5370\u65e5\u5fd7\n\t\t}\n\t\t//\u5224\u65ad\u662f\u5426\u4e3aConfigurationClass\n\t\telse if (ConfigurationClassUtils.checkConfigurationClassCandidate(beanDef, this.metadataReaderFactory)) {\n\t\t\tconfigCandidates.add(new BeanDefinitionHolder(beanDef, beanName));\n\t\t}\n\t}\n\t//\u7701\u7565\u540e\u7eed\u5904\u7406\u4ee3\u7801\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u901a\u8fc7\u4ee3\u7801\u53d1\u73b0\u4e3b\u8981\u662f\u901a\u8fc7 ",(0,s.jsx)(n.em,{children:(0,s.jsx)(n.strong,{children:"ConfigurationClassUtils.checkConfigurationClassCandidate"})})," \u65b9\u6cd5\u6765\u6821\u9a8c\u662f\u5426\u4e3a ",(0,s.jsx)(n.strong,{children:"ConfigurationClass"})," \u3002\u90a3\u4e48\u6765\u7814\u7a76\u4e00\u4e0b\u65b9\u6cd5 ",(0,s.jsx)(n.strong,{children:"checkConfigurationClassCandidate"})," \uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'public static boolean checkConfigurationClassCandidate(\n\t\t\tBeanDefinition beanDef, MetadataReaderFactory metadataReaderFactory) {\n    //\u7701\u7565\u90e8\u5206\u4ee3\u7801\n    \n    //\u83b7\u53d6\u662f\u5426Configuration\u4fee\u9970\u7684\u7c7b\n    Map<String, Object> config = metadata.getAnnotationAttributes(Configuration.class.getName());\n\t\tif (config != null && !Boolean.FALSE.equals(config.get("proxyBeanMethods"))) {\n\t\t\tbeanDef.setAttribute(CONFIGURATION_CLASS_ATTRIBUTE, CONFIGURATION_CLASS_FULL);\n\t\t}\n\t\t//\u5224\u65ad\u662f\u5426\u4e3aComponent\u3001ComponentScan\u3001Import\u3001ImportResource\u4e2d\u7684\u4e00\u4e2a\n\t\telse if (config != null || isConfigurationCandidate(metadata)) {\n\t\t\tbeanDef.setAttribute(CONFIGURATION_CLASS_ATTRIBUTE, CONFIGURATION_CLASS_LITE);\n\t\t}\n\t\telse {\n\t\t\treturn false;\n\t\t}\n\t//\u7701\u7565\u90e8\u5206\u4ee3\u7801\n\t\n\treturn true;\n}\n\n//isConfigurationCandidate\u6e90\u7801\npublic static boolean isConfigurationCandidate(AnnotationMetadata metadata) {\n\t\t// \u5224\u65ad\u662f\u5426\u4e3a\u63a5\u53e3\n\t\tif (metadata.isInterface()) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// \u662f\u5426\u4e3aComponent\u3001ComponentScan\u3001Import\u3001ImportResource\u914d\u7f6e\u7c7b\u4e2d\u7684\u4e00\u4e2a\n\t\tfor (String indicator : candidateIndicators) {\n\t\t\tif (metadata.isAnnotated(indicator)) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\n\t\t// \u67e5\u8be2\u662f\u5426\u6709\u88ab@Bean\u6ce8\u89e3\u4fee\u590d\u7684\u65b9\u6cd5\n\t\ttry {\n\t\t\treturn metadata.hasAnnotatedMethods(Bean.class.getName());\n\t\t}\n\t\tcatch (Throwable ex) {\n            //\u7701\u7565\u65e5\u5fd7\u6253\u5370\n\t\t\treturn false;\n\t\t}\n\t}\n'})}),"\n",(0,s.jsx)(n.p,{children:"\u901a\u8fc7\u6e90\u7801\u5206\u6790\u53ef\u4ee5\u53d1\u73b0\u914d\u7f6eClass\u5206\u4e3a\u4e24\u7c7b\uff1a"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"full configurationClass"})}),"\n",(0,s.jsx)(n.p,{children:"Spring\u4e2d\u79f0\u4e3afull configurationClass,\u8fd9\u4e2a\u662f\u7531\u6ce8\u89e3@Configuration\u6ce8\u89e3\u4fee\u9970\u7684\u3002"}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"lite configurationClass"})}),"\n",(0,s.jsx)(n.p,{children:"Spring\u4e2d\u79f0\u4e3alite configurationClass\uff0c\u4e5f\u5c31\u662f\u8f7b\u91cf\u7ea7\u7684\u914d\u7f6e\u7c7b\uff0c\u7531\u6ce8\u89e3@Component\u3001@ComponentScan\u3001@Import\u3001@ImportResource"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["\u5728\u6765\u770b\u4e00\u4e0b ",(0,s.jsxs)(n.em,{children:[(0,s.jsx)(n.em,{children:"ConfigurationClassPostProcessor"}),"#",(0,s.jsx)(n.em,{children:"processConfigBeanDefinitions"})]}),"* \u4e2d\u662f\u5982\u4f55\u6765\u5904\u7406configurationClass\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:"public void processConfigBeanDefinitions(BeanDefinitionRegistry registry) {\n    \n    //\u7701\u7565\u4ee3\u7801\n    \n    //configCandidates\u7684\u5904\u7406\u4ee3\u7801\u5982\u4e0b\n    \n    //ConfigurationClassParser\u5904\u7406\u7c7b\u6765\u5904\u7406configCandidates\n    ConfigurationClassParser parser = new ConfigurationClassParser(\n\t\t\t\tthis.metadataReaderFactory, this.problemReporter, this.environment,\n\t\t\t\tthis.resourceLoader, this.componentScanBeanNameGenerator, registry);\n\n\t\tSet<BeanDefinitionHolder> candidates = new LinkedHashSet<>(configCandidates);\n\t\tSet<ConfigurationClass> alreadyParsed = new HashSet<>(configCandidates.size());\n\t\tdo {\n\t\t    //\u89e3\u6790candidates\n\t\t\tparser.parse(candidates);\n\t\t\tparser.validate();\n            \n            //\u83b7\u53d6\u89e3\u6790\u540e\u7684\u914d\u7f6e\u7c7b\n\t\t\tSet<ConfigurationClass> configClasses = new LinkedHashSet<>(parser.getConfigurationClasses());\n\t\t\tconfigClasses.removeAll(alreadyParsed);\n\n\t\t\t// \u521b\u5efa\u89e3\u6790\u540e\u7684\u914d\u7f6e\u7c7bBean\n\t\t\tif (this.reader == null) {\n\t\t\t\tthis.reader = new ConfigurationClassBeanDefinitionReader(\n\t\t\t\t\t\tregistry, this.sourceExtractor, this.resourceLoader, this.environment,\n\t\t\t\t\t\tthis.importBeanNameGenerator, parser.getImportRegistry());\n\t\t\t}\n\t\t\tthis.reader.loadBeanDefinitions(configClasses);\n\t\t\talreadyParsed.addAll(configClasses);\n\n\t\t\tcandidates.clear();\n\t\t\t//\u5faa\u73af\u5904\u7406\n\t\t\tif (registry.getBeanDefinitionCount() > candidateNames.length) {\n\t\t\t\tString[] newCandidateNames = registry.getBeanDefinitionNames();\n\t\t\t\tSet<String> oldCandidateNames = new HashSet<>(Arrays.asList(candidateNames));\n\t\t\t\tSet<String> alreadyParsedClasses = new HashSet<>();\n\t\t\t\tfor (ConfigurationClass configurationClass : alreadyParsed) {\n\t\t\t\t\talreadyParsedClasses.add(configurationClass.getMetadata().getClassName());\n\t\t\t\t}\n\t\t\t\tfor (String candidateName : newCandidateNames) {\n\t\t\t\t\tif (!oldCandidateNames.contains(candidateName)) {\n\t\t\t\t\t\tBeanDefinition bd = registry.getBeanDefinition(candidateName);\n\t\t\t\t\t\tif (ConfigurationClassUtils.checkConfigurationClassCandidate(bd, this.metadataReaderFactory) &&\n\t\t\t\t\t\t\t\t!alreadyParsedClasses.contains(bd.getBeanClassName())) {\n\t\t\t\t\t\t\tcandidates.add(new BeanDefinitionHolder(bd, candidateName));\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tcandidateNames = newCandidateNames;\n\t\t\t}\n\t\t}\n\t\twhile (!candidates.isEmpty());    \n    \n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u901a\u8fc7\u4ee3\u7801\u5206\u6790\u4e0a\u9762\u7684\u4ee3\u7801\u4e3b\u8981\u5904\u7406ConfigurationClass\u662f\u901a\u8fc7 ",(0,s.jsx)(n.em,{children:(0,s.jsx)(n.strong,{children:"ConfigurationClassParser"})})," \u89e3\u6790\u5668\u6765\u5904\u7406\u3002\u4e0b\u9762\u770b\u4e00\u4e0b\u89e3\u6790\u5668\u7684 ",(0,s.jsx)(n.em,{children:(0,s.jsx)(n.strong,{children:"ConfigurationClassParser#parse"})})," \u65b9\u6cd5\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'\tpublic void parse(Set<BeanDefinitionHolder> configCandidates) {\n\t\tfor (BeanDefinitionHolder holder : configCandidates) {\n\t\t\tBeanDefinition bd = holder.getBeanDefinition();\n\t\t\ttry {\n\t\t\t\tif (bd instanceof AnnotatedBeanDefinition) {\n\t\t\t\t\tparse(((AnnotatedBeanDefinition) bd).getMetadata(), holder.getBeanName());\n\t\t\t\t}\n\t\t\t\telse if (bd instanceof AbstractBeanDefinition && ((AbstractBeanDefinition) bd).hasBeanClass()) {\n\t\t\t\t\tparse(((AbstractBeanDefinition) bd).getBeanClass(), holder.getBeanName());\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tparse(bd.getBeanClassName(), holder.getBeanName());\n\t\t\t\t}\n\t\t\t}\n\t\t\tcatch (BeanDefinitionStoreException ex) {\n\t\t\t\tthrow ex;\n\t\t\t}\n\t\t\tcatch (Throwable ex) {\n\t\t\t\tthrow new BeanDefinitionStoreException(\n\t\t\t\t\t\t"Failed to parse configuration class [" + bd.getBeanClassName() + "]", ex);\n\t\t\t}\n\t\t}\n        //\u5904\u7406DeferredImportSelector\u63a5\u53e3\n\t\tthis.deferredImportSelectorHandler.process();\n\t}\n'})}),"\n",(0,s.jsx)(n.p,{children:"\u901a\u8fc7\u4e0a\u9762\u4ee3\u7801\u53ef\u4ee5\u770b\u51fa\u6765\u4e3b\u8981\u662f\u5206\u4e3a\u4e24\u90e8\u5206\uff1a"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"ConfigurationClassParser#parse ConfigurationClass\u89e3\u6790"})}),"\n",(0,s.jsx)(n.p,{children:"ConfigurationClassParser#parse\u662f\u4e00\u4e2a\u7a7a\u58f3\u65b9\u6cd5\uff0c\u5f53\u4e2d\u8c03\u7528\u4e86\u4e00\u4e2a ConfigurationClassParser#processConfigurationClass\u65b9\u6cd5"}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"DeferredImportSelector\u63a5\u53e3\u7684\u5904\u7406"})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["\u4e0b\u9762\u6765\u5206\u6790\u4e00\u4e0b ",(0,s.jsx)(n.strong,{children:"ConfigurationClassParser#processConfigurationClass"})," \u65b9\u6cd5\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:"protected void processConfigurationClass(ConfigurationClass configClass) throws IOException {\n        //\u6761\u4ef6\u52a0\u8f7d\u7684\u5224\u5b9a\u4e4b\u524d\u6709\u5206\u6790\u8fc7@Conditional\u6ce8\u89e3\n\t\tif (this.conditionEvaluator.shouldSkip(configClass.getMetadata(), ConfigurationPhase.PARSE_CONFIGURATION)) {\n\t\t\treturn;\n\t\t}\n\n\t\tConfigurationClass existingClass = this.configurationClasses.get(configClass);\n        //\u7701\u7565\u90e8\u5206\u4ee3\u7801\n\t\tSourceClass sourceClass = asSourceClass(configClass);\n\t\tdo {\n\t\t    //\u5904\u7406ConfigurationClass\n\t\t\tsourceClass = doProcessConfigurationClass(configClass, sourceClass);\n\t\t}\n\t\twhile (sourceClass != null);\n\n\t\tthis.configurationClasses.put(configClass, configClass);\n\t}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u4ee3\u7801\u5206\u6790\u53ef\u4ee5\u770b\u51fa\u6765\u4e3b\u8981\u662f\u901a\u8fc7 ",(0,s.jsx)(n.em,{children:(0,s.jsx)(n.strong,{children:"doProcessConfigurationClass"})})," \u65b9\u6cd5\u6765\u5904\u7406ConfigurationClass\u7c7b\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'protected final SourceClass doProcessConfigurationClass(ConfigurationClass configClass, SourceClass sourceClass)\n\t\t\tthrows IOException {\n\n\t\t//@Component\u6ce8\u89e3\u5904\u7406\n\t\tif (configClass.getMetadata().isAnnotated(Component.class.getName())) {\n\t\t\tprocessMemberClasses(configClass, sourceClass);\n\t\t}\n\n\t\t// @PropertySource\u6ce8\u89e3\u5904\u7406\n\t\tfor (AnnotationAttributes propertySource : AnnotationConfigUtils.attributesForRepeatable(\n\t\t\t\tsourceClass.getMetadata(), PropertySources.class,\n\t\t\t\torg.springframework.context.annotation.PropertySource.class)) {\n\t\t\tif (this.environment instanceof ConfigurableEnvironment) {\n\t\t\t\tprocessPropertySource(propertySource);\n\t\t\t}\n\t\t\telse {\n\t\t\t\t//\u7701\u7565\u65e5\u5fd7\u6253\u5370\n\t\t\t}\n\t\t}\n\t\t// @ComponentScan \u6ce8\u89e3\u5904\u7406\n\t\tSet<AnnotationAttributes> componentScans = AnnotationConfigUtils.attributesForRepeatable(\n\t\t\t\tsourceClass.getMetadata(), ComponentScans.class, ComponentScan.class);\n\t\tif (!componentScans.isEmpty() &&\n\t\t\t\t!this.conditionEvaluator.shouldSkip(sourceClass.getMetadata(), ConfigurationPhase.REGISTER_BEAN)) {\n\t\t\tfor (AnnotationAttributes componentScan : componentScans) {\n\t\t\t\t// The config class is annotated with @ComponentScan -> perform the scan immediately\n\t\t\t\tSet<BeanDefinitionHolder> scannedBeanDefinitions =\n\t\t\t\t\t\tthis.componentScanParser.parse(componentScan, sourceClass.getMetadata().getClassName());\n\t\t\t\t// Check the set of scanned definitions for any further config classes and parse recursively if needed\n\t\t\t\tfor (BeanDefinitionHolder holder : scannedBeanDefinitions) {\n\t\t\t\t\tBeanDefinition bdCand = holder.getBeanDefinition().getOriginatingBeanDefinition();\n\t\t\t\t\tif (bdCand == null) {\n\t\t\t\t\t\tbdCand = holder.getBeanDefinition();\n\t\t\t\t\t}\n\t\t\t\t\tif (ConfigurationClassUtils.checkConfigurationClassCandidate(bdCand, this.metadataReaderFactory)) {\n\t\t\t\t\t\tparse(bdCand.getBeanClassName(), holder.getBeanName());\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// @Import \u6ce8\u89e3\u5904\u7406\n\t\tprocessImports(configClass, sourceClass, getImports(sourceClass), true);\n\t\t// @ImportResource \u6ce8\u89e3\u5904\u7406\n\t\tAnnotationAttributes importResource =\n\t\t\t\tAnnotationConfigUtils.attributesFor(sourceClass.getMetadata(), ImportResource.class);\n\t\tif (importResource != null) {\n\t\t\tString[] resources = importResource.getStringArray("locations");\n\t\t\tClass<? extends BeanDefinitionReader> readerClass = importResource.getClass("reader");\n\t\t\tfor (String resource : resources) {\n\t\t\t\tString resolvedResource = this.environment.resolveRequiredPlaceholders(resource);\n\t\t\t\tconfigClass.addImportedResource(resolvedResource, readerClass);\n\t\t\t}\n\t\t}\n\n\t\t// @Bean \u6ce8\u89e3\u65b9\u6cd5\u5904\u7406\n\t\tSet<MethodMetadata> beanMethods = retrieveBeanMethodMetadata(sourceClass);\n\t\tfor (MethodMetadata methodMetadata : beanMethods) {\n\t\t\tconfigClass.addBeanMethod(new BeanMethod(methodMetadata, configClass));\n\t\t}\n\n\t\t// \u5904\u7406\u9ed8\u8ba4\u7684\u63a5\u53e3\u65b9\u6cd5\n\t\tprocessInterfaces(configClass, sourceClass);\n\n\t\t// \u5904\u7406\u7236\u7c7b\n\t\tif (sourceClass.getMetadata().hasSuperClass()) {\n\t\t\tString superclass = sourceClass.getMetadata().getSuperClassName();\n\t\t\tif (superclass != null && !superclass.startsWith("java") &&\n\t\t\t\t\t!this.knownSuperclasses.containsKey(superclass)) {\n\t\t\t\tthis.knownSuperclasses.put(superclass, configClass);\n\t\t\t\t// Superclass found, return its annotation metadata and recurse\n\t\t\t\treturn sourceClass.getSuperClass();\n\t\t\t}\n\t\t}\n\t\treturn null;\n\t}\t\t\n'})}),"\n",(0,s.jsx)(n.p,{children:"\u901a\u4e0a\u9762\u7684\u4ee3\u7801\u53ef\u4ee5\u53d1\u73b0\u4e3b\u8981\u5904\u7406\u4e86\u8fd9\u6837\u51e0\u4e2a\u6ce8\u89e3\uff1a"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"@Component\u6ce8\u89e3\u5904\u7406"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"@PropertySource\u6ce8\u89e3\u5904\u7406"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"@ComponentScan \u6ce8\u89e3\u5904\u7406"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"@Import \u6ce8\u89e3\u5904\u7406"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"@ImportResource \u6ce8\u89e3\u5904\u7406"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"@Bean \u6ce8\u89e3\u65b9\u6cd5\u5904\u7406"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"\u5904\u7406\u9ed8\u8ba4\u7684\u63a5\u53e3\u65b9\u6cd5"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"\u5904\u7406\u7236\u7c7b"})}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["\u5206\u6790\u5230\u8fd9\u91cc\u5c31\u53ef\u4ee5\u770b\u51fa\u6765\uff0c ",(0,s.jsx)(n.em,{children:(0,s.jsx)(n.strong,{children:"ConfigurationClassPostProcessor"})})," \u7c7b\u4e3b\u8981\u662f\u5904\u7406\u4e00\u4e0b\u7684\u51e0\u4e2a\u6ce8\u89e3\uff1a ",(0,s.jsx)(n.strong,{children:"Component\u3001PropertySources\u3001PropertySource\u3001ComponentScans\u3001ComponentScan\u3001Import\u3001ImportResource\u3001Bean"})," \u3002"]}),"\n",(0,s.jsx)(n.h3,{id:"3-configurationclasspostprocessor\u5982\u4f55\u6ce8\u5165\u5230spring-application\u4e2d",children:"3. ConfigurationClassPostProcessor\u5982\u4f55\u6ce8\u5165\u5230Spring Application\u4e2d"}),"\n",(0,s.jsxs)(n.p,{children:["\u901a\u8fc7 ",(0,s.jsx)(n.strong,{children:"AnnotationConfigUtils"})," \u7c7b\u4e2d\u7684\u9759\u6001\u65b9\u6cd5 ",(0,s.jsx)(n.strong,{children:"registerAnnotationConfigProcessors"})," \u6ce8\u5165\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'public static final String CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME =\n\t\t\t"org.springframework.context.annotation.internalConfigurationAnnotationProcessor";\n\n//\nif (!registry.containsBeanDefinition(CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME)) {\n\t\t\tRootBeanDefinition def = new RootBeanDefinition(ConfigurationClassPostProcessor.class);\n\t\t\tdef.setSource(source);\n\t\t\tbeanDefs.add(registerPostProcessor(registry, def, CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME));\n\t\t}\n'})})]})}function g(t={}){const{wrapper:n}={...(0,a.R)(),...t.components};return n?(0,s.jsx)(n,{...t,children:(0,s.jsx)(d,{...t})}):d(t)}},8453:(t,n,e)=>{e.d(n,{R:()=>r,x:()=>o});var s=e(6540);const a={},i=s.createContext(a);function r(t){const n=s.useContext(i);return s.useMemo((function(){return"function"==typeof t?t(n):{...n,...t}}),[n,t])}function o(t){let n;return n=t.disableParentContext?"function"==typeof t.components?t.components(a):t.components||a:r(t.components),s.createElement(i.Provider,{value:n},t.children)}}}]);