"use strict";(self.webpackChunkmxsm_website=self.webpackChunkmxsm_website||[]).push([[9530],{2719:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>i,contentTitle:()=>a,default:()=>d,frontMatter:()=>l,metadata:()=>s,toc:()=>u});var t=n(4848),o=n(8453);const l={title:"broker busy\u95ee\u9898",date:new Date("2020-04-05T00:00:00.000Z")},a=void 0,s={id:"rocketmq/rocketmq4/issue/broker-busy-issue",title:"broker busy\u95ee\u9898",description:"\u4e00\u8d77\u517b\u6210\u5199\u4f5c\u4e60\u60ef\uff01\u8fd9\u662f\u6211\u53c2\u4e0e\u300c\u6398\u91d1\u65e5\u65b0\u8ba1\u5212 \xb7 4 \u6708\u66f4\u6587\u6311\u6218\u300d\u7684\u7b2c20\u5929\uff0c\u70b9\u51fb\u67e5\u770b\u6d3b\u52a8\u8be6\u60c5\u3002",source:"@site/docs/rocketmq/rocketmq4/issue/broker-busy-issue.md",sourceDirName:"rocketmq/rocketmq4/issue",slug:"/rocketmq/rocketmq4/issue/broker-busy-issue",permalink:"/docs/rocketmq/rocketmq4/issue/broker-busy-issue",draft:!1,unlisted:!1,editUrl:"https://github.com/mxsm/mxsm-website/edit/develop/docs/rocketmq/rocketmq4/issue/broker-busy-issue.md",tags:[],version:"current",lastUpdatedBy:"mxsm",lastUpdatedAt:1710773855,formattedLastUpdatedAt:"Mar 18, 2024",frontMatter:{title:"broker busy\u95ee\u9898",date:"2020-04-05T00:00:00.000Z"}},i={},u=[{value:"1. \u95ee\u9898\u63cf\u8ff0",id:"1-\u95ee\u9898\u63cf\u8ff0",level:3},{value:"2. \u6e90\u7801\u5206\u6790\u95ee\u9898",id:"2-\u6e90\u7801\u5206\u6790\u95ee\u9898",level:3},{value:"3. \u5982\u4f55\u89e3\u51b3\u95ee\u9898",id:"3-\u5982\u4f55\u89e3\u51b3\u95ee\u9898",level:3}];function c(e){const r={a:"a",blockquote:"blockquote",code:"code",h3:"h3",p:"p",pre:"pre",strong:"strong",...(0,o.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(r.p,{children:["\u4e00\u8d77\u517b\u6210\u5199\u4f5c\u4e60\u60ef\uff01\u8fd9\u662f\u6211\u53c2\u4e0e\u300c\u6398\u91d1\u65e5\u65b0\u8ba1\u5212 \xb7 4 \u6708\u66f4\u6587\u6311\u6218\u300d\u7684\u7b2c20\u5929\uff0c",(0,t.jsx)(r.a,{href:"https://juejin.cn/post/7080800226365145118",children:"\u70b9\u51fb\u67e5\u770b\u6d3b\u52a8\u8be6\u60c5"}),"\u3002"]}),"\n",(0,t.jsxs)(r.blockquote,{children:["\n",(0,t.jsx)(r.p,{children:"Rocket MQ\u7248\u672c 4.8.0"}),"\n"]}),"\n",(0,t.jsx)(r.h3,{id:"1-\u95ee\u9898\u63cf\u8ff0",children:"1. \u95ee\u9898\u63cf\u8ff0"}),"\n",(0,t.jsx)(r.p,{children:"\u5728\u751f\u4ea7\u8005\u4e0d\u505c\u7684\u5f80Broker\u53d1\u9001\u6d88\u606f\u62a5broker busy\uff0c\u8fd9\u4e2a\u662f\u5728\u7814\u7a76RocketMQ\u6e90\u7801\u672c\u5730\u542f\u52a8\u670d\u52a1\u8fdb\u884c\u6d4b\u8bd5\u7684\u65f6\u5019\u51fa\u73b0\u7684\u3002"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-shell",children:"org.apache.rocketmq.client.exception.MQBrokerException: CODE: 2  DESC: [TIMEOUT_CLEAN_QUEUE]broker busy, start flow control for a while, period in queue: 240ms, size of queue: 9\nFor more information, please visit the url, http://rocketmq.apache.org/docs/faq/\n\tat org.apache.rocketmq.client.impl.MQClientAPIImpl.processSendResponse(MQClientAPIImpl.java:711)\n\tat org.apache.rocketmq.client.impl.MQClientAPIImpl.sendMessageSync(MQClientAPIImpl.java:505)\n\tat org.apache.rocketmq.client.impl.MQClientAPIImpl.sendMessage(MQClientAPIImpl.java:487)\n\tat org.apache.rocketmq.client.impl.MQClientAPIImpl.sendMessage(MQClientAPIImpl.java:431)\n\tat org.apache.rocketmq.client.impl.producer.DefaultMQProducerImpl.sendKernelImpl(DefaultMQProducerImpl.java:853)\n\tat org.apache.rocketmq.client.impl.producer.DefaultMQProducerImpl.sendDefaultImpl(DefaultMQProducerImpl.java:583)\n\tat org.apache.rocketmq.client.impl.producer.DefaultMQProducerImpl.send(DefaultMQProducerImpl.java:1342)\n\tat org.apache.rocketmq.client.impl.producer.DefaultMQProducerImpl.send(DefaultMQProducerImpl.java:1288)\n\tat org.apache.rocketmq.client.producer.DefaultMQProducer.send(DefaultMQProducer.java:324)\n\tat com.github.mxsm.MQProducer.lambda$main$0(MQProducer.java:50)\n\tat java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)\n\tat java.util.concurrent.FutureTask.run$$$capture(FutureTask.java:266)\n\tat java.util.concurrent.FutureTask.run(FutureTask.java)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\n\tat java.lang.Thread.run(Thread.java:748)\n"})}),"\n",(0,t.jsx)(r.p,{children:"\u90a3\u4e48\u6211\u4eec\u5c31\u4ece\u6e90\u7801\u5206\u6790\u95ee\u9898\uff0c\u770b\u770b\u5982\u4f55\u89e3\u51b3\u3002"}),"\n",(0,t.jsx)(r.h3,{id:"2-\u6e90\u7801\u5206\u6790\u95ee\u9898",children:"2. \u6e90\u7801\u5206\u6790\u95ee\u9898"}),"\n",(0,t.jsxs)(r.p,{children:["\u901a\u8fc7\u641c\u7d22\u9519\u8bef\u4fe1\u606f\u53ef\u4ee5\u5b9a\u4f4d\u5230\u9519\u8bef\u662f\u4ece ",(0,t.jsx)(r.strong,{children:(0,t.jsx)(r.code,{children:"BrokerFastFailure"})})," \u7c7b\u629b\u51fa\u6765\u7684\u3002"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-java",children:'    void cleanExpiredRequestInQueue(final BlockingQueue<Runnable> blockingQueue, final long maxWaitTimeMillsInQueue) {\n        while (true) {\n            try {\n                if (!blockingQueue.isEmpty()) {\n                    final Runnable runnable = blockingQueue.peek();\n                    if (null == runnable) {\n                        break;\n                    }\n                    final RequestTask rt = castRunnable(runnable);\n                    if (rt == null || rt.isStopRun()) {\n                        break;\n                    }\n\n                    final long behind = System.currentTimeMillis() - rt.getCreateTimestamp();\n                    if (behind >= maxWaitTimeMillsInQueue) {\n                        if (blockingQueue.remove(runnable)) {\n                            rt.setStopRun(true);\n                            rt.returnResponse(RemotingSysResponseCode.SYSTEM_BUSY, String.format("[TIMEOUT_CLEAN_QUEUE]broker busy, start flow control for a while, period in queue: %sms, size of queue: %d", behind, blockingQueue.size()));\n                        }\n                    } else {\n                        break;\n                    }\n                } else {\n                    break;\n                }\n            } catch (Throwable ignored) {\n            }\n        }\n    }\n'})}),"\n",(0,t.jsxs)(r.p,{children:["\u90a3\u4e48\u8fd9\u4e2a ",(0,t.jsx)(r.strong,{children:(0,t.jsx)(r.code,{children:"BrokerFastFailure#cleanExpiredRequestInQueue"})}),"  \u4e3b\u8981\u7528\u4e8e\u6e05\u7406\u963b\u585e\u961f\u5217\u4e2d\u7684\u8fc7\u671f\u7684 ",(0,t.jsx)(r.strong,{children:(0,t.jsx)(r.code,{children:"RequestTask"})})," \u3002\u8fd9\u4e2a\u65b9\u6cd5\u5728**",(0,t.jsx)(r.code,{children:"BrokerFastFailure#cleanExpiredRequest"}),"** \u4e2d\u88ab\u8c03\u7528\uff1a"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-java",children:'    private void cleanExpiredRequest() {\n        \n        //\u7cfb\u7edf\u9875\u5fd9\u629b\u9519\n        while (this.brokerController.getMessageStore().isOSPageCacheBusy()) {\n            try {\n                if (!this.brokerController.getSendThreadPoolQueue().isEmpty()) {\n                    final Runnable runnable = this.brokerController.getSendThreadPoolQueue().poll(0, TimeUnit.SECONDS);\n                    if (null == runnable) {\n                        break;\n                    }\n\n                    final RequestTask rt = castRunnable(runnable);\n                    rt.returnResponse(RemotingSysResponseCode.SYSTEM_BUSY, String.format("[PCBUSY_CLEAN_QUEUE]broker busy, start flow control for a while, period in queue: %sms, size of queue: %d", System.currentTimeMillis() - rt.getCreateTimestamp(), this.brokerController.getSendThreadPoolQueue().size()));\n                } else {\n                    break;\n                }\n            } catch (Throwable ignored) {\n            }\n        }\n\t\t//\u6e05\u7406\u8fc7\u671f\u53d1\u9001\u6d88\u606f\u961f\u5217\u8bf7\u6c42\n        cleanExpiredRequestInQueue(this.brokerController.getSendThreadPoolQueue(),\n            this.brokerController.getBrokerConfig().getWaitTimeMillsInSendQueue());\n\t\t//\u6e05\u7406\u8fc7\u671f\u62c9\u53d6\u6d88\u606f\u7684\u8bf7\u6c42\n        cleanExpiredRequestInQueue(this.brokerController.getPullThreadPoolQueue(),\n            this.brokerController.getBrokerConfig().getWaitTimeMillsInPullQueue());\n\t\t//\u6e05\u7406\u8fc7\u671f\u5fc3\u8df3\u7684\u8bf7\u6c42\n        cleanExpiredRequestInQueue(this.brokerController.getHeartbeatThreadPoolQueue(),\n            this.brokerController.getBrokerConfig().getWaitTimeMillsInHeartbeatQueue());\n//\u6e05\u7406\u8fc7\u671f\u4e8b\u52a1\u8bf7\u6c42\n        cleanExpiredRequestInQueue(this.brokerController.getEndTransactionThreadPoolQueue(), this\n            .brokerController.getBrokerConfig().getWaitTimeMillsInTransactionQueue());\n    }\n'})}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"\u7531\u4e8e\u662f\u4e4b\u524d\u5728\u4e0d\u505c\u7684\u5f80MQ\u53d1\u9001\u6d88\u606f\u6d88\u606f\uff0c\u6240\u4ee5\u5224\u65ad\u662f\u7531\u4e8e\u6e05\u7406\u8fc7\u671f\u7684\u53d1\u9001\u5904\u7406\u8bf7\u6c42\u5bfc\u81f4\u7684\u3002"})}),"\n",(0,t.jsx)(r.h3,{id:"3-\u5982\u4f55\u89e3\u51b3\u95ee\u9898",children:"3. \u5982\u4f55\u89e3\u51b3\u95ee\u9898"}),"\n",(0,t.jsx)(r.p,{children:"\u90a3\u4e48\u5982\u4f55\u89e3\u51b3\u95ee\u9898\uff0c\u901a\u8fc7\u4ee3\u7801\uff1a"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-java",children:"cleanExpiredRequestInQueue(this.brokerController.getSendThreadPoolQueue(),\n            this.brokerController.getBrokerConfig().getWaitTimeMillsInSendQueue());\n"})}),"\n",(0,t.jsx)(r.p,{children:"\u53ef\u4ee5\u770b\u4e00\u51fa\u6765\u901a\u8fc7\u589e\u52a0\u7b49\u5f85\u65f6\u95f4\u6765\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u3002\u53ea\u9700\u8981\u5728\u914d\u7f6eBroker\u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\u4fee\u6539\u5982\u4e0b\u503c\u5373\u53ef\uff1a"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-properties",children:"waitTimeMillsInSendQueue=200 \uff08\u9ed8\u8ba4\u503c\uff09--\u4fee\u6539\u8fd9\u4e2a\u503c\n"})}),"\n",(0,t.jsxs)(r.blockquote,{children:["\n",(0,t.jsx)(r.p,{children:"\u6211\u662f\u8682\u8681\u80cc\u5927\u8c61\uff0c\u6587\u7ae0\u5bf9\u4f60\u6709\u5e2e\u52a9\u70b9\u8d5e\u5173\u6ce8\u6211\uff0c\u6587\u7ae0\u6709\u4e0d\u6b63\u786e\u7684\u5730\u65b9\u8bf7\u60a8\u65a7\u6b63\u7559\u8a00\u8bc4\u8bba~\u8c22\u8c22\uff01"}),"\n"]})]})}function d(e={}){const{wrapper:r}={...(0,o.R)(),...e.components};return r?(0,t.jsx)(r,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},8453:(e,r,n)=>{n.d(r,{R:()=>a,x:()=>s});var t=n(6540);const o={},l=t.createContext(o);function a(e){const r=t.useContext(l);return t.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function s(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),t.createElement(l.Provider,{value:r},e.children)}}}]);