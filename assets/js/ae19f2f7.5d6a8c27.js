"use strict";(self.webpackChunkmxsm_website=self.webpackChunkmxsm_website||[]).push([[306],{7013:(t,e,n)=>{n.r(e),n.d(e,{assets:()=>l,contentTitle:()=>s,default:()=>p,frontMatter:()=>i,metadata:()=>a,toc:()=>c});var r=n(4848),o=n(8453);const i={title:"ContextLoaderListener \u6e90\u7801\u5206\u6790",date:new Date("2018-09-18T00:00:00.000Z")},s=void 0,a={id:"spring/spring-framework/web-source-analysis/ContextLoaderListener",title:"ContextLoaderListener \u6e90\u7801\u5206\u6790",description:"1. ContextLoaderListener\u7c7b",source:"@site/docs/spring/spring-framework/web-source-analysis/ContextLoaderListener.md",sourceDirName:"spring/spring-framework/web-source-analysis",slug:"/spring/spring-framework/web-source-analysis/ContextLoaderListener",permalink:"/docs/spring/spring-framework/web-source-analysis/ContextLoaderListener",draft:!1,unlisted:!1,editUrl:"https://github.com/mxsm/mxsm-website/edit/develop/docs/spring/spring-framework/web-source-analysis/ContextLoaderListener.md",tags:[],version:"current",lastUpdatedBy:"mxsm",lastUpdatedAt:1711106468,formattedLastUpdatedAt:"Mar 22, 2024",frontMatter:{title:"ContextLoaderListener \u6e90\u7801\u5206\u6790",date:"2018-09-18T00:00:00.000Z"},sidebar:"springframework",previous:{title:"Spring\u4e8b\u52a1\u5904\u7406\u6e90\u7801\u89e3\u6790",permalink:"/docs/spring/spring-framework/core-source-analysis/transaction-processing"},next:{title:"DispatcherServlet\u6e90\u7801\u89e3\u6790",permalink:"/docs/spring/spring-framework/web-source-analysis/DispatcherServlet"}},l={},c=[{value:"1. ContextLoaderListener\u7c7b",id:"1-contextloaderlistener\u7c7b",level:3}];function x(t){const e={a:"a",br:"br",code:"code",em:"em",h3:"h3",p:"p",pre:"pre",strong:"strong",...(0,o.R)(),...t.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.h3,{id:"1-contextloaderlistener\u7c7b",children:"1. ContextLoaderListener\u7c7b"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public class ContextLoaderListener extends ContextLoader implements ServletContextListener {\n    //....... \u7701\u7565\u4ee3\u7801\n    @Override\n\tpublic void contextInitialized(ServletContextEvent event) {\n\t\tinitWebApplicationContext(event.getServletContext());\n\t}\n}\n"})}),"\n",(0,r.jsxs)(e.p,{children:["\u7ee7\u627f\u4e86 ",(0,r.jsx)(e.em,{children:"ContextLoader"})," (Spring\u7684\u7c7b)\uff0c\u5b9e\u73b0\u4e86 ",(0,r.jsx)(e.em,{children:(0,r.jsx)(e.strong,{children:"ServletContextListener"})})," \u63a5\u53e3(Servlet3.1\u7684\u76d1\u542c\u63a5\u53e3)\u3002",(0,r.jsx)(e.br,{}),"\n","\u901a\u8fc7\u8c03\u7528 ",(0,r.jsx)(e.em,{children:"contextInitialized"})," \u65b9\u6cd5\u6765\u521d\u59cb\u5316Spring\u4e0a\u4e0b\u6587"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'\npublic WebApplicationContext initWebApplicationContext(ServletContext servletContext) {\n\t\tif (servletContext.getAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE) != null) {\n\t\t  //\u629b\u5f02\u5e38\n\t\t}\n\t\tservletContext.log("Initializing Spring root WebApplicationContext");\n\t\tLog logger = LogFactory.getLog(ContextLoader.class);\n\t\tif (logger.isInfoEnabled()) {\n\t\t\tlogger.info("Root WebApplicationContext: initialization started");\n\t\t}\n\t\tlong startTime = System.currentTimeMillis();\n\t\ttry {\n\t\t\t//\u5224\u65ad\u4e0a\u4e0b\u6587\u662f\u5426\u4e3a\u7a7a\n\t\t\tif (this.context == null) {\n\t\t\t   //\u521b\u5efaSpring\u4e0a\u4e0b\u6587\n\t\t\t\tthis.context = createWebApplicationContext(servletContext);\n\t\t\t}\n\t\t\tif (this.context instanceof ConfigurableWebApplicationContext) {\n\t\t\t\tConfigurableWebApplicationContext cwac = (ConfigurableWebApplicationContext) this.context;\n\t\t\t\tif (!cwac.isActive()) {\n\t\t\t\t\t// The context has not yet been refreshed -> provide services such as\n\t\t\t\t\t// setting the parent context, setting the application context id, etc\n\t\t\t\t\tif (cwac.getParent() == null) {\n\t\t\t\t\t\t// The context instance was injected without an explicit parent ->\n\t\t\t\t\t\t// determine parent for root web application context, if any.\n\t\t\t\t\t\tApplicationContext parent = loadParentContext(servletContext);\n\t\t\t\t\t\tcwac.setParent(parent);\n\t\t\t\t\t}\n\t\t\t\t\tconfigureAndRefreshWebApplicationContext(cwac, servletContext);\n\t\t\t\t}\n\t\t\t}\n\t\t\t//\u628a\u4e0a\u4e0b\u6587\u8bbe\u7f6e\u5230servlet\u4e0a\u4e0b\u6587\u4e2d\n\t\t\tservletContext.setAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE, this.context);\n\n\t\t\tClassLoader ccl = Thread.currentThread().getContextClassLoader();\n\t\t\tif (ccl == ContextLoader.class.getClassLoader()) {\n\t\t\t\tcurrentContext = this.context;\n\t\t\t}\n\t\t\telse if (ccl != null) {\n\t\t\t\tcurrentContextPerThread.put(ccl, this.context);\n\t\t\t}\n\n\t\t\tif (logger.isInfoEnabled()) {\n\t\t\t\tlong elapsedTime = System.currentTimeMillis() - startTime;\n\t\t\t\tlogger.info("Root WebApplicationContext initialized in " + elapsedTime + " ms");\n\t\t\t}\n\n\t\t\treturn this.context;\n\t\t}\n\t\tcatch (RuntimeException | Error ex) {\n\t\t\tlogger.error("Context initialization failed", ex);\n\t\t\tservletContext.setAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE, ex);\n\t\t\tthrow ex;\n\t\t}\n\t}\n'})}),"\n",(0,r.jsx)(e.p,{children:"\u901a\u8fc7createWebApplicationContext(servletContext)\u65b9\u6cd5\u6765\u521b\u5efaWebApplicationContext\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"protected WebApplicationContext createWebApplicationContext(ServletContext sc) {\n        //\u52a0\u8f7d\u5bf9\u5e94\u7684\u7c7b\n\t\tClass<?> contextClass = determineContextClass(sc);\n\t\tif (!ConfigurableWebApplicationContext.class.isAssignableFrom(contextClass)) {\n\t\t    //\u629b\u5f02\u5e38\n\t\t}\n\t\t//\u5b9e\u4f8b\u5316\u5bf9\u8c61\n\t\treturn (ConfigurableWebApplicationContext) BeanUtils.instantiateClass(contextClass);\n\t}\n\nprotected Class<?> determineContextClass(ServletContext servletContext) {\n        //\u83b7\u53d6 servletContext \u4e2d\u7684 contextClass \u53c2\u6570\u503c\n\t\tString contextClassName = servletContext.getInitParameter(CONTEXT_CLASS_PARAM);\n\t\t//\u5982\u679c\u6ca1\u6709\u8bbe\u7f6econtextClass\u503c\n\t\tif (contextClassName != null) {\n\t\t\ttry {\n\t\t\t\treturn ClassUtils.forName(contextClassName, ClassUtils.getDefaultClassLoader());\n\t\t\t}\n\t\t\tcatch (ClassNotFoundException ex) {\n\t\t\t\t//\u6ca1\u6709\u627e\u5230\u629b\u5f02\u5e38\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t    //\u9ed8\u8ba4\u52a0\u8f7d\u7684\u662fXmlWebApplicationContext--\u914d\u7f6e\u5728ContextLoader.properties\u6587\u4ef6\u4e2d\n\t\t\tcontextClassName = defaultStrategies.getProperty(WebApplicationContext.class.getName());\n\t\t\ttry {\n\t\t\t\treturn ClassUtils.forName(contextClassName, ContextLoader.class.getClassLoader());\n\t\t\t}\n\t\t\tcatch (ClassNotFoundException ex) {\n\t\t\t  \t//\u6ca1\u6709\u627e\u5230\u629b\u5f02\u5e38\n\t\t\t}\n\t\t}\n\t}\n"})}),"\n",(0,r.jsxs)(e.p,{children:["\u901a\u8fc7\u4e0a\u9762\u7684\u5206\u6790\u770b\u51fa\u4ee5\u53ca\u7ed3\u5408\u4e4b\u524d\u7684 ",(0,r.jsx)(e.a,{href:"https://github.com/mxsm/document/blob/master/Spring/Springframework/Spring-web%E5%88%86%E6%9E%90/Spring%20Web%20Context.md",children:"Spring Web Contexts"})," \u7684\u6587\u7ae0\u8bb2\u7684\u5982\u4f55\u914d\u7f6e\u4e0d\u540c\u7684Spirng Context\u3002"]})]})}function p(t={}){const{wrapper:e}={...(0,o.R)(),...t.components};return e?(0,r.jsx)(e,{...t,children:(0,r.jsx)(x,{...t})}):x(t)}},8453:(t,e,n)=>{n.d(e,{R:()=>s,x:()=>a});var r=n(6540);const o={},i=r.createContext(o);function s(t){const e=r.useContext(i);return r.useMemo((function(){return"function"==typeof t?t(e):{...e,...t}}),[e,t])}function a(t){let e;return e=t.disableParentContext?"function"==typeof t.components?t.components(o):t.components||o:s(t.components),r.createElement(i.Provider,{value:e},t.children)}}}]);