"use strict";(self.webpackChunkmxsm_website=self.webpackChunkmxsm_website||[]).push([[8525],{3692:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>a,default:()=>u,frontMatter:()=>r,metadata:()=>i,toc:()=>c});var s=n(4848),o=n(8453);const r={title:"RocketMQ\u6e90\u7801\u89e3\u6790-\u6d88\u8d39\u6a21\u5f0f\u6d88\u8d39\u8fdb\u5ea6\u52a0\u8f7d\u6e90\u7801\u89e3\u6790",date:new Date("2021-06-14T00:00:00.000Z"),weight:202106102132},a=void 0,i={id:"rocketmq/rocketmq4/consumer/RocketMQ-analysis-consumer-messagemodel",title:"RocketMQ\u6e90\u7801\u89e3\u6790-\u6d88\u8d39\u6a21\u5f0f\u6d88\u8d39\u8fdb\u5ea6\u52a0\u8f7d\u6e90\u7801\u89e3\u6790",description:"\u4ee5\u4e0b\u6e90\u7801\u57fa\u4e8eRocketMQ 4.8.0",source:"@site/docs/rocketmq/rocketmq4/consumer/RocketMQ-analysis-consumer-messagemodel.md",sourceDirName:"rocketmq/rocketmq4/consumer",slug:"/rocketmq/rocketmq4/consumer/RocketMQ-analysis-consumer-messagemodel",permalink:"/docs/rocketmq/rocketmq4/consumer/RocketMQ-analysis-consumer-messagemodel",draft:!1,unlisted:!1,editUrl:"https://github.com/mxsm/mxsm-website/edit/develop/docs/rocketmq/rocketmq4/consumer/RocketMQ-analysis-consumer-messagemodel.md",tags:[],version:"current",lastUpdatedBy:"mxsm",lastUpdatedAt:1710773855,formattedLastUpdatedAt:"Mar 18, 2024",frontMatter:{title:"RocketMQ\u6e90\u7801\u89e3\u6790-\u6d88\u8d39\u6a21\u5f0f\u6d88\u8d39\u8fdb\u5ea6\u52a0\u8f7d\u6e90\u7801\u89e3\u6790",date:"2021-06-14T00:00:00.000Z",weight:202106102132},sidebar:"rocketmq4",previous:{title:"RocketMQ\u6e90\u7801\u89e3\u6790-\u5e76\u53d1\u6d88\u8d39\u6d88\u606f\u6e90\u7801\u89e3\u6790",permalink:"/docs/rocketmq/rocketmq4/consumer/RocketMQ-analysis-consumer-concurrently"},next:{title:"RocketMQ\u6e90\u7801\u89e3\u6790-\u6d88\u8d39\u8005\u91cd\u590d\u6d88\u8d39",permalink:"/docs/rocketmq/rocketmq4/consumer/RocketMQ-analysis-consumer-repeat-consume"}},l={},c=[{value:"1. \u4ece\u4f55\u5904\u52a0\u8f7d\u6d88\u8d39\u8fdb\u5ea6\uff1f",id:"1-\u4ece\u4f55\u5904\u52a0\u8f7d\u6d88\u8d39\u8fdb\u5ea6",level:3}];function f(e){const t={blockquote:"blockquote",code:"code",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(t.blockquote,{children:["\n",(0,s.jsx)(t.p,{children:"\u4ee5\u4e0b\u6e90\u7801\u57fa\u4e8eRocketMQ 4.8.0"}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"MQ\u7684\u6d88\u8d39\u6a21\u5f0f\u901a\u8fc7\u4e4b\u524d\u7684\u5206\u6790\u53ef\u4ee5\u77e5\u9053\u6709\u4e24\u79cd\uff1a"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"\u96c6\u7fa4\u6d88\u8d39\u6a21\u5f0f(CLUSTERING)"}),"\n",(0,s.jsx)(t.li,{children:"\u5e7f\u64ad\u6d88\u8d39\u6a21\u5f0f(BROADCASTING)"}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"\u4e24\u79cd\u4e0d\u540c\u7c7b\u578b\u7684\u6d88\u8d39\u6a21\u5f0f\u5f53\u4e2d\u6709\u533a\u522b\uff0c\u4e0b\u9762\u901a\u8fc7\u6e90\u7801\u6765\u8bf4\u660e\uff1a"}),"\n",(0,s.jsx)(t.h3,{id:"1-\u4ece\u4f55\u5904\u52a0\u8f7d\u6d88\u8d39\u8fdb\u5ea6",children:"1. \u4ece\u4f55\u5904\u52a0\u8f7d\u6d88\u8d39\u8fdb\u5ea6\uff1f"}),"\n",(0,s.jsx)(t.p,{children:"\u4ece\u4e4b\u524d\u7684\u5206\u6790\u53ef\u4ee5\u77e5\u9053\uff0cConsumer\u901a\u8fc7\u8c03\u7528\uff1a"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-java",children:"consumer.start();\n"})}),"\n",(0,s.jsxs)(t.p,{children:["\u5728\u542f\u52a8\u540e\u4f1a\u52a0\u8f7d\u6d88\u8d39\u8fdb\u5ea6 ",(0,s.jsx)(t.strong,{children:(0,s.jsx)(t.code,{children:"DefaultMQPushConsumerImpl#start"})})," \u4ee3\u7801\u7247\u6bb5\uff1a"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-java",children:" if (this.defaultMQPushConsumer.getOffsetStore() != null) {\n     this.offsetStore = this.defaultMQPushConsumer.getOffsetStore();\n } else {\n     switch (this.defaultMQPushConsumer.getMessageModel()) {\n         case BROADCASTING:\n             this.offsetStore = new LocalFileOffsetStore(this.mQClientFactory, this.defaultMQPushConsumer.getConsumerGroup());\n             break;\n         case CLUSTERING:\n             this.offsetStore = new RemoteBrokerOffsetStore(this.mQClientFactory, this.defaultMQPushConsumer.getConsumerGroup());\n             break;\n         default:\n             break;\n     }\n     this.defaultMQPushConsumer.setOffsetStore(this.offsetStore);\n }\n this.offsetStore.load();\n"})}),"\n",(0,s.jsx)(t.p,{children:"\u4ee3\u7801\u53ef\u4ee5\u770b\u51fa\uff1a"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"BROADCASTING\u7684\u6d88\u8d39\u6a21\u5f0f\u6d88\u8d39\u8fdb\u5ea6\u7684\u6301\u4e45\u5316\u7531LocalFileOffsetStore\u5b9e\u73b0"}),"\n",(0,s.jsx)(t.li,{children:"CLUSTERING\u7684\u6d88\u8d39\u6a21\u5f0f\u6d88\u8d39\u8fdb\u5ea6\u7684\u6301\u4e45\u5316\u7531RemoteBrokerOffsetStore\u5b9e\u73b0"}),"\n"]}),"\n",(0,s.jsxs)(t.p,{children:["\u4e24\u8005\u90fd\u5b9e\u73b0\u4e86 ",(0,s.jsx)(t.strong,{children:(0,s.jsx)(t.code,{children:"OffsetStore"})})," \u63a5\u53e3\uff0c\u8be5\u63a5\u53e3\u63d0\u4f9b\u4e86\u4f8b\u5982\uff1a\u52a0\u8f7d\u6d88\u8d39\u8fdb\u5ea6\u3001\u6301\u4e45\u5316\u6d88\u8d39\u8fdb\u5ea6\u3001\u66f4\u65b0\u6d88\u8d39\u8fdb\u5ea6\u7b49\u529f\u80fd\uff1a"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-java",children:"public interface OffsetStore {\n    void load() throws MQClientException;\n\n    void updateOffset(final MessageQueue mq, final long offset, final boolean increaseOnly);\n\n    long readOffset(final MessageQueue mq, final ReadOffsetType type);\n\n    void persistAll(final Set<MessageQueue> mqs);\n\n    void persist(final MessageQueue mq);\n\n    void removeOffset(MessageQueue mq);\n\n    Map<MessageQueue, Long> cloneOffsetTable(String topic);\n\n    void updateConsumeOffsetToBroker(MessageQueue mq, long offset, boolean isOneway) throws RemotingException,\n        MQBrokerException, InterruptedException, MQClientException;\n}\n\n"})}),"\n",(0,s.jsx)(t.p,{children:"\u901a\u8fc7\u4e0a\u9762\u7684\u5206\u6790\u53ef\u4ee5\u770b\u51fa\u6765\uff0c\u662f\u901a\u8fc7\u8c03\u7528 OffsetStore#load\u65b9\u6cd5\u6765\u52a0\u8f7d\u6d88\u8d39\u8fdb\u5ea6\u3002"}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.strong,{children:"RemoteBrokerOffsetStore#load"})," \u7684\u5b9e\u73b0\uff1a"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-java",children:"public class RemoteBrokerOffsetStore implements OffsetStore {\n    private final static InternalLogger log = ClientLogger.getLog();\n    private final MQClientInstance mQClientFactory;\n    private final String groupName;\n    private ConcurrentMap<MessageQueue, AtomicLong> offsetTable =\n        new ConcurrentHashMap<MessageQueue, AtomicLong>();\n\n    public RemoteBrokerOffsetStore(MQClientInstance mQClientFactory, String groupName) {\n        this.mQClientFactory = mQClientFactory;\n        this.groupName = groupName;\n    }\n\n    @Override\n    public void load() {\n        \n        //\u7a7a\u5b9e\u73b0\uff1f\n        \n    }\n\t//\u7701\u7565\u90e8\u5206\u4ee3\u7801\n}\n"})}),"\n",(0,s.jsxs)(t.blockquote,{children:["\n",(0,s.jsx)(t.p,{children:"RemoteBrokerOffsetStore\u53d1\u73b0\u662f\u7a7a\u5b9e\u73b0\uff0c\u539f\u56e0\u662f\u56e0\u4e3a\u96c6\u7fa4\u6d88\u8d39\u7684\u6d88\u8d39\u8fdb\u5ea6\u4fdd\u5b58\u5728Broker\u7aef"}),"\n"]}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.strong,{children:"LocalFileOffsetStore#load"})," \u5b9e\u73b0\uff1a"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-java",children:'public class LocalFileOffsetStore implements OffsetStore {\n    public final static String LOCAL_OFFSET_STORE_DIR = System.getProperty(\n        "rocketmq.client.localOffsetStoreDir",\n        System.getProperty("user.home") + File.separator + ".rocketmq_offsets");\n    private final static InternalLogger log = ClientLogger.getLog();\n    private final MQClientInstance mQClientFactory;\n    private final String groupName;\n    private final String storePath;\n    private ConcurrentMap<MessageQueue, AtomicLong> offsetTable =\n        new ConcurrentHashMap<MessageQueue, AtomicLong>();\n\n    @Override\n    public void load() throws MQClientException {\n        OffsetSerializeWrapper offsetSerializeWrapper = this.readLocalOffset();\n        if (offsetSerializeWrapper != null && offsetSerializeWrapper.getOffsetTable() != null) {\n            offsetTable.putAll(offsetSerializeWrapper.getOffsetTable());\n\n            for (MessageQueue mq : offsetSerializeWrapper.getOffsetTable().keySet()) {\n                AtomicLong offset = offsetSerializeWrapper.getOffsetTable().get(mq);\n                log.info("load consumer\'s offset, {} {} {}",\n                    this.groupName,\n                    mq,\n                    offset.get());\n            }\n        }\n    }\n    //\u7701\u7565\u5176\u4ed6\u4ee3\u7801\n}\n'})}),"\n",(0,s.jsx)(t.p,{children:"\u901a\u8fc7 LocalFileOffsetStore#load\u5b9e\u73b0\u53ef\u4ee5\u770b\u51fa\u6765\uff0c\u5e7f\u64ad\u6d88\u8d39\u662f\u5728\u672c\u5730\u52a0\u8f7d\u6d88\u8d39\u8fdb\u5ea6\uff0c\u6d88\u8d39\u8fdb\u5ea6\u4fdd\u5b58\u5728\u6d88\u8d39\u8005\u672c\u5730\u3002"})]})}function u(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(f,{...e})}):f(e)}},8453:(e,t,n)=>{n.d(t,{R:()=>a,x:()=>i});var s=n(6540);const o={},r=s.createContext(o);function a(e){const t=s.useContext(r);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function i(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),s.createElement(r.Provider,{value:t},e.children)}}}]);