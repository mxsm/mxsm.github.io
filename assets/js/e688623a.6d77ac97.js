"use strict";(self.webpackChunkmxsm_website=self.webpackChunkmxsm_website||[]).push([[5786],{8283:(n,t,e)=>{e.r(t),e.d(t,{assets:()=>r,contentTitle:()=>s,default:()=>h,frontMatter:()=>o,metadata:()=>d,toc:()=>l});var a=e(4848),i=e(8453);const o={title:"spring\u6ce8\u89e3\u6e90\u7801\u89e3\u6790\u4e4b-Conditional",linkTitle:"spring\u6ce8\u89e3\u6e90\u7801\u89e3\u6790\u4e4b-Conditional",date:new Date("2018-04-15T00:00:00.000Z"),weight:2},s=void 0,d={id:"spring/spring-framework/annotation-source-analysis/conditional",title:"spring\u6ce8\u89e3\u6e90\u7801\u89e3\u6790\u4e4b-Conditional",description:"1. Conditional\u6ce8\u89e3\u7684\u4f5c\u7528",source:"@site/docs/spring/spring-framework/annotation-source-analysis/conditional.md",sourceDirName:"spring/spring-framework/annotation-source-analysis",slug:"/spring/spring-framework/annotation-source-analysis/conditional",permalink:"/docs/spring/spring-framework/annotation-source-analysis/conditional",draft:!1,unlisted:!1,editUrl:"https://github.com/mxsm/mxsm-website/edit/develop/docs/spring/spring-framework/annotation-source-analysis/conditional.md",tags:[],version:"current",lastUpdatedBy:"mxsm",lastUpdatedAt:1728574453e3,frontMatter:{title:"spring\u6ce8\u89e3\u6e90\u7801\u89e3\u6790\u4e4b-Conditional",linkTitle:"spring\u6ce8\u89e3\u6e90\u7801\u89e3\u6790\u4e4b-Conditional",date:"2018-04-15T00:00:00.000Z",weight:2}},r={},l=[{value:"1. Conditional\u6ce8\u89e3\u7684\u4f5c\u7528",id:"1-conditional\u6ce8\u89e3\u7684\u4f5c\u7528",level:3},{value:"2. \u4ece\u6e90\u7801\u89e3\u6790Conditional\u5982\u4f55\u53d1\u6325\u4f5c\u7528",id:"2-\u4ece\u6e90\u7801\u89e3\u6790conditional\u5982\u4f55\u53d1\u6325\u4f5c\u7528",level:3}];function c(n){const t={blockquote:"blockquote",code:"code",em:"em",h3:"h3",p:"p",pre:"pre",strong:"strong",...(0,i.R)(),...n.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(t.h3,{id:"1-conditional\u6ce8\u89e3\u7684\u4f5c\u7528",children:"1. Conditional\u6ce8\u89e3\u7684\u4f5c\u7528"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-java",children:"@Target({ElementType.TYPE, ElementType.METHOD})\n@Retention(RetentionPolicy.RUNTIME)\n@Documented\npublic @interface Conditional {\n\n\tClass<? extends Condition>[] value();\n\n}\n"})}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-java",children:"@FunctionalInterface\npublic interface Condition {\n\n\tboolean matches(ConditionContext context, AnnotatedTypeMetadata metadata);\n\n}\n"})}),"\n",(0,a.jsx)(t.p,{children:"\u4e00\u4e2a\u662f\u6ce8\u89e3\u3001\u4e00\u4e2a\u662f\u63a5\u53e3\u3002"}),"\n",(0,a.jsx)(t.h3,{id:"2-\u4ece\u6e90\u7801\u89e3\u6790conditional\u5982\u4f55\u53d1\u6325\u4f5c\u7528",children:"2. \u4ece\u6e90\u7801\u89e3\u6790Conditional\u5982\u4f55\u53d1\u6325\u4f5c\u7528"}),"\n",(0,a.jsxs)(t.p,{children:["\u901a\u8fc7\u6e90\u7801\u5206\u6790\u6ce8\u89e3 ",(0,a.jsx)(t.strong,{children:"Conditional"})," \u4e3b\u8981\u5728\u4e09\u4e2a\u7c7b\u4e2d\u3002 ",(0,a.jsx)(t.strong,{children:"AnnotatedBeanDefinitionReader"})," \u3001 ",(0,a.jsx)(t.strong,{children:"ClassPathScanningCandidateComponentProvider"})," \u3001 ",(0,a.jsx)(t.strong,{children:"ConditionEvaluator"})," \u3002\u901a\u8fc7\u8fdb\u4e00\u6b65\u5206\u6790\u53d1\u73b0 ",(0,a.jsx)(t.strong,{children:"AnnotatedBeanDefinitionReader\u3001ClassPathScanningCandidateComponentProvider"})," \u4e2d\u90fd\u5305\u542b\u4e86 ",(0,a.jsx)(t.strong,{children:(0,a.jsx)(t.code,{children:"ConditionEvaluator"})})," \u7c7b\u7684\u53d8\u91cf\u3002",(0,a.jsx)(t.strong,{children:(0,a.jsx)(t.code,{children:"AnnotatedBeanDefinitionReader"})})," \u4e3b\u8981\u7528\u6765\u8bfb\u53d6\u6ce8\u89e3\u7684BeanDefinition\uff0c\u800c ",(0,a.jsx)(t.strong,{children:(0,a.jsx)(t.code,{children:"ClassPathScanningCandidateComponentProvider"})})," \u4e3b\u8981\u7531 ",(0,a.jsx)(t.strong,{children:(0,a.jsx)(t.code,{children:"ClassPathBeanDefinitionScanner"})})," \u7ee7\u627f\uff0c\u8be5\u7c7b\u4e3b\u8981\u7528\u6765\u626b\u63cfclass path \u7684BeanDefinition\u3002\u4e0b\u9762\u901a\u8fc7\u5206\u6790\u4e00\u4e0b ",(0,a.jsx)(t.strong,{children:(0,a.jsx)(t.code,{children:"ClassPathBeanDefinitionScanner"})})," \u6e90\u7801\u6765\u770b\u4e00\u4e0b\u5982\u4f55\u53d1\u6325\u4f5c\u7528\u7684\uff0c\u770b\u4e00\u4e0b ",(0,a.jsx)(t.strong,{children:(0,a.jsx)(t.code,{children:"ClassPathBeanDefinitionScanner#doScan"})})," \u65b9\u6cd5\uff1a"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-java",children:"protected Set<BeanDefinitionHolder> doScan(String... basePackages) {\n    \n    //\u7701\u7565\u90e8\u5206\u4ee3\u7801\n    \n    for (String basePackage : basePackages) {\n            //\u8fd9\u4e2a\u65b9\u6cd5\u6765\u627e\u5230\u5019\u9009\u7684BeanDefinition\n\t\t\tSet<BeanDefinition> candidates = findCandidateComponents(basePackage);\n        \n        //\u751f\u8def\u90e8\u5206\u4ee3\u7801\n    }\n}\n"})}),"\n",(0,a.jsxs)(t.p,{children:["\u90a3\u4e48\u518d\u6765\u770b\u4e00\u4e0b ",(0,a.jsx)(t.strong,{children:"ClassPathScanningCandidateComponentProvider#findCandidateComponents"})," \u65b9\u6cd5\uff1a"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-java",children:"\tpublic Set<BeanDefinition> findCandidateComponents(String basePackage) {\n\t\tif (this.componentsIndex != null && indexSupportsIncludeFilters()) {\n\t\t\treturn addCandidateComponentsFromIndex(this.componentsIndex, basePackage);\n\t\t}\n\t\telse {\n\t\t\treturn scanCandidateComponents(basePackage);\n\t\t}\n\t}\n"})}),"\n",(0,a.jsxs)(t.p,{children:["\u8fdb\u4e00\u6b65\u5206\u6790\u4e0a\u9762\u7684 ",(0,a.jsx)(t.strong,{children:"scanCandidateComponents"})," \u548c ",(0,a.jsx)(t.strong,{children:"addCandidateComponentsFromIndex"})," \u65b9\u6cd5\u53d1\u73b0\uff0c\u8fd9\u4e24\u4e2a\u65b9\u6cd5\u4e2d\u90fd\u8c03\u7528\u4e86\u540c\u4e00\u4e2a\u65b9\u6cd5 ",(0,a.jsx)(t.strong,{children:"ClassPathScanningCandidateComponentProvider#isCandidateComponent"})," \uff1a"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-java",children:"\tprotected boolean isCandidateComponent(MetadataReader metadataReader) throws IOException {\n\t    //excludeFilters\u6392\u9664\n\t\tfor (TypeFilter tf : this.excludeFilters) {\n\t\t\tif (tf.match(metadataReader, getMetadataReaderFactory())) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\t\tfor (TypeFilter tf : this.includeFilters) {\n\t\t\tif (tf.match(metadataReader, getMetadataReaderFactory())) {\n\t\t\t    //\u8fd9\u4e2a\u65b9\u6cd5\u5c31\u662fConditional\u6ce8\u89e3\u7684\u5b9e\u73b0\n\t\t\t\treturn isConditionMatch(metadataReader);\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\tprivate boolean isConditionMatch(MetadataReader metadataReader) {\n\t\tif (this.conditionEvaluator == null) {\n\t\t\tthis.conditionEvaluator =\n\t\t\t\t\tnew ConditionEvaluator(getRegistry(), this.environment, this.resourcePatternResolver);\n\t\t}\n\t\treturn !this.conditionEvaluator.shouldSkip(metadataReader.getAnnotationMetadata());\n\t}\n"})}),"\n",(0,a.jsxs)(t.p,{children:["\u901a\u8fc7\u4ee3\u7801\u5206\u6790\u53ef\u4ee5\u770b\u51fa\u6765\u6700\u540e\u662f\u901a\u8fc7\u8c03\u7528 ",(0,a.jsx)(t.em,{children:(0,a.jsx)(t.strong,{children:(0,a.jsx)(t.code,{children:"ConditionEvaluator#shouldSkip"})})})," \u7684\u65b9\u6cd5\u6765\u5b9e\u73b0\u7684\u3002"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-java",children:"\tpublic boolean shouldSkip(AnnotatedTypeMetadata metadata) {\n\t\treturn shouldSkip(metadata, null);\n\t}\n\tpublic boolean shouldSkip(@Nullable AnnotatedTypeMetadata metadata, @Nullable ConfigurationPhase phase) {\n\t\t\n\t\t//\u5224\u65ad\u662f\u5426\u6709\u6ce8\u89e3Conditional\n\t\tif (metadata == null || !metadata.isAnnotated(Conditional.class.getName())) {\n\t\t\treturn false;\n\t\t}\n\n\t\t//\u5224\u65ad\u914d\u7f6e\u89e3\u6790\u7684\u7c7b\u578b\n\t\tif (phase == null) {\n\t\t\t\n\t\t\t//\u914d\u7f6e\u7c7b\u7684\u7c7b\u578b\n\t\t\tif (metadata instanceof AnnotationMetadata &&\n\t\t\t\t\tConfigurationClassUtils.isConfigurationCandidate((AnnotationMetadata) metadata)) {\n\t\t\t\treturn shouldSkip(metadata, ConfigurationPhase.PARSE_CONFIGURATION);\n\t\t\t}\n\t\t\t//bean\u6ce8\u518c\u7c7b\u578b\n\t\t\treturn shouldSkip(metadata, ConfigurationPhase.REGISTER_BEAN);\n\t\t}\n\n\t\tList<Condition> conditions = new ArrayList<>();\n\t\tfor (String[] conditionClasses : getConditionClasses(metadata)) {\n\t\t\tfor (String conditionClass : conditionClasses) {\n\t\t\t\tCondition condition = getCondition(conditionClass, this.context.getClassLoader());\n\t\t\t\tconditions.add(condition);\n\t\t\t}\n\t\t}\n\n\t\tAnnotationAwareOrderComparator.sort(conditions);\n\n\t\tfor (Condition condition : conditions) {\n\t\t\tConfigurationPhase requiredPhase = null;\n\t\t\tif (condition instanceof ConfigurationCondition) {\n\t\t\t\trequiredPhase = ((ConfigurationCondition) condition).getConfigurationPhase();\n\t\t\t}\n\t\t\t//\u8c03\u7528Condition#matches\u63a5\u53e3\u6765\u5224\u65ad\u662f\u5426\u52a0\u8f7d\u8be5\u7c7b\n\t\t\tif ((requiredPhase == null || requiredPhase == phase) && !condition.matches(this.context, metadata)) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\n\t\treturn false;\n\t}\n"})}),"\n",(0,a.jsx)(t.p,{children:"\u901a\u8fc7\u6e90\u7801\u89e3\u6790\u5c31\u77e5\u9053\u4e86\u6ce8\u89e3@Conditional\u914d\u5408Condition\u63a5\u53e3\u5728Spring\u5bb9\u5668\u4e2d\u8fdb\u884c\u6761\u4ef6\u5316\u52a0\u8f7dBean\u3002\u8fd9\u4e2a\u5728SpringBoot\u4e2d\u88ab\u5e7f\u6cdb\u7684\u5e94\u7528\u3002"}),"\n",(0,a.jsxs)(t.blockquote,{children:["\n",(0,a.jsx)(t.p,{children:"\u8fd9\u4e2a\u6761\u4ef6\u52a0\u8f7dBean\u548c\u7b56\u7565\u6a21\u5f0f\u5dee\u4e0d\u591a\u3002\u901a\u8fc7\u4e0d\u540c\u7684\u7b56\u7565\u6765\u52a0\u8f7d\u4e0d\u540c\u7684Bean"}),"\n"]})]})}function h(n={}){const{wrapper:t}={...(0,i.R)(),...n.components};return t?(0,a.jsx)(t,{...n,children:(0,a.jsx)(c,{...n})}):c(n)}},8453:(n,t,e)=>{e.d(t,{R:()=>s,x:()=>d});var a=e(6540);const i={},o=a.createContext(i);function s(n){const t=a.useContext(o);return a.useMemo((function(){return"function"==typeof n?n(t):{...t,...n}}),[t,n])}function d(n){let t;return t=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:s(n.components),a.createElement(o.Provider,{value:t},n.children)}}}]);