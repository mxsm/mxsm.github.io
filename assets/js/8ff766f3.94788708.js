"use strict";(self.webpackChunkmxsm_website=self.webpackChunkmxsm_website||[]).push([[8429],{334:(t,e,n)=>{n.r(e),n.d(e,{assets:()=>o,contentTitle:()=>s,default:()=>p,frontMatter:()=>i,metadata:()=>l,toc:()=>c});var r=n(4848),a=n(8453);const i={title:"Spring\u61d2\u52a0\u8f7d\u6e90\u7801\u5206\u6790",date:new Date("2018-04-19T00:00:00.000Z")},s=void 0,l={id:"spring/spring-framework/core-source-analysis/spring-lazyload",title:"Spring\u61d2\u52a0\u8f7d\u6e90\u7801\u5206\u6790",description:"1 \u4ec0\u4e48\u662f\u61d2\u52a0\u8f7d",source:"@site/docs/spring/spring-framework/core-source-analysis/spring-lazyload.md",sourceDirName:"spring/spring-framework/core-source-analysis",slug:"/spring/spring-framework/core-source-analysis/spring-lazyload",permalink:"/docs/spring/spring-framework/core-source-analysis/spring-lazyload",draft:!1,unlisted:!1,editUrl:"https://github.com/mxsm/mxsm-website/edit/develop/docs/spring/spring-framework/core-source-analysis/spring-lazyload.md",tags:[],version:"current",lastUpdatedBy:"mxsm",lastUpdatedAt:1710773855,formattedLastUpdatedAt:"Mar 18, 2024",frontMatter:{title:"Spring\u61d2\u52a0\u8f7d\u6e90\u7801\u5206\u6790",date:"2018-04-19T00:00:00.000Z"},sidebar:"springframework",previous:{title:"Spring\u4e2d\u7684Aware\u63a5\u53e3",permalink:"/docs/spring/spring-framework/core-source-analysis/spring-aware-interface"},next:{title:"Spring \u751f\u547d\u5468\u671f",permalink:"/docs/spring/spring-framework/core-source-analysis/spring-lifecycle"}},o={},c=[{value:"1 \u4ec0\u4e48\u662f\u61d2\u52a0\u8f7d",id:"1-\u4ec0\u4e48\u662f\u61d2\u52a0\u8f7d",level:3},{value:"2 Spring\u662f\u5982\u4f55\u5904\u7406\u61d2\u52a0\u8f7d\u3002",id:"2-spring\u662f\u5982\u4f55\u5904\u7406\u61d2\u52a0\u8f7d",level:3},{value:"3 \u5206\u6790@Lazy\u7684\u5b9e\u73b0\u6e90\u7801",id:"3-\u5206\u6790lazy\u7684\u5b9e\u73b0\u6e90\u7801",level:3},{value:"3.1 \u5206\u6790@Lazy\u5728\u7c7b\u4e0a",id:"31-\u5206\u6790lazy\u5728\u7c7b\u4e0a",level:4},{value:"3.2 \u5206\u6790@Lazy\u5728\u7c7b\u7684\u79c1\u6709\u53d8\u91cf\u4e0a\u9762",id:"32-\u5206\u6790lazy\u5728\u7c7b\u7684\u79c1\u6709\u53d8\u91cf\u4e0a\u9762",level:4}];function d(t){const e={blockquote:"blockquote",code:"code",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...t.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.h3,{id:"1-\u4ec0\u4e48\u662f\u61d2\u52a0\u8f7d",children:"1 \u4ec0\u4e48\u662f\u61d2\u52a0\u8f7d"}),"\n",(0,r.jsxs)(e.p,{children:["Spring\u4e2d\u6709\u4e00\u4e2a\u6982\u5ff5\u53eb\u505a\u61d2\u52a0\u8f7d\uff0c\u90a3\u4e48\u4ec0\u4e48\u662f\u61d2\u52a0\u8f7d\uff1f",(0,r.jsx)(e.strong,{children:"\u5c31\u662f\u5728\u9700\u8981\u7528\u5230\u7684\u65f6\u5019\u52a0\u8f7d\u7c7b"}),"\u3002"]}),"\n",(0,r.jsx)(e.h3,{id:"2-spring\u662f\u5982\u4f55\u5904\u7406\u61d2\u52a0\u8f7d",children:"2 Spring\u662f\u5982\u4f55\u5904\u7406\u61d2\u52a0\u8f7d\u3002"}),"\n",(0,r.jsx)(e.p,{children:"\u5bf9\u4e8eSpring\u4e2d\u7684\u4e00\u4e2abean\u5982\u4f55\u5224\u65ad\u662f\u5426\u4e3a\u61d2\u52a0\u8f7dBean\u3002\u5206\u4e3a\u4e24\u79cd\u60c5\u51b5\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"Bean\u7684\u5b9a\u4e49\u7531XML\u5b8c\u6210"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-xml",children:'<bean id="addressBean" class="com.fh.spring.Address" lazy-init="true" />\n'})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"Bean\u7684\u5b9a\u4e49\u7531\u6ce8\u89e3\u5b8c\u6210"})}),"\n",(0,r.jsx)(e.p,{children:"@Lazy\u6ce8\u89e3\uff0c\u5bf9\u4e8e\u7c7b\u548c\u7c7b\u7684\u53d8\u91cf\u503c\u4f7f\u7528\u4e86@Lazy\u6ce8\u89e3\u8bf4\u660e\u8fd9\u4e2a\u662f\u61d2\u52a0\u8f7d"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.h3,{id:"3-\u5206\u6790lazy\u7684\u5b9e\u73b0\u6e90\u7801",children:"3 \u5206\u6790@Lazy\u7684\u5b9e\u73b0\u6e90\u7801"}),"\n",(0,r.jsx)(e.p,{children:"@Lazy\u6ce8\u89e3\u4e3b\u8981\u4f7f\u7528\u5728\u4e24\u4e2a\u5730\u65b9\uff1a"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsx)(e.li,{children:"\u7c7b\u4e0a\u9762--\u914d\u5408@Component\u6ce8\u89e3\u4f7f\u7528"}),"\n",(0,r.jsx)(e.li,{children:"\u7c7b\u7684\u79c1\u6709\u53d8\u91cf\u4e0a\u9762--\u914d\u5408@Autowired\u6ce8\u89e3\u4f7f\u7528"}),"\n"]}),"\n",(0,r.jsx)(e.h4,{id:"31-\u5206\u6790lazy\u5728\u7c7b\u4e0a",children:"3.1 \u5206\u6790@Lazy\u5728\u7c7b\u4e0a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"\n@Component\n@Lazy\npublic class ServiceTest {\n //.......\u7701\u7565\u5176\u4ed6\u7684\u4ee3\u7801   \n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u5982\u4e0a\u793a\u4f8b\u4ee3\u7801\uff0c@Lazy\u7684\u4f4d\u7f6e\u5728ServiceTest\u4e0a\u9762\u3002\u5728Spring\u626b\u63cf\u5bf9\u5e94\u7684\u5305\u4e0b\u9762\u7684\u7c7b\uff0c\u89e3\u6790\u672aBeanDefinition\u7684\u65f6\u5019\uff0c\u5bf9\u5e94\u7684BeanDefinition#isLazyInit\u65b9\u6cd5\u8fd4\u56de\u4e3atrue\uff0c\u8bf4\u660e\u8fd9\u4e2aBeanDefinition\u5b9e\u73b0\u7684\u662f\u61d2\u52a0\u8f7d\u3002\n\u90a3\u4e48\u6211\u770b\u4e00\u4e0b\u5728DefaultListableBeanFactory#preInstantiateSingletons\u65b9\u6cd5"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public void preInstantiateSingletons() throws BeansException {\n    \n    //\u7701\u7565\u4e86\u90e8\u5206\u4ee3\u7801\n    for (String beanName : beanNames) {\n\t\t\tRootBeanDefinition bd = getMergedLocalBeanDefinition(beanName);\n\t\t\t//bd.isLazyInit() \u5982\u679c\u662ftrue\u5c31\u6267\u884c\u4e0b\u9762\u7684\u4ee3\u7801\n\t\t\tif (!bd.isAbstract() && bd.isSingleton() && !bd.isLazyInit()) {\n\t\t\t    //  \u7701\u7565Spring\u6e90\u7801\u4e2d\u7684\u4ee3\u7801\n\t\t\t}\n\t\t}\n}\n"})}),"\n",(0,r.jsxs)(e.p,{children:["\u901a\u8fc7\u4e0a\u9762\u7684\u4ee3\u7801\u53ef\u4ee5\u77e5\u9053\uff0c\u5728\u5bb9\u5668\u542f\u52a8\u7684\u65f6\u5019\uff0c\u52a0\u4e86 ",(0,r.jsx)(e.strong,{children:(0,r.jsx)(e.code,{children:"@Lazy"})})," \u7684\u7c7b\u4e0d\u4f1a\u8fdb\u884c\u5b9e\u4f8b\u5316\u3002"]}),"\n",(0,r.jsx)(e.h4,{id:"32-\u5206\u6790lazy\u5728\u7c7b\u7684\u79c1\u6709\u53d8\u91cf\u4e0a\u9762",children:"3.2 \u5206\u6790@Lazy\u5728\u7c7b\u7684\u79c1\u6709\u53d8\u91cf\u4e0a\u9762"}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"@Lazy"})," \u642d\u914d ",(0,r.jsx)(e.strong,{children:"@Autowired"})," \u4f7f\u7528\uff0c ",(0,r.jsx)(e.strong,{children:"@Autowired"})," \u7684\u5904\u7406\u7c7b\u662f ",(0,r.jsx)(e.strong,{children:(0,r.jsx)(e.code,{children:"AutowiredAnnotationBeanPostProcessor"})})]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'private class AutowiredFieldElement extends InjectionMetadata.InjectedElement {\n\n\t\tprivate final boolean required;\n\n\t\tprivate volatile boolean cached = false;\n\n\t\t@Nullable\n\t\tprivate volatile Object cachedFieldValue;\n\n\t\tpublic AutowiredFieldElement(Field field, boolean required) {\n\t\t\tsuper(field, null);\n\t\t\tthis.required = required;\n\t\t}\n\n\t\t@Override\n\t\tprotected void inject(Object bean, @Nullable String beanName, @Nullable PropertyValues pvs) throws Throwable {\n\t\t\tField field = (Field) this.member;\n\t\t\tObject value;\n\t\t\tif (this.cached) {\n\t\t\t\tvalue = resolvedCachedArgument(beanName, this.cachedFieldValue);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tDependencyDescriptor desc = new DependencyDescriptor(field, this.required);\n\t\t\t\tdesc.setContainingClass(bean.getClass());\n\t\t\t\tSet<String> autowiredBeanNames = new LinkedHashSet<>(1);\n\t\t\t\tAssert.state(beanFactory != null, "No BeanFactory available");\n\t\t\t\tTypeConverter typeConverter = beanFactory.getTypeConverter();\n\t\t\t\ttry {\n                    //\u8fd9\u4e2a\u65b9\u6cd5\u4e3b\u8981\u7528\u6765\u5904\u7406\u65b9\u6cd5\n\t\t\t\t\tvalue = beanFactory.resolveDependency(desc, beanName, autowiredBeanNames, typeConverter);\n\t\t\t\t}\n\t\t\t\tcatch (BeansException ex) {\n\t\t\t\t\tthrow new UnsatisfiedDependencyException(null, beanName, new InjectionPoint(field), ex);\n\t\t\t\t}\n\t\t\t\tsynchronized (this) {\n\t\t\t\t\tif (!this.cached) {\n\t\t\t\t\t\tif (value != null || this.required) {\n\t\t\t\t\t\t\tthis.cachedFieldValue = desc;\n\t\t\t\t\t\t\tregisterDependentBeans(beanName, autowiredBeanNames);\n\t\t\t\t\t\t\tif (autowiredBeanNames.size() == 1) {\n\t\t\t\t\t\t\t\tString autowiredBeanName = autowiredBeanNames.iterator().next();\n\t\t\t\t\t\t\t\tif (beanFactory.containsBean(autowiredBeanName) &&\n\t\t\t\t\t\t\t\t\t\tbeanFactory.isTypeMatch(autowiredBeanName, field.getType())) {\n\t\t\t\t\t\t\t\t\tthis.cachedFieldValue = new ShortcutDependencyDescriptor(\n\t\t\t\t\t\t\t\t\t\t\tdesc, autowiredBeanName, field.getType());\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tthis.cachedFieldValue = null;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tthis.cached = true;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (value != null) {\n\t\t\t\tReflectionUtils.makeAccessible(field);\n\t\t\t\tfield.set(bean, value);\n\t\t\t}\n\t\t}\n\t}\n'})}),"\n",(0,r.jsx)(e.p,{children:"\u770b\u4e00\u4e0bvalue = beanFactory.resolveDependency(desc, beanName, autowiredBeanNames, typeConverter)\u8fd9\u6bb5\u4ee3\u7801\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"\tpublic Object resolveDependency(DependencyDescriptor descriptor, @Nullable String requestingBeanName,\n\t\t\t@Nullable Set<String> autowiredBeanNames, @Nullable TypeConverter typeConverter) throws BeansException {\n\n\t\tdescriptor.initParameterNameDiscovery(getParameterNameDiscoverer());\n\t\tif (Optional.class == descriptor.getDependencyType()) {\n\t\t\treturn createOptionalDependency(descriptor, requestingBeanName);\n\t\t}\n\t\telse if (ObjectFactory.class == descriptor.getDependencyType() ||\n\t\t\t\tObjectProvider.class == descriptor.getDependencyType()) {\n\t\t\treturn new DependencyObjectProvider(descriptor, requestingBeanName);\n\t\t}\n\t\telse if (javaxInjectProviderClass == descriptor.getDependencyType()) {\n\t\t\treturn new Jsr330Factory().createDependencyProvider(descriptor, requestingBeanName);\n\t\t}\n\t\telse {\n            //\u5904\u7406\u5305\u542b\u6709@Lazy\u6ce8\u89e3\u7684\n\t\t\tObject result = getAutowireCandidateResolver().getLazyResolutionProxyIfNecessary(\n\t\t\t\t\tdescriptor, requestingBeanName);\n\t\t\tif (result == null) {\n\t\t\t\tresult = doResolveDependency(descriptor, requestingBeanName, autowiredBeanNames, typeConverter);\n\t\t\t}\n\t\t\treturn result;\n\t\t}\n\t}\n"})}),"\n",(0,r.jsxs)(e.blockquote,{children:["\n",(0,r.jsx)(e.p,{children:"DefaultListableBeanFactory \u9ed8\u8ba4\u4e3a private AutowireCandidateResolver autowireCandidateResolver = new SimpleAutowireCandidateResolver();\u5bf9\u4e8e\u6ce8\u89e3\u7c7b\u7684\u5728AnnotationConfigUtils\u8fdb\u884c\u4e86\u8bbe\u7f6e\uff0cAnnotationConfigUtils#registerAnnotationConfigProcessors\u65b9\u6cd5\u4e2d\u3002if (!(beanFactory.getAutowireCandidateResolver() instanceof ContextAnnotationAutowireCandidateResolver)) {   beanFactory.setAutowireCandidateResolver(new ContextAnnotationAutowireCandidateResolver());}\u8fdb\u884c\u4e86\u8bbe\u7f6e"}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:["\u5206\u6790\u4e00\u4e0b ",(0,r.jsx)(e.strong,{children:(0,r.jsx)(e.code,{children:"ContextAnnotationAutowireCandidateResolver#getLazyResolutionProxyIfNecessary"})})," \u7684\u65b9\u6cd5\uff1a"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public Object getLazyResolutionProxyIfNecessary(DependencyDescriptor descriptor, @Nullable String beanName) {\n    \t//\u5224\u65ad\u662f\u5426\u4e3a\u61d2\u52a0\u8f7d\n\t\treturn (isLazy(descriptor) ? buildLazyResolutionProxy(descriptor, beanName) : null);\n\t}\n"})}),"\n",(0,r.jsxs)(e.p,{children:["\u4e0b\u9762\u6765 ",(0,r.jsx)(e.strong,{children:(0,r.jsx)(e.code,{children:"buildLazyResolutionProxy"})})," \u65b9\u6cd5\uff0c\u521b\u5efa\u4ee3\u7406\u7c7b\uff1a"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'protected Object buildLazyResolutionProxy(final DependencyDescriptor descriptor, final @Nullable String beanName) {\n\t\tAssert.state(getBeanFactory() instanceof DefaultListableBeanFactory,\n\t\t\t\t"BeanFactory needs to be a DefaultListableBeanFactory");\n\t\tfinal DefaultListableBeanFactory beanFactory = (DefaultListableBeanFactory) getBeanFactory();\n\t\tTargetSource ts = new TargetSource() {\n\t\t\t@Override\n\t\t\tpublic Class<?> getTargetClass() {\n\t\t\t\treturn descriptor.getDependencyType();\n\t\t\t}\n\t\t\t@Override\n\t\t\tpublic boolean isStatic() {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\t@Override\n\t\t\tpublic Object getTarget() {\n\t\t\t\tObject target = beanFactory.doResolveDependency(descriptor, beanName, null, null);\n\t\t\t\tif (target == null) {\n\t\t\t\t\tClass<?> type = getTargetClass();\n\t\t\t\t\tif (Map.class == type) {\n\t\t\t\t\t\treturn Collections.emptyMap();\n\t\t\t\t\t}\n\t\t\t\t\telse if (List.class == type) {\n\t\t\t\t\t\treturn Collections.emptyList();\n\t\t\t\t\t}\n\t\t\t\t\telse if (Set.class == type || Collection.class == type) {\n\t\t\t\t\t\treturn Collections.emptySet();\n\t\t\t\t\t}\n\t\t\t\t\tthrow new NoSuchBeanDefinitionException(descriptor.getResolvableType(),\n\t\t\t\t\t\t\t"Optional dependency not present for lazy injection point");\n\t\t\t\t}\n\t\t\t\treturn target;\n\t\t\t}\n\t\t\t@Override\n\t\t\tpublic void releaseTarget(Object target) {\n\t\t\t}\n\t\t};\n\t\tProxyFactory pf = new ProxyFactory();\n\t\tpf.setTargetSource(ts);\n\t\tClass<?> dependencyType = descriptor.getDependencyType();\n\t\tif (dependencyType.isInterface()) {\n\t\t\tpf.addInterface(dependencyType);\n\t\t}\n\t\treturn pf.getProxy(beanFactory.getBeanClassLoader());\n\t}\n'})})]})}function p(t={}){const{wrapper:e}={...(0,a.R)(),...t.components};return e?(0,r.jsx)(e,{...t,children:(0,r.jsx)(d,{...t})}):d(t)}},8453:(t,e,n)=>{n.d(e,{R:()=>s,x:()=>l});var r=n(6540);const a={},i=r.createContext(a);function s(t){const e=r.useContext(i);return r.useMemo((function(){return"function"==typeof t?t(e):{...e,...t}}),[e,t])}function l(t){let e;return e=t.disableParentContext?"function"==typeof t.components?t.components(a):t.components||a:s(t.components),r.createElement(i.Provider,{value:e},t.children)}}}]);