"use strict";(self.webpackChunkmxsm_website=self.webpackChunkmxsm_website||[]).push([[7465],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>k});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var o=r.createContext({}),s=function(e){var t=r.useContext(o),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},p=function(e){var t=s(e.components);return r.createElement(o.Provider,{value:t},e.children)},u="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,o=e.parentName,p=c(e,["components","mdxType","originalType","parentName"]),u=s(n),d=a,k=u["".concat(o,".").concat(d)]||u[d]||m[d]||i;return n?r.createElement(k,l(l({ref:t},p),{},{components:n})):r.createElement(k,l({ref:t},p))}));function k(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,l=new Array(i);l[0]=d;var c={};for(var o in t)hasOwnProperty.call(t,o)&&(c[o]=t[o]);c.originalType=e,c[u]="string"==typeof e?e:a,l[1]=c;for(var s=2;s<i;s++)l[s]=n[s];return r.createElement.apply(null,l)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},3835:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>o,contentTitle:()=>l,default:()=>m,frontMatter:()=>i,metadata:()=>c,toc:()=>s});var r=n(7462),a=(n(7294),n(3905));const i={title:"Rocketmq\u751f\u4ea7\u8005\u542f\u52a8\u6d41\u7a0b\u5206\u6790",sidebar_position:202301251540,description:"\u5206\u6790Rocketmq\u751f\u4ea7\u8005\u542f\u52a8\u6d41\u7a0b\u4ee5\u53ca\u542f\u52a8\u8fc7\u7a0b\u7684\u7ec6\u8282"},l=void 0,c={unversionedId:"rocketmq/rocketmq5/client/producer/producer-start",id:"rocketmq/rocketmq5/client/producer/producer-start",title:"Rocketmq\u751f\u4ea7\u8005\u542f\u52a8\u6d41\u7a0b\u5206\u6790",description:"\u5206\u6790Rocketmq\u751f\u4ea7\u8005\u542f\u52a8\u6d41\u7a0b\u4ee5\u53ca\u542f\u52a8\u8fc7\u7a0b\u7684\u7ec6\u8282",source:"@site/docs/rocketmq/rocketmq5/03-client/producer/03-producer-start.md",sourceDirName:"rocketmq/rocketmq5/03-client/producer",slug:"/rocketmq/rocketmq5/client/producer/producer-start",permalink:"/docs/rocketmq/rocketmq5/client/producer/producer-start",draft:!1,editUrl:"https://github.com/mxsm/mxsm-website/edit/develop/docs/rocketmq/rocketmq5/03-client/producer/03-producer-start.md",tags:[],version:"current",lastUpdatedBy:"mxsm",lastUpdatedAt:1693139387,formattedLastUpdatedAt:"Aug 27, 2023",sidebarPosition:202301251540,frontMatter:{title:"Rocketmq\u751f\u4ea7\u8005\u542f\u52a8\u6d41\u7a0b\u5206\u6790",sidebar_position:202301251540,description:"\u5206\u6790Rocketmq\u751f\u4ea7\u8005\u542f\u52a8\u6d41\u7a0b\u4ee5\u53ca\u542f\u52a8\u8fc7\u7a0b\u7684\u7ec6\u8282"},sidebar:"rocketmq5",previous:{title:"Rocketmq\u6d88\u606f\u7ed3\u6784",permalink:"/docs/rocketmq/rocketmq5/client/producer/rocketmq-message"},next:{title:"\u751f\u4ea7\u8005Topic",permalink:"/docs/rocketmq/rocketmq5/client/producer/topic/"}},o={},s=[{value:"1. \u6d88\u606f\u53d1\u9001",id:"1-\u6d88\u606f\u53d1\u9001",level:2},{value:"2. \u751f\u4ea7\u8005\u7c7b\u7ee7\u627f\u5173\u7cfb",id:"2-\u751f\u4ea7\u8005\u7c7b\u7ee7\u627f\u5173\u7cfb",level:2},{value:"3. DefaultMQProducer#start",id:"3-defaultmqproducerstart",level:2},{value:"4. \u751f\u4ea7\u8005\u542f\u52a8\u6d41\u7a0b\u8be6\u89e3",id:"4-\u751f\u4ea7\u8005\u542f\u52a8\u6d41\u7a0b\u8be6\u89e3",level:2},{value:"4.1 \u5fc5\u8981\u53c2\u6570\u6821\u9a8c",id:"41-\u5fc5\u8981\u53c2\u6570\u6821\u9a8c",level:3},{value:"4.2 \u521b\u5efa\u6216\u8005\u4ece\u7f13\u5b58\u4e2d\u6839\u636e\u751f\u4ea7\u8005ID\u83b7\u53d6MQClientInstance\u5b9e\u4f8b",id:"42-\u521b\u5efa\u6216\u8005\u4ece\u7f13\u5b58\u4e2d\u6839\u636e\u751f\u4ea7\u8005id\u83b7\u53d6mqclientinstance\u5b9e\u4f8b",level:3},{value:"4.3 MQClientInstance\u5b9e\u4f8b\u4e2d\u6ce8\u518c\u5f53\u524d\u751f\u4ea7\u8005",id:"43-mqclientinstance\u5b9e\u4f8b\u4e2d\u6ce8\u518c\u5f53\u524d\u751f\u4ea7\u8005",level:3},{value:"4.4 \u521d\u59cb\u5316\u5f53\u524d\u751f\u4ea7\u8005\u4e3b\u9898\u548c\u4e3b\u9898\u53d1\u5e03\u4fe1\u606f\u6620\u5c04\u5173\u7cfb",id:"44-\u521d\u59cb\u5316\u5f53\u524d\u751f\u4ea7\u8005\u4e3b\u9898\u548c\u4e3b\u9898\u53d1\u5e03\u4fe1\u606f\u6620\u5c04\u5173\u7cfb",level:3},{value:"4.5 \u542f\u52a8MQClientInstance",id:"45-\u542f\u52a8mqclientinstance",level:3},{value:"4.5.1 \u5efa\u7acb\u751f\u4ea7\u8005\u548c\u914d\u7f6e\u7684NameServer\u7684Channel\u901a\u9053",id:"451-\u5efa\u7acb\u751f\u4ea7\u8005\u548c\u914d\u7f6e\u7684nameserver\u7684channel\u901a\u9053",level:4},{value:"4.5.2 \u542f\u52a8MQClientInstance\u5b9a\u65f6\u4efb\u52a1",id:"452-\u542f\u52a8mqclientinstance\u5b9a\u65f6\u4efb\u52a1",level:4},{value:"4.5.3 \u542f\u52a8PullMessageService",id:"453-\u542f\u52a8pullmessageservice",level:4},{value:"4.5.4 \u542f\u52a8RebalanceService\u670d\u52a1",id:"454-\u542f\u52a8rebalanceservice\u670d\u52a1",level:4},{value:"4.5.6 \u542f\u52a8MQClientInstance\u5185\u90e8\u7684DefaultMQProducer",id:"456-\u542f\u52a8mqclientinstance\u5185\u90e8\u7684defaultmqproducer",level:4},{value:"4.6 \u53d1\u9001\u5fc3\u8df3\u7ed9\u6240\u6709\u7684Broker",id:"46-\u53d1\u9001\u5fc3\u8df3\u7ed9\u6240\u6709\u7684broker",level:3},{value:"4.7 \u542f\u52a8\u5b9a\u65f6\u4efb\u52a1",id:"47-\u542f\u52a8\u5b9a\u65f6\u4efb\u52a1",level:3},{value:"5. \u603b\u7ed3",id:"5-\u603b\u7ed3",level:2}],p={toc:s},u="wrapper";function m(e){let{components:t,...n}=e;return(0,a.kt)(u,(0,r.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h2",{id:"1-\u6d88\u606f\u53d1\u9001"},"1. \u6d88\u606f\u53d1\u9001"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java"},'package org.apache.rocketmq.example.quickstart;\n\nimport org.apache.rocketmq.client.exception.MQClientException;\nimport org.apache.rocketmq.client.producer.DefaultMQProducer;\nimport org.apache.rocketmq.client.producer.SendResult;\nimport org.apache.rocketmq.common.message.Message;\nimport org.apache.rocketmq.remoting.common.RemotingHelper;\npublic class Producer {\n    public static final int MESSAGE_COUNT = 1000;\n    public static final String PRODUCER_GROUP = "please_rename_unique_group_name";\n    public static final String DEFAULT_NAMESRVADDR = "127.0.0.1:9876";\n    public static final String TOPIC = "TopicTest";\n    public static final String TAG = "TagA";\n\n    public static void main(String[] args) throws MQClientException, InterruptedException {\n        DefaultMQProducer producer = new DefaultMQProducer(PRODUCER_GROUP);\n        producer.setNamesrvAddr(DEFAULT_NAMESRVADDR);\n        producer.start();\n\n        for (int i = 0; i < MESSAGE_COUNT; i++) {\n            try {\n                Message msg = new Message(TOPIC /* Topic */,\n                    TAG /* Tag */,\n                    ("Hello RocketMQ " + i).getBytes(RemotingHelper.DEFAULT_CHARSET) /* Message body */\n                );\n                SendResult sendResult = producer.send(msg);\n                System.out.printf("%s%n", sendResult);\n            } catch (Exception e) {\n                e.printStackTrace();\n                Thread.sleep(1000);\n            }\n        }\n        producer.shutdown();\n    }\n}\n\n')),(0,a.kt)("admonition",{title:"\u4fe1\u606f",type:"info"},(0,a.kt)("p",{parentName:"admonition"},"\u4f8b\u5b50\u4ee3\u7801\u6765\u81ea",(0,a.kt)("a",{parentName:"p",href:"https://github.com/apache/rocketmq/blob/develop/example/src/main/java/org/apache/rocketmq/example/quickstart/Producer.java"},"RocketMQ\u5b98\u65b9"))),(0,a.kt)("p",null,"\u4ece\u4e0a\u9762\u7684\u4f8b\u5b50\u53ef\u4ee5\u5206\u6790\u51fa\u6765\u53d1\u9001\u6d88\u606f\u7684\u51e0\u4e2a\u6b65\u9aa4\uff1a"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"\u6784\u5efaDefaultMQProducer\u5b9e\u4f8b"),(0,a.kt)("li",{parentName:"ol"},"\u8bbe\u7f6eNameServer\u5730\u5740"),(0,a.kt)("li",{parentName:"ol"},"\u542f\u52a8Producer"),(0,a.kt)("li",{parentName:"ol"},"\u6784\u5efa\u9700\u8981\u53d1\u9001\u6d88\u606f"),(0,a.kt)("li",{parentName:"ol"},"\u53d1\u9001\u6570\u636e\u5230Broker\uff0c\u7b49\u5f85\u8fd4\u56de\u7ed3\u679c(\u540c\u6b65\u53d1\u9001)"),(0,a.kt)("li",{parentName:"ol"},"\u751f\u4ea7\u8005shutdown")),(0,a.kt)("p",null,"1\u30012\u30013\u6b65\u9aa4\u662fRocketmq\u751f\u4ea7\u8005\u542f\u52a8\u6d41\u7a0b\u3002\u63a5\u4e0b\u6765\u5c31\u5206\u6790\u542f\u52a8\u6d41\u7a0b"),(0,a.kt)("h2",{id:"2-\u751f\u4ea7\u8005\u7c7b\u7ee7\u627f\u5173\u7cfb"},"2. \u751f\u4ea7\u8005\u7c7b\u7ee7\u627f\u5173\u7cfb"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://raw.githubusercontent.com/mxsm/picture/main/rocketmq5/client/producer/image-20230126131919957.png",alt:"image-20230126131919957"})),(0,a.kt)("p",null,"\u7c7b\u7684\u7ee7\u627f\u5173\u7cfb\u5982\u4e0a\u56fe\u3002\u63a5\u4e0b\u5206\u6790\u751f\u957f\u7740\u542f\u52a8\u7684\u8fc7\u7a0b\u3002"),(0,a.kt)("h2",{id:"3-defaultmqproducerstart"},"3. DefaultMQProducer#start"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java",metastring:'jxs title="DefaultMQProducer#start"',jxs:!0,title:'"DefaultMQProducer#start"'},'@Override\npublic void start() throws MQClientException {\n    //\u8bbe\u7f6e\u751f\u4ea7\u8005\u7ec4\n    this.setProducerGroup(withNamespace(this.producerGroup));\n    //\u542f\u52a8\u670d\u52a1\n    this.defaultMQProducerImpl.start();\n    if (null != traceDispatcher) {\n        try {\n            traceDispatcher.start(this.getNamesrvAddr(), this.getAccessChannel());\n        } catch (MQClientException e) {\n            logger.warn("trace dispatcher start failed ", e);\n        }\n    }\n}\n')),(0,a.kt)("p",null,"\u4e3b\u8981\u7684\u65b9\u6cd5 ",(0,a.kt)("strong",{parentName:"p"},(0,a.kt)("inlineCode",{parentName:"strong"},"DefaultMQProducerImpl#start"))," "),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java",metastring:'jxs title="DefaultMQProducerImpl#start"',jxs:!0,title:'"DefaultMQProducerImpl#start"'},'public void start(final boolean startFactory) throws MQClientException {\n    switch (this.serviceState) {\n        case CREATE_JUST: //\u521d\u6b21serviceState\u9ed8\u8ba4\u503cCREATE_JUST\n            this.serviceState = ServiceState.START_FAILED;\n\n            this.checkConfig();\n\n            if (!this.defaultMQProducer.getProducerGroup().equals(MixAll.CLIENT_INNER_PRODUCER_GROUP)) {\n                this.defaultMQProducer.changeInstanceNameToPID();\n            }\n            //\u521b\u5efa\u83b7\u53d6ClientFactory\n            this.mQClientFactory = MQClientManager.getInstance().getOrCreateMQClientInstance(this.defaultMQProducer, rpcHook);\n\n            //\u5f80ClientFactory\u6ce8\u518c\u5f53\u524d\u751f\u4ea7\u8005\n            boolean registerOK = mQClientFactory.registerProducer(this.defaultMQProducer.getProducerGroup(), this);\n            if (!registerOK) {\n                this.serviceState = ServiceState.CREATE_JUST;\n                throw new MQClientException("The producer group[" + this.defaultMQProducer.getProducerGroup()\n                    + "] has been created before, specify another name please." + FAQUrl.suggestTodo(FAQUrl.GROUP_NAME_DUPLICATE_URL),\n                    null);\n            }\n\n            //\u521d\u59cb\u5316\u5f53\u524d\u751f\u4ea7\u8005\u4e3b\u9898\u548c\u4e3b\u9898\u53d1\u5e03\u7684\u6620\u5c04\u5173\u7cfb\n            this.topicPublishInfoTable.put(this.defaultMQProducer.getCreateTopicKey(), new TopicPublishInfo());\n\n            //\u542f\u52a8\u5de5\u5382\u7c7b\n            if (startFactory) {\n                mQClientFactory.start();\n            }\n\n            log.info("the producer [{}] start OK. sendMessageWithVIPChannel={}", this.defaultMQProducer.getProducerGroup(),\n                this.defaultMQProducer.isSendMessageWithVIPChannel());\n            this.serviceState = ServiceState.RUNNING;\n            break;\n        case RUNNING:\n        case START_FAILED:\n        case SHUTDOWN_ALREADY:\n            throw new MQClientException("The producer service state not OK, maybe started once, "\n                + this.serviceState\n                + FAQUrl.suggestTodo(FAQUrl.CLIENT_SERVICE_NOT_OK),\n                null);\n        default:\n            break;\n    }\n    //\u53d1\u9001\u5fc3\u8df3\u7ed9\u6240\u6709\u7684Broker\n    this.mQClientFactory.sendHeartbeatToAllBrokerWithLock();\n\n    //\u542f\u52a8\u5b9a\u65f6\u4efb\u52a1\n    RequestFutureHolder.getInstance().startScheduledTask(this);\n}\n')),(0,a.kt)("p",null,"\u4e0a\u8ff0\u65b9\u6cd5\u4e3b\u8981\u53ef\u4ee5\u5206\u6210\u4e00\u4e0b\u51e0\u4e2a\u6b65\u9aa4\uff1a"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"\u751f\u4ea7\u8005\u542f\u52a8\u5fc5\u8981\u53c2\u6570\u7684\u6821\u9a8c"),(0,a.kt)("li",{parentName:"ol"},"\u521b\u5efa\u6216\u8005\u4ece\u7f13\u5b58\u4e2d\u6839\u636e\u751f\u4ea7\u8005ID\u83b7\u53d6MQClientInstance\u5b9e\u4f8b"),(0,a.kt)("li",{parentName:"ol"},"MQClientInstance\u5b9e\u4f8b\u4e2d\u6ce8\u518c\u5f53\u524d\u751f\u4ea7\u8005"),(0,a.kt)("li",{parentName:"ol"},"\u521d\u59cb\u5316\u5f53\u524d\u751f\u4ea7\u8005\u4e3b\u9898\u548c\u4e3b\u9898\u53d1\u5e03\u4fe1\u606f\u6620\u5c04\u5173\u7cfb"),(0,a.kt)("li",{parentName:"ol"},"\u542f\u52a8MQClientInstance"),(0,a.kt)("li",{parentName:"ol"},"\u53d1\u9001\u5fc3\u8df3\u7ed9\u6240\u6709\u7684Broker"),(0,a.kt)("li",{parentName:"ol"},"\u542f\u52a8\u5b9a\u65f6\u4efb\u52a1")),(0,a.kt)("p",null,"\u89e3\u6790\u6765\u5c31\u5206\u6790\u4e0a\u8ff0\u7684\u51e0\u4e2a\u6b65\u9aa4\u770b\u770b\u5177\u4f53\u505a\u4e86\u4ec0\u4e48\u3002"),(0,a.kt)("h2",{id:"4-\u751f\u4ea7\u8005\u542f\u52a8\u6d41\u7a0b\u8be6\u89e3"},"4. \u751f\u4ea7\u8005\u542f\u52a8\u6d41\u7a0b\u8be6\u89e3"),(0,a.kt)("h3",{id:"41-\u5fc5\u8981\u53c2\u6570\u6821\u9a8c"},"4.1 \u5fc5\u8981\u53c2\u6570\u6821\u9a8c"),(0,a.kt)("p",null,"\u4e3b\u8981\u6821\u9a8c\u4e86 ",(0,a.kt)("strong",{parentName:"p"},(0,a.kt)("inlineCode",{parentName:"strong"},"DefaultMQProducer.producerGroup"))," \u5b57\u6bb5\u662f\u5426\u7b26\u5408\u8981\u6c42\u3002"),(0,a.kt)("h3",{id:"42-\u521b\u5efa\u6216\u8005\u4ece\u7f13\u5b58\u4e2d\u6839\u636e\u751f\u4ea7\u8005id\u83b7\u53d6mqclientinstance\u5b9e\u4f8b"},"4.2 \u521b\u5efa\u6216\u8005\u4ece\u7f13\u5b58\u4e2d\u6839\u636e\u751f\u4ea7\u8005ID\u83b7\u53d6MQClientInstance\u5b9e\u4f8b"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java",metastring:'jxs title="MQClientManager"',jxs:!0,title:'"MQClientManager"'},"public class MQClientManager {\n    private final static Logger log = LoggerFactory.getLogger(MQClientManager.class);\n    private static MQClientManager instance = new MQClientManager();\n    private AtomicInteger factoryIndexGenerator = new AtomicInteger();\n    //\u4fdd\u5b58\u5ba2\u6237\u7aefID\u548cMQClientInstance\u5b9e\u4f8b\u7684\u6620\u5c04\u5173\u7cfb\n    private ConcurrentMap<String/* clientId */, MQClientInstance> factoryTable =\n        new ConcurrentHashMap<>();\n\n    private MQClientManager() {\n\n    }\n    //\u7701\u7565\u90e8\u5206\u4ee3\u7801\n}\n")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},(0,a.kt)("inlineCode",{parentName:"strong"},"MQClientManager"))," \u4e3b\u8981\u7ba1\u7406\u5ba2\u6237\u7aef\u548cMQClientInstance\u5b9e\u4f8b\u4e4b\u95f4\u7684\u6620\u5c04\u5173\u7cfb\u3002",(0,a.kt)("inlineCode",{parentName:"p"},"MQClientManager#getOrCreateMQClientInstance")," \u65b9\u6cd5\u83b7\u53d6MQClientInstance\u5b9e\u4f8b\u5982\u679c\u7f13\u5b58\u4e2d\u5b58\u5728\u76f4\u63a5\u83b7\u53d6\uff0c\u7f13\u5b58\u4e2d\u4e0d\u5b58\u5728\u76f4\u63a5\u521b\u5efa\u3002"),(0,a.kt)("admonition",{title:"\u4fe1\u606f",type:"info"},(0,a.kt)("p",{parentName:"admonition"},"MQClientInstance\u7684\u521b\u5efa\u5728\u542f\u52a8\u7684\u65f6\u5019\u8fdb\u884c\u5206\u6790")),(0,a.kt)("h3",{id:"43-mqclientinstance\u5b9e\u4f8b\u4e2d\u6ce8\u518c\u5f53\u524d\u751f\u4ea7\u8005"},"4.3 MQClientInstance\u5b9e\u4f8b\u4e2d\u6ce8\u518c\u5f53\u524d\u751f\u4ea7\u8005"),(0,a.kt)("p",null,"\u5c06\u751f\u4ea7\u8005\u7ec4\u548c\u751f\u4ea7\u8005\u7f13\u5b58\u5230MQClientInstance\u5b9e\u4f8b\u4e2d\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java",metastring:'jxs title="MQClientInstance#registerProducer"',jxs:!0,title:'"MQClientInstance#registerProducer"'},'public synchronized boolean registerProducer(final String group, final DefaultMQProducerImpl producer) {\n    if (null == group || null == producer) {\n        return false;\n    }\n\n    MQProducerInner prev = this.producerTable.putIfAbsent(group, producer);\n    if (prev != null) {\n        log.warn("the producer group[{}] exist already.", group);\n        return false;\n    }\n\n    return true;\n}\n')),(0,a.kt)("h3",{id:"44-\u521d\u59cb\u5316\u5f53\u524d\u751f\u4ea7\u8005\u4e3b\u9898\u548c\u4e3b\u9898\u53d1\u5e03\u4fe1\u606f\u6620\u5c04\u5173\u7cfb"},"4.4 \u521d\u59cb\u5316\u5f53\u524d\u751f\u4ea7\u8005\u4e3b\u9898\u548c\u4e3b\u9898\u53d1\u5e03\u4fe1\u606f\u6620\u5c04\u5173\u7cfb"),(0,a.kt)("p",null,"\u5c06\u5f53\u524d\u751f\u4ea7\u8005\u7684\u4e3b\u9898\u548c\u4e3b\u9898\u53d1\u5e03\u7684\u6620\u5c04\u5173\u7cfb\u5148\u521d\u59cb\u5316\uff0c\u5f53\u524d\u6ca1\u6709\u53bbNameServer\u62c9\u53d6\u5bf9\u5e94\u7684Topic\u7684\u76f8\u5173\u6570\u636e\u4fe1\u606f\u3002"),(0,a.kt)("h3",{id:"45-\u542f\u52a8mqclientinstance"},"4.5 \u542f\u52a8MQClientInstance"),(0,a.kt)("p",null,"\u542f\u52a8MQClientInstance\u662f\u91cd\u70b9\uff0c\u4ece\u4ee3\u7801\u4e00\u4e00\u6765\u5206\u6790\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java",metastring:'jxs title="MQClientInstance#start"',jxs:!0,title:'"MQClientInstance#start"'},'public void start() throws MQClientException {\n\n    synchronized (this) {\n        switch (this.serviceState) {\n            case CREATE_JUST:\n                this.serviceState = ServiceState.START_FAILED;\n                // If not specified,looking address from name server\n                if (null == this.clientConfig.getNamesrvAddr()) {\n                    this.mQClientAPIImpl.fetchNameServerAddr();\n                }\n                // Start request-response channel\n                this.mQClientAPIImpl.start();\n                // Start various schedule tasks\n                this.startScheduledTask();\n                // Start pull service\n                this.pullMessageService.start();\n                // Start rebalance service\n                this.rebalanceService.start();\n                // Start push service\n                this.defaultMQProducer.getDefaultMQProducerImpl().start(false);\n                log.info("the client factory [{}] start OK", this.clientId);\n                this.serviceState = ServiceState.RUNNING;\n                break;\n            case START_FAILED:\n                throw new MQClientException("The Factory object[" + this.getClientId() + "] has been created before, and failed.", null);\n            default:\n                break;\n        }\n    }\n}\n')),(0,a.kt)("h4",{id:"451-\u5efa\u7acb\u751f\u4ea7\u8005\u548c\u914d\u7f6e\u7684nameserver\u7684channel\u901a\u9053"},"4.5.1 \u5efa\u7acb\u751f\u4ea7\u8005\u548c\u914d\u7f6e\u7684NameServer\u7684Channel\u901a\u9053"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},(0,a.kt)("inlineCode",{parentName:"strong"},"MQClientAPIImpl"))," \u5b9e\u4f8b\u5316\u540e\u5728 ",(0,a.kt)("inlineCode",{parentName:"p"},"ClientConfig#getNamesrvAddr")," \u65b9\u6cd5\u83b7\u53d6\u7684NameServer\u5730\u5740\u4e0d\u4e3a\u7a7a\u7684\u60c5\u51b5\u4e0b\u4f1a\u66f4\u65b0MQClientAPIImpl\u5b9e\u4f8b\u4e2d\u7684NameServer\u5730\u5740\u3002\u968f\u540e\u5728\u542f\u52a8MQClientAPIImpl\u7684\u65f6\u5019\u4e0e\u5730\u5740\u5bf9\u5e94\u7684NameServer\u5efa\u7acbChannel\u901a\u9053\u3002"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://raw.githubusercontent.com/mxsm/picture/main/rocketmq5/client/producer/image-20230127205711836.png",alt:"image-20230127205711836"})),(0,a.kt)("h4",{id:"452-\u542f\u52a8mqclientinstance\u5b9a\u65f6\u4efb\u52a1"},"4.5.2 \u542f\u52a8MQClientInstance\u5b9a\u65f6\u4efb\u52a1"),(0,a.kt)("p",null,"\u4e00\u5171\u6709\u4e94\u4e2a\u5b9a\u65f6\u4efb\u52a1\u542f\u52a8\uff0c\u6709\u4e00\u4e2a\u4e0d\u662f\u5fc5\u987b\u542f\u52a8\u3002"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"\u5b9a\u65f6\u66f4\u65b0NameServer\u5730\u5740"),(0,a.kt)("p",{parentName:"li"},"\u6bcf120\u79d2\u66f4\u65b0\u4e00\u6b21(\u914d\u7f6e\u7684NameServer\u4e3a\u7a7a\u7684\u60c5\u51b5\u4e0b\u542f\u52a8)\uff0c\u53ef\u4ee5\u81ea\u5df1\u901a\u8fc7SPI\u5b9e\u73b0TopAddressing\u63a5\u53e3\u3002")),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"\u5b9a\u65f6\u66f4\u65b0Topic\u7684\u8def\u7531\u4fe1\u606f"),(0,a.kt)("p",{parentName:"li"},"\u6bcf30\u79d2\u66f4\u65b0\u4e00\u6b21\uff0c\u5c06\u5f53\u524d\u7684\u5e94\u7528\u4e2d\u7684\u751f\u4ea7\u8005\u548c\u6d88\u8d39\u8005\u5bf9\u5e94\u7684Topic\u5168\u90e8\u7f13\u5b58\u4e0b\u6765\uff0c\u7136\u540e\u53bbNameServer\u66f4\u65b0TopicRouteData\u7684\u6570\u636e\u3002")),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"\u5b9a\u65f6\u6e05\u7406\u79bb\u7ebfBroker\u548c\u7ed9Broker\u53d1\u9001\u5fc3\u8df3"),(0,a.kt)("p",{parentName:"li"},"\u6bcf30\u79d2\u6267\u884c\u4e00\u6b21")),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"\u5b9a\u65f6\u6301\u4e45\u5316\u6d88\u8d39\u8fdb\u5ea6"),(0,a.kt)("p",{parentName:"li"},"\u6bcf5\u79d2\u949f\u6301\u4e45\u4e00\u6b21\u6d88\u8d39\u8fdb\u7684\uff0c\u4f46\u662f\u8fd9\u6837\u6d88\u8d39\u8fdb\u5ea6\u7684\u6301\u4e45\u5316\u9700\u8981\u5206\u4e3a\u4e24\u79cd\u60c5\u51b5\uff1a"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"\u5e7f\u64ad\u6d88\u606f"),(0,a.kt)("p",{parentName:"li"},"\u5e7f\u64ad\u6d88\u606f\u6d88\u8d39\u8fdb\u5ea6\u76f4\u63a5\u6301\u4e45\u5316\u5728\u6d88\u8d39\u8005\u672c\u5730")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"\u96c6\u7fa4\u6d88\u606f"),(0,a.kt)("p",{parentName:"li"},"\u96c6\u7fa4\u6d88\u606f\u6d88\u8d39\u8fdb\u5ea6\u6301\u4e45\u5316Broker")))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"\u8c03\u6574\u7ebf\u7a0b\u6c60"),(0,a.kt)("p",{parentName:"li"},"\u6bcf\u4e00\u5206\u949f\u6267\u884c\u4e00\u6b21\uff0c\u4f46\u662f\u5177\u4f53\u662f\u6ca1\u6709\u5b9e\u73b0"))),(0,a.kt)("h4",{id:"453-\u542f\u52a8pullmessageservice"},"4.5.3 \u542f\u52a8PullMessageService"),(0,a.kt)("p",null,"PullMessageService\u7684\u672c\u8d28\u662f\u4e00\u4e2a\u7ebf\u7a0b\uff0c\u7ee7\u627f\u4e86",(0,a.kt)("inlineCode",{parentName:"p"},"ServiceThread")," \u3002 \u4ece\u6d88\u606f\u963b\u585e\u961f\u5217\u4e2d\u83b7\u53d6\u6d88\u606f\u8bf7\u6c42",(0,a.kt)("inlineCode",{parentName:"p"},"MessageRequest")," \u7136\u540e\u5224\u65ad\u8bf7\u6c42\u662f ",(0,a.kt)("inlineCode",{parentName:"p"},"PopReques")," \u8fd8\u662f ",(0,a.kt)("inlineCode",{parentName:"p"},"PullRequest"),"  \u6267\u884c\u4e0d\u540c\u7684\u6570\u636e\u62c9\u53d6\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java",metastring:'jxs title="PullMessageService#run"',jxs:!0,title:'"PullMessageService#run"'},"@Override\npublic void run() {\n    //\u7701\u7565\u65e5\u5fd7\u6253\u5370\u4ee3\u7801\n    while (!this.isStopped()) {\n        try {\n            MessageRequest messageRequest = this.messageRequestQueue.take();\n            if (messageRequest.getMessageRequestMode() == MessageRequestMode.POP) {\n                this.popMessage((PopRequest)messageRequest);\n            } else {\n                this.pullMessage((PullRequest)messageRequest);\n            }\n        } catch (InterruptedException ignored) {\n        } catch (Exception e) {\n      \n        }\n    }\n}\n")),(0,a.kt)("h4",{id:"454-\u542f\u52a8rebalanceservice\u670d\u52a1"},"4.5.4 \u542f\u52a8RebalanceService\u670d\u52a1"),(0,a.kt)("p",null,"RebalanceService\u7684\u672c\u8d28\u662f\u4e00\u4e2a\u7ebf\u7a0b\uff0c\u7ee7\u627f\u4e86",(0,a.kt)("inlineCode",{parentName:"p"},"ServiceThread")," \u3002 "),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java",metastring:'jxs title="RebalanceService#run"',jxs:!0,title:'"RebalanceService#run"'},"@Override\npublic void run() {\n    while (!this.isStopped()) {\n        this.waitForRunning(waitInterval);\n        this.mqClientFactory.doRebalance();\n    }\n}\n")),(0,a.kt)("p",null,"\u4f5c\u7528\u662f\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u6bcf20S\u8c03\u7528\u4e00\u6b21 ",(0,a.kt)("strong",{parentName:"p"},(0,a.kt)("inlineCode",{parentName:"strong"},"MQClientInstance#doRebalance"))," \u65b9\u6cd5\u6765\u5b8c\u6210Consumer ",(0,a.kt)("strong",{parentName:"p"},(0,a.kt)("inlineCode",{parentName:"strong"},"\u8d1f\u8f7d\u5747\u8861"))," \u5c06\u91cd\u65b0\u5206\u914d\u7684MessageQueue\u6784\u5efaPullRequest\u8bf7\u6c42\u5e76\u5c06\u5176\u653e\u5230PullMessageService\u670d\u52a1\u4e2d\u7684pullRequestQueue\u961f\u5217\u4e2d\u3002"),(0,a.kt)("admonition",{title:"\u8bf4\u660e",type:"tip"},(0,a.kt)("p",{parentName:"admonition"},"\u8d1f\u8f7d\u5747\u8861\u3001PopRequest\u3001PullRequest\u7684\u5206\u6790\u90fd\u4f1a\u5728\u540e\u7eed\u6587\u7ae0\u4e2d\u8fdb\u884c")),(0,a.kt)("h4",{id:"456-\u542f\u52a8mqclientinstance\u5185\u90e8\u7684defaultmqproducer"},"4.5.6 \u542f\u52a8MQClientInstance\u5185\u90e8\u7684DefaultMQProducer"),(0,a.kt)("p",null,"\u542f\u52a8MQClientInstance\u5185\u90e8\u7684DefaultMQProducer\u8fd9\u4e2a\uff0c\u8fd9\u4e2aDefaultMQProducer\u7684\u4f5c\u7528\u662f\u7528\u4e8e\u5c06\u56de\u8c03\u5931\u8d25\u7684\u4fe1\u606f\u91cd\u65b0\u53d1\u9001\u5230Broker\u3002"),(0,a.kt)("h3",{id:"46-\u53d1\u9001\u5fc3\u8df3\u7ed9\u6240\u6709\u7684broker"},"4.6 \u53d1\u9001\u5fc3\u8df3\u7ed9\u6240\u6709\u7684Broker"),(0,a.kt)("p",null,"\u751f\u4ea7\u8005\u53d1\u9001\u5fc3\u8df3\u7ed9Broker\uff0c\u4e0eBroker\u5efa\u7acb\u8fde\u63a5\u3002"),(0,a.kt)("h3",{id:"47-\u542f\u52a8\u5b9a\u65f6\u4efb\u52a1"},"4.7 \u542f\u52a8\u5b9a\u65f6\u4efb\u52a1"),(0,a.kt)("p",null,"\u8fd9\u91cc\u542f\u52a8\u7684\u5b9a\u65f6\u4efb\u52a1\u662f\u7528\u4e8e\u626b\u63cf\u5904\u7406\u8d85\u65f6\u7684\u8bf7\u6c42\u3002"),(0,a.kt)("h2",{id:"5-\u603b\u7ed3"},"5. \u603b\u7ed3"),(0,a.kt)("p",null,"\u5f85\u5b9a\u3002\u3002"))}m.isMDXComponent=!0}}]);