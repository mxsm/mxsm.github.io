"use strict";(self.webpackChunkmxsm_website=self.webpackChunkmxsm_website||[]).push([[2617],{5276:(t,e,n)=>{n.r(e),n.d(e,{assets:()=>o,contentTitle:()=>i,default:()=>d,frontMatter:()=>a,metadata:()=>l,toc:()=>c});var r=n(4848),s=n(8453);const a={title:"DispatcherServlet\u6e90\u7801\u89e3\u6790",date:new Date("2018-08-09T00:00:00.000Z")},i=void 0,l={id:"spring/spring-framework/web-source-analysis/DispatcherServlet",title:"DispatcherServlet\u6e90\u7801\u89e3\u6790",description:"1. DispatcherServlet\u662f\u4ec0\u4e48\uff1f",source:"@site/docs/spring/spring-framework/web-source-analysis/DispatcherServlet.md",sourceDirName:"spring/spring-framework/web-source-analysis",slug:"/spring/spring-framework/web-source-analysis/DispatcherServlet",permalink:"/docs/spring/spring-framework/web-source-analysis/DispatcherServlet",draft:!1,unlisted:!1,editUrl:"https://github.com/mxsm/mxsm-website/edit/develop/docs/spring/spring-framework/web-source-analysis/DispatcherServlet.md",tags:[],version:"current",lastUpdatedBy:"mxsm",lastUpdatedAt:1720344793e3,frontMatter:{title:"DispatcherServlet\u6e90\u7801\u89e3\u6790",date:"2018-08-09T00:00:00.000Z"},sidebar:"springframework",previous:{title:"ContextLoaderListener \u6e90\u7801\u5206\u6790",permalink:"/docs/spring/spring-framework/web-source-analysis/ContextLoaderListener"},next:{title:"RequestMappingHandlerAdapter\u6e90\u7801\u5206\u6790",permalink:"/docs/spring/spring-framework/web-source-analysis/RequestMappingHandlerAdapter"}},o={},c=[{value:"1. DispatcherServlet\u662f\u4ec0\u4e48\uff1f",id:"1-dispatcherservlet\u662f\u4ec0\u4e48",level:3},{value:"2. DispatcherServlet\u5728Spring\u4e2d\u7684\u7ee7\u627f\u5173\u7cfb",id:"2-dispatcherservlet\u5728spring\u4e2d\u7684\u7ee7\u627f\u5173\u7cfb",level:3},{value:"3. \u6e90\u7801\u5206\u6790",id:"3-\u6e90\u7801\u5206\u6790",level:3},{value:"4. service\u65b9\u6cd5\u7684\u5206\u6790",id:"4-service\u65b9\u6cd5\u7684\u5206\u6790",level:3}];function p(t){const e={blockquote:"blockquote",code:"code",em:"em",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...t.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.h3,{id:"1-dispatcherservlet\u662f\u4ec0\u4e48",children:"1. DispatcherServlet\u662f\u4ec0\u4e48\uff1f"}),"\n",(0,r.jsx)(e.p,{children:"\u4ece\u672c\u8d28\u4e0a\u662f\u8bf4DispatcherServlet\u5c31\u662f\u4e00\u4e2aServlet\u89c4\u8303\u7684\u5b9e\u73b0\u3002\u4e5f\u5c31\u662f\u4e00\u4e2aServlet\uff01"}),"\n",(0,r.jsx)(e.h3,{id:"2-dispatcherservlet\u5728spring\u4e2d\u7684\u7ee7\u627f\u5173\u7cfb",children:"2. DispatcherServlet\u5728Spring\u4e2d\u7684\u7ee7\u627f\u5173\u7cfb"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public class DispatcherServlet extends FrameworkServlet {\n    //\u7701\u7565\u4ee3\u7801\n}\n\npublic abstract class FrameworkServlet extends HttpServletBean implements ApplicationContextAware {\n    //\u7701\u7565\u4ee3\u7801\n}\n\npublic abstract class HttpServletBean extends HttpServlet implements EnvironmentCapable, EnvironmentAware {\n    //\u7701\u7565\u4ee3\u7801    \n}\n\n"})}),"\n",(0,r.jsxs)(e.p,{children:["\u4ece\u4e0a\u9762\u7684\u5173\u7cfb\u53ef\u4ee5\u770b\u51fa\u6765 ",(0,r.jsx)(e.em,{children:"HttpServletBean"})," \u7ee7\u627f\u4e86Servlet API\u7684 ",(0,r.jsx)(e.em,{children:"HttpServlet"})," \uff0c\u7136\u540e ",(0,r.jsx)(e.em,{children:"FrameworkServlet"})," \u7ee7\u627f\u4e86\n",(0,r.jsx)(e.em,{children:"HttpServletBean"}),"\uff0c \u6700\u540e ",(0,r.jsx)(e.em,{children:"DispatcherServlet"})," \u7ee7\u627f\u4e86 ",(0,r.jsx)(e.em,{children:"FrameworkServlet"})," \u3002"]}),"\n",(0,r.jsx)(e.h3,{id:"3-\u6e90\u7801\u5206\u6790",children:"3. \u6e90\u7801\u5206\u6790"}),"\n",(0,r.jsx)(e.p,{children:"\u7531\u4e8eDispatcherServlet\u662f\u4e00\u4e2aServlet\u90a3\u4e48\u5c31\u4eceServlet\u7684\u65b9\u6cd5\u5165\u624b\u3002Servlet\u5b8c\u6210\u5b9e\u4f8b\u5316\u4ee5\u540e\u9996\u5148\u8c03\u7528\u7684\u5c31\u662finit\u65b9\u6cd5\u3002\u5728GenericServlet\u7c7b\u4e2dinit()\u65b9\u6cd5\u5b9e\u73b0\u4e3a\u7a7a\uff0c\u5728HttpServletBean\u91cd\u5199"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'@Override\n\tpublic final void init() throws ServletException {\n\n\t\t// Set bean properties from init parameters.\n\t\tPropertyValues pvs = new ServletConfigPropertyValues(getServletConfig(), this.requiredProperties);\n\t\tif (!pvs.isEmpty()) {\n\t\t\ttry {\n\t\t\t\tBeanWrapper bw = PropertyAccessorFactory.forBeanPropertyAccess(this);\n\t\t\t\tResourceLoader resourceLoader = new ServletContextResourceLoader(getServletContext());\n\t\t\t\tbw.registerCustomEditor(Resource.class, new ResourceEditor(resourceLoader, getEnvironment()));\n\t\t\t\tinitBeanWrapper(bw);\n\t\t\t\tbw.setPropertyValues(pvs, true);\n\t\t\t}\n\t\t\tcatch (BeansException ex) {\n\t\t\t\tif (logger.isErrorEnabled()) {\n\t\t\t\t\tlogger.error("Failed to set bean properties on servlet \'" + getServletName() + "\'", ex);\n\t\t\t\t}\n\t\t\t\tthrow ex;\n\t\t\t}\n\t\t}\n\n\t\t// \u8be5\u65b9\u6cd5\u5728HttpServletBean\u7c7b\u4e2d\u5b9e\u73b0\u4e3a\u7a7a--\u4e3b\u8981\u7531\u5b50\u7c7b\u8fdb\u884c\u5b9e\u73b0\n\t\tinitServletBean();\n\t}\n'})}),"\n",(0,r.jsx)(e.p,{children:"\u4e0b\u9762\u770b\u4e00\u4e0binitServletBean\u65b9\u6cd5\u5728FrameworkServlet\u4e2d\u7684\u5b9e\u73b0\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'@Override\n\tprotected final void initServletBean() throws ServletException {\n\t\t\n\t\t//\u7701\u7565\u65e5\u5fd7\u6253\u5370\n\n\t\ttry {\n\t\t    //\u521d\u59cb\u5316webApplicationContext\n\t\t\tthis.webApplicationContext = initWebApplicationContext();\n\t\t\t//\u521d\u59cb\u5316initFrameworkServlet-- \u9ed8\u8ba4\u5b9e\u73b0\u4e3a\u7a7a\n\t\t\tinitFrameworkServlet();\n\t\t}\n\t\tcatch (ServletException | RuntimeException ex) {\n\t\t\tlogger.error("Context initialization failed", ex);\n\t\t\tthrow ex;\n\t\t}\n\n\t\t//\u7701\u7565\u65e5\u5fd7\u6253\u5370\n\t}\n'})}),"\n",(0,r.jsx)(e.p,{children:"\u4ece\u4e0a\u9762\u53ef\u4ee5\u770b\u51fa\u6765\u4e3b\u8981\u662f\u521d\u59cb\u5316webApplicationContext\uff0c\u901a\u8fc7\u8c03\u7528initWebApplicationContext()\u65b9\u6cd5\u3002"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"protected WebApplicationContext initWebApplicationContext() {\n        //\u83b7\u53d6ServletContext\u4e2d\u7684\u5c5e\u6027\u503c\u4e3aWebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE\u5bf9\u8c61\u7684\u503c\n\t\t//\u5982\u679c\u6709ContextLoaderListner\u7684\u60c5\u51b5\u8bbe\u7f6e\u7684\n\t\tWebApplicationContext rootContext =\n\t\t\t\tWebApplicationContextUtils.getWebApplicationContext(getServletContext());\n\t\tWebApplicationContext wac = null;\n\t\tif (this.webApplicationContext != null) {\n\t\t\t// A context instance was injected at construction time -> use it\n\t\t\twac = this.webApplicationContext;\n\t\t\tif (wac instanceof ConfigurableWebApplicationContext) {\n\t\t\t\tConfigurableWebApplicationContext cwac = (ConfigurableWebApplicationContext) wac;\n\t\t\t\tif (!cwac.isActive()) {\n\t\t\t\t\n\t\t\t\t\tif (cwac.getParent() == null) {\n\t\t\t\t\t\tcwac.setParent(rootContext);\n\t\t\t\t\t}\n\t\t\t\t\t//\u5237\u65b0WebApplicationContext\n\t\t\t\t\tconfigureAndRefreshWebApplicationContext(cwac);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif (wac == null) {\n\t\t    //\u6839\u636econtextAttribute\u5c5e\u6027\u67e5\u627eWebApplicationContext\n\t\t\twac = findWebApplicationContext();\n\t\t}\n\t\tif (wac == null) {\n\t\t\t// \u5982\u679c\u4e0a\u9762\u90fd\u6ca1\u6709\u521b\u5efa\u4e00\u4e2a\n\t\t\twac = createWebApplicationContext(rootContext);\n\t\t}\n\n\t\tif (!this.refreshEventReceived) {\n\t\t\n\t\t\tsynchronized (this.onRefreshMonitor) {\n\t\t\t   //\u89e6\u53d1onRefresh\u65b9\u6cd5\u53bb\u505a\u4e00\u4e9b\u5176\u4ed6\u7684\u4e8b\u60c5\n\t\t\t\tonRefresh(wac);\n\t\t\t}\n\t\t}\n\n\t\tif (this.publishContext) {\n\t\t\t// Publish the context as a servlet context attribute.\n\t\t\tString attrName = getServletContextAttributeName();\n\t\t\tgetServletContext().setAttribute(attrName, wac);\n\t\t}\n\n\t\treturn wac;\n\t}\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u5206\u6790\u4e00\u4e0bcreateWebApplicationContext(rootContext)\u65b9\u6cd5\uff0cconfigureAndRefreshWebApplicationContext(cwac);\u5728\u5206\u6790\u4e00\u4e0bcreateWebApplicationContext\u4e2d\u4e5f\u6709\u8c03\u7528\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"protected WebApplicationContext createWebApplicationContext(@Nullable ApplicationContext parent) {\n\t\t//\u83b7\u53d6contextClass,\u5982\u679c\u6ca1\u6709\u8bbe\u7f6econtextClass\u9ed8\u8ba4\u662fXmlWebApplicationContext\n\t\tClass<?> contextClass = getContextClass();\n\t\tif (!ConfigurableWebApplicationContext.class.isAssignableFrom(contextClass)) {\n\t\t\t//\u4e0d\u662f\u7ee7\u627f\u5173\u7cfb\u629b\u9519\n\t\t}\n\t\t\n\t\t//\u5b9e\u4f8b\u5316\u6570\u636e\n\t\tConfigurableWebApplicationContext wac =\n\t\t\t\t(ConfigurableWebApplicationContext) BeanUtils.instantiateClass(contextClass);\n\n\t\twac.setEnvironment(getEnvironment());\n\t\twac.setParent(parent);\n\t\t//contextConfigLocation\u8bbe\u7f6e\u914d\u7f6e\u6587\u4ef6\u6216\u8005\u626b\u63cf\u5305\u7684\u8def\u5f84,\u6839\u636e\u4e0d\u540c\u7684Context\u6765\u5339\u914d\n\t\tString configLocation = getContextConfigLocation();\n\t\tif (configLocation != null) {\n\t\t\twac.setConfigLocation(configLocation);\n\t\t}\n\t\t\n\t\t//\u914d\u7f6e\u5237\u65b0--\u8c03\u7528\u4e86Spring core \u7684refresh\u65b9\u6cd5\n\t\tconfigureAndRefreshWebApplicationContext(wac);\n\n\t\treturn wac;\n\t}\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u521b\u5efa\u5b8c\u6210Spring application context\u540e\u5f00\u59cbFrameworkServlet#refresh\u65b9\u6cd5\u8fd9\u4e2a\u65b9\u6cd5\u662f\u4e00\u4e2a\u62bd\u8c61\u7684\u65b9\u6cd5\u5728\u5b50\u7c7b\u4e2d\u5b9e\u73b0\uff0c\u4e5f\u5c31\u662f\u5728DispatcherServlet\u4e2d\u5b9e\u73b0\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"\t@Override\n\tprotected void onRefresh(ApplicationContext context) {\n\t\tinitStrategies(context);\n\t}\n\t//\u521d\u59cb\u5316\u4e00\u4e9b\u8bf7\u6c42\u8fc7\u7a0b\u4e2d\u7684\u7b56\u7565\n\tprotected void initStrategies(ApplicationContext context) {\n\t\tinitMultipartResolver(context);\n\t\tinitLocaleResolver(context);\n\t\tinitThemeResolver(context);\n\t\tinitHandlerMappings(context);\n\t\tinitHandlerAdapters(context);\n\t\tinitHandlerExceptionResolvers(context);\n\t\tinitRequestToViewNameTranslator(context);\n\t\tinitViewResolvers(context);\n\t\tinitFlashMapManager(context);\n\t}\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u5bf9\u4e8e\u65b9\u6cd5initStrategies\u4e3b\u8981\u505a\u4e86\u8fd99\u4ef6\u4e8b\u60c5\u3002"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"initMultipartResolver"}),"\n",(0,r.jsx)(e.p,{children:"\u521d\u59cb\u5316MultipartResolver\uff0c\u7528\u4e8e\u5904\u7406\u6587\u4ef6\u4e0a\u4f20\u670d\u52a1\uff0c\u5982\u679c\u6709\u6587\u4ef6\u4e0a\u4f20\uff0c\u90a3\u4e48\u5c31\u4f1a\u5c06\u5f53\u524d\u7684HttpServletRequest\u5305\u88c5\u6210DefaultMultipartHttpServletRequest\uff0c\u5e76\u4e14\u5c06\u6bcf\u4e2a\u4e0a\u4f20\u7684\u5185\u5bb9\u5c01\u88c5\u6210CommonsMultipartFile\u5bf9\u8c61\u3002\u9700\u8981\u5728dispatcherServlet-servlet.xml\u4e2d\u914d\u7f6e\u6587\u4ef6\u4e0a\u4f20\u89e3\u6790\u5668\u3002"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"initLocaleResolver"}),"\n",(0,r.jsx)(e.p,{children:"\u7528\u4e8e\u5904\u7406\u5e94\u7528\u7684\u56fd\u9645\u5316\u95ee\u9898\uff0c\u672c\u5730\u5316\u89e3\u6790\u7b56\u7565\u3002"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"initThemeResolver"}),"\n",(0,r.jsx)(e.p,{children:"\u7528\u4e8e\u5b9a\u4e49\u4e00\u4e2a\u4e3b\u9898"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"initHandlerMapping"}),"\n",(0,r.jsx)(e.p,{children:"\u7528\u4e8e\u5b9a\u4e49\u8bf7\u6c42\u6620\u5c04\u5173\u7cfb"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"initHandlerAdapters"}),"\n",(0,r.jsx)(e.p,{children:"\u7528\u4e8e\u6839\u636eHandler\u7684\u7c7b\u578b\u5b9a\u4e49\u4e0d\u540c\u7684\u5904\u7406\u89c4\u5219"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"initHandlerExceptionResolvers"}),"\n",(0,r.jsx)(e.p,{children:"\u5f53Handler\u5904\u7406\u51fa\u9519\u540e\uff0c\u4f1a\u901a\u8fc7\u6b64\u5c06\u9519\u8bef\u65e5\u5fd7\u8bb0\u5f55\u5728log\u6587\u4ef6\u4e2d\uff0c\u9ed8\u8ba4\u5b9e\u73b0\u7c7b\u662fSimpleMappingExceptionResolver"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"initRequestToViewNameTranslators"}),"\n",(0,r.jsx)(e.p,{children:"\u5c06\u6307\u5b9a\u7684ViewName\u6309\u7167\u5b9a\u4e49\u7684RequestToViewNameTranslators\u66ff\u6362\u6210\u60f3\u8981\u7684\u683c\u5f0f"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"initViewResolvers"}),"\n",(0,r.jsx)(e.p,{children:"\u7528\u4e8e\u5c06View\u89e3\u6790\u6210\u9875\u9762"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"initFlashMapManager"}),"\n",(0,r.jsx)(e.p,{children:"\u7528\u4e8e\u751f\u6210FlashMap\u7ba1\u7406\u5668"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.h3,{id:"4-service\u65b9\u6cd5\u7684\u5206\u6790",children:"4. service\u65b9\u6cd5\u7684\u5206\u6790"}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.em,{children:"service"})," \u65b9\u6cd5\u4e3b\u8981\u662f\u5904\u7406\u5728HTTP\u8bf7\u6c42\uff0c\u5728 ",(0,r.jsx)(e.em,{children:"FrameworkServlet"})," \u4e2d\u91cd\u5199\u4e86 ",(0,r.jsx)(e.em,{children:"HttpServlet"})," \u65b9\u6cd5\u4e2d\u7684 ",(0,r.jsx)(e.em,{children:"service"})," \u65b9\u6cd5\u3002"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"    @Override\n\tprotected void service(HttpServletRequest request, HttpServletResponse response)\n\t\t\tthrows ServletException, IOException {\n\n\t\tHttpMethod httpMethod = HttpMethod.resolve(request.getMethod());\n\t\t//PATCH\u65b9\u6cd5\u6216\u8005\u4e3anull\u7684\u5904\u7406\n\t\tif (httpMethod == HttpMethod.PATCH || httpMethod == null) {\n\t\t\tprocessRequest(request, response);\n\t\t}\n\t\telse {\n\t\t    //\u8c03\u7528HttpServlet\u7684\u65b9\u6cd5--\u5904\u7406\u5176\u4ed6\u7684HTTP\u65b9\u6cd5\n\t\t\tsuper.service(request, response);\n\t\t}\n\t}\n"})}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.em,{children:"doGet\u3001doPost\u3001doPut\u3001doDelete\u3001doOptions\u3001doTrace"})," \u65b9\u6cd5\u4e2d\u5171\u540c\u8c03\u7528\u4e86 ",(0,r.jsx)(e.em,{children:"processRequest"})," \u65b9\u6cd5\u3002"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'\tprotected final void processRequest(HttpServletRequest request, HttpServletResponse response)\n\t\t\tthrows ServletException, IOException {\n\n\t\tlong startTime = System.currentTimeMillis();\n\t\tThrowable failureCause = null;\n\n\t\tLocaleContext previousLocaleContext = LocaleContextHolder.getLocaleContext();\n\t\t//\u83b7\u53d6Locale\n\t\tLocaleContext localeContext = buildLocaleContext(request);\n\n\t\tRequestAttributes previousAttributes = RequestContextHolder.getRequestAttributes();\n\t\t//\u83b7\u53d6Servlet\u8bf7\u6c42\u5c5e\u6027\n\t\tServletRequestAttributes requestAttributes = buildRequestAttributes(request, response, previousAttributes);\n        \n        //\u5f02\u6b65\u7ba1\u7406\n\t\tWebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);\n\t\tasyncManager.registerCallableInterceptor(FrameworkServlet.class.getName(), new RequestBindingInterceptor());\n\n\t\tinitContextHolders(request, localeContext, requestAttributes);\n\n\t\ttry {\n\t\t    //\u8c03\u7528\u5b50\u7c7b\u7684doService\n\t\t\tdoService(request, response);\n\t\t}\n\t\tcatch (ServletException | IOException ex) {\n\t\t\tfailureCause = ex;\n\t\t\tthrow ex;\n\t\t}\n\t\tcatch (Throwable ex) {\n\t\t\tfailureCause = ex;\n\t\t\tthrow new NestedServletException("Request processing failed", ex);\n\t\t}\n\n\t\tfinally {\n\t\t    //\u91ca\u653eContext\n\t\t\tresetContextHolders(request, previousLocaleContext, previousAttributes);\n\t\t\tif (requestAttributes != null) {\n\t\t\t\trequestAttributes.requestCompleted();\n\t\t\t}\n\t\t\tlogResult(request, response, failureCause, asyncManager);\n\t\t\tpublishRequestHandledEvent(request, response, startTime, failureCause);\n\t\t}\n\t}\n\n'})}),"\n",(0,r.jsx)(e.p,{children:"\u901a\u8fc7\u8c03\u7528DispatcherServlet#doService\u65b9\u6cd5\u6765\u5904\u7406\u5916\u90e8\u53d1\u6765\u670d\u52a1\u5668\u7684HTTP\u8bf7\u6c42\uff0c"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"@Override\n\tprotected void doService(HttpServletRequest request, HttpServletResponse response) throws Exception {\n\t\tlogRequest(request);\n\n\t\t// Keep a snapshot of the request attributes in case of an include,\n\t\t// to be able to restore the original attributes after the include.\n\t\tMap<String, Object> attributesSnapshot = null;\n\t\tif (WebUtils.isIncludeRequest(request)) {\n\t\t\tattributesSnapshot = new HashMap<>();\n\t\t\tEnumeration<?> attrNames = request.getAttributeNames();\n\t\t\twhile (attrNames.hasMoreElements()) {\n\t\t\t\tString attrName = (String) attrNames.nextElement();\n\t\t\t\tif (this.cleanupAfterInclude || attrName.startsWith(DEFAULT_STRATEGIES_PREFIX)) {\n\t\t\t\t\tattributesSnapshot.put(attrName, request.getAttribute(attrName));\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// \u8ba9\u6846\u67b6\u80fd\u591f\u5904\u7406\u548c\u67e5\u770bWebApplicationContext\u4e2d\u7684\u5bf9\u8c61\n\t\trequest.setAttribute(WEB_APPLICATION_CONTEXT_ATTRIBUTE, getWebApplicationContext());\n\t\trequest.setAttribute(LOCALE_RESOLVER_ATTRIBUTE, this.localeResolver);\n\t\trequest.setAttribute(THEME_RESOLVER_ATTRIBUTE, this.themeResolver);\n\t\trequest.setAttribute(THEME_SOURCE_ATTRIBUTE, getThemeSource());\n\n\t\tif (this.flashMapManager != null) {\n\t\t\tFlashMap inputFlashMap = this.flashMapManager.retrieveAndUpdate(request, response);\n\t\t\tif (inputFlashMap != null) {\n\t\t\t\trequest.setAttribute(INPUT_FLASH_MAP_ATTRIBUTE, Collections.unmodifiableMap(inputFlashMap));\n\t\t\t}\n\t\t\trequest.setAttribute(OUTPUT_FLASH_MAP_ATTRIBUTE, new FlashMap());\n\t\t\trequest.setAttribute(FLASH_MAP_MANAGER_ATTRIBUTE, this.flashMapManager);\n\t\t}\n\n\t\ttry {\n\t\t    //\u6700\u91cd\u8981\u7684\u65b9\u6cd5\uff1a\u5206\u53d1\u8bf7\u6c42\u5904\u7406\n\t\t\tdoDispatch(request, response);\n\t\t}\n\t\tfinally {\n\t\t\tif (!WebAsyncUtils.getAsyncManager(request).isConcurrentHandlingStarted()) {\n\t\t\t\t// Restore the original attribute snapshot, in case of an include.\n\t\t\t\tif (attributesSnapshot != null) {\n\t\t\t\t\trestoreAttributesAfterInclude(request, attributesSnapshot);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n"})}),"\n",(0,r.jsx)(e.p,{children:"doDispatch\u65b9\u6cd5\u7528\u6765\u5206\u53d1\u8bf7\u6c42\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'protected void doDispatch(HttpServletRequest request, HttpServletResponse response) throws Exception {\n\t\tHttpServletRequest processedRequest = request;\n\t\tHandlerExecutionChain mappedHandler = null;\n\t\tboolean multipartRequestParsed = false;\n\n\t\tWebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);\n\n\t\ttry {\n\t\t\tModelAndView mv = null;\n\t\t\tException dispatchException = null;\n\n\t\t\ttry {\n\t\t\t    //\u68c0\u67e5\u662f\u5426\u4e3a\u6587\u4ef6\u4e0a\u4f20\u8bf7\u6c42\n\t\t\t\tprocessedRequest = checkMultipart(request);\n\t\t\t\tmultipartRequestParsed = (processedRequest != request);\n\n\t\t\t\t// \u83b7\u53d6\u5f53\u524d\u8bf7\u6c42\u7684\u5904\u7406\u5668.\n\t\t\t\tmappedHandler = getHandler(processedRequest);\n\t\t\t\tif (mappedHandler == null) {\n\t\t\t\t\tnoHandlerFound(processedRequest, response);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// \u83b7\u53d6\u5f53\u524d\u8bf7\u6c42\u7684\u5904\u7406\u9002\u914d\u5668\n\t\t\t\tHandlerAdapter ha = getHandlerAdapter(mappedHandler.getHandler());\n\n\t\t\t\t// Process last-modified header, if supported by the handler.\n\t\t\t\tString method = request.getMethod();\n\t\t\t\tboolean isGet = "GET".equals(method);\n\t\t\t\tif (isGet || "HEAD".equals(method)) {\n\t\t\t\t\tlong lastModified = ha.getLastModified(request, mappedHandler.getHandler());\n\t\t\t\t\tif (new ServletWebRequest(request, response).checkNotModified(lastModified) && isGet) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (!mappedHandler.applyPreHandle(processedRequest, response)) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\t//\u5b9e\u9645\u6267\u884c\u7684\u5904\u7406\u5668\n\t\t\t\tmv = ha.handle(processedRequest, response, mappedHandler.getHandler());\n\n\t\t\t\tif (asyncManager.isConcurrentHandlingStarted()) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n                //\u5e94\u7528\u9ed8\u8ba4\u7684\u89c6\u56fe\u540d\u79f0\n\t\t\t\tapplyDefaultViewName(processedRequest, mv);\n\t\t\t\tmappedHandler.applyPostHandle(processedRequest, response, mv);\n\t\t\t}\n\t\t\tcatch (Exception ex) {\n\t\t\t\tdispatchException = ex;\n\t\t\t}\n\t\t\tcatch (Throwable err) {\n\t\t\t\t// As of 4.3, we\'re processing Errors thrown from handler methods as well,\n\t\t\t\t// making them available for @ExceptionHandler methods and other scenarios.\n\t\t\t\tdispatchException = new NestedServletException("Handler dispatch failed", err);\n\t\t\t}\n\t\t\tprocessDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);\n\t\t}\n\t\tcatch (Exception ex) {\n\t\t\ttriggerAfterCompletion(processedRequest, response, mappedHandler, ex);\n\t\t}\n\t\tcatch (Throwable err) {\n\t\t\ttriggerAfterCompletion(processedRequest, response, mappedHandler,\n\t\t\t\t\tnew NestedServletException("Handler processing failed", err));\n\t\t}\n\t\tfinally {\n\t\t\tif (asyncManager.isConcurrentHandlingStarted()) {\n\t\t\t\t// Instead of postHandle and afterCompletion\n\t\t\t\tif (mappedHandler != null) {\n\t\t\t\t\tmappedHandler.applyAfterConcurrentHandlingStarted(processedRequest, response);\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// Clean up any resources used by a multipart request.\n\t\t\t\tif (multipartRequestParsed) {\n\t\t\t\t\tcleanupMultipart(processedRequest);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n'})}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.em,{children:"getHandler"})," \u83b7\u53d6\u5904\u7406\u5668\u6267\u884c\u5668\u5904\u7406\u94fe\uff0c\u7136\u540e ",(0,r.jsx)(e.em,{children:"getHandlerAdapter"})," \u83b7\u53d6\u5904\u7406\u5668\u9002\u914d\u5668\u3002 ",(0,r.jsx)(e.em,{children:"applyPreHandle"})," \u6267\u884c\u3002\u4ece\u4e0a\u9762\u7684\u6709\u4e24\u4e2a\u51e0\u4e2a\u91cd\u8981\u7684\u65b9\u6cd5\uff1a"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"//\u83b7\u53d6\u6267\u884c\u94fe\nmappedHandler = getHandler(processedRequest);\n\n//\u83b7\u53d6\u6267\u884c\u9002\u914d\u5668\nHandlerAdapter ha = getHandlerAdapter(mappedHandler.getHandler());\n\n//\u8c03\u7528\u94fe\u6267\u884c--\u524d\u7f6eHandlerInterceptor\nmappedHandler.applyPreHandle(processedRequest, response)\n\n//\u5b9e\u9645\u5904\u7406\nmv = ha.handle(processedRequest, response, mappedHandler.getHandler());\n\n//\u8c03\u7528\u94fe\u6267\u884c--\u540e\u7f6eHandlerInterceptor\nmappedHandler.applyPostHandle(processedRequest, response, mv);\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u63a5\u4e0b\u6765\u4e00\u4e2a\u4e2a\u6765\u5206\u6790\u4e0a\u9762\u7684\u65b9\u6cd5\uff1a"}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.em,{children:(0,r.jsx)(e.strong,{children:(0,r.jsx)(e.code,{children:"mappedHandler = getHandler(processedRequest)"})})}),"  \u65b9\u6cd5\u7684\u5206\u6790\uff0c\u770b\u4e00\u4e0b\u6e90\u4ee3\u7801\uff1a"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"\tprotected HandlerExecutionChain getHandler(HttpServletRequest request) throws Exception {\n\t\tif (this.handlerMappings != null) {\n            //\u4ecehandlerMappings\u83b7\u53d6HandlerMapping\u7684\u5b9e\u73b0\n\t\t\tfor (HandlerMapping mapping : this.handlerMappings) {\n                //\u4eceHandlerMapping\u5b9e\u73b0\u4e2d\u83b7\u53d6\u5904\u7406\u6267\u884c\u8c03\u7528\u94fe\n\t\t\t\tHandlerExecutionChain handler = mapping.getHandler(request);\n\t\t\t\tif (handler != null) {\n\t\t\t\t\treturn handler;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn null;\n\t}\n"})}),"\n",(0,r.jsxs)(e.blockquote,{children:["\n",(0,r.jsx)(e.p,{children:"HandlerMapping\u9ed8\u8ba4\u5b9e\u73b0\u52a0\u8f7d\u6709\u4e09\u4e2a\uff1a"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsx)(e.li,{children:"RequestMappingHandlerMapping"}),"\n",(0,r.jsx)(e.li,{children:"BeanNameUrlHandlerMapping"}),"\n",(0,r.jsx)(e.li,{children:"SimpleUrlHandlerMapping"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:["\u9ed8\u8ba4\u52a0\u8f7d\u7684 ",(0,r.jsx)(e.em,{children:(0,r.jsx)(e.strong,{children:(0,r.jsx)(e.code,{children:"RequestMappingHandlerMapping"})})})," \uff0c\u770b\u4e00\u4e0b\u5982\u4f55\u83b7\u53d6 ",(0,r.jsx)(e.strong,{children:(0,r.jsx)(e.code,{children:"HandlerExecutionChain"})})," \u8c03\u7528\u94fe\u3002 \u8c03\u7528\u7684\u65b9\u6cd5 ",(0,r.jsx)(e.strong,{children:(0,r.jsx)(e.code,{children:"AbstractHandlerMapping#getHandler"})})]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"\tpublic final HandlerExecutionChain getHandler(HttpServletRequest request) throws Exception {\n        //\u83b7\u53d6\u5185\u90e8\u5904\u7406\u5668\n\t\tObject handler = getHandlerInternal(request);\n\t\tif (handler == null) {\n            //\u5982\u679c\u4e3a\u7a7a\u83b7\u53d6\u9ed8\u8ba4\u5904\u7406\u5668\n\t\t\thandler = getDefaultHandler();\n\t\t}\n\t\tif (handler == null) {\n\t\t\treturn null;\n\t\t}\n\t\t// Bean name or resolved handler?\n\t\tif (handler instanceof String) {\n\t\t\tString handlerName = (String) handler;\n\t\t\thandler = obtainApplicationContext().getBean(handlerName);\n\t\t}\n\n\t\tHandlerExecutionChain executionChain = getHandlerExecutionChain(handler, request);\n\n\t\t//\u7701\u4e86\u65e5\u5fd7\u6253\u5370\n\n        //\u8de8\u57df\u7684\u914d\u7f6e\n\t\tif (CorsUtils.isCorsRequest(request)) {\n\t\t\tCorsConfiguration globalConfig = this.corsConfigurationSource.getCorsConfiguration(request);\n\t\t\tCorsConfiguration handlerConfig = getCorsConfiguration(handler, request);\n\t\t\tCorsConfiguration config = (globalConfig != null ? globalConfig.combine(handlerConfig) : handlerConfig);\n\t\t\texecutionChain = getCorsHandlerExecutionChain(request, executionChain, config);\n\t\t}\n\n\t\treturn executionChain;\n\t}\n"})}),"\n",(0,r.jsxs)(e.p,{children:["\u7136\u540e\u5c31\u662f\u83b7\u53d6 ",(0,r.jsx)(e.strong,{children:(0,r.jsx)(e.code,{children:"HandlerAdapter ha = getHandlerAdapter(mappedHandler.getHandler())"})})," \u9002\u914d\u5668\u3002"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'protected HandlerAdapter getHandlerAdapter(Object handler) throws ServletException {\n\t\tif (this.handlerAdapters != null) {\n\t\t\t//\u83b7\u53d6\u5904\u7406\u9002\u914d\u5668\n            for (HandlerAdapter adapter : this.handlerAdapters) {\n\t\t\t\tif (adapter.supports(handler)) {\n\t\t\t\t\treturn adapter;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tthrow new ServletException("No adapter for handler [" + handler +\n\t\t\t\t"]: The DispatcherServlet configuration needs to include a HandlerAdapter that supports this handler");\n\t}\n'})}),"\n",(0,r.jsxs)(e.p,{children:["\u9002\u914d\u5668\u9ed8\u8ba4\u52a0\u8f7d\u7684 ",(0,r.jsx)(e.strong,{children:(0,r.jsx)(e.code,{children:"RequestMappingHandlerAdapter"})})," \u9002\u914d\u5668\u3002 ",(0,r.jsx)(e.strong,{children:(0,r.jsx)(e.code,{children:"mappedHandler.applyPreHandle(processedRequest, response)"})}),"  \u5904\u7406 ",(0,r.jsx)(e.strong,{children:(0,r.jsx)(e.code,{children:"HandlerInterceptor"})})," \u7684 ",(0,r.jsx)(e.em,{children:(0,r.jsx)(e.strong,{children:(0,r.jsx)(e.code,{children:"preHandle"})})})," \u65b9\u6cd5\u3002\u7136\u540e ",(0,r.jsx)(e.strong,{children:(0,r.jsx)(e.code,{children:"mv = ha.handle(processedRequest, response, mappedHandler.getHandler())"})})," \u8c03\u7528 ",(0,r.jsx)(e.strong,{children:(0,r.jsx)(e.code,{children:"HandlerAdapter"})})," \u7684 ",(0,r.jsx)(e.strong,{children:(0,r.jsx)(e.code,{children:"handle"})})," \u65b9\u6cd5\u3002 ",(0,r.jsx)(e.strong,{children:(0,r.jsx)(e.code,{children:"mappedHandler.applyPostHandle(processedRequest, response, mv);"})})," \u63a5\u4e0b\u6765\u6267\u884c ",(0,r.jsx)(e.strong,{children:(0,r.jsx)(e.code,{children:"HandlerInterceptor"})}),"  \u7684 ",(0,r.jsx)(e.em,{children:(0,r.jsx)(e.strong,{children:(0,r.jsx)(e.code,{children:"postHandle"})})}),"\u3002"]})]})}function d(t={}){const{wrapper:e}={...(0,s.R)(),...t.components};return e?(0,r.jsx)(e,{...t,children:(0,r.jsx)(p,{...t})}):p(t)}},8453:(t,e,n)=>{n.d(e,{R:()=>i,x:()=>l});var r=n(6540);const s={},a=r.createContext(s);function i(t){const e=r.useContext(a);return r.useMemo((function(){return"function"==typeof t?t(e):{...e,...t}}),[e,t])}function l(t){let e;return e=t.disableParentContext?"function"==typeof t.components?t.components(s):t.components||s:i(t.components),r.createElement(a.Provider,{value:e},t.children)}}}]);