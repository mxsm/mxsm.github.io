"use strict";(self.webpackChunkmxsm_website=self.webpackChunkmxsm_website||[]).push([[6968],{3905:(e,r,t)=>{t.d(r,{Zo:()=>c,kt:()=>d});var n=t(7294);function a(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function o(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r&&(n=n.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,n)}return t}function l(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?o(Object(t),!0).forEach((function(r){a(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}function u(e,r){if(null==e)return{};var t,n,a=function(e,r){if(null==e)return{};var t,n,a={},o=Object.keys(e);for(n=0;n<o.length;n++)t=o[n],r.indexOf(t)>=0||(a[t]=e[t]);return a}(e,r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)t=o[n],r.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var i=n.createContext({}),s=function(e){var r=n.useContext(i),t=r;return e&&(t="function"==typeof e?e(r):l(l({},r),e)),t},c=function(e){var r=s(e.components);return n.createElement(i.Provider,{value:r},e.children)},p="mdxType",m={inlineCode:"code",wrapper:function(e){var r=e.children;return n.createElement(n.Fragment,{},r)}},k=n.forwardRef((function(e,r){var t=e.components,a=e.mdxType,o=e.originalType,i=e.parentName,c=u(e,["components","mdxType","originalType","parentName"]),p=s(t),k=a,d=p["".concat(i,".").concat(k)]||p[k]||m[k]||o;return t?n.createElement(d,l(l({ref:r},c),{},{components:t})):n.createElement(d,l({ref:r},c))}));function d(e,r){var t=arguments,a=r&&r.mdxType;if("string"==typeof e||a){var o=t.length,l=new Array(o);l[0]=k;var u={};for(var i in r)hasOwnProperty.call(r,i)&&(u[i]=r[i]);u.originalType=e,u[p]="string"==typeof e?e:a,l[1]=u;for(var s=2;s<o;s++)l[s]=t[s];return n.createElement.apply(null,l)}return n.createElement.apply(null,t)}k.displayName="MDXCreateElement"},7199:(e,r,t)=>{t.r(r),t.d(r,{assets:()=>i,contentTitle:()=>l,default:()=>p,frontMatter:()=>o,metadata:()=>u,toc:()=>s});var n=t(7462),a=(t(7294),t(3905));const o={title:"broker busy\u95ee\u9898",date:new Date("2020-04-05T00:00:00.000Z")},l=void 0,u={unversionedId:"rocketmq/rocketmq4/issue/broker-busy-issue",id:"rocketmq/rocketmq4/issue/broker-busy-issue",title:"broker busy\u95ee\u9898",description:"\u4e00\u8d77\u517b\u6210\u5199\u4f5c\u4e60\u60ef\uff01\u8fd9\u662f\u6211\u53c2\u4e0e\u300c\u6398\u91d1\u65e5\u65b0\u8ba1\u5212 \xb7 4 \u6708\u66f4\u6587\u6311\u6218\u300d\u7684\u7b2c20\u5929\uff0c\u70b9\u51fb\u67e5\u770b\u6d3b\u52a8\u8be6\u60c5\u3002",source:"@site/docs/rocketmq/rocketmq4/issue/broker-busy-issue.md",sourceDirName:"rocketmq/rocketmq4/issue",slug:"/rocketmq/rocketmq4/issue/broker-busy-issue",permalink:"/docs/rocketmq/rocketmq4/issue/broker-busy-issue",draft:!1,editUrl:"https://github.com/mxsm/mxsm-website/edit/develop/docs/rocketmq/rocketmq4/issue/broker-busy-issue.md",tags:[],version:"current",lastUpdatedBy:"mxsm",lastUpdatedAt:1672841610,formattedLastUpdatedAt:"Jan 4, 2023",frontMatter:{title:"broker busy\u95ee\u9898",date:"2020-04-05T00:00:00.000Z"}},i={},s=[{value:"1. \u95ee\u9898\u63cf\u8ff0",id:"1-\u95ee\u9898\u63cf\u8ff0",level:3},{value:"2. \u6e90\u7801\u5206\u6790\u95ee\u9898",id:"2-\u6e90\u7801\u5206\u6790\u95ee\u9898",level:3},{value:"3. \u5982\u4f55\u89e3\u51b3\u95ee\u9898",id:"3-\u5982\u4f55\u89e3\u51b3\u95ee\u9898",level:3}],c={toc:s};function p(e){let{components:r,...t}=e;return(0,a.kt)("wrapper",(0,n.Z)({},c,t,{components:r,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"\u4e00\u8d77\u517b\u6210\u5199\u4f5c\u4e60\u60ef\uff01\u8fd9\u662f\u6211\u53c2\u4e0e\u300c\u6398\u91d1\u65e5\u65b0\u8ba1\u5212 \xb7 4 \u6708\u66f4\u6587\u6311\u6218\u300d\u7684\u7b2c20\u5929\uff0c",(0,a.kt)("a",{parentName:"p",href:"https://juejin.cn/post/7080800226365145118"},"\u70b9\u51fb\u67e5\u770b\u6d3b\u52a8\u8be6\u60c5"),"\u3002"),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"Rocket MQ\u7248\u672c 4.8.0")),(0,a.kt)("h3",{id:"1-\u95ee\u9898\u63cf\u8ff0"},"1. \u95ee\u9898\u63cf\u8ff0"),(0,a.kt)("p",null,"\u5728\u751f\u4ea7\u8005\u4e0d\u505c\u7684\u5f80Broker\u53d1\u9001\u6d88\u606f\u62a5broker busy\uff0c\u8fd9\u4e2a\u662f\u5728\u7814\u7a76RocketMQ\u6e90\u7801\u672c\u5730\u542f\u52a8\u670d\u52a1\u8fdb\u884c\u6d4b\u8bd5\u7684\u65f6\u5019\u51fa\u73b0\u7684\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"org.apache.rocketmq.client.exception.MQBrokerException: CODE: 2  DESC: [TIMEOUT_CLEAN_QUEUE]broker busy, start flow control for a while, period in queue: 240ms, size of queue: 9\nFor more information, please visit the url, http://rocketmq.apache.org/docs/faq/\n    at org.apache.rocketmq.client.impl.MQClientAPIImpl.processSendResponse(MQClientAPIImpl.java:711)\n    at org.apache.rocketmq.client.impl.MQClientAPIImpl.sendMessageSync(MQClientAPIImpl.java:505)\n    at org.apache.rocketmq.client.impl.MQClientAPIImpl.sendMessage(MQClientAPIImpl.java:487)\n    at org.apache.rocketmq.client.impl.MQClientAPIImpl.sendMessage(MQClientAPIImpl.java:431)\n    at org.apache.rocketmq.client.impl.producer.DefaultMQProducerImpl.sendKernelImpl(DefaultMQProducerImpl.java:853)\n    at org.apache.rocketmq.client.impl.producer.DefaultMQProducerImpl.sendDefaultImpl(DefaultMQProducerImpl.java:583)\n    at org.apache.rocketmq.client.impl.producer.DefaultMQProducerImpl.send(DefaultMQProducerImpl.java:1342)\n    at org.apache.rocketmq.client.impl.producer.DefaultMQProducerImpl.send(DefaultMQProducerImpl.java:1288)\n    at org.apache.rocketmq.client.producer.DefaultMQProducer.send(DefaultMQProducer.java:324)\n    at com.github.mxsm.MQProducer.lambda$main$0(MQProducer.java:50)\n    at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)\n    at java.util.concurrent.FutureTask.run$$$capture(FutureTask.java:266)\n    at java.util.concurrent.FutureTask.run(FutureTask.java)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\n    at java.lang.Thread.run(Thread.java:748)\n")),(0,a.kt)("p",null,"\u90a3\u4e48\u6211\u4eec\u5c31\u4ece\u6e90\u7801\u5206\u6790\u95ee\u9898\uff0c\u770b\u770b\u5982\u4f55\u89e3\u51b3\u3002"),(0,a.kt)("h3",{id:"2-\u6e90\u7801\u5206\u6790\u95ee\u9898"},"2. \u6e90\u7801\u5206\u6790\u95ee\u9898"),(0,a.kt)("p",null,"\u901a\u8fc7\u641c\u7d22\u9519\u8bef\u4fe1\u606f\u53ef\u4ee5\u5b9a\u4f4d\u5230\u9519\u8bef\u662f\u4ece ",(0,a.kt)("strong",{parentName:"p"},(0,a.kt)("inlineCode",{parentName:"strong"},"BrokerFastFailure"))," \u7c7b\u629b\u51fa\u6765\u7684\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java"},'    void cleanExpiredRequestInQueue(final BlockingQueue<Runnable> blockingQueue, final long maxWaitTimeMillsInQueue) {\n        while (true) {\n            try {\n                if (!blockingQueue.isEmpty()) {\n                    final Runnable runnable = blockingQueue.peek();\n                    if (null == runnable) {\n                        break;\n                    }\n                    final RequestTask rt = castRunnable(runnable);\n                    if (rt == null || rt.isStopRun()) {\n                        break;\n                    }\n\n                    final long behind = System.currentTimeMillis() - rt.getCreateTimestamp();\n                    if (behind >= maxWaitTimeMillsInQueue) {\n                        if (blockingQueue.remove(runnable)) {\n                            rt.setStopRun(true);\n                            rt.returnResponse(RemotingSysResponseCode.SYSTEM_BUSY, String.format("[TIMEOUT_CLEAN_QUEUE]broker busy, start flow control for a while, period in queue: %sms, size of queue: %d", behind, blockingQueue.size()));\n                        }\n                    } else {\n                        break;\n                    }\n                } else {\n                    break;\n                }\n            } catch (Throwable ignored) {\n            }\n        }\n    }\n')),(0,a.kt)("p",null,"\u90a3\u4e48\u8fd9\u4e2a ",(0,a.kt)("strong",{parentName:"p"},(0,a.kt)("inlineCode",{parentName:"strong"},"BrokerFastFailure#cleanExpiredRequestInQueue")),"  \u4e3b\u8981\u7528\u4e8e\u6e05\u7406\u963b\u585e\u961f\u5217\u4e2d\u7684\u8fc7\u671f\u7684 ",(0,a.kt)("strong",{parentName:"p"},(0,a.kt)("inlineCode",{parentName:"strong"},"RequestTask"))," \u3002\u8fd9\u4e2a\u65b9\u6cd5\u5728",(0,a.kt)("strong",{parentName:"p"},(0,a.kt)("inlineCode",{parentName:"strong"},"BrokerFastFailure#cleanExpiredRequest"))," \u4e2d\u88ab\u8c03\u7528\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java"},'    private void cleanExpiredRequest() {\n        \n        //\u7cfb\u7edf\u9875\u5fd9\u629b\u9519\n        while (this.brokerController.getMessageStore().isOSPageCacheBusy()) {\n            try {\n                if (!this.brokerController.getSendThreadPoolQueue().isEmpty()) {\n                    final Runnable runnable = this.brokerController.getSendThreadPoolQueue().poll(0, TimeUnit.SECONDS);\n                    if (null == runnable) {\n                        break;\n                    }\n\n                    final RequestTask rt = castRunnable(runnable);\n                    rt.returnResponse(RemotingSysResponseCode.SYSTEM_BUSY, String.format("[PCBUSY_CLEAN_QUEUE]broker busy, start flow control for a while, period in queue: %sms, size of queue: %d", System.currentTimeMillis() - rt.getCreateTimestamp(), this.brokerController.getSendThreadPoolQueue().size()));\n                } else {\n                    break;\n                }\n            } catch (Throwable ignored) {\n            }\n        }\n        //\u6e05\u7406\u8fc7\u671f\u53d1\u9001\u6d88\u606f\u961f\u5217\u8bf7\u6c42\n        cleanExpiredRequestInQueue(this.brokerController.getSendThreadPoolQueue(),\n            this.brokerController.getBrokerConfig().getWaitTimeMillsInSendQueue());\n        //\u6e05\u7406\u8fc7\u671f\u62c9\u53d6\u6d88\u606f\u7684\u8bf7\u6c42\n        cleanExpiredRequestInQueue(this.brokerController.getPullThreadPoolQueue(),\n            this.brokerController.getBrokerConfig().getWaitTimeMillsInPullQueue());\n        //\u6e05\u7406\u8fc7\u671f\u5fc3\u8df3\u7684\u8bf7\u6c42\n        cleanExpiredRequestInQueue(this.brokerController.getHeartbeatThreadPoolQueue(),\n            this.brokerController.getBrokerConfig().getWaitTimeMillsInHeartbeatQueue());\n//\u6e05\u7406\u8fc7\u671f\u4e8b\u52a1\u8bf7\u6c42\n        cleanExpiredRequestInQueue(this.brokerController.getEndTransactionThreadPoolQueue(), this\n            .brokerController.getBrokerConfig().getWaitTimeMillsInTransactionQueue());\n    }\n')),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"\u7531\u4e8e\u662f\u4e4b\u524d\u5728\u4e0d\u505c\u7684\u5f80MQ\u53d1\u9001\u6d88\u606f\u6d88\u606f\uff0c\u6240\u4ee5\u5224\u65ad\u662f\u7531\u4e8e\u6e05\u7406\u8fc7\u671f\u7684\u53d1\u9001\u5904\u7406\u8bf7\u6c42\u5bfc\u81f4\u7684\u3002")," "),(0,a.kt)("h3",{id:"3-\u5982\u4f55\u89e3\u51b3\u95ee\u9898"},"3. \u5982\u4f55\u89e3\u51b3\u95ee\u9898"),(0,a.kt)("p",null,"\u90a3\u4e48\u5982\u4f55\u89e3\u51b3\u95ee\u9898\uff0c\u901a\u8fc7\u4ee3\u7801\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java"},"cleanExpiredRequestInQueue(this.brokerController.getSendThreadPoolQueue(),\n            this.brokerController.getBrokerConfig().getWaitTimeMillsInSendQueue());\n")),(0,a.kt)("p",null,"\u53ef\u4ee5\u770b\u4e00\u51fa\u6765\u901a\u8fc7\u589e\u52a0\u7b49\u5f85\u65f6\u95f4\u6765\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u3002\u53ea\u9700\u8981\u5728\u914d\u7f6eBroker\u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\u4fee\u6539\u5982\u4e0b\u503c\u5373\u53ef\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-properties"},"waitTimeMillsInSendQueue=200 \uff08\u9ed8\u8ba4\u503c\uff09--\u4fee\u6539\u8fd9\u4e2a\u503c\n")),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"\u6211\u662f\u8682\u8681\u80cc\u5927\u8c61\uff0c\u6587\u7ae0\u5bf9\u4f60\u6709\u5e2e\u52a9\u70b9\u8d5e\u5173\u6ce8\u6211\uff0c\u6587\u7ae0\u6709\u4e0d\u6b63\u786e\u7684\u5730\u65b9\u8bf7\u60a8\u65a7\u6b63\u7559\u8a00\u8bc4\u8bba~\u8c22\u8c22\uff01")))}p.isMDXComponent=!0}}]);