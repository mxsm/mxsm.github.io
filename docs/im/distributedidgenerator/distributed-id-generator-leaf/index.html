<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.83.1"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>分布式ID生成器-美团Leaf | 蚂蚁背大象</title><meta property="og:title" content="分布式ID生成器-美团Leaf"><meta property="og:description" content="1. 美团Leaf分布式ID生成器 美团Leaf 最早期需求是各个业务线的订单ID生成需求，具体Leaf 设计文档见：leaf 美团分布式ID生成服务。Leaf的特点：
 Leaf依赖了数据库或者ZK(这里依赖ZK实现的Snowflake是对Snowflake原有的方式的一种增强)。 Leaf提供两种模式：Leaf-segment数据库模式和Leaf-snowflake模式两种。 对snowflake时间回拨做了优化。解决了时间回拨的问题。  2.Leaf的Java实现 在Github上美团有实现代码，下面我们跟进代码搭建一个本地项目跑起来。并且使用一下看看。
Clone代码:
git clone https://github.com/Meituan-Dianping/Leaf.git 配置：
进入leaf-server/src/main/resources/leaf.properties配置文件中设置
   配置 说明 默认值     leaf.name leaf service name    leaf.segment.enable whether segment mode is enabled false   leaf.jdbc.url mysql url    leaf.jdbc.username mysql username    leaf.jdbc.password mysql password    leaf.snowflake.enable whether snowflake mode is enabled false   leaf."><meta property="og:type" content="article"><meta property="og:url" content="/docs/im/distributedidgenerator/distributed-id-generator-leaf/"><meta property="article:section" content="docs"><meta property="article:published_time" content="2022-04-10T00:00:00+00:00"><meta property="article:modified_time" content="2022-04-30T07:10:27+08:00"><meta property="og:site_name" content="蚂蚁背大象"><meta itemprop=name content="分布式ID生成器-美团Leaf"><meta itemprop=description content="1. 美团Leaf分布式ID生成器 美团Leaf 最早期需求是各个业务线的订单ID生成需求，具体Leaf 设计文档见：leaf 美团分布式ID生成服务。Leaf的特点：
 Leaf依赖了数据库或者ZK(这里依赖ZK实现的Snowflake是对Snowflake原有的方式的一种增强)。 Leaf提供两种模式：Leaf-segment数据库模式和Leaf-snowflake模式两种。 对snowflake时间回拨做了优化。解决了时间回拨的问题。  2.Leaf的Java实现 在Github上美团有实现代码，下面我们跟进代码搭建一个本地项目跑起来。并且使用一下看看。
Clone代码:
git clone https://github.com/Meituan-Dianping/Leaf.git 配置：
进入leaf-server/src/main/resources/leaf.properties配置文件中设置
   配置 说明 默认值     leaf.name leaf service name    leaf.segment.enable whether segment mode is enabled false   leaf.jdbc.url mysql url    leaf.jdbc.username mysql username    leaf.jdbc.password mysql password    leaf.snowflake.enable whether snowflake mode is enabled false   leaf."><meta itemprop=datePublished content="2022-04-10T00:00:00+00:00"><meta itemprop=dateModified content="2022-04-30T07:10:27+08:00"><meta itemprop=wordCount content="117"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="分布式ID生成器-美团Leaf"><meta name=twitter:description content="1. 美团Leaf分布式ID生成器 美团Leaf 最早期需求是各个业务线的订单ID生成需求，具体Leaf 设计文档见：leaf 美团分布式ID生成服务。Leaf的特点：
 Leaf依赖了数据库或者ZK(这里依赖ZK实现的Snowflake是对Snowflake原有的方式的一种增强)。 Leaf提供两种模式：Leaf-segment数据库模式和Leaf-snowflake模式两种。 对snowflake时间回拨做了优化。解决了时间回拨的问题。  2.Leaf的Java实现 在Github上美团有实现代码，下面我们跟进代码搭建一个本地项目跑起来。并且使用一下看看。
Clone代码:
git clone https://github.com/Meituan-Dianping/Leaf.git 配置：
进入leaf-server/src/main/resources/leaf.properties配置文件中设置
   配置 说明 默认值     leaf.name leaf service name    leaf.segment.enable whether segment mode is enabled false   leaf.jdbc.url mysql url    leaf.jdbc.username mysql username    leaf.jdbc.password mysql password    leaf.snowflake.enable whether snowflake mode is enabled false   leaf."><link rel=preload href=/scss/main.min.e09cb23c7dff3bf1285aa0294bcdc4ac8194fb3425a99c621e31e7b871315685.css as=style><link href=/scss/main.min.e09cb23c7dff3bf1285aa0294bcdc4ac8194fb3425a99c621e31e7b871315685.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 321.39 78.54"><title id="title19">DUBBO LOGO</title><path class="cls-1" d="M68.46 50.38c0 14.06 11.39 22.11 25.45 22.11s25.45-8.05 25.45-22.11V7.25H68.46zm21.24-28h8.6V31H89.7zm0 22.25h8.6v8.6H89.7zM33.24 7.25H4.06v64H33.24c10.95.0 19.3-7.18 23.29-17.15a45.12 45.12.0 002.38-14.87A45.12 45.12.0 0056.53 24.4C52.84 14.62 44.19 7.25 33.24 7.25zm.43 14.63H30.34a3.44 3.44.0 00-3.44 3.44V53.23a3.44 3.44.0 003.44 3.44h3.33v4.63h-8.3a6.87 6.87.0 01-6.87-6.87V24.12a6.87 6.87.0 016.87-6.87h8.3zM285.51 6.06c-17.05.0-30.88 10.28-30.88 33.21s13.83 33.21 30.88 33.21 30.88-10.28 30.88-33.21S302.56 6.06 285.51 6.06zm7.59 48.36a6.87 6.87.0 01-6.87 6.87h-8.3V56.67h3.33a3.44 3.44.0 003.44-3.44V25.31a3.44 3.44.0 00-3.44-3.44h-3.33V17.25h8.3a6.87 6.87.0 016.87 6.87zm-53.4-17.56A17.39 17.39.0 00227.31 7.25H195.1v64h32.21a19.44 19.44.0 0012.38-34.44zM211.63 61.29h-6.08l18.68-44h6.08zM177 36.85A17.39 17.39.0 00164.65 7.25H132.43v64h32.21A19.44 19.44.0 00177 36.85zM149 61.29h-6.08l18.68-44h6.08z" style="fill:#fff;fill-opacity:1"/></svg></span><span class="text-uppercase font-weight-bold">蚂蚁背大象</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/about/><span>Home</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog/><span>Java</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/spring/><span>Spring</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/middlewares/><span>Middleware</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/docs/><span class=active>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/other/><span>Others</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community/><span>Community</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002 站内搜索…" aria-label=站内搜索… autocomplete=off></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002 站内搜索…" aria-label=站内搜索… autocomplete=off>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">Documentation</a></li><ul><li class="collapse show" id=docs><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/theory/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">理论知识</a></li><ul><li class=collapse id=docstheory><a class="td-sidebar-link td-sidebar-link__page" id=m-docstheoryinterface-power-etc href=/docs/theory/interface-power-etc/>什么是接口幂等，接口幂等如何保证</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docstheorymessage-loss-prevention href=/docs/theory/message-loss-prevention/>RocketMQ保证消息不丢失</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docstheorydouble-write-consistency href=/docs/theory/double-write-consistency/>缓存与数据库双写数据一致性问题</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docstheoryringbuffer-theory href=/docs/theory/ringbuffer-theory/>RingBuffer-理论篇</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docstheoryringbuffer-implment-java href=/docs/theory/ringbuffer-implment-java/>RingBuffer-实践</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docstheoryringbuffer-implment-disruptor href=/docs/theory/ringbuffer-implment-disruptor/>Disruptor-高性能队列</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docstheoryjctools href=/docs/theory/jctools/>Java并发工具-JCTools简介</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/im/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">IM-即时通讯</a></li><ul><li class="collapse show" id=docsim><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/im/architecture/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">IM架构</a></li><ul><li class=collapse id=docsimarchitecture><a class="td-sidebar-link td-sidebar-link__page" id=m-docsimarchitecturemagpie-bridge href=/docs/im/architecture/magpie-bridge/>客户端接入服务(Magpie Bridge)</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsimarchitectureoverall-architecture href=/docs/im/architecture/overall-architecture/>IM系统总体架构</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsimarchitectureprotocol href=/docs/im/architecture/protocol/>IM协议</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsimarchitectureregister href=/docs/im/architecture/register/>注册中心(Register)</a></li></ul></ul><a class="td-sidebar-link td-sidebar-link__page" id=m-docsimcoredns-1 href=/docs/im/coredns-1/>CoreDNS搭建内网DNS服务</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsimcoredns-2 href=/docs/im/coredns-2/>CoreDNS+ETCD实现DNS服务发现</a><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/im/distributedidgenerator/ class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">分布式ID生成器</a></li><ul><li class="collapse show" id=docsimdistributedidgenerator><a class="td-sidebar-link td-sidebar-link__page" id=m-docsimdistributedidgeneratordistributed-id-generator-uuid href=/docs/im/distributedidgenerator/distributed-id-generator-uuid/>分布式ID生成器-UUID</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsimdistributedidgeneratordistributed-id-generator-mysql href=/docs/im/distributedidgenerator/distributed-id-generator-mysql/>分布式ID生成器-MySQL数据库自增</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsimdistributedidgeneratordistributed-id-generator-redis href=/docs/im/distributedidgenerator/distributed-id-generator-redis/>分布式ID生成器-Redis</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsimdistributedidgeneratordistributed-id-generator-snowflake href=/docs/im/distributedidgenerator/distributed-id-generator-snowflake/>分布式ID生成器-雪花算法</a>
<a class="td-sidebar-link td-sidebar-link__page active" id=m-docsimdistributedidgeneratordistributed-id-generator-leaf href=/docs/im/distributedidgenerator/distributed-id-generator-leaf/>分布式ID生成器-美团Leaf</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsimdistributedidgeneratordistributed-id-generator-tinyid href=/docs/im/distributedidgenerator/distributed-id-generator-tinyid/>分布式ID生成器-Tinyid</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsimdistributedidgeneratordistributed-id-generator-uid href=/docs/im/distributedidgenerator/distributed-id-generator-uid/>分布式ID生成器-百度UidGenerator</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsimdistributedidgeneratordistributed-id-generator-custom href=/docs/im/distributedidgenerator/distributed-id-generator-custom/>分布式ID生成器-mxsm-uidgenerator</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsimdistributedidgeneratordistributed-id-generator-custom-use href=/docs/im/distributedidgenerator/distributed-id-generator-custom-use/>分布式ID生成器-mxsm-uidgenerator如何使用</a></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/grpc/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">gRPC</a></li><ul><li class=collapse id=docsgrpc><a class="td-sidebar-link td-sidebar-link__page" id=m-docsgrpcgrpc href=/docs/grpc/grpc/>深入浅出理解gRPC</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsgrpcgrpc-concepts-architecture-lifecycle href=/docs/grpc/grpc-concepts-architecture-lifecycle/>gRPC的概念-图文并茂</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsgrpcprotobut-json href=/docs/grpc/protobut-json/>Protobuf与JSON的优劣-用数据说话</a></li></ul></ul><a class="td-sidebar-link td-sidebar-link__page" id=m-docswork-issue-solutionsystem-data-bisynchronous-solution href=/docs/work-issue-solution/system-data-bisynchronous-solution/>系统数据双向同步方案</a></li></ul></ul></nav></div></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/mxsm/mxsm-website/edit/main/content/en/docs/IM/DistributedIDGenerator/distributed-id-generator-leaf.md target=_blank><i class="fa fa-edit fa-fw"></i> 编辑此页</a>
<a href="https://github.com/mxsm/mxsm-website/new/main/content/en/docs/IM/DistributedIDGenerator/distributed-id-generator-leaf.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" target=_blank><i class="fa fa-edit fa-fw"></i> 添加子页面</a>
<a href="https://github.com/mxsm/mxsm-website/issues/new?title=%e5%88%86%e5%b8%83%e5%bc%8fID%e7%94%9f%e6%88%90%e5%99%a8-%e7%be%8e%e5%9b%a2Leaf" target=_blank><i class="fab fa-github fa-fw"></i> 提交文档问题</a>
<a href=https://github.com/mxsm/mxsm-website/issues/new target=_blank><i class="fas fa-tasks fa-fw"></i> 提交项目问题</a>
<a id=print href=/docs/im/distributedidgenerator/_print/><i class="fa fa-print fa-fw"></i> Print entire section</a></div><nav id=TableOfContents><ul><li><ul><li><ul><li><a href=#1-美团leaf分布式id生成器>1. 美团Leaf分布式ID生成器</a></li><li><a href=#2leaf的java实现>2.Leaf的Java实现</a></li><li><a href=#3-总结>3. 总结</a></li></ul></li></ul></li></ul></nav></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class="d-none d-md-block d-print-none"><ol class="breadcrumb spb-1"><li class=breadcrumb-item><a href=/docs/>Documentation</a></li><li class=breadcrumb-item><a href=/docs/im/>IM-即时通讯</a></li><li class=breadcrumb-item><a href=/docs/im/distributedidgenerator/>分布式ID生成器</a></li><li class="breadcrumb-item active" aria-current=page><a href=/docs/im/distributedidgenerator/distributed-id-generator-leaf/>分布式ID生成器-美团Leaf</a></li></ol></nav><div class=td-content><h1>分布式ID生成器-美团Leaf</h1><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/architecture/Distributed%20ID-Generation%E5%B8%B8%E7%94%A8%E5%88%86%E5%B8%83%E5%BC%8FID%E7%94%9F%E6%88%90%E5%99%A8.png alt=常用分布式ID生成器></p><h3 id=1-美团leaf分布式id生成器>1. 美团Leaf分布式ID生成器</h3><p>美团Leaf 最早期需求是各个业务线的订单ID生成需求，具体Leaf 设计文档见：<a href=https://tech.meituan.com/MT_Leaf.html> leaf 美团分布式ID生成服务</a>。Leaf的特点：</p><ul><li>Leaf依赖了数据库或者ZK(这里依赖ZK实现的Snowflake是对Snowflake原有的方式的一种增强)。</li><li>Leaf提供两种模式：Leaf-segment数据库模式和Leaf-snowflake模式两种。</li><li>对snowflake时间回拨做了优化。解决了时间回拨的问题。</li></ul><h3 id=2leaf的java实现>2.Leaf的Java实现</h3><p>在Github上美团有实现代码，下面我们跟进代码搭建一个本地项目跑起来。并且使用一下看看。</p><p><strong>Clone代码:</strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/Meituan-Dianping/Leaf.git
</code></pre></div><p><strong>配置：</strong></p><p>进入leaf-server/src/main/resources/leaf.properties配置文件中设置</p><table><thead><tr><th>配置</th><th>说明</th><th>默认值</th></tr></thead><tbody><tr><td>leaf.name</td><td>leaf service name</td><td></td></tr><tr><td>leaf.segment.enable</td><td>whether segment mode is enabled</td><td>false</td></tr><tr><td>leaf.jdbc.url</td><td>mysql url</td><td></td></tr><tr><td>leaf.jdbc.username</td><td>mysql username</td><td></td></tr><tr><td>leaf.jdbc.password</td><td>mysql password</td><td></td></tr><tr><td>leaf.snowflake.enable</td><td>whether snowflake mode is enabled</td><td>false</td></tr><tr><td>leaf.snowflake.zk.address</td><td>zk address under snowflake mode</td><td></td></tr><tr><td>leaf.snowflake.port</td><td>service registration port under snowflake mode</td><td></td></tr></tbody></table><p>我们开启**<code>leaf.segment.enable=true</code>** 。而**<code>leaf.snowflake.enable</code>** 由于需要使用到zk暂时不开起。leaf.properties设置：</p><pre><code class=language-properties data-lang=properties>leaf.name=mxsm
leaf.segment.enable=true
leaf.jdbc.url=jdbc:mysql://192.168.43.129:3306/leaf?useUnicode=true&amp;characterEncoding=utf-8
leaf.jdbc.username=root
leaf.jdbc.password=sys123456
</code></pre><p><strong>执行脚本：</strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>leaf_alloc</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>biz_tag</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>varchar</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>128</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>-- your biz unique name
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>max_id</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>bigint</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;1&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>step</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>int</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>11</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>description</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>varchar</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>256</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>update_time</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>timestamp</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>CURRENT_TIMESTAMP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>UPDATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>CURRENT_TIMESTAMP</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>PRIMARY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>biz_tag</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ENGINE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>InnoDB</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>insert</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>into</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>leaf_alloc</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>biz_tag</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>max_id</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>step</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>description</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>values</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;leaf-segment-test&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2000</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Test leaf Segment Mode Get Id&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/architecture/image-20220410211931372.png alt=image-20220410211931372></p><p><strong>编译项目：</strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#204a87>cd</span> Leaf
mvn clean install -DskipTests
</code></pre></div><p><strong>运行项目：</strong></p><pre><code>cd leaf-server
mvn spring-boot:run
</code></pre><p>项目启动完成：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/architecture/image-20220410213923017.png alt=image-20220410213923017></p><blockquote><p>Tips: 我使用的是mysql8.0所以修改了 mysql的connector版本以及druid的版本，不修改报错。jdk版本使用的是11</p></blockquote><p><strong>测试：</strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#8f5902;font-style:italic>#segment</span>
curl http://localhost:8080/api/segment/get/leaf-segment-test
<span style=color:#8f5902;font-style:italic>#snowflake</span>
curl http://localhost:8080/api/snowflake/get/test
</code></pre></div><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/architecture/leaf%E6%B5%8B%E8%AF%95.gif alt=leaf测试></p><p>完全可以使用。</p><blockquote><p>Tips: 代码自行分析，大体都差不多。</p></blockquote><h3 id=3-总结>3. 总结</h3><p><strong><code>Leaf-segment</code></strong> 数据库模式结合数据库以及内存生成的有点。相当于之前文章中Redis实现的一种增强。这里在数据库发生错误后还能短暂的提供服务，但是服务的多长取决于 <strong><code>step</code></strong> 。如果步长设置的很大那么就能长时间的提供服务就算数据库发生错误。但是同样可能导致大量的浪费。</p><p><strong><code>Leaf-snowflake</code></strong> 用ZK来实现对workId的分配。解决了需要手动指定的情况。</p><blockquote><p>我是蚂蚁背大象，文章对你有帮助点赞关注我，文章有不正确的地方请您斧正留言评论~谢谢</p></blockquote><p>参考资料：</p><ul><li><a href=https://tech.meituan.com/2017/04/21/mt-leaf.html>https://tech.meituan.com/2017/04/21/mt-leaf.html</a></li><li><a href=https://github.com/Meituan-Dianping/Leaf>https://github.com/Meituan-Dianping/Leaf</a></li></ul><br><div class=page-blank><div id=disqus_thread></div><script>(function(){var a=document,b=a.createElement('script');b.src='https://ljbmxsm.disqus.com/embed.js',b.setAttribute('data-timestamp',+new Date),(a.head||a.body).appendChild(b)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div><div class="text-muted mt-5 pt-3 border-top">最后修改 2022-04-30: <a href=https://github.com/mxsm/mxsm-website/commit/dbc47c23aacb0ee9bf90b9b8911676ad7717ef3d>fix blog title bug (dbc47c2)</a></div></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list"><a class=text-white target=_blank rel="noopener noreferrer" href=https://groups.google.com/u/1/g/ljbmxsm><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=个人掘金主页 aria-label=个人掘金主页><a class=text-white target=_blank rel="noopener noreferrer" href=https://juejin.cn/user/1151943918492855><i class="fab fa-twitter"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/mxsm><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2022 The Docsy Authors All Rights Reserved</small>
<small class=ml-1><a href=https://policies.google.com/privacy target=_blank>隐私政策</a></small><p class=mt-2><a href=/about/>Home</a></p></div></div></div></footer><div><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css><script src=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js></script><script>$("p img").wrap(function(){return'<a data-fancybox="gallery" href="'+$(this).attr('src')+'"></a>'})</script></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/mermaid@8.8.1/dist/mermaid.min.js integrity=sha384-to2w0I1OqmbJ9J6yTnIX+KYU8grNpZoD1dKPLjgEJvMe5L5+/7qvuNa2sQo8WAWj crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/raphael/2.3.0/raphael.min.js integrity="sha512-tBzZQxySO5q5lqwLWfu8Q+o4VkTcRGOeQGVQ0ueJga4A1RKuzmAu5HXDOXLEjpbKyV7ow9ympVoa6wZLEzRzDg==" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.15.0/flowchart.min.js integrity="sha512-6QsSiIybtf8tuZ6xfjRTr2tdtw3Gp4q5RSCh2b6q9seoKEQmhAG1RrCA8F0kXTwivVxRVbp/YF3zOh8rvEAU7Q==" crossorigin=anonymous></script><script src=/js/main.min.b541b310f01941a0abfd76b652b5fb60dac470573775bb5b31ff08fe3f6cea51.js integrity="sha256-tUGzEPAZQaCr/Xa2UrX7YNrEcFc3dbtbMf8I/j9s6lE=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.js></script><script type=text/javascript>docsearch({appId:'JO2SY3WDAC',apiKey:'324ddb3b679c1308e5aa8bf222e07f8b',indexName:'mxsm',inputSelector:'.td-search-input',debug:!1})</script></body></html>