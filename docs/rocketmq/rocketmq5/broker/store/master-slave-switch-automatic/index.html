<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-rocketmq/rocketmq5/broker/store/master-slave-switch-automatic">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">图说RocketMQ5.0的Broker的主备自动切换的设计与实现 | mxsm(蚂蚁背大象)</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://blog.ljbmxsm.com/docs/rocketmq/rocketmq5/broker/store/master-slave-switch-automatic"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="图说RocketMQ5.0的Broker的主备自动切换的设计与实现 | mxsm(蚂蚁背大象)"><meta data-rh="true" name="description" content="持续创作，加速成长！这是我参与「掘金日新计划 · 10 月更文挑战」的第9天，点击查看活动详情"><meta data-rh="true" property="og:description" content="持续创作，加速成长！这是我参与「掘金日新计划 · 10 月更文挑战」的第9天，点击查看活动详情"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://blog.ljbmxsm.com/docs/rocketmq/rocketmq5/broker/store/master-slave-switch-automatic"><link data-rh="true" rel="alternate" href="https://blog.ljbmxsm.com/docs/rocketmq/rocketmq5/broker/store/master-slave-switch-automatic" hreflang="en"><link data-rh="true" rel="alternate" href="https://blog.ljbmxsm.com/docs/rocketmq/rocketmq5/broker/store/master-slave-switch-automatic" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="mxsm(蚂蚁背大象) RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="mxsm(蚂蚁背大象) Atom Feed">




<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-141789564-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-226F0LR9KE"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-226F0LR9KE",{anonymize_ip:!0})</script><link rel="stylesheet" href="/assets/css/styles.48e438c8.css">
<link rel="preload" href="/assets/js/runtime~main.5868c1d9.js" as="script">
<link rel="preload" href="/assets/js/main.6c0ba5f7.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">⭐️ If you like, give it a star on <a target="_blank" rel="noopener noreferrer" href="https://github.com/mxsm/mxsm-website">GitHub</a> and follow me. This web site is updating!! </div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a><a class="navbar__item navbar__link" href="/docs/intro">Tutorial</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">RocketMQ</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/rocketmq/rocketmq5">RocketMQ 5.0</a></li><li><a class="dropdown__link" href="/docs/rocketmq/rocketmq4">RocketMQ 4.X</a></li><li><a href="https://github.com/apache/rocketmq" target="_blank" class="dropdown__link">RocketMQ GitHub<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://rocketmq.apache.org/" target="_blank" class="dropdown__link">RocketMQ official website<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Spring</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/spring/spring-framework">Spring Framework</a></li><li><a href="https://spring.io/" target="_blank" class="dropdown__link">Spring official website<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Java</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/intro">Java SE</a></li><li><a class="dropdown__link" href="/docs/intro">Java Web</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Middleware</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/intro">Netty</a></li><li><a class="dropdown__link" href="/docs/intro">Redis</a></li><li><a class="dropdown__link" href="/docs/intro">Kafka</a></li><li><a class="dropdown__link" href="/docs/intro">Etcd</a></li><li><a class="dropdown__link" href="/docs/intro">Docker</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Database</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/intro">SQL</a></li><li><a class="dropdown__link" href="/docs/intro">MySQL</a></li><li><a class="dropdown__link" href="/docs/intro">PostgreSQL</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Theory</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/intro">SQL</a></li><li><a class="dropdown__link" href="/docs/intro">MySQL</a></li><li><a class="dropdown__link" href="/docs/intro">PostgreSQL</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Others</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/others/blog-building">Blog building</a></li><li><a class="dropdown__link" href="/docs/intro">MySQL</a></li><li><a class="dropdown__link" href="/docs/intro">PostgreSQL</a></li></ul></div><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/mxsm" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/rocketmq/rocketmq5">Overview</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/rocketmq/rocketmq5/quick-start/dledger-controller">Quick Start</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rocketmq/rocketmq5/quick-start/dledger-controller">RocketMQ5.0 Controller DLedger模式</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/rocketmq/rocketmq5/nameserver/dledger-controller">NameServer</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rocketmq/rocketmq5/nameserver/dledger-controller">RocketMQ5.0 Controller DLedger模式</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/rocketmq/rocketmq5/broker/ha/broker-elect-master">Broker</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/rocketmq/rocketmq5/broker/ha/broker-elect-master">ha</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/rocketmq/rocketmq5/broker/store/AutoSwitchHAClient-source-code-analysis">store</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rocketmq/rocketmq5/broker/store/AutoSwitchHAClient-source-code-analysis">RocketMQ5.0源码分析-AutoSwitchHAClient</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rocketmq/rocketmq5/broker/store/CommitLog-important-attribute">RocketMQ5.0源码解析-CommitLog设计与几个重要的属性关系图文解析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rocketmq/rocketmq5/broker/store/AutoSwitchHAService-source-code-analysis">AutoSwitchHAService-source-code-analysis</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rocketmq/rocketmq5/broker/store/CommitLog">RocketMQ5.0-CommitLog设计与源码解析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rocketmq/rocketmq5/broker/store/dledger-controller-truncate">DLedger Controller模式下Broker文件截断</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/rocketmq/rocketmq5/broker/store/master-slave-switch-automatic">图说RocketMQ5.0的Broker的主备自动切换的设计与实现</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/rocketmq/rocketmq5/client/dledger-controller">Client</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rocketmq/rocketmq5/client/dledger-controller">RocketMQ5.0 Controller DLedger模式</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/rocketmq/rocketmq5/controller/dledger-controller">Controller</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rocketmq/rocketmq5/controller/dledger-controller">RocketMQ5.0 Controller DLedger模式</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/rocketmq/rocketmq5/proxy/dledger-controller">Proxy</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rocketmq/rocketmq5/proxy/dledger-controller">RocketMQ5.0 Controller DLedger模式</a></li></ul></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Broker</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">store</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">图说RocketMQ5.0的Broker的主备自动切换的设计与实现</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>图说RocketMQ5.0的Broker的主备自动切换的设计与实现</h1></header><p>持续创作，加速成长！这是我参与「掘金日新计划 · 10 月更文挑战」的第9天，<a href="https://juejin.cn/post/7147654075599978532" target="_blank" rel="noopener noreferrer">点击查看活动详情</a></p><p>RocketMQ5.0用新开发的 <strong>DLedger Controller</strong> 模式增强了以前的 <strong>DLedger</strong> 模式，下面就来从设计聊一下 <strong>DLedger Controller</strong> 模式是如何来实现Broker的主备自动切换。我们从以下几个方面来分析：</p><ul><li>RocketMQ5.0 整体的架构改动</li><li>DLedger Controller如何实现Broker选主(主备自动切换关键)</li><li>参与Broker选主的扩容和缩容(哪些Broker有资格参加选主)</li></ul><blockquote><p>Tips: RocketMQ 源码版本5.0.0</p></blockquote><h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-rocketmq50-主备自动切换架构">1. RocketMQ5.0 主备自动切换架构<a class="hash-link" href="#1-rocketmq50-主备自动切换架构" title="Direct link to heading">​</a></h2><p>![RocketMQ5.0 architecture]<!-- -->(E:\download\RocketMQ5.0 architecture.png)</p><p>相比之前的高可用架构，增加了一个DLedger Controller用来实现Broker主备的自主切换和高可用。RocketMQ5.0的主备模式解决RocketMQ4.x哪些问题：</p><ul><li>想要具备选举切换的能力，单组 Broker 内的副本数必须 3 副本及以上</li><li>副本 ACK 需要严格遵循 Raft 协议多数派的限制，3 副本需要 2 副本 ACK 后才能返回，5 副本需要 3 副本 ACK 后才能返回，副本越多返回ACK的时间越长。这会导致性能下降</li><li>DLedger 模式下，由于存储库使用了 OpenMessaging DLedger 存储，因此无法复用 RocketMQ 原生的存储和复制的能力（比如 transientStorePool 和零拷贝能力），且对维护造成了困难。</li></ul><p>在RocketMQ5.0版本新增了DLedger Controller模式来解决上面对的痛点。</p><p>DLedger Controller的部署模式有两种：</p><ul><li><p><strong>独立部署</strong></p><p>单独部署DLedger Controller集群</p></li><li><p><strong>内嵌NameServer部署(推荐)</strong></p><p>RocketMQ5.0在默认情况下是不会开启内嵌Controller的，通过设置配置：<strong><code>enableControllerInNamesrv=true</code></strong></p></li></ul><p>DLedger Controller主要用于Broker的选主，而数据的存储能力还是依靠RocketMQ Broker。 这里可以很好使用到MQ原生的存储能力便于维护。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-dledger-controller如何实现broker选主">2. DLedger Controller如何实现Broker选主<a class="hash-link" href="#2-dledger-controller如何实现broker选主" title="Direct link to heading">​</a></h2><p>![Broker Elect Master -2]<!-- -->(E:\download\Broker Elect Master -2.png)</p><p>Broker的选主发起主要有三种情况：</p><ul><li><strong>通过admin命令人为主动发起重新选主(运维命令)</strong></li><li><strong>RocketMQ集群刚搭建Broker启动注册Broker到DLedger Controller，DLedger Controller还没有选主，然后触发选主操作。(系统初始化)</strong></li><li><strong>RocketMQ Broker Master Inactive，会触发DLedger Controller选主Broker</strong></li></ul><p>Broker 组第一次上线时，调用该方法也没有 Master，此时会让调用的 broker 试着成为 Master，形成 ElectMasterEvent 事件日志并提交提案，副本组中第一个成功应用 ElectMasterEvent 事件日志的 Broker 会成为 Master，并形成只有自己的 SyncStateSet 列表。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="21-选主的元数据">2.1 选主的元数据<a class="hash-link" href="#21-选主的元数据" title="Direct link to heading">​</a></h3><p>选主Broker注册到 <strong>DLedger Controller</strong> 的元数据：</p><ul><li>clusterName</li><li>brokerName</li><li>address</li><li>epoch</li><li>maxOffset</li></ul><p>这些元数据主要用来选主判断。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="22-选主的流程">2.2 选主的流程<a class="hash-link" href="#22-选主的流程" title="Direct link to heading">​</a></h3><p>ELectMaster 主要是在某 Broker 副本组的 Master 下线或不可访问时，重新从 SyncStateSet 列表里面选出一个新的 Master，该事件由 Controller 自身发起。 这里主要是利用了心跳机制, Broker 定期会和 Controller 上报心跳, Controller 也会定期扫描超时的 Broker (scanNotActiveBroker)。如果某个 Broker 心跳超时, Controller 会判断是否为 Master (BrokerId = 0), 如果是 Master, 则会发起 ElectMaster, 选举新的 Broker Master。 选举 Master 的方式比较简单，我们只需要在该组 Broker 所对应的 SyncStateSet 列表中，挑选一个仍然存活的副本(心跳未超时)出来成为新的 Master 即可，选举出来生成 ElectMaster 事件，通过 DLedger 共识后应用到内存元数据，并将结果通知对应的 Broker 副本组（Broker 本身也会有有轮询机制来获取自身副本组的 Master 信息（getReplicaInfo）做进一步保证，防止通知丢失）。 此外, Controller 增加 enableElectUnCleanMaster 参数，这时如果 SyncStateSet 没有符合要求的副本，可以在当前所有的存活的副本中选，但可能大量消息丢失。</p><blockquote><p>Tips: 具体可以参照<a href="https://juejin.cn/post/7156202204104392717" target="_blank" rel="noopener noreferrer">《RocketMQ5.0主备自动切换模式Broker选主详解》</a></p></blockquote><h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-参与broker选主的扩容和缩容">3. 参与Broker选主的扩容和缩容<a class="hash-link" href="#3-参与broker选主的扩容和缩容" title="Direct link to heading">​</a></h2><p>哪些Broker能够参加选主这个是有规则的，同时这里也涉及到了我们要说道的Broker的选主范围的缩容和扩容。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="31-扩容">3.1 扩容<a class="hash-link" href="#31-扩容" title="Direct link to heading">​</a></h3><p>在DLedger Controller中保存了这样的一个集合 <strong>SyncStateSet</strong> ：</p><p>SyncStateSet表示⼀个 broker 副本组中跟上 Master 的 Slave 副本数加上 Master 的集合, 主要判断标准是 Master 和 Slave 之间的差距。当 Master 下线时 我们会从 SyncStateSet 列表中选出新的主。Master broker 会定期的检测是否需要扩容和缩容 SyncStateSet, 并通过 api 上报 SyncStateSet 列表信息，DLedger Controller 会根据上述信息维护强一致性的 Broker 副本组的 SyncStateSet 列表。</p><p>如果⼀个 Slave 副本追赶上了 Master，Master 需要及时向Controller Alter SyncStateSet 。加⼊SyncStateSet 的条件是 slaveAckOffset &gt;= ConfirmOffset（当前 SyncStateSet 中所有副本的 MaxOffset 的最⼩值）。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="32-缩容">3.2 缩容<a class="hash-link" href="#32-缩容" title="Direct link to heading">​</a></h3><p>Broker新增了配置：</p><ul><li><p>haMaxTimeSlaveNotCatchup</p><p>表示slave没有跟上Master的最大时间间隔，若在SyncStateSet中的slave超过该时间间隔会将其从SyncStateSet移除。默认为15000（15s）</p></li><li><p>HaConnection 中记录 Slave 上⼀次跟上 Master 的时间戳 lastCaughtUpTimeMs，该时间戳含义是：每次Master 向 Slave 发送数据（transferData）时记录⾃⼰当前的 MaxOffset 为 lastMasterMaxOffset 以及当前时间戳 lastTransferTimeMs。</p></li><li><p>ReadSocketService 接收到 slaveAckOffset 时若 slaveAckOffset &gt;= lastMasterMaxOffset 则将lastCaughtUpTimeMs 更新为 lastTransferTimeMs。</p></li><li><p>Master 端通过定时任务扫描每一个 HaConnection，如果 (cur_time - connection.lastCaughtUpTimeMs) &gt; haMaxTimeSlaveNotCatchUp，则该 Slave 是 Out-of-sync 的。</p></li><li><p>如果检测到 Slave out of sync ，master 会立刻向 Controller 上报SyncStateSet，从而 Shrink SyncStateSet。</p></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-消息不丢失配置">4. 消息不丢失配置<a class="hash-link" href="#4-消息不丢失配置" title="Direct link to heading">​</a></h2><p>首先就是启用DLedger Controller模式，部署DLedger Controller 不管是内嵌NameServer还是独立部署都可以。</p><p>其次就是Broker开启Broker controller模式(enableControllerMode=true,默认值为false关闭状态)，配置allAckInSyncStateSet=true，副本之间的复制为同步复。这样就能实现消息不丢失。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="5-总结">5. 总结<a class="hash-link" href="#5-总结" title="Direct link to heading">​</a></h2><p>DLedger Controller模式能够在最大限度利用RocketMQ原有的存储能力的基础上提供主备自动切换和消息不丢失的方案。</p><blockquote><p>我是蚂蚁背大象(GitHub:mxsm)，文章对你有帮助点赞关注我，文章有不正确的地方请您斧正留言评论~谢谢!</p></blockquote></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/mxsm/mxsm-website/edit/develop/docs/rocketmq/rocketmq5/broker/store/master-slave-switch-automatic.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2022-11-13T15:50:22.000Z">Nov 13, 2022</time></b> by <b>mxsm</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/rocketmq/rocketmq5/broker/store/dledger-controller-truncate"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">DLedger Controller模式下Broker文件截断</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/rocketmq/rocketmq5/client/dledger-controller"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">RocketMQ5.0 Controller DLedger模式</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-rocketmq50-主备自动切换架构" class="table-of-contents__link toc-highlight">1. RocketMQ5.0 主备自动切换架构</a></li><li><a href="#2-dledger-controller如何实现broker选主" class="table-of-contents__link toc-highlight">2. DLedger Controller如何实现Broker选主</a><ul><li><a href="#21-选主的元数据" class="table-of-contents__link toc-highlight">2.1 选主的元数据</a></li><li><a href="#22-选主的流程" class="table-of-contents__link toc-highlight">2.2 选主的流程</a></li></ul></li><li><a href="#3-参与broker选主的扩容和缩容" class="table-of-contents__link toc-highlight">3. 参与Broker选主的扩容和缩容</a><ul><li><a href="#31-扩容" class="table-of-contents__link toc-highlight">3.1 扩容</a></li><li><a href="#32-缩容" class="table-of-contents__link toc-highlight">3.2 缩容</a></li></ul></li><li><a href="#4-消息不丢失配置" class="table-of-contents__link toc-highlight">4. 消息不丢失配置</a></li><li><a href="#5-总结" class="table-of-contents__link toc-highlight">5. 总结</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/mxsm" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 mxsm(蚂蚁背大象), Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.5868c1d9.js"></script>
<script src="/assets/js/main.6c0ba5f7.js"></script>
</body>
</html>