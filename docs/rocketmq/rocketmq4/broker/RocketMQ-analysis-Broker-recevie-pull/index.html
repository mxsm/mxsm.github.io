<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-rocketmq/rocketmq4/broker/RocketMQ-analysis-Broker-recevie-pull" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">RocketMQ源码解析-Broker接收拉取消息 | mxsm(蚂蚁背大象)</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://blog.ljbmxsm.com/docs/rocketmq/rocketmq4/broker/RocketMQ-analysis-Broker-recevie-pull"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="RocketMQ源码解析-Broker接收拉取消息 | mxsm(蚂蚁背大象)"><meta data-rh="true" name="description" content="以下源码基于Rocket MQ 4.7.0"><meta data-rh="true" property="og:description" content="以下源码基于Rocket MQ 4.7.0"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://blog.ljbmxsm.com/docs/rocketmq/rocketmq4/broker/RocketMQ-analysis-Broker-recevie-pull"><link data-rh="true" rel="alternate" href="https://blog.ljbmxsm.com/docs/rocketmq/rocketmq4/broker/RocketMQ-analysis-Broker-recevie-pull" hreflang="en"><link data-rh="true" rel="alternate" href="https://blog.ljbmxsm.com/docs/rocketmq/rocketmq4/broker/RocketMQ-analysis-Broker-recevie-pull" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="mxsm(蚂蚁背大象) RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="mxsm(蚂蚁背大象) Atom Feed">




<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-141789564-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-226F0LR9KE"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-226F0LR9KE",{anonymize_ip:!0})</script><link rel="stylesheet" href="/assets/css/styles.b5c903b7.css">
<script src="/assets/js/runtime~main.9dbea368.js" defer="defer"></script>
<script src="/assets/js/main.b1bdd402.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const a=new URLSearchParams(window.location.search).entries();for(var[t,e]of a)if(t.startsWith("docusaurus-data-")){var n=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(n,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">⭐️ If you like, give it a star on <a target="_blank" rel="noopener noreferrer" href="https://github.com/mxsm/mxsm-website">GitHub</a> and follow me. This web site is updating!! </div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><a class="navbar__item navbar__link" href="/docs/intro">Tutorial</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">RocketMQ</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/rocketmq/rocketmq-rust">RocketMQ Rust</a></li><li><a class="dropdown__link" href="/docs/rocketmq/rocketmq5">RocketMQ 5.0</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/rocketmq/rocketmq4">RocketMQ 4.X</a></li><li><a href="https://github.com/apache/rocketmq" target="_blank" class="dropdown__link">RocketMQ GitHub<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://rocketmq.apache.org/" target="_blank" class="dropdown__link">RocketMQ official website<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><a class="navbar__item navbar__link" href="/docs/event-mesh/">EventMesh</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Spring</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/spring/spring-framework">Spring Framework</a></li><li><a class="dropdown__link" href="/docs/spring/spring-boot">Spring Boot</a></li><li><a class="dropdown__link" href="/docs/spring/spring-cloud">Spring Cloud</a></li><li><a href="https://spring.io/" target="_blank" class="dropdown__link">Spring official website<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Java</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/java/openjdk">OpenJDK</a></li><li><a class="dropdown__link" href="/docs/java/java-se">Java SE</a></li><li><a class="dropdown__link" href="/docs/java/java-web">Java Web</a></li><li><a class="dropdown__link" href="/docs/java/java-tools">Java Tools</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Rust</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/rust/official-doc">Rust官方文档(翻译)</a></li><li><a class="dropdown__link" href="/docs/rust/rust-learn/introduction">Rust学习</a></li><li><a class="dropdown__link" href="/docs/rust/tokio">Tokio学习系列</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">C++</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/java/java-se">Java SE</a></li><li><a class="dropdown__link" href="/docs/java/java-web">Java Web</a></li><li><a class="dropdown__link" href="/docs/java/java-tools">Java Tools</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Cloud Native</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/cloud-native/open-telemetry">OpenTelemetry</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Middleware</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/netty/">Netty</a></li><li><a class="dropdown__link" href="/docs/redis">Redis</a></li><li><a class="dropdown__link" href="/docs/intro">Kafka-改造中</a></li><li><a class="dropdown__link" href="/docs/intro">Etcd-改造中</a></li><li><a class="dropdown__link" href="/docs/docker">Docker</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Database</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/intro">SQL-改造中</a></li><li><a class="dropdown__link" href="/docs/intro">MySQL-改造中</a></li><li><a class="dropdown__link" href="/docs/intro">PostgreSQL-改造中</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Theory</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/intro">SQL</a></li><li><a class="dropdown__link" href="/docs/intro">MySQL</a></li><li><a class="dropdown__link" href="/docs/intro">PostgreSQL</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Others</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/others/blog-building">Blog building</a></li><li><a class="dropdown__link" href="/docs/others/tools">Develop Tools</a></li><li><a class="dropdown__link" href="/docs/intro">PostgreSQL</a></li></ul></div><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/mxsm" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/rocketmq/rocketmq4">Overview</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/rocketmq/rocketmq4/quick-start/rocketmq-architecture-design">Quick Start</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rocketmq/rocketmq4/quick-start/rocketmq-architecture-design">RocketMQ-架构设计</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rocketmq/rocketmq4/quick-start/rocketmq-base-concept">RocketMQ-基本概念</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rocketmq/rocketmq4/quick-start/rocketmq-character">RocketMQ-特性</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rocketmq/rocketmq4/quick-start/rocketmq-docker">RocketMQ Docker部署</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rocketmq/rocketmq4/quick-start/rocketmq-module-design">RocketMQ-模块设计</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rocketmq/rocketmq4/quick-start/rocketmq-slf4j-logging">当SLF4J遇上RocketMQ</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/rocketmq/rocketmq4/nameserver/">NameServer</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rocketmq/rocketmq4/nameserver/">NameServer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rocketmq/rocketmq4/nameserver/RocketMQ-analysis-NameServer-start">RocketMQ源码解析-NameServer启动</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rocketmq/rocketmq4/nameserver/RocketMQ-analysis-broker-manage">RocketMQ源码解析-NameServer对Broker的管理</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/rocketmq/rocketmq4/broker/RocketMQ-analysis-Broker-CommitLog">Broker</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rocketmq/rocketmq4/broker/RocketMQ-analysis-Broker-CommitLog">RocketMQ源码解析-Broker消息存储CommitLog</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rocketmq/rocketmq4/broker/RocketMQ-analysis-Broker-ConsumeQueue">RocketMQ源码解析-Broker消息存储ConsumeQueue</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rocketmq/rocketmq4/broker/RocketMQ-analysis-Broker-NameServer-interaction">RocketMQ源码解析-Broker与NameServer交互</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rocketmq/rocketmq4/broker/RocketMQ-analysis-Broker-failure-recovery">RocketMQ源码解析-Broker故障恢复</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rocketmq/rocketmq4/broker/RocketMQ-analysis-Broker-message-store">RocketMQ源码解析-Broker消息存储设计与实现</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/rocketmq/rocketmq4/broker/RocketMQ-analysis-Broker-recevie-pull">RocketMQ源码解析-Broker接收拉取消息</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rocketmq/rocketmq4/broker/RocketMQ-analysis-Broker-start">RocketMQ源码解析-Broker启动</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rocketmq/rocketmq4/broker/RocketMQ-analysis-Broker-tag-filter">RocketMQ源码解析-Broker 消息Tag过滤</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rocketmq/rocketmq4/broker/RocketMQ-analysis-broker-configfile">RocketMQ源码解析-Broker存储配置文件说明</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/rocketmq/rocketmq4/consumer/RocketMQ-analysis-ack">consumer</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rocketmq/rocketmq4/consumer/RocketMQ-analysis-ack">RocketMQ源码解析-RocketMQ消息ACK机制及消费进度管理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rocketmq/rocketmq4/consumer/RocketMQ-analysis-consumer-concurrently">RocketMQ源码解析-并发消费消息源码解析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rocketmq/rocketmq4/consumer/RocketMQ-analysis-consumer-messagemodel">RocketMQ源码解析-消费模式消费进度加载源码解析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rocketmq/rocketmq4/consumer/RocketMQ-analysis-consumer-repeat-consume">RocketMQ源码解析-消费者重复消费</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rocketmq/rocketmq4/consumer/RocketMQ-analysis-consumer-scheduledtask">RocketMQ源码解析-消费者定时任务解析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rocketmq/rocketmq4/consumer/RocketMQ-analysis-consumer-strategy">RocketMQ源码解析-消费者消费策略源码解析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rocketmq/rocketmq4/consumer/RocketMQ-analysis-consumer">RocketMQ源码解析-消费者启动源码解析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rocketmq/rocketmq4/consumer/RocketMQ-analysis-ordermessage-consume">RocketMQ源码解析-RocketMQ顺序消息的投递与消费</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/rocketmq/rocketmq4/producer/">producer</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rocketmq/rocketmq4/producer/">Producer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rocketmq/rocketmq4/producer/RocketMQ-analysis-producer-messagesend">RocketMQ源码解析-producer发送消息的流程</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rocketmq/rocketmq4/producer/RocketMQ-analysis-producer-msgsend-strategy">RocketMQ源码解析-生产者投递消息策略</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rocketmq/rocketmq4/producer/RocketMQ-analysis-topic-create-strategy">RocketMQ源码解析-topic创建机制</a></li></ul></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Broker</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">RocketMQ源码解析-Broker接收拉取消息</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>RocketMQ源码解析-Broker接收拉取消息</h1></header><blockquote>
<p>以下源码基于Rocket MQ 4.7.0</p>
</blockquote>
<p>引言：Broker对于不同消息有不同的NettyRequestProcessor，对于DefaultMQPushConsumer的pull请求对应的Processor为PullMessageProcessor。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="pullmessageprocessor">PullMessageProcessor<a href="#pullmessageprocessor" class="hash-link" aria-label="Direct link to PullMessageProcessor" title="Direct link to PullMessageProcessor">​</a></h3>
<p>通过上面的分析可以知道，处理DefaultMQPushConsumer的pull请求主要是通过 <strong><code>PullMessageProcessor.processRequest</code></strong> 方法来实现的：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param channel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param request 请求的command</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param brokerAllowSuspend 是否允许挂起</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @throws RemotingCommandException</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private RemotingCommand processRequest(final Channel channel, RemotingCommand request, boolean brokerAllowSuspend)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throws RemotingCommandException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RemotingCommand response = RemotingCommand.createResponseCommand(PullMessageResponseHeader.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final PullMessageResponseHeader responseHeader = (PullMessageResponseHeader) response.readCustomHeader();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final PullMessageRequestHeader requestHeader =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            (PullMessageRequestHeader) request.decodeCommandCustomHeader(PullMessageRequestHeader.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        response.setOpaque(request.getOpaque());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log.debug(&quot;receive PullMessage request command, {}&quot;, request);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //判断Broker是否可读</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!PermName.isReadable(this.brokerController.getBrokerConfig().getBrokerPermission())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            response.setCode(ResponseCode.NO_PERMISSION);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            response.setRemark(String.format(&quot;the broker[%s] pulling message is forbidden&quot;, this.brokerController.getBrokerConfig().getBrokerIP1()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return response;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 判断consumerGroup是否存在-如果不存在判断是否允许自动创建，可以自动创建就直接创建消费者组(权限控制)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SubscriptionGroupConfig subscriptionGroupConfig =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.brokerController.getSubscriptionGroupManager().findSubscriptionGroupConfig(requestHeader.getConsumerGroup());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (null == subscriptionGroupConfig) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            response.setCode(ResponseCode.SUBSCRIPTION_GROUP_NOT_EXIST);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            response.setRemark(String.format(&quot;subscription group [%s] does not exist, %s&quot;, requestHeader.getConsumerGroup(), FAQUrl.suggestTodo(FAQUrl.SUBSCRIPTION_GROUP_NOT_EXIST)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return response;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 判断consumerGroup的消费状态是否Enable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!subscriptionGroupConfig.isConsumeEnable()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            response.setCode(ResponseCode.NO_PERMISSION);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            response.setRemark(&quot;subscription group no permission, &quot; + requestHeader.getConsumerGroup());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return response;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final boolean hasSuspendFlag = PullSysFlag.hasSuspendFlag(requestHeader.getSysFlag());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final boolean hasCommitOffsetFlag = PullSysFlag.hasCommitOffsetFlag(requestHeader.getSysFlag());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final boolean hasSubscriptionFlag = PullSysFlag.hasSubscriptionFlag(requestHeader.getSysFlag());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //获取挂起超时时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final long suspendTimeoutMillisLong = hasSuspendFlag ? requestHeader.getSuspendTimeoutMillis() : 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //判断主题配置是否为空</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TopicConfig topicConfig = this.brokerController.getTopicConfigManager().selectTopicConfig(requestHeader.getTopic());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (null == topicConfig) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.error(&quot;the topic {} not exist, consumer: {}&quot;, requestHeader.getTopic(), RemotingHelper.parseChannelRemoteAddr(channel));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            response.setCode(ResponseCode.TOPIC_NOT_EXIST);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            response.setRemark(String.format(&quot;topic[%s] not exist, apply first please! %s&quot;, requestHeader.getTopic(), FAQUrl.suggestTodo(FAQUrl.APPLY_TOPIC_URL)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return response;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //判断主题是否可读</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!PermName.isReadable(topicConfig.getPerm())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            response.setCode(ResponseCode.NO_PERMISSION);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            response.setRemark(&quot;the topic[&quot; + requestHeader.getTopic() + &quot;] pulling message is forbidden&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return response;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //判断请求消息队列ID是否合法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (requestHeader.getQueueId() &lt; 0 || requestHeader.getQueueId() &gt;= topicConfig.getReadQueueNums()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String errorInfo = String.format(&quot;queueId[%d] is illegal, topic:[%s] topicConfig.readQueueNums:[%d] consumer:[%s]&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                requestHeader.getQueueId(), requestHeader.getTopic(), topicConfig.getReadQueueNums(), channel.remoteAddress());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.warn(errorInfo);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            response.setCode(ResponseCode.SYSTEM_ERROR);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            response.setRemark(errorInfo);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return response;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SubscriptionData subscriptionData = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ConsumerFilterData consumerFilterData = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 有设置subscribe flag,表示第一次pull或者需要更新filter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (hasSubscriptionFlag) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 获得订阅信息，用于过滤消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                subscriptionData = FilterAPI.build(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    requestHeader.getTopic(), requestHeader.getSubscription(), requestHeader.getExpressionType()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 是否使用了表达式过滤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (!ExpressionType.isTagType(subscriptionData.getExpressionType())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    consumerFilterData = ConsumerFilterManager.build(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        requestHeader.getTopic(), requestHeader.getConsumerGroup(), requestHeader.getSubscription(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        requestHeader.getExpressionType(), requestHeader.getSubVersion()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    assert consumerFilterData != null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                log.warn(&quot;Parse the consumer&#x27;s subscription[{}] failed, group: {}&quot;, requestHeader.getSubscription(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    requestHeader.getConsumerGroup());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                response.setCode(ResponseCode.SUBSCRIPTION_PARSE_FAILED);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                response.setRemark(&quot;parse the consumer&#x27;s subscription failed&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return response;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 没有设置subscribe flag，表示之前已经订阅过了,对比订阅条件是否一致</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 对于同一个ConsumerGroup下的多个consumer客户端，Broker要求订阅参数设置必须要是一致的，要不然会造成数据混乱</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ConsumerGroupInfo consumerGroupInfo =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.brokerController.getConsumerManager().getConsumerGroupInfo(requestHeader.getConsumerGroup());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (null == consumerGroupInfo) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                log.warn(&quot;the consumer&#x27;s group info not exist, group: {}&quot;, requestHeader.getConsumerGroup());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                response.setCode(ResponseCode.SUBSCRIPTION_NOT_EXIST);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                response.setRemark(&quot;the consumer&#x27;s group info not exist&quot; + FAQUrl.suggestTodo(FAQUrl.SAME_GROUP_DIFFERENT_TOPIC));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return response;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!subscriptionGroupConfig.isConsumeBroadcastEnable()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &amp;&amp; consumerGroupInfo.getMessageModel() == MessageModel.BROADCASTING) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                response.setCode(ResponseCode.NO_PERMISSION);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                response.setRemark(&quot;the consumer group[&quot; + requestHeader.getConsumerGroup() + &quot;] can not consume by broadcast way&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return response;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            subscriptionData = consumerGroupInfo.findSubscriptionData(requestHeader.getTopic());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (null == subscriptionData) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                log.warn(&quot;the consumer&#x27;s subscription not exist, group: {}, topic:{}&quot;, requestHeader.getConsumerGroup(), requestHeader.getTopic());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                response.setCode(ResponseCode.SUBSCRIPTION_NOT_EXIST);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                response.setRemark(&quot;the consumer&#x27;s subscription not exist&quot; + FAQUrl.suggestTodo(FAQUrl.SAME_GROUP_DIFFERENT_TOPIC));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return response;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (subscriptionData.getSubVersion() &lt; requestHeader.getSubVersion()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                log.warn(&quot;The broker&#x27;s subscription is not latest, group: {} {}&quot;, requestHeader.getConsumerGroup(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    subscriptionData.getSubString());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                response.setCode(ResponseCode.SUBSCRIPTION_NOT_LATEST);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                response.setRemark(&quot;the consumer&#x27;s subscription not latest&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return response;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!ExpressionType.isTagType(subscriptionData.getExpressionType())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                consumerFilterData = this.brokerController.getConsumerFilterManager().get(requestHeader.getTopic(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    requestHeader.getConsumerGroup());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (consumerFilterData == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    response.setCode(ResponseCode.FILTER_DATA_NOT_EXIST);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    response.setRemark(&quot;The broker&#x27;s consumer filter data is not exist!Your expression may be wrong!&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return response;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (consumerFilterData.getClientVersion() &lt; requestHeader.getSubVersion()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    log.warn(&quot;The broker&#x27;s consumer filter data is not latest, group: {}, topic: {}, serverV: {}, clientV: {}&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        requestHeader.getConsumerGroup(), requestHeader.getTopic(), consumerFilterData.getClientVersion(), requestHeader.getSubVersion());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    response.setCode(ResponseCode.FILTER_DATA_NOT_LATEST);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    response.setRemark(&quot;the consumer&#x27;s consumer filter data not latest&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return response;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!ExpressionType.isTagType(subscriptionData.getExpressionType())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &amp;&amp; !this.brokerController.getBrokerConfig().isEnablePropertyFilter()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            response.setCode(ResponseCode.SYSTEM_ERROR);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            response.setRemark(&quot;The broker does not support consumer to filter message by &quot; + subscriptionData.getExpressionType());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return response;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //创建消息过滤器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MessageFilter messageFilter;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (this.brokerController.getBrokerConfig().isFilterSupportRetry()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            messageFilter = new ExpressionForRetryMessageFilter(subscriptionData, consumerFilterData,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.brokerController.getConsumerFilterManager());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            messageFilter = new ExpressionMessageFilter(subscriptionData, consumerFilterData,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.brokerController.getConsumerFilterManager());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //读取消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final GetMessageResult getMessageResult =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.brokerController.getMessageStore().getMessage(requestHeader.getConsumerGroup(), requestHeader.getTopic(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                requestHeader.getQueueId(), requestHeader.getQueueOffset(), requestHeader.getMaxMsgNums(), messageFilter);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (getMessageResult != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            response.setRemark(getMessageResult.getStatus().name());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            responseHeader.setNextBeginOffset(getMessageResult.getNextBeginOffset());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            responseHeader.setMinOffset(getMessageResult.getMinOffset());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            responseHeader.setMaxOffset(getMessageResult.getMaxOffset());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //判断是否建议从slave读取数据---默认为false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (getMessageResult.isSuggestPullingFromSlave()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                responseHeader.setSuggestWhichBrokerId(subscriptionGroupConfig.getWhichBrokerWhenConsumeSlowly());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                responseHeader.setSuggestWhichBrokerId(MixAll.MASTER_ID);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            switch (this.brokerController.getMessageStoreConfig().getBrokerRole()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                case ASYNC_MASTER:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                case SYNC_MASTER:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                case SLAVE:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 如果当前broker是slave，并且不支持read，则提示客户端从master读</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (!this.brokerController.getBrokerConfig().isSlaveReadEnable()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        responseHeader.setSuggestWhichBrokerId(MixAll.MASTER_ID);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (this.brokerController.getBrokerConfig().isSlaveReadEnable()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 消费太慢重定向到另外一台机器消费</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (getMessageResult.isSuggestPullingFromSlave()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    responseHeader.setSuggestWhichBrokerId(subscriptionGroupConfig.getWhichBrokerWhenConsumeSlowly());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // consume ok</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    responseHeader.setSuggestWhichBrokerId(subscriptionGroupConfig.getBrokerId());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                responseHeader.setSuggestWhichBrokerId(MixAll.MASTER_ID);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //将读取的消息状态转换为Response的状态code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            switch (getMessageResult.getStatus()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                case FOUND:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    response.setCode(ResponseCode.SUCCESS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                case MESSAGE_WAS_REMOVING:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                case NO_MATCHED_LOGIC_QUEUE:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                case NO_MESSAGE_IN_QUEUE:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (0 != requestHeader.getQueueOffset()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        response.setCode(ResponseCode.PULL_OFFSET_MOVED);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // XXX: warn and notify me</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        log.info(&quot;the broker store no queue data, fix the request offset {} to {}, Topic: {} QueueId: {} Consumer Group: {}&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            requestHeader.getQueueOffset(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            getMessageResult.getNextBeginOffset(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            requestHeader.getTopic(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            requestHeader.getQueueId(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            requestHeader.getConsumerGroup()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        response.setCode(ResponseCode.PULL_NOT_FOUND);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                case NO_MATCHED_MESSAGE:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                case OFFSET_FOUND_NULL:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    response.setCode(ResponseCode.PULL_NOT_FOUND);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                case OFFSET_OVERFLOW_BADLY:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    response.setCode(ResponseCode.PULL_OFFSET_MOVED);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // XXX: warn and notify me</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    log.info(&quot;the request offset: {} over flow badly, broker max offset: {}, consumer: {}&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        requestHeader.getQueueOffset(), getMessageResult.getMaxOffset(), channel.remoteAddress());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                case OFFSET_OVERFLOW_ONE:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    response.setCode(ResponseCode.PULL_NOT_FOUND);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                case OFFSET_TOO_SMALL:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    response.setCode(ResponseCode.PULL_OFFSET_MOVED);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    log.info(&quot;the request offset too small. group={}, topic={}, requestOffset={}, brokerMinOffset={}, clientIp={}&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        requestHeader.getConsumerGroup(), requestHeader.getTopic(), requestHeader.getQueueOffset(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        getMessageResult.getMinOffset(), channel.remoteAddress());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                default:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    assert false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (this.hasConsumeMessageHook()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ConsumeMessageContext context = new ConsumeMessageContext();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                context.setConsumerGroup(requestHeader.getConsumerGroup());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                context.setTopic(requestHeader.getTopic());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                context.setQueueId(requestHeader.getQueueId());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String owner = request.getExtFields().get(BrokerStatsManager.COMMERCIAL_OWNER);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                switch (response.getCode()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    case ResponseCode.SUCCESS:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        int commercialBaseCount = brokerController.getBrokerConfig().getCommercialBaseCount();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        int incValue = getMessageResult.getMsgCount4Commercial() * commercialBaseCount;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        context.setCommercialRcvStats(BrokerStatsManager.StatsType.RCV_SUCCESS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        context.setCommercialRcvTimes(incValue);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        context.setCommercialRcvSize(getMessageResult.getBufferTotalSize());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        context.setCommercialOwner(owner);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    case ResponseCode.PULL_NOT_FOUND:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (!brokerAllowSuspend) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            context.setCommercialRcvStats(BrokerStatsManager.StatsType.RCV_EPOLLS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            context.setCommercialRcvTimes(1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            context.setCommercialOwner(owner);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    case ResponseCode.PULL_RETRY_IMMEDIATELY:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    case ResponseCode.PULL_OFFSET_MOVED:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        context.setCommercialRcvStats(BrokerStatsManager.StatsType.RCV_EPOLLS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        context.setCommercialRcvTimes(1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        context.setCommercialOwner(owner);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    default:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        assert false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.executeConsumeMessageHookBefore(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //进一步处理返回的结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            switch (response.getCode()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                case ResponseCode.SUCCESS:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    //更新topic获取的消息数量信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    this.brokerController.getBrokerStatsManager().incGroupGetNums(requestHeader.getConsumerGroup(), requestHeader.getTopic(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        getMessageResult.getMessageCount());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    //更新统计的消息大小</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    this.brokerController.getBrokerStatsManager().incGroupGetSize(requestHeader.getConsumerGroup(), requestHeader.getTopic(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        getMessageResult.getBufferTotalSize());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    this.brokerController.getBrokerStatsManager().incBrokerGetNums(getMessageResult.getMessageCount());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (this.brokerController.getBrokerConfig().isTransferMsgByHeap()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        final long beginTimeMills = this.brokerController.getMessageStore().now();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        final byte[] r = this.readGetMessageResult(getMessageResult, requestHeader.getConsumerGroup(), requestHeader.getTopic(), requestHeader.getQueueId());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        this.brokerController.getBrokerStatsManager().incGroupGetLatency(requestHeader.getConsumerGroup(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            requestHeader.getTopic(), requestHeader.getQueueId(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            (int) (this.brokerController.getMessageStore().now() - beginTimeMills));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        response.setBody(r);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            FileRegion fileRegion =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                new ManyMessageTransfer(response.encodeHeader(getMessageResult.getBufferTotalSize()), getMessageResult);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            channel.writeAndFlush(fileRegion).addListener(new ChannelFutureListener() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                public void operationComplete(ChannelFuture future) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    getMessageResult.release();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    if (!future.isSuccess()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        log.error(&quot;transfer many message by pagecache failed, {}&quot;, channel.remoteAddress(), future.cause());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        } catch (Throwable e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            log.error(&quot;transfer many message by pagecache exception&quot;, e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            getMessageResult.release();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        response = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //没有读取到消息，则hold住请求，有新消息时唤醒</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //等待超时后还是没读到brokerAllowSuspend=false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                case ResponseCode.PULL_NOT_FOUND:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    //brokerAllowSuspend=ture 方法传入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (brokerAllowSuspend &amp;&amp; hasSuspendFlag) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        long pollingTimeMills = suspendTimeoutMillisLong;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (!this.brokerController.getBrokerConfig().isLongPollingEnable()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            pollingTimeMills = this.brokerController.getBrokerConfig().getShortPollingTimeMills();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        String topic = requestHeader.getTopic();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        long offset = requestHeader.getQueueOffset();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        int queueId = requestHeader.getQueueId();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        PullRequest pullRequest = new PullRequest(request, channel, pollingTimeMills,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            this.brokerController.getMessageStore().now(), offset, subscriptionData, messageFilter);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        this.brokerController.getPullRequestHoldService().suspendPullRequest(topic, queueId, pullRequest);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        response = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                case ResponseCode.PULL_RETRY_IMMEDIATELY:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 消费开始的offset不正确</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                case ResponseCode.PULL_OFFSET_MOVED:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (this.brokerController.getMessageStoreConfig().getBrokerRole() != BrokerRole.SLAVE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        || this.brokerController.getMessageStoreConfig().isOffsetCheckInSlave()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        MessageQueue mq = new MessageQueue();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        mq.setTopic(requestHeader.getTopic());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        mq.setQueueId(requestHeader.getQueueId());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        mq.setBrokerName(this.brokerController.getBrokerConfig().getBrokerName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        OffsetMovedEvent event = new OffsetMovedEvent();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        event.setConsumerGroup(requestHeader.getConsumerGroup());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        event.setMessageQueue(mq);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        event.setOffsetRequest(requestHeader.getQueueOffset());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        event.setOffsetNew(getMessageResult.getNextBeginOffset());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        this.generateOffsetMovedEvent(event);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        log.warn(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            &quot;PULL_OFFSET_MOVED:correction offset. topic={}, groupId={}, requestOffset={}, newOffset={}, suggestBrokerId={}&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            requestHeader.getTopic(), requestHeader.getConsumerGroup(), event.getOffsetRequest(), event.getOffsetNew(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            responseHeader.getSuggestWhichBrokerId());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        responseHeader.setSuggestWhichBrokerId(subscriptionGroupConfig.getBrokerId());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        log.warn(&quot;PULL_OFFSET_MOVED:none correction. topic={}, groupId={}, requestOffset={}, suggestBrokerId={}&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            requestHeader.getTopic(), requestHeader.getConsumerGroup(), requestHeader.getQueueOffset(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            responseHeader.getSuggestWhichBrokerId());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                default:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    assert false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            response.setCode(ResponseCode.SYSTEM_ERROR);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            response.setRemark(&quot;store getMessage return null&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        boolean storeOffsetEnable = brokerAllowSuspend;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        storeOffsetEnable = storeOffsetEnable &amp;&amp; hasCommitOffsetFlag;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        storeOffsetEnable = storeOffsetEnable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &amp;&amp; this.brokerController.getMessageStoreConfig().getBrokerRole() != BrokerRole.SLAVE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (storeOffsetEnable) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //持久化储存offerSet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.brokerController.getConsumerOffsetManager().commitOffset(RemotingHelper.parseChannelRemoteAddr(channel),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                requestHeader.getConsumerGroup(), requestHeader.getTopic(), requestHeader.getQueueId(), requestHeader.getCommitOffset());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return response;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>从上面的分析可以知道：根据 <strong><code>Topic、queueId、offfset</code></strong> 以及过滤器从 <strong><code>MessageStore</code></strong> 获取消息。如果成功获取到消息根据配置有两种返回的方式：</p>
<ol>
<li><code>ByteBuffer</code>中将数据读取到response中（经过堆）</li>
<li>netty直接读取<code>ByteBuffer</code>，将消息写给客户端</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="defaultmessagestoregetmessage">DefaultMessageStore.getMessage<a href="#defaultmessagestoregetmessage" class="hash-link" aria-label="Direct link to DefaultMessageStore.getMessage" title="Direct link to DefaultMessageStore.getMessage">​</a></h3>
<p>下面来看一下这个方法：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public GetMessageResult getMessage(final String group, final String topic, final int queueId, final long offset,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final int maxMsgNums,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final MessageFilter messageFilter) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (this.shutdown) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.warn(&quot;message store has shutdown, so getMessage is forbidden&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!this.runningFlags.isReadable()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.warn(&quot;message store is not readable, so getMessage is forbidden &quot; + this.runningFlags.getFlagBits());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        long beginTime = this.getSystemClock().now();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        GetMessageStatus status = GetMessageStatus.NO_MESSAGE_IN_QUEUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        long nextBeginOffset = offset;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        long minOffset = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        long maxOffset = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        GetMessageResult getResult = new GetMessageResult();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final long maxOffsetPy = this.commitLog.getMaxOffset();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //找到对应的消费队列</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ConsumeQueue consumeQueue = findConsumeQueue(topic, queueId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (consumeQueue != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            minOffset = consumeQueue.getMinOffsetInQueue();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            maxOffset = consumeQueue.getMaxOffsetInQueue();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (maxOffset == 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                status = GetMessageStatus.NO_MESSAGE_IN_QUEUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                nextBeginOffset = nextOffsetCorrection(offset, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else if (offset &lt; minOffset) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                status = GetMessageStatus.OFFSET_TOO_SMALL;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                nextBeginOffset = nextOffsetCorrection(offset, minOffset);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else if (offset == maxOffset) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                status = GetMessageStatus.OFFSET_OVERFLOW_ONE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                nextBeginOffset = nextOffsetCorrection(offset, offset);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else if (offset &gt; maxOffset) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                status = GetMessageStatus.OFFSET_OVERFLOW_BADLY;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (0 == minOffset) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    nextBeginOffset = nextOffsetCorrection(offset, minOffset);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    nextBeginOffset = nextOffsetCorrection(offset, maxOffset);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                SelectMappedBufferResult bufferConsumeQueue = consumeQueue.getIndexBuffer(offset);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (bufferConsumeQueue != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        status = GetMessageStatus.NO_MATCHED_MESSAGE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        long nextPhyFileStartOffset = Long.MIN_VALUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        long maxPhyOffsetPulling = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        int i = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        final int maxFilterMessageCount = Math.max(16000, maxMsgNums * ConsumeQueue.CQ_STORE_UNIT_SIZE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        final boolean diskFallRecorded = this.messageStoreConfig.isDiskFallRecorded();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ConsumeQueueExt.CqExtUnit cqExtUnit = new ConsumeQueueExt.CqExtUnit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        for (; i &lt; bufferConsumeQueue.getSize() &amp;&amp; i &lt; maxFilterMessageCount; i += ConsumeQueue.CQ_STORE_UNIT_SIZE) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            long offsetPy = bufferConsumeQueue.getByteBuffer().getLong();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            int sizePy = bufferConsumeQueue.getByteBuffer().getInt();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            long tagsCode = bufferConsumeQueue.getByteBuffer().getLong();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            maxPhyOffsetPulling = offsetPy;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            if (nextPhyFileStartOffset != Long.MIN_VALUE) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                if (offsetPy &lt; nextPhyFileStartOffset)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    continue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            boolean isInDisk = checkInDiskByCommitOffset(offsetPy, maxOffsetPy);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            if (this.isTheBatchFull(sizePy, maxMsgNums, getResult.getBufferTotalSize(), getResult.getMessageCount(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                isInDisk)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            boolean extRet = false, isTagsCodeLegal = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            if (consumeQueue.isExtAddr(tagsCode)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                extRet = consumeQueue.getExt(tagsCode, cqExtUnit);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                if (extRet) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    tagsCode = cqExtUnit.getTagsCode();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    // can&#x27;t find ext content.Client will filter messages by tag also.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    log.error(&quot;[BUG] can&#x27;t find consume queue extend file content!addr={}, offsetPy={}, sizePy={}, topic={}, group={}&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        tagsCode, offsetPy, sizePy, topic, group);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    isTagsCodeLegal = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            if (messageFilter != null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                &amp;&amp; !messageFilter.isMatchedByConsumeQueue(isTagsCodeLegal ? tagsCode : null, extRet ? cqExtUnit : null)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                if (getResult.getBufferTotalSize() == 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    status = GetMessageStatus.NO_MATCHED_MESSAGE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                continue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            SelectMappedBufferResult selectResult = this.commitLog.getMessage(offsetPy, sizePy);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            if (null == selectResult) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                if (getResult.getBufferTotalSize() == 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    status = GetMessageStatus.MESSAGE_WAS_REMOVING;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                nextPhyFileStartOffset = this.commitLog.rollNextFile(offsetPy);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                continue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            if (messageFilter != null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                &amp;&amp; !messageFilter.isMatchedByCommitLog(selectResult.getByteBuffer().slice(), null)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                if (getResult.getBufferTotalSize() == 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    status = GetMessageStatus.NO_MATCHED_MESSAGE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                // release...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                selectResult.release();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                continue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            this.storeStatsService.getGetMessageTransferedMsgCount().incrementAndGet();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            getResult.addMessage(selectResult);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            status = GetMessageStatus.FOUND;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            nextPhyFileStartOffset = Long.MIN_VALUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (diskFallRecorded) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            long fallBehind = maxOffsetPy - maxPhyOffsetPulling;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            brokerStatsManager.recordDiskFallBehindSize(group, topic, queueId, fallBehind);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        nextBeginOffset = offset + (i / ConsumeQueue.CQ_STORE_UNIT_SIZE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        long diff = maxOffsetPy - maxPhyOffsetPulling;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        long memory = (long) (StoreUtil.TOTAL_PHYSICAL_MEMORY_SIZE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            * (this.messageStoreConfig.getAccessMessageInMemoryMaxRatio() / 100.0));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        getResult.setSuggestPullingFromSlave(diff &gt; memory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        bufferConsumeQueue.release();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    status = GetMessageStatus.OFFSET_FOUND_NULL;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    nextBeginOffset = nextOffsetCorrection(offset, consumeQueue.rollNextFile(offset));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    log.warn(&quot;consumer request topic: &quot; + topic + &quot;offset: &quot; + offset + &quot; minOffset: &quot; + minOffset + &quot; maxOffset: &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        + maxOffset + &quot;, but access logic queue failed.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            status = GetMessageStatus.NO_MATCHED_LOGIC_QUEUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nextBeginOffset = nextOffsetCorrection(offset, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (GetMessageStatus.FOUND == status) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.storeStatsService.getGetMessageTimesTotalFound().incrementAndGet();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.storeStatsService.getGetMessageTimesTotalMiss().incrementAndGet();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        long elapsedTime = this.getSystemClock().now() - beginTime;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.storeStatsService.setGetMessageEntireTimeMax(elapsedTime);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        getResult.setStatus(status);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        getResult.setNextBeginOffset(nextBeginOffset);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        getResult.setMaxOffset(maxOffset);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        getResult.setMinOffset(minOffset);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return getResult;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>首先根据topic和queueId找到对应的ConsumeQueue。然后找到对应的MappedFile获取对应数量的数据，然后根据tag进行过滤出来对应的数据。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="挂起请求处理">挂起请求处理<a href="#挂起请求处理" class="hash-link" aria-label="Direct link to 挂起请求处理" title="Direct link to 挂起请求处理">​</a></h3>
<p>之前PullRequest请求处理中有这样一段代码：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">case ResponseCode.PULL_NOT_FOUND:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    //brokerAllowSuspend=ture 方法传入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (brokerAllowSuspend &amp;&amp; hasSuspendFlag) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        long pollingTimeMills = suspendTimeoutMillisLong;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (!this.brokerController.getBrokerConfig().isLongPollingEnable()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            pollingTimeMills = this.brokerController.getBrokerConfig().getShortPollingTimeMills();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        String topic = requestHeader.getTopic();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        long offset = requestHeader.getQueueOffset();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        int queueId = requestHeader.getQueueId();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        PullRequest pullRequest = new PullRequest(request, channel, pollingTimeMills,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            this.brokerController.getMessageStore().now(), offset, subscriptionData, messageFilter);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        this.brokerController.getPullRequestHoldService().suspendPullRequest(topic, queueId, pullRequest);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        response = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这段代码就是在没有找到Message的时候去挂起请求，通过PullRequestHoldService#suspendPullRequest来挂起请求：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    public void suspendPullRequest(final String topic, final int queueId, final PullRequest pullRequest) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String key = this.buildKey(topic, queueId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ManyPullRequest mpr = this.pullRequestTable.get(key);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (null == mpr) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            mpr = new ManyPullRequest();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ManyPullRequest prev = this.pullRequestTable.putIfAbsent(key, mpr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (prev != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                mpr = prev;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mpr.addPullRequest(pullRequest);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们是不是在BrokerController启动中看到了PullRequestHoldService(继承ServiceThread)被启动了，所以我们应该去看看PullRequestHoldService做了什么，所以首先去看他的run方法：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void run() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log.info(&quot;{} service started&quot;, this.getServiceName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while (!this.isStopped()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //是否开启了长轮询</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (this.brokerController.getBrokerConfig().isLongPollingEnable()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    //长轮询等待5s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    this.waitForRunning(5 * 1000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   //短轮询等待1s this.waitForRunning(this.brokerController.getBrokerConfig().getShortPollingTimeMills());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                long beginLockTimestamp = this.systemClock.now();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //检查挂起的请求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.checkHoldRequest();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                long costTime = this.systemClock.now() - beginLockTimestamp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (costTime &gt; 5 * 1000) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    log.info(&quot;[NOTIFYME] check hold request cost {} ms.&quot;, costTime);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Throwable e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                log.warn(this.getServiceName() + &quot; service has exception. &quot;, e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log.info(&quot;{} service end&quot;, this.getServiceName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>通过调用 <strong><code>PullRequestHoldService#checkHoldRequest</code></strong> 方法来检查保存在这个里面的数据：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private void checkHoldRequest() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (String key : this.pullRequestTable.keySet()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String[] kArray = key.split(TOPIC_QUEUEID_SEPARATOR);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (2 == kArray.length) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String topic = kArray[0];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                int queueId = Integer.parseInt(kArray[1]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                final long offset = this.brokerController.getMessageStore().getMaxOffsetInQueue(topic, queueId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    //五秒钟通知一次</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    this.notifyMessageArriving(topic, queueId, offset);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (Throwable e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    log.error(&quot;check hold request failed. topic={}, queueId={}&quot;, topic, queueId, e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>看一下 <strong><code>PullRequestHoldService#notifyMessageArriving</code></strong> 方法：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    public void notifyMessageArriving(final String topic, final int queueId, final long maxOffset) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        notifyMessageArriving(topic, queueId, maxOffset, null, 0, null, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void notifyMessageArriving(final String topic, final int queueId, final long maxOffset, final Long tagsCode,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        long msgStoreTime, byte[] filterBitMap, Map&lt;String, String&gt; properties) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String key = this.buildKey(topic, queueId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ManyPullRequest mpr = this.pullRequestTable.get(key);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (mpr != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;PullRequest&gt; requestList = mpr.cloneListAndClear();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (requestList != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                List&lt;PullRequest&gt; replayList = new ArrayList&lt;PullRequest&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for (PullRequest request : requestList) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    long newestOffset = maxOffset;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (newestOffset &lt;= request.getPullFromThisOffset()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        newestOffset = this.brokerController.getMessageStore().getMaxOffsetInQueue(topic, queueId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (newestOffset &gt; request.getPullFromThisOffset()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        boolean match = request.getMessageFilter().isMatchedByConsumeQueue(tagsCode,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            new ConsumeQueueExt.CqExtUnit(tagsCode, msgStoreTime, filterBitMap));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // match by bit map, need eval again when properties is not null.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (match &amp;&amp; properties != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            match = request.getMessageFilter().isMatchedByCommitLog(null, properties);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (match) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                this.brokerController.getPullMessageProcessor().executeRequestWhenWakeup(request.getClientChannel(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    request.getRequestCommand());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            } catch (Throwable e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                log.error(&quot;execute request when wakeup failed.&quot;, e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            continue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (System.currentTimeMillis() &gt;= (request.getSuspendTimestamp() + request.getTimeoutMillis())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            this.brokerController.getPullMessageProcessor().executeRequestWhenWakeup(request.getClientChannel(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                request.getRequestCommand());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        } catch (Throwable e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            log.error(&quot;execute request when wakeup failed.&quot;, e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        continue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    replayList.add(request);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (!replayList.isEmpty()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    mpr.addPullRequest(replayList);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>通过 <strong><code>PullMessageProcessor#executeRequestWhenWakeup</code></strong> 来处理数据。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public void executeRequestWhenWakeup(final Channel channel,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final RemotingCommand request) throws RemotingCommandException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Runnable run = new Runnable() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            public void run() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    final RemotingCommand response = PullMessageProcessor.this.processRequest(channel, request, false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (response != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        response.setOpaque(request.getOpaque());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        response.markResponseType();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            channel.writeAndFlush(response).addListener(new ChannelFutureListener() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                public void operationComplete(ChannelFuture future) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    if (!future.isSuccess()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        log.error(&quot;processRequestWrapper response to {} failed&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                            future.channel().remoteAddress(), future.cause());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        log.error(request.toString());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        log.error(response.toString());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        } catch (Throwable e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            log.error(&quot;processRequestWrapper process request over, but response failed&quot;, e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            log.error(request.toString());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            log.error(response.toString());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (RemotingCommandException e1) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    log.error(&quot;excuteRequestWhenWakeup run&quot;, e1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.brokerController.getPullMessageExecutor().submit(new RequestTask(run, channel, request));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>最终还是通过 <strong><code>PullMessageProcessor#processRequest</code></strong> 这个方法来处理数据，但是这里的brokerAllowSuspend=false意思就是只会挂起一次，不会无限制的挂起这个请求在没有消息来的时候。到这里就Broker接收完了</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/mxsm/mxsm-website/edit/develop/docs/rocketmq/rocketmq4/broker/RocketMQ-analysis-Broker-recevie-pull.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2024-03-18T15:56:29.000Z">Mar 18, 2024</time></b> by <b>mxsm</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/rocketmq/rocketmq4/broker/RocketMQ-analysis-Broker-message-store"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">RocketMQ源码解析-Broker消息存储设计与实现</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/rocketmq/rocketmq4/broker/RocketMQ-analysis-Broker-start"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">RocketMQ源码解析-Broker启动</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#pullmessageprocessor" class="table-of-contents__link toc-highlight">PullMessageProcessor</a></li><li><a href="#defaultmessagestoregetmessage" class="table-of-contents__link toc-highlight">DefaultMessageStore.getMessage</a></li><li><a href="#挂起请求处理" class="table-of-contents__link toc-highlight">挂起请求处理</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/mxsm" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 mxsm(蚂蚁背大象), Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>