<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.83.1"><link rel=canonical type=text/html href=/docs/grpc/><link rel=alternate type=application/rss+xml href=/docs/grpc/index.xml><meta name=ROBOTS content="INDEX, FOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>gRPC | 蚂蚁背大象</title><meta property="og:title" content="gRPC"><meta property="og:description" content="gRPC"><meta property="og:type" content="website"><meta property="og:url" content="/docs/grpc/"><meta property="og:site_name" content="蚂蚁背大象"><meta itemprop=name content="gRPC"><meta itemprop=description content="gRPC"><meta name=twitter:card content="summary"><meta name=twitter:title content="gRPC"><meta name=twitter:description content="gRPC"><link rel=preload href=/scss/main.min.e09cb23c7dff3bf1285aa0294bcdc4ac8194fb3425a99c621e31e7b871315685.css as=style><link href=/scss/main.min.e09cb23c7dff3bf1285aa0294bcdc4ac8194fb3425a99c621e31e7b871315685.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 321.39 78.54"><title id="title19">DUBBO LOGO</title><path class="cls-1" d="M68.46 50.38c0 14.06 11.39 22.11 25.45 22.11s25.45-8.05 25.45-22.11V7.25H68.46zm21.24-28h8.6V31H89.7zm0 22.25h8.6v8.6H89.7zM33.24 7.25H4.06v64H33.24c10.95.0 19.3-7.18 23.29-17.15a45.12 45.12.0 002.38-14.87A45.12 45.12.0 0056.53 24.4C52.84 14.62 44.19 7.25 33.24 7.25zm.43 14.63H30.34a3.44 3.44.0 00-3.44 3.44V53.23a3.44 3.44.0 003.44 3.44h3.33v4.63h-8.3a6.87 6.87.0 01-6.87-6.87V24.12a6.87 6.87.0 016.87-6.87h8.3zM285.51 6.06c-17.05.0-30.88 10.28-30.88 33.21s13.83 33.21 30.88 33.21 30.88-10.28 30.88-33.21S302.56 6.06 285.51 6.06zm7.59 48.36a6.87 6.87.0 01-6.87 6.87h-8.3V56.67h3.33a3.44 3.44.0 003.44-3.44V25.31a3.44 3.44.0 00-3.44-3.44h-3.33V17.25h8.3a6.87 6.87.0 016.87 6.87zm-53.4-17.56A17.39 17.39.0 00227.31 7.25H195.1v64h32.21a19.44 19.44.0 0012.38-34.44zM211.63 61.29h-6.08l18.68-44h6.08zM177 36.85A17.39 17.39.0 00164.65 7.25H132.43v64h32.21A19.44 19.44.0 00177 36.85zM149 61.29h-6.08l18.68-44h6.08z" style="fill:#fff;fill-opacity:1"/></svg></span><span class="text-uppercase font-weight-bold">蚂蚁背大象</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/about/><span>Home</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog/><span>Java</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/spring/><span>Spring</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/middlewares/><span>Middleware</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/docs/><span class=active>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/other/><span>Others</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community/><span>Community</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002 站内搜索…" aria-label=站内搜索… autocomplete=off></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/grpc/>Return to the regular view of this page</a>.</p></div><h1 class=title>gRPC</h1><div class=lead>gRPC</div><ul><li>1: <a href=#pg-df2003f65dc2ddabbb1c9b05346773e6>深入浅出理解gRPC</a></li><li>2: <a href=#pg-d45a5f3c0423d0ca088e54fd393e69c9>gRPC的概念-图文并茂</a></li><li>3: <a href=#pg-1101806d6e2ab75365f452c3a6aa3d06>Protobuf与JSON的优劣-用数据说话</a></li></ul><div class=content></div></div><div class=td-content><h1 id=pg-df2003f65dc2ddabbb1c9b05346773e6>1 - 深入浅出理解gRPC</h1><h3 id=前言>前言</h3><p>gRPC在最近的几年出现的频率越来越高，越来越多的项目都引入了gRPC,例如：Dubbo3.0, Nacos, RocketMQ5.0。那么gRPC到底是什么我们从下面的几个方面来进行分析</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/gRPC/image-20220101214137128.png alt=image-20220101214137128></p><h3 id=1-grpc是什么>1. gRPC是什么？</h3><p>gRPC是一个现代的开源高性能远程过程调用(RPC)框架，可以在任何环境中运行。它可以有效地连接数据中心内和跨数据中心的服务，支持负载均衡、跟踪、健康检查和身份验证。它也适用于分布式计算，将设备、移动应用程序和浏览器连接到后端服务&mdash;这是官方给的说明。gRPC特点：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/gRPC/image-20211231173154257.png alt=image-20211231173154257></p><p>那么gRPC是什么呢？</p><ul><li>一个高性能RPC框架，一个跨语言平台的RPC框架。</li><li>使用<a href=https://developers.google.com/protocol-buffers>Protocol Buffers</a>作为二进制序列化</li><li>使用HTTP/2进行数据传输</li></ul><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/gRPC/image-20211231173654659.png alt=图片来源gRPC官网></p><p>gRPC客户机和服务器可以在各种环境中彼此运行和通信。服务端使用的C++实现。而客户端可以是Ruby、Java、Go等其他的语言。这就体现了gRPC的跨平。</p><h3 id=2-grpc与protocol-buffers>2. gRPC与Protocol Buffers</h3><h4 id=21-protocol-buffers是什么>2.1 Protocol Buffers是什么？</h4><blockquote><p>Protocol Buffers官网：https://developers.google.com/protocol-buffers</p></blockquote><p>由Google定义的一个与语言和平台无关具有可拓展的用于序列化结构化的数据(例如：XML、JSON)的协议。但更小、更快、更简单。您只需定义数据的结构化方式，然后就可以使用特殊生成的源代码轻松地向各种数据流写入和读取结构化数据，并可以被各种语言使用。</p><blockquote><p>Akka的节点之间的数据传输可以自定义基于<a href=https://developers.google.com/protocol-buffers>Protocol Buffers</a>序列化的处理。</p></blockquote><h4 id=22--grpc使用protocol-buffers序列化结构化数据>2.2 gRPC使用Protocol Buffers序列化结构化数据</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=color:#8f5902;font-style:italic>// The greeter service definition.
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>service</span> <span style=color:#000>Greeter</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Sends a greeting
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>rpc</span> <span style=color:#000>SayHello</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>HelloRequest</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>returns</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>HelloReply</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{}</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic>// The request message containing the user&#39;s name.
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>HelloRequest</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic>// The response message containing the greetings
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>HelloReply</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>string</span> <span style=color:#204a87;font-weight:700>message</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></code></pre></div><p>通过定义 <em>proto</em> 文件，来定义 <strong><code>service</code></strong> 和 <strong><code>message</code></strong> 。 service负责提供服务， message提供结构化数据的序列化。</p><p>gRPC与Protocol Buffers的关系:</p><p><strong>Protocol Buffers 负责gRPC的结构化数据的序列化</strong></p><h3 id=3-grpc与http2>3. gRPC与HTTP2</h3><blockquote><p><a href="https://developers.google.com/web/fundamentals/performance/http2?hl=zh-cn">HTTP/2</a></p></blockquote><p>让我们深入了解gRPC概念如何与HTTP/2概念相关。gRPC引入了三个新概念:channel、RPC和Message。三者之间的关系很简单:每个Channel可能有许多RPC，而每个RPC可能有许多Message。</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/gRPC/chanel%E5%92%8CRPC%E5%92%8CMessage%E7%9A%84%E5%85%B3%E7%B3%BB.png alt=chanel和RPC和Message的关系></p><h4 id=31-grpc如何关联http2>3.1 gRPC如何关联HTTP/2</h4><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/gRPC/gRPC%E4%B8%8EHTTP_2.png alt=gRPC与HTTP_2></p><p>HTTP/2中的流在一个连接上允许多个并发会话,而gRPC的通过支持多个并发连接上的多个流扩展了这个概念。</p><blockquote><p>Channel: 表示和终端的一个虚拟链接</p></blockquote><p><code>Channel</code> 背后实际上可能有多个HTTP/2 连接。从上面关系图来看，一个RPC和一个HTTP/2连接相关联，rpc实际上是纯HTTP/2流。Message与rpc关联，并以HTTP/2数据帧的形式发送。</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/gRPC/RPC%E5%92%8CMessage%E5%92%8CFrame.png alt=RPC和Message和Frame></p><blockquote><p>消息是在数据帧之上分层的。一个数据帧可能有许多gRPC消息，或者如果一个gRPC消息非常大，它可能跨越多个数据帧。</p></blockquote><h4 id=32-解析器和负载均衡>3.2 解析器和负载均衡</h4><p>为了保持连接的alive、Healthy和利用，gRPC使用了许多组件，其中最重要的是名称解析器和负载平衡器。</p><ul><li><p>解析器将名称转换为地址，然后将这些地址交给负载均衡器。</p></li><li><p>负载均衡器负责从这些地址创建连接，并在连接之间对rpc进行负载均衡。</p></li></ul><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/gRPC/gRPC%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1.png alt=gRPC解析器和负载均衡></p><h4 id=33-连接的管理>3.3 连接的管理</h4><p>配置完成后，gRPC将保持连接池(解析器和平衡器定义的)处于正常状态、处于活动状态和已使用状态。</p><p>当连接失败时，负载均衡器将开始使用最后已知的地址列表重新连接。同时，解析器将开始尝试重新解析主机名列表。这在许多场景中都很有用。例如，如果代理不再可达，我们希望解析器更新地址列表，使其不包含该代理的地址。再举一个例子:DNS条目可能会随着时间的推移而改变，因此可能需要定期更新地址列表。通过这种方式和其他方式，gRPC旨在实现长期弹性。</p><p>一旦解析完成，负载均衡器就会被告知新的地址。如果地址发生了变化，负载均衡器可能会关闭到新列表中不存在的地址的连接，或者创建到以前不存在的地址的连接。</p><blockquote><p>连接也试用了池化</p></blockquote><h4 id=34-失效连接识别>3.4 失效连接识别</h4><p>gRPC连接管理的有效性取决于它识别失败连接的能力。失效连接分为两种：</p><ul><li><p>清除的失效连接&mdash;通讯失败（例如：连接失败）</p><p>当端点有意终止连接时，可能会发生清除故障。例如，端点可能已经优雅地关闭，或者可能超过了计时器，从而提示端点关闭连接。当连接干净地关闭时，TCP语义就足够了:关闭连接会导致FIN握手。这将结束HTTP/2连接，从而结束gRPC连接。gRPC将立即开始重新连接。不需要额外的HTTP/2或gRPC语义。</p></li><li><p>不可清除的失效连接（复杂的网络环境）</p><p>endpoint死亡或挂起而不通知客户端。在这种情况下，TCP可能会在认为连接失败之前进行长达10分钟的重试。当然，没有意识到连接已死10分钟是不可接受的。gRPC使用HTTP/2语义解决了这个问题:当配置KeepAlive时，gRPC会定期发送HTTP/2 PING帧。这些帧绕过流量控制，用来建立连接是否有效。如果PING响应没有及时返回，gRPC将认为连接失败，关闭连接，并开始重新连接</p></li></ul><p>通过这种方式，gRPC保持连接池的健康状态，并定期使用HTTP/2来确定连接的健康状态。</p><h4 id=35-alive保持>3.5 Alive保持</h4><p>通过发送HTTP/2 PING来定期检查连接的健康状况，以确定连接是否仍然活着</p><blockquote><p><strong>gRPC与HTTP/2的关系：HTTP/2为长连接、实时的通信流提供了基础。gRPC建立在这个基础之上，具有连接池、健康语义、高效使用数据帧和多路复用以及KeepAlive，gRPC的通讯基石就是HTTP/2</strong></p></blockquote><h3 id=4-grpc的应用>4. gRPC的应用</h3><p>现在gRPC在很多项目中都有应用</p><ul><li>Nacos(2.x)</li><li>Dubbo(3.x)</li><li>Apache RocketMQ（5.x）</li></ul><p>有兴趣的可以研究一下对应项目的源码</p><h3 id=5-总结>5. 总结</h3><ul><li>gRPC是一个高可用的 <strong><code>跨平台</code></strong> 的RPC框架</li><li>gRPC数据序列化是通过<a href=https://developers.google.com/protocol-buffers>Protocol Buffers</a>,数据传输基于HTTP/2</li><li>HTTP/2的语义提供给gRPC的长连接和实时的通讯，以及其他的HTTP/2的特性</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-d45a5f3c0423d0ca088e54fd393e69c9>2 - gRPC的概念-图文并茂</h1><p>之前在学习gRPC梳理了Protobuf Buffers和HTTP/2在gRPC中的作用和关系。接下来对gRPC的几个概念整理一下。</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/gRPC/image-20220101165554451.png alt=image-20220101165554451></p><p>主要有两个：</p><ul><li><p>gRPC中如何定义一个服务</p><p>gRPC使用的是 <a href=https://developers.google.com/protocol-buffers>Protocol Buffers</a>作为接口定义语言</p></li><li><p>RPC生命周期</p></li></ul><h3 id=1-服务定义>1. 服务定义</h3><p>gRPC使用的是 <a href=https://developers.google.com/protocol-buffers>Protocol Buffers</a>作为接口定义语言，通过<a href=https://developers.google.com/protocol-buffers>Protocol Buffers</a>来定义，下面以Java作为例子来定义一个</p><blockquote><p><a href=https://developers.google.com/protocol-buffers>Protocol Buffers</a>官网：https://developers.google.com/protocol-buffers</p></blockquote><h4 id=11-定义一个proto文件>1.1 定义一个proto文件</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=color:#000>syntax</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;proto3&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>option</span> <span style=color:#000>java_multiple_files</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>option</span> <span style=color:#000>java_package</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;com.github.mxsm.grpc&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic>/*下面这一段来自gRPC官网，或者也可以自己定义，这里只是做一个演示*/</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>service</span> <span style=color:#000>HelloService</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>rpc</span> <span style=color:#000>SayHello</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>HelloRequest</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>returns</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>HelloResponse</span><span style=color:#000;font-weight:700>);</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>HelloRequest</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>greeting</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>HelloResponse</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>reply</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></code></pre></div><blockquote><p>文件的位置放在 <strong><code>src/main/proto</code></strong>（默认情况）</p></blockquote><h4 id=12-pomxml文件增加依赖和插件>1.2 pom.xml文件增加依赖和插件</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;!-- gRPC依赖 --&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;dependency&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;groupId&gt;</span>io.grpc<span style=color:#204a87;font-weight:700>&lt;/groupId&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;artifactId&gt;</span>grpc-netty-shaded<span style=color:#204a87;font-weight:700>&lt;/artifactId&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;version&gt;</span>1.43.1<span style=color:#204a87;font-weight:700>&lt;/version&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/dependency&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;dependency&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;groupId&gt;</span>io.grpc<span style=color:#204a87;font-weight:700>&lt;/groupId&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;artifactId&gt;</span>grpc-protobuf<span style=color:#204a87;font-weight:700>&lt;/artifactId&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;version&gt;</span>1.43.1<span style=color:#204a87;font-weight:700>&lt;/version&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/dependency&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;dependency&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;groupId&gt;</span>io.grpc<span style=color:#204a87;font-weight:700>&lt;/groupId&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;artifactId&gt;</span>grpc-stub<span style=color:#204a87;font-weight:700>&lt;/artifactId&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;version&gt;</span>1.43.1<span style=color:#204a87;font-weight:700>&lt;/version&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/dependency&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;dependency&gt;</span> <span style=color:#8f5902;font-style:italic>&lt;!-- necessary for Java 9+ --&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;groupId&gt;</span>org.apache.tomcat<span style=color:#204a87;font-weight:700>&lt;/groupId&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;artifactId&gt;</span>annotations-api<span style=color:#204a87;font-weight:700>&lt;/artifactId&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;version&gt;</span>6.0.53<span style=color:#204a87;font-weight:700>&lt;/version&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;scope&gt;</span>provided<span style=color:#204a87;font-weight:700>&lt;/scope&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/dependency&gt;</span>
</code></pre></div><p>上面就是增加了相关的gRPC依赖。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;build&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;extensions&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;extension&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;groupId&gt;</span>kr.motd.maven<span style=color:#204a87;font-weight:700>&lt;/groupId&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;artifactId&gt;</span>os-maven-plugin<span style=color:#204a87;font-weight:700>&lt;/artifactId&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;version&gt;</span>1.6.2<span style=color:#204a87;font-weight:700>&lt;/version&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/extension&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;/extensions&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;plugins&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;plugin&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;groupId&gt;</span>org.xolstice.maven.plugins<span style=color:#204a87;font-weight:700>&lt;/groupId&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;artifactId&gt;</span>protobuf-maven-plugin<span style=color:#204a87;font-weight:700>&lt;/artifactId&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;version&gt;</span>0.6.1<span style=color:#204a87;font-weight:700>&lt;/version&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;configuration&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;protocArtifact&gt;</span>com.google.protobuf:protoc:3.19.1:exe:${os.detected.classifier}<span style=color:#204a87;font-weight:700>&lt;/protocArtifact&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;pluginId&gt;</span>grpc-java<span style=color:#204a87;font-weight:700>&lt;/pluginId&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;pluginArtifact&gt;</span>io.grpc:protoc-gen-grpc-java:1.43.1:exe:${os.detected.classifier}<span style=color:#204a87;font-weight:700>&lt;/pluginArtifact&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;protoSourceRoot&gt;</span>${basedir}/src/main/resources<span style=color:#204a87;font-weight:700>&lt;/protoSourceRoot&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;outputDirectory&gt;</span>src/main/java<span style=color:#204a87;font-weight:700>&lt;/outputDirectory&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;/configuration&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;executions&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;execution&gt;</span>
          <span style=color:#204a87;font-weight:700>&lt;goals&gt;</span>
            <span style=color:#204a87;font-weight:700>&lt;goal&gt;</span>compile<span style=color:#204a87;font-weight:700>&lt;/goal&gt;</span>
            <span style=color:#204a87;font-weight:700>&lt;goal&gt;</span>compile-custom<span style=color:#204a87;font-weight:700>&lt;/goal&gt;</span>
          <span style=color:#204a87;font-weight:700>&lt;/goals&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;/execution&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;/executions&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/plugin&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;/plugins&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/build&gt;</span>
</code></pre></div><p>这里增加的代码生成插件。</p><blockquote><p>通过protoSourceRoot修改了proto文件的存放的位置，outputDirectory修改输出的位置。</p></blockquote><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/gRPC/gRPC%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90.gif alt=gRPC代码生成></p><p>通过动态图可以看出来，通过<a href=https://developers.google.com/protocol-buffers>Protocol Buffers</a>定义出来了对应的接口。以及结构化的数据。</p><blockquote><p>也可以参考Nacos定义的服务，看看开源服务是怎么样去定义的。文件地址：https://github.com/alibaba/nacos/blob/develop/api/src/main/proto/nacos_grpc_service.proto</p></blockquote><h3 id=2-服务方法分类>2. 服务方法分类</h3><p>gRPC能够让我们定义四类服务方法</p><h4 id=21-一元rpc>2.1 一元RPC</h4><p>客户端发送一个单独的请求到服务器，然后服务器在返回一个单独响应给客户端</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/gRPC/%E4%B8%80%E5%85%83RPC.png alt=一元RPC></p><p>这种就是客户端请求，然后等待服务器返回。</p><p>定义方式：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=color:#204a87;font-weight:700>rpc</span> <span style=color:#000>SayHello</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>HelloRequest</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>returns</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>HelloResponse</span><span style=color:#000;font-weight:700>);</span><span style=color:#a40000>
</span></code></pre></div><h4 id=22-服务器流式rpc>2.2 服务器流式RPC</h4><p>客户端向服务器发送请求，并获得一个流来读取一系列消息。客户端从返回的流中读取，直到没有更多的消息。gRPC保证单个RPC调用中的消息顺序</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/gRPC/%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%B5%81%E5%BC%8FRPC.png alt=服务器流式RPC></p><p>客户端请求一次，但是服务器通过流返回多个返回消息。</p><p>定义方式：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=color:#204a87;font-weight:700>rpc</span> <span style=color:#000>LotsOfReplies</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>HelloRequest</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>returns</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>stream</span> <span style=color:#000>HelloResponse</span><span style=color:#000;font-weight:700>);</span><span style=color:#a40000>
</span></code></pre></div><blockquote><p>Tips: 在返回的消息的前面使用 stream 关键字</p></blockquote><h4 id=23-客户端流式rpc>2.3 客户端流式RPC</h4><p>其中客户端写入一系列消息并将它们发送到服务器，再次使用提供的流。一旦客户端完成了消息的写入，它就会等待服务器读取消息并返回响应。</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/gRPC/%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%B5%81%E5%BC%8FRPC.png alt=客户端流式RPC></p><p>定义方式：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=color:#204a87;font-weight:700>rpc</span> <span style=color:#000>LotsOfGreetings</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>stream</span> <span style=color:#000>HelloRequest</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>returns</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>HelloResponse</span><span style=color:#000;font-weight:700>);</span><span style=color:#a40000>
</span></code></pre></div><h4 id=24-双向流rpc>2.4 双向流RPC</h4><p>双方使用读写流发送一系列消息。两个流独立运作,因此客户端和服务器可以读和写在他们喜欢的任何顺序:例如,服务器可以等待收到所有客户端消息之前写的反应,也可以交替阅读一条消息然后写一个消息,或其他一些读写的结合。每个流中的消息顺序被保留。</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/gRPC/%E5%8F%8C%E5%90%91%E6%B5%81.png alt=双向流></p><p>定义方式：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=color:#204a87;font-weight:700>rpc</span> <span style=color:#000>BidiHello</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>stream</span> <span style=color:#000>HelloRequest</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>returns</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>stream</span> <span style=color:#000>HelloResponse</span><span style=color:#000;font-weight:700>);</span><span style=color:#a40000>
</span></code></pre></div><blockquote><p>服务定义在 <strong><code>.proto</code></strong> 文件中，gRPC提供了gRPC提供了生成客户端和服务器端代码的协议缓冲区编译器插件。gRPC在客户端调用定义的接口，在服务器端实现定义的相对应的接口</p><ul><li>在服务器端，服务器实现服务声明的方法，并运行gRPC服务器来处理客户端调用。gRPC基础设施对传入的请求进行解码，执行服务方法，并对服务响应进行编码。(RPC的调用过程)</li><li>在客户端，客户端有一个称为存根的本地对象，它实现了与服务相同的方法。然后客户端可以在本地对象上调用这些方法，将调用的参数包装在适当的Protocol Buffers消息类型中——gRPC负责向服务器发送请求并返回服务器的Protocol Buffers响应。</li></ul><p>gRPC有同步和异步两种风格</p></blockquote><h3 id=3-rpc的生命周期>3. RPC的生命周期</h3><p>上面说了四种不同的RPC,每种RPC的生命周期也不一样，下面来看一下不同RPC的生命周期。</p><blockquote><p>元数据是以键-值对列表的形式表示的关于特定RPC调用(比如身份验证细节)的信息，其中键是字符串，值通常是字符串，但也可以是二进制数据。元数据对于gRPC本身是不透明的——它让客户机提供与服务器调用相关联的信息，反之亦然。</p></blockquote><h4 id=31-一元rpc生命周期>3.1 一元RPC生命周期</h4><p>客户端发送一个请求并且等待服务器的返回。</p><ol><li>一旦客户机调用存根方法，服务器就会被通知，RPC已经被调用了，该调用使用客户机的元数据、方法名以及指定的截止日期等等</li><li>服务器可以直接返回它自己的初始元数据(必须在任何响应之前发送)，或者等待客户机的请求消息</li><li>一旦服务器获得了客户机的请求消息，它就会执行创建和填充响应所需的任何工作。然后将响应(如果成功)连同状态详细信息(状态代码和可选的状态消息)和可选的跟踪元数据返回给客户端</li><li>如果响应状态为OK，则客户端将获得响应，从而完成客户端上的调用</li></ol><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/gRPC/%E4%B8%80%E5%85%83RPC%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.png alt=一元RPC生命周期></p><h4 id=32-服务器流rpc生命周期>3.2 服务器流RPC生命周期</h4><p>服务器流RPC类似于一元RPC，不同之处是服务器返回响应客户机请求的消息流。在发送所有消息之后，服务器的状态详细信息(状态代码和可选的状态消息)和可选的跟踪元数据被发送到客户端。这就完成了服务器端的处理。客户端拥有服务器的所有消息后就完成了。</p><h4 id=33-客户端流rpc生命周期>3.3 客户端流RPC生命周期</h4><p>客户端流RPC类似于一元RPC，不同之处是客户端向服务器发送消息流而不是单个消息。服务器用一条消息(以及它的状态详细信息和可选的跟踪元数据)响应，通常但不一定是在它收到所有客户端消息之后</p><h4 id=34-双向流rpc生命周期>3.4 双向流RPC生命周期</h4><p>在双向流RPC中，调用是由调用方法的客户机和接收客户机元数据、方法名和截止日期的服务器发起的。服务器可以选择发回其初始元数据或等待客户端开始流消息。客户端和服务器端流处理是特定于应用程序的。由于这两个流是独立的，客户端和服务器可以以任何顺序读写消息。例如,一个服务器可以等到它已经收到了客户的所有信息之前写它的消息,或者是服务器和客户端可以玩“乒乓球”——服务器收到一个请求,然后发回一个响应,然后根据响应客户端发送另一个请求,等等</p><h4 id=35-截止时间过期时间>3.5 截止时间/过期时间</h4><p>gRPC允许客户端指定在使用DEADLINE_EXCEEDED错误终止RPC之前，他们愿意等待RPC完成多长时间。在服务器端，服务器可以查询特定的RPC是否超时，或者还剩下多少时间来完成RPC。</p><h4 id=36-rpc终止>3.6 RPC终止</h4><p>在gRPC中，客户端和服务器都对调用的成功做出独立的和本地的判断，它们的结论可能不匹配。这意味着，例如，您可以有一个RPC，它在服务器端成功完成(“我已经发送了我所有的响应!”)，但在客户端失败(“响应在我的截止日期之后到达!”)。服务器也可以在客户端发送完所有请求之前决定是否完成。</p><blockquote><p>例如：web网页请求某一个后端的接口，但是还没又返回的时候前端已经关闭了连接。就在关闭连接没多久后端完成了处理这个接口并且准备返回数据。这个时候就会出现后端数据没法传输到前端。</p></blockquote><h3 id=4-什么是channel>4 什么是Channel?</h3><p>gRPC通道提供到指定主机和端口的gRPC服务器的连接。它在创建客户端存根时使用。客户端可以指定通道参数来修改gRPC的默认行为，比如打开或关闭消息压缩。通道有状态，包括已连接和空闲。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-1101806d6e2ab75365f452c3a6aa3d06>3 - Protobuf与JSON的优劣-用数据说话</h1><p>JSON因为其轻量和易阅读，对开发者友好逐步替代了XML,所以现在大多数的前后端交互都是使用的JSON，但是由于容器化、K8s的崛起。有Google设计的Protobuf作为一种跨平台的序列化结构化数据的协议慢慢的开始了展露头角。同时gRPC在对Protobuf的应用也让Protobuf快速崛起。国内很多的开源的项目如：Nacos、Dubbo3、RocketMQ5 都已gRPC作为基础。那么Protobuf既然好处这么多我们平时的开发中为什么还是用JSON比较多。从以下几个方面分析：</p><p><img src=E:%5Cdownload%5CProtobuf%E5%92%8CJSON%E6%AF%94%E8%BE%83.png alt=Protobuf和JSON比较></p><ul><li><strong>序列化和反序列化的时间</strong></li><li><strong>相同结构化的数据反序列化内存占用</strong></li><li><strong>对开发者的友好程度</strong></li></ul><h3 id=1-序列化和反序列化的时间>1. 序列化和反序列化的时间</h3><p>定一个简单User数据结构,首先是Protobuf的定义</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>syntax</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;proto3&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#000>option</span> <span style=color:#000>java_multiple_files</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#000>option</span> <span style=color:#000>java_package</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;com.github.mxsm.grpc.login&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#000>message</span> <span style=color:#000>UserProto</span><span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#000>string</span> <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#000>int32</span> <span style=color:#000>age</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#000>string</span> <span style=color:#000>address</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#000>string</span> <span style=color:#000>email</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#000>string</span> <span style=color:#000>phone</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>Java类的定义</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>UserJson</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>age</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>address</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>email</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>phone</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#8f5902;font-style:italic>//省略了get set方法
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>编写序列化的测试程序</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@BenchmarkMode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Mode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>AverageTime</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Warmup</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>iterations</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>time</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Measurement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>iterations</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>time</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Threads</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Fork</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@State</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Scope</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Benchmark</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@OutputTimeUnit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MICROSECONDS</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ProtobufJsonTest</span> <span style=color:#ce5c00;font-weight:700>{</span>


    <span style=color:#5c35cc;font-weight:700>@Param</span><span style=color:#ce5c00;font-weight:700>({</span><span style=color:#4e9a06>&#34;100000&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;1000000&#34;</span><span style=color:#ce5c00;font-weight:700>})</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>counter</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>UserJson</span> <span style=color:#000>userJson</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>UserProto</span> <span style=color:#000>userProto</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>userJsonBytes</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>userProtoBytes</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@Setup</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>init</span><span style=color:#ce5c00;font-weight:700>(){</span>

        <span style=color:#000>Faker</span> <span style=color:#000>faker</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Faker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Locale</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;zh-CN&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#000>String</span> <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>faker</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>name</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>fullName</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>age</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>faker</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>number</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>numberBetween</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>100</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>String</span> <span style=color:#000>address</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>faker</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>address</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>fullAddress</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>String</span> <span style=color:#000>email</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>faker</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>internet</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>emailAddress</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>String</span> <span style=color:#000>phone</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>faker</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>phoneNumber</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>cellPhone</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#000>userJson</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>UserJson</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>userJson</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>userJson</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAge</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>age</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>userJson</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAddress</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>address</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>userJson</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setEmail</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>email</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>userJson</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setPhone</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>phone</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#000>userJsonBytes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>JSON</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toJSONBytes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userJson</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#000>userProto</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>UserProto</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newBuilder</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>setName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>setAge</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>age</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>setAddress</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>address</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>setEmail</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>email</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setPhone</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>phone</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>build</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#000>userProtoBytes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>userProto</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toByteArray</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>


    <span style=color:#5c35cc;font-weight:700>@Benchmark</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>protobufSerializable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Blackhole</span> <span style=color:#000>blackhole</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>bytes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span>  <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(;</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>counter</span><span style=color:#ce5c00;font-weight:700>;++</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#000>bytes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>userProto</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toByteArray</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>blackhole</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consume</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bytes</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Benchmark</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>jsonSerializable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Blackhole</span> <span style=color:#000>blackhole</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span>  <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>bytes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(;</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>counter</span><span style=color:#ce5c00;font-weight:700>;++</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#000>bytes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>JSON</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toJSONBytes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userJson</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>blackhole</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consume</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bytes</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>


    <span style=color:#5c35cc;font-weight:700>@Benchmark</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>protobufDeserialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Blackhole</span> <span style=color:#000>blackhole</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InvalidProtocolBufferException</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#000>UserProto</span> <span style=color:#000>up</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span>  <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(;</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>counter</span><span style=color:#ce5c00;font-weight:700>;++</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#000>up</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>UserProto</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseFrom</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userProtoBytes</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>blackhole</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consume</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>up</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Benchmark</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>jsonDeserialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Blackhole</span> <span style=color:#000>blackhole</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span>  <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>UserJson</span> <span style=color:#000>aaa</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(;</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>counter</span><span style=color:#ce5c00;font-weight:700>;++</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#000>aaa</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>JSON</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userJsonBytes</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>UserJson</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>blackhole</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consume</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>aaa</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>RunnerException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Options</span> <span style=color:#000>opt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>OptionsBuilder</span><span style=color:#ce5c00;font-weight:700>().</span>
            <span style=color:#000>include</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ProtobufJsonTest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSimpleName</span><span style=color:#ce5c00;font-weight:700>())</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>result</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;result.json&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resultFormat</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResultFormatType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>JSON</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>build</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Runner</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>opt</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>run</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote><p>Tips：这里测试还是用到了JMH和Faker，JSON序列化和反序列化使用的Fastjson</p></blockquote><p>代码运行结果：</p><p><img src=E:%5Cdownload%5Cimage-20220125224526677.png alt=image-20220125224526677></p><p><img src=E:%5Cdownload%5Cprotobufjson%E5%AF%B9%E6%AF%94.png alt=protobufjson对比></p><p>从上图可以看出来<strong>protobuf的序列化和反序列化的性能都优于JSON</strong>（不同的JSON序列化工具可能速度不一样，但是fastjson是较快的序列化工具了）</p><h3 id=2-占用的内存>2. 占用的内存</h3><p>对比一下序列化生成byte数组占用的大小。测试代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MemeryTest</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Faker</span> <span style=color:#000>faker</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Faker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Locale</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;zh-CN&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#000>String</span> <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>faker</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>name</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>fullName</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>age</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>faker</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>number</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>numberBetween</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>100</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>String</span> <span style=color:#000>address</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>faker</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>address</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>fullAddress</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>String</span> <span style=color:#000>email</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>faker</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>internet</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>emailAddress</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>String</span> <span style=color:#000>phone</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>faker</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>phoneNumber</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>cellPhone</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34; &#34;</span><span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>age</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>address</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; &#34;</span><span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>email</span><span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; &#34;</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>phone</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>UserJson</span>  <span style=color:#000>userJson</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>UserJson</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>userJson</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>userJson</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAge</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>age</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>userJson</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAddress</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>address</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>userJson</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setEmail</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>email</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>userJson</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setPhone</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>phone</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>userJsonBytes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>JSON</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toJSONBytes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userJson</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#000>UserProto</span> <span style=color:#000>userProto</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>UserProto</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newBuilder</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>setName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>setAge</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>age</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>setAddress</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>address</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>setEmail</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>email</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setPhone</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>phone</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>build</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>userProtoBytes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>userProto</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toByteArray</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;userJsonBytes=&#34;</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>userJsonBytes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;;userProtoBytes=&#34;</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>userProtoBytes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>运行结果：</p><p><img src=E:%5Cdownload%5Cimage-20220125220932902.png alt=image-20220125220932902></p><p>Protobuf比JSON少了45个byte。<strong>Protobuf比JSON序化以后占用的字节数更少，在网络传输的过程中Protobuf更具有优势。</strong></p><h3 id=3-对开发者的友好程度>3. 对开发者的友好程度</h3><p>测试代码还是使用 <strong>MemeryTest</strong> 的测试代码在最后加两句打印：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userJsonBytes</span><span style=color:#ce5c00;font-weight:700>));</span>
<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userProtoBytes</span><span style=color:#ce5c00;font-weight:700>));</span>
</code></pre></div><p>运行结果：</p><p><img src=E:%5Cdownload%5Cimage-20220125221428571.png alt=image-20220125221428571></p><p>发现 JSON 开发者能够很好的识别，而Protobuf会出现乱码的情况。这里说明了一个问题：在对程序员的友好程度上JSON优于Protobuf。</p><p>另外还有一个JSON和对应的Bean之间是可以互相转换，而Protobuf需要先在 <strong><code>proto</code></strong> 文件中定义结构化的数据，然后通过编译工具转换为对应语言的数据结构，使用起来比较繁琐。</p><h3 id=4-总结>4. 总结</h3><ul><li>protobuf在序列化和反序列的速度领先于JSON,而序列化以后的内存占用有少于JSON。所以总的来说protobuf由于JSON</li><li>由于对开发者的友好程度不如JSON，使用过程比较繁琐。这可能是JSON的普及率大于Protobuf的原因，但是在一些对于性能和传输数据有极高要求的项目Protobuf可能更加的适合，例如IM的数据交互。</li><li>将Protobuf和JSON相结合可能是一个不错的选择(这个没有进行测试)</li></ul></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list"><a class=text-white target=_blank rel="noopener noreferrer" href=https://groups.google.com/u/1/g/ljbmxsm><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=个人掘金主页 aria-label=个人掘金主页><a class=text-white target=_blank rel="noopener noreferrer" href=https://juejin.cn/user/1151943918492855><i class="fab fa-twitter"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/mxsm><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2022 The Docsy Authors All Rights Reserved</small>
<small class=ml-1><a href=https://policies.google.com/privacy target=_blank>隐私政策</a></small><p class=mt-2><a href=/about/>Home</a></p></div></div></div></footer><div><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css><script src=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js></script><script>$("p img").wrap(function(){return'<a data-fancybox="gallery" href="'+$(this).attr('src')+'"></a>'})</script></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/mermaid@8.8.1/dist/mermaid.min.js integrity=sha384-to2w0I1OqmbJ9J6yTnIX+KYU8grNpZoD1dKPLjgEJvMe5L5+/7qvuNa2sQo8WAWj crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/raphael/2.3.0/raphael.min.js integrity="sha512-tBzZQxySO5q5lqwLWfu8Q+o4VkTcRGOeQGVQ0ueJga4A1RKuzmAu5HXDOXLEjpbKyV7ow9ympVoa6wZLEzRzDg==" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.15.0/flowchart.min.js integrity="sha512-6QsSiIybtf8tuZ6xfjRTr2tdtw3Gp4q5RSCh2b6q9seoKEQmhAG1RrCA8F0kXTwivVxRVbp/YF3zOh8rvEAU7Q==" crossorigin=anonymous></script><script src=/js/main.min.b541b310f01941a0abfd76b652b5fb60dac470573775bb5b31ff08fe3f6cea51.js integrity="sha256-tUGzEPAZQaCr/Xa2UrX7YNrEcFc3dbtbMf8I/j9s6lE=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.js></script><script type=text/javascript>docsearch({appId:'JO2SY3WDAC',apiKey:'324ddb3b679c1308e5aa8bf222e07f8b',indexName:'mxsm',inputSelector:'.td-search-input',debug:!1})</script></body></html>