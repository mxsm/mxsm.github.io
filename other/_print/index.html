<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.83.1"><link rel=canonical type=text/html href=/other/><link rel=alternate type=application/rss+xml href=/other/index.xml><meta name=ROBOTS content="INDEX, FOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Others | 蚂蚁背大象</title><meta property="og:title" content="Others"><meta property="og:description" content="蚂蚁背大象博客"><meta property="og:type" content="website"><meta property="og:url" content="/other/"><meta property="og:site_name" content="蚂蚁背大象"><meta itemprop=name content="Others"><meta itemprop=description content="蚂蚁背大象博客"><meta name=twitter:card content="summary"><meta name=twitter:title content="Others"><meta name=twitter:description content="蚂蚁背大象博客"><link rel=preload href=/scss/main.min.e09cb23c7dff3bf1285aa0294bcdc4ac8194fb3425a99c621e31e7b871315685.css as=style><link href=/scss/main.min.e09cb23c7dff3bf1285aa0294bcdc4ac8194fb3425a99c621e31e7b871315685.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 321.39 78.54"><title id="title19">DUBBO LOGO</title><path class="cls-1" d="M68.46 50.38c0 14.06 11.39 22.11 25.45 22.11s25.45-8.05 25.45-22.11V7.25H68.46zm21.24-28h8.6V31H89.7zm0 22.25h8.6v8.6H89.7zM33.24 7.25H4.06v64H33.24c10.95.0 19.3-7.18 23.29-17.15a45.12 45.12.0 002.38-14.87A45.12 45.12.0 0056.53 24.4C52.84 14.62 44.19 7.25 33.24 7.25zm.43 14.63H30.34a3.44 3.44.0 00-3.44 3.44V53.23a3.44 3.44.0 003.44 3.44h3.33v4.63h-8.3a6.87 6.87.0 01-6.87-6.87V24.12a6.87 6.87.0 016.87-6.87h8.3zM285.51 6.06c-17.05.0-30.88 10.28-30.88 33.21s13.83 33.21 30.88 33.21 30.88-10.28 30.88-33.21S302.56 6.06 285.51 6.06zm7.59 48.36a6.87 6.87.0 01-6.87 6.87h-8.3V56.67h3.33a3.44 3.44.0 003.44-3.44V25.31a3.44 3.44.0 00-3.44-3.44h-3.33V17.25h8.3a6.87 6.87.0 016.87 6.87zm-53.4-17.56A17.39 17.39.0 00227.31 7.25H195.1v64h32.21a19.44 19.44.0 0012.38-34.44zM211.63 61.29h-6.08l18.68-44h6.08zM177 36.85A17.39 17.39.0 00164.65 7.25H132.43v64h32.21A19.44 19.44.0 00177 36.85zM149 61.29h-6.08l18.68-44h6.08z" style="fill:#fff;fill-opacity:1"/></svg></span><span class="text-uppercase font-weight-bold">蚂蚁背大象</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/about/><span>Home</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog/><span>Java</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/spring/><span>Spring</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/middlewares/><span>Middleware</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/><span>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/other/><span class=active>Others</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community/><span>Community</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002 站内搜索…" aria-label=站内搜索… autocomplete=off></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/other/>Return to the regular view of this page</a>.</p></div><h1 class=title>Others</h1><ul><li>1: <a href=#pg-5014b92657fcc0426dbfcd2b341fd8fe>Shiro</a></li><ul><li>1.1: <a href=#pg-55aefe613d7848998c1579c9e824a319>Shiro术语</a></li></ul><li>2: <a href=#pg-5010acba27346a41f20238ce70d85bee>Dubbo</a></li><ul><li>2.1: <a href=#pg-108048b6dea706faa21aa8c4066e7fe5>Dubbo源码解析</a></li><ul><li>2.1.1: <a href=#pg-1ae027685242a0951c9636435ef91a70>Dubbo隐式参数</a></li><li>2.1.2: <a href=#pg-abab17c8f67b23c11896ebe64911a6ff>Dubbo Protocol说明</a></li><li>2.1.3: <a href=#pg-a6eed78e18c0e91042c73d5dce6751d5>ExtensionLoader源码解析</a></li><li>2.1.4: <a href=#pg-b34cacfc715c1d8efd4f78f7f3c1135b>ReferenceConfig分析</a></li><li>2.1.5: <a href=#pg-652cd908caaf365ff060d62fc554020c>ServiceConfig源码分析</a></li><li>2.1.6: <a href=#pg-c1c1b3b4b1d2bb00e27cb34ee005caba>自适应机制解析</a></li></ul><li>2.2: <a href=#pg-76de6d247d92294905421acf341dd7a8>Dubbo容错四大利器之—服务目录</a></li><li>2.3: <a href=#pg-33c41505d9c393822a923b9596fbb713>Dubbo元数据</a></li><li>2.4: <a href=#pg-8c14b3b69b7fdc44190bbad9d2162bba>Dubbo容错四大利器之— 服务路由</a></li><li>2.5: <a href=#pg-9a8e8a5bacab88fdcec9f751288fd29e>Dubbo容错四大利器之—集群</a></li><li>2.6: <a href=#pg-691974821e2bc4bfe1b87e9591d412e6>Dubbo框架设计</a></li><li>2.7: <a href=#pg-8fcbe43af4f428e5c9335f9c0064fc03>Config模块分析</a></li><li>2.8: <a href=#pg-1484c515461f0187953d4c24bd98eab0>Dubbo容错四大利器之—负载均衡</a></li></ul><li>3: <a href=#pg-e576977d48d1397f2791280be937d4a0>Git</a></li><ul><li>3.1: <a href=#pg-092880b73f25ee23e8d01762acb39500>如何将本地已有项目关联到github的新建的项目中</a></li><li>3.2: <a href=#pg-ec34fc0ffa6f9c2e572617734f4d7781>Git版本回退</a></li><li>3.3: <a href=#pg-55a8c521e6b929fad4d62890a5901b5c>Git常用命令-Tag</a></li></ul><li>4: <a href=#pg-22d3b6c2b275d6435a01ec3135988ccd>Maven</a></li><ul><li>4.1: <a href=#pg-ba2f6b8953ac7bf92ecd08f22dd38dec>maven-mvnd比maven更快的maven</a></li><li>4.2: <a href=#pg-67760cad93268097d30ecf76c30d9ca2>Maven-自定义archetype</a></li></ul><li>5: <a href=#pg-b2abc3c459aa6755fc84d0f9a37420fa>Mybatis</a></li><ul><li>5.1: <a href=#pg-e7f6382310d7fe7aec09a43ae19591da>深入理解mybatis原理-SQL的执行过程</a></li><li>5.2: <a href=#pg-30532d22a8014280e5253f2624861330>深入理解mybatis原理-MyBatis的架构设计</a></li><li>5.3: <a href=#pg-6f10502e052f2f61f9073d0bbcc16e6e>深入理解mybatis原理-MyBatis配置xml文件解析</a></li></ul><li>6: <a href=#pg-89569d3a1dba3d724fe53ef3c9eba809>数据库</a></li><ul><li>6.1: <a href=#pg-6f62ad977a4908f1d7eaefc2a3050a87>Elasticsearch</a></li><ul><li>6.1.1: <a href=#pg-3ba9b40140caede44a523a63c07edd2a>Elasticsearch Mapping</a></li><ul><li>6.1.1.1: <a href=#pg-9c8e7b95edb840f027d21d643e447743>Elasticsearch-元数据</a></li></ul><li>6.1.2: <a href=#pg-c41f9e3d45e990c68edbb3c5f7588ccf>Elasticsearch 查询DSL</a></li><ul><li>6.1.2.1: <a href=#pg-1bec54c06fd5bfa70738192554abd0f6>复合查询</a></li><ul><li>6.1.2.1.1: <a href=#pg-5842184e8950bd6979597144c6d13ac8>Elasticsearch复合查询-boosting query查询</a></li><li>6.1.2.1.2: <a href=#pg-1f3ccaf409495f5a278314a1a9ecc794>Elasticsearch复合查询-Constant score query查询</a></li><li>6.1.2.1.3: <a href=#pg-abbbba3364147f531a55fc26401e66f1>Elasticsearch复合查询-Boolean查询</a></li><li>6.1.2.1.4: <a href=#pg-5562c7834eadd03c46f44be1321441d0>Elasticsearch复合查询-Disjunction max query</a></li></ul></ul><li>6.1.3: <a href=#pg-fcdebd986e21ba3e19eb2edbfe214887>Elasticsearch 索引</a></li><ul><li>6.1.3.1: <a href=#pg-2a343fe20075bfa2165e414ca1f82ae5>Elasticsearch-索引模式</a></li></ul><li>6.1.4: <a href=#pg-98885c5652d1ba82ef8776e8bf9533ae>elasticsearch基本概念</a></li></ul><li>6.2: <a href=#pg-e22f96dad81fab1e53b89fdf1734542c>mysql</a></li><ul><li>6.2.1: <a href=#pg-e0de2e6771d881b72685715e0f4489b1>mysql命令</a></li><li>6.2.2: <a href=#pg-8eadac371fc406ad90ac0089742b30a3>Mysql基础知识</a></li><ul><li>6.2.2.1: <a href=#pg-e0e58cd7fe078fdb821378315a1476c5>mysql索引1-索引如何组织数据</a></li><li>6.2.2.2: <a href=#pg-98acea010485c71694a9e83d4912ee6a>mysql索引2-索引分类</a></li><li>6.2.2.3: <a href=#pg-b02679d8b8f3028059cd65c9826ccf54>mysql索引3-索引匹配和SQL优化</a></li><li>6.2.2.4: <a href=#pg-53a5a5c185e31e14ab9d9ad9d4075318>MySQL几种索引的区别</a></li><li>6.2.2.5: <a href=#pg-5a47e7eaf772733bc8247b0243ce3c2c>行溢出</a></li><li>6.2.2.6: <a href=#pg-7ed18dddab526c61f5d89c53439c832c>存储引擎</a></li><li>6.2.2.7: <a href=#pg-b2fc20b51acddf5ec8ad59e51421b5c9>MySQL的优化</a></li><li>6.2.2.8: <a href=#pg-660f64ff0579f3e10fffc1e77700b899>MySQL主从复制原理</a></li></ul><li>6.2.3: <a href=#pg-58acaf13a33c364a05ead30153e63893>Mysql笔记</a></li><ul><li>6.2.3.1: <a href=#pg-cc4197811e43cf5e0c00c83a8556def1>Mysql索引</a></li><ul><li>6.2.3.1.1: <a href=#pg-8e3beb10f5e6095a25721e0b7bbc998c>高性能索引策略</a></li><li>6.2.3.1.2: <a href=#pg-169bd172f308a0a4c3a457df80a89b63>索引的类型</a></li></ul><li>6.2.3.2: <a href=#pg-f9260c175af181cb07ecd7cb084b6b9f>Schema与数据类型优化</a></li><li>6.2.3.3: <a href=#pg-6d24780045a900a31f9e66f2c7385438>查询性能优化</a></li></ul><li>6.2.4: <a href=#pg-20551a8a7882f1a25eee5d247ec0ab3b>InnoDB存储引擎</a></li><ul><li>6.2.4.1: <a href=#pg-f2a0a8e4eafd129919af5c5528379592>mysql innodb 索引</a></li><li>6.2.4.2: <a href=#pg-a1aea873df1c160d23c82c62337e6eaf>mysql引擎InnoDB索引中的cardinality关键字</a></li><li>6.2.4.3: <a href=#pg-3eaf90af32116bd141cd90fe3be9087b>InnoDB表</a></li><li>6.2.4.4: <a href=#pg-3d89993c61d8f20a8a16149403b6e11e>Mysql InnoDB 锁</a></li><li>6.2.4.5: <a href=#pg-3c9f466967fc922424da326a0ff058ff>Explain执行计划</a></li><li>6.2.4.6: <a href=#pg-d155293e0ea1bbdd68ce1f35e6841bf9>InnoDb崩溃恢复</a></li></ul><li>6.2.5: <a href=#pg-155860a4dc4a0940b63e2f0aa8a54ac3>mysql使用过程中的问题</a></li><ul><li>6.2.5.1: <a href=#pg-1f5a9d0891eb285c4d6121ce45a1fca1>虚拟机VMware的Linux系统挂起后 docker中的mysql容器无法访问</a></li></ul></ul><li>6.3: <a href=#pg-5675abed06c2c2213ef706d8cf2ed456>建立索引原则</a></li><li>6.4: <a href=#pg-73c555a203186678c06e0a28ba8fb9e0>数据库事务</a></li><li>6.5: <a href=#pg-ed38975c43e54aaba853e41a00f4f0f8>范式和反范式</a></li></ul><li>7: <a href=#pg-d1d1d686a8b969063ba3bf1f04df1f05>数据结构</a></li><ul><li>7.1: <a href=#pg-659d4e3b23970a9bfe18a52f8a854c36>二叉搜索树</a></li><li>7.2: <a href=#pg-1c065ee55b7d20e668419cbfe55f7501>二叉树</a></li><li>7.3: <a href=#pg-5cd0867366aea565f1b236552c237316>红黑树</a></li></ul><li>8: <a href=#pg-090364dd405b90a6c7c191a20498d139>算法</a></li><ul><li>8.1: <a href=#pg-6e35430cee89ef0ca47e69f2f0ae158b>排序算法</a></li><ul><li>8.1.1: <a href=#pg-b3794a05f355f8ecc97b5e9806758a50>冒泡排序</a></li><li>8.1.2: <a href=#pg-62835df1451a381a241acde6c0e15b97>排序算法</a></li><li>8.1.3: <a href=#pg-38500cbb1c4e42b688afa8f96e2b8aca>归并排序</a></li><li>8.1.4: <a href=#pg-2f05a743566e6c750d0be3cd5e0972fd>希尔排序</a></li><li>8.1.5: <a href=#pg-1ad6d68c98ce88e48a6d6566c0d6edfe>快速排序</a></li><li>8.1.6: <a href=#pg-735b608d61481fddcb9e9ede7da09b05>选择排序</a></li><li>8.1.7: <a href=#pg-f21220cdadaf1a797011cad847878ed7>插入排序</a></li></ul><li>8.2: <a href=#pg-876b05e357fd8c99a0d1c64c94267c15>五大基本算法</a></li><ul><li>8.2.1: <a href=#pg-feca5839cfd8a5ba920967fc9e27ac76>五大基本算法之动态规划</a></li></ul><li>8.3: <a href=#pg-f52df178d3d079d8fafa13604420162f>图遍历</a></li><ul><li>8.3.1: <a href=#pg-28d7791bc2a0760bad8784aa4f2aa45c>深度优先搜索-DFS</a></li><li>8.3.2: <a href=#pg-36e33cd7ef4e80e065f355ebd2c5790d>广度优先搜索-BFS</a></li></ul></ul><li>9: <a href=#pg-cebc6b122c30d87786a63800a65ec6c4>设计模式</a></li><ul><li>9.1: <a href=#pg-376a1b92b0507ae2078343d7d408095b>创建模式</a></li><ul><li>9.1.1: <a href=#pg-24b630be7e6d0a9add2d0b66fe64082c>抽象工厂模式</a></li><li>9.1.2: <a href=#pg-e759425ba3d122b481d9b50147a09d97>工厂方法模式</a></li><li>9.1.3: <a href=#pg-40f79de50d94dea1afc39110713e0025>建造者模式</a></li><li>9.1.4: <a href=#pg-6f17de29496589b65379e33c7add2fa8>简单工厂模式</a></li><li>9.1.5: <a href=#pg-2644f3f07de5207176e7ca9b73f957c0>单例模式</a></li></ul><li>9.2: <a href=#pg-50e096c6c8d0a3f281ccec816b8c9ea1>结构模式</a></li><ul></ul><li>9.3: <a href=#pg-4eeec0bdc3a006fb0b6ac7419084e828>行为模式</a></li><ul><li>9.3.1: <a href=#pg-17f49ae48771b9df7cdead51dc753900>适配器模式</a></li></ul><li>9.4: <a href=#pg-05fecb92b9230fd54b405ee6b4a899d3>看懂UML图</a></li></ul><li>10: <a href=#pg-1aca59aba33ca367ec7d4120a9ee45b1>IntelliJ IDEA</a></li><ul><li>10.1: <a href=#pg-0e1bd03bcd985b7f9bb31e27786cec42>IntelliJ IDEA常用设置</a></li><li>10.2: <a href=#pg-3145767a18767487b291575dc4617873>IntelliJ IDEA那些不常用但很有用技巧</a></li></ul><li>11: <a href=#pg-9366bab765273e7ef4ad0343ffc16a58>单点登录</a></li><ul><li>11.1: <a href=#pg-7bbbadfdfaaf6b67c8838adcab09819e>CAS Docker部署</a></li></ul><li>12: <a href=#pg-3b6fba77103ab4932e501dbb5b00ac81>开发工具</a></li><ul><li>12.1: <a href=#pg-2125a657bd64dc63240a60bd728448d3>Arthas使用实践-方法性能调优</a></li><li>12.2: <a href=#pg-a3a86ab82262e21932a7d11397e80c8d></a></li></ul><li>13: <a href=#pg-5871a6806b962bc5d80731ad5f2ca911>Windows WSL让你告别VMware</a></li><li>14: <a href=#pg-ff23825a2db2dc09b20ea38c53e4d4c0>序列化</a></li><ul><li>14.1: <a href=#pg-abae75c0fe02936f0701d52b0744822f>fastjson序列化脱敏实现</a></li></ul><li>15: <a href=#pg-afdf357f4372abfc47c4b3dbc42d5a79>OAuth2</a></li><ul><li>15.1: <a href=#pg-0b895f1aa34cce4d6e5b1806510f375c>从IETF规范理解OAuth 2.0</a></li><li>15.2: <a href=#pg-151f08c12cb3b07b8a7b120b75f12cd0>OAuth2-授权码模式图解(Authorization Code Grant)</a></li><li>15.3: <a href=#pg-f84d73d54dd0f743c30df3592b14b6bb>OAuth2-隐式授权详解(Implicit Grant)</a></li></ul><li>16: <a href=#pg-33d6b9722483b2dfb277435709dba898>分布式文件系统MinIO环境的搭建</a></li><li>17: <a href=#pg-c6fb5a2738e2e578ffa268fc796aa8a9>“如何快速搭建Java项目开发环境"</a></li><li>18: <a href=#pg-4d5e4bbfdc472bee3a77574339202d36>JMeter+Faker让测试数据生成自动化</a></li><li>19: <a href=#pg-b46e004c4cc4af43f4b8ecb55ca85470>开发中分布式锁和本地锁如何取舍</a></li><li>20: <a href=#pg-82d6bfc6323de0127e964f116bd2223f>理论实现</a></li><ul><li>20.1: <a href=#pg-9f7f974253ec7fa2bab97d1478cc1eb0>时间轮-理论篇</a></li><li>20.2: <a href=#pg-2bfcd508e672bb4651f09cc91104e418>时间轮-实现篇</a></li><li>20.3: <a href=#pg-157758a244ffd7ac57dcef368f41f9d1>分布式一致性算法Raft-理论篇</a></li></ul><li>21: <a href=#pg-2fc91697d64acc0334143a3b414e7ba0>“如何使用GitHub Actions自动发布JAR到Maven中央仓库"</a></li></ul><div class=content></div></div><div class=td-content><h1 id=pg-5014b92657fcc0426dbfcd2b341fd8fe>1 - Shiro</h1></div><div class=td-content><h1 id=pg-55aefe613d7848998c1579c9e824a319>1.1 - Shiro术语</h1><h3 id=1-authentication>1. Authentication</h3><p>身份验证是验证主体身份的过程-本质上是证明某人确实是他们所说的真实身份。身份验证尝试成功后，应用程序可以相信可以保证主题是应用程序期望的对象</p><h3 id=2-authorization>2. Authorization</h3><p>授权，也称为访问控制，是确定是否允许用户/主题做某事的过程。通常，通过检查和解释主体的角色和权限(请参见下文)，然后允许或拒绝对请求的资源或功能的访问来完成此任务</p><h3 id=3-cipher>3. Cipher</h3><p>密码是进行加密或解密的一种算法。该算法一般依赖于一块被称为 key 的信息。基于不同的key 的加密算法也是不一样的，所有解密没有它是非常困难的。 密码有不同的表现形式。分组密码致力于符号块，通常是固定大小的，而流密码致力于连续的符号流。对称性密码加密和解密使用相同的密钥（key），而非对称性加密使用不同的密钥。如果非对称性加密的密钥不能从其他地方得到，那么可以创建公钥/私钥对公开共享</p><h3 id=4-credential>4. <strong>Credential</strong></h3><p>凭证是一块信息，用来验证 user/Subject 的身份。在认证尝试期间，一个（或多个）凭证与 Principals(s)被一同提交，来验证 user/Subject 所提交的确实是所关联的用户。证书通常是非常秘密的东西，只有特定的 user/Subject 才知道，如密码或 PGP 密钥或生物属性或类似的机制。 这个想法是为 principal 设置的，只有一个人会知道正确的证书来“匹配”该 principal。如果当前 user/Subject 提供了正确的凭证匹配了存储在系统中的，那么系统可以假定并信任当前user/Subject 是真的他们所说的他们是谁。信任度随着更安全的凭证类型加深（如，生物识别签名 > 密码）</p><h3 id=5-cryptography>5. <strong>Cryptography</strong></h3><p>加密是保护信息不受不希望的访问的习惯做法，通过隐藏信息或将它转化成无意义的东西，这样没人可以理解它。Shiro 致力于加密的两个核心要素：加密数据的密码，如使用公钥或私钥的邮件，以及散列表（也称消息摘要），它对数据进行不可逆的加密，如密码</p><h3 id=6-hash>6. <strong>Hash</strong></h3><p>散列函数是单向的，不可逆转的输入源，有时也被称为消息，在一个编码的哈希值内部，有时也被称为消息摘要。它通常用于密码，数字指纹，或以字节数组为基础的数据。</p><h3 id=7-permission>7. <strong>Permission</strong></h3><p>权限，至少按照 Shiro 的解释，是在应用程序中描述原始功能的一份声明并没有更多的功能。权限是在安全策略中最低级别的概念。它们仅定义了应用程序能够做“什么”。它们没有说明“谁”能够执行这些操作。权限只是行为的声明，仅此而已。 一些权限的例子：</p><ul><li>打开文件</li><li>浏览'/user/list&rsquo;页面</li><li>打印文档</li><li>删除&rsquo;jsmith&rsquo;用户</li></ul><h3 id=8-principal>8. <strong>Principal</strong></h3><p>rincipal 是一个应用程序用户（Subject）的任何标志属性。“标志属性”可以是任何对你应用程序有意义的东西——用户名，姓，名，社会安全号码，用户ID 等。这就是它——没什么古怪的。Shiro 也引用一些我们称之为Subject 的 primary principal 的东西。一个 primary principal 是在整个应用程序中唯一标识 Subject 的 principal。理想的 primary principal 是用户名或 RDBMS 用户表主键——用户 ID。对于在应用 程序中的用户（Subject）来说，只有一个primary principal</p><h3 id=9-realm>9. Realm</h3><p>Realm 是一个能够访问应用程序特定的安全数据（如用户，角色和权限）的组件。它可以被看作是一个特定安全的 DAO（Data Access Object）。Realm 将这些应用程序特定的数据转换成 Shiro 能够理解的格式，这样Shiro 反过来能够提供一个单一的易于理解的 Subject 编程API，无论有多少数据源存在或无论你的数据是什么样的应用程序特定的格式。 Realm 通常和数据源是一对一的对应关系，如关系数据库，LDAP 目录，文件系统，或其他类似资源。因此，Realm 接口的实现使用数据源特定的API 来展示授权数据（角色，权限等），如JDBC，文件IO，Hibernate 或 JPA，或其他数据访问API</p><h3 id=10-role>10. <strong>Role</strong></h3><p>基于你对话的对象，一个角色的定义是可以多变的。在许多应用程序中，它充其量是个模糊不清的概念，人们用它来隐式定义安全策略。Shiro 偏向于把角色简单地解释为一组命名的权限的集合。这就是它——一个应用程序的唯一名称，聚集一个或多个权限声明。 这是一个比许多应用程序使用的隐式的定义更为具体的定义。如果你选择了你的数据模型反映Shiro 的假设，你会发现将有更多控制安全策略的权力。</p><h3 id=11-session>11. <strong>Session</strong></h3><p>会话是一个在一段时间内有状态的数据，其上下文与一个单一的与软件系统交互的user/Subject 相关联。当 Subject 使用应用程序时，能够从会话中添加/读取/删除数据，并且应用程序稍后能够在需要的地方使用该数据。会话会被终止，由于user/Subject 注销或会话不活动而超时。 对于那些熟悉 HttpSession 的，Shiro Session 服务于同一目标，除了Shiro 会话能够在任何环境下使用，甚至在没有Servlet 容器或EJB 容器的环境</p><h3 id=12-subject>12. <strong>Subject</strong></h3><p>Subject 只是一个精挑细选的安全术语，基本上的意思是一个应用程序用户的安全特定的“视图”。然而 Subject 不总是需要反映为一个人——它可以代表一个调用你应用程序的外部进程，或许是一个系统帐户的守护进程， 在一段时间内执行一些间歇性的东西（如一个cron job）。它基本上是任何使用应用程序做某事的实体的一个代表</p></div><div class=td-content style=page-break-before:always><h1 id=pg-5010acba27346a41f20238ce70d85bee>2 - Dubbo</h1></div><div class=td-content><h1 id=pg-108048b6dea706faa21aa8c4066e7fe5>2.1 - Dubbo源码解析</h1></div><div class=td-content><h1 id=pg-1ae027685242a0951c9636435ef91a70>2.1.1 - Dubbo隐式参数</h1><div class=lead>通过 Dubbo 中的 Attachment 在服务消费方和提供方之间隐式传递参数</div><blockquote><p>Dubbo版本：2.7.8</p></blockquote><h3 id=1-隐式参数>1. 隐式参数</h3><p>通过 Dubbo 中的 Attachment 在服务消费方和提供方之间隐式传递参数。</p><p>可以通过 <code>RpcContext</code> 上的 <code>setAttachment</code> 和 <code>getAttachment</code> 在服务消费方和提供方之间进行参数的隐式传递。</p><blockquote><p><strong><code>path</code></strong>, <strong><code>interface</code></strong> ,<strong><code>group</code></strong> ,<strong><code>version</code></strong> ,<strong><code>dubbo</code></strong> ,<strong><code>token</code></strong> ,<strong><code>timeout</code></strong> ,<strong><code>_TO</code></strong> ,<strong><code>async</code></strong> ,<strong><code>dubbo.tag</code></strong> ,<strong><code>dubbo.force.tag</code></strong> 保留字段，请使用其它值。保留字段的代码可以查看 <strong><code>ContextFilter</code></strong></p></blockquote><p><img src="https://github.com/mxsm/picture/blob/main/dubbo/context.png?raw=true" alt=原理图示></p><h3 id=2在服务消费方端设置隐式参数>2.在服务消费方端设置隐式参数</h3><p><code>setAttachment</code> 设置的 KV 对，在完成下面一次远程调用会被清空，即多次远程调用要多次设置。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>RpcContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getContext</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>setAttachment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;index&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// 隐式传参，后面的远程调用都会隐式将这些参数发送到服务器端，类似cookie，用于框架集成，不建议常规业务使用
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>xxxService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>xxx</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>// 远程调用
</span><span style=color:#8f5902;font-style:italic>// ...
</span></code></pre></div><h3 id=3-在服务提供方端获取隐式参数>3. 在服务提供方端获取隐式参数</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>XxxServiceImpl</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>XxxService</span> <span style=color:#ce5c00;font-weight:700>{</span>
 
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>xxx</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 获取客户端隐式传入的参数，用于框架集成，不建议常规业务使用
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>String</span> <span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RpcContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getContext</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getAttachment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;index&#34;</span><span style=color:#ce5c00;font-weight:700>);</span> 
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=4-rpccontext源码解析>4. RpcContext源码解析</h3><p>通过 <strong>RpcContext.getContext().setAttachment(&ldquo;index&rdquo;, &ldquo;1&rdquo;)</strong> 方法来从这里入手分析一下</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>RpcContext</span> <span style=color:#000>getContext</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>LOCAL</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>RpcContext</span> <span style=color:#000>setAttachment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>setObjectAttachment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Experimental</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Experiment api for supporting Object transmission&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>RpcContext</span> <span style=color:#000>setObjectAttachment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>attachments</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>attachments</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过上面代码可以看出来从 LOCAL变量中获取RpcContext, 然后设置数据到attachments(Map类型，Key 为String,Value为Object)变量中。这个变量属于RpcContext的私有变量。</p><p>在RpcContext中存在两个静态变量：</p><ul><li><p>LOCAL</p><p>保存请求的RpcContext</p></li><li><p>SERVER_LOCAL</p><p>保存响应的RpcContext</p></li></ul><p><strong><code>InternalThreadLocal</code></strong> 是Dubbo内部实现的一个本地线程变量保存数据和Java的ThreadLocal有异曲同工之妙。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-abab17c8f67b23c11896ebe64911a6ff>2.1.2 - Dubbo Protocol说明</h1><h3 id=1protocol接口>1.Protocol接口</h3><p>代码中的注释解释该类是API和SPI的，并且是一个单例模式，线程安全的接口。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@SPI</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;dubbo&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Protocol</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>//获取协议的默认端口
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>getDefaultPort</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#8f5902;font-style:italic>//服务输出
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Adaptive</span>
    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Exporter</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>export</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Invoker</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>invoker</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>RpcException</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>//远程服务引用
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Adaptive</span>
    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Invoker</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>refer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>URL</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>RpcException</span><span style=color:#ce5c00;font-weight:700>;</span>
   
    <span style=color:#8f5902;font-style:italic>//协议销毁
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>destroy</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#8f5902;font-style:italic>//获取
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ProtocolServer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getServers</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Collections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>emptyList</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在Dubbo的Protocol接口实现类中有三个比较特殊的三个：</p><ul><li><p><strong>ProtocolFilterWrapper</strong></p><p><a href=https://dubbo.apache.org/zh-cn/blog/first-dubbo-filter.html>对于Filter可以看一下官方的说明</a></p></li><li><p><strong>ProtocolListenerWrapper</strong></p><p>官方对此并没有介绍</p></li><li><p><strong>QosProtocolWrapper</strong></p><p><a href=http://dubbo.apache.org/zh-cn/blog/introduction-to-dubbo-qos.html>官方对于Qos的介绍</a></p></li></ul><p>首先这三个类在Dubbo中有一个统称叫做包装类。对于包装类在进行拓展加载的时候会进行特殊处理。<a href=http://dubbo.apache.org/zh-cn/blog/introduction-to-dubbo-spi-2.html>官方对Wrapper类的介绍</a></p><h3 id=2-protocol如何实例化>2. Protocol如何实例化</h3><p>从 <em><strong>ServiceConfig</strong></em> 类的静态属性 <em><strong>protocol</strong></em> 来进行分析：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ServiceConfig</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ServiceConfigBase</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

    
     <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Protocol</span> <span style=color:#000>protocol</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ExtensionLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getExtensionLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Protocol</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getAdaptiveExtension</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过方法可以看出来 <em><strong>ExtensionLoader</strong></em> 类加载的。看一下 <em><strong>ExtensionLoader#getAdaptiveExtension</strong></em> 方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>T</span> <span style=color:#000>getAdaptiveExtension</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Object</span> <span style=color:#000>instance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cachedAdaptiveInstance</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instance</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>createAdaptiveInstanceError</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Failed to create adaptive instance: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                        <span style=color:#000>createAdaptiveInstanceError</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>(),</span>
                        <span style=color:#000>createAdaptiveInstanceError</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cachedAdaptiveInstance</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>instance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cachedAdaptiveInstance</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instance</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>//这个方法是主要的方法
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>instance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createAdaptiveExtension</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#000>cachedAdaptiveInstance</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instance</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>createAdaptiveInstanceError</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Failed to create adaptive instance: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>instance</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过分析方法 <em><strong>getAdaptiveExtension</strong></em> 可以发现获取实例是通过 <em><strong>createAdaptiveExtension</strong></em> 方法。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>T</span> <span style=color:#000>createAdaptiveExtension</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>injectExtension</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>getAdaptiveExtensionClass</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Can&#39;t create adaptive extension &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;, cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>获取 <em><strong>getAdaptiveExtensionClass()</strong></em> 来获取类。最后生成Java类。关注一下一个私有方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>T</span> <span style=color:#000>createExtension</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>clazz</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getExtensionClasses</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>findException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>T</span> <span style=color:#000>instance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>EXTENSION_INSTANCES</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instance</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>EXTENSION_INSTANCES</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putIfAbsent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#000>instance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>EXTENSION_INSTANCES</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#000>injectExtension</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instance</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>wrapperClasses</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cachedWrapperClasses</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CollectionUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isNotEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wrapperClasses</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>//包装类的处理
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>wrapperClass</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>wrapperClasses</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>instance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>injectExtension</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>wrapperClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConstructor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instance</span><span style=color:#ce5c00;font-weight:700>));</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#000>initExtension</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instance</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>instance</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Extension instance (name: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;, class: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                    <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;) couldn&#39;t be instantiated: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面代码有一段处理Wrapper类。之前已经由链接说明了Dubbo中的包装类的说明(已自身为构造函数的类称为Wrapper类)。<br>所以在获取 <em><strong>Protocol</strong></em> 实现的时候会记载出来 <em><strong>Protocol</strong></em> 的Wrapper类。也就是上面说的三个主要类。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-a6eed78e18c0e91042c73d5dce6751d5>2.1.3 - ExtensionLoader源码解析</h1><h3 id=extensionloader源码解析dubbo-271版本>ExtensionLoader源码解析(Dubbo-2.7.1版本)</h3><p>首先看一下 <strong><code>ExtensionLoader</code></strong> 源码中的类的变量,变量分为两类:</p><ul><li><p>私有的静态变量</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#8f5902;font-style:italic>//下面的三个变量是拓展了JAVA的SPI
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>//JAVA标准的SPI存放的目录 Dubbo也会去扫描这个目录但是下面的文件格式是按照Dubbo的格式来的
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>SERVICES_DIRECTORY</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;META-INF/services/&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#8f5902;font-style:italic>//用户自定义的拓展放在这个目录
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>DUBBO_DIRECTORY</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;META-INF/dubbo/&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#8f5902;font-style:italic>//Dubbo内部实现的拓展问价放在这个目录
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>DUBBO_INTERNAL_DIRECTORY</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>DUBBO_DIRECTORY</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;internal/&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>

      <span style=color:#8f5902;font-style:italic>//类命名正则表达式
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Pattern</span> <span style=color:#000>NAME_SEPARATOR</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Pattern</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;\\s*[,]+\\s*&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>//接口对应的ExtensionLoader的缓存
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ConcurrentMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;,</span> <span style=color:#000>ExtensionLoader</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>EXTENSION_LOADERS</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConcurrentHashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
      <span style=color:#8f5902;font-style:italic>//接口对应的实现的实例对象缓存
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ConcurrentMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>EXTENSION_INSTANCES</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConcurrentHashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
</code></pre></div></li><li><p>对象的私有变量</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>      <span style=color:#8f5902;font-style:italic>//拓展的接口Class
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>//拓展使用的工厂
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ExtensionFactory</span> <span style=color:#000>objectFactory</span><span style=color:#ce5c00;font-weight:700>;</span>

      <span style=color:#8f5902;font-style:italic>//类和名称的缓存
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ConcurrentMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>cachedNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConcurrentHashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
      <span style=color:#8f5902;font-style:italic>//加载type类型接口实现的名称和类的缓存
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Holder</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;&gt;</span> <span style=color:#000>cachedClasses</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Holder</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
      <span style=color:#8f5902;font-style:italic>//缓存带有@Activate注解的对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>cachedActivates</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConcurrentHashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
    <span style=color:#8f5902;font-style:italic>//缓存实例
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ConcurrentMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Holder</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>cachedInstances</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConcurrentHashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
      <span style=color:#8f5902;font-style:italic>//保存带有@Adaptive注解的对象实例
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Holder</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>cachedAdaptiveInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Holder</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
      <span style=color:#8f5902;font-style:italic>//保存带有@Adaptive注解的class
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>cachedAdaptiveClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#8f5902;font-style:italic>//缓存的默认名称--获取SPI注解的value值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>cachedDefaultName</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Throwable</span> <span style=color:#000>createAdaptiveInstanceError</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#8f5902;font-style:italic>//保存包装classes
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>cachedWrapperClasses</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>exceptions</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConcurrentHashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
</code></pre></div></li></ul><p>从代码中随便找出一个该类的使用方式来对类进行进一步分析，选取 <strong><code>ServiceConfig</code></strong> 类中的一段代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Protocol</span> <span style=color:#000>protocol</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ExtensionLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getExtensionLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Protocol</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getAdaptiveExtension</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div><ul><li>首先用过 <strong><code>ExtensionLoader</code></strong> 调用静态方法 <strong><code>getExtensionLoader</code></strong></li><li>获取到 <strong><code>ExtensionLoader</code></strong> 对象后调用对象的 <strong><code>getAdaptiveExtension</code></strong> 方法(还有其他的类似方法这是其中的一个)</li><li>最后获取到 <strong><code>Protocol</code></strong> 的实际对象</li></ul><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ExtensionLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>type</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>;</span>
   			<span style=color:#8f5902;font-style:italic>//这段代码下面进行分析
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>objectFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>ExtensionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>ExtensionLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getExtensionLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ExtensionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getAdaptiveExtension</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从上面的代码可以看出来 <strong><code>ExtensionLoader</code></strong> 的构造函数为私有的。所以外部不能进行创建该对象。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>ExtensionLoader</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getExtensionLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Extension type == null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
   			<span style=color:#8f5902;font-style:italic>//判断了是否为接口
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInterface</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Extension type (&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;) is not an interface!&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
   			<span style=color:#8f5902;font-style:italic>//判断是否含有Dubbo自定义的@SPI注解
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>withExtensionAnnotation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Extension type (&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>+</span>
                    <span style=color:#4e9a06>&#34;) is not an extension, because it is NOT annotated with @&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>SPI</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSimpleName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;!&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
				
   			<span style=color:#8f5902;font-style:italic>//首先从静态变量的缓存中获取
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>ExtensionLoader</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>loader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ExtensionLoader</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#000>EXTENSION_LOADERS</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>loader</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          	<span style=color:#8f5902;font-style:italic>//不存在创建放入缓存
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>EXTENSION_LOADERS</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putIfAbsent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ExtensionLoader</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#000>loader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ExtensionLoader</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#000>EXTENSION_LOADERS</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>loader</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>withExtensionAnnotation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAnnotationPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SPI</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>正如上面的调用是通过调用 <strong><code>ExtensionLoader</code></strong> 的静态方法 <strong>getExtensionLoader(Class<t> type)</strong> 来获取对应type的 <strong><code>ExtensionLoader</code></strong> 对象。所以从上面可以看出来要能生成 <strong><code>ExtensionLoader</code></strong> 对象需要满足一下几个条件：</p><ul><li><strong>type一定要是接口(interface)</strong></li><li><strong>type接口上面一定要包含@SPI注解</strong></li></ul><p>通过调用以后生成了type接口对应的 <strong><code>ExtensionLoader</code></strong> 对象，然后接下来看对象调用对象的 <strong><code>getAdaptiveExtension</code></strong> 方法。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>T</span> <span style=color:#000>getAdaptiveExtension</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
      	<span style=color:#8f5902;font-style:italic>//首先从缓存的Holder对象中获取Adaptive对象
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Object</span> <span style=color:#000>instance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cachedAdaptiveInstance</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
      	<span style=color:#8f5902;font-style:italic>//获取的dubbo check
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instance</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>createAdaptiveInstanceError</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cachedAdaptiveInstance</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                  	<span style=color:#8f5902;font-style:italic>//再一次获取
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>instance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cachedAdaptiveInstance</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instance</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>instance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createAdaptiveExtension</span><span style=color:#ce5c00;font-weight:700>();</span>
                          	<span style=color:#8f5902;font-style:italic>//存入缓存
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#000>cachedAdaptiveInstance</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instance</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>createAdaptiveInstanceError</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#8f5902;font-style:italic>//throw ex
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>//throw ex
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>instance</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>//对象cachedAdaptiveInstance用的是这个对象持有的
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Holder</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>//使用了关键字volatile保证可见性
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>T</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>T</span> <span style=color:#000>get</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从上面的代码看一下获取的步骤：</p><ul><li><strong>首先从缓存对象</strong> <strong><code>cachedAdaptiveInstance</code></strong> <strong>来获取合适的拓展类</strong></li><li><strong>如果获取拓展类不存在就开始创建(dubbo check)</strong></li><li><strong>调用</strong> <strong><code>createAdaptiveExtension</code></strong> <strong>方法进行创建对象并且放入</strong> <strong><code>cachedAdaptiveInstance</code></strong> <strong>缓存起来</strong></li></ul><p>接下里看一下 <strong><code>createAdaptiveExtension</code></strong> 方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>T</span> <span style=color:#000>createAdaptiveExtension</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
          	<span style=color:#8f5902;font-style:italic>//这里分为了两个方法一个是：(T) getAdaptiveExtensionClass().newInstance()
</span><span style=color:#8f5902;font-style:italic></span>          	<span style=color:#8f5902;font-style:italic>//获取对应的类进行实例化，injectExtension对对象进行注入对应的私有变量引用
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>injectExtension</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>getAdaptiveExtensionClass</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Can&#39;t create adaptive extension &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;, cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#8f5902;font-style:italic>//那么看一下injectExtension方法
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>T</span> <span style=color:#000>injectExtension</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span> <span style=color:#000>instance</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
          	<span style=color:#8f5902;font-style:italic>//首先判断ExtensionFactory是否为空
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>objectFactory</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Method</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>instance</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getMethods</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                  	<span style=color:#8f5902;font-style:italic>//判断方法是否是set开头的方法
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isSetter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                      	<span style=color:#8f5902;font-style:italic>//判断是否带有@DisableInject注解--表示不允许注入
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAnnotation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DisableInject</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#204a87;font-weight:700>continue</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                      	<span style=color:#8f5902;font-style:italic>//获取要注入的对象的class
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>pt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterTypes</span><span style=color:#ce5c00;font-weight:700>()[</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>];</span>
                      	<span style=color:#8f5902;font-style:italic>//排除基本类
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ReflectUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isPrimitives</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pt</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#204a87;font-weight:700>continue</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                          	<span style=color:#8f5902;font-style:italic>//返回set后面的名称
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#000>String</span> <span style=color:#000>property</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSetterProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#000>Object</span> <span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>objectFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getExtension</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pt</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                              	<span style=color:#8f5902;font-style:italic>//注入
</span><span style=color:#8f5902;font-style:italic></span>                                <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                           <span style=color:#8f5902;font-style:italic>// throw ex
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>instance</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div><p>从上面的代码可以看出 <strong><code>createAdaptiveExtension</code></strong> 主要有两个步骤：</p><ul><li><strong>生成对应的拓展类对象</strong></li><li><strong>调用</strong> <strong><code>injectExtension</code></strong> <strong>将生成的类对象注入set方法的注入(递归调用)</strong></li></ul><p>动态注入上面的代码已经分析了，下面来分析 <strong><code>getAdaptiveExtensionClass</code></strong> 方法如何来获取拓展类的Class</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>getAdaptiveExtensionClass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//获取拓展类
</span><span style=color:#8f5902;font-style:italic></span>   			<span style=color:#000>getExtensionClasses</span><span style=color:#ce5c00;font-weight:700>();</span>
   			<span style=color:#8f5902;font-style:italic>//判断是否有缓存的拓展类
</span><span style=color:#8f5902;font-style:italic></span>   			<span style=color:#8f5902;font-style:italic>// private volatile Class&lt;?&gt; cachedAdaptiveClass = null; 含有关键字
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cachedAdaptiveClass</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>cachedAdaptiveClass</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
   			<span style=color:#8f5902;font-style:italic>//创建缓存拓展类
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>cachedAdaptiveClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createAdaptiveExtensionClass</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面主要也是有三个步骤：</p><ul><li><p><strong>调用</strong> <strong><code>getExtensionClasses</code></strong> <strong>方法 获取type对应的拓展类</strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>getExtensionClasses</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//首先从之前的缓存获取
</span><span style=color:#8f5902;font-style:italic></span>              <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>classes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cachedClasses</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>classes</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cachedClasses</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>classes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cachedClasses</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>classes</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                      <span style=color:#8f5902;font-style:italic>//不存在通过调用loadExtensionClasses()来加载
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>classes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>loadExtensionClasses</span><span style=color:#ce5c00;font-weight:700>()</span> 
                    <span style=color:#000>cachedClasses</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>classes</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>classes</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#8f5902;font-style:italic>//从对应的文件下记载SPI对应的数据 -- 这里就用到之前的三个静态变量
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>loadExtensionClasses</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>//获取默认的拓展的名称--获取注解@SPI的value值
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>cacheDefaultExtensionName</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>extensionClasses</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
          <span style=color:#8f5902;font-style:italic>//loadDirectory方法就是去文件中加载对应的数据符合文件命名符合java的
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#8f5902;font-style:italic>//SPI规范
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>extensionClasses</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>DUBBO_INTERNAL_DIRECTORY</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>loadDirectory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>extensionClasses</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>DUBBO_INTERNAL_DIRECTORY</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>replace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.apache&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;com.alibaba&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#000>loadDirectory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>extensionClasses</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>DUBBO_DIRECTORY</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>loadDirectory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>extensionClasses</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>DUBBO_DIRECTORY</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>replace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.apache&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;com.alibaba&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#000>loadDirectory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>extensionClasses</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SERVICES_DIRECTORY</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>loadDirectory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>extensionClasses</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SERVICES_DIRECTORY</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>replace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.apache&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;com.alibaba&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>extensionClasses</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>cacheDefaultExtensionName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SPI</span> <span style=color:#000>defaultAnnotation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAnnotation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SPI</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>defaultAnnotation</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>String</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>defaultAnnotation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trim</span><span style=color:#ce5c00;font-weight:700>()).</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>names</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>NAME_SEPARATOR</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>split</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>names</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;More than 1 default extension name on extension &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span>
                            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>names</span><span style=color:#ce5c00;font-weight:700>));</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>names</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>cachedDefaultName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>names</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>];</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从上面可以看出主要进行了两个步骤的操作：</p><ul><li><p>获取 cacheDefaultExtensionName 默认名称从接口的@SPI注解上，如果没有就是null</p><p>比如下面的两个接口：</p><ul><li><strong><code>Protocol</code></strong> 接口的 <strong><code>cacheDefaultExtensionName=dubbo</code></strong></li></ul><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@SPI</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;dubbo&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Protocol</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>getDefaultPort</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#5c35cc;font-weight:700>@Adaptive</span>
    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Exporter</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>export</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Invoker</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>invoker</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>RpcException</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@Adaptive</span>
    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Invoker</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>refer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>URL</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>RpcException</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>destroy</span><span style=color:#ce5c00;font-weight:700>();</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul><li><p><strong><code>ExtensionFactory</code></strong> 接口 <strong><code>cacheDefaultExtensionName</code></strong> 就是null</p><pre><code>@SPI
public interface ExtensionFactory {

    &lt;T&gt; T getExtension(Class&lt;T&gt; type, String name);

}
</code></pre></li></ul></li><li><p>通过 <strong><code>loadDirectory</code></strong> 来获取对应的type接口的实现类</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>loadDirectory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>extensionClasses</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>dir</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//从之前定义的SPI的三个目录中进行查找数据
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>String</span> <span style=color:#000>fileName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>dir</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>//比如 type.getName() = org.apache.dubbo.rpc.Protocol  
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Enumeration</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>net</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>URL</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>urls</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>ClassLoader</span> <span style=color:#000>classLoader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>findClassLoader</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>classLoader</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>urls</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>classLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResources</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fileName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>urls</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ClassLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSystemResources</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fileName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>urls</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>urls</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasMoreElements</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>net</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>URL</span> <span style=color:#000>resourceURL</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>urls</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nextElement</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#8f5902;font-style:italic>//加载资源
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>loadResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>extensionClasses</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>classLoader</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resourceURL</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
           <span style=color:#8f5902;font-style:italic>//throw ex
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>下面来看一下 <strong><code>loadResource</code></strong> 如何加载资源的。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>loadResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>extensionClasses</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ClassLoader</span> <span style=color:#000>classLoader</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>net</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>URL</span> <span style=color:#000>resourceURL</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//一行一行的读取数据项目中的结构如下图
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BufferedReader</span> <span style=color:#000>reader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BufferedReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InputStreamReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resourceURL</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>openStream</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>StandardCharsets</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>UTF_8</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>String</span> <span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>line</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>reader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readLine</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ci</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>indexOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;#&#39;</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ci</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>line</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>substring</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ci</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#000>line</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trim</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>String</span> <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>indexOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;=&#39;</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>substring</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>trim</span><span style=color:#ce5c00;font-weight:700>();</span>
                                <span style=color:#000>line</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>substring</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>trim</span><span style=color:#ce5c00;font-weight:700>();</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>
                            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#000>loadClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>extensionClasses</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resourceURL</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>classLoader</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                           <span style=color:#8f5902;font-style:italic>//错误处理
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//错误打印
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><img src="https://github.com/mxsm/document/blob/master/image/RPC/Dubbo/Dubbo%E5%8A%A8%E6%80%81%E7%94%9F%E6%88%90%E9%80%82%E9%85%8D%E5%AF%B9%E8%B1%A1%E8%AF%B4%E6%98%8E%E6%88%AA%E5%9B%BE.jpg?raw=true" alt=图></p><p>下面来看 <strong><code>loadClass</code></strong> 方法是如何处理的</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>loadClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>extensionClasses</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>net</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>URL</span> <span style=color:#000>resourceURL</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>NoSuchMethodException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//判断继承关系
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAssignableFrom</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
           <span style=color:#8f5902;font-style:italic>//throw ex
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#8f5902;font-style:italic>//判断实现类上面是否含有@Adaptive注解--比如下面两个类有：
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//AdaptiveExtensionFactory  AdaptiveCompiler都有
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAnnotationPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Adaptive</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//设置变量cachedAdaptiveClass的值
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>cacheAdaptiveClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isWrapperClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>//判断是否为包装类
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//缓存包装类
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>cacheWrapperClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//确认存在没有参数的构造函数
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConstructor</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>findAnnotationName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;No such extension name for the class &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; in the config &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>resourceURL</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>names</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>NAME_SEPARATOR</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>split</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ArrayUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isNotEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>names</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>cacheActivateClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>names</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>]);</span>
                <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>names</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>//缓存激活的class名称
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>cacheName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#8f5902;font-style:italic>//存入拓展类的hashmap中
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>saveInExtensionClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>extensionClasses</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li></ul></li><li><p><strong>判断是否 cachedAdaptiveClass 是否为空</strong></p></li><li><p><strong>为空</strong> <strong><code>createAdaptiveExtensionClass</code></strong> <strong>创建并且赋值给</strong> <strong><code>cachedAdaptiveClass</code></strong></p></li></ul><p>接下来看一下 <strong><code>createAdaptiveExtensionClass</code></strong> 创建拓展类方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>createAdaptiveExtensionClass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
  			<span style=color:#8f5902;font-style:italic>//动态生成Adaptive类
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>String</span> <span style=color:#000>code</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AdaptiveClassCodeGenerator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cachedDefaultName</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>generate</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>//获取ClassLoader
</span><span style=color:#8f5902;font-style:italic></span>  			<span style=color:#000>ClassLoader</span> <span style=color:#000>classLoader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>findClassLoader</span><span style=color:#ce5c00;font-weight:700>();</span>
  			<span style=color:#8f5902;font-style:italic>//获取编译器
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dubbo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>common</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compiler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Compiler</span> <span style=color:#000>compiler</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ExtensionLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getExtensionLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dubbo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>common</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compiler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Compiler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getAdaptiveExtension</span><span style=color:#ce5c00;font-weight:700>();</span>
  			<span style=color:#8f5902;font-style:italic>//编译代码
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>compiler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>code</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>classLoader</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>到这里基本上的ExtensionLoader已经分析完成。</p><p>这里还有一个地方需要分析：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>T</span> <span style=color:#000>getExtension</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Extension name == null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getDefaultExtension</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>Holder</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>holder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getOrCreateHolder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>Object</span> <span style=color:#000>instance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>holder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instance</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>holder</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>instance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>holder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instance</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>instance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createExtension</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#000>holder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instance</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>instance</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在调用 <strong><code>getExtension</code></strong> 方法会自动对类进行包装：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>T</span> <span style=color:#000>createExtension</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>clazz</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getExtensionClasses</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>findException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>T</span> <span style=color:#000>instance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>EXTENSION_INSTANCES</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instance</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>EXTENSION_INSTANCES</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putIfAbsent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#000>instance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>EXTENSION_INSTANCES</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#000>injectExtension</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instance</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>wrapperClasses</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cachedWrapperClasses</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CollectionUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isNotEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wrapperClasses</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>wrapperClass</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>wrapperClasses</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                  	<span style=color:#8f5902;font-style:italic>//生成包装类 
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>instance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>injectExtension</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>wrapperClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConstructor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instance</span><span style=color:#ce5c00;font-weight:700>));</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>instance</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Extension instance (name: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;, class: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                    <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;) couldn&#39;t be instantiated: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果没有包装类直接对象。这里就解释了为什么定义的默认集群为 <strong>FailoverCluster</strong> 最后变成了 <strong>MockerClusterWrapper</strong> 这里给出了解释。在 <strong>Cluster</strong> 有多重实现包括Wapper类型</p><h3 id=dubbo-spi高级用法之-aop>Dubbo SPI高级用法之 AOP</h3><p>在用Spring的时候，我们经常会用到AOP功能。在目标类的方法前后插入其他逻辑。比如通常使用Spring AOP来实现日志，监控和鉴权等功能。 Dubbo的扩展机制，是否也支持类似的功能呢？答案是yes。在Dubbo中，有一种特殊的类，被称为Wrapper类。通过装饰者模式，使用包装类包装原始的扩展点实例。在原始扩展点实现前后插入其他逻辑，实现AOP功能。</p><h3 id=什么是wrapper类>什么是Wrapper类</h3><p>那什么样类的才是Dubbo扩展机制中的Wrapper类呢？Wrapper类是一个有复制构造函数的类，也是典型的装饰者模式。下面就是一个Wrapper类:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>A</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>A</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>){</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>a</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>类A有一个构造函数<code>public A(A a)</code>，构造函数的参数是A本身。这样的类就可以成为Dubbo扩展机制中的一个Wrapper类。Dubbo中这样的Wrapper类有ProtocolFilterWrapper, ProtocolListenerWrapper等, 大家可以查看源码加深理解。</p><h3 id=总结>总结</h3><ul><li><strong>主要利用了Java SPI的思想并且对SPI进行了拓展。</strong></li><li><strong>动态生成代码</strong></li><li><strong>支持setter的IOC注入— 可以进行拓展比如向Spring的IOC靠拢</strong></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-b34cacfc715c1d8efd4f78f7f3c1135b>2.1.4 - ReferenceConfig分析</h1><h3 id=referenceconfig代码分析>ReferenceConfig代码分析</h3><p>首先看一下 <strong><code>ReferenceConfig</code></strong> 继承关系：</p><p><img src="https://github.com/mxsm/document/blob/master/image/RPC/Dubbo/ReferenceConfig.png?raw=true" alt=图></p><p>看一下代码调用：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.dubbo.rpc.config.ApplicationConfig</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.dubbo.rpc.config.RegistryConfig</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.dubbo.rpc.config.ConsumerConfig</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.dubbo.rpc.config.ReferenceConfig</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>com.xxx.XxxService</span><span style=color:#ce5c00;font-weight:700>;</span>
 
<span style=color:#8f5902;font-style:italic>// 当前应用配置
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>ApplicationConfig</span> <span style=color:#000>application</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ApplicationConfig</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#000>application</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;yyy&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
 
<span style=color:#8f5902;font-style:italic>// 连接注册中心配置
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>RegistryConfig</span> <span style=color:#000>registry</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RegistryConfig</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAddress</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;10.20.130.230:9090&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setUsername</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;aaa&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setPassword</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;bbb&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
 
<span style=color:#8f5902;font-style:italic>// 注意：ReferenceConfig为重对象，内部封装了与注册中心的连接，以及与服务提供方的连接
</span><span style=color:#8f5902;font-style:italic></span> 
<span style=color:#8f5902;font-style:italic>// 引用远程服务
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>ReferenceConfig</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>XxxService</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>reference</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ReferenceConfig</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>XxxService</span><span style=color:#ce5c00;font-weight:700>&gt;();</span> <span style=color:#8f5902;font-style:italic>// 此实例很重，封装了与注册中心的连接以及与提供者的连接，请自行缓存，否则可能造成内存和连接泄漏
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>reference</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setApplication</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>application</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>reference</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setRegistry</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// 多个注册中心可以用setRegistries()
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>reference</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setInterface</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XxxService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>reference</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setVersion</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;1.0.0&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
 
<span style=color:#8f5902;font-style:italic>// 和本地bean一样使用xxxService
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>XxxService</span> <span style=color:#000>xxxService</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>reference</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>// 注意：此代理对象内部封装了所有通讯细节，对象较重，请缓存复用
</span></code></pre></div><p>直接从 <strong><code>reference.get()</code></strong> 开始分析</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#000>T</span> <span style=color:#000>get</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//检查配置
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>checkAndUpdateSubConfigs</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>destroyed</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The invoker of ReferenceConfig(&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;) has already destroyed!&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ref</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//不存在进行初始化
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>init</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>ref</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如要存在两个方法：</p><ul><li><p><strong><code>checkAndUpdateSubConfigs()</code></strong></p><p>检查配置</p></li><li><p><strong><code>init()</code></strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>init</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//判断是否已经初始化
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>initialized</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>initialized</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>//本地检查
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>checkStubAndLocal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>interfaceClass</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>//检查Mock
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>checkMock</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>interfaceClass</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>map</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>

        <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SIDE_KEY</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONSUMER_SIDE</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>//追加运行时参数
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>appendRuntimeParameters</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>//检测是否为泛化接口
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>isGeneric</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>String</span> <span style=color:#000>revision</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Version</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getVersion</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>interfaceClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>version</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>revision</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>revision</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;revision&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>revision</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>methods</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Wrapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWrapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>interfaceClass</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getMethodNames</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methods</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;No method found in service interface &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>interfaceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;methods&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ANY_VALUE</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;methods&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>join</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashSet</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>asList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methods</span><span style=color:#ce5c00;font-weight:700>)),</span> <span style=color:#4e9a06>&#34;,&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>INTERFACE_KEY</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>interfaceName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>appendParameters</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>application</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>appendParameters</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>module</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>appendParameters</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>consumer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DEFAULT_KEY</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>appendParameters</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>attributes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CollectionUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isNotEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methods</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>attributes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MethodConfig</span> <span style=color:#000>methodConfig</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>methods</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>appendParameters</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>methodConfig</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>methodConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#000>String</span> <span style=color:#000>retryKey</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>methodConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;.retry&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>retryKey</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>String</span> <span style=color:#000>retryValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>retryKey</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;false&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>retryValue</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methodConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;.retries&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;0&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#000>attributes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methodConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>convertMethodConfig2AyncInfo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methodConfig</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#000>String</span> <span style=color:#000>hostToRegistry</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSystemProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DUBBO_IP_TO_REGISTRY</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hostToRegistry</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>hostToRegistry</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>NetUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLocalHost</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>REGISTER_IP_KEY</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>hostToRegistry</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>//创建代理类
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>ref</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#000>ApplicationModel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>initConsumerModel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getUniqueServiceName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>buildConsumerModel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>attributes</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div><p>初始化的步骤：</p><ol><li><p><strong>判断是否已经初始化</strong></p></li><li><p><strong>各种参数的检查</strong></p></li><li><p><strong>创建动态代理类</strong></p><p>创建代理类方式有两种：</p><ul><li><p><strong><code>JavassistProxyFactory</code></strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>JavassistProxyFactory</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractProxyFactory</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>T</span> <span style=color:#000>getProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Invoker</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>invoker</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>interfaces</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>interfaces</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InvokerInvocationHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>invoker</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Invoker</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getInvoker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>URL</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// TODO Wrapper cannot handle this scenario correctly: the classname contains &#39;$&#39;
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Wrapper</span> <span style=color:#000>wrapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Wrapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWrapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>indexOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;$&#39;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AbstractProxyInvoker</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>doInvoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>methodName</span><span style=color:#ce5c00;font-weight:700>,</span>
                                      <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>parameterTypes</span><span style=color:#ce5c00;font-weight:700>,</span>
                                      <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>arguments</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>wrapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invokeMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>methodName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterTypes</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>arguments</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>};</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li><li><p><strong><code>JdkProxyFactory</code></strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>JdkProxyFactory</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractProxyFactory</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>//JDK获取代理类
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>T</span> <span style=color:#000>getProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Invoker</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>invoker</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>interfaces</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newProxyInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getContextClassLoader</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>interfaces</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InvokerInvocationHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>invoker</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Invoker</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getInvoker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>URL</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AbstractProxyInvoker</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>doInvoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>methodName</span><span style=color:#ce5c00;font-weight:700>,</span>
                                      <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>parameterTypes</span><span style=color:#ce5c00;font-weight:700>,</span>
                                      <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>arguments</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>Method</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methodName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterTypes</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>arguments</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>};</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li></ul></li></ol><p>查看 <strong><code>ref = createProxy(map);</code></strong> 代码</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>T</span> <span style=color:#000>createProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
             <span style=color:#8f5902;font-style:italic>//判断是否为JVM内部的引用
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>shouldJvmRefer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
             <span style=color:#8f5902;font-style:italic>//本地调用
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>URL</span> <span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>URL</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>LOCAL_PROTOCOL</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>LOCALHOST_VALUE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>interfaceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()).</span><span style=color:#c4a000>addParameters</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>invoker</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>refprotocol</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>refer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>interfaceClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInfoEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Using injvm service &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>interfaceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
             <span style=color:#8f5902;font-style:italic>//远程调用
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> 
                <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>us</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SEMICOLON_SPLIT_PATTERN</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>split</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>us</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>us</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>u</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>us</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>URL</span> <span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>URL</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>valueOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>u</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPath</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setPath</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>interfaceName</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>REGISTRY_PROTOCOL</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProtocol</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>urls</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addParameterAndEncoded</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>REFER_KEY</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toQueryString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>)));</span>
                        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>urls</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClusterUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mergeUrl</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>));</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// assemble URL from register center&#39;s configuration
</span><span style=color:#8f5902;font-style:italic></span>               <span style=color:#8f5902;font-style:italic>//检查注册中心 
</span><span style=color:#8f5902;font-style:italic></span>                 <span style=color:#000>checkRegistry</span><span style=color:#ce5c00;font-weight:700>();</span>
                  <span style=color:#8f5902;font-style:italic>//从注册中心装配URL
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>URL</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>us</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>loadRegistries</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CollectionUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isNotEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>us</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>URL</span> <span style=color:#000>u</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>us</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>URL</span> <span style=color:#000>monitorUrl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>loadMonitor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>u</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>monitorUrl</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MONITOR_KEY</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>URL</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>encode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>monitorUrl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toFullString</span><span style=color:#ce5c00;font-weight:700>()));</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#000>urls</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>u</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addParameterAndEncoded</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>REFER_KEY</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toQueryString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>)));</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>urls</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                   <span style=color:#8f5902;font-style:italic>//抛出错误
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>urls</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>//单个注册中心直联
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>invoker</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>refprotocol</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>refer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>interfaceClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>urls</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                 <span style=color:#8f5902;font-style:italic>//多个注册中心或者多个服务提供者
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Invoker</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>invokers</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Invoker</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;();</span>
                <span style=color:#000>URL</span> <span style=color:#000>registryURL</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>URL</span> <span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>urls</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>invokers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>refprotocol</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>refer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>interfaceClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>));</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>REGISTRY_PROTOCOL</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProtocol</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>registryURL</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// use last registry url
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registryURL</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// registry url is available
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#8f5902;font-style:italic>// use RegistryAwareCluster only when register&#39;s cluster is available
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>URL</span> <span style=color:#000>u</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>registryURL</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addParameter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CLUSTER_KEY</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RegistryAwareCluster</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NAME</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#8f5902;font-style:italic>// 
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>invoker</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cluster</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>join</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StaticDirectory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>u</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>invokers</span><span style=color:#ce5c00;font-weight:700>));</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// not a registry url, must be direct invoke.
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>invoker</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cluster</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>join</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StaticDirectory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>invokers</span><span style=color:#ce5c00;font-weight:700>));</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>shouldCheck</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>invoker</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAvailable</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>

            <span style=color:#000>initialized</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>//抛出错误
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInfoEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Refer dubbo service &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>interfaceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; from url &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>invoker</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUrl</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>         * @since 2.7.0
</span><span style=color:#8f5902;font-style:italic>         * ServiceData Store
</span><span style=color:#8f5902;font-style:italic>         */</span>
        <span style=color:#000>MetadataReportService</span> <span style=color:#000>metadataReportService</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>metadataReportService</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getMetadataReportService</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>URL</span> <span style=color:#000>consumerURL</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>URL</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONSUMER_PROTOCOL</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>REGISTER_IP_KEY</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>INTERFACE_KEY</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>metadataReportService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>publishConsumer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>consumerURL</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// create service proxy
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>proxyFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>invoker</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过 URL中的 <strong><code>protocol</code></strong> 然后通过 <strong><code>ExtensionLoader</code></strong> 类获取对应的值。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Protocol</span> <span style=color:#000>refprotocol</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ExtensionLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getExtensionLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Protocol</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getAdaptiveExtension</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#8f5902;font-style:italic>//Protocol都是通过javassist 动态生成代码
</span></code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>  * Protocol 实现的默认值名称为dubbo
</span><span style=color:#8f5902;font-style:italic>  *
</span><span style=color:#8f5902;font-style:italic>  *
</span><span style=color:#8f5902;font-style:italic>  */</span>
<span style=color:#5c35cc;font-weight:700>@SPI</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;dubbo&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Protocol</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>getDefaultPort</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#5c35cc;font-weight:700>@Adaptive</span>
    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Exporter</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>export</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Invoker</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>invoker</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>RpcException</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@Adaptive</span>
  <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Invoker</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>refer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>URL</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>RpcException</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>destroy</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>下图是Dubbo的数据加载的截图：</p><p><img src="https://github.com/mxsm/document/blob/master/image/RPC/Dubbo/Dubbo%E5%8A%A8%E6%80%81%E7%94%9F%E6%88%90%E9%80%82%E9%85%8D%E5%AF%B9%E8%B1%A1%E8%AF%B4%E6%98%8E%E6%88%AA%E5%9B%BE.jpg?raw=true" alt=图解></p></li></ul><p>代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Protocol</span> <span style=color:#000>refprotocol</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ExtensionLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getExtensionLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Protocol</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getAdaptiveExtension</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div><p>由于Dubbo没有已经写好带有 <strong><code>@Adaptive</code></strong> 的实现类，通过动态生成的 <strong><code>Adaptive Protocol</code></strong> 。在这个地方加载的</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Protocol$Adaptive</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>destroy</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>UnsupportedOperationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The method public abstract void org.apache.dubbo.rpc.Protocol.destroy() of interface org.apache.dubbo.rpc.Protocol is not adaptive method!&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>getDefaultPort</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>UnsupportedOperationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The method public abstract int org.apache.dubbo.rpc.Protocol.getDefaultPort() of interface org.apache.dubbo.rpc.Protocol is not adaptive method!&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dubbo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rpc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Exporter</span> <span style=color:#000>export</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dubbo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rpc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Invoker</span> <span style=color:#000>arg0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dubbo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rpc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RpcException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>arg0</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.apache.dubbo.rpc.Invoker argument == null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>arg0</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUrl</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.apache.dubbo.rpc.Invoker argument getUrl() == null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dubbo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>common</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>URL</span> <span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>arg0</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUrl</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>String</span> <span style=color:#000>extName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProtocol</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#4e9a06>&#34;dubbo&#34;</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProtocol</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>extName</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Failed to get extension (org.apache.dubbo.rpc.Protocol) name from url (&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;) use keys([protocol])&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dubbo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rpc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Protocol</span> <span style=color:#000>extension</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dubbo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rpc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Protocol</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>ExtensionLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getExtensionLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dubbo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rpc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Protocol</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getExtension</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>extName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>extension</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>export</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>arg0</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dubbo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rpc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Invoker</span> <span style=color:#000>refer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Class</span> <span style=color:#000>arg0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dubbo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>common</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>URL</span> <span style=color:#000>arg1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dubbo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rpc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RpcException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>arg1</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;url == null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dubbo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>common</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>URL</span> <span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>arg1</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>String</span> <span style=color:#000>extName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProtocol</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#4e9a06>&#34;dubbo&#34;</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProtocol</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>extName</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Failed to get extension (org.apache.dubbo.rpc.Protocol) name from url (&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;) use keys([protocol])&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dubbo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rpc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Protocol</span> <span style=color:#000>extension</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dubbo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rpc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Protocol</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>ExtensionLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getExtensionLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dubbo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rpc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Protocol</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getExtension</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>extName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>extension</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>refer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>arg0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>arg1</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>当 <strong><code>invoker = refprotocol.refer(interfaceClass, urls.get(0));</code></strong> 调用，<strong><code>url.getProtocol()</code></strong> 的值为 <strong><code>registry</code></strong> , 那就会获取 <strong><code>registry</code></strong> 的实现类</p><pre><code>registry=org.apache.dubbo.registry.integration.RegistryProtocol
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-652cd908caaf365ff060d62fc554020c>2.1.5 - ServiceConfig源码分析</h1><p>服务导出的代码入口：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>export</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>checkAndUpdateSubConfigs</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>shouldExport</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>shouldDelay</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>delayExportExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>schedule</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>doExport</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>delay</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MILLISECONDS</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>doExport</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ol><li>首先检查和更新配置</li><li>判断是否需要导出</li><li>发布服务是否要进行延迟发布。延迟的单位毫秒。</li><li>不需要延迟直接发布服务</li></ol><p>从上面的服务可以看出不管是延迟发布服务和直接发布服务都是调用了 <strong><code>doExport</code></strong> 方法进行服务的发布。下面就来看一下在方法 <strong><code>doExport</code></strong> 中做了什么事情。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>doExport</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>unexported</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>//抛异常
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
   			<span style=color:#8f5902;font-style:italic>//判断是否已经发布了
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>exported</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>exported</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
				<span style=color:#8f5902;font-style:italic>//判断path是否为空如果为空就赋值接口的名称
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>path</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>interfaceName</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
   			<span style=color:#8f5902;font-style:italic>//真正的做发布的服务的方法
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>doExportUrls</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从上面可以看出来 <strong><code>doExport</code></strong> 在方法前面部分主要是做一些校验性的工作。比如是否已经发布的校验等等。最后调用的是 <strong><code>doExportUrls</code></strong> 方法来发布。多协议多注册中心导出服务</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>   <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>doExportUrls</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//根据服务端接口实现等生成URL
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>URL</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>registryURLs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>loadRegistries</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
     	  <span style=color:#8f5902;font-style:italic>//根据不同的协议发布服务--多协议多注册中心导出服务
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ProtocolConfig</span> <span style=color:#000>protocolConfig</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>protocols</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>String</span> <span style=color:#000>pathKey</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>URL</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>buildKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getContextPath</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>protocolConfig</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;/&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>orElse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>group</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>version</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>//生成提供者模型
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>ProviderModel</span> <span style=color:#000>providerModel</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ProviderModel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pathKey</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ref</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>interfaceClass</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>//本地缓存提供者的模型
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>ApplicationModel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>initProviderModel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pathKey</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>providerModel</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>//根据协议发布服务
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>doExportUrlsFor1Protocol</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>protocolConfig</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>registryURLs</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>下面来看一下 <strong><code>doExportUrlsFor1Protocol</code></strong> 方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>doExportUrlsFor1Protocol</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ProtocolConfig</span> <span style=color:#000>protocolConfig</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>URL</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>registryURLs</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//获取协议名称
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>String</span> <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>protocolConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//默认为Dubbo
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DUBBO</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>map</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
        <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SIDE_KEY</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PROVIDER_SIDE</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#000>appendRuntimeParameters</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>appendParameters</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>metrics</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>appendParameters</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>application</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>appendParameters</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>module</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>appendParameters</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>provider</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DEFAULT_KEY</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>appendParameters</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>protocolConfig</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>appendParameters</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#8f5902;font-style:italic>//服务中是否有方法
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CollectionUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isNotEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methods</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MethodConfig</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>methods</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>appendParameters</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#000>String</span> <span style=color:#000>retryKey</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;.retry&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>retryKey</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>String</span> <span style=color:#000>retryValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>retryKey</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;false&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>retryValue</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;.retries&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;0&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ArgumentConfig</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>arguments</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getArguments</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CollectionUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isNotEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>arguments</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ArgumentConfig</span> <span style=color:#000>argument</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>arguments</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>// convert argument type
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>argument</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getType</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>argument</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getType</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>methods</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>interfaceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethods</span><span style=color:#ce5c00;font-weight:700>();</span>
                            <span style=color:#8f5902;font-style:italic>// visit all methods
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methods</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>methods</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>methods</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                    <span style=color:#000>String</span> <span style=color:#000>methodName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>methods</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>();</span>
                                    <span style=color:#8f5902;font-style:italic>// target the method, and get its signature
</span><span style=color:#8f5902;font-style:italic></span>                                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methodName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                        <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>argtypes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>methods</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#c4a000>getParameterTypes</span><span style=color:#ce5c00;font-weight:700>();</span>
                                        <span style=color:#8f5902;font-style:italic>// one callback in the method
</span><span style=color:#8f5902;font-style:italic></span>                                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>argument</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getIndex</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>argtypes</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>argument</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getIndex</span><span style=color:#ce5c00;font-weight:700>()].</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>argument</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getType</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                                <span style=color:#000>appendParameters</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>argument</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;.&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>argument</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getIndex</span><span style=color:#ce5c00;font-weight:700>());</span>
                                            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Argument config error : the index attribute and type attribute not match :index :&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>argument</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getIndex</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;, type:&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>argument</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getType</span><span style=color:#ce5c00;font-weight:700>());</span>
                                            <span style=color:#ce5c00;font-weight:700>}</span>
                                        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                            <span style=color:#8f5902;font-style:italic>// multiple callbacks in the method
</span><span style=color:#8f5902;font-style:italic></span>                                            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>j</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>j</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>argtypes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                                <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>argclazz</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>argtypes</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>];</span>
                                                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>argclazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>argument</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getType</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                                    <span style=color:#000>appendParameters</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>argument</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;.&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>);</span>
                                                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>argument</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getIndex</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>argument</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getIndex</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                                        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Argument config error : the index attribute and type attribute not match :index :&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>argument</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getIndex</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;, type:&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>argument</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getType</span><span style=color:#ce5c00;font-weight:700>());</span>
                                                    <span style=color:#ce5c00;font-weight:700>}</span>
                                                <span style=color:#ce5c00;font-weight:700>}</span>
                                            <span style=color:#ce5c00;font-weight:700>}</span>
                                        <span style=color:#ce5c00;font-weight:700>}</span>
                                    <span style=color:#ce5c00;font-weight:700>}</span>
                                <span style=color:#ce5c00;font-weight:700>}</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>argument</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getIndex</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>appendParameters</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>argument</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;.&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>argument</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getIndex</span><span style=color:#ce5c00;font-weight:700>());</span>
                        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Argument config must set index or type attribute.eg: &lt;dubbo:argument index=&#39;0&#39; .../&gt; or &lt;dubbo:argument type=xxx .../&gt;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>

                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#8f5902;font-style:italic>// end of methods for
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ProtocolUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isGeneric</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>generic</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GENERIC_KEY</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>generic</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>METHODS_KEY</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ANY_VALUE</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>String</span> <span style=color:#000>revision</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Version</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getVersion</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>interfaceClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>version</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>revision</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>revision</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>REVISION_KEY</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>revision</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>methods</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Wrapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWrapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>interfaceClass</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getMethodNames</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methods</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;No method found in service interface &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>interfaceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>METHODS_KEY</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ANY_VALUE</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>METHODS_KEY</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>join</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashSet</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>asList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methods</span><span style=color:#ce5c00;font-weight:700>)),</span> <span style=color:#4e9a06>&#34;,&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>ConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>token</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDefault</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>token</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TOKEN_KEY</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>UUID</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>randomUUID</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TOKEN_KEY</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>token</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// export service
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>String</span> <span style=color:#000>host</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findConfigedHosts</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>protocolConfig</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>registryURLs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>Integer</span> <span style=color:#000>port</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findConfigedPorts</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>protocolConfig</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>URL</span> <span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>URL</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>host</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>port</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getContextPath</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>protocolConfig</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;/&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>orElse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ExtensionLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getExtensionLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfiguratorFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasExtension</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProtocol</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ExtensionLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getExtensionLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfiguratorFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getExtension</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProtocol</span><span style=color:#ce5c00;font-weight:700>()).</span><span style=color:#c4a000>getConfigurator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>configure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#000>String</span> <span style=color:#000>scope</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SCOPE_KEY</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// scope = none，不导出服务
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SCOPE_NONE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equalsIgnoreCase</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>scope</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>

            <span style=color:#8f5902;font-style:italic>// scope != remote，导出到本地
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SCOPE_REMOTE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equalsIgnoreCase</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>scope</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>exportLocal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#8f5902;font-style:italic>// scope != local，导出到远程
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SCOPE_LOCAL</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equalsIgnoreCase</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>scope</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInfoEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Export dubbo service &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>interfaceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; to url &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CollectionUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isNotEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registryURLs</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>URL</span> <span style=color:#000>registryURL</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>registryURLs</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addParameterIfAbsent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DYNAMIC_KEY</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>registryURL</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DYNAMIC_KEY</span><span style=color:#ce5c00;font-weight:700>));</span>
                        <span style=color:#000>URL</span> <span style=color:#000>monitorUrl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>loadMonitor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registryURL</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>monitorUrl</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addParameterAndEncoded</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MONITOR_KEY</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>monitorUrl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toFullString</span><span style=color:#ce5c00;font-weight:700>());</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInfoEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Register dubbo service &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>interfaceClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; url &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; to registry &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>registryURL</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>

                        <span style=color:#8f5902;font-style:italic>// For providers, this is used to enable custom proxy to generate invoker
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>String</span> <span style=color:#000>proxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PROXY_KEY</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isNotEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>registryURL</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>registryURL</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addParameter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PROXY_KEY</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#8f5902;font-style:italic>//获取Invoker
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>Invoker</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>invoker</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>proxyFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInvoker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ref</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>interfaceClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>registryURL</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addParameterAndEncoded</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>EXPORT_KEY</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toFullString</span><span style=color:#ce5c00;font-weight:700>()));</span>
                        <span style=color:#000>DelegateProviderMetaDataInvoker</span> <span style=color:#000>wrapperInvoker</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DelegateProviderMetaDataInvoker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>invoker</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>

                        <span style=color:#000>Exporter</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>exporter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>protocol</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>export</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wrapperInvoker</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#000>exporters</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>exporter</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>  <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>Invoker</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>invoker</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>proxyFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInvoker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ref</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>interfaceClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#000>DelegateProviderMetaDataInvoker</span> <span style=color:#000>wrapperInvoker</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DelegateProviderMetaDataInvoker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>invoker</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>

                    <span style=color:#000>Exporter</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>exporter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>protocol</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>export</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wrapperInvoker</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#000>exporters</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>exporter</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>                 * @since 2.7.0
</span><span style=color:#8f5902;font-style:italic>                 * ServiceData Store
</span><span style=color:#8f5902;font-style:italic>                 */</span>
                <span style=color:#000>MetadataReportService</span> <span style=color:#000>metadataReportService</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>metadataReportService</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getMetadataReportService</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>metadataReportService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>publishProvider</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>urls</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-c1c1b3b4b1d2bb00e27cb34ee005caba>2.1.6 - 自适应机制解析</h1><h3 id=1-两个注解>1. 两个注解</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Documented</span>
<span style=color:#5c35cc;font-weight:700>@Retention</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RetentionPolicy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RUNTIME</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Target</span><span style=color:#ce5c00;font-weight:700>({</span><span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TYPE</span><span style=color:#ce5c00;font-weight:700>})</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#5c35cc;font-weight:700>@interface</span> <span style=color:#000>SPI</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>String</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>default</span> <span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@Documented</span>
<span style=color:#5c35cc;font-weight:700>@Retention</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RetentionPolicy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RUNTIME</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Target</span><span style=color:#ce5c00;font-weight:700>({</span><span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TYPE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>METHOD</span><span style=color:#ce5c00;font-weight:700>})</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#5c35cc;font-weight:700>@interface</span> <span style=color:#000>Adaptive</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>default</span> <span style=color:#ce5c00;font-weight:700>{};</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul><li><p><strong>@SPI</strong></p><p>通过SPI注解动态获取一个接口在项目中不同的实现。增强了Java原生的SPI。</p></li><li><p><strong>@Adaptive</strong></p><p>通过适配的标签动态注入数据</p></li></ul><h3 id=2-源码解析>2. 源码解析</h3><p>首先获取对应的接口的拓展器加载类：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>ExtensionLoader</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getExtensionLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Extension type == null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInterface</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Extension type (&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;) is not an interface!&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>withExtensionAnnotation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Extension type (&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>+</span>
                    <span style=color:#4e9a06>&#34;) is not an extension, because it is NOT annotated with @&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>SPI</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSimpleName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;!&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#000>ExtensionLoader</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>loader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ExtensionLoader</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#000>EXTENSION_LOADERS</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>loader</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>EXTENSION_LOADERS</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putIfAbsent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ExtensionLoader</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#000>loader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ExtensionLoader</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#000>EXTENSION_LOADERS</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>loader</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ol><li>判断是否需要加载的类type是否为空</li><li>判断是否为接口</li><li><strong><code>withExtensionAnnotation</code></strong> 方法判断是否存在 <strong><code>@SPI</code></strong> 注解</li><li>从缓存中获取拓展类Loader，不存在创建放入缓存。</li></ol><p>然后通过 <strong><code>getAdaptiveExtension()</code></strong> 方法来获取 <strong><code>Adaptive</code></strong> 对象。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>T</span> <span style=color:#000>getAdaptiveExtension</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
      	
      	<span style=color:#8f5902;font-style:italic>//从当前缓存中获取
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Object</span> <span style=color:#000>instance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cachedAdaptiveInstance</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
      	<span style=color:#8f5902;font-style:italic>//dubbo check 保证下面只能有一个
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instance</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>createAdaptiveInstanceError</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cachedAdaptiveInstance</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>instance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cachedAdaptiveInstance</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instance</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                          	<span style=color:#8f5902;font-style:italic>//创建适配对象
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#000>instance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createAdaptiveExtension</span><span style=color:#ce5c00;font-weight:700>();</span>
                          	<span style=color:#8f5902;font-style:italic>//放入缓存
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#000>cachedAdaptiveInstance</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instance</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>createAdaptiveInstanceError</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Failed to create adaptive instance: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Failed to create adaptive instance: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>createAdaptiveInstanceError</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>createAdaptiveInstanceError</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>instance</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>首先也是从缓存中获取，在缓存中没有的时候调用 <strong><code>createAdaptiveExtension()</code></strong> 同样设置到缓存：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>T</span> <span style=color:#000>createAdaptiveExtension</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
          	<span style=color:#8f5902;font-style:italic>//创建适配对象然后对对象进行动态注入
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>injectExtension</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>getAdaptiveExtensionClass</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>//报错
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>先看一下 <strong><code>getAdaptiveExtensionClass()</code></strong> 获取适配拓展类</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>getAdaptiveExtensionClass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
  			<span style=color:#8f5902;font-style:italic>//获取所有的适配类的dubbo实现并且保存
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>getExtensionClasses</span><span style=color:#ce5c00;font-weight:700>();</span>
  			<span style=color:#8f5902;font-style:italic>//判断是否为空 -- 用了volatile 修饰cachedAdaptiveClass 保证可见性
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cachedAdaptiveClass</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>cachedAdaptiveClass</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>cachedAdaptiveClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createAdaptiveExtensionClass</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#8f5902;font-style:italic>//获取所有的拓展类的对应关系
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>getExtensionClasses</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>classes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cachedClasses</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>classes</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cachedClasses</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>classes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cachedClasses</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>classes</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                  	<span style=color:#8f5902;font-style:italic>//关键方法
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>classes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>loadExtensionClasses</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#000>cachedClasses</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>classes</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>classes</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#8f5902;font-style:italic>//SPI的拓展
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>		 * META-INF/services/  -- Java标准的SPI
</span><span style=color:#8f5902;font-style:italic>		 * META-INF/dubbo/  -- 用户自己拓展的
</span><span style=color:#8f5902;font-style:italic>		 * META-INF/dubbo/internal/ -- Dubbo内部的拓展
</span><span style=color:#8f5902;font-style:italic>		 * 会去加载这三个目录下面的文件
</span><span style=color:#8f5902;font-style:italic> 		*/</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>loadExtensionClasses</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>cacheDefaultExtensionName</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>extensionClasses</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
        <span style=color:#000>loadDirectory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>extensionClasses</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>DUBBO_INTERNAL_DIRECTORY</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>loadDirectory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>extensionClasses</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>DUBBO_INTERNAL_DIRECTORY</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>replace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.apache&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;com.alibaba&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#000>loadDirectory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>extensionClasses</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>DUBBO_DIRECTORY</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>loadDirectory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>extensionClasses</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>DUBBO_DIRECTORY</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>replace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.apache&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;com.alibaba&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#000>loadDirectory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>extensionClasses</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SERVICES_DIRECTORY</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>loadDirectory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>extensionClasses</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SERVICES_DIRECTORY</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>replace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.apache&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;com.alibaba&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>extensionClasses</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果适配的class不存在,</p><p><strong><code>String code = new AdaptiveClassCodeGenerator(type, cachedDefaultName).generate();</code></strong> 生成代码</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Protocol$Adaptive</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>destroy</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>UnsupportedOperationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The method public abstract void org.apache.dubbo.rpc.Protocol.destroy() of interface org.apache.dubbo.rpc.Protocol is not adaptive method!&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>getDefaultPort</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>UnsupportedOperationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The method public abstract int org.apache.dubbo.rpc.Protocol.getDefaultPort() of interface org.apache.dubbo.rpc.Protocol is not adaptive method!&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dubbo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rpc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Exporter</span> <span style=color:#000>export</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dubbo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rpc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Invoker</span> <span style=color:#000>arg0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dubbo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rpc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RpcException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>arg0</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.apache.dubbo.rpc.Invoker argument == null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>arg0</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUrl</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.apache.dubbo.rpc.Invoker argument getUrl() == null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dubbo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>common</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>URL</span> <span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>arg0</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUrl</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>String</span> <span style=color:#000>extName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProtocol</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#4e9a06>&#34;dubbo&#34;</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProtocol</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>extName</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Failed to get extension (org.apache.dubbo.rpc.Protocol) name from url (&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;) use keys([protocol])&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dubbo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rpc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Protocol</span> <span style=color:#000>extension</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dubbo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rpc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Protocol</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>ExtensionLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getExtensionLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dubbo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rpc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Protocol</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getExtension</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>extName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>extension</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>export</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>arg0</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dubbo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rpc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Invoker</span> <span style=color:#000>refer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Class</span> <span style=color:#000>arg0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dubbo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>common</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>URL</span> <span style=color:#000>arg1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dubbo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rpc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RpcException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>arg1</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;url == null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dubbo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>common</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>URL</span> <span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>arg1</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>String</span> <span style=color:#000>extName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProtocol</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#4e9a06>&#34;dubbo&#34;</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProtocol</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>extName</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Failed to get extension (org.apache.dubbo.rpc.Protocol) name from url (&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;) use keys([protocol])&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dubbo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rpc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Protocol</span> <span style=color:#000>extension</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dubbo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rpc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Protocol</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>ExtensionLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getExtensionLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dubbo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rpc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Protocol</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getExtension</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>extName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>extension</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>refer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>arg0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>arg1</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote><p>对于拓展类的实现有两类：</p><ul><li><p>默认的-Adaptive类型</p><p>在没有指定的时候会获取对应的类上面的@Adaptive注解来获取</p></li><li><p>通过配置或者其他方式指定的类</p></li></ul></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-76de6d247d92294905421acf341dd7a8>2.2 - Dubbo容错四大利器之—服务目录</h1><h3 id=1-集群容错包含哪些组件>1. 集群容错包含哪些组件？</h3><p>Dubbo的集群容错包含了四个部分：</p><ul><li><strong>服务目录Directory</strong></li><li><strong>服务路由 Router</strong></li><li><strong>集群 Cluster</strong></li><li><strong>负载均衡 LoadBalance</strong></li></ul><h4 id=2-什么是服务目录字典>2 什么是服务目录字典？</h4><p>服务目录存储了一些和<strong>服务提供者</strong> 相关的信息，通过服务目录，消费者可以获取服务提供者的信息。比如IP、端口、服务协议等等。通过这些信息，消费者可以通过Netty等客户端进行远程调用。在一个集群中。服务提供者的信息并不是一成不变的。如果集群新增了一台机器，相应的在服务目录中就要新增一条服务提供者的记录。或者，如果服务提供者的配置修改了，服务目录中的记录也要做相应的更新。</p><p>实际上服务目录在获取注册中心的服务配置信息后，会为每条配置信息生成一个 Invoker 对象，并把这个 Invoker 对象存储起来，这个 Invoker 才是服务目录最终持有的对象。Invoker 有什么用呢？看名字就知道了，这是一个具有远程调用功能的对象。讲到这大家应该知道了什么是服务目录了，它可以看做是 Invoker 集合，且这个集合中的元素会随注册中心的变化而进行动态调整。</p><p>概括的说：<strong>在每个本地机器上缓存了一份远程注册中心的信息，好处就是注册中心挂了还是能够从本地获取到原有已经注册在注册中心上面的服务。不以至于注册中心宕机导致整个服务不能使用</strong></p><h3 id=3-服务目录字典继承体系>3 服务目录字典继承体系</h3><p><img src="https://github.com/mxsm/document/blob/master/image/RPC/Dubbo/%E6%9C%8D%E7%9B%AE%E5%BD%95%E7%BB%A7%E6%89%BF%E4%BD%93%E7%B3%BB%E5%9B%BE2.7.0.jpg?raw=true" alt=图></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Directory</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Node</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getInterface</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 列出所有的Invoker
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @return invokers
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Invoker</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Invocation</span> <span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>RpcException</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>注意</strong>： <strong>RegistryDirectory 实现了 NotifyListener 接口，当注册中心节点信息发生变化后，RegistryDirectory 可以通过此接口方法得到变更信息，并根据变更信息动态调整内部 Invoker 列表。</strong></p><h3 id=4-源码分析270版本代码>4 源码分析—2.7.0版本代码</h3><p><strong><code>AbstractDirectory</code></strong> 类的 <strong><code>List&lt;Invoker&lt;T>> list(Invocation invocation) throws RpcException;</code></strong> 的实现代码</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Invoker</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Invocation</span> <span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>RpcException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>destroyed</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RpcException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Directory already destroyed .url: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>getUrl</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#8f5902;font-style:italic>//子类的模板方法
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>doList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#8f5902;font-style:italic>//模板方法由子类实现
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Invoker</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>doList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Invocation</span> <span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>RpcException</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><h4 id=41-staticdirectory-子类>4.1 StaticDirectory 子类</h4><p>废话不多说先上代码</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>StaticDirectory</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractDirectory</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Logger</span> <span style=color:#000>logger</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>LoggerFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLogger</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StaticDirectory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Invoker</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>invokers</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>//......构造函数省了
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getInterface</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>invokers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getInterface</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isAvailable</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isDestroyed</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Invoker</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>invoker</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>invokers</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//一个Invoker这个服务目录字典就可用
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>invoker</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAvailable</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>destroy</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isDestroyed</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>destroy</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Invoker</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>invoker</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>invokers</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>invoker</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>destroy</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>invokers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>buildRouterChain</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>RouterChain</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>routerChain</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RouterChain</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>buildChain</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getUrl</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>routerChain</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setInvokers</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>invokers</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setRouterChain</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>routerChain</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Invoker</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>doList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Invocation</span> <span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>RpcException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Invoker</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>finalInvokers</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>invokers</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>routerChain</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>//从
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>finalInvokers</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>routerChain</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>route</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getConsumerUrl</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Failed to execute router: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>getUrl</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;, cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>finalInvokers</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>Collections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>emptyList</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>finalInvokers</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-33c41505d9c393822a923b9596fbb713>2.3 - Dubbo元数据</h1><h3 id=如何使用元数据>如何使用元数据？</h3><p>元数据在Dubbo2.7才开始有的。如果在2.7版本中不进行额外的配置就会沿用以前的。zookeeper 中的数据格式仍然会和 Dubbo 2.6 保持一致，这主要是为了保证兼容性，让 Dubbo 2.6 的客户端可以调用 Dubbo 2.7 的服务端。如果整体迁移到 2.7，则可以为注册中心开启简化配置的参数（PS:当时自己在进行查看的过程还在说为什么没用变化难道只是Dubbo把代码写了没用真正的用，结果是没有设置）：</p><p>xml中的配置：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;dubbo:registry</span> <span style=color:#c4a000>address=</span><span style=color:#4e9a06>“zookeeper://127.0.0.1:2181”</span> <span style=color:#c4a000>simplified=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
</code></pre></div><p>.properties配置：</p><pre><code class=language-properties data-lang=properties>dubbo.registry.simplified=true
</code></pre><p>上面的是配置了使用元数据的配置后如何启用元数据。</p><p>元数据的配置：</p><pre><code class=language-properties data-lang=properties>dubbo.metadata-report.address=zookeeper://127.0.0.1:2181
dubbo.metadata-report.username=xxx        ##非必须
dubbo.metadata-report.password=xxx        ##非必须
dubbo.metadata-report.retry-times=30       ##非必须,default值100
dubbo.metadata-report.retry-period=5000    ##非必须,default值3000
dubbo.metadata-report.cycle-report=false   ##非必须,default值true
</code></pre><p>如果不配置元数据的配置这样就不会使用。</p><p>具体的为什么使用元数据和元数据带来了好处Dubbo的官网说明了</p><p><a href=https://dubbo.apache.org/zh-cn/docs/user/references/metadata/introduction.html>Dubbo元数据说明</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-8c14b3b69b7fdc44190bbad9d2162bba>2.4 - Dubbo容错四大利器之— 服务路由</h1><h3 id=1-什么是服务路由>1 什么是服务路由？</h3><p><strong>服务路由包含一条路由规则，路由规则决定了服务消费者的调用目标，即规定了服务消费者可调用哪些服务提供者。</strong></p><ul><li><strong>条件路由 — ConditionRouter</strong> 最常用的路由</li><li><strong>脚本路由 — ScriptRouter</strong></li><li><strong>标签路由 — TagRouter</strong> 标签路由是一个新的实现</li></ul><p><img src="https://github.com/mxsm/document/blob/master/image/RPC/Dubbo/Dubbo-Router%E8%B7%AF%E7%94%B1%E7%BB%A7%E6%89%BF%E5%9B%BE.jpg?raw=true" alt=继承图></p><h3 id=2-条件路由的分析>2 条件路由的分析</h3><h4 id=21组成条件路由的两个条件>2.1组成条件路由的两个条件</h4><ul><li><strong>服务消费者匹配条件</strong></li><li><strong>服务提供者匹配条件</strong></li></ul><p>例如下面这样</p><pre><code>[服务消费者匹配条件] =&gt; [服务提供者匹配条件]
</code></pre><ul><li>服务消费者匹配为空，表示不对服务消费者进行限制</li><li>服务通知匹配条件为空，表示对某些服务消费者禁用服务</li></ul><p>工作流程：</p><ul><li>需要先对用户配置的路由规则进行解析，得到一系列的条件</li><li>根据条件对服务进行路由</li></ul><h4 id=22-conditionrouter的源码分析>2.2 ConditionRouter的源码分析</h4><p><strong>路由的规则的解析：</strong></p><p>首先来看一下 <strong><code>ConditionRouter</code></strong> 的构造函数</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>   <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ConditionRouter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>rule</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>force</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>enabled</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
       <span style=color:#8f5902;font-style:italic>//当路由结果为空时，是否强制执行，如果不强制执行，路由结果为空的路由规则将自动失效，可不填，缺省为 false 
</span><span style=color:#8f5902;font-style:italic></span>       <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>force</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>force</span><span style=color:#ce5c00;font-weight:700>;</span>
       <span style=color:#8f5902;font-style:italic>// 当前路由规则是否生效
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>enabled</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>enabled</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>//调用方法初始化规则
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>init</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rule</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ConditionRouter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>URL</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>url</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>priority</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PRIORITY_KEY</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>force</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>FORCE_KEY</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>enabled</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ENABLED_KEY</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>init</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterAndDecoded</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RULE_KEY</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在构造函数中调用了 <strong><code>init</code></strong> 方法，从方法来看主要是解析出路由规则，得到一系列的条件</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>init</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>rule</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rule</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>rule</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trim</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Illegal route rule!&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#000>rule</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>rule</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>replace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;consumer.&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>replace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;provider.&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>rule</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>indexOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;=&gt;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>//获取 =&gt; 前面的部分 服务消费者的规则
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>String</span> <span style=color:#000>whenRule</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>rule</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>substring</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>trim</span><span style=color:#ce5c00;font-weight:700>();</span>
             <span style=color:#8f5902;font-style:italic>//获取 =&gt; 后面面的部分 服务提供者的规则
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>String</span> <span style=color:#000>thenRule</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>rule</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trim</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>rule</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>substring</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>trim</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MatchPair</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>when</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isBlank</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>whenRule</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>whenRule</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MatchPair</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>parseRule</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>whenRule</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MatchPair</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>then</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isBlank</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>thenRule</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#4e9a06>&#34;false&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>thenRule</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>parseRule</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>thenRule</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// NOTE: It should be determined on the business level whether the `When condition` can be empty or not.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>whenCondition</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>when</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>thenCondition</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>then</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ParseException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>看一下方法 <strong><code>parseRule</code></strong> 如何具体根据规则字符串解析出来规则</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MatchPair</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>parseRule</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>rule</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>ParseException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MatchPair</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>condition</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MatchPair</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isBlank</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rule</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>condition</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
       
        <span style=color:#000>MatchPair</span> <span style=color:#000>pair</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        
        <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>values</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>//根据Pattern.compile(&#34;([&amp;!=,]*)\\s*([^&amp;!=,\\s]+)&#34;);正则来匹配
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Matcher</span> <span style=color:#000>matcher</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ROUTE_PATTERN</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>matcher</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rule</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>matcher</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>find</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// Try to match one by one
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>String</span> <span style=color:#000>separator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>matcher</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>group</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>String</span> <span style=color:#000>content</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>matcher</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>group</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// Start part of the condition expression.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>separator</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>pair</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MatchPair</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#000>condition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pair</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#8f5902;font-style:italic>// The KV part of the condition expression
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;&amp;&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>separator</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>condition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>pair</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MatchPair</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#000>condition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pair</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>pair</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>condition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#8f5902;font-style:italic>// The Value in the KV part.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;=&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>separator</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pair</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ParseException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Illegal route rule \&#34;&#34;</span>
                            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>rule</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;\&#34;, The error char &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>separator</span>
                            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; at index &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>matcher</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; before \&#34;&#34;</span>
                            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>content</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;\&#34;.&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>matcher</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#ce5c00;font-weight:700>}</span>

                <span style=color:#000>values</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pair</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>matches</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>values</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#8f5902;font-style:italic>// The Value in the KV part.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;!=&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>separator</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pair</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ParseException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Illegal route rule \&#34;&#34;</span>
                            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>rule</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;\&#34;, The error char &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>separator</span>
                            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; at index &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>matcher</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; before \&#34;&#34;</span>
                            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>content</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;\&#34;.&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>matcher</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#ce5c00;font-weight:700>}</span>

                <span style=color:#000>values</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pair</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mismatches</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>values</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#8f5902;font-style:italic>// The Value in the KV part, if Value have more than one items.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;,&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>separator</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// Should be separated by &#39;,&#39;
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>values</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>values</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ParseException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Illegal route rule \&#34;&#34;</span>
                            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>rule</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;\&#34;, The error char &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>separator</span>
                            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; at index &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>matcher</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; before \&#34;&#34;</span>
                            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>content</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;\&#34;.&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>matcher</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#000>values</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ParseException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Illegal route rule \&#34;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>rule</span>
                        <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;\&#34;, The error char &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>separator</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; at index &#34;</span>
                        <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>matcher</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; before \&#34;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>content</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;\&#34;.&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>matcher</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>condition</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>例如 host = 2.2.2.2 & host != 1.1.1.1 & method = hello 循环结束后的内容</p><pre><code>{
    &quot;host&quot;: {
        &quot;matches&quot;: [&quot;2.2.2.2&quot;],
        &quot;mismatches&quot;: [&quot;1.1.1.1&quot;]
    },
    &quot;method&quot;: {
        &quot;matches&quot;: [&quot;hello&quot;],
        &quot;mismatches&quot;: []
    }
}
</code></pre><p><strong>服务路由：</strong></p><p>服务路由的入口方法是 <strong><code>ConditionRouter</code></strong> 的 <strong><code>router</code></strong> 方法，该方法定义在 <strong><code>Router</code></strong> 接口中。实现代码如下：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Invoker</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>route</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Invoker</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>invokers</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>URL</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Invocation</span> <span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>RpcException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//判断是否生效，如果enabled设置的为false直接返回
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>enabled</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>invokers</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CollectionUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>invokers</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>invokers</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 先对服务消费者条件进行匹配，如果匹配失败，表明服务消费者 url 不符合匹配规则，
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 无需进行后续匹配，直接返回 Invoker 列表即可。比如下面的规则：
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>//     host = 10.20.153.10 =&gt; host = 10.0.0.10
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 这条路由规则希望 IP 为 10.20.153.10 的服务消费者调用 IP 为 10.0.0.10 机器上的服务。
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 当消费者 ip 为 10.20.153.11 时，matchWhen 返回 false，表明当前这条路由规则不适用于
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 当前的服务消费者，此时无需再进行后续匹配，直接返回即可。
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>matchWhen</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>invokers</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Invoker</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Invoker</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;();</span>
            <span style=color:#8f5902;font-style:italic>//服务提供者匹配条件未配置，表明对指定的服务消费者禁用服务，也就是服务消费者在黑名单中
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//这个也在前面讲路由条件组成的情况下，服务通知匹配条件为空，表示对某些服务消费者禁用服务
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>thenCondition</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Invoker</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>invoker</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>invokers</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 若匹配成功，表明当前 Invoker 符合服务提供者匹配规则。
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 此时将 Invoker 添加到 result 列表中
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>matchThen</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>invoker</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUrl</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>invoker</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>force</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>//.....省略了打印日志
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>invokers</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=3-总结>3. 总结</h3><ul><li><strong>路由规则</strong></li><li><strong>路由规则获取对应的Invoke</strong></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-9a8e8a5bacab88fdcec9f751288fd29e>2.5 - Dubbo容错四大利器之—集群</h1><h3 id=1-集群容错>1. 集群容错</h3><p>集群容错包含的饿组件：</p><ul><li><strong>Cluster</strong></li><li><strong>Cluster Invoker</strong></li><li><strong>Directory</strong></li><li><strong>Router</strong></li><li><strong>LoadBalance</strong></li></ul><p>来自Dubbo官网的一张集群的组件之间的关系图：</p><p><img src=http://dubbo.incubator.apache.org/docs/zh-cn/source_code_guide/sources/images/cluster.jpg alt=关系图></p><p><strong>集群工作的两个阶段：</strong></p><ul><li><p><strong>服务消费者初始化期间</strong></p><p>集群 <strong><code>Cluster</code></strong> 实现类为服务消费者创建 <strong><code>Cluster Invoker</code></strong> 实例，即上图中的 merge 操作。</p></li><li><p><strong>服务消费者进行远程调用</strong></p><p><strong>FailoverClusterInvoker</strong> 为例子：</p><ul><li>调用 Directory 的 list 方法列举 Invoker 列表</li><li>并调用 Router 的 route 方法进行路由，过滤掉不符合路由规则的 Invoker</li><li>当 FailoverClusterInvoker 拿到 Directory 返回的 Invoker 列表后，它会通过 LoadBalance 从 Invoker 列表中选择一个 Inovker</li><li>FailoverClusterInvoker 会将参数传给 LoadBalance 选择出的 Invoker 实例的 invoker 方法，进行真正的远程调用</li></ul></li></ul><p><strong>Dubbo 主要提供了这样几种容错方式</strong>：</p><ul><li><strong>Failover Cluster - 失败自动切换</strong></li><li><strong>Failfast Cluster - 快速失败</strong></li><li><strong>Failsafe Cluster - 失败安全</strong></li><li><strong>Failback Cluster - 失败自动恢复</strong></li><li><strong>Forking Cluster - 并行调用多个服务提供者</strong></li></ul><h3 id=2-代码分析>2 代码分析</h3><p>以 <strong><code>FailoverCluster</code></strong> 为例子来讲：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>FailoverCluster</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Cluster</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>String</span> <span style=color:#000>NAME</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;failover&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Invoker</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>join</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Directory</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>directory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>RpcException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//创建返回FailoverClusterInvoker 对象就是上图的Merge过程
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FailoverClusterInvoker</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>directory</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>接下来看 <strong><code>FailoverClusterInvoker</code></strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>FailoverClusterInvoker</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractClusterInvoker</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>FailoverClusterInvoker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Directory</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>directory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>directory</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>({</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;rawtypes&#34;</span><span style=color:#ce5c00;font-weight:700>})</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Result</span> <span style=color:#000>doInvoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Invocation</span> <span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Invoker</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>invokers</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>LoadBalance</span> <span style=color:#000>loadbalance</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>RpcException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Invoker</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>copyInvokers</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>invokers</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>//判断是否为空
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>checkInvokers</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>copyInvokers</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>//获取执行方法的名称
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>String</span> <span style=color:#000>methodName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RpcUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethodName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getUrl</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getMethodParameter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methodName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RETRIES_KEY</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Constants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DEFAULT_RETRIES</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// retry loop.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>RpcException</span> <span style=color:#000>le</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// last exception.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Invoker</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>invoked</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Invoker</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;(</span><span style=color:#000>copyInvokers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>providers</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashSet</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>checkWhetherDestroyed</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#000>copyInvokers</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>checkInvokers</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>copyInvokers</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#8f5902;font-style:italic>//根据服务目录 路由  和 负载筛选出 Invoker  ----- 1
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>Invoker</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>invoker</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>select</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>loadbalance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>copyInvokers</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>invoked</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>invoked</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>invoker</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>RpcContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getContext</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>setInvokers</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>invoked</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>//执行远程调用  ---- 2
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>Result</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>invoker</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>le</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isWarnEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#8f5902;font-style:italic>//删除了此处的日子打印
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RpcException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isBiz</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// biz exception.
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#000>le</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>le</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RpcException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>providers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>invoker</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUrl</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getAddress</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RpcException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>le</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCode</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#4e9a06>&#34;Failed to invoke the method &#34;</span>
                <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>methodName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; in the service &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>getInterface</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span>
                <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;. Tried &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; times of the providers &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>providers</span>
                <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; (&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>providers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;/&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>copyInvokers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span>
                <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;) from the registry &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>directory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUrl</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getAddress</span><span style=color:#ce5c00;font-weight:700>()</span>
                <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; on the consumer &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>NetUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLocalHost</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; using the dubbo version &#34;</span>
                <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>Version</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getVersion</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;. Last error is: &#34;</span>
                <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>le</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>le</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCause</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>le</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCause</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>le</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-691974821e2bc4bfe1b87e9591d412e6>2.6 - Dubbo框架设计</h1><h3 id=框架设计图>框架设计图</h3><p><img src=http://dubbo.incubator.apache.org/docs/zh-cn/dev/sources/images/dubbo-framework.jpg alt=图></p></div><div class=td-content style=page-break-before:always><h1 id=pg-8fcbe43af4f428e5c9335f9c0064fc03>2.7 - Config模块分析</h1><h3 id=类之间的继承关系>类之间的继承关系</h3><p><img src="https://github.com/mxsm/document/blob/master/image/RPC/Dubbo/dubboconfig%E5%85%B3%E7%B3%BB%E5%9B%BE2.7.1%E7%89%88%E6%9C%AC.jpg?raw=true" alt=图解></p><p>从图可以看出配置都是继承 <strong><code>AbstractConfig</code></strong> 抽象类然后下面大致分成了八个：</p><ul><li><p><strong>RegistryConfig</strong></p><p>注册中心配置类，同时如果有多个注册中心可以声明多个 <code>&lt;dubbo:registry></code> 并且在 <code>&lt;dubbo:service></code> 或 <code>&lt;dubbo:reference></code> 的 <code>registry</code> 属性指定使用的注册中心。</p></li><li><p><strong>ProtocalConfig</strong></p><p>服务提供者协议配置类，同时，如果需要支持多个协议就可以声明多个<code>&lt;dubbo:protocol></code> 标签，并在 <code>&lt;dubbo:service></code> 中通过 <code>protocol</code> 属性指定使用的协议。</p></li><li><p><strong>MonitorConfig</strong></p><p>监控中心配置</p></li><li><p><strong>AbstractMethodConfig</strong></p><p>后续的继承分为消费者和提供者</p></li><li><p><strong>ConfigCenterConfig</strong></p><p>配置中心</p></li><li><p><strong>ModuleConfig</strong></p><p>模块信息配置</p></li><li><p><strong>MetadataReportConfig</strong></p><p>2.7.1版本新增的下面看一下Dubbo官方给的这个配置的解释说明</p><blockquote><h4 id=背景>背景</h4><p>dubbo provider中的服务配置项有接近<a href=http://dubbo.apache.org/en-us/docs/user/references/xml/dubbo-service.html>30个配置项</a>。 排除注册中心服务治理需要之外，很大一部分配置项是provider自己使用，不需要透传给消费者。这部分数据不需要进入注册中心，而只需要以key-value形式持久化存储。 dubbo consumer中的配置项也有<a href=http://dubbo.apache.org/en-us/docs/user/references/xml/dubbo-reference.html>20+个配置项</a>。在注册中心之中，服务消费者列表中只需要关注application，version，group，ip，dubbo版本等少量配置，其他配置也可以以key-value形式持久化存储。 这些数据是以服务为维度注册进入注册中心，导致了数据量的膨胀，进而引发注册中心(如zookeeper)的网络开销增大，性能降低。
除了上述配置项的存储之外，dubbo服务元数据信息也需要被存储下来。元数据信息包括服务接口，及接口的方法信息。这些信息将被用于服务mock，服务测试。</p><h4 id=目标>目标</h4><p>需要将注册中心原来的数据信息和元数据信息保存到独立的key-value的存储中，这个key-value可以是DB，redis或者其他持久化存储。核心代码中支持了zookeeper，redis(推荐)的默认支持。</p><p>provider存储内容的格式，参见：org.apache.dubbo.metadata.definition.model.FullServiceDefinition。是该类型gson化之后的存储。 Consumer存储内容，为Map格式。从Consumer端注册到注册中心的URL中的获取参数信息。即通过URL.getParameterMap()获取到的Map，进行gson话之后进行存储。</p></blockquote><p><a href=https://dubbo.incubator.apache.org/zh-cn/docs/user/references/metadata/introduction.html>元数据官方介绍</a></p></li><li><p><strong>ApplicationConfig</strong></p><p>应用信息配置</p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-1484c515461f0187953d4c24bd98eab0>2.8 - Dubbo容错四大利器之—负载均衡</h1><h3 id=1-负载均衡>1. 负载均衡</h3><p>Dubbo中负载均衡四个算法：</p><ul><li><strong>基于权重随机算法 — RandomLoadBalance</strong></li><li><strong>基于最少活跃调用数算法 — LeastActiveLoadBalance</strong></li><li><strong>基于 hash 一致性 — ConsistentHashLoadBalance</strong></li><li><strong>基于加权轮询算法 — RoundRobinLoadBalance</strong></li></ul><h3 id=2-randomloadbalance>2. RandomLoadBalance</h3><p>思想：假设我们有一组服务器 servers = [A, B, C]，他们对应的权重为 weights = [5, 3, 2]，权重总和为10。现在把这些权重值平铺在一维坐标值上，[0, 5) 区间属于服务器 A，[5, 8) 区间属于服务器 B，[8, 10) 区间属于服务器 C。接下来通过随机数生成器生成一个范围在 [0, 10) 之间的随机数，然后计算这个随机数会落到哪个区间上。比如数字3会落到服务器 A 对应的区间上，此时返回服务器 A 即可。权重越大的机器，在坐标轴上对应的区间范围就越大，因此随机数生成器生成的数字就会有更大的概率落到此区间内(<strong>简单的说就是把数据分布在一维坐标上然后把随机的数据分布的在坐标轴什么范围能表示是哪个服务器</strong>)</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>RandomLoadBalance</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractLoadBalance</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>NAME</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;random&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Invoker</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>doSelect</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Invoker</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>invokers</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>URL</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Invocation</span> <span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// Number of invokers
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>invokers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>// Every invoker has the same weight?
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>sameWeight</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// the weight of every invokers
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>weights</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>length</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#8f5902;font-style:italic>// the first invoker&#39;s weight
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>firstWeight</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getWeight</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>invokers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>weights</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>firstWeight</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// 下面这个循环有两个作用，第一是计算总权重 totalWeight，
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 第二是检测每个服务提供者的权重是否相同
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>totalWeight</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>firstWeight</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>length</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>weight</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getWeight</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>invokers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>weights</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>weight</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>totalWeight</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>weight</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sameWeight</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>weight</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>firstWeight</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>sameWeight</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>totalWeight</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>sameWeight</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 随机获取一个 [0, totalWeight) 区间内的数字
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ThreadLocalRandom</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>current</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>nextInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>totalWeight</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 循环让 offset 数减去服务提供者权重值，当 offset 小于0时，返回相应的 Invoker。
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 举例说明一下，我们有 servers = [A, B, C]，weights = [5, 3, 2]，offset = 7。
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 第一次循环，offset - 5 = 2 &gt; 0，即 offset &gt; 5，
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 表明其不会落在服务器 A 对应的区间上。
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 第二次循环，offset - 3 = -1 &lt; 0，即 5 &lt; offset &lt; 8，
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 表明其会落在服务器 B 对应的区间上
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//这个而不是直接用10个长度的数组来实现
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>length</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>-=</span> <span style=color:#000>weights</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>];</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>invokers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#8f5902;font-style:italic>// 如果所有服务提供者权重值相同，此时直接随机返回一个即可
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>invokers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ThreadLocalRandom</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>current</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>nextInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>length</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>优点：算法简单好实现，在经过多次请求后，能够将调用请求按照权重值进行“均匀”分配。— Dubbo缺省实现</strong></p><p><strong>缺点：调用次数较少时候Random 产生的随机数可能会比较集中，此时多数请求会落到同一台服务器上。</strong></p><h3 id=3-leastactiveloadbalance>3 LeastActiveLoadBalance</h3><p>思想：活跃调用数越小，表明该服务提供者效率越高，单位时间内可处理更多的请求。此时应优先将请求分配给该服务提供者。</p><p>实现方案：每个服务提供者对应一个活跃数 active。初始情况下，所有服务提供者活跃数均为0。每收到一个请求，活跃数加1，完成请求后则将活跃数减1。在服务运行一段时间后，性能好的服务提供者处理请求的速度更快，因此活跃数下降的也越快，此时这样的服务提供者能够优先获取到新的服务请求。<strong>在Dubbo的实现中还加入了权重(活跃相同取权重大的)以及随机的算法</strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>LeastActiveLoadBalance</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractLoadBalance</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>NAME</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;leastactive&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Invoker</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>doSelect</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Invoker</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>invokers</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>URL</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Invocation</span> <span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// Number of invokers
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>invokers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>// The least active value of all invokers
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>leastActive</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// The number of invokers having the same least active value (leastActive)
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>leastCount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// The index of invokers having the same least active value (leastActive)
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>leastIndexes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>length</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#8f5902;font-style:italic>// the weight of every invokers
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>weights</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>length</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#8f5902;font-style:italic>// The sum of the warmup weights of all the least active invokes
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>totalWeight</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// The weight of the first least active invoke
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>firstWeight</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// Every least active invoker has the same weight value?
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>sameWeight</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>


        <span style=color:#8f5902;font-style:italic>// Filter out all the least active invokers
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>length</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Invoker</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>invoker</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>invokers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// Get the active number of the invoke
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>active</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RpcStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStatus</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>invoker</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUrl</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethodName</span><span style=color:#ce5c00;font-weight:700>()).</span><span style=color:#c4a000>getActive</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#8f5902;font-style:italic>// Get the weight of the invoke configuration. The default value is 100.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>afterWarmup</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getWeight</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>invoker</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// save for later use
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>weights</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>afterWarmup</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>// If it is the first invoker or the active number of the invoker is less than the current least active number
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>leastActive</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>active</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>leastActive</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// Reset the active number of the current invoker to the least active number
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>leastActive</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>active</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#8f5902;font-style:italic>// Reset the number of least active invokers
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>leastCount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#8f5902;font-style:italic>// Put the first least active invoker first in leastIndexs
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>leastIndexes</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#8f5902;font-style:italic>// Reset totalWeight
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>totalWeight</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>afterWarmup</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#8f5902;font-style:italic>// Record the weight the first least active invoker
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>firstWeight</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>afterWarmup</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#8f5902;font-style:italic>// Each invoke has the same weight (only one invoker here)
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>sameWeight</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#8f5902;font-style:italic>// If current invoker&#39;s active value equals with leaseActive, then accumulating.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>active</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>leastActive</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// Record the index of the least active invoker in leastIndexs order
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>leastIndexes</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>leastCount</span><span style=color:#ce5c00;font-weight:700>++]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#8f5902;font-style:italic>// Accumulate the total weight of the least active invoker
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>totalWeight</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>afterWarmup</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#8f5902;font-style:italic>// If every invoker has the same weight?
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sameWeight</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span>
                        <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>afterWarmup</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>firstWeight</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>sameWeight</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// Choose an invoker from all the least active invokers
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>leastCount</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// If we got exactly one invoker having the least active value, return this invoker directly.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>invokers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>leastIndexes</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>]);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>sameWeight</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>totalWeight</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// If (not every invoker has the same weight &amp; at least one invoker&#39;s weight&gt;0), select randomly based on 
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// totalWeight.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>offsetWeight</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ThreadLocalRandom</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>current</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>nextInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>totalWeight</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// Return a invoker based on the random value.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>leastCount</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>leastIndex</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>leastIndexes</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>];</span>
                <span style=color:#000>offsetWeight</span> <span style=color:#ce5c00;font-weight:700>-=</span> <span style=color:#000>weights</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>leastIndex</span><span style=color:#ce5c00;font-weight:700>];</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offsetWeight</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>invokers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>leastIndex</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// If all invokers have the same weight value or totalWeight=0, return evenly.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>invokers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>leastIndexes</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>ThreadLocalRandom</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>current</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>nextInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>leastCount</span><span style=color:#ce5c00;font-weight:700>)]);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=4-consistenthashloadbalance>4. ConsistentHashLoadBalance</h3><h3 id=5-roundrobinloadbalance>5. RoundRobinLoadBalance</h3><p>思想：所谓轮询是指将请求轮流分配给每台服务器。举个例子，我们有三台服务器 A、B、C。我们将第一个请求分配给服务器 A，第二个请求分配给服务器 B，第三个请求分配给服务器 C，第四个请求再次分配给服务器 A。这个过程就叫做轮询。轮询是无状态的算法</p></div><div class=td-content style=page-break-before:always><h1 id=pg-e576977d48d1397f2791280be937d4a0>3 - Git</h1><p>Git常用的工具网站：</p><ul><li><a href=https://backlog.com/git-tutorial/cn/>https://backlog.com/git-tutorial/cn/</a></li></ul></div><div class=td-content><h1 id=pg-092880b73f25ee23e8d01762acb39500>3.1 - 如何将本地已有项目关联到github的新建的项目中</h1><p>一起养成写作习惯！这是我参与「掘金日新计划 · 4 月更文挑战」的第5天，<a href=https://juejin.cn/post/7080800226365145118>点击查看活动详情</a>。</p><h3 id=1背景>1.背景</h3><p>很多使用Git的人会遇到这样的情况，我在本地新建了一个项目(以Java项目举例)。此时这个Java项目还没有用Git进行管理。然后我们这个时候会去GitHub或者其他你想用来管理项目的Git后台创建一个项目。这个时候如何将本地的项目推送到服务器上？</p><p>一般的做法就是首先 <strong><code>GitHub</code></strong> 上建的项目 <strong><code>Clone</code></strong> 到本地。然后把新建的项目手动拷贝到项目中，然后把文件用Git进行管理。最后把文件 <strong><code>Push</code></strong> 到Github。其次我们还可以使用命令进行操作。下面就来说一说如何用命令的方式直接把两者关联进行管理。这个也是我们比较常见的方式。</p><h3 id=2-关联步骤>2. 关联步骤</h3><h4 id=21github创建项目>2.1Github创建项目</h4><p>本地项目如下：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/other/git/image-20220405200549240.png alt=image-20220405200549240></p><p>然后在Github上面创建名称和本地一样的项目：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/other/git/image-20220405200646074.png alt=image-20220405200646074></p><h4 id=22-git初始化本地项目>2.2 Git初始化本地项目</h4><p>用命令初始化本地项目：</p><pre><code>git init
git add .
git commit -m &quot;project init&quot;
</code></pre><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/other/git/image-20220405201219092.png alt=image-20220405201219092></p><h4 id=23-关联github项目>2.3 关联GitHub项目</h4><p>命令：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell> git remote add &lt;name&gt; &lt;url&gt;
</code></pre></div><p>例如：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git remote add origin git@github.com:mxsm/distributed-id-generator.git
</code></pre></div><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/other/git/image-20220405202603586.png alt=image-20220405202603586></p><p>此时已经关联起来了。</p><h4 id=24-pull远程库>2.4 pull远程库</h4><p>命令：</p><pre><code>git pull origin main --allow-unrelated-histories
</code></pre><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/other/git/image-20220405205318418.png alt=image-20220405205318418></p><h4 id=25-提交代码>2.5 提交代码</h4><pre><code>git push -u origin main 
</code></pre><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/other/git/image-20220405205419581.png alt=image-20220405205419581></p><p>到这里就完成了本地项目关联到GitHub的项目。</p><h4 id=26-验证>2.6 验证</h4><p>打开GitHub项目进行验证：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/other/git/image-20220405205707203.png alt=image-20220405205707203></p><p>以及提交关联了。</p><blockquote><p>Tips: 以上操作是GitHub已经添加了SSH key的情况下进行操作的。没有添加的可以自行进行添加</p></blockquote><h3 id=3-总结>3. 总结</h3><p>本地将本地已有项目关联到github的新建的项目中主要使用的是命令：<strong>git remote add <name><url></strong>。平时工作中也用的比较多。</p><blockquote><p>我是蚂蚁背大象，文章对你有帮助点赞关注我，文章有不正确的地方请您斧正留言评论~谢谢</p></blockquote><p><strong>参考资料：</strong></p><ul><li><a href=https://docs.github.com/cn/authentication/connecting-to-github-with-ssh/checking-for-existing-ssh-keys>https://docs.github.com/cn/authentication/connecting-to-github-with-ssh/checking-for-existing-ssh-keys</a></li><li><a href=https://docs.github.com/cn/authentication/connecting-to-github-with-ssh/adding-a-new-ssh-key-to-your-github-account>https://docs.github.com/cn/authentication/connecting-to-github-with-ssh/adding-a-new-ssh-key-to-your-github-account</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-ec34fc0ffa6f9c2e572617734f4d7781>3.2 - Git版本回退</h1><h3 id=使用命令>使用命令</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git reset <span style=color:#ce5c00;font-weight:700>[</span>-q<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>&lt;tree-ish&gt;<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>--<span style=color:#ce5c00;font-weight:700>]</span> &lt;pathspec&gt;…​
git reset <span style=color:#ce5c00;font-weight:700>[</span>-q<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>--pathspec-from-file<span style=color:#ce5c00;font-weight:700>=</span>&lt;file&gt; <span style=color:#ce5c00;font-weight:700>[</span>--pathspec-file-nul<span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#ce5c00;font-weight:700>[</span>&lt;tree-ish&gt;<span style=color:#ce5c00;font-weight:700>]</span>
git reset <span style=color:#ce5c00;font-weight:700>(</span>--patch <span style=color:#000;font-weight:700>|</span> -p<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>[</span>&lt;tree-ish&gt;<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>--<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>&lt;pathspec&gt;…​<span style=color:#ce5c00;font-weight:700>]</span>
git reset <span style=color:#ce5c00;font-weight:700>[</span>--soft <span style=color:#000;font-weight:700>|</span> --mixed <span style=color:#ce5c00;font-weight:700>[</span>-N<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000;font-weight:700>|</span> --hard <span style=color:#000;font-weight:700>|</span> --merge <span style=color:#000;font-weight:700>|</span> --keep<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>-q<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>&lt;commit&gt;<span style=color:#ce5c00;font-weight:700>]</span>
</code></pre></div><h3 id=使用演示>使用演示</h3><p>首先建一个git仓库如下图：</p><p><img src=https://raw.githubusercontent.com/mxsm/document/master/image/git/reset1.png alt></p><p>然后通过命令:</p><blockquote><p>git log &ndash;pretty=oneline</p></blockquote><p>查看提交纪录</p><p><img src=https://raw.githubusercontent.com/mxsm/document/master/image/git/reset2.png alt></p><p>常用的reset命令有两种：</p><blockquote><p>git reset &ndash;soft 保留之前的修改</p><p>git reset &ndash;hard 丢弃所有的改变</p></blockquote><h4 id=git-reset---hard>git reset &ndash;hard</h4><p><img src=https://raw.githubusercontent.com/mxsm/document/master/image/git/reset3.png alt></p><p><img src=https://raw.githubusercontent.com/mxsm/document/master/image/git/reset4.png alt></p><h4 id=git-reset---soft>git reset &ndash;soft</h4><p><img src=https://raw.githubusercontent.com/mxsm/document/master/image/git/reset5.png alt></p><p><img src=https://raw.githubusercontent.com/mxsm/document/master/image/git/reset6.png alt></p><h4 id=提交远程>提交远程</h4><p><img src=https://raw.githubusercontent.com/mxsm/document/master/image/git/reset7.png alt></p><blockquote><p><a href=https://www.cnblogs.com/kidsitcn/p/4513297.html>git reset soft,hard,mixed之区别深解</a> 可以看一下这篇文章，同样自己也可以用souretree去看一下。</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-55a8c521e6b929fad4d62890a5901b5c>3.3 - Git常用命令-Tag</h1><h3 id=git-基础---打标签>Git 基础 - 打标签</h3><h4 id=打标签>打标签</h4><p>像其他版本控制系统（VCS）一样，Git 可以给历史中的某一个提交打上标签，以示重要。 比较有代表性的是人们会使用这个功能来标记发布结点（v1.0 等等）。 在本节中，你将会学习如何列出已有的标签、如何创建新标签、以及不同类型的标签分别是什么。</p><h3 id=列出标签>列出标签</h3><p>在 Git 中列出已有的标签是非常简单直观的。 只需要输入 <code>git tag</code>：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ git tag
v0.1
v1.3
</code></pre></div><p>这个命令以字母顺序列出标签；但是它们出现的顺序并不重要。</p><p>你也可以使用特定的模式查找标签。 例如，Git 自身的源代码仓库包含标签的数量超过 500 个。 如果只对 1.8.5 系列感兴趣，可以运行：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ git tag -l <span style=color:#4e9a06>&#39;v1.8.5*&#39;</span>
v1.8.5
v1.8.5-rc0
v1.8.5-rc1
v1.8.5-rc2
v1.8.5-rc3
v1.8.5.1
v1.8.5.2
v1.8.5.3
v1.8.5.4
v1.8.5.5
</code></pre></div><h3 id=创建标签>创建标签</h3><p>Git 使用两种主要类型的标签：轻量标签（lightweight）与附注标签（annotated）。</p><p>一个轻量标签很像一个不会改变的分支——它只是一个特定提交的引用。</p><p>然而，附注标签是存储在 Git 数据库中的一个完整对象。 它们是可以被校验的；其中包含打标签者的名字、电子邮件地址、日期时间；还有一个标签信息；并且可以使用 GNU Privacy Guard （GPG）签名与验证。 通常建议创建附注标签，这样你可以拥有以上所有信息；但是如果你只是想用一个临时的标签，或者因为某些原因不想要保存那些信息，轻量标签也是可用的。</p><h4 id=附注标签>附注标签</h4><p>在 Git 中创建一个附注标签是很简单的。 最简单的方式是当你在运行 <code>tag</code> 命令时指定 <code>-a</code> 选项：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ git tag -a v1.4 -m <span style=color:#4e9a06>&#34;my version 1.4&#34;</span>
$ git tag
v0.1
v1.3
v1.4
</code></pre></div><p><code>-m</code> 选项指定了一条将会存储在标签中的信息。 如果没有为附注标签指定一条信息，Git 会运行编辑器要求你输入信息。</p><p>通过使用 <code>git show</code> 命令可以看到标签信息与对应的提交信息：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ git show v1.4
tag v1.4
Tagger: Ben Straub &lt;ben@straub.cc&gt;
Date:   Sat May <span style=color:#0000cf;font-weight:700>3</span> 20:19:12 <span style=color:#0000cf;font-weight:700>2014</span> -0700

my version 1.4

commit ca82a6dff817ec66f44342007202690a93763949
Author: Scott Chacon &lt;schacon@gee-mail.com&gt;
Date:   Mon Mar <span style=color:#0000cf;font-weight:700>17</span> 21:52:11 <span style=color:#0000cf;font-weight:700>2008</span> -0700

    changed the version number
</code></pre></div><p>输出显示了打标签者的信息、打标签的日期时间、附注信息，然后显示具体的提交信息。</p><h4 id=轻量标签>轻量标签</h4><p>另一种给提交打标签的方式是使用轻量标签。 轻量标签本质上是将提交校验和存储到一个文件中——没有保存任何其他信息。 创建轻量标签，不需要使用 <code>-a</code>、<code>-s</code> 或 <code>-m</code> 选项，只需要提供标签名字：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ git tag v1.4-lw
$ git tag
v0.1
v1.3
v1.4
v1.4-lw
v1.5
</code></pre></div><p>这时，如果在标签上运行 <code>git show</code>，你不会看到额外的标签信息。 命令只会显示出提交信息：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ git show v1.4-lw
commit ca82a6dff817ec66f44342007202690a93763949
Author: Scott Chacon &lt;schacon@gee-mail.com&gt;
Date:   Mon Mar <span style=color:#0000cf;font-weight:700>17</span> 21:52:11 <span style=color:#0000cf;font-weight:700>2008</span> -0700

    changed the version number
</code></pre></div><h4 id=后期打标签>后期打标签</h4><p>你也可以对过去的提交打标签。 假设提交历史是这样的：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ git log --pretty<span style=color:#ce5c00;font-weight:700>=</span>oneline
15027957951b64cf874c3557a0f3547bd83b3ff6 Merge branch <span style=color:#4e9a06>&#39;experiment&#39;</span>
a6b4c97498bd301d84096da251c98a07c7723e65 beginning write support
0d52aaab4479697da7686c15f77a3d64d9165190 one more thing
6d52a271eda8725415634dd79daabbc4d9b6008e Merge branch <span style=color:#4e9a06>&#39;experiment&#39;</span>
0b7434d86859cc7b8c3d5e1dddfed66ff742fcbc added a commit <span style=color:#204a87;font-weight:700>function</span>
4682c3261057305bdd616e23b64b0857d832627b added a todo file
166ae0c4d3f420721acbb115cc33848dfcc2121a started write support
9fceb02d0ae598e95dc970b74767f19372d61af8 updated rakefile
964f16d36dfccde844893cac5b347e7b3d44abbc commit the todo
8a5cbc430f1a9c3d00faaeffd07798508422908a updated readme
</code></pre></div><p>现在，假设在 v1.2 时你忘记给项目打标签，也就是在 “updated rakefile” 提交。 你可以在之后补上标签。 要在那个提交上打标签，你需要在命令的末尾指定提交的校验和（或部分校验和）：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ git tag -a v1.2 9fceb02
</code></pre></div><p>可以看到你已经在那次提交上打上标签了：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ git tag
v0.1
v1.2
v1.3
v1.4
v1.4-lw
v1.5

$ git show v1.2
tag v1.2
Tagger: Scott Chacon &lt;schacon@gee-mail.com&gt;
Date:   Mon Feb <span style=color:#0000cf;font-weight:700>9</span> 15:32:16 <span style=color:#0000cf;font-weight:700>2009</span> -0800

version 1.2
commit 9fceb02d0ae598e95dc970b74767f19372d61af8
Author: Magnus Chacon &lt;mchacon@gee-mail.com&gt;
Date:   Sun Apr <span style=color:#0000cf;font-weight:700>27</span> 20:43:35 <span style=color:#0000cf;font-weight:700>2008</span> -0700

    updated rakefile
...
</code></pre></div><h4 id=共享标签>共享标签</h4><p>默认情况下，<code>git push</code> 命令并不会传送标签到远程仓库服务器上。 在创建完标签后你必须显式地推送标签到共享服务器上。 这个过程就像共享远程分支一样——你可以运行 <code>git push origin [tagname]</code>。</p><pre><code class=language-console data-lang=console>$ git push origin v1.5
Counting objects: 14, done.
Delta compression using up to 8 threads.
Compressing objects: 100% (12/12), done.
Writing objects: 100% (14/14), 2.05 KiB | 0 bytes/s, done.
Total 14 (delta 3), reused 0 (delta 0)
To git@github.com:schacon/simplegit.git
 * [new tag]         v1.5 -&gt; v1.5
</code></pre><p>如果想要一次性推送很多标签，也可以使用带有 <code>--tags</code> 选项的 <code>git push</code> 命令。 这将会把所有不在远程仓库服务器上的标签全部传送到那里。</p><pre><code class=language-console data-lang=console>$ git push origin --tags
Counting objects: 1, done.
Writing objects: 100% (1/1), 160 bytes | 0 bytes/s, done.
Total 1 (delta 0), reused 0 (delta 0)
To git@github.com:schacon/simplegit.git
 * [new tag]         v1.4 -&gt; v1.4
 * [new tag]         v1.4-lw -&gt; v1.4-lw
</code></pre><p>现在，当其他人从仓库中克隆或拉取，他们也能得到你的那些标签。</p><h3 id=删除标签>删除标签</h3><p>要删除掉你本地仓库上的标签，可以使用命令 <code>git tag -d </code>。例如，可以使用下面的命令删除掉一个轻量级标签：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ git tag -d v1.4-lw
Deleted tag <span style=color:#4e9a06>&#39;v1.4-lw&#39;</span> <span style=color:#ce5c00;font-weight:700>(</span>was e7d5add<span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>应该注意的是上述命令并不会从任何远程仓库中移除这个标签，你必须使用 <code>git push :refs/tags/</code> 来更新你的远程仓库：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ git push origin :refs/tags/v1.4-lw
To /git@github.com:schacon/simplegit.git
 - <span style=color:#ce5c00;font-weight:700>[</span>deleted<span style=color:#ce5c00;font-weight:700>]</span>         v1.4-lw
</code></pre></div><h3 id=检出标签>检出标签</h3><p>如果你想查看某个标签所指向的文件版本，可以使用 <code>git checkout</code> 命令，虽然说这会使你的仓库处于“分离头指针（detacthed HEAD）”状态——这个状态有些不好的副作用：</p><pre><code class=language-console data-lang=console>$ git checkout 2.0.0
Note: checking out '2.0.0'.

You are in 'detached HEAD' state. You can look around, make experimental
changes and commit them, and you can discard any commits you make in this
state without impacting any branches by performing another checkout.

If you want to create a new branch to retain commits you create, you may
do so (now or later) by using -b with the checkout command again. Example:

  git checkout -b &lt;new-branch&gt;

HEAD is now at 99ada87... Merge pull request #89 from schacon/appendix-final

$ git checkout 2.0-beta-0.1
Previous HEAD position was 99ada87... Merge pull request #89 from schacon/appendix-final
HEAD is now at df3f601... add atlas.json and cover image
</code></pre><p>在“分离头指针”状态下，如果你做了某些更改然后提交它们，标签不会发生变化，但你的新提交将不属于任何分支，并且将无法访问，除非确切的提交哈希。因此，如果你需要进行更改——比如说你正在修复旧版本的错误——这通常需要创建一个新分支：</p><pre><code class=language-console data-lang=console>$ git checkout -b version2 v2.0.0
Switched to a new branch 'version2'
</code></pre><p>当然，如果在这之后又进行了一次提交，<code>version2</code> 分支会因为这个改动向前移动，<code>version2</code> 分支就会和 <code>v2.0.0</code> 标签稍微有些不同，这时就应该当心了。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-22d3b6c2b275d6435a01ec3135988ccd>4 - Maven</h1></div><div class=td-content><h1 id=pg-ba2f6b8953ac7bf92ecd08f22dd38dec>4.1 - maven-mvnd比maven更快的maven</h1><h3 id=1-前言>1. 前言</h3><p>对于Java开发者而言，Maven和Gradle是使用的比较多的两个打包构建项目的工具。以前使用Java后端开发使用Maven的比较多，安卓开发使用Gradle。这两年Gradle开始慢慢的蚕食Maven。随着Spring-Boot项目由Maven迁移到了Gradle(太惨了Maven,我个人比价喜欢Maven)。在github上无意间看到了apache 下面有一个项目叫 Mavan-mvnd(开始还以为是一个插件)。下面来看一下这个工具</p><h3 id=2-什么是maven-mvnd>2. 什么是maven-mvnd?</h3><p>maven-mvnd全称：Apache Maven Daemon。主要借鉴了Gradle和Takari所知的技术提供更快的Maven构建。</p><p>maven-mvnd架构：</p><ul><li>mvnd内嵌Maven(所以不需要单独安装Maven)</li><li>实际的构建发生在一个长期存在的后台进程中(守护进程)</li><li>一个守护进程实例可以服务于来自mvnd客户端的多个连续请求</li><li>mvnd客户端是一个使用GraalVM构建的本地可执行文件。与启动传统JVM相比，它启动得更快，占用的内存更少</li><li>没有空闲守护进程来服务一个构建请求，可以并行地生成多个守护进程</li></ul><p>架构带来的好处：</p><ul><li>用于运行实际构建的JVM不需要每次构建都重新启动</li><li>持有Maven插件类的类加载器在多个构建中被缓存。因此，插件jar文件只被读取和解析一次。快照版本(SNAPSHOT)的Maven插件不会被缓存。</li><li>JVM中即时(JIT)编译器生成的本地代码也被保留。与常规Maven相比，JIT编译所花费的时间更少。在重复构建期间，jit优化的代码立即可用。这不仅适用于来自Maven插件和Maven Core的代码，也适用于所有来自JDK本身的代码。</li></ul><blockquote><p>GraalVM的核心就是Graal编译器，一款优秀的JIT编译器.</p></blockquote><p>在官方网站还给了一个测试的动态图来说明：</p><p><img src=https://user-images.githubusercontent.com/1826249/103917178-94ee4500-510d-11eb-9abb-f52dae58a544.gif alt></p><h3 id=3-linux如何安装mvnd>3. Linux如何安装mvnd</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>wget https://github.com/apache/maven-mvnd/releases/download/0.7.1/mvnd-0.7.1-linux-amd64.zip
</code></pre></div><p>下载然后解压</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>unzip mvnd-0.7.1-linux-amd64.zip
</code></pre></div><p>将bin添加到PATH。</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/maven/mvndversion.png alt></p><p>到这里就按照完成了。</p><h3 id=4-mvn和mvnd打包rocketmq的时间对比>4. mvn和mvnd打包rocketmq的时间对比</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>mvn -Prelease-all -DskipTests clean install -U
</code></pre></div><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/maven/mvn%E6%89%93%E5%8C%85.png alt></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>mvnd -T <span style=color:#0000cf;font-weight:700>4</span> -Prelease-all -DskipTests clean install -U -Dquickly -Dmvnd.serial<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>4</span> 
</code></pre></div><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/maven/mvnd%E6%89%93%E5%8C%85.png alt></p><p>从上面对比可以看出来打包时间明显缩短很多。</p><h3 id=5-总结>5. 总结</h3><p>从使用来说打包时间有较大的缩短。还是有很大的提升。但是现在这个项目估计还在测试阶段和发展阶段。后续还需要开发工具的支持等等。可以观望一下，但是如果在服务器自己使用我感觉完全可以。还有一个问题现在这个项目的资料比较少。主要都来自Github项目介绍，遇到问题就需要自己去摸索，使用也需要自己探索。</p><p>参考文档：</p><ul><li><a href=https://github.com/apache/maven-mvnd>https://github.com/apache/maven-mvnd</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-67760cad93268097d30ecf76c30d9ca2>4.2 - Maven-自定义archetype</h1><blockquote><p>基于Maven 3.6.3版本</p></blockquote><h3 id=什么是archetype>什么是archetype</h3><p>简单一点说archetype就是一个创建工程的模板。这样的好处在哪里呢？就是不用每次新建一个项目就要去把maven中的配置pom配置一遍我们需要的一些通用的东西。</p><p>这里举个栗子：比如你搭建spring-boot项目简单的无非不是在pom文件中添加一些spring-boot的必须的依赖。那么你新建十个项目你就要添加十次。想想累不累烦不烦。所以maven archetype就是来解决这个问题的。那么我们来看一下怎么开发这样一个模板。然后倒入idea中在后续的过程中使用</p><h3 id=自定义archetype>自定义archetype</h3><p>自定义从现有网上和官网的资料来看有两种方式：</p><ol><li>从现有的个人项目生成模板(通过命令)</li><li>手写添加模板</li></ol><h4 id=从现有的个人项目生成模板通过命令>从现有的个人项目生成模板(通过命令)</h4><p>我这边就以创建一个spring-boot项目为例子。首先新建一个如下图所示的项目，这个项目是一个标准的Spring-boot web项目：</p><p><img src="https://github.com/mxsm/document/blob/master/image/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/Maven/archtypeslearning.gif?raw=true" alt></p><p>项目创建好了以后去到项目下面执行(E:\develop\workspace\mxsm\archtypes-learning) ： <strong><code>mvn archetype:create-from-project</code></strong></p><p>如下图所示：</p><p><img src="https://github.com/mxsm/document/blob/master/image/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/Maven/archtypeslearningcreate.gif?raw=true" alt></p><p>执行完成脚本后。会在 <strong>target/generated-sources/archetype</strong> 这样一个目录：</p><p><img src="https://github.com/mxsm/document/blob/master/image/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/Maven/archtypestruct.png?raw=true" alt></p><p>然后去目录下面执行： <strong><code>mvn install</code></strong> 命令</p><blockquote><p>这里需要注意，如果你和我一样都是用的 idea 新建的项目然后生成的。那么需要稍微处理一下。</p><ol><li><p>找到target\generated-sources\archetype\src\main\resources\META-INF\maven目录下面的archetype-metadata.xml文件删除和idea相关的东西。把下图注释的部分删掉。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;archetype-descriptor</span> <span style=color:#c4a000>xsi:schemaLocation=</span><span style=color:#4e9a06>&#34;https://maven.apache.org/plugins/maven-archetype-plugin/archetype-descriptor/1.1.0 http://maven.apache.org/xsd/archetype-descriptor-1.1.0.xsd&#34;</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;archtypes-learning&#34;</span>
    <span style=color:#c4a000>xmlns=</span><span style=color:#4e9a06>&#34;https://maven.apache.org/plugins/maven-archetype-plugin/archetype-descriptor/1.1.0&#34;</span>
    <span style=color:#c4a000>xmlns:xsi=</span><span style=color:#4e9a06>&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;fileSets&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;fileSet</span> <span style=color:#c4a000>filtered=</span><span style=color:#4e9a06>&#34;true&#34;</span> <span style=color:#c4a000>packaged=</span><span style=color:#4e9a06>&#34;true&#34;</span> <span style=color:#c4a000>encoding=</span><span style=color:#4e9a06>&#34;UTF-8&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;directory&gt;</span>src/main/java<span style=color:#204a87;font-weight:700>&lt;/directory&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;includes&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;include&gt;</span>**/*.java<span style=color:#204a87;font-weight:700>&lt;/include&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;/includes&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/fileSet&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;fileSet</span> <span style=color:#c4a000>encoding=</span><span style=color:#4e9a06>&#34;UTF-8&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;directory&gt;</span>src/main/resources<span style=color:#204a87;font-weight:700>&lt;/directory&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;includes&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;include&gt;</span>**/*.yml<span style=color:#204a87;font-weight:700>&lt;/include&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;/includes&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/fileSet&gt;</span>
<span style=color:#8f5902;font-style:italic>&lt;!--    &lt;fileSet filtered=&#34;true&#34; encoding=&#34;UTF-8&#34;&gt;
</span><span style=color:#8f5902;font-style:italic>      &lt;directory&gt;.idea&lt;/directory&gt;
</span><span style=color:#8f5902;font-style:italic>      &lt;includes&gt;
</span><span style=color:#8f5902;font-style:italic>        &lt;include&gt;**/*.xml&lt;/include&gt;
</span><span style=color:#8f5902;font-style:italic>      &lt;/includes&gt;
</span><span style=color:#8f5902;font-style:italic>    &lt;/fileSet&gt;
</span><span style=color:#8f5902;font-style:italic>    &lt;fileSet encoding=&#34;UTF-8&#34;&gt;
</span><span style=color:#8f5902;font-style:italic>      &lt;directory&gt;.idea&lt;/directory&gt;
</span><span style=color:#8f5902;font-style:italic>      &lt;includes&gt;
</span><span style=color:#8f5902;font-style:italic>        &lt;include&gt;**/*.gitignore&lt;/include&gt;
</span><span style=color:#8f5902;font-style:italic>      &lt;/includes&gt;
</span><span style=color:#8f5902;font-style:italic>    &lt;/fileSet&gt;
</span><span style=color:#8f5902;font-style:italic>    &lt;fileSet encoding=&#34;UTF-8&#34;&gt;
</span><span style=color:#8f5902;font-style:italic>      &lt;directory&gt;&lt;/directory&gt;
</span><span style=color:#8f5902;font-style:italic>      &lt;includes&gt;
</span><span style=color:#8f5902;font-style:italic>        &lt;include&gt;archtypes-learning.iml&lt;/include&gt;
</span><span style=color:#8f5902;font-style:italic>      &lt;/includes&gt;
</span><span style=color:#8f5902;font-style:italic>    &lt;/fileSet&gt;--&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;/fileSets&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/archetype-descriptor&gt;</span>
</code></pre></div></li><li><p>找到target\generated-sources\archetype\src\main\resources\archetype-resources目录删除 .iml文件和.idea目录</p></li></ol><p>这样生成的才不会有问题后续的使用。</p></blockquote><p><img src="https://github.com/mxsm/document/blob/master/image/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/Maven/archtypeslearninginstall.gif?raw=true" alt></p><blockquote><p>Maven的官方地址：https://maven.apache.org/archetype/maven-archetype-plugin/advanced-usage.html</p></blockquote><p>这个archtype在本地maven仓库的一个archetype-catalog.xml文件中可以看到：</p><p><img src="https://github.com/mxsm/document/blob/master/image/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/Maven/archtypecatolog.png?raw=true" alt></p><p>接下来演示如何如何在idea中使用。如下图：</p><p><img src="https://github.com/mxsm/document/blob/master/image/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/Maven/archtypeslearninguse1.gif?raw=true" alt></p><p>这样就创建好了一个自定义的模板以后就可以使用了。</p><h4 id=手动创建>手动创建</h4><p>手动创建又是怎么一回事，说白了就是把 <strong><code>mvn archetype:create-from-project</code></strong> 命令干的活自己干一遍。</p><blockquote><p>Maven的官方教程：http://maven.apache.org/guides/mini/guide-creating-archetypes.html</p></blockquote><p>这里就不多说，但是需要大家注意一个地方就是如下图结构(官方拷贝)</p><pre><code>archetype
|-- pom.xml  -- 这个pom里面的packaging是需要注意的
`-- src
    `-- main
        `-- resources
            |-- META-INF
            |   `-- maven
            |       `--archetype-metadata.xml
            `-- archetype-resources
                |-- pom.xml
                `-- src
                    |-- main
                    |   `-- java
                    |       `-- App.java
                    `-- test
                        `-- java
                            `-- AppTest.java
</code></pre><p>看一下archetype下面的这个pom文件(内容来自官方文档)：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;project</span> <span style=color:#c4a000>xmlns=</span><span style=color:#4e9a06>&#34;http://maven.apache.org/POM/4.0.0&#34;</span> <span style=color:#c4a000>xmlns:xsi=</span><span style=color:#4e9a06>&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
  <span style=color:#c4a000>xsi:schemaLocation=</span><span style=color:#4e9a06>&#34;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;modelVersion&gt;</span>4.0.0<span style=color:#204a87;font-weight:700>&lt;/modelVersion&gt;</span>
 
  <span style=color:#204a87;font-weight:700>&lt;groupId&gt;</span>my.groupId<span style=color:#204a87;font-weight:700>&lt;/groupId&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;artifactId&gt;</span>my-archetype-id<span style=color:#204a87;font-weight:700>&lt;/artifactId&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;version&gt;</span>1.0-SNAPSHOT<span style=color:#204a87;font-weight:700>&lt;/version&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;packaging&gt;</span>maven-archetype<span style=color:#204a87;font-weight:700>&lt;/packaging&gt;</span>  <span style=color:#8f5902;font-style:italic>&lt;!-- 这个地方是maven-archetype --&gt;</span>
 
  <span style=color:#204a87;font-weight:700>&lt;build&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;extensions&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;extension&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;groupId&gt;</span>org.apache.maven.archetype<span style=color:#204a87;font-weight:700>&lt;/groupId&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;artifactId&gt;</span>archetype-packaging<span style=color:#204a87;font-weight:700>&lt;/artifactId&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;version&gt;</span>3.1.1<span style=color:#204a87;font-weight:700>&lt;/version&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;/extension&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/extensions&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;/build&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/project&gt;</span>
</code></pre></div><p>里面的packaging这个地方不熟pom或者jar。而是maven-archetype这个地方一定要注意。这种手动的方式我就演示了具体的例子我提供了两种：</p><ul><li><a href=https://github.com/apache/maven-archetypes>官方例子</a></li><li><a href=https://github.com/mxsm/mxsm-archetypes>我的例子</a></li></ul><p>官方例子就是在IDEA中使用的那些。最基本的，我这是spring-boot的一个脚手架。后续这里会更新更多的脚手架：Dubbo、spring cloud等等后续会进行更新。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-b2abc3c459aa6755fc84d0f9a37420fa>5 - Mybatis</h1></div><div class=td-content><h1 id=pg-e7f6382310d7fe7aec09a43ae19591da>5.1 - 深入理解mybatis原理-SQL的执行过程</h1><blockquote><p>以下分析基于mybatis 3.5.2版本</p></blockquote><h3 id=mybatis框架>Mybatis框架</h3><p>MyBatis框架主要完成的是以下2件事情：</p><ol><li>根据JDBC规范建立与数据库的连接</li><li>通过反射打通Java对象与数据库参数交互之间相互转换的关系</li></ol><p>这个就是mybatis以及ORM框架主要做的两件事情</p><h3 id=mybatis-主要类介绍>Mybatis 主要类介绍</h3><ul><li><p><strong>Configuration</strong></p><p>MyBatis所有的配置信息都维持在Configuration对象之中，在也就是mybatis的xml，configuration节点</p></li><li><p><strong>SqlSession</strong></p><p>作为MyBatis工作的主要顶层API，表示和数据库交互的会话，完成必要数据库增删改查功能</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>org.apache.ibatis.session</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.io.Closeable</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.sql.Connection</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.List</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.Map</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.ibatis.cursor.Cursor</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.ibatis.executor.BatchResult</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>SqlSession</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Closeable</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>T</span> <span style=color:#000>selectOne</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>);</span>

  <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>T</span> <span style=color:#000>selectOne</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>);</span>

  <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>selectList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>);</span>

  <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>selectList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>);</span>

  <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>selectList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RowBounds</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>);</span>

  <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>selectMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>mapKey</span><span style=color:#ce5c00;font-weight:700>);</span>

  <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>selectMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>mapKey</span><span style=color:#ce5c00;font-weight:700>);</span>

  <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>selectMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>mapKey</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RowBounds</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>);</span>

  <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Cursor</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>selectCursor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>);</span>

  <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Cursor</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>selectCursor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>);</span>

  <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Cursor</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>selectCursor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RowBounds</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>);</span>

  <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>select</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ResultHandler</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>);</span>

  <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>select</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ResultHandler</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>);</span>

  <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>select</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RowBounds</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ResultHandler</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>);</span>

  <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>insert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>);</span>

  <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>insert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>);</span>

  <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>update</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>);</span>

  <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>update</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>);</span>

  <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>delete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>);</span>

  <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>delete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>);</span>

  <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>commit</span><span style=color:#ce5c00;font-weight:700>();</span>

  <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>commit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>force</span><span style=color:#ce5c00;font-weight:700>);</span>

  <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>rollback</span><span style=color:#ce5c00;font-weight:700>();</span>

  <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>rollback</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>force</span><span style=color:#ce5c00;font-weight:700>);</span>

  <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BatchResult</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>flushStatements</span><span style=color:#ce5c00;font-weight:700>();</span>

  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>();</span>

  <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>clearCache</span><span style=color:#ce5c00;font-weight:700>();</span>

  <span style=color:#000>Configuration</span> <span style=color:#000>getConfiguration</span><span style=color:#ce5c00;font-weight:700>();</span>

  <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>T</span> <span style=color:#000>getMapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>

  <span style=color:#000>Connection</span> <span style=color:#000>getConnection</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div></li><li><p><strong>Executor</strong></p><p>MyBatis执行器，是MyBatis 调度的核心，负责SQL语句的生成和查询缓存的维护</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Executor</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#000>ResultHandler</span> <span style=color:#000>NO_RESULT_HANDLER</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>update</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MappedStatement</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>query</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MappedStatement</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RowBounds</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ResultHandler</span> <span style=color:#000>resultHandler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CacheKey</span> <span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BoundSql</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>query</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MappedStatement</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RowBounds</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ResultHandler</span> <span style=color:#000>resultHandler</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Cursor</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>queryCursor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MappedStatement</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RowBounds</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BatchResult</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>flushStatements</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>commit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>required</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>rollback</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>required</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#000>CacheKey</span> <span style=color:#000>createCacheKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MappedStatement</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RowBounds</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BoundSql</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>);</span>

  <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isCached</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MappedStatement</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CacheKey</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>

  <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>clearLocalCache</span><span style=color:#ce5c00;font-weight:700>();</span>

  <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>deferLoad</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MappedStatement</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MetaObject</span> <span style=color:#000>resultObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CacheKey</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>targetType</span><span style=color:#ce5c00;font-weight:700>);</span>

  <span style=color:#000>Transaction</span> <span style=color:#000>getTransaction</span><span style=color:#ce5c00;font-weight:700>();</span>

  <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>forceRollback</span><span style=color:#ce5c00;font-weight:700>);</span>

  <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isClosed</span><span style=color:#ce5c00;font-weight:700>();</span>

  <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setExecutorWrapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Executor</span> <span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li><li><p><strong>StatementHandler</strong></p><p>封装了JDBC Statement操作，负责对JDBC statement 的操作，如设置参数、将Statement结果集转换成List集合</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>StatementHandler</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#000>Statement</span> <span style=color:#000>prepare</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Connection</span> <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Integer</span> <span style=color:#000>transactionTimeout</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>parameterize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Statement</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>batch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Statement</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>update</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Statement</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>query</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Statement</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ResultHandler</span> <span style=color:#000>resultHandler</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Cursor</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>queryCursor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Statement</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#000>BoundSql</span> <span style=color:#000>getBoundSql</span><span style=color:#ce5c00;font-weight:700>();</span>

  <span style=color:#000>ParameterHandler</span> <span style=color:#000>getParameterHandler</span><span style=color:#ce5c00;font-weight:700>();</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li><li><p><strong>ParameterHandler</strong></p><p>负责对用户传递的参数转换成JDBC Statement 所需要的参数</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>ParameterHandler</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#000>Object</span> <span style=color:#000>getParameterObject</span><span style=color:#ce5c00;font-weight:700>();</span>

  <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setParameters</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PreparedStatement</span> <span style=color:#000>ps</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li><li><p><strong>ResultSetHandler</strong></p><p>负责将JDBC返回的ResultSet结果集对象转换成List类型的集合(单个查询是通过列表查询得来的)</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>ResultSetHandler</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>handleResultSets</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Statement</span> <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Cursor</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>handleCursorResultSets</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Statement</span> <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>handleOutputParameters</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CallableStatement</span> <span style=color:#000>cs</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li><li><p><strong>TypeHandler</strong></p><p>负责java数据类型和jdbc数据类型之间的映射和转换</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>TypeHandler</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setParameter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PreparedStatement</span> <span style=color:#000>ps</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>T</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>JdbcType</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * @param columnName Colunm name, when configuration &lt;code&gt;useColumnLabel&lt;/code&gt; is &lt;code&gt;false&lt;/code&gt;
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#000>T</span> <span style=color:#000>getResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResultSet</span> <span style=color:#000>rs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>columnName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#000>T</span> <span style=color:#000>getResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResultSet</span> <span style=color:#000>rs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>columnIndex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#000>T</span> <span style=color:#000>getResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CallableStatement</span> <span style=color:#000>cs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>columnIndex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li><li><p><strong>MappedStatement</strong></p><p>MappedStatement维护了一条&lt;select|update|delete|insert>节点的封装</p></li><li><p><strong>SqlSource</strong></p><p>负责根据用户传递的parameterObject，动态地生成SQL语句，将信息封装到BoundSql对象中，并返回</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>SqlSource</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#000>BoundSql</span> <span style=color:#000>getBoundSql</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li><li><p><strong>BoundSql</strong></p><p>表示动态生成的SQL语句以及相应的参数信息</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BoundSql</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ParameterMapping</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>parameterMappings</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>additionalParameters</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MetaObject</span> <span style=color:#000>metaParameters</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BoundSql</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Configuration</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ParameterMapping</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>parameterMappings</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sql</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parameterMappings</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parameterMappings</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parameterObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>additionalParameters</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>metaParameters</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newMetaObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>additionalParameters</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getSql</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ParameterMapping</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getParameterMappings</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>parameterMappings</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getParameterObject</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>hasAdditionalParameter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>String</span> <span style=color:#000>paramName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PropertyTokenizer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>additionalParameters</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>paramName</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setAdditionalParameter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>metaParameters</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getAdditionalParameter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>metaParameters</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><img src="https://img-blog.csdn.net/20141028140852531?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvbHVhbmxvdWlz/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt></p><p>图片来源：https://blog.csdn.net/luanlouis/article/details/40422941</p></li><li><p><strong>Interceptor</strong></p><p>拦截器，MyBatis 允许你在已映射语句执行过程中的某一点进行拦截调用。默认情况下，MyBatis 允许使用插件来拦截的方法调用包括：</p><ul><li>Executor (update, query, flushStatements, commit, rollback, getTransaction, close, isClosed)</li><li>ParameterHandler (getParameterObject, setParameters)</li><li>ResultSetHandler (handleResultSets, handleOutputParameters)</li><li>StatementHandler (prepare, parameterize, batch, update, query)</li></ul></li></ul><h3 id=sql的执行流程>SQL的执行流程</h3><blockquote><p>示例的代码：https://github.com/mxsm/spring-sample/tree/master/mxsm-mybatis</p></blockquote><p><img src="https://github.com/mxsm/document/blob/master/image/orm%E6%A1%86%E6%9E%B6/mybatis/%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%81.png?raw=true" alt=示例图></p><p>上图是项目的目录结构和主要的代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ApplicationStart</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>String</span> <span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;mybatis-config.xml&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>InputStream</span> <span style=color:#000>inputStream</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Resources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceAsStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>SqlSessionFactory</span> <span style=color:#000>sqlSessionFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SqlSessionFactoryBuilder</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>build</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputStream</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>RoleMapper</span> <span style=color:#000>roleMapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>openSession</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getMapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RoleMapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>Roles</span> <span style=color:#000>roles</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>roleMapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>select</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;ROLE_ADMIN&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>roles</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUsername</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过上面的代码以 <strong><code>SqlSessionFactory</code></strong> 方式创建，主要有两个步骤：</p><ul><li><a href=#%E8%A7%A3%E6%9E%90mybatis%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6>解析mybatis的配置文件</a></li><li><a href=#%E6%89%A7%E8%A1%8CMapper%E4%B8%AD%E7%9A%84%E6%96%B9%E6%B3%95>执行Mapper中的方法</a></li></ul><p>解析从这个两个方面来根据源码来分析整个执行的SQL的过程。</p><h3 id=解析mybatis的配置文件>解析mybatis的配置文件</h3><p>跟进 <code>SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);</code> 这段代码可以发现。代码中主要调用了下面的方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>SqlSessionFactory</span> <span style=color:#000>build</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InputStream</span> <span style=color:#000>inputStream</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>environment</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Properties</span> <span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>XMLConfigBuilder</span> <span style=color:#000>parser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>XMLConfigBuilder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputStream</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>environment</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>build</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ExceptionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wrapException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error building SqlSession.&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>ErrorContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>reset</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>inputStream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IOException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// Intentionally ignore. Prefer previous error.
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这个方法在 <strong>SqlSessionFactoryBuilder#build</strong> 中。通过 <strong><code>XMLConfigBuilder</code></strong> 解析出来 <strong><code>Configuration</code></strong> 来构建 <strong><code>SqlSessionFactory</code></strong> 。</p><blockquote><p><strong><code>Configuration</code></strong> 在上面的主要类中说明了，这个是mybatis的一个重要的类。</p></blockquote><h4 id=xmlconfigbuilderparse方法解析>XMLConfigBuilder#parse方法解析</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Configuration</span> <span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parsed</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Each XMLConfigBuilder can only be used once.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>parsed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>parseConfiguration</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/configuration&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在 <strong>XMLConfigBuilder#parse</strong> 方法中主要调用 <strong>XMLConfigBuilder#parseConfiguration</strong> (这个过程有把xml文档解析成Document的过程这里不做分析)</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>parseConfiguration</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>//issue #117 read properties first
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>propertiesElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;properties&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#000>Properties</span> <span style=color:#000>settings</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>settingsAsProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;settings&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#000>loadCustomVfs</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>settings</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>loadCustomLogImpl</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>settings</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>typeAliasesElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;typeAliases&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#000>pluginElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;plugins&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#000>objectFactoryElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;objectFactory&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#000>objectWrapperFactoryElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;objectWrapperFactory&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#000>reflectorFactoryElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;reflectorFactory&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#000>settingsElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>settings</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// read it after objectFactory and objectWrapperFactory issue #631
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>environmentsElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;environments&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#000>databaseIdProviderElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;databaseIdProvider&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#000>typeHandlerElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;typeHandlers&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#000>mapperElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;mappers&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error parsing SQL Mapper Configuration. Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这个方法把mybatis的配置xml中的配置节点解析为Java对应的类。根据上面的我们看一下主要的几个</p><ul><li><a href=#plugins>plugins解析</a></li><li><a href=#typeHandlers>typeHandlers</a></li><li><a href=#mappers--%E6%9C%80%E9%87%8D%E8%A6%81%E7%9A%84>mappers</a></li></ul><h5 id=plugins>plugins</h5><p>主要是一个拦截器：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>pluginElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>child</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildren</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>String</span> <span style=color:#000>interceptor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;interceptor&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>Properties</span> <span style=color:#000>properties</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildrenAsProperties</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>Interceptor</span> <span style=color:#000>interceptorInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Interceptor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>resolveClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>interceptor</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>interceptorInstance</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addInterceptor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>interceptorInstance</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>生成的拦截器添加到 <strong>Configuration</strong> 类的实例中去。</p><h5 id=typehandlers>typeHandlers</h5><p>类型处理器，返回的类型处理：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>typeHandlerElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>child</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildren</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;package&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>String</span> <span style=color:#000>typeHandlerPackage</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>typeHandlerRegistry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>register</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeHandlerPackage</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>String</span> <span style=color:#000>javaTypeName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;javaType&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>String</span> <span style=color:#000>jdbcTypeName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;jdbcType&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>String</span> <span style=color:#000>handlerTypeName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;handler&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>javaTypeClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>javaTypeName</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>JdbcType</span> <span style=color:#000>jdbcType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveJdbcType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>jdbcTypeName</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>typeHandlerClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handlerTypeName</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>javaTypeClass</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>jdbcType</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#000>typeHandlerRegistry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>register</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>javaTypeClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>typeHandlerClass</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#000>typeHandlerRegistry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>register</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>javaTypeClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>typeHandlerClass</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>typeHandlerRegistry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>register</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeHandlerClass</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>添加类型处理器有两种方式：</p><ul><li>package</li><li>typeHandler</li></ul><p>同样这些实例化的对象都保存到 <strong>Configuration</strong> 类的实例中去了。</p><h5 id=mappers--最重要的>mappers&ndash;最重要的</h5><p>mapper主要把接口的文件和SQL的xml结合起来，下面来看一下代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>mapperElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>child</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildren</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;package&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>String</span> <span style=color:#000>mapperPackage</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addMappers</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mapperPackage</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>String</span> <span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;resource&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>String</span> <span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;url&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>String</span> <span style=color:#000>mapperClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;class&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>mapperClass</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>ErrorContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>resource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>InputStream</span> <span style=color:#000>inputStream</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Resources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceAsStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>XMLMapperBuilder</span> <span style=color:#000>mapperParser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>XMLMapperBuilder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputStream</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSqlFragments</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#000>mapperParser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>mapperClass</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>ErrorContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>resource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>InputStream</span> <span style=color:#000>inputStream</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Resources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUrlAsStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>XMLMapperBuilder</span> <span style=color:#000>mapperParser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>XMLMapperBuilder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputStream</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSqlFragments</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#000>mapperParser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>mapperClass</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>mapperInterface</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Resources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>classForName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mapperClass</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addMapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mapperInterface</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;A mapper element may only specify a url, resource or class, but not more than one.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面代码也给了两种注入方式：</p><ul><li><p>package</p><p>这个是以包的方式添加</p></li><li><p>mapper</p><p>这种是以单一的方式添加xml文件或者mapper接口文件</p></li></ul><p>对于mapper如果是xml的话， <strong><code>XMLMapperBuilder</code></strong> 主要是用来解析mybatis的mapperxml的。下面就解析来分析。</p><h3 id=xmlmapperbuilder源码解析>XMLMapperBuilder源码解析</h3><p>同样XMLMapperBuilder主要是调用parse方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isResourceLoaded</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>configurationElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/mapper&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addLoadedResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>bindMapperForNamespace</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#000>parsePendingResultMaps</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>parsePendingCacheRefs</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>parsePendingStatements</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过代码可以看出来上面的代码主要做了五件事情：</p><ol><li><p><strong>加载mapper资源</strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>configurationElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>String</span> <span style=color:#000>namespace</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;namespace&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>namespace</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>namespace</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Mapper&#39;s namespace cannot be empty&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>builderAssistant</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCurrentNamespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>namespace</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>cacheRefElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;cache-ref&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#000>cacheElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;cache&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>//官网介绍已经废弃了parameterMap--具体可看一下官网的说明
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>parameterMapElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNodes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/mapper/parameterMap&#34;</span><span style=color:#ce5c00;font-weight:700>));</span> 
      <span style=color:#000>resultMapElements</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNodes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/mapper/resultMap&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#000>sqlElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNodes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/mapper/sql&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#000>buildStatementFromContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNodes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;select|insert|update|delete&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error parsing Mapper XML. The XML location is &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;. Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>处理mapper下面的所有节点。</p></li><li><p><strong>绑定Mapper和配置的namespace</strong></p><p>绑定Mapper xml和配置的 mapper接口</p></li><li><p><strong>解析准备ResultMap节点</strong></p></li><li><p><strong>解析准备缓存引用</strong></p></li><li><p><strong>解析准备Statement</strong></p></li></ol><blockquote><p>这里通过源码分析可以看出来，在解析mapper xml的时候，如果namespace配置的接口类不存在是不会抛错的。</p></blockquote><h3 id=执行mapper中的方法>执行Mapper中的方法</h3><p>首先看一下代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>RoleMapper</span> <span style=color:#000>roleMapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>openSession</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getMapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RoleMapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>先看一下 <strong><code>openSession</code></strong> 方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>SqlSession</span> <span style=color:#000>openSession</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>openSessionFromDataSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDefaultExecutorType</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>SqlSession</span> <span style=color:#000>openSessionFromDataSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ExecutorType</span> <span style=color:#000>execType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TransactionIsolationLevel</span> <span style=color:#000>level</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>autoCommit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Transaction</span> <span style=color:#000>tx</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Environment</span> <span style=color:#000>environment</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>TransactionFactory</span> <span style=color:#000>transactionFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getTransactionFactoryFromEnvironment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>environment</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>tx</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>transactionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newTransaction</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>environment</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDataSource</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>level</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>autoCommit</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Executor</span> <span style=color:#000>executor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newExecutor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>execType</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DefaultSqlSession</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>autoCommit</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>closeTransaction</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tx</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// may have fetched a connection so lets call close()
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ExceptionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wrapException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error opening session.  Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>ErrorContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>reset</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这个的默认实现 <strong><code>DefaultSqlSessionFactory</code></strong> 返回的是一个默认的 <strong><code>DefaultSqlSession</code></strong> 。下面来看一下获取 <strong><code>getMapper</code></strong> 方法源代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>T</span> <span style=color:#000>getMapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div><p>通过代码发现是调用了 <strong><code>Configuration.getMapper</code></strong> 方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>T</span> <span style=color:#000>getMapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SqlSession</span> <span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>mapperRegistry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>T</span> <span style=color:#000>getMapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SqlSession</span> <span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MapperProxyFactory</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>mapperProxyFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MapperProxyFactory</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#000>knownMappers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mapperProxyFactory</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BindingException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Type &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; is not known to the MapperRegistry.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>mapperProxyFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BindingException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error getting mapper instance. Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过研究代码发现是 <strong><code>mapperRegistry</code></strong> 变量中根据Mapper的接口类type获取 <strong><code>MapperProxyFactory</code></strong> 的代理工厂，然后通过 <strong><code>MapperProxyFactory#newInstance</code></strong> 创建 <strong>Mapper</strong> 接口的代理类。获取Mapper的接口对象来执行SQL可以看出来，这里获取的是代理类。那么这个 <strong><code>MapperProxyFactory</code></strong> 什么时候创建的添加到 <strong><code>mapperRegistry</code></strong> 对象中去的。 在前面分析解析mybatis文件的时候有解析mapper配置的时候有这样的一段代码(XMLMapperBuilder#bindMapperForNamespace)：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>bindMapperForNamespace</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>String</span> <span style=color:#000>namespace</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>builderAssistant</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCurrentNamespace</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>namespace</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>boundType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>boundType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Resources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>classForName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>namespace</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassNotFoundException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//ignore, bound type is not required
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>boundType</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasMapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>boundType</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// Spring may not know the real resource name so we set a flag
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#8f5902;font-style:italic>// to prevent loading again this resource from the mapper interface
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#8f5902;font-style:italic>// look at MapperAnnotationBuilder#loadXmlResource
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addLoadedResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;namespace:&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>namespace</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addMapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>boundType</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这段代码有这样一段代码： <strong>configuration.addMapper(boundType)</strong> ，下面来看这段代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>addMapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>mapperRegistry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addMapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这里面调用了 <strong><code>MapperRegistry#addMapper</code></strong> 方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>addMapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInterface</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasMapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BindingException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Type &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; is already known to the MapperRegistry.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>loadCompleted</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//在这里创建了MapperProxyFactory并且添加
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>knownMappers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MapperProxyFactory</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#8f5902;font-style:italic>// It&#39;s important that the type is added before the parser is run
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// otherwise the binding may automatically be attempted by the
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// mapper parser. If the type is already known, it won&#39;t try.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>MapperAnnotationBuilder</span> <span style=color:#000>parser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MapperAnnotationBuilder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>loadCompleted</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>loadCompleted</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>knownMappers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过代理来执行数据库的逻辑。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-30532d22a8014280e5253f2624861330>5.2 - 深入理解mybatis原理-MyBatis的架构设计</h1><p>MyBatis是目前非常流行的ORM框架，它的功能很强大，然而其实现却比较简单、优雅。这里会更加网上的找到的现有资料和结合MyBatis(<a href=https://github.com/mybatis/mybatis-3/releases/tag/mybatis-3.5.4>mybatis-3.5.4</a>)的版本来进行分析。</p><h3 id=mybatis的框架设计>MyBatis的框架设计</h3><p>这个框架设计图来源于https://blog.csdn.net/luanlouis/article/details/40422941这个博客。</p><p><img src="https://img-blog.csdn.net/20141028232313593?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvbHVhbmxvdWlz/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt></p></div><div class=td-content style=page-break-before:always><h1 id=pg-6f10502e052f2f61f9073d0bbcc16e6e>5.3 - 深入理解mybatis原理-MyBatis配置xml文件解析</h1><h3 id=mybatis创建的两种方式>Mybatis创建的两种方式</h3><ul><li><strong>从XML中构建 SqlSessionFactory</strong></li><li><strong>用Java代码创建SqlSessionFactory</strong></li></ul><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ApplicationStart</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>String</span> <span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;mybatis-config.xml&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>InputStream</span> <span style=color:#000>inputStream</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Resources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceAsStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>SqlSessionFactory</span> <span style=color:#000>sqlSessionFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SqlSessionFactoryBuilder</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>build</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputStream</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>RoleMapper</span> <span style=color:#000>roleMapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>openSession</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getMapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RoleMapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>Roles</span> <span style=color:#000>roles</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>roleMapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>select</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;ROLE_ADMIN&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div><p>上面代码就是通过读取xml配置文件来创建 <strong><code>SqlSessionFactory</code></strong></p><p><img src="https://github.com/mxsm/document/blob/master/image/orm%E6%A1%86%E6%9E%B6/mybatis/mybatisproject.jpg?raw=true" alt></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34; ?&gt;</span>
<span style=color:#8f5902;font-style:italic>&lt;!DOCTYPE configuration
</span><span style=color:#8f5902;font-style:italic>  PUBLIC &#34;-//mybatis.org//DTD Config 3.0//EN&#34;
</span><span style=color:#8f5902;font-style:italic>  &#34;http://mybatis.org/dtd/mybatis-3-config.dtd&#34;&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;configuration&gt;</span>
  
  <span style=color:#204a87;font-weight:700>&lt;settings&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;setting</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;logImpl&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;LOG4J2&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;/settings&gt;</span>
  
  
  <span style=color:#204a87;font-weight:700>&lt;environments</span> <span style=color:#c4a000>default=</span><span style=color:#4e9a06>&#34;development&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;environment</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;development&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;transactionManager</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;JDBC&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;dataSource</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;POOLED&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;driver&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;${jdbc}&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;url&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;${url}&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;username&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;${user}&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;password&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;${password}&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;/dataSource&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/environment&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;/environments&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;mappers&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;mapper</span> <span style=color:#c4a000>resource=</span><span style=color:#4e9a06>&#34;mapper/RoleMapper.xml&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;/mappers&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/configuration&gt;</span>
</code></pre></div><h3 id=mybatis配置xml源码解析>Mybatis配置xml源码解析</h3><p>通过xml来创建SqlSessionFactory，通过分析xml的源码看一下是如何加载和解析配置的xml的。我们从以下几个方面来分析：</p><ul><li>configuration（配置）<ul><li>properties（属性）</li><li>settings（设置）</li><li>typeAliases（类型别名)</li><li>typeHandlers（类型处理器）</li><li>objectFactory（对象工厂）</li><li>plugins（插件）</li><li>environments（环境配置）<ul><li>environment（环境变量）<ul><li>transactionManager（事务管理器）</li><li>dataSource（数据源）</li></ul></li></ul></li><li>databaseIdProvider（数据库厂商标识）</li><li>mappers（映射器)</li></ul></li></ul><p>通过上面创建SqlSessionFactory代码可以发现：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>SqlSessionFactory</span> <span style=color:#000>build</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InputStream</span> <span style=color:#000>inputStream</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>environment</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Properties</span> <span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>XMLConfigBuilder</span> <span style=color:#000>parser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>XMLConfigBuilder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputStream</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>environment</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>build</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ExceptionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wrapException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error building SqlSession.&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>ErrorContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>reset</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>inputStream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IOException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// Intentionally ignore. Prefer previous error.
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>配置是通过 <strong><code>XMLConfigBuilder</code></strong> 解析出来的。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>XMLConfigBuilder</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BaseBuilder</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>parsed</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>XPathParser</span> <span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>environment</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ReflectorFactory</span> <span style=color:#000>localReflectorFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DefaultReflectorFactory</span><span style=color:#ce5c00;font-weight:700>();</span>

<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BaseBuilder</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Configuration</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>TypeAliasRegistry</span> <span style=color:#000>typeAliasRegistry</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>TypeHandlerRegistry</span> <span style=color:#000>typeHandlerRegistry</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>配置xml的解析是通过 <strong><code>XMLConfigBuilder#parse</code></strong> 方法解析的。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Configuration</span> <span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parsed</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Each XMLConfigBuilder can only be used once.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>parsed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>//调用方法解析configuration节点
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>parseConfiguration</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/configuration&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>parseConfiguration</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>//issue #117 read properties first
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>//解析properties节点
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>propertiesElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;properties&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>//解析settings节点
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Properties</span> <span style=color:#000>settings</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>settingsAsProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;settings&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#000>loadCustomVfs</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>settings</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>loadCustomLogImpl</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>settings</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>//解析typeAliases
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>typeAliasesElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;typeAliases&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>//解析plugins
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>pluginElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;plugins&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>//objectFactory
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>objectFactoryElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;objectFactory&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#000>objectWrapperFactoryElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;objectWrapperFactory&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#000>reflectorFactoryElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;reflectorFactory&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#000>settingsElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>settings</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// read it after objectFactory and objectWrapperFactory issue #631
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>environmentsElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;environments&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#000>databaseIdProviderElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;databaseIdProvider&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#000>typeHandlerElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;typeHandlers&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#000>mapperElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;mappers&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error parsing SQL Mapper Configuration. Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=properties解析>properties解析</h4><p>properties解析主要是 <strong>propertiesElement</strong> 方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>propertiesElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>Properties</span> <span style=color:#000>defaults</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildrenAsProperties</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#000>String</span> <span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;resource&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>String</span> <span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;url&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The properties element cannot specify both a URL and a resource based property file reference.  Please specify one or the other.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>defaults</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Resources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceAsProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>defaults</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Resources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUrlAsProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>Properties</span> <span style=color:#000>vars</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getVariables</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>vars</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>defaults</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>vars</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setVariables</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>defaults</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setVariables</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>defaults</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>解析后的属性存储在 XPathParser.variables 变量和 BaseBuilder.configuration 变量中。</p><h4 id=settings解析>settings解析</h4><p>配置节点的解析,该节点主要是为Java类 <strong>Configuration</strong> 设置对应的数据</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Properties</span> <span style=color:#000>settingsAsProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Properties</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>Properties</span> <span style=color:#000>props</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildrenAsProperties</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// Check that all settings are known to the configuration class
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>MetaClass</span> <span style=color:#000>metaConfig</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MetaClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>localReflectorFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>props</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>keySet</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>metaConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasSetter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>valueOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The setting &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; is not known.  Make sure you spelled it correctly (case sensitive).&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>props</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在 <strong>parseConfiguration</strong> 方法中主要是三个方法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#8f5902;font-style:italic>//获取settings节点下面的配置数据转换为Properties
</span><span style=color:#8f5902;font-style:italic></span> <span style=color:#000>Properties</span> <span style=color:#000>settings</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>settingsAsProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;settings&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
 <span style=color:#000>loadCustomVfs</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>settings</span><span style=color:#ce5c00;font-weight:700>);</span>  <span style=color:#8f5902;font-style:italic>// 加载自定义的vfs格式
</span><span style=color:#8f5902;font-style:italic></span> <span style=color:#000>loadCustomLogImpl</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>settings</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//设置自定义日志实现
</span><span style=color:#8f5902;font-style:italic></span> <span style=color:#000>settingsElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>settings</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//为configuration对象设置配置的属性
</span></code></pre></div><p>下面是settings下面配置的setting的变量：</p><table><thead><tr><th style=text-align:left>设置名</th><th style=text-align:left>描述</th><th style=text-align:left>有效值</th><th style=text-align:left>默认值</th></tr></thead><tbody><tr><td style=text-align:left>cacheEnabled</td><td style=text-align:left>全局地开启或关闭配置文件中的所有映射器已经配置的任何缓存。</td><td style=text-align:left>true | false</td><td style=text-align:left>true</td></tr><tr><td style=text-align:left>lazyLoadingEnabled</td><td style=text-align:left>延迟加载的全局开关。当开启时，所有关联对象都会延迟加载。 特定关联关系中可通过设置 <code>fetchType</code> 属性来覆盖该项的开关状态。</td><td style=text-align:left>true | false</td><td style=text-align:left>false</td></tr><tr><td style=text-align:left>aggressiveLazyLoading</td><td style=text-align:left>当开启时，任何方法的调用都会加载该对象的所有属性。 否则，每个属性会按需加载（参考 <code>lazyLoadTriggerMethods</code>)。</td><td style=text-align:left>true | false</td><td style=text-align:left>false （在 3.4.1 及之前的版本默认值为 true）</td></tr><tr><td style=text-align:left>multipleResultSetsEnabled</td><td style=text-align:left>是否允许单一语句返回多结果集（需要驱动支持）。</td><td style=text-align:left>true | false</td><td style=text-align:left>true</td></tr><tr><td style=text-align:left>useColumnLabel</td><td style=text-align:left>使用列标签代替列名。不同的驱动在这方面会有不同的表现，具体可参考相关驱动文档或通过测试这两种不同的模式来观察所用驱动的结果。</td><td style=text-align:left>true | false</td><td style=text-align:left>true</td></tr><tr><td style=text-align:left>useGeneratedKeys</td><td style=text-align:left>允许 JDBC 支持自动生成主键，需要驱动支持。 如果设置为 true 则这个设置强制使用自动生成主键，尽管一些驱动不能支持但仍可正常工作（比如 Derby）。</td><td style=text-align:left>true | false</td><td style=text-align:left>False</td></tr><tr><td style=text-align:left>autoMappingBehavior</td><td style=text-align:left>指定 MyBatis 应如何自动映射列到字段或属性。 NONE 表示取消自动映射；PARTIAL 只会自动映射没有定义嵌套结果集映射的结果集。 FULL 会自动映射任意复杂的结果集（无论是否嵌套）。</td><td style=text-align:left>NONE, PARTIAL, FULL</td><td style=text-align:left>PARTIAL</td></tr><tr><td style=text-align:left>autoMappingUnknownColumnBehavior</td><td style=text-align:left>指定发现自动映射目标未知列（或者未知属性类型）的行为。<code>NONE</code>: 不做任何反应<code>WARNING</code>: 输出提醒日志 (<code>'org.apache.ibatis.session.AutoMappingUnknownColumnBehavior'</code> 的日志等级必须设置为 <code>WARN</code>)<code>FAILING</code>: 映射失败 (抛出 <code>SqlSessionException</code>)</td><td style=text-align:left>NONE, WARNING, FAILING</td><td style=text-align:left>NONE</td></tr><tr><td style=text-align:left>defaultExecutorType</td><td style=text-align:left>配置默认的执行器。SIMPLE 就是普通的执行器；REUSE 执行器会重用预处理语句（prepared statements）； BATCH 执行器将重用语句并执行批量更新。</td><td style=text-align:left>SIMPLE REUSE BATCH</td><td style=text-align:left>SIMPLE</td></tr><tr><td style=text-align:left>defaultStatementTimeout</td><td style=text-align:left>设置超时时间，它决定驱动等待数据库响应的秒数。</td><td style=text-align:left>任意正整数</td><td style=text-align:left>未设置 (null)</td></tr><tr><td style=text-align:left>defaultFetchSize</td><td style=text-align:left>为驱动的结果集获取数量（fetchSize）设置一个提示值。此参数只可以在查询设置中被覆盖。</td><td style=text-align:left>任意正整数</td><td style=text-align:left>未设置 (null)</td></tr><tr><td style=text-align:left>defaultResultSetType</td><td style=text-align:left>Specifies a scroll strategy when omit it per statement settings. (Since: 3.5.2)</td><td style=text-align:left>FORWARD_ONLY | SCROLL_SENSITIVE | SCROLL_INSENSITIVE | DEFAULT(same behavior with &lsquo;Not Set&rsquo;)</td><td style=text-align:left>Not Set (null)</td></tr><tr><td style=text-align:left>safeRowBoundsEnabled</td><td style=text-align:left>允许在嵌套语句中使用分页（RowBounds）。如果允许使用则设置为 false。</td><td style=text-align:left>true | false</td><td style=text-align:left>False</td></tr><tr><td style=text-align:left>safeResultHandlerEnabled</td><td style=text-align:left>允许在嵌套语句中使用分页（ResultHandler）。如果允许使用则设置为 false。</td><td style=text-align:left>true | false</td><td style=text-align:left>True</td></tr><tr><td style=text-align:left>mapUnderscoreToCamelCase</td><td style=text-align:left>是否开启自动驼峰命名规则（camel case）映射，即从经典数据库列名 A_COLUMN 到经典 Java 属性名 aColumn 的类似映射。</td><td style=text-align:left>true | false</td><td style=text-align:left>False</td></tr><tr><td style=text-align:left>localCacheScope</td><td style=text-align:left>MyBatis 利用本地缓存机制（Local Cache）防止循环引用（circular references）和加速重复嵌套查询。 默认值为 SESSION，这种情况下会缓存一个会话中执行的所有查询。 若设置值为 STATEMENT，本地会话仅用在语句执行上，对相同 SqlSession 的不同调用将不会共享数据。</td><td style=text-align:left>SESSION | STATEMENT</td><td style=text-align:left>SESSION</td></tr><tr><td style=text-align:left>jdbcTypeForNull</td><td style=text-align:left>当没有为参数提供特定的 JDBC 类型时，为空值指定 JDBC 类型。 某些驱动需要指定列的 JDBC 类型，多数情况直接用一般类型即可，比如 NULL、VARCHAR 或 OTHER。</td><td style=text-align:left>JdbcType 常量，常用值：NULL, VARCHAR 或 OTHER。</td><td style=text-align:left>OTHER</td></tr><tr><td style=text-align:left>lazyLoadTriggerMethods</td><td style=text-align:left>指定哪个对象的方法触发一次延迟加载。</td><td style=text-align:left>用逗号分隔的方法列表。</td><td style=text-align:left>equals,clone,hashCode,toString</td></tr><tr><td style=text-align:left>defaultScriptingLanguage</td><td style=text-align:left>指定动态 SQL 生成的默认语言。</td><td style=text-align:left>一个类型别名或完全限定类名。</td><td style=text-align:left>org.apache.ibatis.scripting.xmltags.XMLLanguageDriver</td></tr><tr><td style=text-align:left>defaultEnumTypeHandler</td><td style=text-align:left>指定 Enum 使用的默认 <code>TypeHandler</code> 。（新增于 3.4.5）</td><td style=text-align:left>一个类型别名或完全限定类名。</td><td style=text-align:left>org.apache.ibatis.type.EnumTypeHandler</td></tr><tr><td style=text-align:left>callSettersOnNulls</td><td style=text-align:left>指定当结果集中值为 null 的时候是否调用映射对象的 setter（map 对象时为 put）方法，这在依赖于 Map.keySet() 或 null 值初始化的时候比较有用。注意基本类型（int、boolean 等）是不能设置成 null 的。</td><td style=text-align:left>true | false</td><td style=text-align:left>false</td></tr><tr><td style=text-align:left>returnInstanceForEmptyRow</td><td style=text-align:left>当返回行的所有列都是空时，MyBatis默认返回 <code>null</code>。 当开启这个设置时，MyBatis会返回一个空实例。 请注意，它也适用于嵌套的结果集 （如集合或关联）。（新增于 3.4.2）</td><td style=text-align:left>true | false</td><td style=text-align:left>false</td></tr><tr><td style=text-align:left>logPrefix</td><td style=text-align:left>指定 MyBatis 增加到日志名称的前缀。</td><td style=text-align:left>任何字符串</td><td style=text-align:left>未设置</td></tr><tr><td style=text-align:left>logImpl</td><td style=text-align:left>指定 MyBatis 所用日志的具体实现，未指定时将自动查找。</td><td style=text-align:left>SLF4J | LOG4J | LOG4J2 | JDK_LOGGING | COMMONS_LOGGING | STDOUT_LOGGING | NO_LOGGING</td><td style=text-align:left>未设置</td></tr><tr><td style=text-align:left>proxyFactory</td><td style=text-align:left>指定 Mybatis 创建具有延迟加载能力的对象所用到的代理工具。</td><td style=text-align:left>CGLIB | JAVASSIST</td><td style=text-align:left>JAVASSIST （MyBatis 3.3 以上）</td></tr><tr><td style=text-align:left>vfsImpl</td><td style=text-align:left>指定 VFS 的实现</td><td style=text-align:left>自定义 VFS 的实现的类全限定名，以逗号分隔。</td><td style=text-align:left>未设置</td></tr><tr><td style=text-align:left>useActualParamName</td><td style=text-align:left>允许使用方法签名中的名称作为语句参数名称。 为了使用该特性，你的项目必须采用 Java 8 编译，并且加上 <code>-parameters</code> 选项。（新增于 3.4.1）</td><td style=text-align:left>true | false</td><td style=text-align:left>true</td></tr><tr><td style=text-align:left>configurationFactory</td><td style=text-align:left>指定一个提供 <code>Configuration</code> 实例的类。 这个被返回的 Configuration 实例用来加载被反序列化对象的延迟加载属性值。 这个类必须包含一个签名为<code>static Configuration getConfiguration()</code> 的方法。（新增于 3.2.3）</td><td style=text-align:left>类型别名或者全类名.</td><td style=text-align:left>未设置</td></tr></tbody></table><p>比如我上面代码中用到的：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>  <span style=color:#204a87;font-weight:700>&lt;settings&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;setting</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;logImpl&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;LOG4J2&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;/settings&gt;</span>
</code></pre></div><p>设置日志的实现方式。</p><h4 id=typealiases处理>typeAliases处理</h4><p>类型别名是为 Java 类型设置一个短的名字。 它只和 XML 配置有关，存在的意义仅在于用来减少类完全限定名的冗余。例如：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;typeAliases&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;typeAlias</span> <span style=color:#c4a000>alias=</span><span style=color:#4e9a06>&#34;Author&#34;</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;domain.blog.Author&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;typeAlias</span> <span style=color:#c4a000>alias=</span><span style=color:#4e9a06>&#34;Blog&#34;</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;domain.blog.Blog&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;typeAlias</span> <span style=color:#c4a000>alias=</span><span style=color:#4e9a06>&#34;Comment&#34;</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;domain.blog.Comment&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;typeAlias</span> <span style=color:#c4a000>alias=</span><span style=color:#4e9a06>&#34;Post&#34;</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;domain.blog.Post&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;typeAlias</span> <span style=color:#c4a000>alias=</span><span style=color:#4e9a06>&#34;Section&#34;</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;domain.blog.Section&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;typeAlias</span> <span style=color:#c4a000>alias=</span><span style=color:#4e9a06>&#34;Tag&#34;</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;domain.blog.Tag&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/typeAliases&gt;</span>
</code></pre></div><p>看一源码的解析：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>typeAliasesElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>child</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildren</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;package&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>String</span> <span style=color:#000>typeAliasPackage</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTypeAliasRegistry</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>registerAliases</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeAliasPackage</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>String</span> <span style=color:#000>alias</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;alias&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>String</span> <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;type&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>clazz</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Resources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>classForName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>alias</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#000>typeAliasRegistry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerAlias</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#000>typeAliasRegistry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerAlias</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>alias</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassNotFoundException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error registering typeAlias for &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>alias</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;. Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过代码发现类型别称存入的是BaseBuilder.typeAliasRegistry变量中，这个变量主要是一个HashMap。这个里面同时存入了一些Java的基础类的名称和类的对应关系：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> 	<span style=color:#000>registerAlias</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;byte&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Byte</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>registerAlias</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;long&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>registerAlias</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;short&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Short</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>registerAlias</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;int&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>registerAlias</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;integer&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>registerAlias</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;double&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Double</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>registerAlias</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;float&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Float</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>registerAlias</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;boolean&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>通过源码可以看出来typeAliases节点下面可以用两种子节点，package 和 typeAlias两种。对于typeAlias如果没有属性alias值，就会获取对应类上面是否包含注解 <strong>@Alias</strong> 如果没有注解，那么别名就是类的名称不包含包名称。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerAlias</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>String</span> <span style=color:#000>alias</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSimpleName</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>Alias</span> <span style=color:#000>aliasAnnotation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAnnotation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Alias</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>aliasAnnotation</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>alias</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>aliasAnnotation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>registerAlias</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>alias</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>下面看一下别名和java类的对应关系，这是一些为常见的 Java 类型内建的相应的类型别名。它们都是不区分大小写的，注意对基本类型名称重复采取的特殊命名风格。</p><table><thead><tr><th style=text-align:left>别名</th><th style=text-align:left>映射的类型</th></tr></thead><tbody><tr><td style=text-align:left>_byte</td><td style=text-align:left>byte</td></tr><tr><td style=text-align:left>_long</td><td style=text-align:left>long</td></tr><tr><td style=text-align:left>_short</td><td style=text-align:left>short</td></tr><tr><td style=text-align:left>_int</td><td style=text-align:left>int</td></tr><tr><td style=text-align:left>_integer</td><td style=text-align:left>int</td></tr><tr><td style=text-align:left>_double</td><td style=text-align:left>double</td></tr><tr><td style=text-align:left>_float</td><td style=text-align:left>float</td></tr><tr><td style=text-align:left>_boolean</td><td style=text-align:left>boolean</td></tr><tr><td style=text-align:left>string</td><td style=text-align:left>String</td></tr><tr><td style=text-align:left>byte</td><td style=text-align:left>Byte</td></tr><tr><td style=text-align:left>long</td><td style=text-align:left>Long</td></tr><tr><td style=text-align:left>short</td><td style=text-align:left>Short</td></tr><tr><td style=text-align:left>int</td><td style=text-align:left>Integer</td></tr><tr><td style=text-align:left>integer</td><td style=text-align:left>Integer</td></tr><tr><td style=text-align:left>double</td><td style=text-align:left>Double</td></tr><tr><td style=text-align:left>float</td><td style=text-align:left>Float</td></tr><tr><td style=text-align:left>boolean</td><td style=text-align:left>Boolean</td></tr><tr><td style=text-align:left>date</td><td style=text-align:left>Date</td></tr><tr><td style=text-align:left>decimal</td><td style=text-align:left>BigDecimal</td></tr><tr><td style=text-align:left>bigdecimal</td><td style=text-align:left>BigDecimal</td></tr><tr><td style=text-align:left>object</td><td style=text-align:left>Object</td></tr><tr><td style=text-align:left>map</td><td style=text-align:left>Map</td></tr><tr><td style=text-align:left>hashmap</td><td style=text-align:left>HashMap</td></tr><tr><td style=text-align:left>list</td><td style=text-align:left>List</td></tr><tr><td style=text-align:left>arraylist</td><td style=text-align:left>ArrayList</td></tr><tr><td style=text-align:left>collection</td><td style=text-align:left>Collection</td></tr><tr><td style=text-align:left>iterator</td><td style=text-align:left>Iterator</td></tr></tbody></table><blockquote><p>下划线开头的表示的是java的基本类。</p></blockquote><h4 id=类型处理器typehandlers>类型处理器（typeHandlers）</h4><p>无论是 MyBatis 在预处理语句（PreparedStatement）中设置一个参数时，还是从结果集中取出一个值时， 都会用类型处理器将获取的值以合适的方式转换成 Java 类型。下表描述了一些默认的类型处理器。</p><p><strong>提示</strong> 从 3.4.5 开始，MyBatis 默认支持 JSR-310（日期和时间 API） 。</p><table><thead><tr><th style=text-align:left>类型处理器</th><th style=text-align:left>Java 类型</th><th style=text-align:left>JDBC 类型</th></tr></thead><tbody><tr><td style=text-align:left><code>BooleanTypeHandler</code></td><td style=text-align:left><code>java.lang.Boolean</code>, <code>boolean</code></td><td style=text-align:left>数据库兼容的 <code>BOOLEAN</code></td></tr><tr><td style=text-align:left><code>ByteTypeHandler</code></td><td style=text-align:left><code>java.lang.Byte</code>, <code>byte</code></td><td style=text-align:left>数据库兼容的 <code>NUMERIC</code> 或 <code>BYTE</code></td></tr><tr><td style=text-align:left><code>ShortTypeHandler</code></td><td style=text-align:left><code>java.lang.Short</code>, <code>short</code></td><td style=text-align:left>数据库兼容的 <code>NUMERIC</code> 或 <code>SMALLINT</code></td></tr><tr><td style=text-align:left><code>IntegerTypeHandler</code></td><td style=text-align:left><code>java.lang.Integer</code>, <code>int</code></td><td style=text-align:left>数据库兼容的 <code>NUMERIC</code> 或 <code>INTEGER</code></td></tr><tr><td style=text-align:left><code>LongTypeHandler</code></td><td style=text-align:left><code>java.lang.Long</code>, <code>long</code></td><td style=text-align:left>数据库兼容的 <code>NUMERIC</code> 或 <code>BIGINT</code></td></tr><tr><td style=text-align:left><code>FloatTypeHandler</code></td><td style=text-align:left><code>java.lang.Float</code>, <code>float</code></td><td style=text-align:left>数据库兼容的 <code>NUMERIC</code> 或 <code>FLOAT</code></td></tr><tr><td style=text-align:left><code>DoubleTypeHandler</code></td><td style=text-align:left><code>java.lang.Double</code>, <code>double</code></td><td style=text-align:left>数据库兼容的 <code>NUMERIC</code> 或 <code>DOUBLE</code></td></tr><tr><td style=text-align:left><code>BigDecimalTypeHandler</code></td><td style=text-align:left><code>java.math.BigDecimal</code></td><td style=text-align:left>数据库兼容的 <code>NUMERIC</code> 或 <code>DECIMAL</code></td></tr><tr><td style=text-align:left><code>StringTypeHandler</code></td><td style=text-align:left><code>java.lang.String</code></td><td style=text-align:left><code>CHAR</code>, <code>VARCHAR</code></td></tr><tr><td style=text-align:left><code>ClobReaderTypeHandler</code></td><td style=text-align:left><code>java.io.Reader</code></td><td style=text-align:left>-</td></tr><tr><td style=text-align:left><code>ClobTypeHandler</code></td><td style=text-align:left><code>java.lang.String</code></td><td style=text-align:left><code>CLOB</code>, <code>LONGVARCHAR</code></td></tr><tr><td style=text-align:left><code>NStringTypeHandler</code></td><td style=text-align:left><code>java.lang.String</code></td><td style=text-align:left><code>NVARCHAR</code>, <code>NCHAR</code></td></tr><tr><td style=text-align:left><code>NClobTypeHandler</code></td><td style=text-align:left><code>java.lang.String</code></td><td style=text-align:left><code>NCLOB</code></td></tr><tr><td style=text-align:left><code>BlobInputStreamTypeHandler</code></td><td style=text-align:left><code>java.io.InputStream</code></td><td style=text-align:left>-</td></tr><tr><td style=text-align:left><code>ByteArrayTypeHandler</code></td><td style=text-align:left><code>byte[]</code></td><td style=text-align:left>数据库兼容的字节流类型</td></tr><tr><td style=text-align:left><code>BlobTypeHandler</code></td><td style=text-align:left><code>byte[]</code></td><td style=text-align:left><code>BLOB</code>, <code>LONGVARBINARY</code></td></tr><tr><td style=text-align:left><code>DateTypeHandler</code></td><td style=text-align:left><code>java.util.Date</code></td><td style=text-align:left><code>TIMESTAMP</code></td></tr><tr><td style=text-align:left><code>DateOnlyTypeHandler</code></td><td style=text-align:left><code>java.util.Date</code></td><td style=text-align:left><code>DATE</code></td></tr><tr><td style=text-align:left><code>TimeOnlyTypeHandler</code></td><td style=text-align:left><code>java.util.Date</code></td><td style=text-align:left><code>TIME</code></td></tr><tr><td style=text-align:left><code>SqlTimestampTypeHandler</code></td><td style=text-align:left><code>java.sql.Timestamp</code></td><td style=text-align:left><code>TIMESTAMP</code></td></tr><tr><td style=text-align:left><code>SqlDateTypeHandler</code></td><td style=text-align:left><code>java.sql.Date</code></td><td style=text-align:left><code>DATE</code></td></tr><tr><td style=text-align:left><code>SqlTimeTypeHandler</code></td><td style=text-align:left><code>java.sql.Time</code></td><td style=text-align:left><code>TIME</code></td></tr><tr><td style=text-align:left><code>ObjectTypeHandler</code></td><td style=text-align:left>Any</td><td style=text-align:left><code>OTHER</code> 或未指定类型</td></tr><tr><td style=text-align:left><code>EnumTypeHandler</code></td><td style=text-align:left>Enumeration Type</td><td style=text-align:left>VARCHAR 或任何兼容的字符串类型，用以存储枚举的名称（而不是索引值）</td></tr><tr><td style=text-align:left><code>EnumOrdinalTypeHandler</code></td><td style=text-align:left>Enumeration Type</td><td style=text-align:left>任何兼容的 <code>NUMERIC</code> 或 <code>DOUBLE</code> 类型，存储枚举的序数值（而不是名称）。</td></tr><tr><td style=text-align:left><code>SqlxmlTypeHandler</code></td><td style=text-align:left><code>java.lang.String</code></td><td style=text-align:left><code>SQLXML</code></td></tr><tr><td style=text-align:left><code>InstantTypeHandler</code></td><td style=text-align:left><code>java.time.Instant</code></td><td style=text-align:left><code>TIMESTAMP</code></td></tr><tr><td style=text-align:left><code>LocalDateTimeTypeHandler</code></td><td style=text-align:left><code>java.time.LocalDateTime</code></td><td style=text-align:left><code>TIMESTAMP</code></td></tr><tr><td style=text-align:left><code>LocalDateTypeHandler</code></td><td style=text-align:left><code>java.time.LocalDate</code></td><td style=text-align:left><code>DATE</code></td></tr><tr><td style=text-align:left><code>LocalTimeTypeHandler</code></td><td style=text-align:left><code>java.time.LocalTime</code></td><td style=text-align:left><code>TIME</code></td></tr><tr><td style=text-align:left><code>OffsetDateTimeTypeHandler</code></td><td style=text-align:left><code>java.time.OffsetDateTime</code></td><td style=text-align:left><code>TIMESTAMP</code></td></tr><tr><td style=text-align:left><code>OffsetTimeTypeHandler</code></td><td style=text-align:left><code>java.time.OffsetTime</code></td><td style=text-align:left><code>TIME</code></td></tr><tr><td style=text-align:left><code>ZonedDateTimeTypeHandler</code></td><td style=text-align:left><code>java.time.ZonedDateTime</code></td><td style=text-align:left><code>TIMESTAMP</code></td></tr><tr><td style=text-align:left><code>YearTypeHandler</code></td><td style=text-align:left><code>java.time.Year</code></td><td style=text-align:left><code>INTEGER</code></td></tr><tr><td style=text-align:left><code>MonthTypeHandler</code></td><td style=text-align:left><code>java.time.Month</code></td><td style=text-align:left><code>INTEGER</code></td></tr><tr><td style=text-align:left><code>YearMonthTypeHandler</code></td><td style=text-align:left><code>java.time.YearMonth</code></td><td style=text-align:left><code>VARCHAR</code> 或 <code>LONGVARCHAR</code></td></tr><tr><td style=text-align:left><code>JapaneseDateTypeHandler</code></td><td style=text-align:left><code>java.time.chrono.JapaneseDate</code></td><td style=text-align:left><code>DATE</code></td></tr></tbody></table><p>你可以重写类型处理器或创建你自己的类型处理器来处理不支持的或非标准的类型。 具体做法为：实现 <code>org.apache.ibatis.type.TypeHandler</code> 接口， 或继承一个很便利的类 <code>org.apache.ibatis.type.BaseTypeHandler</code>， 然后可以选择性地将它映射到一个 JDBC 类型。比如：</p><pre><code>// ExampleTypeHandler.java
@MappedJdbcTypes(JdbcType.VARCHAR)
public class ExampleTypeHandler extends BaseTypeHandler&lt;String&gt; {

  @Override
  public void setNonNullParameter(PreparedStatement ps, int i, String parameter, JdbcType jdbcType) throws SQLException {
    ps.setString(i, parameter);
  }

  @Override
  public String getNullableResult(ResultSet rs, String columnName) throws SQLException {
    return rs.getString(columnName);
  }

  @Override
  public String getNullableResult(ResultSet rs, int columnIndex) throws SQLException {
    return rs.getString(columnIndex);
  }

  @Override
  public String getNullableResult(CallableStatement cs, int columnIndex) throws SQLException {
    return cs.getString(columnIndex);
  }
}
&lt;!-- mybatis-config.xml --&gt;
&lt;typeHandlers&gt;
  &lt;typeHandler handler=&quot;org.mybatis.example.ExampleTypeHandler&quot;/&gt;
&lt;/typeHandlers&gt;
</code></pre><p>使用上述的类型处理器将会覆盖已经存在的处理 Java 的 String 类型属性和 VARCHAR 参数及结果的类型处理器。 要注意 MyBatis 不会通过窥探数据库元信息来决定使用哪种类型，所以你必须在参数和结果映射中指明那是 VARCHAR 类型的字段， 以使其能够绑定到正确的类型处理器上。这是因为 MyBatis 直到语句被执行时才清楚数据类型。</p><p>通过类型处理器的泛型，MyBatis 可以得知该类型处理器处理的 Java 类型，不过这种行为可以通过两种方法改变：</p><ul><li>在类型处理器的配置元素（typeHandler 元素）上增加一个 <code>javaType</code> 属性（比如：<code>javaType="String"</code>）；</li><li>在类型处理器的类上（TypeHandler class）增加一个 <code>@MappedTypes</code> 注解来指定与其关联的 Java 类型列表。 如果在 <code>javaType</code> 属性中也同时指定，则注解方式将被忽略。</li></ul><p>可以通过两种方式来指定被关联的 JDBC 类型：</p><ul><li>在类型处理器的配置元素上增加一个 <code>jdbcType</code> 属性（比如：<code>jdbcType="VARCHAR"</code>）；</li><li>在类型处理器的类上增加一个 <code>@MappedJdbcTypes</code> 注解来指定与其关联的 JDBC 类型列表。 如果在 <code>jdbcType</code> 属性中也同时指定，则注解方式将被忽略。</li></ul><p>当在 <code>ResultMap</code> 中决定使用哪种类型处理器时，此时 Java 类型是已知的（从结果类型中获得），但是 JDBC 类型是未知的。 因此 Mybatis 使用 <code>javaType=[Java 类型], jdbcType=null</code> 的组合来选择一个类型处理器。 这意味着使用 <code>@MappedJdbcTypes</code> 注解可以<em>限制</em>类型处理器的范围，同时除非显式的设置，否则类型处理器在 <code>ResultMap</code> 中将是无效的。 如果希望在 <code>ResultMap</code> 中使用类型处理器，那么设置 <code>@MappedJdbcTypes</code> 注解的 <code>includeNullJdbcType=true</code> 即可。 然而从 Mybatis 3.4.0 开始，如果<strong>只有一个</strong>注册的类型处理器来处理 Java 类型，那么它将是 <code>ResultMap</code> 使用 Java 类型时的默认值（即使没有 <code>includeNullJdbcType=true</code>）。</p><p>最后，可以让 MyBatis 为你查找类型处理器：</p><pre><code>&lt;!-- mybatis-config.xml --&gt;
&lt;typeHandlers&gt;
  &lt;package name=&quot;org.mybatis.example&quot;/&gt;
&lt;/typeHandlers&gt;
</code></pre><p>注意在使用自动发现功能的时候，只能通过注解方式来指定 JDBC 的类型。</p><p>你可以创建一个能够处理多个类的泛型类型处理器。为了使用泛型类型处理器， 需要增加一个接受该类的 class 作为参数的构造器，这样在构造一个类型处理器的时候 MyBatis 就会传入一个具体的类。</p><pre><code>//GenericTypeHandler.java
public class GenericTypeHandler&lt;E extends MyObject&gt; extends BaseTypeHandler&lt;E&gt; {

  private Class&lt;E&gt; type;

  public GenericTypeHandler(Class&lt;E&gt; type) {
    if (type == null) throw new IllegalArgumentException(&quot;Type argument cannot be null&quot;);
    this.type = type;
  }
  ...
</code></pre><p><code>EnumTypeHandler</code> 和 <code>EnumOrdinalTypeHandler</code> 都是泛型类型处理器，我们将会在接下来的部分详细探讨。</p><h4 id=处理枚举类型>处理枚举类型</h4><p>若想映射枚举类型 <code>Enum</code>，则需要从 <code>EnumTypeHandler</code> 或者 <code>EnumOrdinalTypeHandler</code> 中选一个来使用。</p><p>比如说我们想存储取近似值时用到的舍入模式。默认情况下，MyBatis 会利用 <code>EnumTypeHandler</code> 来把 <code>Enum</code> 值转换成对应的名字。</p><p><strong>注意 <code>EnumTypeHandler</code> 在某种意义上来说是比较特别的，其他的处理器只针对某个特定的类，而它不同，它会处理任意继承了 <code>Enum</code> 的类。</strong></p><p>不过，我们可能不想存储名字，相反我们的 DBA 会坚持使用整形值代码。那也一样轻而易举： 在配置文件中把 <code>EnumOrdinalTypeHandler</code> 加到 <code>typeHandlers</code> 中即可， 这样每个 <code>RoundingMode</code> 将通过他们的序数值来映射成对应的整形数值。</p><pre><code>&lt;!-- mybatis-config.xml --&gt;
&lt;typeHandlers&gt;
  &lt;typeHandler handler=&quot;org.apache.ibatis.type.EnumOrdinalTypeHandler&quot; javaType=&quot;java.math.RoundingMode&quot;/&gt;
&lt;/typeHandlers&gt;
</code></pre><p>但是怎样能将同样的 <code>Enum</code> 既映射成字符串又映射成整形呢？</p><p>自动映射器（auto-mapper）会自动地选用 <code>EnumOrdinalTypeHandler</code> 来处理， 所以如果我们想用普通的 <code>EnumTypeHandler</code>，就必须要显式地为那些 SQL 语句设置要使用的类型处理器。</p><p>（下一节才开始介绍映射器文件，如果你是首次阅读该文档，你可能需要先跳过这里，过会再来看。）</p><pre><code>&lt;!DOCTYPE mapper
    PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;
    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;

&lt;mapper namespace=&quot;org.apache.ibatis.submitted.rounding.Mapper&quot;&gt;
	&lt;resultMap type=&quot;org.apache.ibatis.submitted.rounding.User&quot; id=&quot;usermap&quot;&gt;
		&lt;id column=&quot;id&quot; property=&quot;id&quot;/&gt;
		&lt;result column=&quot;name&quot; property=&quot;name&quot;/&gt;
		&lt;result column=&quot;funkyNumber&quot; property=&quot;funkyNumber&quot;/&gt;
		&lt;result column=&quot;roundingMode&quot; property=&quot;roundingMode&quot;/&gt;
	&lt;/resultMap&gt;

	&lt;select id=&quot;getUser&quot; resultMap=&quot;usermap&quot;&gt;
		select * from users
	&lt;/select&gt;
	&lt;insert id=&quot;insert&quot;&gt;
	    insert into users (id, name, funkyNumber, roundingMode) values (
	    	#{id}, #{name}, #{funkyNumber}, #{roundingMode}
	    )
	&lt;/insert&gt;

	&lt;resultMap type=&quot;org.apache.ibatis.submitted.rounding.User&quot; id=&quot;usermap2&quot;&gt;
		&lt;id column=&quot;id&quot; property=&quot;id&quot;/&gt;
		&lt;result column=&quot;name&quot; property=&quot;name&quot;/&gt;
		&lt;result column=&quot;funkyNumber&quot; property=&quot;funkyNumber&quot;/&gt;
		&lt;result column=&quot;roundingMode&quot; property=&quot;roundingMode&quot; typeHandler=&quot;org.apache.ibatis.type.EnumTypeHandler&quot;/&gt;
	&lt;/resultMap&gt;
	&lt;select id=&quot;getUser2&quot; resultMap=&quot;usermap2&quot;&gt;
		select * from users2
	&lt;/select&gt;
	&lt;insert id=&quot;insert2&quot;&gt;
	    insert into users2 (id, name, funkyNumber, roundingMode) values (
	    	#{id}, #{name}, #{funkyNumber}, #{roundingMode, typeHandler=org.apache.ibatis.type.EnumTypeHandler}
	    )
	&lt;/insert&gt;

&lt;/mapper&gt;
</code></pre><p>注意，这里的 select 语句强制使用 <code>resultMap</code> 来代替 <code>resultType</code>。</p><h4 id=对象工厂objectfactory>对象工厂（objectFactory）</h4><p>MyBatis 每次创建结果对象的新实例时，它都会使用一个对象工厂（ObjectFactory）实例来完成。 默认的对象工厂需要做的仅仅是实例化目标类，要么通过默认构造方法，要么在参数映射存在的时候通过参数构造方法来实例化。 如果想覆盖对象工厂的默认行为，则可以通过创建自己的对象工厂来实现。比如：</p><pre><code>// ExampleObjectFactory.java
public class ExampleObjectFactory extends DefaultObjectFactory {
  public Object create(Class type) {
    return super.create(type);
  }
  public Object create(Class type, List&lt;Class&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs) {
    return super.create(type, constructorArgTypes, constructorArgs);
  }
  public void setProperties(Properties properties) {
    super.setProperties(properties);
  }
  public &lt;T&gt; boolean isCollection(Class&lt;T&gt; type) {
    return Collection.class.isAssignableFrom(type);
  }}
&lt;!-- mybatis-config.xml --&gt;
&lt;objectFactory type=&quot;org.mybatis.example.ExampleObjectFactory&quot;&gt;
  &lt;property name=&quot;someProperty&quot; value=&quot;100&quot;/&gt;
&lt;/objectFactory&gt;
</code></pre><p>ObjectFactory 接口很简单，它包含两个创建用的方法，一个是处理默认构造方法的，另外一个是处理带参数的构造方法的。 最后，setProperties 方法可以被用来配置 ObjectFactory，在初始化你的 ObjectFactory 实例后， objectFactory 元素体中定义的属性会被传递给 setProperties 方法。</p><h4 id=插件plugins>插件（plugins）</h4><p>MyBatis 允许你在已映射语句执行过程中的某一点进行拦截调用。默认情况下，MyBatis 允许使用插件来拦截的方法调用包括：</p><ul><li>Executor (update, query, flushStatements, commit, rollback, getTransaction, close, isClosed)</li><li>ParameterHandler (getParameterObject, setParameters)</li><li>ResultSetHandler (handleResultSets, handleOutputParameters)</li><li>StatementHandler (prepare, parameterize, batch, update, query)</li></ul><p>这些类中方法的细节可以通过查看每个方法的签名来发现，或者直接查看 MyBatis 发行包中的源代码。 如果你想做的不仅仅是监控方法的调用，那么你最好相当了解要重写的方法的行为。 因为如果在试图修改或重写已有方法的行为的时候，你很可能在破坏 MyBatis 的核心模块。 这些都是更低层的类和方法，所以使用插件的时候要特别当心。</p><p>通过 MyBatis 提供的强大机制，使用插件是非常简单的，只需实现 Interceptor 接口，并指定想要拦截的方法签名即可。</p><pre><code>// ExamplePlugin.java
@Intercepts({@Signature(
  type= Executor.class,
  method = &quot;update&quot;,
  args = {MappedStatement.class,Object.class})})
public class ExamplePlugin implements Interceptor {
  private Properties properties = new Properties();
  public Object intercept(Invocation invocation) throws Throwable {
    // implement pre processing if need
    Object returnObject = invocation.proceed();
    // implement post processing if need
    return returnObject;
  }
  public void setProperties(Properties properties) {
    this.properties = properties;
  }
}
&lt;!-- mybatis-config.xml --&gt;
&lt;plugins&gt;
  &lt;plugin interceptor=&quot;org.mybatis.example.ExamplePlugin&quot;&gt;
    &lt;property name=&quot;someProperty&quot; value=&quot;100&quot;/&gt;
  &lt;/plugin&gt;
&lt;/plugins&gt;
</code></pre><p>上面的插件将会拦截在 Executor 实例中所有的 “update” 方法调用， 这里的 Executor 是负责执行低层映射语句的内部对象。</p><p><strong>提示</strong> <strong>覆盖配置类</strong></p><p>除了用插件来修改 MyBatis 核心行为之外，还可以通过完全覆盖配置类来达到目的。只需继承后覆盖其中的每个方法，再把它传递到 SqlSessionFactoryBuilder.build(myConfig) 方法即可。再次重申，这可能会严重影响 MyBatis 的行为，务请慎之又慎。</p><h4 id=环境配置environments>环境配置（environments）</h4><p>MyBatis 可以配置成适应多种环境，这种机制有助于将 SQL 映射应用于多种数据库之中， 现实情况下有多种理由需要这么做。例如，开发、测试和生产环境需要有不同的配置；或者想在具有相同 Schema 的多个生产数据库中 使用相同的 SQL 映射。有许多类似的使用场景。</p><p><strong>不过要记住：尽管可以配置多个环境，但每个 SqlSessionFactory 实例只能选择一种环境。</strong></p><p>所以，如果你想连接两个数据库，就需要创建两个 SqlSessionFactory 实例，每个数据库对应一个。而如果是三个数据库，就需要三个实例，依此类推，记起来很简单：</p><ul><li><strong>每个数据库对应一个 SqlSessionFactory 实例</strong></li></ul><p>为了指定创建哪种环境，只要将它作为可选的参数传递给 SqlSessionFactoryBuilder 即可。可以接受环境配置的两个方法签名是：</p><pre><code>SqlSessionFactory factory = new SqlSessionFactoryBuilder().build(reader, environment);
SqlSessionFactory factory = new SqlSessionFactoryBuilder().build(reader, environment, properties);
</code></pre><p>如果忽略了环境参数，那么默认环境将会被加载，如下所示：</p><pre><code>SqlSessionFactory factory = new SqlSessionFactoryBuilder().build(reader);
SqlSessionFactory factory = new SqlSessionFactoryBuilder().build(reader, properties);
</code></pre><p>环境元素定义了如何配置环境。</p><pre><code>&lt;environments default=&quot;development&quot;&gt;
  &lt;environment id=&quot;development&quot;&gt;
    &lt;transactionManager type=&quot;JDBC&quot;&gt;
      &lt;property name=&quot;...&quot; value=&quot;...&quot;/&gt;
    &lt;/transactionManager&gt;
    &lt;dataSource type=&quot;POOLED&quot;&gt;
      &lt;property name=&quot;driver&quot; value=&quot;${driver}&quot;/&gt;
      &lt;property name=&quot;url&quot; value=&quot;${url}&quot;/&gt;
      &lt;property name=&quot;username&quot; value=&quot;${username}&quot;/&gt;
      &lt;property name=&quot;password&quot; value=&quot;${password}&quot;/&gt;
    &lt;/dataSource&gt;
  &lt;/environment&gt;
&lt;/environments&gt;
</code></pre><p>注意这里的关键点:</p><ul><li>默认使用的环境 ID（比如：default=&ldquo;development&rdquo;）。</li><li>每个 environment 元素定义的环境 ID（比如：id=&ldquo;development&rdquo;）。</li><li>事务管理器的配置（比如：type=&ldquo;JDBC&rdquo;）。</li><li>数据源的配置（比如：type=&ldquo;POOLED&rdquo;）。</li></ul><p>默认的环境和环境 ID 是自解释的，因此一目了然。 你可以对环境随意命名，但一定要保证默认的环境 ID 要匹配其中一个环境 ID。</p><p><strong>事务管理器（transactionManager）</strong></p><p>在 MyBatis 中有两种类型的事务管理器（也就是 type=”[JDBC|MANAGED]”）：</p><ul><li><p>JDBC – 这个配置就是直接使用了 JDBC 的提交和回滚设置，它依赖于从数据源得到的连接来管理事务作用域。</p></li><li><p>MANAGED – 这个配置几乎没做什么。它从来不提交或回滚一个连接，而是让容器来管理事务的整个生命周期（比如 JEE 应用服务器的上下文）。 默认情况下它会关闭连接，然而一些容器并不希望这样，因此需要将 closeConnection 属性设置为 false 来阻止它默认的关闭行为。例如:</p><pre><code>&lt;transactionManager type=&quot;MANAGED&quot;&gt;
  &lt;property name=&quot;closeConnection&quot; value=&quot;false&quot;/&gt;
&lt;/transactionManager&gt;
</code></pre></li></ul><p><strong>提示</strong>如果你正在使用 Spring + MyBatis，则没有必要配置事务管理器， 因为 Spring 模块会使用自带的管理器来覆盖前面的配置。</p><p>这两种事务管理器类型都不需要设置任何属性。它们其实是类型别名，换句话说，你可以使用 TransactionFactory 接口的实现类的完全限定名或类型别名代替它们。</p><pre><code>public interface TransactionFactory {
  default void setProperties(Properties props) { // Since 3.5.2, change to default method
    // NOP
  }
  Transaction newTransaction(Connection conn);
  Transaction newTransaction(DataSource dataSource, TransactionIsolationLevel level, boolean autoCommit);
}
</code></pre><p>任何在 XML 中配置的属性在实例化之后将会被传递给 setProperties() 方法。你也需要创建一个 Transaction 接口的实现类，这个接口也很简单：</p><pre><code>public interface Transaction {
  Connection getConnection() throws SQLException;
  void commit() throws SQLException;
  void rollback() throws SQLException;
  void close() throws SQLException;
  Integer getTimeout() throws SQLException;
}
</code></pre><p>使用这两个接口，你可以完全自定义 MyBatis 对事务的处理。</p><p><strong>数据源（dataSource）</strong></p><p>dataSource 元素使用标准的 JDBC 数据源接口来配置 JDBC 连接对象的资源。</p><ul><li>许多 MyBatis 的应用程序会按示例中的例子来配置数据源。虽然这是可选的，但为了使用延迟加载，数据源是必须配置的。</li></ul><p>有三种内建的数据源类型（也就是 type=”[UNPOOLED|POOLED|JNDI]”）：</p><p><strong>UNPOOLED</strong>– 这个数据源的实现只是每次被请求时打开和关闭连接。虽然有点慢，但对于在数据库连接可用性方面没有太高要求的简单应用程序来说，是一个很好的选择。 不同的数据库在性能方面的表现也是不一样的，对于某些数据库来说，使用连接池并不重要，这个配置就很适合这种情形。UNPOOLED 类型的数据源具有以下属性。：</p><ul><li><code>driver</code> – 这是 JDBC 驱动的 Java 类的完全限定名（并不是 JDBC 驱动中可能包含的数据源类）。</li><li><code>url</code> – 这是数据库的 JDBC URL 地址。</li><li><code>username</code> – 登录数据库的用户名。</li><li><code>password</code> – 登录数据库的密码。</li><li><code>defaultTransactionIsolationLevel</code> – 默认的连接事务隔离级别。</li><li><code>defaultNetworkTimeout</code> – The default network timeout value in milliseconds to wait for the database operation to complete. See the API documentation of <code>java.sql.Connection#setNetworkTimeout()</code> for details.</li></ul><p>作为可选项，你也可以传递属性给数据库驱动。只需在属性名加上“driver.”前缀即可，例如：</p><ul><li><code>driver.encoding=UTF8</code></li></ul><p>这将通过 DriverManager.getConnection(url,driverProperties) 方法传递值为 <code>UTF8</code> 的 <code>encoding</code> 属性给数据库驱动。</p><p><strong>POOLED</strong>– 这种数据源的实现利用“池”的概念将 JDBC 连接对象组织起来，避免了创建新的连接实例时所必需的初始化和认证时间。 这是一种使得并发 Web 应用快速响应请求的流行处理方式。</p><p>除了上述提到 UNPOOLED 下的属性外，还有更多属性用来配置 POOLED 的数据源：</p><ul><li><code>poolMaximumActiveConnections</code> – 在任意时间可以存在的活动（也就是正在使用）连接数量，默认值：10</li><li><code>poolMaximumIdleConnections</code> – 任意时间可能存在的空闲连接数。</li><li><code>poolMaximumCheckoutTime</code> – 在被强制返回之前，池中连接被检出（checked out）时间，默认值：20000 毫秒（即 20 秒）</li><li><code>poolTimeToWait</code> – 这是一个底层设置，如果获取连接花费了相当长的时间，连接池会打印状态日志并重新尝试获取一个连接（避免在误配置的情况下一直安静的失败），默认值：20000 毫秒（即 20 秒）。</li><li><code>poolMaximumLocalBadConnectionTolerance</code> – 这是一个关于坏连接容忍度的底层设置， 作用于每一个尝试从缓存池获取连接的线程。 如果这个线程获取到的是一个坏的连接，那么这个数据源允许这个线程尝试重新获取一个新的连接，但是这个重新尝试的次数不应该超过 <code>poolMaximumIdleConnections</code> 与 <code>poolMaximumLocalBadConnectionTolerance</code> 之和。 默认值：3 （新增于 3.4.5）</li><li><code>poolPingQuery</code> – 发送到数据库的侦测查询，用来检验连接是否正常工作并准备接受请求。默认是“NO PING QUERY SET”，这会导致多数数据库驱动失败时带有一个恰当的错误消息。</li><li><code>poolPingEnabled</code> – 是否启用侦测查询。若开启，需要设置 <code>poolPingQuery</code> 属性为一个可执行的 SQL 语句（最好是一个速度非常快的 SQL 语句），默认值：false。</li><li><code>poolPingConnectionsNotUsedFor</code> – 配置 poolPingQuery 的频率。可以被设置为和数据库连接超时时间一样，来避免不必要的侦测，默认值：0（即所有连接每一时刻都被侦测 — 当然仅当 poolPingEnabled 为 true 时适用）。</li></ul><p><strong>JNDI</strong> – 这个数据源的实现是为了能在如 EJB 或应用服务器这类容器中使用，容器可以集中或在外部配置数据源，然后放置一个 JNDI 上下文的引用。这种数据源配置只需要两个属性：</p><ul><li><code>initial_context</code> – 这个属性用来在 InitialContext 中寻找上下文（即，initialContext.lookup(initial_context)）。这是个可选属性，如果忽略，那么将会直接从 InitialContext 中寻找 data_source 属性。</li><li><code>data_source</code> – 这是引用数据源实例位置的上下文的路径。提供了 initial_context 配置时会在其返回的上下文中进行查找，没有提供时则直接在 InitialContext 中查找。</li></ul><p>和其他数据源配置类似，可以通过添加前缀“env.”直接把属性传递给初始上下文。比如：</p><ul><li><code>env.encoding=UTF8</code></li></ul><p>这就会在初始上下文（InitialContext）实例化时往它的构造方法传递值为 <code>UTF8</code> 的 <code>encoding</code> 属性。</p><p>你可以通过实现接口 <code>org.apache.ibatis.datasource.DataSourceFactory</code> 来使用第三方数据源：</p><pre><code>public interface DataSourceFactory {
  void setProperties(Properties props);
  DataSource getDataSource();
}
</code></pre><p><code>org.apache.ibatis.datasource.unpooled.UnpooledDataSourceFactory</code> 可被用作父类来构建新的数据源适配器，比如下面这段插入 C3P0 数据源所必需的代码：</p><pre><code>import org.apache.ibatis.datasource.unpooled.UnpooledDataSourceFactory;
import com.mchange.v2.c3p0.ComboPooledDataSource;

public class C3P0DataSourceFactory extends UnpooledDataSourceFactory {

  public C3P0DataSourceFactory() {
    this.dataSource = new ComboPooledDataSource();
  }
}
</code></pre><p>为了令其工作，记得为每个希望 MyBatis 调用的 setter 方法在配置文件中增加对应的属性。 下面是一个可以连接至 PostgreSQL 数据库的例子：</p><pre><code>&lt;dataSource type=&quot;org.myproject.C3P0DataSourceFactory&quot;&gt;
  &lt;property name=&quot;driver&quot; value=&quot;org.postgresql.Driver&quot;/&gt;
  &lt;property name=&quot;url&quot; value=&quot;jdbc:postgresql:mydb&quot;/&gt;
  &lt;property name=&quot;username&quot; value=&quot;postgres&quot;/&gt;
  &lt;property name=&quot;password&quot; value=&quot;root&quot;/&gt;
&lt;/dataSource&gt;
</code></pre><h4 id=数据库厂商标识databaseidprovider>数据库厂商标识（databaseIdProvider）</h4><p>MyBatis 可以根据不同的数据库厂商执行不同的语句，这种多厂商的支持是基于映射语句中的 <code>databaseId</code> 属性。 MyBatis 会加载不带 <code>databaseId</code> 属性和带有匹配当前数据库 <code>databaseId</code> 属性的所有语句。 如果同时找到带有 <code>databaseId</code> 和不带 <code>databaseId</code> 的相同语句，则后者会被舍弃。 为支持多厂商特性只要像下面这样在 mybatis-config.xml 文件中加入 <code>databaseIdProvider</code> 即可：</p><pre><code>&lt;databaseIdProvider type=&quot;DB_VENDOR&quot; /&gt;
</code></pre><p>DB_VENDOR 对应的 databaseIdProvider 实现会将 databaseId 设置为 <code>DatabaseMetaData#getDatabaseProductName()</code> 返回的字符串。 由于通常情况下这些字符串都非常长而且相同产品的不同版本会返回不同的值，所以你可能想通过设置属性别名来使其变短，如下：</p><pre><code>&lt;databaseIdProvider type=&quot;DB_VENDOR&quot;&gt;
  &lt;property name=&quot;SQL Server&quot; value=&quot;sqlserver&quot;/&gt;
  &lt;property name=&quot;DB2&quot; value=&quot;db2&quot;/&gt;
  &lt;property name=&quot;Oracle&quot; value=&quot;oracle&quot; /&gt;
&lt;/databaseIdProvider&gt;
</code></pre><p>在提供了属性别名时，DB_VENDOR 的 databaseIdProvider 实现会将 databaseId 设置为第一个数据库产品名与属性中的名称相匹配的值，如果没有匹配的属性将会设置为 “null”。 在这个例子中，如果 <code>getDatabaseProductName()</code> 返回“Oracle (DataDirect)”，databaseId 将被设置为“oracle”。</p><p>你可以通过实现接口 <code>org.apache.ibatis.mapping.DatabaseIdProvider</code> 并在 mybatis-config.xml 中注册来构建自己的 DatabaseIdProvider：</p><pre><code>public interface DatabaseIdProvider {
  default void setProperties(Properties p) { // Since 3.5.2, change to default method
    // NOP
  }
  String getDatabaseId(DataSource dataSource) throws SQLException;
}
</code></pre><h4 id=映射器mappers>映射器（mappers）</h4><p>既然 MyBatis 的行为已经由上述元素配置完了，我们现在就要定义 SQL 映射语句了。 但是首先我们需要告诉 MyBatis 到哪里去找到这些语句。 Java 在自动查找这方面没有提供一个很好的方法，所以最佳的方式是告诉 MyBatis 到哪里去找映射文件。 你可以使用相对于类路径的资源引用， 或完全限定资源定位符（包括 <code>file:///</code> 的 URL），或类名和包名等。例如：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;!-- 使用相对于类路径的资源引用 --&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;mappers&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;mapper</span> <span style=color:#c4a000>resource=</span><span style=color:#4e9a06>&#34;org/mybatis/builder/AuthorMapper.xml&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;mapper</span> <span style=color:#c4a000>resource=</span><span style=color:#4e9a06>&#34;org/mybatis/builder/BlogMapper.xml&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;mapper</span> <span style=color:#c4a000>resource=</span><span style=color:#4e9a06>&#34;org/mybatis/builder/PostMapper.xml&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/mappers&gt;</span>
<span style=color:#8f5902;font-style:italic>&lt;!-- 使用完全限定资源定位符（URL） --&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;mappers&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;mapper</span> <span style=color:#c4a000>url=</span><span style=color:#4e9a06>&#34;file:///var/mappers/AuthorMapper.xml&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;mapper</span> <span style=color:#c4a000>url=</span><span style=color:#4e9a06>&#34;file:///var/mappers/BlogMapper.xml&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;mapper</span> <span style=color:#c4a000>url=</span><span style=color:#4e9a06>&#34;file:///var/mappers/PostMapper.xml&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/mappers&gt;</span>
<span style=color:#8f5902;font-style:italic>&lt;!-- 使用映射器接口实现类的完全限定类名 --&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;mappers&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;mapper</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.mybatis.builder.AuthorMapper&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;mapper</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.mybatis.builder.BlogMapper&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;mapper</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.mybatis.builder.PostMapper&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/mappers&gt;</span>
<span style=color:#8f5902;font-style:italic>&lt;!-- 将包内的映射器接口实现全部注册为映射器 --&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;mappers&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;package</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;org.mybatis.builder&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/mappers&gt;</span>
</code></pre></div><p>这些配置会告诉了 MyBatis 去哪里找映射文件，剩下的细节就应该是每个 SQL 映射文件了，也就是接下来我们要讨论的。</p><p>参考：https://mybatis.org/mybatis-3/zh/configuration.html#</p></div><div class=td-content style=page-break-before:always><h1 id=pg-89569d3a1dba3d724fe53ef3c9eba809>6 - 数据库</h1></div><div class=td-content><h1 id=pg-6f62ad977a4908f1d7eaefc2a3050a87>6.1 - Elasticsearch</h1></div><div class=td-content><h1 id=pg-3ba9b40140caede44a523a63c07edd2a>6.1.1 - Elasticsearch Mapping</h1></div><div class=td-content><h1 id=pg-9c8e7b95edb840f027d21d643e447743>6.1.1.1 - Elasticsearch-元数据</h1><blockquote><p>注意：以下语法都是基于Elasticsearch的7.6版本</p></blockquote><h3 id=元数据字段>元数据字段</h3><p>每个文档都有与之相关联的元数据，比如 _index、mapping _type和 _id元字段。在创建映射类型时，可以定制其中一些元字段的行为。</p><h4 id=身份元数据>身份元数据</h4><table><thead><tr><th>元数据</th><th>说明</th></tr></thead><tbody><tr><td><strong>_index</strong></td><td>文档属于那个索引</td></tr><tr><td><strong>_type</strong></td><td>文档所属类型</td></tr><tr><td><strong>_id</strong></td><td>文档的唯一标识</td></tr></tbody></table><h4 id=文档元数据>文档元数据</h4><table><thead><tr><th>元数据</th><th>说明</th></tr></thead><tbody><tr><td><strong>_source</strong></td><td>表示文档主体的原始JSON</td></tr><tr><td><strong>_size</strong></td><td>_source字段的大小</td></tr></tbody></table><h4 id=索引的元数据>索引的元数据</h4><table><thead><tr><th>元数据</th><th>说明</th></tr></thead><tbody><tr><td><strong>_field_names</strong></td><td>文档中包含非空值的所有字段</td></tr><tr><td><strong>_ignored</strong></td><td>在索引时被忽略的文档中的所有字段</td></tr></tbody></table><h4 id=路由元数据>路由元数据</h4><table><thead><tr><th>元数据</th><th>说明</th></tr></thead><tbody><tr><td><strong>_routing</strong></td><td>自定义路由值将文档路由到特定的分片</td></tr></tbody></table><h4 id=其他元数据>其他元数据</h4><table><thead><tr><th>元数据</th><th>说明</th></tr></thead><tbody><tr><td><strong>_meta</strong></td><td>应用程序的特定元数据。</td></tr></tbody></table><h3 id=元数据详解>元数据详解</h3><p>下面来一一说明这些元数据。</p><h4 id=_index元数据>_index元数据</h4><p>在跨多个索引执行查询时，有时需要添加仅与特定索引的文档相关联的查询子句。_index字段允许对索引到的文档的索引进行匹配。它的值可以在某些查询和聚合中访问，也可以在排序或编写脚本时访问：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#a40000>PUT</span> <span style=color:#a40000>index_</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#a40000>/_doc/</span><span style=color:#0000cf;font-weight:700>1</span>
<span style=color:#000;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>&#34;text&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Document in index 1&#34;</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#a40000>PUT</span> <span style=color:#a40000>index_</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#a40000>/_doc/</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#a40000>?refresh=</span><span style=color:#204a87;font-weight:700>true</span>
<span style=color:#000;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>&#34;text&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Document in index 2&#34;</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#a40000>GET</span> <span style=color:#a40000>index_</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#a40000>,index_</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#a40000>/_search</span>
<span style=color:#000;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>&#34;query&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;terms&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;_index&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;index_1&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;index_2&#34;</span><span style=color:#000;font-weight:700>]</span> 
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>},</span>
  <span style=color:#204a87;font-weight:700>&#34;aggs&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;indices&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;terms&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>&#34;field&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;_index&#34;</span><span style=color:#000;font-weight:700>,</span> 
        <span style=color:#204a87;font-weight:700>&#34;size&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>10</span>
      <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>},</span>
  <span style=color:#204a87;font-weight:700>&#34;sort&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
    <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;_index&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span> 
        <span style=color:#204a87;font-weight:700>&#34;order&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;asc&#34;</span>
      <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>],</span>
  <span style=color:#204a87;font-weight:700>&#34;script_fields&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;index_name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;script&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>&#34;lang&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;painless&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>&#34;source&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;doc[&#39;_index&#39;]&#34;</span> 
      <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>

</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-c41f9e3d45e990c68edbb3c5f7588ccf>6.1.2 - Elasticsearch 查询DSL</h1></div><div class=td-content><h1 id=pg-1bec54c06fd5bfa70738192554abd0f6>6.1.2.1 - 复合查询</h1></div><div class=td-content><h1 id=pg-5842184e8950bd6979597144c6d13ac8>6.1.2.1.1 - Elasticsearch复合查询-boosting query查询</h1><blockquote><p>注意：以下语法都是基于Elasticsearch的7.6版本</p></blockquote><h3 id=boosting-query>boosting query</h3><p>在前面的boolean的复合查询我们可以通过<code>must_not+must</code> 先剔除不想匹配的文档，再获取匹配的文档，但是有一种场景就是我并不需要完全剔除，而是把需要剔除的那部分文档的分数降低。这个时候就可以使用boosting query。下面会举例说明（官方例子）：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#a40000>GET</span> <span style=color:#a40000>/_search</span>
<span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;query&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>&#34;boosting&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>&#34;positive&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>&#34;term&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>&#34;text&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;apple&#34;</span>
                <span style=color:#000;font-weight:700>}</span>
            <span style=color:#000;font-weight:700>},</span>
            <span style=color:#204a87;font-weight:700>&#34;negative&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
                 <span style=color:#204a87;font-weight:700>&#34;term&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
                     <span style=color:#204a87;font-weight:700>&#34;text&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;pie tart fruit crumble tree&#34;</span>
                <span style=color:#000;font-weight:700>}</span>
            <span style=color:#000;font-weight:700>},</span>
            <span style=color:#204a87;font-weight:700>&#34;negative_boost&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>0.5</span>
        <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><pre><code>说明`boosting需要搭配三个关键字 `positive` , `negative` , `negative_boost
</code></pre><p>只有匹配了 <strong>positive查询</strong> 的文档才会被包含到结果集中，但是同时匹配了<strong>negative查询</strong> 的文档会被降低其相关度，通过将文档原本的<code>_score和negative_boost</code>参数进行</p><p>相乘来得到新的_score。因此，<code>negative_boost参数一般小于1.0</code>。在上面的例子中，任何包含了指定负面词条的文档的<code>_score</code>都会是其原本_score的一半。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-1f3ccaf409495f5a278314a1a9ecc794>6.1.2.1.2 - Elasticsearch复合查询-Constant score query查询</h1><blockquote><p>注意：以下语法都是基于Elasticsearch的7.6版本</p></blockquote><h3 id=constant-score-query>Constant score query</h3><p>包装筛选器查询，并返回每个匹配的文档，其相关性得分等于boost参数值。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#a40000>POST</span> <span style=color:#a40000>twitter/_search</span>
<span style=color:#000;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>&#34;query&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;constant_score&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;filter&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>&#34;match&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>&#34;content&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;apple&#34;</span>
        <span style=color:#000;font-weight:700>}</span>
      <span style=color:#000;font-weight:700>},</span>
      <span style=color:#204a87;font-weight:700>&#34;boost&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>100</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><ul><li><p><strong>filter</strong></p><p>(必选，查询对象)筛选您希望运行的查询。任何返回的文档都必须匹配此查询。过滤查询不计算相关分数。为了提高性能，Elasticsearch自动缓存常用的过滤查询。</p></li><li><p><strong>boost</strong></p><p>(可选，浮点数)浮点数用作与筛选器查询匹配的每个文档的常数相关分数。默认为1.0。</p></li></ul><p>结果：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>&#34;took&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>&#34;timed_out&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>&#34;_shards&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;total&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#204a87;font-weight:700>&#34;successful&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#204a87;font-weight:700>&#34;skipped&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#204a87;font-weight:700>&#34;failed&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>0</span>
  <span style=color:#000;font-weight:700>},</span>
  <span style=color:#204a87;font-weight:700>&#34;hits&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;total&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;value&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;relation&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;eq&#34;</span>
    <span style=color:#000;font-weight:700>},</span>
    <span style=color:#204a87;font-weight:700>&#34;max_score&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>100.0</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#204a87;font-weight:700>&#34;hits&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
      <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>&#34;_index&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;twitter&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>&#34;_type&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;_doc&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>&#34;_id&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;2&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>&#34;_score&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>100.0</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>&#34;_source&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>&#34;content&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Apple iPad&#34;</span>
        <span style=color:#000;font-weight:700>}</span>
      <span style=color:#000;font-weight:700>},</span>
      <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>&#34;_index&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;twitter&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>&#34;_type&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;_doc&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>&#34;_id&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;3&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>&#34;_score&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>100.0</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>&#34;_source&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>&#34;content&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Apple employee like Apple Pie and Apple Juice&#34;</span>
        <span style=color:#000;font-weight:700>}</span>
      <span style=color:#000;font-weight:700>},</span>
      <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>&#34;_index&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;twitter&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>&#34;_type&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;_doc&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>&#34;_id&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>&#34;_score&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>100.0</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>&#34;_source&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>&#34;content&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Apple Mac&#34;</span>
        <span style=color:#000;font-weight:700>}</span>
      <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>]</span>
  <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>

</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-abbbba3364147f531a55fc26401e66f1>6.1.2.1.3 - Elasticsearch复合查询-Boolean查询</h1><blockquote><p>注意：以下语法都是基于Elasticsearch的7.6版本</p></blockquote><h3 id=布尔查询>布尔查询</h3><p>Bool查询语法有以下特点</p><ol><li>子查询可以任意顺序出现</li><li>可以嵌套多个查询，包括bool查询</li><li>如果bool查询中没有must条件，should中必须至少满足一条才会返回结果。</li></ol><p>匹配文档与其他查询的布尔组合的查询。bool查询映射到Lucene BooleanQuery。它是使用一个或多个布尔子句构建的，每个子句都有一个类型化的出现，发生类型</p><table><thead><tr><th>发生类型</th><th>描述</th></tr></thead><tbody><tr><td><code>must</code></td><td>子句(查询)必须出现在匹配的文档中，并对分数有贡献(<strong>必须匹配。贡献算分</strong>)</td></tr><tr><td><code>filter</code></td><td>子句(查询)必须出现在匹配的文档中。但是与“必须”不同的是，查询的分数将被忽略。筛选器子句在筛选器上下文中执行，这意味着忽略评分，并考虑子句用于缓存。(<strong>过滤子句，必须匹配，但不贡献算分</strong>)</td></tr><tr><td><code>should</code></td><td>子句(查询)应该出现在匹配的文档中（<strong>选择性匹配，至少满足一条。贡献算分</strong>）</td></tr><tr><td><code>must_not</code></td><td>子句(查询)不能出现在匹配的文档中。子句在筛选器上下文中执行，这意味着忽略评分，而子句用于缓存。因为忽略了评分，所以返回所有文档的“0”评分。(<strong>过滤子句，必须不能匹配，但不贡献算分</strong>)</td></tr></tbody></table><p>bool查询采用的是“匹配越多越好”的方法，因此来自每个匹配的must或should子句的分数将被添加到一起，以提供每个文档的最终_score。例子：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#a40000>POST</span> <span style=color:#a40000>_search</span>
<span style=color:#000;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>&#34;query&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;bool&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;must&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>&#34;term&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>&#34;user&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;kimchy&#34;</span> <span style=color:#000;font-weight:700>}</span>
      <span style=color:#000;font-weight:700>},</span>
      <span style=color:#204a87;font-weight:700>&#34;filter&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>&#34;term&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>&#34;tag&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;tech&#34;</span> <span style=color:#000;font-weight:700>}</span>
      <span style=color:#000;font-weight:700>},</span>
      <span style=color:#204a87;font-weight:700>&#34;must_not&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>&#34;range&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>&#34;age&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>&#34;gte&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>&#34;lte&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>20</span> <span style=color:#000;font-weight:700>}</span>
        <span style=color:#000;font-weight:700>}</span>
      <span style=color:#000;font-weight:700>},</span>
      <span style=color:#204a87;font-weight:700>&#34;should&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
        <span style=color:#000;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>&#34;term&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>&#34;tag&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;wow&#34;</span> <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>},</span>
        <span style=color:#000;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>&#34;term&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>&#34;tag&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;elasticsearch&#34;</span> <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>}</span>
      <span style=color:#000;font-weight:700>],</span>
      <span style=color:#204a87;font-weight:700>&#34;minimum_should_match&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;boost&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>1.0</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><h4 id=使用minimum_should_match>使用minimum_should_match</h4><p>可以使用minimum_should_match参数指定返回的文档必须匹配的should子句的数量或百分比。如果bool查询包含至少一个should子句和没有 must或filter子句，则默认值为1。否则，默认值为0。其他的值<a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-minimum-should-match.html>minimum_should_match</a>。</p><h4 id=用boolfilter评分>用bool.filter评分</h4><p>在筛选器元素下指定的查询对评分没有影响—返回的分数为0。分数只受指定查询的影响。例如，以下三个查询都返回status字段中包含术语active的所有文档。第一个查询为所有文档赋值0分，因为没有指定打分查询：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#a40000>GET</span> <span style=color:#a40000>_search</span>
<span style=color:#000;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>&#34;query&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;bool&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;filter&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>&#34;term&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>&#34;status&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;active&#34;</span>
        <span style=color:#000;font-weight:700>}</span>
      <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>这个bool查询有一个match_all查询，它为所有文档赋值1.0</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#a40000>GET</span> <span style=color:#a40000>_search</span>
<span style=color:#000;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>&#34;query&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;bool&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;must&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>&#34;match_all&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{}</span>
      <span style=color:#000;font-weight:700>},</span>
      <span style=color:#204a87;font-weight:700>&#34;filter&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>&#34;term&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>&#34;status&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;active&#34;</span>
        <span style=color:#000;font-weight:700>}</span>
      <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>这个constant_score查询的行为与上面的第二个示例完全相同。constant_score查询为筛选器匹配的所有文档分配1.0分。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#a40000>GET</span> <span style=color:#a40000>_search</span>
<span style=color:#000;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>&#34;query&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;constant_score&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;filter&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>&#34;term&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>&#34;status&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;active&#34;</span>
        <span style=color:#000;font-weight:700>}</span>
      <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-5562c7834eadd03c46f44be1321441d0>6.1.2.1.4 - Elasticsearch复合查询-Disjunction max query</h1><blockquote><p>注意：以下语法都是基于Elasticsearch的7.6版本</p></blockquote><h3 id=disjunction-max-query最佳匹配查询>Disjunction max query(最佳匹配查询)</h3><p>返回与一个或多个包装查询(称为查询子句或子句)匹配的文档。</p><p>如果返回的文档匹配多个查询子句，dis_max查询将从任何匹配子句中为文档分配最高的相关性得分，并为任何其他匹配子查询分配一个打破平局的增量。</p><p>您可以使用dis_max在映射了不同boost因子的字段中搜索一个术语。下面看一下官方的例子：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#a40000>GET</span> <span style=color:#a40000>/_search</span>
<span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;query&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>&#34;dis_max&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>&#34;queries&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
                <span style=color:#000;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>&#34;term&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>&#34;title&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Quick pets&#34;</span> <span style=color:#000;font-weight:700>}},</span>
                <span style=color:#000;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>&#34;term&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>&#34;body&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Quick pets&#34;</span> <span style=color:#000;font-weight:700>}}</span>
            <span style=color:#000;font-weight:700>],</span>
            <span style=color:#204a87;font-weight:700>&#34;tie_breaker&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>0.7</span>
        <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><ul><li><p><strong>queries</strong></p><p>(必须参数，查询对象数组)包含一个或多个查询子句。返回的文档必须匹配一个或多个这些查询。如果文档匹配多个查询，则Elasticsearch使用最高的相关性得分。</p></li><li><p><strong>tie_breaker</strong></p><p>0到1.0之间的浮点数，用于增加匹配多个查询子句的文档的相关性得分。默认为0.0。您可以使用tie_breaker值为在多个字段中包含相同术语的文档分配较高的相关性分数，而不是只在多个字段中包含该术语的文档中最好的一个，而不会将其与多个字段中两个不同术语的较好情况相混淆。如果一个文档匹配多个子句，dis_max查询将计算该文档的相关分数，如下所示:</p><ol><li>从具有最高分数的匹配子句中获取关联分数。</li><li>将任何其他匹配子句的得分乘以tie_breaker值。</li><li>把最高的分数加到相乘的分数上。</li></ol><p>如果tie_breaker值大于0.0，所有匹配的子句都算数，但是分数最高的子句算数最多。</p></li></ul><h3 id=例子>例子</h3><pre><code>#1、创建索引
PUT /dismaxmxsm
{
    &quot;settings&quot;: {
        &quot;number_of_shards&quot;: 1,
        &quot;number_of_replicas&quot;: 1
    },
    &quot;mappings&quot;: {
            &quot;properties&quot;: {
                &quot;title&quot;: {
                    &quot;type&quot;:&quot;text&quot;
                },
                &quot;content&quot;: {
                    &quot;type&quot;:&quot;text&quot;
                }
        }
    }
}

#2、创建数据
PUT  /dismaxmxsm/_doc/1 
{
  &quot;title&quot; : &quot;Java&quot;,  
  &quot;content&quot; : &quot;Javajava&quot; 
}
PUT  /dismaxmxsm/_doc/2
{
  &quot;title&quot; : &quot;GO&quot;, 
  &quot;content&quot; : &quot;Development GO&quot;
}
PUT  /dismaxmxsm/_doc/3
{
  &quot;title&quot; :&quot;python&quot;, 
  &quot;content&quot; :&quot;Python development beginner&quot;
}
</code></pre><h4 id=用should查询>用should查询</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#a40000>GET</span> <span style=color:#a40000>dismaxmxsm/_search</span>
<span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;query&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>&#34;bool&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>&#34;should&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
                <span style=color:#000;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>&#34;match&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>&#34;title&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;java &#34;</span> <span style=color:#000;font-weight:700>}},</span>
                <span style=color:#000;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>&#34;match&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>&#34;content&#34;</span><span style=color:#000;font-weight:700>:</span>  <span style=color:#4e9a06>&#34;java beginner&#34;</span> <span style=color:#000;font-weight:700>}}</span>
            <span style=color:#000;font-weight:700>]</span>
        <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>结果：</p><pre><code>{
  &quot;took&quot; : 0,
  &quot;timed_out&quot; : false,
  &quot;_shards&quot; : {
    &quot;total&quot; : 1,
    &quot;successful&quot; : 1,
    &quot;skipped&quot; : 0,
    &quot;failed&quot; : 0
  },
  &quot;hits&quot; : {
    &quot;total&quot; : {
      &quot;value&quot; : 2,
      &quot;relation&quot; : &quot;eq&quot;
    },
    &quot;max_score&quot; : 0.9808291,
    &quot;hits&quot; : [
      {
        &quot;_index&quot; : &quot;dismaxmxsm&quot;,
        &quot;_type&quot; : &quot;_doc&quot;,
        &quot;_id&quot; : &quot;1&quot;,
        &quot;_score&quot; : 0.9808291,
        &quot;_source&quot; : {
          &quot;title&quot; : &quot;Java&quot;,
          &quot;content&quot; : &quot;Javajava&quot;
        }
      },
      {
        &quot;_index&quot; : &quot;dismaxmxsm&quot;,
        &quot;_type&quot; : &quot;_doc&quot;,
        &quot;_id&quot; : &quot;3&quot;,
        &quot;_score&quot; : 0.81427324,
        &quot;_source&quot; : {
          &quot;title&quot; : &quot;python&quot;,
          &quot;content&quot; : &quot;Python development beginner&quot;
        }
      }
    ]
  }
}
</code></pre><h4 id=用dis_max查询>用dis_max查询</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#a40000>GET</span> <span style=color:#a40000>dismaxmxsm/_search</span>
<span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;query&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>&#34;dis_max&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>&#34;queries&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
                <span style=color:#000;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>&#34;match&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>&#34;title&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;java&#34;</span> <span style=color:#000;font-weight:700>}},</span>
                <span style=color:#000;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>&#34;match&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>&#34;content&#34;</span><span style=color:#000;font-weight:700>:</span>  <span style=color:#4e9a06>&#34;java beginner&#34;</span> <span style=color:#000;font-weight:700>}}</span>
            <span style=color:#000;font-weight:700>]</span>
            <span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>&#34;tie_breaker&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>0.7</span>
        <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>结果：</p><pre><code>{
  &quot;took&quot; : 1,
  &quot;timed_out&quot; : false,
  &quot;_shards&quot; : {
    &quot;total&quot; : 1,
    &quot;successful&quot; : 1,
    &quot;skipped&quot; : 0,
    &quot;failed&quot; : 0
  },
  &quot;hits&quot; : {
    &quot;total&quot; : {
      &quot;value&quot; : 2,
      &quot;relation&quot; : &quot;eq&quot;
    },
    &quot;max_score&quot; : 0.9808291,
    &quot;hits&quot; : [
      {
        &quot;_index&quot; : &quot;dismaxmxsm&quot;,
        &quot;_type&quot; : &quot;_doc&quot;,
        &quot;_id&quot; : &quot;1&quot;,
        &quot;_score&quot; : 0.9808291,
        &quot;_source&quot; : {
          &quot;title&quot; : &quot;Java&quot;,
          &quot;content&quot; : &quot;Javajava&quot;
        }
      },
      {
        &quot;_index&quot; : &quot;dismaxmxsm&quot;,
        &quot;_type&quot; : &quot;_doc&quot;,
        &quot;_id&quot; : &quot;3&quot;,
        &quot;_score&quot; : 0.81427324,
        &quot;_source&quot; : {
          &quot;title&quot; : &quot;python&quot;,
          &quot;content&quot; : &quot;Python development beginner&quot;
        }
      }
    ]
  }
}

</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-fcdebd986e21ba3e19eb2edbfe214887>6.1.3 - Elasticsearch 索引</h1></div><div class=td-content><h1 id=pg-2a343fe20075bfa2165e414ca1f82ae5>6.1.3.1 - Elasticsearch-索引模式</h1><blockquote><p>注意：以下语法都是基于Elasticsearch的7.6版本</p></blockquote><h3 id=索引模式>索引模式</h3><p>之前介绍过，在ES中index相当于关系数据库中的数据库实例。下面来看一下index的一些设置</p><h3 id=索引的设置>索引的设置</h3><p>可以为每一个索引设置级别，如下：</p><ul><li><p><em><strong>静态索引(static)</strong></em></p><p>只能在创建索引或者在关闭的索引上面设置</p></li><li><p><em><strong>动态索引dynamic</strong></em></p><p>可以使用<a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-update-settings.html>update-index-settings API</a>在活动索引上更改它们。</p></li></ul><blockquote><p>注意：更改关闭索引上的静态或动态索引设置可能导致错误的设置，如果不删除和重新创建索引，就无法纠正这些错误</p></blockquote><h4 id=静态索引设置>静态索引设置</h4><p>下面列举了所有的与任何特殊索引无关的静态索引的配置：</p><ul><li><p><strong>index.number_of_shards</strong></p><p>索引应该具有的主分片数量， <strong>默认值为：1，同时这个设置只能在索引创建的时候，不能再关闭了的索引上面进行修改。索引（index）分片的最大值为1024</strong> 。 这个设置以防止由于资源分配而意外创建可能破坏集群稳定的索引。通过 <strong>export ES_JAVA_OPTS="-Des.index.max_number_of_shards=128"</strong> 来设置。</p></li><li><p><strong>index.shard.check_on_startup</strong></p><p>是否应该在打开之前检查分片是否损坏。当检测到损坏时，它将阻止碎片被打开</p><ul><li><p><strong>false</strong></p><p>默认值</p></li><li><p><strong>checksum</strong></p><p>检查是否物理损坏</p></li><li><p><strong>true</strong></p><p>检查物理损坏和逻辑损坏</p></li></ul><blockquote><p>注意： 检查分片可能花费很多时间，在一个很大的索引上面</p></blockquote></li><li><p><strong>index.codec</strong></p><p>默认值使用LZ4压缩压缩存储的数据，但是可以将这个值设置为best_compression，它使用DEFLATE获得更高的压缩比，代价是降低存储字段的性能。如果您正在更新压缩类型，则新的压缩类型将在段合并后应用。段合并可以使用强制合并来强制执行。</p></li><li><p><strong>index.routing_partition_size</strong></p><p>自定义路由值可以转到的碎片数。默认值为1，只能在创建索引时设置。这个值必须小于索引。除非索引是number_of_shards。number_of_shards的值也是1。有关如何使用此设置的详细信息，<a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-routing-field.html#routing-index-partition>请参阅路由到索引分区</a>。</p></li><li><p><strong>index.load_fixed_bitset_filters_eagerly</strong></p><p>指示是否为嵌套查询预先加载缓存的筛选器。可能的值为true(默认值)和false。</p></li></ul><h4 id=动态索引设置>动态索引设置</h4><ul><li><p><strong>index.number_of_replicas</strong></p><p>每个主分片副本的数量，默认值：1</p></li><li><p><strong>index.auto_expand_replicas</strong></p><p>根据集群中数据节点的数量自动扩展副本的数量。设置为以破折号分隔的下界和上界(例如0-5)，或将all用于上界(例如0-all)。默认为false(即禁用)。注意auto-expanded数量的副本只需要配置过滤规则,但是忽略了其他的分配规则,如碎片分配每个节点感知和总碎片,这可能导致集群健康成为黄色如果适用的规则防止所有的副本分配。</p></li><li><p><strong>index.search.idle.after</strong></p><p>设置分片被认为搜索无效，不能接收搜索或获取请求的时间。（<strong>默认值30s</strong>）</p></li><li><p><strong>index.refresh_interval</strong></p><p>执行刷新操作的频率，使对索引的最新更改对搜索可见。默认为1。可以设置为-1以禁用刷新。如果没有显式设置此设置，则至少index.search.idle没有看到搜索流量的分片。秒后将不会收到背景刷新，直到他们收到一个搜索请求。在等待刷新的地方遇到空闲分片的搜索将等待下一次后台刷新(在1秒内)。此行为的目的是在不执行搜索的默认情况下自动优化批量索引。为了避免这种行为，应该将1s的显式值设置为刷新间隔。</p></li><li><p><strong><code>index.max_inner_result_window</code></strong></p><p>The maximum value of <code>from + size</code> for inner hits definition and top hits aggregations to this index. Defaults to <code>100</code>. Inner hits and top hits aggregation take heap memory and time proportional to <code>from + size</code> and this limits that memory.</p></li><li><p><strong><code>index.max_rescore_window</code></strong></p><p>The maximum value of <code>window_size</code> for <code>rescore</code> requests in searches of this index. Defaults to <code>index.max_result_window</code> which defaults to <code>10000</code>. Search requests take heap memory and time proportional to <code>max(window_size, from + size)</code> and this limits that memory.</p></li><li><p><strong><code>index.max_docvalue_fields_search</code></strong></p><p>The maximum number of <code>docvalue_fields</code> that are allowed in a query. Defaults to <code>100</code>. Doc-value fields are costly since they might incur a per-field per-document seek.</p></li><li><p><strong><code>index.max_script_fields</code></strong></p><p>The maximum number of <code>script_fields</code> that are allowed in a query. Defaults to <code>32</code>.</p></li><li><p><strong><code>index.max_ngram_diff</code></strong></p><p>The maximum allowed difference between min_gram and max_gram for NGramTokenizer and NGramTokenFilter. Defaults to <code>1</code>.</p></li><li><p><strong><code>index.max_shingle_diff</code></strong></p><p>The maximum allowed difference between max_shingle_size and min_shingle_size for ShingleTokenFilter. Defaults to <code>3</code>.</p></li><li><p><strong><code>index.blocks.read_only</code></strong></p><p>Set to <code>true</code> to make the index and index metadata read only, <code>false</code> to allow writes and metadata changes.</p></li><li><p><strong><code>index.blocks.read_only_allow_delete</code></strong></p><p>Similar to <code>index.blocks.read_only</code> but also allows deleting the index to free up resources. The <a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/disk-allocator.html>disk-based shard allocator</a> may add and remove this block automatically.</p></li><li><p><strong><code>index.blocks.read</code></strong></p><p>Set to <code>true</code> to disable read operations against the index.</p></li><li><p><strong><code>index.blocks.write</code></strong></p><p>Set to <code>true</code> to disable data write operations against the index. Unlike <code>read_only</code>, this setting does not affect metadata. For instance, you can close an index with a <code>write</code> block, but not an index with a <code>read_only</code> block.</p></li><li><p><strong><code>index.blocks.metadata</code></strong></p><p>Set to <code>true</code> to disable index metadata reads and writes.</p></li><li><p><strong><code>index.max_refresh_listeners</code></strong></p><p>Maximum number of refresh listeners available on each shard of the index. These listeners are used to implement <a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-refresh.html><code>refresh=wait_for</code></a>.</p></li><li><p><strong><code>index.analyze.max_token_count</code></strong></p><p>The maximum number of tokens that can be produced using _analyze API. Defaults to <code>10000</code>.</p></li><li><p><strong><code>index.highlight.max_analyzed_offset</code></strong></p><p>The maximum number of characters that will be analyzed for a highlight request. This setting is only applicable when highlighting is requested on a text that was indexed without offsets or term vectors. Defaults to <code>1000000</code>.</p></li><li><p><strong><code>index.max_terms_count</code></strong></p><p>The maximum number of terms that can be used in Terms Query. Defaults to <code>65536</code>.</p></li><li><p><strong><code>index.max_regex_length</code></strong></p><p>The maximum length of regex that can be used in Regexp Query. Defaults to <code>1000</code>.</p></li><li><p><strong><code>index.routing.allocation.enable</code></strong></p><p>Controls shard allocation for this index. It can be set to:<code>all</code> (default) - Allows shard allocation for all shards.<code>primaries</code> - Allows shard allocation only for primary shards.<code>new_primaries</code> - Allows shard allocation only for newly-created primary shards.<code>none</code> - No shard allocation is allowed.</p></li><li><p><strong><code>index.routing.rebalance.enable</code></strong></p><p>Enables shard rebalancing for this index. It can be set to:<code>all</code> (default) - Allows shard rebalancing for all shards.<code>primaries</code> - Allows shard rebalancing only for primary shards.<code>replicas</code> - Allows shard rebalancing only for replica shards.<code>none</code> - No shard rebalancing is allowed.</p></li><li><p><strong><code>index.gc_deletes</code></strong></p><p>The length of time that a <a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-delete.html#delete-versioning>deleted document’s version number</a> remains available for <a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-index_.html#index-versioning>further versioned operations</a>. Defaults to <code>60s</code>.</p></li><li><p><strong><code>index.default_pipeline</code></strong></p><p>The default <a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/ingest.html>ingest node</a> pipeline for this index. Index requests will fail if the default pipeline is set and the pipeline does not exist. The default may be overridden using the <code>pipeline</code> parameter. The special pipeline name <code>_none</code> indicates no ingest pipeline should be run.</p></li><li><p><strong><code>index.final_pipeline</code></strong></p><p>The final <a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/ingest.html>ingest node</a> pipeline for this index. Index requests will fail if the final pipeline is set and the pipeline does not exist. The final pipeline always runs after the request pipeline (if specified) and the default pipeline (if it exists). The special pipeline name <code>_none</code> indicates no ingest pipeline will run.</p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-98885c5652d1ba82ef8776e8bf9533ae>6.1.4 - elasticsearch基本概念</h1><h3 id=基本概念>基本概念</h3><p>首先了解一下ES的几个基本概念。</p><h4 id=索引index>索引(index)</h4><p>ElasticSearch把数据存放到一个或者多个索引(indices)中。如果用关系型数据库模型对比，索引(index)的地位与数据库实例(database)相当。索引存放和读取的基本单元是文档(Document)。我们也一再强调，ElasticSearch内部用Apache Lucene实现索引中数据的读写。读者应该清楚的是：在ElasticSearch中被视为单独的一个索引(index)，在Lucene中可能不止一个。这是因为在分布式体系中，ElasticSearch会用到分片(shards)和备份(replicas)机制将一个索引(index)存储多份。</p><h4 id=文档document>文档(Document)</h4><p>在ElasticSearch的世界中，文档(Document)是主要的存在实体(在Lucene中也是如此)。所有的ElasticSearch应用需求到最后都可以统一建模成一个检索模型：检索相关文档。文档(Document)由一个或者多个域(Field)组成，每个域(Field)由一个域名(此域名非彼域名)和一个或者多个值组成(有多个值的值称为多值域(multi-valued))。在ElasticSeach中，每个文档(Document)都可能会有不同的域(Field)集合；也就是说文档(Document)是没有固定的模式和统一的结构。文档(Document)之间保持结构的相似性即可(Lucene中的文档(Document)也秉持着相同的规定)。实际上，ElasticSearch中的文档(Document)就是Lucene中的文档(Document)。从客户端的角度来看，文档(Document)就是一个JSON对象(关于JSON格式的相关信息,请参看hhtp://en.wikipedia.org/wiki/JSON)。</p><h4 id=参数映射mapping>参数映射(Mapping)</h4><p>所有的文档(Document)在存储之前都必须经过分析(analyze)流程。用户可以配置输入文本分解成Token的方式；哪些Token应该被过滤掉；或者其它的的处理流程，比如去除HTML标签。此外，ElasticSearch提供的各种特性，比如排序的相关信息。保存上述的配置信息，这就是参数映射(Mapping)在ElasticSearch中扮演的角色。尽管ElasticSearch可以根据域的值自动识别域的类型(field type)，在生产应用中，都是需要自己配置这些信息以避免一些奇的问题发生。要保证应用的可控性。</p><h4 id=文档类型type>文档类型(Type)</h4><p>每个文档在ElasticSearch中都必须设定它的类型。文档类型使得同一个索引中在存储结构不同文档时，只需要依据文档类型就可以找到对应的参数映射(Mapping)信息，方便文档的存取。</p><h3 id=es和关系型数据库的比较>ES和关系型数据库的比较</h3><p>一个ES集群可以包含多个索引（数据库），每个索引又包含了很多类型（表），类型中包含了很多文档（行），每个文档使用 JSON 格式存储数据，包含了很多字段（列）。</p><table><thead><tr><th style=text-align:left>关系型数据库</th><th>数据库</th><th>表</th><th>行</th><th>列</th></tr></thead><tbody><tr><td style=text-align:left>ElasticSearch</td><td>索引(index)</td><td>类型(Types)</td><td>文档(Documents)</td><td>字段(Fields)</td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-e22f96dad81fab1e53b89fdf1734542c>6.2 - mysql</h1></div><div class=td-content><h1 id=pg-e0de2e6771d881b72685715e0f4489b1>6.2.1 - mysql命令</h1><h3 id=1-mysql常用系统命令>1. mysql常用系统命令</h3><p>登录后三部曲命令：查看数据库，选择数据库，查看表</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=color:#204a87;font-weight:700>show</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>databases</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>//</span><span style=color:#a40000>显示数据库</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>use</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>数据库名称</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>//</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>选择数据库</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>show</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>tables</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>//</span><span style=color:#a40000>显示数据库表</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h4 id=11查询变量>1.1查询变量</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=color:#204a87;font-weight:700>show</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>variables</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>show</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>variables</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>like</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;%dir%&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>例子：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=color:#000>mysql</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>show</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>variables</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>like</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;%dir%&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>+-----------------------------------------+--------------------------------+</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Variable_name</span><span style=color:#f8f8f8;text-decoration:underline>                           </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Value</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>+-----------------------------------------+--------------------------------+</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>basedir</span><span style=color:#f8f8f8;text-decoration:underline>                                 </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>usr</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>binlog_direct_non_transactional_updates</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>OFF</span><span style=color:#f8f8f8;text-decoration:underline>                            </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>character_sets_dir</span><span style=color:#f8f8f8;text-decoration:underline>                      </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>usr</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>share</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>mysql</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>charsets</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>datadir</span><span style=color:#f8f8f8;text-decoration:underline>                                 </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>var</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>lib</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>mysql</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>innodb_data_home_dir</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>                                </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>innodb_directories</span><span style=color:#f8f8f8;text-decoration:underline>                      </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>                                </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>innodb_doublewrite_dir</span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>                                </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>innodb_log_group_home_dir</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>.</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8;text-decoration:underline>                             </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>innodb_max_dirty_pages_pct</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>90</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>000000</span><span style=color:#f8f8f8;text-decoration:underline>                      </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>innodb_max_dirty_pages_pct_lwm</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>000000</span><span style=color:#f8f8f8;text-decoration:underline>                      </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>innodb_redo_log_archive_dirs</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>                                </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>innodb_temp_tablespaces_dir</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>.</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#8f5902;font-style:italic>#innodb_temp/                |
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>innodb_tmpdir</span><span style=color:#f8f8f8;text-decoration:underline>                           </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>                                </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>innodb_undo_directory</span><span style=color:#f8f8f8;text-decoration:underline>                   </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>.</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8;text-decoration:underline>                             </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>lc_messages_dir</span><span style=color:#f8f8f8;text-decoration:underline>                         </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>usr</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>share</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>mysql</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>plugin_dir</span><span style=color:#f8f8f8;text-decoration:underline>                              </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>usr</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>lib64</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>mysql</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>plugin</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>slave_load_tmpdir</span><span style=color:#f8f8f8;text-decoration:underline>                       </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>tmp</span><span style=color:#f8f8f8;text-decoration:underline>                           </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tmpdir</span><span style=color:#f8f8f8;text-decoration:underline>                                  </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>tmp</span><span style=color:#f8f8f8;text-decoration:underline>                           </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>+-----------------------------------------+--------------------------------+</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>09</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=2-mysql表相关命令>2. mysql表相关命令</h3><h4 id=21-查看表索引>2.1 查看表索引</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=color:#204a87;font-weight:700>show</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>index</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-8eadac371fc406ad90ac0089742b30a3>6.2.2 - Mysql基础知识</h1><p>文章中用到的数据都是MySQL官网提供的。具体地址为：https://dev.mysql.com/doc/index-other.html</p></div><div class=td-content style=page-break-before:always><h1 id=pg-e0e58cd7fe078fdb821378315a1476c5>6.2.2.1 - mysql索引1-索引如何组织数据</h1><h3 id=1-mysql索引分类>1. mysql索引分类</h3><p>mysql索引主要分为两类：</p><ul><li><p>主键索引</p><p>每一张表的主键就是一个索引。mysql中组织数据也是通过该字段。在没有手动指定主键的情况下，mysql会自动生成一列 <em><strong>row_id</strong></em> 来作为主键。</p></li><li><p>辅助索引</p><p>常用的唯一索引，组合索引，普通的索引都是辅助索引。</p></li></ul><blockquote><p>主键索引和唯一索引的区别：</p><ul><li>唯一索引可以为空值，主键索引不能</li><li>mysql一张表只能有一个主键索引，而可以拥有多个唯一索引</li><li>主键索引一定是一个唯一索引，而唯一索引不一定是主键索引</li></ul></blockquote><h3 id=2-主键索引的组织数据方式>2. 主键索引的组织数据方式</h3><p>mysql的数据逻辑组织方式如下图：</p><p><img src="https://github.com/mxsm/picture/blob/main/mysql/innodbtablestruct.png?raw=true" alt=组成图示></p><p>下面看下主键组织数据的情况，也就是主键索引：</p><p><img src="https://github.com/mxsm/picture/blob/main/mysql/mysql%E4%B8%BB%E9%94%AE%E7%BB%84%E7%BB%87%E6%95%B0%E6%8D%AE.png?raw=true" alt></p><p>B+数组织的是mysql中的页数据。在B+树中的非叶子节点，存储的是主键和页号的指针。对于叶子节点存入的row数据。</p><blockquote><p>在B+tree上有两头指针，一个指向根节点，另个知晓关键字的最小的叶子节点，而且所有的叶子及诶单之间是一种链式环结构。因此B+tree可以做两种查找运算:</p><ul><li>对主键范围查找和分页查找</li><li>根节点开始的随机查找</li></ul></blockquote><p>这里通过会有一个计算层数能够存储的数据估算，例如：主键为int（4byte）,页号指针6byte那么对于非叶子节点能够存储的数据量为，16K / (4+6) 能够存储1600条索引数据那么对于上面来说Degree=3的B+tree。假设一条记录的所占的空间为1K那么mysql一页数据可以存储16条数据。公式如下：</p><p>1600 X 1600 X 16 = 40960000 。</p><blockquote><p>InnoDB是通过B+tree结构对主键创建索引，然后叶子节点存储记录。如果没有主键，那么会选择唯一建。如果没有唯一健就会生成一个六个字节的row_id来作为主键。</p></blockquote><h3 id=3-辅助索引组织数据的方式>3. 辅助索引组织数据的方式</h3><p>数据的组织方式如下图：</p><p><img src="https://github.com/mxsm/picture/blob/main/mysql/mysql%E8%BE%85%E5%8A%A9%E7%B4%A2%E5%BC%95%E7%BB%84%E7%BB%87%E6%95%B0%E6%8D%AE%E6%96%B9%E5%BC%8F.png?raw=true" alt></p><p>辅助索引非叶子节点的数据为：辅助索引值+页号的指针数据，叶子节点为辅助索引的数据和主键的索引。</p><h3 id=4-总结>4. 总结</h3><ul><li>主键索引叶子节点跟的是数据，而负责索引叶子节点跟的主键。</li><li>如果查询包含所有的辅助索引并且能够符合索引的匹配原则，那么这种情况下就不需要进行回表查询数据，这也叫覆盖索引</li></ul><blockquote><p>我是蚂蚁背大象，文章对你有帮助点赞关注我，文章有不正确的地方请您斧正留言评论~谢谢！</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-98acea010485c71694a9e83d4912ee6a>6.2.2.2 - mysql索引2-索引分类</h1><blockquote><p>mysql 版本为8.0版本</p></blockquote><p>[TOC]</p><p>在mysql的使用中，索引是一个少不了的话题，经常会听到很多关于索引的名称。比如全文索引，唯一索引等等。五花八门，下面我们就来对这些索引进行一一的说明。图如下：</p><p><img src="https://github.com/mxsm/picture/blob/main/mysql/mysql%E7%B4%A2%E5%BC%95%E5%88%86%E7%B1%BB.png?raw=true" alt></p><p>创建索引的语法(<a href=https://dev.mysql.com/doc/refman/8.0/en/create-index.html>来源mysql官网</a>):</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#204a87;font-weight:700>UNIQUE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FULLTEXT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SPATIAL</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INDEX</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>index_name</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>index_type</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tbl_name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>key_part</span><span style=color:#000;font-weight:700>,...)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>index_option</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>algorithm_option</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>lock_option</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>...</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>key_part</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>{</span><span style=color:#000>col_name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[(</span><span style=color:#204a87;font-weight:700>length</span><span style=color:#000;font-weight:700>)]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>expr</span><span style=color:#000;font-weight:700>)</span><span style=color:#a40000>}</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#204a87;font-weight:700>ASC</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DESC</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>index_option</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>KEY_BLOCK_SIZE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>value</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>index_type</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WITH</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PARSER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>parser_name</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>COMMENT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;string&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>{</span><span style=color:#000>VISIBLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>INVISIBLE</span><span style=color:#a40000>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ENGINE_ATTRIBUTE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;string&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SECONDARY_ENGINE_ATTRIBUTE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;string&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>index_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>USING</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>{</span><span style=color:#000>BTREE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HASH</span><span style=color:#a40000>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>algorithm_option</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>ALGORITHM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>{</span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>INPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>COPY</span><span style=color:#a40000>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>lock_option</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>LOCK</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>{</span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NONE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SHARED</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>EXCLUSIVE</span><span style=color:#a40000>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><blockquote><p>Note: create index 不能创建主键</p></blockquote><h3 id=1-主键索引>1. 主键索引</h3><p>mysql中Innodb存储引擎来说，一张表只能有一个主键索引。</p><blockquote><p>rowId MySQL的InnoDB引擎默认采用索引组织表</p></blockquote><h3 id=2-辅助索引>2. 辅助索引</h3><p>什么叫辅助索引？主键意外的索引就叫辅助索引。这里包含了我们平时说的唯一索引，组合索引，普通索引。</p><p><img src="https://github.com/mxsm/picture/blob/main/mysql/mysql%E7%B4%A2%E5%BC%95%E5%88%86%E7%B1%BB1.png?raw=true" alt></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INDEX</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>part_of_name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>customer</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>));</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>--创建普通索引使用的是B+tree
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>UNIQUE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INDEX</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>part_of_name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>customer</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>USING</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BTREE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>--创建唯一索引
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FULLTEXT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INDEX</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>part_of_name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>customer</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>USING</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BTREE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>--创建全文索引
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SPATIAL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INDEX</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>part_of_name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>customer</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>USING</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BTREE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>--创建空间索引
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>world</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000;font-weight:700>.</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>city</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ADD</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FULLTEXT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INDEX</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>CountryCode</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>CountryCode</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>USING</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BTREE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>--创建索引
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>--删除索引
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INDEX</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>索引名称</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>表名</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>表名</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INDEX</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>索引名称</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h4 id=21-普通索引>2.1 普通索引</h4><p>普通索引就是平时常见创建的索引。可以针对一个列或者多个列进行创建索引。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INDEX</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>part_of_name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>customer</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>));</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>//</span><span style=color:#a40000>对单个字段建立索引</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INDEX</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>part_of_name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>customer</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>),</span><span style=color:#000>age</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>//</span><span style=color:#a40000>对多个字段建立索引</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h4 id=22-唯一索引>2.2 唯一索引</h4><p>它与前面的"普通索引"类似，不同的就是：索引列的值必须唯一，但允许有空值。如果是组合索引，则列值的组合必须唯一。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>UNIQUE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INDEX</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>part_of_name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>customer</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>USING</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BTREE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>--</span><span style=color:#a40000>创建唯一索引</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>drop</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>index</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>part_of_name</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>-- 删除索引
</span></code></pre></div><h4 id=23-全文索引>2.3 全文索引</h4><p>全文检索技术是智能信息管理的关键技术之一，其主要目的就是实现对大容量的非结构化数据的快速查找。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FULLTEXT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INDEX</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>part_of_name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>customer</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>USING</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BTREE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>--创建全文索引
</span></code></pre></div><h4 id=24-空间索引>2.4 空间索引</h4><p>InnoDB支持空间索引，通过R树来实现，使得空间搜索变得高效</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SPATIAL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INDEX</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>part_of_name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>customer</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>));</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>--</span><span style=color:#a40000>创建空间索引</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=3-聚族索引和非聚族索引>3. 聚族索引和非聚族索引</h3><p>聚族索引和非聚族索引说的是对数据的组织方式。</p><ul><li>聚族索引：叶子节点存放的是记录的数据</li><li>非聚族索引：叶子节点存放的是主键的数据</li></ul><h3 id=4-覆盖索引>4. 覆盖索引</h3><p>覆盖索引（covering index）指一个查询语句的执行只用从索引中就能够取得，不必从数据表中读取。也可以称之为实现了索引覆盖。如果索引包含所有满足查询需要的数据的索引成为覆盖索引(Covering Index)，也就是平时所说的不需要回表操作。</p><blockquote><p>是否需要回表来判断是否为覆盖索引。</p><p>使用explain，可以通过输出的extra列来判断，对于一个索引覆盖查询，显示为<strong>using index</strong>,MySQL查询优化器在执行查询前会决定是否有索引覆盖查询</p></blockquote><h3 id=5-组合索引>5. 组合索引</h3><p>所谓的组合索引其实是对索引的列的多少来进行分类的。例如一行的话就是我们经常用到的索引方式。 对于大于1列的索引我们叫做组合索引。</p><h4 id=51-什么时候创建组合索引>5.1 什么时候创建组合索引</h4><p>当我们的where查询存在多个条件查询的时候，我们需要对查询的列创建组合索引</p><h4 id=52-组合索引相比每个字段索引的好处>5.2 组合索引相比每个字段索引的好处</h4><ul><li><p><strong>减少开销</strong></p><p>比如对col1、col2、col3创建组合索引，相当于创建了（col1）、（col1，col2）、（col1，col2，col3）3个索引。</p></li><li><p><strong>覆盖索引</strong></p><p>通过组合索引直接查出来。假如查询SELECT col1, col2, col3 FROM 表名，由于查询的字段存在索引页中，那么可以从索引中直接获取，而不需要回表查询。</p></li><li><p><strong>效率高</strong></p><p><em><code>对col1、col2、col3三列分别创建索引，MySQL只会选择辨识度高的一列作为索引</code></em> 。假设有100w的数据，一个索引筛选出10%的数据，那么可以筛选出10w的数据；对于组合索引而言，可以筛选出100w*10%*10%*10%=1000条数据</p></li></ul><h4 id=53-对于查询及存在组合索引有存在单一索引数据库如何处理>5.3 对于查询及存在组合索引有存在单一索引数据库如何处理？</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>Student</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>int</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>11</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>varchar</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>255</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>classname</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>varchar</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>255</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>classNumber</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>int</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>11</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>PRIMARY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>test_index</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000;font-weight:700>,</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>classname</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000;font-weight:700>,</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>classNumber</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>USING</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BTREE</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>name_index</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>USING</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BTREE</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>classname_index</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>classname</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>USING</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BTREE</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>classNumber</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>classNumber</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>USING</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BTREE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ENGINE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>InnoDB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CHARSET</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>utf8mb4</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>表中的数据：</p><p><img src="https://github.com/mxsm/document/blob/master/image/database/indexTest.png?raw=true" alt=数据></p><p><img src="https://github.com/mxsm/document/blob/master/image/database/select1.png?raw=true" alt=情况1></p><p><img src="https://github.com/mxsm/document/blob/master/image/database/selection2.png?raw=true" alt=情况2></p><p>从上图可以看出：<strong>最左匹配原则和字段的在前和在后面没有关系</strong></p><hr><p><img src="https://github.com/mxsm/document/blob/master/image/database/selection3.png?raw=true" alt=情况2></p><p><img src="https://github.com/mxsm/document/blob/master/image/database/selection4.png?raw=true" alt=情况2></p><p>从上图可以看出：<strong>在一个字段如果符合最左匹配原则就优先使用最左匹配原则。</strong></p><p><strong>假设我们创建（col1，col2，col3）这样的一个组合索引，那么相当于对col1列进行排序，也就是我们创建组合索引，以最左边的为准，只要查询条件中带有最左边的列，那么查询就会使用到索引，和字段在where后面的位置无关。</strong></p><p>参考文档：</p><ul><li><a href=https://www.jianshu.com/p/77eaad62f974>https://www.jianshu.com/p/77eaad62f974</a></li><li><a href=https://www.cnblogs.com/chenpingzhao/p/4776981.html>https://www.cnblogs.com/chenpingzhao/p/4776981.html</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-b02679d8b8f3028059cd65c9826ccf54>6.2.2.3 - mysql索引3-索引匹配和SQL优化</h1><p>「这是我参与2022首次更文挑战的第28天，活动详情查看：<a href=https://juejin.cn/post/7052884569032392740>2022首次更文挑战</a>」</p><ul><li><a href=#1-%E7%B4%A2%E5%BC%95%E5%8C%B9%E9%85%8D>1. 索引匹配</a><ul><li><a href=#11-%E5%85%A8%E5%80%BC%E5%8C%B9%E9%85%8D>1.1 全值匹配</a></li><li><a href=#12-%E5%8C%B9%E9%85%8D%E6%9C%80%E5%B7%A6%E5%89%8D%E7%BC%80>1.2 匹配最左前缀</a></li><li><a href=#13-%E5%8C%B9%E9%85%8D%E5%88%97%E5%89%8D%E7%BC%80>1.3 匹配列前缀</a></li><li><a href=#14-%E5%8C%B9%E9%85%8D%E8%8C%83%E5%9B%B4%E5%80%BC>1.4 匹配范围值</a></li><li><a href=#15-%E7%B2%BE%E7%A1%AE%E5%8C%B9%E9%85%8D%E6%9F%90%E4%B8%80%E5%88%97%E5%B9%B6%E4%B8%94%E8%8C%83%E5%9B%B4%E5%8C%B9%E9%85%8D%E5%8F%A6%E4%B8%80%E5%88%97>1.5 精确匹配某一列并且范围匹配另一列</a></li><li><a href=#16-%E5%8F%AA%E8%AE%BF%E9%97%AE%E7%B4%A2%E5%BC%95%E7%9A%84%E6%9F%A5%E8%AF%A2%E8%A6%86%E7%9B%96%E7%B4%A2%E5%BC%95>1.6 只访问索引的查询(覆盖索引)</a></li></ul></li><li><a href=#2-sql%E4%BC%98%E5%8C%96>2. SQL优化</a></li></ul><p>通过前面对索引类型，以及索引对数据的组织方式等了解，本章节来说说索引的匹配和SQL的优化(索引方面的)。</p><blockquote><p>下面用到的例子的数据库来自mysql官网的例子下载地址:<a href=https://dev.mysql.com/doc/index-other.html>官网的数据库</a></p></blockquote><h3 id=1-索引匹配>1. 索引匹配</h3><p><img src=C:%5CUsers%5Cmxsm%5CDocuments%5C%E7%B4%A2%E5%BC%95%E7%9A%84%E5%8C%B9%E9%85%8D%E6%96%B9%E5%BC%8F.png alt></p><p>索引匹配这里大致分为了以上六种。下面通过例子一一来讲解。</p><p>city表中 Name和CountryCode组成组合索引。</p><h4 id=11-全值匹配>1.1 全值匹配</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>city</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>Name</span><span style=color:#ce5c00;font-weight:700>`=</span><span style=color:#4e9a06>&#39;Kabul&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CountryCode</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;AFG&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p><img src=C:%5CUsers%5Cmxsm%5CDesktop%5Cpic%5C%E5%85%A8%E5%80%BC%E5%8C%B9%E9%85%8D.png alt></p><h4 id=12-匹配最左前缀>1.2 匹配最左前缀</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>city</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>Name</span><span style=color:#ce5c00;font-weight:700>`=</span><span style=color:#4e9a06>&#39;Kabul&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>District</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Kabol&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>city</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>CountryCode</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;AFG&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>District</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Kabol&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p><img src=C:%5CUsers%5Cmxsm%5CDesktop%5Cpic%5C%E5%8C%B9%E9%85%8D%E6%9C%80%E5%B7%A6%E5%89%8D%E7%BC%80.png alt></p><h4 id=13-匹配列前缀>1.3 匹配列前缀</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>city</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>District</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>like</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Ov%&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>city</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>District</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>like</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;%Ov%&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p><img src=C:%5CUsers%5Cmxsm%5CDesktop%5Cpic%5C%E5%8C%B9%E9%85%8D%E5%88%97%E5%89%8D%E7%BC%80.png alt></p><h4 id=14-匹配范围值>1.4 匹配范围值</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Population</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>city</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Population</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>201843</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p><img src=C:%5CUsers%5Cmxsm%5CDesktop%5Cpic%5C%E8%8C%83%E5%9B%B4%E5%8C%B9%E9%85%8D.png alt></p><h4 id=15-精确匹配某一列并且范围匹配另一列>1.5 精确匹配某一列并且范围匹配另一列</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>city</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Breda&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>and</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CountryCode</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;NLD&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p><img src=C:%5CUsers%5Cmxsm%5CDesktop%5Cpic%5C%E7%B2%BE%E7%A1%AE%E5%8C%B9%E9%85%8D%E6%9F%90%E4%B8%80%E5%88%97%E5%B9%B6%E4%B8%94%E8%8C%83%E5%9B%B4%E5%8C%B9%E9%85%8D%E5%8F%A6%E4%B8%80%E5%88%97.png alt></p><h4 id=16-只访问索引的查询覆盖索引>1.6 只访问索引的查询(覆盖索引)</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Name</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>CountryCode</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>District</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>Population</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>city</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Breda&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>and</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CountryCode</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;NLD&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p><img src=C:%5CUsers%5Cmxsm%5CDesktop%5Cpic%5C%E5%8F%AA%E8%AE%BF%E9%97%AE%E7%B4%A2%E5%BC%95%E7%9A%84%E6%9F%A5%E8%AF%A2-%E8%A6%86%E7%9B%96%E7%B4%A2%E5%BC%95.png alt></p><h3 id=2-sql优化>2. SQL优化</h3><p>sql优化意义是获取相同的数据能够用最小的时间。SQL的优化有很多方面，例如提高硬件的处理能力。在同一个SQL下硬件处理能力越强的你们SQL也就越快。比如网络的延迟等等。我们这边的SQL主要考虑的是通过优化SQL本身和建立适当的索引来降低查询所需要的时间。</p><ul><li><p>对字段建立适当的索引</p><p>这里说的是建立适当的索引。不是索引越多越好。根据实际情况建立适当的索引。在建立索引的过程中也会有技巧。</p></li><li><p>建表的字段</p><p>一般对于建表的字段来说，根据业务需求建立对应的字段大小。等等</p></li><li><p>SQL本身的优化</p><p>何为SQL本身的优化，例如业务需要表A中的a、b 、c三个字段。在查询的就应该根据条件返回这三个字段。而不是返回全部的字段。这样全部返回增加网络的负担。同样也增加了数据库的负担。 很可能导致一些索引使用不了。</p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-53a5a5c185e31e14ab9d9ad9d4075318>6.2.2.4 - MySQL几种索引的区别</h1><h3 id=主键和唯一索引的区别>主键和唯一索引的区别</h3><ul><li>主键是一种约束，唯一索引是一种索引。</li><li>主键创建后一定包含一个唯一索引，唯一索引并不一定就是主键</li><li>主键不能为空，唯一索引可以为空</li><li>主键可以被其他表引用为外键，而唯一索引不能</li><li>一张表只能创建一个主键，但是可以创建多个唯一索引</li></ul><p><strong>总结一下就是：主键包含唯一索引的功能，但是还有部分增强</strong></p><h4 id=聚集索引和非聚集索引的区别>聚集索引和非聚集索引的区别</h4><ul><li><p><strong>聚集索引</strong></p><pre><code>数据行的物理顺序与列值（一般是主键的那一列）的逻辑顺序相同，一个表中只能拥有一个聚集索引
</code></pre></li><li><p><strong>非聚集索引</strong></p><pre><code>该索引中索引的逻辑顺序与磁盘上行的物理存储顺序不同，一个表中可以拥有多个非聚集索引
</code></pre></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-5a47e7eaf772733bc8247b0243ce3c2c>6.2.2.5 - 行溢出</h1><h3 id=行溢出参考>行溢出参考</h3><p><a href=https://keithlan.github.io/2016/04/07/idb_biger/>行溢出参考</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-7ed18dddab526c61f5d89c53439c832c>6.2.2.6 - 存储引擎</h1><h3 id=1-myisam存储引擎>1. MyISAM存储引擎</h3><ul><li><strong>特点：</strong><ul><li><strong>不支持行锁(MyISAM只有表锁)</strong>，读取时对需要读到的所有表加锁，写入时则对表加排他锁.</li><li><strong>不支持事务</strong></li><li><strong>不支持外键</strong></li><li><strong>不支持崩溃后的安全恢复</strong></li><li>在表有读取查询的同时，支持往表中插入新纪录</li><li>支持BLOB和TEXT的前500个字符索引，<strong>支持全文索引</strong></li><li><strong>支持延迟更新索引</strong></li><li>对于不会进行修改的表，支持 <strong>压缩表</strong> ，极大地减少了磁盘空间的占用</li></ul></li><li><strong>存储格式</strong><ul><li><strong><code>.frm</code></strong> 文件存储表定义</li><li><strong><code>.MYD</code></strong> 文件存储数据文件</li><li><strong><code>.MYI</code></strong> 文件存储索引文件</li></ul></li></ul><p><strong>行锁表锁</strong></p><pre><code>Mysql的行锁和表锁（ 锁是计算机协调多个进程或纯线程并发访问某一资源的机制）
表级锁： 每次操作锁住整张表。开销小，加锁快；不会出现死锁；锁定粒度大，发生锁冲突的概率最高，并发度最低；
行级锁： 每次操作锁住一行数据。开销大，加锁慢；会出现死锁；锁定粒度最小，发生锁冲突的概率最低，并发度也最高；
</code></pre><ul><li><p><strong>索引的实现：</strong></p><p><strong>MyISAM 索引文件和数据文件是分离的，索引文件仅保存数据记录的地址。</strong></p><ul><li><p><strong>主键索引的实现</strong></p><p><img src="https://github.com/mxsm/document/blob/master/image/database/myisamprimarykeyimplments.png?raw=true" alt=图解></p></li><li><p><strong>辅助索引：</strong></p><p><img src="https://github.com/mxsm/document/blob/master/image/database/myisamsecondarykeyimplments.png?raw=true" alt=图片></p></li></ul></li></ul><p>在MyISAM中，主索引和辅助索引（Secondary key）在结构上没有任何区别。只是主索引要求key是唯一的，而辅助索引的key可以重复。<strong>data域保存数据记录的地址，因为数据文件和索引文件是分开的。</strong></p><p><strong>MyISAM</strong> 中索引检索的算法为首先按照 <strong>B+Tree</strong> 搜索算法搜索索引，如果指定的Key存在，则取出其data域的值，然后以data域的值为地址，读取相应数据记录。</p><p>MyISAM的索引方式也叫做“<strong>非聚集</strong>”的，之所以这么称呼是为了与InnoDB的聚集索引区分。</p><h4 id=知识点补充>知识点补充</h4><pre><code>什么叫非聚集索引？
非聚集索引索引项顺序存储，但索引项对应的内容却是随机存储的；
什么是聚集索引？
聚集索引表记录的排列顺序与索引的排列顺序一致
</code></pre><h3 id=2-innodb>2. InnoDB</h3><ul><li><p><strong>特点：</strong></p><ul><li><strong>支持行锁</strong>，采用MVCC来支持高并发，有可能死锁。</li><li>支持事务</li><li>支持外键</li><li><strong>支持崩溃后的安全恢复</strong></li><li><strong>不支持全文索引</strong></li></ul></li><li><p><strong>索引的实现</strong></p><p><strong><code>InnoDB</code></strong> 和 <strong><code>MyISAM</code></strong> 一样索引都是用的 <strong><code>B+Tree</code></strong> 作为索引的结构。 但是具体的实现不一样。</p><ul><li><p><strong>InnoDB的数据文件本身就是索引文件</strong></p><p>MyISAM索引文件和数据文件是分离的，索引文件仅保存数据记录的地址。而在InnoDB中，表数据文件本身就是按B+Tree组织的一个索引结构，这棵树的叶节点data域保存了完整的数据记录。这个索引的key是数据表的主键，因此InnoDB表数据文件本身就是主索引。</p><p><img src=https://box.kancloud.cn/2015-07-07_559b7873b514d.png alt=图></p><p>从上图可以看出叶子节点包含了完整的数据记录。这种索引叫做 <strong>聚集索引</strong> 。因为 <strong><code>InnoDB</code></strong> 的数据文件本身要按主键聚集，所以 <strong><code>InnoDB</code></strong> 要求表必须有主键（MyISAM可以没有）。所以在建表的过程中会要求我们选择一列作为主键。</p><p>第二个与MyISAM索引的不同是<strong>InnoDB的辅助索引data域存储相应记录主键的值而不是地址</strong> 。换句话说，InnoDB的所有辅助索引都引用主键作为data域。</p><p><img src=https://box.kancloud.cn/2015-07-07_559b7873ceaf1.png alt=图></p><p><strong>辅助索引搜索需要检索两遍索引：首先检索辅助索引获得主键，然后用主键到主索引中检索获得记录。</strong> 为什么不建议使用过长的字段作为主键：辅助索引都引用主索引，过长的主索引会令辅助索引变得过大。</p></li></ul></li></ul><p>参考：</p><ul><li><a href=https://www.kancloud.cn/kancloud/theory-of-mysql-index/41851>https://www.kancloud.cn/kancloud/theory-of-mysql-index/41851</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-b2fc20b51acddf5ec8ad59e51421b5c9>6.2.2.7 - MySQL的优化</h1><h3 id=1-mysql优化的三个方面>1. MySQL优化的三个方面</h3><ul><li><h4 id=索引优化>索引优化</h4></li><li><h4 id=表结构的优化>表结构的优化</h4></li><li><h4 id=sql慢查询的优化>SQL慢查询的优化</h4></li></ul><p><img src="https://github.com/mxsm/document/blob/master/image/database/MySQL%E7%9A%84%E4%BC%98%E5%8C%96%E4%B8%89%E4%B8%AA%E6%96%B9%E9%9D%A2.jpg?raw=true" alt=图></p><h3 id=2-索引优化>2. 索引优化</h3><h4 id=21什么是索引>2.1什么是索引</h4><p>索引：简单的说，相当于图书的目录，可以帮助用户快速的找到需要的内容。索引的目的在于提高查询效率，与我们查询图书所用的目录是一个道理：先定位到章，然后定位到该章下的一个小结，然后找到页数。相似的例子还有：查字典，查地图等。</p><h4 id=22-索引的类型>2.2 索引的类型</h4><ul><li><p><strong>普通索引</strong></p><pre><code>是最基本的索引，它没有任何限制。
</code></pre></li><li><p><strong>唯一索引</strong></p><pre><code>与前面的普通索引类似，不同的就是：索引列的值必须唯一，但允许有空值。如果是组合索引，则列值的组合必须唯一。
</code></pre></li><li><p><strong>组合索引</strong></p><pre><code>指多个字段上创建的索引，只有在查询条件中使用了创建索引时的第一个字段，索引才会被使用。
</code></pre></li><li><p><strong>主键索引</strong></p><pre><code>是一种特殊的唯一索引，一个表只能有一个主键，不允许有空值。一般是在建表的时候同时创建主键索引
</code></pre></li><li><p><strong>全文索引(InnoDB不支持)</strong></p><pre><code>主要用来查找文本中的关键字，而不是直接与索引中的值相比较。fulltext索引跟其它索引大不相同，它更像是一个搜
索引擎，而不是简单的where语句的参数匹配。fulltext索引配合match against操作使用，而不是一般的where语
句加like。它可以在create table，alter table ，create index使用，不过目前只有char、varchar，text
列上可以创建全文索引。值得一提的是，在数据量较大时候，现将数据放入一个没有全局索引的表中，然后再用CREATE 
index创建fulltext索引，要比先为一张表建立fulltext然后再将数据写入的速度快很多。
</code></pre></li></ul><h4 id=23-索引的优化>2.3 索引的优化</h4><ul><li>只要列中含有NULL值，就最好不要在此例设置索引，复合索引如果有NULL值，此列在使用时也不会使用索引。(所以在建表的过程中尽可能的不要有NULL的字段，设置相应的默认值)</li><li>尽量使用短索引，如果可以，应该制定一个前缀长度</li><li>对于经常在where子句使用的列，最好设置索引，这样会加快查找速度</li><li>对于有多个列where或者order by子句的，应该建立复合索引(这个应该是在开发后期页面展示的视图基本上确定了)</li><li>对于like语句，以%或者‘-’开头的不会使用索引，以%结尾会使用索引</li><li>尽量不要在列上进行运算（函数操作和表达式操作）(比如 <strong><code>from_unixtime(create_time) = ’2014-05-29’</code></strong> 这样的操作应该尽量避免，但是可以写成下面这样 <strong><code>create_time= unix_timestamp(’2014-05-29’)</code></strong>)</li><li>尽量不要使用not in和&lt;>操作</li></ul><h3 id=3-sql慢查询优化>3. SQL慢查询优化</h3><p>SQL慢查询优化的步骤：</p><p><img src="https://github.com/mxsm/document/blob/master/image/database/SQL%E6%85%A2%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96%E6%AD%A5%E9%AA%A4.jpg?raw=true" alt=图></p><h4 id=31-如何捕获低效sql>3.1 如何捕获低效SQL</h4><ul><li><p><strong>slow_query_log</strong></p><p>这个参数设置为ON，可以捕获执行时间超过一定数值的SQL语句。</p></li><li><p><strong>long_query_time</strong></p><p>当SQL语句执行时间超过此数值时，就会被记录到日志中，建议设置为1或者更短</p></li><li><p><strong>slow_query_log_file</strong></p><p>记录日志的文件名。</p></li><li><p><strong>log_queries_not_using_indexes</strong></p><p>这个参数设置为ON，可以捕获到所有未使用索引的SQL语句，尽管这个SQL语句有可能执行得挺快。</p></li></ul><h4 id=32-慢查询优化的基本步骤>3.2 慢查询优化的基本步骤</h4><ul><li><p><strong>先运行看看是否真的很慢，注意设置SQL_NO_CACHE</strong></p><p>SELECT SQL_NO_CACHE yz_id FROM dev_item_backlog WHERE yz_id NOT IN (&lsquo;xZeT3PHc&rsquo;,&lsquo;WcUVNWEq&rsquo;);</p></li><li><p><strong>where条件单表查，锁定最小返回记录表</strong></p><p>查询语句的where都应用到表中返回的记录数最小的表开始查起，单表每个字段分别查询，看哪个字段的区分度最高</p></li><li><p><strong>explain查看执行计划</strong></p></li><li><p><strong>order by limit 形式的sql语句让排序的表优先查</strong></p></li><li><p><strong>加索引时参照建索引的几大原则</strong></p></li></ul><h4 id=33-优化原则>3.3 优化原则</h4><ul><li>*<em>查询时，能不要 * 就不用 <em>，尽量写全字段名</em></em></li><li><strong>大部分情况连接效率远大于子查询换一句话说就是 少用子查询</strong></li><li><strong>多使用explain和profile分析查询语句</strong></li><li><strong>查看慢查询日志，找出执行时间长的sql语句优化</strong></li><li><strong>多表连接时，尽量小表驱动大表，即小表 join 大表</strong></li><li><strong>在千万级分页时使用limit</strong></li><li><strong>对于经常使用的查询，可以开启缓存</strong></li></ul><h3 id=4-数据库表的优化>4. 数据库表的优化</h3><ul><li><p><strong>表的字段尽可能用NOT NULL，或者是最好字段都不存在NULL。因为NULL不走索引。所以最好设置非NULL的默认值</strong></p></li><li><p><strong>将表拆分，垂直拆分或者水平拆分</strong></p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-660f64ff0579f3e10fffc1e77700b899>6.2.2.8 - MySQL主从复制原理</h1><h3 id=1-mysql的主从形式>1. MySQL的主从形式</h3><ul><li><p><strong>一主一从</strong></p><p><img src="https://github.com/mxsm/document/blob/master/image/database/%E4%B8%80%E4%B8%BB%E4%B8%80%E4%BB%8E.jpg?raw=true" alt=图></p></li><li><p><strong>一主多从</strong></p><p><img src="https://github.com/mxsm/document/blob/master/image/database/%E4%B8%80%E4%B8%BB%E5%A4%9A%E4%BB%8E.jpg?raw=true" alt=图></p><p>一主一从和一主多从是最常见的主从架构，实施起来简单并且有效，不仅可以实现HA，而且还能读写分离，进而提升集群的并发能力。</p></li><li><p><strong>多主一从(5.7开始支持)</strong></p><p><img src="https://github.com/mxsm/document/blob/master/image/database/%E5%A4%9A%E4%B8%BB%E4%B8%80%E4%BB%8E.jpg?raw=true" alt=图></p><p>多主一从可以将多个mysql数据库备份到一台存储性能比较好的服务器上</p></li><li><p><strong>双主复制</strong></p><p><img src="https://github.com/mxsm/document/blob/master/image/database/%E5%8F%8C%E4%B8%BB%E5%A4%8D%E5%88%B6.jpg?raw=true" alt=图></p><p>双主复制，也就是互做主从复制，每个master既是master，又是另外一台服务器的slave。这样任何一方所做的变更，都会通过复制应用到另外一方的数据库中。</p></li><li><p><strong>级联复制</strong></p><p><img src="https://github.com/mxsm/document/blob/master/image/database/%E7%BA%A7%E8%81%94%E5%A4%8D%E5%88%B6.jpg?raw=true" alt=图></p><p>级联复制模式下，部分slave的数据同步不连接主节点，而是连接从节点。因为如果主节点有太多的从节点，就会损耗一部分性能用于replication，其它从节点作为二级或者三级与从节点连接，好处：<strong>缓解主节点的压力，并且对数据一致性没有负面影响。</strong></p></li></ul><h3 id=2-主从复制的原理>2. 主从复制的原理</h3><p><img src="https://github.com/mxsm/document/blob/master/image/database/masterslave%E5%8E%9F%E7%90%86%E5%9B%BE.jpg?raw=true" alt=图></p><ul><li>当从节点连接主节点时，主节点会创建一个log dump 线程，用于发送bin-log的内容。在读取bin-log中的操作时，此线程会对主节点上的bin-log加锁，当读取完成，甚至在发动给从节点之前，锁会被释放。</li><li>当从节点上执行<code>start slave</code>命令之后，从节点会创建一个I/O线程用来连接主节点，请求主库中更新的bin-log。I/O线程接收到主节点binlog dump 进程发来的更新之后，保存在本地relay-log中。(这个线程不会对事件进行轮询。如果该线程追赶上了主库，他将进入睡眠状态，知道主库发送信号量通知其有新的事件产生时才会被唤醒)</li><li>SQL线程负责读取relay log中的内容，解析成具体的操作并执行，最终保证主从数据的一致性。</li></ul><blockquote><ol><li>在主库上把数据更改记录到二进制日志(Binary Log)中。</li><li>备库将主库上的日志复制到自己的中继日志(Relay Log)中</li><li>备库读取中继日志中的实践，将其重放到备库数据之上</li></ol></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-58acaf13a33c364a05ead30153e63893>6.2.3 - Mysql笔记</h1></div><div class=td-content><h1 id=pg-cc4197811e43cf5e0c00c83a8556def1>6.2.3.1 - Mysql索引</h1></div><div class=td-content><h1 id=pg-8e3beb10f5e6095a25721e0b7bbc998c>6.2.3.1.1 - 高性能索引策略</h1><p><strong>从索引的角度来提高数据库速度</strong></p><h3 id=1-独立的列>1. 独立的列</h3><p>如果查询过程中不是独立的列，则Mysql就不能使用索引。<strong>独立的列是指索引列不能是表达式的一部分，也不能是函数的参数。</strong> 始终将索引列单独放在比较符的一侧。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>actor_id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>actor</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>actor_id</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>上面的SQL就不能使用到索引。这种情况应该避免！</p><h3 id=2-前缀索引和索引的选择>2. 前缀索引和索引的选择</h3><p>有时候需要索引很长的字符列，这会让索引变得大而且慢！<strong>通过Hash索引可以解决这个问题</strong>，但是有时候这样做还不够。可以从以下方面来着手：</p><ul><li><p><strong>索引开始的部分字符串</strong></p><p><strong>优点：大大的节约索引的空间，提高索引的效率。但这样也会降低索引的选择性。</strong></p><blockquote><p><strong>什么是索引的选择性？</strong></p><p>不重复的索引值（也叫做基数）和表中纪录总数(#T)的比值，范围从1/#T ~ 1 之间。</p><p>索引的选择性越高则查询效率越高，因为选择性高的索引能够过滤掉更多的行。唯一索引的选择性为1，这是最好的索引选择性，性能也最好。</p></blockquote><p>一般情况下某个列前缀的选择性也是足够高的，<strong>足够满足性能查询。对于BLOB、和TEXT或者很长的varchar。必须使用前缀索引。</strong> 因为MySQL不允许索引这些列的完整长度。</p><blockquote><p><strong>使用诀窍：</strong></p><p>选择足够长的前缀以保证较高的选择性，同时又不能太长(节约空间)。前缀足够长，以使得前缀索引的选择性接近于索引整个列。（索引前缀的基数接近于完整列的基数）</p></blockquote><p>如何选择合适的长度演示：</p><p>比如我要查询city使用前缀值为多少比较合适？</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#8f5902;font-style:italic>--获取city的选择性
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>COUNT</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>DISTINCT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>city</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>COUNT</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>city_demo</span><span style=color:#f8f8f8;text-decoration:underline> 
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>--获取不同前缀的选择性
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> 
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>COUNT</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>DISTINCT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>LEFT</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>city</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>))</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>COUNT</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>a1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>COUNT</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>DISTINCT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>LEFT</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>city</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>))</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>COUNT</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>a2</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>COUNT</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>DISTINCT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>LEFT</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>city</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>))</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>COUNT</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>a3</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>COUNT</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>DISTINCT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>LEFT</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>city</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#000;font-weight:700>))</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>COUNT</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>a4</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>city_demo</span><span style=color:#f8f8f8;text-decoration:underline> 
</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>通过对比找出和第一个sql语句最接近的数值(当然可能长度还更长)。假如是LEFT(city，5)这个就已经已经接近了。那么创建前缀索引：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#000>mysql</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>city_demo</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ADD</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctiy</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#000;font-weight:700>));</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>缺点：无法使用前缀索引做Order By和Group By，同样也无法使用前缀索引做覆盖扫描。</p></li></ul><h3 id=3-多列索引>3. 多列索引</h3><p>对于索引来看一下下面的通常的做法：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>vet_friend</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>bigint</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>unsigned</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AUTO_INCREMENT</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>user_id</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>bigint</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>COMMENT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;用户Id&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>friend_id</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>bigint</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>COMMENT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;朋友的Id&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>friend_ship</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tinyint</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;0&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>COMMENT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;状态 0-待同意 1-已同意 2-已拒绝&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>gmt_created</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>timestamp</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>CURRENT_TIMESTAMP</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>gmt_modified</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>timestamp</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>CURRENT_TIMESTAMP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>UPDATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>CURRENT_TIMESTAMP</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>PRIMARY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>idx_left_id</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>user_id</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>idx_right_id</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>friend_id</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ENGINE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>InnoDB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CHARSET</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>utf8mb4</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>COMMENT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;好友表&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>在多个列上面单独建立索引大部分情况并不能提高MySQL的查询效率(通过下面的执行计划)</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>EXPLAIN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>vet_activity</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gmt_created</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>date_format</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;2019-03-25 15:40:07&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;%Y%m%d%H%i%s&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> 
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>EXPLAIN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>vet_activity</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gmt_created</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>date_format</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;2019-03-25 15:40:07&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;%Y%m%d%H%i%s&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>organization</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;organization&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>通过查看执行计划：</p><pre><code>+----+-------------+--------------+------+------------------+------+---------+------+------+-------------+
| id | select_type | table        | type | possible_keys    | key  | key_len | ref  | rows | Extra       |
+----+-------------+--------------+------+------------------+------+---------+------+------+-------------+
|  1 | SIMPLE      | vet_activity | ALL  | gmtCreated_index | NULL | NULL    | NULL |   32 | Using where |
+----+-------------+--------------+------+------------------+------+---------+------+------+-------------+

+----+-------------+--------------+------+-------------------------------------+--------------------+---------+-------+------+------------------------------------+
| id | select_type | table        | type | possible_keys                       | key                | key_len | ref   | rows | Extra                              |
+----+-------------+--------------+------+-------------------------------------+--------------------+---------+-------+------+------------------------------------+
|  1 | SIMPLE      | vet_activity | ref  | gmtCreated_index,organization_index | organization_index | 131     | const |    1 | Using index condition; Using where |
+----+-------------+--------------+------+-------------------------------------+--------------------+---------+-------+------+------------------------------------+
</code></pre><p>在某些情况下没有一个单独索引是非常有效的比如下面的这个SQL语句：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>film_id</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>actor_id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>film_actor</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>actor_id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>or</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>film_id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>如果在EXPLAIN中看到有索引合并的情况，最好检查一下查询和表结构。</p><h3 id=4-选择合适的索引顺序>4. 选择合适的索引顺序</h3><p>正确的索引顺序依赖于使用索引的查询，并且同时需要考虑如何更好的满足排序和分组的需要，(适用于BTree索引，hash不会想B-Tree那样按照顺序存储)。</p><p><strong>如何选择索引的列顺序有一个法则经验：将选择性搞的列放在索引的最前列。</strong> (不是说在建表语句中谁在前面就放在前面)。</p><p>当不需要考虑排序和分组的时候，选择性高的列放在前面通常很好 —— 索引的作用只是用于优化WHERE后面的条件查找，这样索引能够快速的过滤出来所需要的行，对于WHERE子句中只使用了索引的部分前缀列的查询来说选择性也更加高。</p><p>例子：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>payment</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>staff_id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>and</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>customer_id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>548</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>这个应该怎么创建索引呢？ (staff_id,customer_id) 还是颠倒过来。通常的方法如下：</p><ul><li><p><strong>根据业务判断哪个字段的选择性搞就把那个字段放在前面</strong></p></li><li><p><strong>运行一段时间后用SQL进行统计</strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>DISTINCT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>staff_id</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>a1</span><span style=color:#000;font-weight:700>,</span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>DISTINCT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>customer_id</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>a2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>payment</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></code></pre></div><p>将选择性高的列放在前面，但是对于一些特殊的用户这个需要注意。</p></li></ul><h3 id=5-聚簇索引>5. 聚簇索引</h3><p><strong>什么是聚簇索引？</strong></p><p><strong>聚簇索引并不是一种单独的索引类型，二手一种数据存储方式。具体依赖存储引擎的实现方式，InnoDB的聚簇索引实际上在同一个结构中保存了B-Tree索引和数据行。当表有聚簇索引的时候，他的数据行实际上存放在索爷的叶子节点(无法同时吧数据行存放在不停的地方，所以一个表只能有一个聚簇索引)</strong></p><p><img src="https://github.com/mxsm/document/blob/master/image/database/%E9%AB%98%E6%80%A7%E8%83%BDMysql%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/%E7%B4%A2%E5%BC%95/mysqBTree%E7%B4%A2%E5%BC%95%E6%95%B0%E6%8D%AE%E8%AF%B4%E6%98%8E.JPG?raw=true" alt=图></p><p>上图展示了InnoDB聚簇索引的存储。</p><p>MySQL的InnoDB是通过主键聚集数据。</p><p><strong>聚簇索引的优点：</strong></p><ul><li><strong>把相关数据保存在一起，提高了I/O的性能</strong></li><li><strong>数据访问更快。聚簇索引将索引 和数据保存在同一个B-Tree中，因此从聚簇索引中获取数据通常比在非聚簇索引快</strong></li><li><strong>使用覆盖索引扫描的查询可以直接使用页节点中的主键值</strong></li></ul><p><strong>缺点：</strong></p><ul><li><p><strong>聚簇数据提高了I/O密集型应用的性能，但是如果放在内存中聚簇索引就没有什么优势了</strong></p></li><li><p><strong>插入速度严重依赖插入顺序</strong></p><p>按照主键的顺序插入是加载数据到InnoDB表中速度最快的方式。如果不睡按照主键顺序加载数据，那么最好加载完成后使用 <strong><code>OPTIMIZE TABLE</code></strong> 命令重新组织一下表。</p></li><li><p><strong>更新聚簇索引的代价很高</strong></p><p>因为会强制InnoDB将每个被更新的行移动到新的位置。</p></li><li><p><strong>基于聚簇索引的表插入新，或者主键被更新导致需要移动的时候，可能面临"页分裂"的问题</strong></p><p>当行的主键值要求必须将这一行插入到某个已满的页中时，存储引擎会将该页分裂成两个页面来容纳该行。这就是一场页分裂操作。页分裂会导致表占用更多的磁盘空间。</p></li><li><p><strong>聚簇索引可能导致全表扫描变慢，尤其是行比较稀疏，或者由于页分裂导致数据存储不连续的时候</strong></p></li><li><p><strong>二级索引(非聚簇索引)可能比想象的要更大，因为在二级索引的叶子节点包含了引用的主键列</strong></p></li><li><p><strong>二级索引访问需要两次索引查找，而不是一次</strong></p><p><strong><code>InnoDB的二级索引和聚簇索引很不相同。InnoDB二级索引的叶子节点存储的不是行指针，而是主键值。并以此作为行指针。好处就是减少行移动或者行数据页分裂时二级索引的维护工作。使用主键值当做指针会让二级索引占用更多的空间，好处就是InnoDB移动行无须更新二级索引中的这个指针</code></strong></p></li></ul><p><strong>插入乱序数据聚簇索引的缺点：</strong></p><p>插入过程中新的聚簇索引(InnoDB表的主键)，主键值不应定比之前插入的大，索引InnoDB无法简单的总是把新的行插入到索引的最后，而是需要为新的行寻找合适的位置 — 通常是已有的数据的中间位置 —— 并且分配空间。增加了额外的工作，并且导致舒服分布不够优化。</p><ul><li>写入的目标页可能已经刷到磁盘上并从缓存中移除，或者是还没有被加载到缓存中。InnoDB在插入之前不得不现在到并且从实盘读取目标页到内存中。则将导致大量的随机I/O。</li><li>因为写入乱序，InnoDB不得不频繁的做页的分裂操作，以便为新的行分配空间。页分配会导致移动大量的数据。一次插入至少要修改三个页而不是一个页。</li><li>由于频繁的页分裂，页会变得稀疏并被不规则的填充，索引最终数据会碎片。</li></ul><blockquote><p><strong>顺序的主键什么时候会造成更坏的结果？</strong></p><p>对于高并发的工作负荷，在InnoDB中按主键顺序插入可能会造成很明显的争用。主键的上界会成为"热点"，因为所有的插入都发生在这里，所以并发插入可能导致间隙锁竞争。另一个热点可能是AUTO_INCREMENT锁机制。</p><p>解决方式：可能需要考虑重新设计表或者应用，或者更改innodb_autoinc_lock_mode配置。</p></blockquote><h3 id=6-覆盖索引>6. 覆盖索引</h3><blockquote><p><strong>什么是覆盖索引？</strong></p><p>一个索引包含(或者覆盖)所有需要查询的字段的值</p></blockquote><p><strong>覆盖索引的好处：</strong></p><ul><li>索引条目通常远少于数据行大小，所以如果只需要读取索引，那MySQL就会极大的减少数据访问量。</li><li>索引按照列值顺序存储的，所以对于I/O密集型的范围查询会比随机从磁盘读取每一行数据的I/O要少得多。</li><li>由于InnoDB的聚簇索引，覆盖索引对InnoDB表特别有用。InnoDB的二级索引在叶子节点中保存了行的主键值。所以如果二级主键能够覆盖查询，则可以避免对主键索引的二次查询。</li></ul><p>不是所有类型的索引都可以成为覆盖索引。覆盖索引必须要存储索引列的值。而哈希索引，空间索引，和全文索引等等都不存储索引列的值。</p><blockquote><p>在 EXPLAIN的Extra列可以看到"Using index"的信息说明使用了覆盖索引。</p></blockquote><p>看一个不能使用覆盖索引的SQL：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>products</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>actor</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;sendaaa&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>and</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>title</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>like</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;%APPOLLO%&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>无法使用索引的两个原因：</p><ul><li>没有任何索引能够覆盖这个查询。— 查询了所有的列。而没有任何索引覆盖了所有的列。</li><li>MySQL不能在索引中执行LIKE操作。</li></ul><h3 id=7-使用索引扫描来做排序>7. 使用索引扫描来做排序</h3><p>MySQL有两种方式可以生成有序的结果：</p><ul><li><p>排序操作</p></li><li><p>索引顺序扫描</p><p>EXPLAIN出来的type列的值为"index"，则说明MySQL使用了索引扫描来排序。</p></li></ul><p>只有当索引的列顺序和ORDER BY子句的顺序完全一致，并且所有列的排序反方向(倒序或者正序)都一样时，MySQL才能够使用索引来对结果做排序。如果查询需要关联多张表，则只有当ORDER BY 子句引用的字段全部为第一个表时，才能使用索引做排序。 ORDER BY 子句和查找类型查询的限制是一样的，需要满足索引的最左前缀的要求。</p><h3 id=8-冗余索引和重复索引>8. 冗余索引和重复索引</h3><p><strong>重复索引：相同的列上面按照相同的顺序创建的相同类型的索引。</strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>ID</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>int</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>not</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>null</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>primary</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>a</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>int</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>not</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>null</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>UNIQUE</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ID</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#000>engine</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>Innodb</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>上面就是创建了重复索引。</p><p><strong>冗余索引：一个索引包含了另一个索引的</strong></p><p>例如创建索引(A,B) 如果在创建索引(A)就是冗余索引，因为(A,B)索引相当有(A) (A,B)两个索引，(A)索引是(A,B)索引的前缀。</p><blockquote><p>表中的索引越多会导致INSERT、UPDATE、DELETE等操作速度越来越慢，特别是当新增索引后导致达到了内存瓶颈的时候。</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-169bd172f308a0a4c3a457df80a89b63>6.2.3.1.2 - 索引的类型</h1><p><strong>从索引的角度来提高数据库速度</strong></p><h3 id=1-索引的类型>1. 索引的类型</h3><p>索引的类型多种多样，MySQL索引在<strong>存储层实现</strong>而<strong>不是服务器层实现</strong>。不同的存储引擎索引的工作方式也不一样。</p><ul><li><p><strong>B-Tree索引</strong></p><p>使用**<code>B-Tre</code>**e数据结构来存储数据。**<code>InnoDB</code>** 则使用的 **<code>B+Tree</code>** 来做的实现。**<code>B-Tree</code>** 索引的特点：</p><ul><li><p>值都是按顺序存储</p><p><img src="https://github.com/mxsm/document/blob/master/image/database/%E9%AB%98%E6%80%A7%E8%83%BDMysql%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/%E7%B4%A2%E5%BC%95/BTreeMysql%E5%9B%BE%E8%A7%A3.png?raw=true" alt=图></p></li><li><p>叶子节点指针指向的是被索引的数据(<strong>InnoDB指向的行数据，MyISAM指向的是数据的物理地址</strong>)，而不是其他的叶子节点页</p></li><li><p>B-Tree对索引列是顺序组织存储的。所以适合查找范围的数据(对于Hash索引比较适合精确的查找)</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>People</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>last_name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>varchar</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>not</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>null</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>first_name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>varchar</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>not</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>null</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>dob</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87>date</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>not</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>null</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>gender</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>enum</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;m&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;f&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>not</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>null</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>last_name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>first_name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>dob</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p><img src="https://github.com/mxsm/document/blob/master/image/database/%E9%AB%98%E6%80%A7%E8%83%BDMysql%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/%E7%B4%A2%E5%BC%95/mysqBTree%E7%B4%A2%E5%BC%95%E6%95%B0%E6%8D%AE%E8%AF%B4%E6%98%8E.JPG?raw=true" alt=图></p><p><strong>B-Tree适合全键值、键值范围、键前缀查找，其中键前缀查找只适用于根据最左前缀查找。</strong></p><p>上述的索引对如下类型查找有效：</p><ul><li><p><strong>全值匹配</strong></p><p>和索引中所有的列进行匹配</p></li><li><p><strong>匹配最左前缀</strong></p></li><li><p><strong>匹配列前缀</strong></p><p>比如查找 last_name 为 J开头的 &lsquo;j%&rsquo;</p></li><li><p><strong>匹配范围值</strong></p></li><li><p><strong>精确匹配某一列并范围匹配另外一列</strong></p></li><li><p><strong>只访问索引的查询&ndash;覆盖查询</strong></p></li></ul><p>B-Tree索引的限制：</p><ul><li><p><strong>如果不是按照索引的最左端列开始查找，则无法使用索引。</strong></p><p>也就是必须包含last_name在查询的条件中</p></li><li><p><strong>不能跳过索引中的列</strong></p><p>也就是如果包含 last_name 和 date 那只能使用 last_name这个索引</p></li><li><p><strong>如果查询中有某个列的范围查询，则其右边所有的列都无法使用索引优化查找。</strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>last_name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;aaaa&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>and</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>first_name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>like</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;j%&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>and</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>job</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;2001-02-03&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>只有前面两个列可以用到索引</p></li></ul><p>这些索引都和索引的顺序有关。优化的时候需要使用相同的列但是顺序不同的索引来满足不同类型的查询需要。</p></li></ul></li><li><p><strong>哈希索引</strong></p><p>hash索引是基于哈希表实现。只有精确匹配索引所有的列查询才有效。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>testhash</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>fname</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>VARCHAR</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>lname</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>VARCHAR</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>USING</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HASH</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>fname</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ENGINE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>MEMORY</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>假如使用f()哈希函数</p><pre><code>f('Arjen') = 2323

f('Baron') = 7437

f('Peter') = 8784

f('Vadim') = 2458
</code></pre><p>索引只存储了对应的哈希值，hash索引结构非常紧凑，这让hash索引查找非常快。</p><p><strong>hash索引使用的限制：</strong></p><ul><li><p><strong>hash索引只包含哈希值和行指针，而不存储字段值。所以不存在覆盖索引的说法</strong></p></li><li><p><strong>hash索引数据并不是按照索引值顺序存储，所以无法用于排序</strong></p></li><li><p><strong>hash索引不支持部分索引列匹配查找</strong></p><p>因为hash索引始终使用的索引的内的全部列进行hash。在数据列（A,B）上建立hash索引，如果只使用A或者B是不能使用索引的。</p></li><li><p><strong>hash索引只支持等值比较查询，不支持任何范围查询</strong></p><p>支持 = 、IN()，不支持 where a > 10</p></li><li><p><strong>访问hash索引的速度非常快，除非有很大的hash冲突</strong></p></li><li><p><strong>如果hash冲突很多的，一些索引维护操作代价也很高</strong></p></li></ul></li></ul><p><strong>B-Tree索引的优点：</strong></p><ul><li>索引大大减少了服务器需要扫描的数据数量</li><li>索引可以帮助服务器避免排序和临时表</li><li>索引可以将随机I/O变为顺序I/O</li></ul><blockquote><p>索引的局限性？</p><p>索引并不总是最好的选择，评判标准：只有当索引帮助存储引擎快速找到纪录的好处大于其他的额外工作的开销(插入重建索引)索引才是有效的。</p><p>对于小表来说，简单的全表扫描更加高效。对于中到大型的表，索引就非常有效。对于特大型表，建立和使用索引的代价随之增长。</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-f9260c175af181cb07ecd7cb084b6b9f>6.2.3.2 - Schema与数据类型优化</h1><p>从建表的角度来对提高数据库性能进行优化</p><h3 id=1-选择优化的数据类型>1. 选择优化的数据类型</h3><p>数据类型优化的原则：</p><ul><li><p><strong>更小的通常更好</strong></p><p>尽量的使用可以正确存储数据的最小数据类型（<strong>例如存0-200,tinyint</strong>）。更小的数据类型通常更快 &mdash; <strong>占用更少的磁盘，内存，CPU缓存，并且处理时需要的CPU周期更少。</strong></p></li><li><p><strong>简单就好</strong></p><p>简单的数据类型的操作通常需要更少的CPU周期。整形比字符串操作代价更加低。因为字符集的排序规则比整型更加复杂。下面有两个例子：</p><ul><li><p>储存日期和时间应该使用MySQL內建的类型如：<strong><code>data time datatime</code></strong> 而不是用字符串来存储。</p></li><li><p>用整数来存储IP地址</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=color:#000>mysql</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>inet_aton</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;192.168.0.1&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>+--------------------------+</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>inet_aton</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;192.168.0.1&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>+--------------------------+</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#0000cf;font-weight:700>3232235521</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>+--------------------------+</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=color:#000>mysql</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>inet_ntoa</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3232235521</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>+-----------------------+</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>inet_ntoa</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3232235521</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>+-----------------------+</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>192</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>168</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>+-----------------------+</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>通过函数来转换存储。</p></li></ul></li><li><p><strong>尽量避免NULL</strong></p><p>通常情况下NULL是列的默认属性，但是通常情况下最好指定为<strong>Not NULL</strong>。除非真的需要存储<strong>NULL</strong>值。&mdash;-对于包含NULL的列，使得索引、索引统计、和值比较都更加复杂。可为NULL的列会使用更多的存储空间，MySQL中也需要特殊处理。当可为NULL的列被索引时，每个索引纪录需要一个额外的字节。</p><p>所以在要建立索引的字段上尽量避免设计成为NULL的列。</p></li></ul><h3 id=2-整数类型>2. 整数类型</h3><ul><li><p><strong>整数</strong></p><ul><li><p><strong>TINYINT</strong></p><p>存储空间位数：8</p></li><li><p><strong>SMALLINT</strong></p><p>存储空间位数：16</p></li><li><p><strong>MEDIUMINT</strong></p><p>存储空间位数：24</p></li><li><p><strong>INT</strong></p><p>存储空间位数：32</p></li><li><p><strong>BIGINT</strong></p><p>存储空间位数：64</p></li></ul><p>整数类型可以选择UNSIGNED属性，表示不允许负数。无符号和有符号的存储空间一样，具有相同的性能。</p><p><strong>整数类型指定宽度例如INT(11)，对于大多数引用来说没有意义。不会限制合法值的范围。对于储存和计算来说INT(1)和INT(11)都是一样的</strong></p></li><li><p><strong>实数</strong></p><p>实数是带有小数部分的数字。然而不只是为了存储小数部分；也可以使用DECIMAL存储比BIGINT还大的整数。float比DECIMAL更加快。原因是CPU支持浮点数运算而不支持DECIMAL运算。</p></li></ul><h3 id=3-字符串类型>3. 字符串类型</h3><ul><li><p><strong>可变长度 <code>varchar</code></strong></p><p>比定长更加节省空间，因为他是按需分配。例外情况&mdash;Mysql表使用ROW_FORMAT=FIXED创建的话，每一行都会使用定长存储。</p><p><strong><code>varchar</code></strong> 会使用1或2个额外的字节来纪录字符串的长度：长度小于等于255字节，则使用一个字节，如果大于255小于等于65535 则使用两个字节(PS：这里可以看出来varchar的最大值65535，因为至多只有两个字段来纪录大小)。</p><p><strong><code>varchar</code></strong> 的好处就是节省空间。能够提高性能，但是同样的由于是变长在更新(<strong>UPDATE</strong>)时候可能使行变得更加长。如果一个行占用的空间增长，并且页内没有更多的空间可以存储，在这种情况下不同的引擎处理的方式不一样，InnoDB需要分裂页来使得行可以放到页内。</p></li><li><p><strong>固定长度 <code>char</code></strong></p><p>char是固定长度，根据定义的长度分配足够的空间。当存储char值时MySQL会去除掉后面的空字符串。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>chartest</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39; char1 &#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CONCAT</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>char_col</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>chartest</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>char_col</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39; char1 &#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>如上两条语句查询出来的数据是去除了char1后面的空字符。查询的时候也可以去除后面空字符也能查询出来。</p><p>char比较适合存储一些比<strong>较短或者定长</strong>的字符串。比如MD5。对于经常变更的数据，char也比varchar好。定长的char不容易产生碎片。 对于非常短的列，char比varchar在存储空间上也更有效率。</p><blockquote><p>使用VARCHAR(5)和VARCHAR(200)存储 hello 的空间开销是一样的。那么使用更短的列有什么优势？</p><p>更长的列会消耗更多的内存，因为MySQL通常会分配固定大小的内存块来保存内部的值。尤其是使用内存临时表时表进行排序或者操作时会特别糟糕。在利用磁盘临时表进行排序时也同样的糟糕。
所以最好的策略就是只分配正则需要的空间，用多少分配多少，估算当前列的最大值。这个也符合数据库的优化。更小的通常更好</p></blockquote></li></ul><h3 id=4-blob和text类型>4. BLOB和TEXT类型</h3><p>这两个类型都是为了存储很大的数据设计的，分别采用二进制和字符串方式存储。MySQL把每一BLOB和TEXT值当做一个独立的对象处理。存储引擎通常会做特殊处理。当BLOB和TEXT值太大时，InnoDB会使用专门的<strong>外部</strong>存储区域来进行存储，此时每一个值在行内需要1~4个直接存储一个指针，然后外部存储区域存储实际的值。</p><p>MySQL对BLOB和TEXT列进行白鞋与其他类型是不同的。<strong>只对每个列的最前max_sort_length字节而不是整个字符串做排序，可以通过配置max_sort_length的配置设置</strong></p><blockquote><p>磁盘临时表和文件排序</p><p>尽可能的避免使用BLOB和TEXT类型。如果实在无法避免，有一个技巧就是在说用到的BLOB字段的地方都使用SUBSTRING(column,length)将列值转换为字符串(在order by中也适用)，这样就能用到内存临时表了，但是要确保截取的子字符串足够短。不会使临时表的大小超过max_heap_table_size或tmp_table_size,超过以后会会将内存临时表转换为MyISAM磁盘临时表。</p><p>如果EXPLAIN执行计划的Extra列包含"Using temporary",这说明这个查询使用了隐私临时表</p></blockquote><h3 id=5-使用枚举enum代替字符串类型>5. 使用枚举(ENUM)代替字符串类型</h3><p>有时候可以使用枚举代替常用的字符类型(种类固定不会轻易改动：例如性别，开关，订单状态等等)。枚举在MySQL内部的存储枚举非常紧凑。会根据值的数量压缩到一个或者两个字节。(尽量避免使用数字来作为枚举，双重性很容易导致混乱)</p><p>枚举的不好之处：字符串列表都是固定的，添加或者删除字符串都必须使用alter table。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>alter</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>enum_test</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>modify</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>column</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>enum</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;dog&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;cat&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;ant&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;fish&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><blockquote><p>在遇到关联查询的时候，最好是同一类型的数据进行关联，这样能提高查询速度。如果是不同的数据进行关联可能会造成比较慢的情况。测试发现ENUM和VARCHAR关联比VARCHAR和VARCHAR关联慢。整数之间的关联速度更快，把一些列转换成ENUM可以缩减表的大小，如果是联合主键会降低主键的大小，同时会降低二级索引的整个大小。</p></blockquote><h3 id=6-日期和时间类型>6. 日期和时间类型</h3><p>MySQL可以使用许多类型来保存日期和时间值，例如YEAR和DATE。MySQL能存储的最小时间粒度为秒。</p><ul><li><p><strong>DATETIME</strong></p><p>用8个直接存储，与时区无关。</p></li><li><p><strong>TIMESTAMP</strong></p></li></ul><p>​ 保存了从1970年格林尼治时间以来的秒数。用4个字节的存储空间，范围比DATETIME小的多。</p><h3 id=7--特殊的类型数据>7. 特殊的类型数据</h3><p>某些类型的数据并不直接与内置的数据一样。低于秒级精度时间。</p><p>IP的例子，在数据可以用无符号的32位整数进行存储。MySQL提供INET_ATON()和INET_NTOA()函数之间转换。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-6d24780045a900a31f9e66f2c7385438>6.2.3.3 - 查询性能优化</h1><h3 id=慢查询的基础优化数据访问>慢查询的基础：优化数据访问</h3><p>查询性能低下最基本的原因就是查询数据太多。对于低下的查询我们通过下面两个步骤来分析：</p><ul><li><p><strong>确认应用程序是否在检索超过需要的数据。这通常意味着访问了太多的行，但有时候也可能是访问了太多的列。</strong></p><p>有些查询会请求超过实际需要的数据，然后这些多余的数据会被引用程序丢弃。这会给MySQL服务器带来额外的负担，并且增加网络的开销。也会消耗掉服务器的CPU和内存资源。</p><blockquote><p>1 查询不需要的记录</p><p>2 多表关联时返回全部列</p><p>3 总数取出全部的列 如 select *</p><p>4 重复查询相同的数据</p></blockquote></li><li><p><strong>确认MySQL服务器层是否在分析大量超过需要的行数据</strong></p><p>查询开销的三个指标如下：</p><ul><li>响应时间</li><li>扫描的行数</li><li>返回的行数</li></ul></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-20551a8a7882f1a25eee5d247ec0ab3b>6.2.4 - InnoDB存储引擎</h1></div><div class=td-content><h1 id=pg-f2a0a8e4eafd129919af5c5528379592>6.2.4.1 - mysql innodb 索引</h1><h3 id=innodb存储引擎索引>Innodb存储引擎索引</h3><ul><li>B+树索引</li><li>全文索引</li><li>Hash索引</li></ul><h3 id=b树索引>B+树索引</h3><p>B+树索引就是传统意义上的索引，这是目前关系型数据库中查找最为常用和最为有效的索引。B+树索引的构造类似于二叉树，根据键值快速找到数据。</p><blockquote><p>B+树中的B不是代表二叉，而是代表平衡。 B+树索引不能找到一个给定键值的具体行。B+树索引能找到的只是被查找数据行所在的页。然后数据库通过把页读入内存，再在内存中进行查找，最后得到要查找的数据。</p></blockquote><h3 id=b树数据结构>B+树数据结构</h3><h3 id=b树索引-1>B+树索引</h3><p>B+树索引本质就是B+树在数据库中的实现。但是B+树索引在数据库中有一个特点是高扇出性。一般数据库中，B+树的高度一般都在2-4层。也就是说查找某个键值的行记录时最多需要2到4次IO。<br>索引的分类：</p><ul><li>聚集索引</li><li>辅助索引<br>不管是聚集索引还是辅助索引，内部都是B+树，也就是高度平衡，叶子节点存放着数据。不同的是:叶子节点存放的是否是一整行的信息数据。</li></ul><h3 id=聚集索引>聚集索引</h3><p>InnoDB存储引擎表是索引组织表，表中数据按照主键顺序存放。聚集索引就是按照每张表的主键构造一颗B+树，同时叶子节点中存放的即为整张表的行记录数据，聚集索引的这个特性决定了组织表中数据也是索引的一部分。同B+树数据结构一样。每个数据也通过一个双向链表来进行连接。</p><blockquote><p>每张表只能拥有一个聚集索引(主键只能一个)</p></blockquote><h4 id=聚集索引的好处>聚集索引的好处</h4><ol><li>由于定义了数据的逻辑顺序，聚集索引能够特别快的方位针对范围值的查询</li><li>主键的排序查找和范围查找速度特别快。</li></ol><h3 id=辅助索引>辅助索引</h3><p>叶子节点不包含行记录的全部数据。叶子节点除了包含键值以外每个叶子节点的索引中还包含了一个书签，该书签用来告诉InnoDB哪里可以找到与索引相对应的行数据。</p><blockquote><p>由于InnoDB表是索引组织表，因此InnoDB辅助索引的书签就是相对应行数据的聚集索引键</p></blockquote><p><img src="https://github.com/mxsm/picture/blob/main/mysql/%E8%BE%85%E5%8A%A9%E7%B4%A2%E5%BC%95%E5%92%8C%E8%81%9A%E9%9B%86%E7%B4%A2%E5%BC%95%E7%9A%84%E5%85%B3%E7%B3%BB.png?raw=true" alt=辅助索引与聚集索引的关系></p><p>辅助索引的存在并不影响数据在聚集索引中的组织，因此每张表上可以有多个辅助索引。通过辅助索引来查找数据时，InnoDB存储引擎会遍历辅助索引并通过叶级别的指针获取指向主键索引的主键键值，然后通过主键索引来找到完整的行记录。<br>例如：一棵高度为3的辅助索引树中查找数据，那么需要对这颗树遍历3次找到指定主键键值。如果聚集索引同样高度为3，那么对聚集索引树进行3次查找，最终找到文字的数据所在页，因此一共需要6次逻辑IO访问得到最终的一个数据页。</p><h3 id=hash索引>Hash索引</h3><p>InnoDB存储引擎使用哈希算法来对字典来进行查找，其冲突机制采用链表方式，哈希函数采用除法散列方式。</p><h3 id=全文检索>全文检索</h3><p>全文检索通过使用倒排索引来实现。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-a1aea873df1c160d23c82c62337e6eaf>6.2.4.2 - mysql引擎InnoDB索引中的cardinality关键字</h1><h3 id=什么是cardinality>什么是Cardinality</h3><p>cardinality用来统计字段的可选择性。例如：<br>类似于姓名字段，表中都不相同的，属于高选择性，适用于添加索引<br>类似于性别字段，只有男，女的，属于低选择性，则不适用于添加索引</p><blockquote><p>在一定基数下重复少的字段选择性就高，重复数多选择性就低。</p></blockquote><h3 id=innodb存储引擎cardinality统计>InnoDB存储引擎Cardinality统计</h3><p>cardinality值消耗是非常大的，InnoDB一般选择在下边两种情况更新cardinality信息：</p><ul><li>表中数据1/16数据发生变化</li><li>stat_modified_counter>2,000,000,000</li></ul><p>第一种策略为自从上次统计Cardinality信息后，表中1/16的数据已经发生过变化，这个时候需要更新Cardinality信息。<br>第二种策略考虑的是，如果对表中某一行数据频繁的进行更新操作，这时表中的数据并没增加，实际发生变化的还是这一行数据。<br>InnoDB通过采样的方法，默认InnoDB存储引擎对8个叶子节点( Leaf Page)进行采用。采样的过程如下：</p><ul><li>取得B+树索引中叶子节点的数量,记为A。</li><li>随机取得B+树索引中的8个叶子节点。统计每个页不同记录的个数,即为P1,P2,&mldr;,P8。</li><li>根据采样信息给出 Cardinality的预估值: Cardinality=(P1+P2+…+P8)*A/8。</li></ul><h3 id=怎么查看cardinality>怎么查看Cardinality</h3><p>访问infomation_schema架构下的表tables和statistics时以及执行下面SQL</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>show</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>index</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>表名</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>show</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>status</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>analyze</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>表名</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>会导致InnoDB存储引擎去重新计算索引的Cardinality值。</p><blockquote><p>注意：表中的数据量非常大，并且表中存在多个辅助索引的时候，执行上述操作可能会很慢。</p></blockquote><p><img src="https://github.com/mxsm/picture/blob/main/mysql/showindexfrom.png?raw=true" alt></p><h3 id=添加索引的策略>添加索引的策略</h3><p>Cardinality表示的是某个字段的选择性的高低，数值越大选择性越高，数值越小选择性越低。根据建立索引的原理，我们应该尽量选择选择性越高的列(或者组合列)进行索引的建立。</p><p>公式： Cardinality/总的数据行数和1做对比，越接近于1越适合建立索引。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-3eaf90af32116bd141cd90fe3be9087b>6.2.4.3 - InnoDB表</h1><h3 id=1-索引组织表>1. 索引组织表</h3><p>在InnoDB存储引擎中，表都是根据主键顺序组织存放的，这种方式的表称为索引组织表。索引在InnoDB中每张表都有主键，如果没有显式的定义主键，InnoDB会按照如下的方式选择或创建主键：</p><ul><li>判断是否有非空的唯一索引，有该列就是为主键<br>主键根据的是定义索引的顺序，而不是建表时候字段的顺序。</li><li>不满足上述条件，InnoDB自动创建一个6字节大小的指针。</li></ul><blockquote><p>说明: _rowid可以显示表的主键，这只是对单列的主键有效，对于多列组成主键就无效了。</p></blockquote><h3 id=2-innodb逻辑存储结构>2. InnoDB逻辑存储结构</h3><p>从逻辑结构来看所有的逻辑都被存放在一个空间中，称为表空间(tablespace)。表空间由如下组成：</p><ul><li>段(segment)</li><li>区(extent)</li><li>页(page)或者称为块(block)</li></ul><p><img src="https://github.com/mxsm/picture/blob/main/mysql/innodbtablestruct.png?raw=true" alt=组成图示></p><h4 id=21-表空间>2.1 表空间</h4><p>表空间可以看做为InnoDB存储引擎逻辑结构的最高层，所有的数据都放在表空间中。</p><h4 id=22-段>2.2 段</h4><p>段的分类：</p><ul><li>数据段</li><li>索引段</li><li>回滚段</li></ul><p>由于InnoDB存储引擎表是索引组织的，因此数据即索引，索引即数据。那么数据段即为B+树的叶子节点，索引段即为B+树的非叶子节点。</p><h4 id=23-区>2.3 区</h4><p>区是由联想页组成的空间。在任何情况下每个去的掉线都是1M。为了保证区中页的连续性，InnoDB存储引擎一次从磁盘申请多个区。默认情况下页的大小为16K,一个区就有64个连续的页。</p><blockquote><p>页可以通过KEY_BLOCK_SIZE来设置大小</p></blockquote><h4 id=24-页>2.4 页</h4><p>页是InnoDB磁盘管理的最小单位，默认每个也的大小为16KB。页的常见类型：</p><ul><li>数据页</li><li>undo页</li><li>系统页</li><li>事务数据页</li><li>插入缓冲位图页</li><li>插入缓冲空闲列表页</li><li>未压缩的二进制大对象页</li><li>压缩的二进制大对象页</li></ul><h4 id=25-行>2.5 行</h4><p>InnoDB存储引擎是面向列，也就是数据是按行进行存放。每个页存放的行记录也是有硬性定义的，最多允许存放16K/2-200行的记录。</p><p><img src="https://github.com/mxsm/picture/blob/main/mysql/%E6%9F%A5%E7%9C%8B%E8%A1%A8%E7%9A%84%E7%8A%B6%E6%80%81.png?raw=true" alt=图></p></div><div class=td-content style=page-break-before:always><h1 id=pg-3d89993c61d8f20a8a16149403b6e11e>6.2.4.4 - Mysql InnoDB 锁</h1><blockquote><p>使用的表结构：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>city</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>ID</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>int</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AUTO_INCREMENT</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>Name</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>char</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>35</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>CountryCode</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>char</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>District</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>char</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>Population</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>int</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;0&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>PRIMARY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>ID</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>Name</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000;font-weight:700>,</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>CountryCode</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000;font-weight:700>,</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>District</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000;font-weight:700>,</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>Population</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>USING</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BTREE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ENGINE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>InnoDB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AUTO_INCREMENT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>4080</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CHARSET</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>utf8mb4</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>COLLATE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>utf8mb4_0900_ai_ci</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></blockquote><p>目录：</p><ul><li>[1. 什么是锁](#1. 什么是锁)</li><li><a href=#2-locklatch>2. lock与latch</a></li><li><a href=#3-innodb>3. InnoDB存储引擎中的锁</a></li><li><a href=#4-sx>4. 共享锁(S)和排他锁(X)</a></li><li><a href=#5-intention-locks>5. 意向锁(Intention Locks)</a></li><li><a href=#6-record-locks>6. 行锁(Record Locks)</a></li><li><a href=#7-gap-locks>7. 间隙锁(Gap Locks)</a></li><li><a href=#8-next-key->8. Next-Key 锁</a></li><li><a href=#9>9.插入意向锁</a></li><li><a href=#10-auto-inc->10. AUTO-INC 锁</a></li></ul><h3 id=1-什么是锁>1. 什么是锁</h3><p>锁机制用于管理对共享资源的并发访问，提供数据的完整性和一致性。</p><h3 id=2-lock与latch>2. lock与latch</h3><ul><li>latch<br>闩锁(轻量级的锁)作用对象是并发线程，要求锁定的时间要非常短。持续时间太长则性能就会非常差。在InnoDb中latch又分为两种：mutex(互斥量)和rwlock（读写锁）。作用用来保证并发线程操作临界资源的正确性(没有死锁的检查机制)</li><li>lock<br>lock作用对象是事务，用来锁定数据库中的对象(表、页、行)并且一般lock的对象仅在事务commit或rollback后进行释放(不同的事务隔离级别释放的时间可能不同)，有死锁的检测机制</li></ul><p>区别列表：</p><table><thead><tr><th></th><th>lock</th><th>latch</th></tr></thead><tbody><tr><td>对象</td><td>事务</td><td>线程</td></tr><tr><td>保护</td><td>数据库内容</td><td>内存数据结构</td></tr><tr><td>持续时间</td><td>整个事务过程</td><td>临界资源</td></tr><tr><td>模式</td><td>行锁、表锁、意向锁</td><td>读写锁、互斥量</td></tr><tr><td>死锁</td><td>通过waits-for graph、time out等机制进行死锁检测处理</td><td>无死锁的检测与处理机制</td></tr><tr><td>存在于</td><td>Lock Mannager的哈希表中</td><td>每个数据结构的对象</td></tr></tbody></table><blockquote><p>latch查看命令：show engine innodb mutex;</p></blockquote><h3 id=3-innodb存储引擎中的锁>3. InnoDB存储引擎中的锁</h3><p>在InnoDB中使用的锁：</p><ul><li><strong>[共享锁和排他锁(S锁、X锁)](#4. 共享锁(S)和排他锁(X))</strong></li><li><strong>[意向锁](#5. 意向锁(Intention Locks))</strong></li><li><strong>[行锁](#6. 行锁(Record Locks))</strong></li><li><strong>[间隙锁](#7. 间隙锁(Gap Locks))</strong></li><li><strong>[Next-Key Locks](#8. Next-Key 锁)</strong></li><li><strong><a href=#9.%E6%8F%92%E5%85%A5%E6%84%8F%E5%90%91%E9%94%81>插入意向锁</a></strong></li><li><strong>[AUTO-INC 锁](#10. AUTO-INC 锁)</strong></li><li><strong>基于空间索引的锁</strong></li></ul><h3 id=4-共享锁s和排他锁x>4. 共享锁(S)和排他锁(X)</h3><p>InnoDB实现了两种标准的行级锁，共享锁(也叫：S锁)和排他锁(X锁)</p><ul><li>共享(S)锁允许持有锁的事务读取一行</li><li>独占(X)锁允许持有锁的事务更新或删除一行</li></ul><p>如果事务T1持有一条记录r的S锁，然后，对来自不同事务T2的行r上的锁的请求进行如下处理：</p><ul><li>T2对S锁的请求可以立即被允许。因此，T1和T2都持有r记录上的S锁。</li><li>T2对S锁的请求不能立刻被允许</li></ul><p>下面看一下例子：</p><p><img src="https://github.com/mxsm/picture/blob/main/mysql/%E8%AF%BB%E5%86%99%E9%94%81.gif?raw=true" alt></p><p>如果事务T1持有行r上的独占(X)锁，则某个不同事务T2对行r上任何一种类型的锁的请求都不能立即被批准。相反，事务T2必须等待事务T1释放该行r上的锁。例子说明：</p><p><img src="https://github.com/mxsm/picture/blob/main/mysql/%E8%AF%BB%E5%86%99%E9%94%811.gif?raw=true" alt></p><h3 id=5-意向锁intention-locks>5. 意向锁(Intention Locks)</h3><p>InnoDB支持多粒度锁，允许行锁和表锁共存。例如，LOCK TABLES…WRITE接受指定表上的排他锁(X锁)。为了实现多粒度级别的锁，InnoDB使用意向锁。意向锁是表级锁，它指示事务以后对表中的一行需要哪种类型的锁(共享或独占)。有两种类型的意向锁:</p><ul><li>意图共享锁(IS)表示事务打算在表中的各个行上设置共享锁。( SELECT &mldr; FOR SHARE)</li><li>意图排他锁(IX)表示事务打算在表中的各个行上设置排他锁。( SELECT &mldr; FOR UPDATE)</li></ul><p>意向锁的协议如下：</p><ul><li>事务在获取表中某一行上的共享锁之前，必须首先获取表上的IS锁或更强的锁</li><li>在事务获得表中某一行上的独占锁之前，它必须首先获得表上的IX锁。</li></ul><p>如果锁与现有锁兼容，则将锁授予请求事务，但如果锁与现有锁冲突，则不会授予该事务。事务等待，直到冲突的现有锁被释放。如果一个锁请求与现有的锁冲突，并且由于可能导致死锁而不能授予，则会发生错误。</p><table><thead><tr><th style=text-align:center></th><th style=text-align:center>X</th><th style=text-align:center>IX</th><th style=text-align:center>S</th><th style=text-align:center>IS</th></tr></thead><tbody><tr><td style=text-align:center>X</td><td style=text-align:center>冲突</td><td style=text-align:center>冲突</td><td style=text-align:center>冲突</td><td style=text-align:center>冲突</td></tr><tr><td style=text-align:center>IX</td><td style=text-align:center>冲突</td><td style=text-align:center>兼容</td><td style=text-align:center>冲突</td><td style=text-align:center>兼容</td></tr><tr><td style=text-align:center>S</td><td style=text-align:center>冲突</td><td style=text-align:center>冲突</td><td style=text-align:center>兼容</td><td style=text-align:center>兼容</td></tr><tr><td style=text-align:center>IS</td><td style=text-align:center>冲突</td><td style=text-align:center>兼容</td><td style=text-align:center>兼容</td><td style=text-align:center>兼容</td></tr></tbody></table><p>除了全表请求（例如，<a href=https://dev.mysql.com/doc/refman/8.0/en/lock-tables.html><code>LOCK TABLES ... WRITE</code></a>）之外，意图锁不会阻止任何内容。意图锁的主要目的是表明有人正在锁定一行，或者打算锁定表中的一行。</p><h3 id=6-行锁record-locks>6. 行锁(Record Locks)</h3><p>记录锁是对索引记录的锁。例如， <code>SELECT c1 FROM t WHERE c1 = 10 FOR UPDATE;</code> 可以防止从插入，更新或删除行，其中的值的任何其它交易<code>t.c1</code>是 <code>10</code>。</p><p>记录锁总是锁定索引记录，即使一个表没有定义索引。对于这种情况， <code>InnoDB</code>创建一个隐藏的聚集索引并使用该索引进行记录锁定。</p><h3 id=7-间隙锁gap-locks>7. 间隙锁(Gap Locks)</h3><p>间隙锁是对索引记录之间的间隙的锁，或者是对第一个索引记录之前或最后一个索引记录之后的间隙的锁。例如，<code>SELECT c1 FROM t WHERE c1 BETWEEN 10 and 20 FOR UPDATE;</code>阻止其他事务将 的值插入<code>15</code>到列中<code>t.c1</code>，无论列 中是否已经存在任何此类值，因为该范围内所有现有值之间的间隙被锁定。</p><p>间隙可能跨越单个索引值、多个索引值，甚至是空的。</p><p>间隙锁是性能和并发性之间权衡的一部分，用于某些事务隔离级别而不是其他级别。</p><p>使用唯一索引锁定行以搜索唯一行的语句不需要间隙锁定。（这不包括搜索条件仅包含多列唯一索引的某些列的情况；在这种情况下，确实会发生间隙锁定。）例如，如果该<code>id</code>列具有唯一索引，则以下语句仅使用<code>id</code>值为 100的行的索引记录锁定，其他会话是否在前面的间隙中插入行无关紧要：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>child</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>如果<code>id</code>未编入索引或具有非唯一索引，则该语句会锁定前面的间隙。</p><p>这里还值得注意的是，不同的事务可以在间隙上持有冲突的锁。例如，事务 A 可以在间隙上持有共享间隙锁（间隙 S 锁），而事务 B 在同一间隙上持有排他间隙锁（间隙 X 锁）。允许冲突间隙锁的原因是，如果从索引中清除记录，则必须合并不同事务在记录上持有的间隙锁。</p><p>间隙锁定<code>InnoDB</code>是“纯粹的抑制性”，这意味着它们的唯一目的是防止其他事务插入间隙。间隙锁可以共存。一个事务采用的间隙锁不会阻止另一个事务在同一间隙上采用间隙锁。共享和排他间隙锁之间没有区别。它们彼此不冲突，并且执行相同的功能。</p><p>可以明确禁用间隙锁定。如果将事务隔离级别更改为 ，则会发生这种情况 <a href=https://dev.mysql.com/doc/refman/8.0/en/innodb-transaction-isolation-levels.html#isolevel_read-committed><code>READ COMMITTED</code></a>。在这种情况下，对搜索和索引扫描禁用间隙锁定，仅用于外键约束检查和重复键检查。</p><p>使用<a href=https://dev.mysql.com/doc/refman/8.0/en/innodb-transaction-isolation-levels.html#isolevel_read-committed><code>READ COMMITTED</code></a>隔离级别还有其他影响 。在 MySQL 评估<code>WHERE</code>条件后释放不匹配行的记录锁。对于 <code>UPDATE</code>报表，<code>InnoDB</code> 做一个“半一致”读，这样它返回的最新提交版本到MySQL使MySQL能够确定该行是否比赛<code>WHERE</code> 的条件<a href=https://dev.mysql.com/doc/refman/8.0/en/update.html><code>UPDATE</code></a>。</p><h3 id=8-next-key-锁>8. Next-Key 锁</h3><p>next-key 锁是索引记录上的记录锁和索引记录之前的间隙上的间隙锁的组合。</p><h3 id=9插入意向锁>9.插入意向锁</h3><p>插入意图锁是一种由<a href=https://dev.mysql.com/doc/refman/8.0/en/insert.html><code>INSERT</code></a>行插入之前的操作设置的间隙锁 。此锁表示插入意图，如果插入同一索引间隙的多个事务未插入间隙内的相同位置，则它们无需相互等待。假设存在值为 4 和 7 的索引记录。 分别尝试插入值 5 和 6 的单独事务，在获得插入行的排他锁之前，每个事务都使用插入意向锁锁定 4 和 7 之间的间隙，但不要相互阻塞，因为行是不冲突的。</p><p>以下示例演示了在获取插入记录的排他锁之前采用插入意向锁的事务。该示例涉及两个客户端 A 和 B。</p><p>客户端 A 创建一个包含两条索引记录（90 和 102）的表，然后启动一个事务，对 ID 大于 100 的索引记录放置排他锁。 排他锁包括记录 102 之前的间隙锁：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#000>mysql</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>child</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>int</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>11</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>PRIMARY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ENGINE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>InnoDB</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>mysql</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>child</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>values</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>90</span><span style=color:#000;font-weight:700>),(</span><span style=color:#0000cf;font-weight:700>102</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>mysql</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>START</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TRANSACTION</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>mysql</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>child</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FOR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>UPDATE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#8f5902;font-style:italic>-----+
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#8f5902;font-style:italic>-----+
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>102</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#8f5902;font-style:italic>-----+
</span></code></pre></div><p>客户端 B 开始一个事务以在间隙中插入一条记录。事务在等待获得排他锁时使用插入意向锁。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#000>mysql</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>START</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TRANSACTION</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>mysql</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>child</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>101</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>用于插入意图锁定事务数据出现类似于在下面 <a href=https://dev.mysql.com/doc/refman/8.0/en/show-engine.html><code>SHOW ENGINE INNODB STATUS</code></a>和 <a href=https://dev.mysql.com/doc/refman/8.0/en/innodb-standard-monitor.html>InnoDB的监视器</a> 输出：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#000>RECORD</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>LOCKS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>space</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>31</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>page</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>no</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>n</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>bits</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>72</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>index</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#204a87;font-weight:700>PRIMARY</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>of</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000;font-weight:700>.</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>trx</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8731</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>lock_mode</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>X</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>locks</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gap</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>before</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>rec</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>insert</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>intention</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>waiting</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>Record</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>lock</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>heap</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>no</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PHYSICAL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RECORD</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>n_fields</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>compact</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>format</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>info</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>bits</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>len</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hex</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>80000066</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>asc</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>f</span><span style=color:#000;font-weight:700>;;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>len</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hex</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>000000002215</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>asc</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#4e9a06>&#34; ;;
</span><span style=color:#4e9a06> 2: len 7; hex 9000000172011c; asc     r  ;;...
</span></code></pre></div><h3 id=10-auto-inc-锁>10. AUTO-INC 锁</h3><p>一个<code>AUTO-INC</code>锁是通过交易将与表中取得一个特殊的表级锁 <code>AUTO_INCREMENT</code>列。在最简单的情况下，如果一个事务正在向表中插入值，则任何其他事务都必须等待自己插入到该表中，以便第一个事务插入的行接收连续的主键值。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-3c9f466967fc922424da326a0ff058ff>6.2.4.5 - Explain执行计划</h1><blockquote><p>使用的表：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>city</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>ID</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>int</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AUTO_INCREMENT</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>Name</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>char</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>35</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>CountryCode</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>char</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>District</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>char</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>Population</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>int</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;0&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>PRIMARY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>ID</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>name_code</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>Name</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000;font-weight:700>,</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>CountryCode</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ENGINE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>InnoDB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AUTO_INCREMENT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>4080</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CHARSET</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>utf8mb4</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>COLLATE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>utf8mb4_0900_ai_ci</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>city</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Kabul&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;AFG&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Kabol&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>1780000</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>city</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Qandahar&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;AFG&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Qandahar&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>237500</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>city</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Herat&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;AFG&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Herat&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>186800</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>city</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Mazar-e-Sharif&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;AFG&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Balkh&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>127800</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>city</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Amsterdam&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;NLD&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Noord-Holland&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>731200</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>city</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Rotterdam&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;NLD&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Zuid-Holland&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>593321</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>city</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Haag&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;NLD&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Zuid-Holland&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>440900</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>city</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Utrecht&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;NLD&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Utrecht&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>234323</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>city</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>9</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Eindhoven&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;NLD&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Noord-Brabant&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>201843</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>city</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Tilburg&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;NLD&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Noord-Brabant&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>193238</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>city</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>11</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Groningen&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;NLD&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Groningen&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>172701</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>city</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Breda&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;NLD&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Noord-Brabant&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>160398</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>city</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Apeldoorn&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;NLD&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Gelderland&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>153491</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>city</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Nijmegen&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;NLD&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Gelderland&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>152463</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>city</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Enschede&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;NLD&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Overijssel&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>149544</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>city</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Haarlem&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;NLD&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Noord-Holland&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>148772</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>city</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>17</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Almere&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;NLD&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Flevoland&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>142465</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>city</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Arnhem&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;NLD&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Gelderland&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>138020</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>city</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>19</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Zaanstad&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;NLD&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Noord-Holland&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>135621</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>city</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;´s-Hertogenbosch&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;NLD&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Noord-Brabant&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>129170</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>city</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>21</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Amersfoort&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;NLD&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Utrecht&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>126270</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>city</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>22</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Maastricht&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;NLD&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;Limburg&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>122087</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>可以去MySQL官网地址下载：https://downloads.mysql.com/docs/world-db.zip</p></blockquote><h3 id=1-explain的作用>1. explain的作用</h3><ul><li>表的加载顺序</li><li>sql的查询类型</li><li>sql查询时候用到的索引</li><li>表与表之间的关系</li><li>记录被查询的行数</li></ul><p>这些都是对应这explain的查询信息</p><h3 id=2-explain的信息>2. explain的信息</h3><table><thead><tr><th>字段</th><th>JSON名称</th><th>说明</th></tr></thead><tbody><tr><td>id</td><td>select_id</td><td>SELECT标识符</td></tr><tr><td>select_type</td><td>无</td><td>SELECT类型</td></tr><tr><td>table</td><td>table_name</td><td>表名称</td></tr><tr><td>partitions</td><td>partitions</td><td>匹配的分区</td></tr><tr><td>type</td><td>access_type</td><td>join类型</td></tr><tr><td>possible_keys</td><td>possible_keys</td><td>可供选择的可能的索引</td></tr><tr><td>key</td><td>key</td><td>实际使用的索引</td></tr><tr><td>key_len</td><td>key_len</td><td>实际选择索引的长度</td></tr><tr><td>ref</td><td>ref</td><td>将列与索引进行比较</td></tr><tr><td>rows</td><td>rows</td><td>预估查询的行数</td></tr><tr><td>filtered</td><td>filtered</td><td>按表条件过滤的行百分比</td></tr><tr><td>Extra</td><td>无</td><td>附加信息</td></tr></tbody></table><p>下面我们逐一分析explain的查询字段的信息</p><h3 id=3-id>3. id</h3><p>id表示查询中执行select子句或者操作表的顺序， <strong>id的值越大，代表优先级越高，越先执行</strong> 。大概会有三种情况。</p><h3 id=4-select_type>4. select_type</h3><table><thead><tr><th>select_type值</th><th>说明</th></tr></thead><tbody><tr><td>SIMPLE</td><td>简单查询(没有使用union或者子查询)</td></tr><tr><td>PRIMARY</td><td>查询中若包含任何复杂的子部分,最外层的select被标记为PRIMARY</td></tr><tr><td>UNION</td><td>UNION中的第二个或后面的SELECT语句</td></tr><tr><td>DEPENDENT UNION</td><td>UNION中的第二个或后面的SELECT语句，取决于外面的查询</td></tr><tr><td>UNION RESULT</td><td>UNION的结果</td></tr><tr><td>SUBQUERY</td><td>子查询中第一个SELECT语句</td></tr><tr><td>DEPENDENT SUBQUERY</td><td>第一个SELECT在子查询中，依赖于外部查询</td></tr><tr><td>DERIVED</td><td>派生表</td></tr><tr><td>DEPENDENT DERIVED</td><td>派生表依赖于另一个表</td></tr><tr><td>MATERIALIZED</td><td>物化子查询</td></tr><tr><td>UNCACHEABLE SUBQUERY</td><td>无法缓存结果并且必须为外部查询的每一行重新评估的子查询</td></tr><tr><td>UNCACHEABLE UNION</td><td>UNION 属于不可缓存子查询的第二个或以后的选择</td></tr></tbody></table><h3 id=5-table>5. table</h3><p>查询的表名，并不一定是真实存在的表，有别名显示别名，也可能为临时表.</p><h3 id=6-partitions>6. partitions</h3><p>查询时匹配到的分区信息，对于非分区表值为NULL，当查询的是分区表时，partitions显示分区表命中的分区情况。</p><h3 id=7-type>7. type</h3><p>查询使用了何种类型,下面的列表描述了查询join类型，从最好到最差的类型：</p><ul><li><p>system</p></li><li><p>const</p><p>表示查询时命中 <code>primary key</code> 主键或者 <code>unique</code> 唯一索引，或者被连接的部分是一个常量(<code>const</code>)值。这类扫描效率极高，返回数据量少，速度非常快。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=color:#000>mysql</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>explain</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>city</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>+----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------------+</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>select_type</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>partitions</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>possible_keys</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>key_len</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ref</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>filtered</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Extra</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>+----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------------+</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SIMPLE</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>city</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>NULL</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>const</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>PRIMARY</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>PRIMARY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>const</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>Using</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>index</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>+----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------------+</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>row</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>01</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li><li><p>eq_ref</p><p>查询时命中主键<code>primary key</code> 或者 <code>unique key</code>索引， <code>type</code> 就是 <code>eq_ref</code></p></li><li><p>ref</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=color:#000>mysql</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>explain</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>Name</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CountryCode</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>city</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>CountryCode</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;NLD&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>Name</span><span style=color:#ce5c00;font-weight:700>`=</span><span style=color:#4e9a06>&#39;Haag&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>+----+-------------+-------+------------+------+---------------+-----------+---------+-------------+------+----------+--------------------------+</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>select_type</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>partitions</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>possible_keys</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>key_len</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ref</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>filtered</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Extra</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>+----+-------------+-------+------------+------+---------------+-----------+---------+-------------+------+----------+--------------------------+</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SIMPLE</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>city</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>NULL</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ref</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name_code</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name_code</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>152</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>const</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>const</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>Using</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>Using</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>index</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>+----+-------------+-------+------------+------+---------------+-----------+---------+-------------+------+----------+--------------------------+</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>row</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>02</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li><li><p>fulltext</p></li><li><p>ref_or_null</p></li><li><p>index_merge</p></li><li><p>unique_subquery</p></li><li><p>index_subquery</p></li><li><p>range</p><p>使用索引选择行，仅检索给定范围内的行。简单点说就是针对一个有索引的字段，给定范围检索数据。在<code>where</code>语句中使用 <code>bettween...and</code>、<code>&lt;</code>、<code>></code>、<code>&lt;=</code>、<code>in</code> 等条件查询 <code>type</code> 都是 <code>range</code> 。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=color:#000>mysql</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>explain</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>Name</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CountryCode</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>city</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>IN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>+----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+-------------+</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>select_type</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>partitions</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>possible_keys</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>key_len</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ref</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>filtered</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Extra</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>+----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+-------------+</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SIMPLE</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>city</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>NULL</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>range</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>PRIMARY</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>PRIMARY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>NULL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>Using</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>+----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+-------------+</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>row</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>05</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>对只设置了索引的字段，做范围检索 <code>type</code> 才是 <code>range</code></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=color:#000>mysql</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>explain</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>Name</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CountryCode</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>city</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>District</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>IN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;A&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;B&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>select_type</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>partitions</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>possible_keys</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>key_len</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ref</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>rows</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>filtered</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Extra</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SIMPLE</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>city</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>NULL</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>NULL</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>NULL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>NULL</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>NULL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>4046</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>00</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>Using</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>row</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>07</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sec</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li><li><p>index</p><p><code>index</code>：<code>Index</code> 与<code>ALL</code> 其实都是读全表，区别在于<code>index</code>是遍历索引树读取，而<code>ALL</code>是从硬盘中读取</p></li><li><p>ALL</p></li></ul><h3 id=8-possible_keys>8. possible_keys</h3><p>表示在MySQL中通过哪些索引，能让我们在表中找到想要的记录，一旦查询涉及到的某个字段上存在索引，则索引将被列出，但这个索引并不定一会是最终查询数据时所被用到的索引</p><h3 id=9-key>9. key</h3><p>key是查询中实际使用到的索引，若没有使用索引，显示为NULL</p><h3 id=10-key_len>10. key_len</h3><p>表示查询用到的索引长度（字节数），原则上长度越短越好</p><ul><li>单列索引，那么需要将整个索引长度算进去</li><li>多列索引，不是所有列都能用到，需要计算查询中实际用到的列</li></ul><h3 id=11-ref>11. ref</h3><p>常见的有：const，func，null，字段名.</p><ul><li>当使用常量等值查询，显示const</li><li>当关联查询时，会显示相应关联表的关联字段</li><li>如果查询条件使用了表达式、函数，或者条件列发生内部隐式转换，可能显示为func</li><li>其他情况null</li></ul><h3 id=12-rows>12. rows</h3><p>以表的统计信息和索引使用情况，估算要找到我们所需的记录，需要读取的行数。 这个数据越小越好，在最小的扫描行数找出需要的记录数最好的</p><h3 id=13-filtered>13. filtered</h3><p>该filtered列指示按表条件过滤的表行的估计百分比。最大值为100，这意味着没有发生行过滤。从 100 开始减小的值表示过滤量增加。 rows显示估计的检查行数，rows × filtered显示与下表连接的行数。</p><h3 id=14-extra>14. Extra</h3><p>不适合在其他列中显示的信息，Explain 中的很多额外的信息会在 Extra 字段显示</p><blockquote><p>例如:Using where</p></blockquote><p>参考文档:</p><ul><li><a href=https://dev.mysql.com/doc/refman/8.0/en/explain-output.html>https://dev.mysql.com/doc/refman/8.0/en/explain-output.html</a></li><li><a href=https://juejin.cn/post/6844904163969630221>https://juejin.cn/post/6844904163969630221</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-d155293e0ea1bbdd68ce1f35e6841bf9>6.2.4.6 - InnoDb崩溃恢复</h1><p>参考文章：</p><p><a href=http://mysql.taobao.org/monthly/2017/07/01/>http://mysql.taobao.org/monthly/2017/07/01/</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-155860a4dc4a0940b63e2f0aa8a54ac3>6.2.5 - mysql使用过程中的问题</h1></div><div class=td-content><h1 id=pg-1f5a9d0891eb285c4d6121ce45a1fca1>6.2.5.1 - 虚拟机VMware的Linux系统挂起后 docker中的mysql容器无法访问</h1><h3 id=1-问题描述>1. 问题描述</h3><p>vm虚拟机挂起再开启后，宿住机便无法访问虚拟机中的docker容器， 但是宿主机是可以ping通linux虚拟机的。 搞得每次都得重启虚拟机</p><h3 id=2-解决方式>2. 解决方式</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>vim /usr/lib/sysctl.d/00-system.conf 
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-5675abed06c2c2213ef706d8cf2ed456>6.3 - 建立索引原则</h1><h3 id=建索引的原则>建索引的原则</h3><ul><li><p><strong>最左前缀匹配原则</strong></p><p>mysql会一直向右匹配直到<strong>遇到范围查询(>、&lt;、between、like)就停止匹配</strong>，比如a= 1 and b = 2 and c > 3 and d = 4 如果建立(a,b,c,d)顺序的索引，d是用不到索引的，如果建立(a,b,d,c)的索引则都可以用到，a,b,d的顺序可以任意调整。</p></li><li><p><strong>=和in可以乱序</strong></p><p>比如a = 1 and b = 2 and c = 3 建立(a,b,c)索引可以任意顺序，mysql的查询优化器会帮你优化成索引可以识别的形式。</p></li><li><p><strong>尽量选择区分度高的列作为索引</strong></p><p>什么叫做区分度高说白了就是重复少。比如表的主键。区分度的公式是 <strong><code>count(distinct col)/count(*)</code></strong> ，表示字段不重复的比例，比例越大我们扫描的记录数越少，唯一键的区分度是1，而一些状态、性别字段可能在大数据面前区分度就是0</p></li><li><p><strong>索引列不能参与计算，保持列“干净”</strong></p><p>比如 <strong><code>from_unixtime(create_time) = ’2014-05-29’</code></strong> 就不能使用到索引，原因很简单，b+树中存的都是数据表中的字段值，但进行检索时，需要把所有元素都应用函数才能比较，显然成本太大。所以语句应该写成 <strong><code>create_time= unix_timestamp(’2014-05-29’);</code></strong></p></li><li><p><strong>尽量的扩展索引，不要新建索引。</strong></p><p>比如表中已经有a的索引，现在要加(a,b)的索引，那么只需要修改原来的索引即可</p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-73c555a203186678c06e0a28ba8fb9e0>6.4 - 数据库事务</h1><h3 id=数据库事务的四大特性acid>数据库事务的四大特性(ACID)</h3><ul><li><strong>原子性(atomicity):一个事务必须视为一个不可分割的最小单元，整个事务中的所有操作要么全部提交成功，要么全部失败回滚，对于一个事务来说，不可能只执行成功其中的一部分操作，这就是事务的原子性.</strong></li><li><strong>一致性(consistency)：数据总是从一个一致性的状态转换到另一个一致性的状态。</strong></li><li><strong>隔离性（isolation）：一个事务所做的修改在最终提交以前，对其他事务是不可见的，多个并发事务之间是相互隔离的。关于事务的隔离性，MySQL提供了四种隔离级别。</strong></li><li><strong>持久性（durability）：一旦事务提交，所做的修改会永久保存到数据库中。即使系统崩溃，修改的数据也不会丢失。</strong></li></ul><h3 id=不考虑隔离性可能产生的问题>不考虑隔离性可能产生的问题</h3><ul><li><h4 id=脏读>脏读</h4><p>脏读是指在一个事务处理过程中读取了另一个未提交的事务中的数据。</p></li><li><h4 id=不可重复读>不可重复读</h4><p>不可重复读是指对于数据库中的某个数据，一个事务内多次查询却返回了不同的数据值，这是由于在事务执行过程中，数据被另一个事务修改并提交了。</p></li><li><h4 id=幻读>幻读</h4><p>幻读是事务非独立执行时发生的一种现象。例如，事务T1对一个表中所有的行的某个字段做了从“1”修改为“2”的操作，这时事务T2又插入了一条新的记录，而该字段的值为“1”并且提交给数据库。这时，操作事务T1的用户如果再查看刚刚修改的数据，会发现还有一行没有修改，其实这行是从事务T2中添加的，就好像产生幻觉一样，这就是产生了幻读。</p></li></ul><h4 id=幻读和不可重复读的区别>幻读和不可重复读的区别：</h4><ul><li><strong>幻读针对的是一批数据（比如数据的个数）重点在于新增或者删除操作</strong></li><li><strong>不可重复读查询的都是同一个数据项 重点在于更新操作</strong></li></ul><p><strong>相同点都是读取了另一条提交的事物</strong></p><h3 id=事务的隔离级别>事务的隔离级别</h3><ul><li><h5 id=serializable串行化可避免脏读不可重复读幻读的发生级别最高>Serializable（串行化）：可避免脏读、不可重复读、幻读的发生。（级别最高）</h5></li><li><h5 id=repeatable-read可重复读可避免脏读不可重复读的发生>Repeatable-read（可重复读）：可避免脏读、不可重复读的发生。</h5></li><li><h5 id=read-committed读已提交可避免脏读的发生>Read-committed（读已提交）：可避免脏读的发生。</h5></li><li><h5 id=read-uncommitted读未提交最低级别任何情况都无法保证级别最低>Read-uncommitted（读未提交）：最低级别，任何情况都无法保证。（级别最低）</h5></li></ul><p>MySQL的InnoDB默认为 <strong><code>Repeatable-read</code></strong></p></div><div class=td-content style=page-break-before:always><h1 id=pg-ed38975c43e54aaba853e41a00f4f0f8>6.5 - 范式和反范式</h1><h3 id=1-第一范式1nf>1. 第一范式(1NF)</h3><p>1NF是对属性的<strong>原子性</strong>，要求属性具有原子性，不可再分解；</p><pre><code>表：字段1、 字段2(字段2.1、字段2.2)、字段3 ......
</code></pre><h3 id=2-第二范式2nf>2. 第二范式(2NF)</h3><p>2NF是对记录的<strong>惟一性</strong>，要求记录有惟一标识，即实体的惟一性，即不存在部分依赖；</p><pre><code>表：学号、课程号、姓名、学分;
</code></pre><p>这个表明显说明了两个事务:学生信息, 课程信息;由于非主键字段必须依赖主键，这里<strong>学分依赖课程号</strong>，<strong>姓名依赖与学号</strong>，所以不符合二范式。</p><p><strong>可能会存在问题：</strong></p><ul><li><code>数据冗余:</code>，每条记录都含有相同信息；</li><li><code>删除异常：</code>删除所有学生成绩，就把课程信息全删除了；</li><li><code>插入异常：</code>学生未选课，无法记录进数据库；</li><li><code>更新异常：</code>调整课程学分，所有行都调整</li></ul><h3 id=3-第三范式3nf>3. 第三范式(3NF)</h3><p>3NF是对字段的<strong>冗余性</strong>，要求任何字段不能由其他字段派生出来，它要求字段没有冗余，即不存在传递依赖；</p><pre><code>表: 学号, 姓名, 年龄, 学院名称, 学院电话
</code></pre><p>因为存在<strong>依赖传递</strong>: (学号) → (学生)→(所在学院) → (学院电话) 。</p><p><strong>可能会存在问题：</strong></p><ul><li><code>数据冗余:</code>有重复值；</li><li><code>更新异常：</code>有重复的冗余信息，修改时需要同时修改多条记录，否则会出现<strong>数据不一致的情况</strong> 。</li></ul><h3 id=4-反范式>4. 反范式</h3><p>没有冗余的数据库设计可以做到。但是，没有冗余的数据库未必是最好的数据库，有时为了提高运行效率，就必须降低范式标准，适当保留冗余数据。具体做法是：在概念数据模型设计时遵守第三范式，降低范式标准的工作放到物理数据模型设计时考虑。降低范式就是增加字段，允许冗余，<strong>达到以空间换时间的目的</strong>。</p><p>例子：</p><pre><code>比如订单表中加入商品的金额，为什么加入金额这样违反了第二范式，但是由于商品金额改变并不会影响当时购买时候的金
额。所以用冗余的办法来达到空间换时间的目的就不需要去联表查询
</code></pre><h3 id=5-范式和反范式的优缺点对比>5. 范式和反范式的优缺点对比</h3><ul><li><h4 id=范式>范式</h4><ul><li><strong>优点</strong><ul><li>减少数据冗余，数据表更新小</li><li>更新操作范式更快</li><li>范式化的表比反范式更小</li></ul></li><li><strong>缺点</strong><ul><li>查询需要进行多表关联查询可能导致性能降低</li><li>更难进行索引的优化</li></ul></li></ul></li><li><h4 id=反范式>反范式</h4><ul><li><strong>优点</strong><ul><li>可以减少联表查询提高查询效率</li><li>更好的进行索引的优化</li></ul></li><li><strong>缺点</strong><ul><li>如果冗余的数据需要随着更新，数据的维护比较难</li><li>对数据的修改成本很高，因为需要修改很多记录</li></ul></li></ul></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-d1d1d686a8b969063ba3bf1f04df1f05>7 - 数据结构</h1></div><div class=td-content><h1 id=pg-659d4e3b23970a9bfe18a52f8a854c36>7.1 - 二叉搜索树</h1><h3 id=二叉查找树><strong>二叉查找树</strong></h3><p><strong>二叉查找树</strong>（英语：Binary Search Tree），也称为<strong>二叉搜索树</strong>、<strong>有序二叉树</strong>（ordered binary tree）或<strong>排序二叉树</strong>（sorted binary tree）</p><p>数据结构(Java)：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BinTreeNode</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>//节点值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>//节点的父节点
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>BinTreeNode</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>//左右孩子节点
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>BinTreeNode</span> <span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>二叉查找树性质：</strong></p><ul><li>若任意节点的左子树不空，则左子树上所有节点的值均小于它的根节点的值(左子树的最大值为左子树的最有叶子节点)。</li><li>若任意节点的右子树不空，则右子树上所有节点的值均大于它的根节点的值(右子树的最小值为右子树的最左叶子节点)。</li><li>任意节点的左、右子树也分别为二叉查找树。</li><li>没有键值相等的节点。</li></ul><p><strong>二叉树的查找算法</strong></p><p>在二叉搜索树b种查找x的过程：</p><ol><li>若b是空树，则搜索失败，否则</li><li>若x等于b的根节点数据域之值，则查找成功；否则</li><li>若x小于b的根节点的数据域值，则搜索左子树(根据若任意节点的左子树不空，则左子树上所有节点的值均小于它的根节点的值)；否则</li><li>查找右子树</li></ol><p>查找代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BinTreeNode</span> <span style=color:#000>find</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BinTreeNode</span> <span style=color:#000>treeNode</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BinTreeNode</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>){</span>

        <span style=color:#8f5902;font-style:italic>//若treeNode是空树，则搜索失败
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>treeNode</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>BinTreeNode</span> <span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>find</span> <span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>treeNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>treeNode</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span><span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>treeNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>left</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>treeNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>){</span>
                <span style=color:#000>find</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>find</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span><span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>treeNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>right</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>treeNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>){</span>
                <span style=color:#000>find</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>find</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>find</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>二叉搜索树插入节点的算法</strong></p><p>向一个二叉搜索树b中插入一个节点s的算法，过程为：</p><ol><li>若b是空树，则将s所指节点作为根节点插入，否则、</li><li>若s->data等于b的根节点的数据域之值，则返回，否则</li><li>若s->data小于b的根节点的数据域之值，则把s所指节点插入到左子树中，否则</li><li>把s所指节点插入到右子树中</li></ol><p>图解：</p><p><img src="https://github.com/mxsm/document/blob/master/image/datastructure/20190216092448.gif?raw=true" alt=图片></p><p><strong>BST 的插入算法的复杂度与查找算法的复杂度是一样的：最佳情况是 O(log­2n)，而最坏情况是 O(n)</strong> 因为它们对节点的查找定位策略是相同的</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>insert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BinTreeNode</span> <span style=color:#000>treeNode</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BinTreeNode</span> <span style=color:#000>newNode</span><span style=color:#ce5c00;font-weight:700>){</span>

        <span style=color:#8f5902;font-style:italic>//树为空将新插入的节点作为根节点
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>treeNode</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#000>treeNode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newNode</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>BinTreeNode</span> <span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>treeNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>newNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#8f5902;font-style:italic>//不做处理直接返回
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span><span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>treeNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>newNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#8f5902;font-style:italic>//插入左子树
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>left</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>treeNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#000>insert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>newNode</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>else</span>
                <span style=color:#000>treeNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>newNode</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>newNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>treeNode</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span><span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>treeNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>newNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>right</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>treeNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#000>insert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>newNode</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>else</span>
                <span style=color:#000>treeNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>newNode</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>newNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>treeNode</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>二叉查找树删除节点的算法</strong></p><p>从BST中删除节点比插入节点更困难，删除一个非叶子节点必须选择其他的节点来填补因为删除节点造成的树的断裂。</p><ul><li>**情况1：**如果删除的节点没有右孩子，那么就选择它的左孩子来代替原来的节点。二叉查找树的性质保证了被删除节点的左子树必然符合二叉查找树的性质。因此左子树的值要么都大于，要么都小于被删除节点的父节点的值，这取决于被删除节点是左孩子还是右孩子。因此用被删除节点的左子树来替代被删除节点，是完全符合二叉搜索树的性质的</li><li>**情况 2：**如果被删除节点的右孩子没有左孩子，那么这个右孩子被用来替换被删除节点。因为被删除节点的右孩子都大于被删除节点左子树的所有节点，同时也大于或小于被删除节点的父节点，这同样取决于被删除节点是左孩子还是右孩子。因此，用右孩子来替换被删除节点，符合二叉查找树的性质。</li><li><strong>情况 3：<strong>如果被删除节点的右孩子有左孩子，就需要用被删除节点右孩子的左子树中的最下面的节点来替换它，就是说，我们用被删除节点的右子树中最小值的节点来替换</strong>。</strong></li></ul><p><img src="https://github.com/mxsm/document/blob/master/image/datastructure/20190216092447.gif?raw=true" alt></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 删除节点
</span><span style=color:#8f5902;font-style:italic>     * @param treeNode
</span><span style=color:#8f5902;font-style:italic>     * @param dNode
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>delete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BinTreeNode</span> <span style=color:#000>treeNode</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BinTreeNode</span> <span style=color:#000>dNode</span><span style=color:#ce5c00;font-weight:700>){</span>

        <span style=color:#000>BinTreeNode</span> <span style=color:#000>delNode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>find</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>treeNode</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>dNode</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>//没有找到要删除的节点
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delNode</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>BinTreeNode</span> <span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>delNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>BinTreeNode</span> <span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>delNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>BinTreeNode</span> <span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>delNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>left</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>right</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>){</span>
                <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>delNode</span><span style=color:#ce5c00;font-weight:700>){</span>
                    <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span><span style=color:#204a87;font-weight:700>else</span><span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span><span style=color:#204a87;font-weight:700>else</span><span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>treeNode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>right</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#8f5902;font-style:italic>//删除的节点没有右孩子--左孩子来代替原来的节点
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>){</span>
                <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>delNode</span><span style=color:#ce5c00;font-weight:700>){</span>
                    <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span><span style=color:#204a87;font-weight:700>else</span><span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#000>delNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>delNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//右孩子的左子树中的最最小的
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>BinTreeNode</span> <span style=color:#000>min</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>findMin</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>//处理最小节点
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>delNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>min</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>min</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>min</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#000>min</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>min</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span><span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>min</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>min</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#000>min</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>min</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>min</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>=</span>  <span style=color:#000>min</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>min</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>min</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>全部代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>com.mxsm.edas.resource</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BinTreeNode</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>BinTreeNode</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>BinTreeNode</span> <span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BinTreeNode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BinTreeNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BinTreeNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BinTreeNode</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BinTreeNode</span> <span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BinTreeNode</span> <span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 构建树
</span><span style=color:#8f5902;font-style:italic>     * @param treeNode
</span><span style=color:#8f5902;font-style:italic>     * @param newNode
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>insert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BinTreeNode</span> <span style=color:#000>treeNode</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BinTreeNode</span> <span style=color:#000>newNode</span><span style=color:#ce5c00;font-weight:700>){</span>

        <span style=color:#8f5902;font-style:italic>//树为空将新插入的节点作为根节点
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>treeNode</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#000>treeNode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newNode</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>BinTreeNode</span> <span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>treeNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>newNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#8f5902;font-style:italic>//不做处理直接返回
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span><span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>treeNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>newNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#8f5902;font-style:italic>//插入左子树
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>left</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>treeNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#000>insert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>newNode</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>else</span>
                <span style=color:#000>treeNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>newNode</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>newNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>treeNode</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span><span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>treeNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>newNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>right</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>treeNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#000>insert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>newNode</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>else</span>
                <span style=color:#000>treeNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>newNode</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>newNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>treeNode</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BinTreeNode</span> <span style=color:#000>find</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BinTreeNode</span> <span style=color:#000>treeNode</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BinTreeNode</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>){</span>

        <span style=color:#8f5902;font-style:italic>//若treeNode是空树，则搜索失败
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>treeNode</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>BinTreeNode</span> <span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>find</span> <span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>treeNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>treeNode</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span><span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>treeNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>left</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>treeNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>){</span>
                <span style=color:#000>find</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>find</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span><span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>treeNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>right</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>treeNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>){</span>
                <span style=color:#000>find</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>find</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>find</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 删除节点
</span><span style=color:#8f5902;font-style:italic>     * @param treeNode
</span><span style=color:#8f5902;font-style:italic>     * @param dNode
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>delete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BinTreeNode</span> <span style=color:#000>treeNode</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BinTreeNode</span> <span style=color:#000>dNode</span><span style=color:#ce5c00;font-weight:700>){</span>

        <span style=color:#000>BinTreeNode</span> <span style=color:#000>delNode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>find</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>treeNode</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>dNode</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>//没有找到要删除的节点
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delNode</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>BinTreeNode</span> <span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>delNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>BinTreeNode</span> <span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>delNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>BinTreeNode</span> <span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>delNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>left</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>right</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>){</span>
                <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>delNode</span><span style=color:#ce5c00;font-weight:700>){</span>
                    <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span><span style=color:#204a87;font-weight:700>else</span><span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span><span style=color:#204a87;font-weight:700>else</span><span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>treeNode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>right</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#8f5902;font-style:italic>//删除的节点没有右孩子--左孩子来代替原来的节点
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>){</span>
                <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>delNode</span><span style=color:#ce5c00;font-weight:700>){</span>
                    <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span><span style=color:#204a87;font-weight:700>else</span><span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#000>delNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>delNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//右孩子的左子树中的最最小的
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>BinTreeNode</span> <span style=color:#000>min</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>findMin</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>//处理最小节点
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>delNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>min</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>min</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>min</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#000>min</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>min</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span><span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>min</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>min</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#000>min</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>min</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>min</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>=</span>  <span style=color:#000>min</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>min</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>min</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BinTreeNode</span> <span style=color:#000>findMin</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BinTreeNode</span> <span style=color:#000>treeNode</span><span style=color:#ce5c00;font-weight:700>){</span>

        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>treeNode</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BinTreeNode</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>treeNode</span><span style=color:#ce5c00;font-weight:700>;;){</span>
            <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>){</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>traverseLDR</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BinTreeNode</span> <span style=color:#000>tree</span><span style=color:#ce5c00;font-weight:700>){</span>

        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tree</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>BinTreeNode</span> <span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>left</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tree</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#000>traverseLDR</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>print</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tree</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; &#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>tree</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#000>traverseLDR</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>getValue</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BinTreeNode</span> <span style=color:#000>getParent</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setParent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BinTreeNode</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BinTreeNode</span> <span style=color:#000>getLeft</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setLeft</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BinTreeNode</span> <span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BinTreeNode</span> <span style=color:#000>getRight</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setRight</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BinTreeNode</span> <span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;BinTreeNode{&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                <span style=color:#4e9a06>&#34;value=&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>+</span>
                <span style=color:#4e9a06>&#39;}&#39;</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-1c065ee55b7d20e668419cbfe55f7501>7.2 - 二叉树</h1><h3 id=二叉树的定义>二叉树的定义</h3><p>二叉树是一个联通的无环图，且每个定点的读不大于3，有跟二叉树还要满足根节点的度不大于2。有了根节点之后，每个顶底定义了唯一的父节点，和最多2个子节点。</p><h3 id=二叉树的数据结构>二叉树的数据结构</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BinTreeNode</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>//值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>//父节点
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>BinTree</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>//左右孩子节点
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>BinTree</span> <span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div><h3 id=二叉树的访问方法--树的遍历>二叉树的访问方法&ndash;树的遍历</h3><h4 id=深度优先>深度优先</h4><p>L、D、R分别表示遍历左子树、访问根结点和遍历右子树</p><ul><li><strong>前序遍历(DLR)</strong></li><li><strong>中序遍历(LDR)</strong></li><li><strong>后序遍历(LRD)</strong>
上面三种遍历深度优先遍历的特例</li></ul><h4 id=广度优先>广度优先</h4><p>和深度优先遍历不同，广度优先遍历会先访问离根节点最近的节点。 二叉树的广度优先遍历又称<strong>按层次遍历</strong>。算法借助队列实现</p></div><div class=td-content style=page-break-before:always><h1 id=pg-5cd0867366aea565f1b236552c237316>7.3 - 红黑树</h1><h3 id=红黑树简介><strong>红黑树简介</strong></h3><p>R-B Tree，全称是Red-Black Tree，又称为“红黑树”，它一种特殊的二叉查找树。红黑树的每个节点上都有存储位表示节点的颜色，可以是红(Red)或黑(Black)。</p><h4 id=红黑树的五个特点><strong>红黑树的五个特点：</strong></h4><ol><li>每个节点必须是红黑两种颜色中的一种</li><li>根节点必须是黑色</li><li>每个叶子节点(NIL)是黑色[这里叶子节点，是指为空的（NULL或者NIL）叶子节点]</li><li>如果一个节点是红色，则它的子节点必须是黑色[换句话：从每个叶子到根的所有路径上不能有两个连续的红色节点]</li><li>从任一节点到其每个叶子的所有<a href=https://zh.wikipedia.org/wiki/%E9%81%93%E8%B7%AF_(%E5%9B%BE%E8%AE%BA)>简单路径</a>都包含相同数目的黑色节点</li></ol><p>图解：</p><p><img src="https://github.com/mxsm/document/blob/master/image/datastructure/%E7%BA%A2%E9%BB%91%E6%A0%91%E5%9B%BE%E8%A7%A3.png?raw=true" alt=图解></p><p><strong>红黑树的时间复杂度</strong>：O(logn)</p><h3 id=插入>插入</h3><ol><li><a href=https://zh.wikipedia.org/wiki/%E4%BA%8C%E5%8F%89%E6%9F%A5%E6%89%BE%E6%A0%91#%E6%8F%92%E5%85%A5>以二叉查找树的方法</a>增加节点并标记它为红色（新增的节点都标记为红色，如果设为黑色，就会导致根到叶子的路径上有一条路上，多一个额外的黑节点，这个是很难调整的。但是设为红色节点后，可能会导致出现两个连续红色节点的冲突，那么可以通过颜色调换（color flips）和树旋转来调整）</li></ol><p>注意：</p><ul><li>性质1和性质3总是保持着</li><li>性质4只在增加红色节点、重绘黑色节点为红色，或做旋转时受到威胁。</li><li>性质5只在增加黑色节点、重绘红色节点为黑色，或做旋转时受到威胁。</li></ul><p><strong>情形1</strong>：新增的节点N位于根节点，没有父亲节点，这种情况下我们重新绘制为黑色以满足性质2。因为它在没给个路径上对黑节点数目增加1，性质5匹配。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//待实现
</span></code></pre></div><p><strong>情形2</strong>：新节点的父亲节点P是黑色，性质4没有失效(新节点是红色)。这种情况下，树仍然有效，性质5没有受到破坏，尽管新节点N有两个黑色叶子子节点。但是由于新节点N是红色，通过它的每 个子节点的路径就都有同通过它所取代的黑色的叶子的路径同样数目的黑色节点，所以依然满足5这个性质。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//待实现
</span></code></pre></div><p><strong>注意</strong>：在下列情形下我们假定新节点的父节点为红色，所以它必定有祖父节点(根据性质4)；因为如果父节点是根节点，那父节点就应当是黑色。所以新节点总有一个叔父节点，尽管在情形4和5下它可能是叶子节点。</p><p><strong>情形3</strong>：如果父节点P和叔父节点U二者都是红色，(此时新插入节点N做为P的左子节点或右子节点都属于情形3，这里图仅显示N做为P左子的情形)则我们可以将它们两个重绘为黑色并且重绘父节点G为红色来保持性质五。现在我们的新节点N有了一个黑色的父节点P。因为通过父节点P或叔父节点U的任何路径都必定通过祖父节点G，在这些路径上的黑节点数目没有改变。但是，红色的祖父节点G可能是根节点，这就违反了性质2，也有可能祖父节点G的父节点是红色的，这就违反了性质4。为了解决这个问题，我们在祖父节点G上递归地进行<strong>情形1</strong>的整个过程。（把G当成是新加入的节点进行各种情形的检查），图解如下：</p><p><img src="https://github.com/mxsm/document/blob/master/image/datastructure/Red-black_tree_insert_case_3.png?raw=true" alt=图解></p><p><strong>情形4</strong>：父节点P是红色而叔父节点U是黑色或缺少，并且新节点N是其父节点P的右子节点而父节点P又是其父节点的左子节点(新增节点N和P不再同一半边子树上面,P在左边，N在P的右边)。在这种情形下，我们进行一次<a href=https://zh.wikipedia.org/wiki/%E6%A0%91%E6%97%8B%E8%BD%AC>左旋转</a>调换新节点和其父节点的角色;接着，我们按<strong>情形5</strong>处理以前的父节点P以解决仍然失效的性质4。注意这个改变会导致某些路径通过它们以前不通过的新节点N（比如图中1号叶子节点）或不通过节点P（比如图中3号叶子节点），但由于这两个节点都是红色的，所以性质5仍有效，图解如下：</p><p><img src="https://github.com/mxsm/document/blob/master/image/datastructure/Red-black_tree_insert_case_4.png?raw=true" alt=图解></p><p><strong>情形5</strong>：父节点P是红色而叔父节点U是黑色或缺少，新节点N是其父节点的左子节点，而父节点P又是其父节点G的左子节点。在这种情形下，我们进行针对祖父节点G的一次<a href=https://zh.wikipedia.org/wiki/%E6%A0%91%E6%97%8B%E8%BD%AC>右旋转</a>；在旋转产生的树中，以前的父节点P现在是新节点N和以前的祖父节点G的父节点。我们知道以前的祖父节点G是黑色，否则父节点P就不可能是红色（如果P和G都是红色就违反了性质4，所以G必须是黑色）。我们切换以前的父节点P和祖父节点G的颜色，结果的树满足性质4。性质5也仍然保持满足，因为通过这三个节点中任何一个的所有路径以前都通过祖父节点G，现在它们都通过以前的父节点P。在各自的情形下，这都是三个节点中唯一的黑色节点。</p><p><img src="https://github.com/mxsm/document/blob/master/image/datastructure/Red-black_tree_insert_case_5.png?raw=true" alt=图解></p><p>注意插入实际上是<a href=https://zh.wikipedia.org/wiki/%E5%8E%9F%E5%9C%B0%E7%AE%97%E6%B3%95>原地算法</a>，因为上述所有调用都使用了<a href=https://zh.wikipedia.org/wiki/%E5%B0%BE%E9%83%A8%E9%80%92%E5%BD%92>尾部递归</a>。</p><h3 id=删除>删除</h3><p><strong>如果需要删除的节点有两个儿子，那么问题可以被转化成删除另一个只有一个儿子的节点的问题</strong>（为了表述方便，这里所指的儿子，为非叶子节点的儿子）。对于二叉查找树，在删除带有两个非叶子儿子的节点的时候，我们要么找到它左子树中的最大元素、要么找到它右子树中的最小元素，并把它的值转移到要删除的节点中（如在<a href=https://zh.wikipedia.org/wiki/%E4%BA%8C%E5%8F%89%E6%9F%A5%E6%89%BE%E6%A0%91>这里</a>所展示的那样）。我们接着删除我们从中复制出值的那个节点，它必定有少于两个非叶子的儿子。因为只是复制了一个值，不违反任何性质，这就把问题简化为如何删除最多有一个儿子的节点的问题。它不关心这个节点是最初要删除的节点还是我们从中复制出值的那个节点。</p><p>在本文余下的部分中，<strong>我们只需要讨论删除只有一个儿子的节点</strong>（如果它两个儿子都为空，即均为叶子，我们任意将其中一个看作它的儿子）。如果我们删除一个红色节点（此时该节点的儿子将都为叶子节点），它的父亲和儿子一定是黑色的。所以我们可以简单的用它的黑色儿子替换它，并不会破坏性质3和性质4。通过被删除节点的所有路径只是少了一个红色节点，这样可以继续保证性质5。另一种简单情况是在被删除节点是黑色而它的儿子是红色的时候。如果只是去除这个黑色节点，用它的红色儿子顶替上来的话，会破坏性质5，但是如果我们重绘它的儿子为黑色，则曾经通过它的所有路径将通过它的黑色儿子，这样可以继续保持性质5。</p><p><strong>需要进一步讨论的是在要删除的节点和它的儿子二者都是黑色的时候</strong>，这是一种复杂的情况（这种情况下该结点的两个儿子都是叶子结点，否则若其中一个儿子是黑色非叶子结点，另一个儿子是叶子结点，那么从该结点通过非叶子结点儿子的路径上的黑色结点数最小为2，而从该结点到另一个叶子结点儿子的路径上的黑色结点数为1，违反了性质5）。我们首先把要删除的节点替换为它的儿子。出于方便，称呼这个儿子为<strong>N</strong>（在新的位置上），称呼它的兄弟（它父亲的另一个儿子）为<strong>S</strong>。在下面的示意图中，我们还是使用<strong>P</strong>称呼N的父亲，<strong>SL</strong>称呼S的左儿子，<strong>SR</strong>称呼S的右儿子。我们将使用下述函数找到兄弟节点：</p><p>​ <strong>情形1</strong>：N是新根。这种情况下就已经做完了，我们从所有的路径上删除一个黑色节点，而新根是黑色的，所以性质都保持着。</p><p><strong>注意</strong>：在情形2、5和6下，我们假定N是它父亲的左儿子。如果它是右儿子，则在这些情形下的<em>左</em>和<em>右</em>应当对调</p><p>​ <strong>情形2</strong>：S是红色。在这种情形下我们在N的父亲上做<a href=https://zh.wikipedia.org/wiki/%E6%A0%91%E6%97%8B%E8%BD%AC>左旋转</a>，把红色兄弟转换成N的祖父，我们接着对调N的父亲和祖父的颜色。完成这两个操作后，尽管所有路径上黑色节点的数目没有改变，但现在N有了一个黑色的兄弟和一个红色的父亲（它的新兄弟是黑色因为它是红色S的一个儿子），所以我们可以接下去按<strong>情形4</strong>、<strong>情形5</strong>或<strong>情形6</strong>来处理</p><p><img src="https://github.com/mxsm/document/blob/master/image/datastructure/Red-black_tree_delete_case_2.png?raw=true" alt=图解></p><p>​ <strong>情形3</strong>：N的父亲、S和S的儿子都是黑色的。在这种情形下，我们简单的重绘S为红色。结果是通过S的所有路径，它们就是以前<em>不</em>通过N的那些路径，都少了一个黑色节点。因为删除N的初始的父亲使通过N的所有路径少了一个黑色节点，这使事情都平衡了起来。但是，通过P的所有路径现在比不通过P的路径少了一个黑色节点，所以仍然违反性质5。要修正这个问题，我们要从<strong>情形1</strong>开始，在P上做重新平衡处理</p><p><img src="https://github.com/mxsm/document/blob/master/image/datastructure/Red-black_tree_delete_case_3.png?raw=true" alt=图解></p><p>​ <strong>情形4</strong>：S和S的儿子都是黑色，但是N的父亲是红色。在这种情形下，我们简单的交换N的兄弟和父亲的颜色。这不影响不通过N的路径的黑色节点的数目，但是它在通过N的路径上对黑色节点数目增加了一，添补了在这些路径上删除的黑色节点。图解：</p><p><img src="https://github.com/mxsm/document/blob/master/image/datastructure/Red-black_tree_delete_case_4.png?raw=true" alt=图解></p><p>​ <strong>情形5</strong>：S是黑色，S的左儿子是红色，S的右儿子是黑色，而N是它父亲的左儿子。在这种情形下我们在S上做<a href=https://zh.wikipedia.org/wiki/%E6%A0%91%E6%97%8B%E8%BD%AC>右旋转</a>，这样S的左儿子成为S的父亲和N的新兄弟。我们接着交换S和它的新父亲的颜色。所有路径仍有同样数目的黑色节点，但是现在N有了一个黑色兄弟，他的右儿子是红色的，所以我们进入了<strong>情形6</strong>。N和它的父亲都不受这个变换的影响</p><p><img src="https://github.com/mxsm/document/blob/master/image/datastructure/Red-black_tree_delete_case_5.png?raw=true" alt=图解></p><p>​ <strong>情形6</strong>：S是黑色，S的右儿子是红色，而N是它父亲的左儿子。在这种情形下我们在N的父亲上做左旋转，这样S成为N的父亲（P）和S的右儿子的父亲。我们接着交换N的父亲和S的颜色，并使S的右儿子为黑色。子树在它的根上的仍是同样的颜色，所以性质3没有被违反。但是，N现在增加了一个黑色祖先：要么N的父亲变成黑色，要么它是黑色而S被增加为一个黑色祖父。所以，通过N的路径都增加了一个黑色节点。</p><p>此时，如果一个路径不通过N，则有两种可能性：</p><ul><li>它通过N的新兄弟。那么它以前和现在都必定通过S和N的父亲，而它们只是交换了颜色。所以路径保持了同样数目的黑色节点。</li><li>它通过N的新叔父，S的右儿子。那么它以前通过S、S的父亲和S的右儿子，但是现在只通过S，它被假定为它以前的父亲的颜色，和S的右儿子，它被从红色改变为黑色。合成效果是这个路径通过了同样数目的黑色节点。</li></ul><p>在任何情况下，在这些路径上的黑色节点数目都没有改变。所以我们恢复了性质4。在示意图中的白色节点可以是红色或黑色，但是在变换前后都必须指定相同的颜色</p><p><img src="https://github.com/mxsm/document/blob/master/image/datastructure/Red-black_tree_delete_case_6.png?raw=true" alt=图解></p></div><div class=td-content style=page-break-before:always><h1 id=pg-090364dd405b90a6c7c191a20498d139>8 - 算法</h1></div><div class=td-content><h1 id=pg-6e35430cee89ef0ca47e69f2f0ae158b>8.1 - 排序算法</h1></div><div class=td-content><h1 id=pg-b3794a05f355f8ecc97b5e9806758a50>8.1.1 - 冒泡排序</h1><p>一起养成写作习惯！这是我参与「掘金日新计划 · 4 月更文挑战」的第17天，<a href=https://juejin.cn/post/7080800226365145118>点击查看活动详情</a>。</p><h3 id=1-冒泡排序bubble-sort>1. 冒泡排序(Bubble Sort)</h3><p>冒泡排序是一种简单的排序算法。它重复地走访过要排序的数列，一次比较两个元素，如果它们的顺序错误就把它们交换过来。走访数列的工作是重复地进行直到没有再需要交换，也就是说该数列已经排序完成。这个算法的名字由来是因为越小的元素会经由交换慢慢“浮”到数列的顶端。</p><ul><li><p><strong>算法描述</strong></p><ul><li>比较相邻的两个元素。如果第一个比第二个大，就交换两个的位置。</li><li>对每一个相邻元素进行同样的工作，从开始第一对到结尾最后一对。这样在最后的元素应该会是最大数。</li><li>针对所有的元素重复以上的步骤，除了最后一个</li><li>重复以上三个步骤直到完成排序</li></ul><p><strong>上面的排序方式是顺序排序(从小到大排序)，倒序排序就是假定第一个为最小的然后做交换。</strong></p></li><li><p><strong>动图演示</strong></p><p><img src="https://github.com/mxsm/document/blob/master/image/arithmetic/sort/%E5%86%92%E6%B3%A1%E6%8E%92%E5%BA%8F%E5%8A%A8%E5%9B%BE%E6%BC%94%E7%A4%BA.gif?raw=true" alt=图解></p></li></ul><p>冒泡排序的本质：根据事先设定的条件对相邻两个数据的交换。</p><h3 id=2-java代码实现>2. Java代码实现</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BubbleSort</span> <span style=color:#ce5c00;font-weight:700>{</span>


    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>bubbleSortASC</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>){</span>

        <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>--</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>temp</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>j</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>j</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>){</span>
              <span style=color:#8f5902;font-style:italic>//升序的控制条件
</span><span style=color:#8f5902;font-style:italic></span>               <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>temp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>]){</span>
                   <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>];</span>
                   <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>temp</span><span style=color:#ce5c00;font-weight:700>;</span>
               <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>bubbleSortDESC</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>){</span>

        <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>--</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>temp</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>j</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>j</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>){</span>
              	<span style=color:#8f5902;font-style:italic>//倒序的控制条件
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>temp</span> <span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>]){</span>
                    <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>];</span>
                    <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>temp</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>array</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>];</span>

        <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>random</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>20</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#000>bubbleSortDESC</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>代码的关键：相邻两个数据的大小相比来确定是降序还是升序。</p><h3 id=3-总结>3. 总结</h3><ul><li><strong>主要是两个for循环来控制每一次对比</strong></li><li><strong>前后两个值的大小判断来控制倒序还是逆序</strong></li></ul><blockquote><p>我是蚂蚁背大象，文章对你有帮助点赞关注我，文章有不正确的地方请您斧正留言评论~谢谢！</p></blockquote><p><strong>参考资料：</strong></p><ul><li><a href=https://visualgo.net/en/sorting>https://visualgo.net/en/sorting</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-62835df1451a381a241acde6c0e15b97>8.1.2 - 排序算法</h1><h3 id=排序算法分类>排序算法分类</h3><p>十种常见排序算法可以分为两大类：</p><ul><li><p><strong>比较类排序</strong></p><p>通过比较来决定元素间的相对次序，由于其时间复杂度不能突破O(nlogn)，因此也称为非线性时间比较类排序。</p></li><li><p><strong>非比较类排序</strong></p><p>不通过比较来决定元素间的相对次序，它可以突破基于比较排序的时间下界，以线性时间运行，因此也称为线性时间非比较类排序。</p></li></ul><p><img src="https://github.com/mxsm/document/blob/master/image/arithmetic/sort/%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95%E5%88%86%E7%B1%BB%E8%AF%B4%E6%98%8E%E5%9B%BE.png?raw=true" alt=图></p><h3 id=排序算法的复杂度>排序算法的复杂度</h3><p><img src=https://images2018.cnblogs.com/blog/849589/201804/849589-20180402133438219-1946132192.png alt=圖></p></div><div class=td-content style=page-break-before:always><h1 id=pg-38500cbb1c4e42b688afa8f96e2b8aca>8.1.3 - 归并排序</h1><h3 id=归并排序merge-sort>归并排序(Merge Sort)</h3><p>归并排序是建立在归并操作上的一种有效的排序算法。该算法是采用分治法（Divide and Conquer）的一个非常典型的应用。将已有序的子序列合并，得到完全有序的序列；即先使每个子序列有序，再使子序列段间有序。若将两个有序表合并成一个有序表，称为2-路归并。</p><blockquote><p>归并排序（MERGE-SORT）是利用归并的实现实现的一种排序方法。该算法采用经典的分治(divide-and-conquer)策略(分治法将问题<strong>分</strong>(divide)成一些小的问题然后递归求解，而**治(conquer)**的阶段则将分的阶段得到的各答案"修补"在一起，即分而治之)</p></blockquote><p><strong>分治：</strong></p><p><img src="https://github.com/mxsm/document/blob/master/image/arithmetic/sort/%E5%BD%92%E5%B9%B6%E6%8E%92%E5%BA%8F%E5%88%86%E8%80%8C%E6%B2%BB%E4%B9%8B%E7%9A%84%E6%80%9D%E6%83%B3%E5%9B%BE%E8%A7%A3.png?raw=true" alt=图解></p><p>可以看到这种结构很像一棵完全二叉树，本文的归并排序我们采用递归去实现（也可采用迭代的方式去实现）。<strong>分</strong>阶段可以理解为就是递归拆分子序列的过程，递归深度为log2n</p><p><strong>合并相邻的子序列：</strong></p><p>再来看看<strong>治</strong>阶段，我们需要将两个已经有序的子序列合并成一个有序序列，比如上图中的最后一次合并，要将[4,5,7,8]和[1,2,3,6]两个已经有序的子序列，合并为最终序列[1,2,3,4,5,6,7,8]，来看下实现步骤。</p><p><img src="https://github.com/mxsm/document/blob/master/image/arithmetic/sort/%E5%BD%92%E5%B9%B6%E6%8E%92%E5%BA%8F%E5%90%88%E5%B9%B6%E7%9B%B8%E9%82%BB%E5%AD%90%E5%BA%8F%E5%88%97%E5%9B%BE%E8%A7%A3.png?raw=true" alt=图解></p><p><img src="https://github.com/mxsm/document/blob/master/image/arithmetic/sort/%E5%BD%92%E5%B9%B6%E6%8E%92%E5%BA%8F%E5%90%88%E5%B9%B6%E7%9B%B8%E9%82%BB%E5%AD%90%E5%BA%8F%E5%88%97%E5%9B%BE%E8%A7%A32.png?raw=true" alt=图解></p><ul><li><p><strong>算法描述</strong></p><ul><li>把长度为n的输入序列分成两个长度为n/2的子序列</li><li>对这两个子序列分别采用归并排序</li><li>将两个排序好的子序列合并成一个最终的排序序列</li></ul></li><li><p><strong>动态图演示</strong></p><p><img src="https://github.com/mxsm/document/blob/master/image/arithmetic/sort/%E5%BD%92%E5%B9%B6%E6%8E%92%E5%BA%8F%E5%8A%A8%E6%80%81%E5%9B%BE%E6%BC%94%E7%A4%BA.gif?raw=true" alt=图解></p></li><li><p><strong>Java代码实现</strong>、</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MergeSort</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>mergeSort</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>){</span>

        <span style=color:#000>mergeSort</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>]);</span>

    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>mergeSort</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>end</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>temp</span><span style=color:#ce5c00;font-weight:700>){</span>

        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>end</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>mid</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span> <span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>end</span><span style=color:#ce5c00;font-weight:700>)/</span><span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>//处理左边
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>mergeSort</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>mid</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>temp</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>//处理右边
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>mergeSort</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>mid</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>end</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>temp</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>//归并操作
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>merge</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mid</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>end</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>temp</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>//治函数也就是合并的子序列的函数
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span>  <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>merge</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>mid</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>end</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>temp</span><span style=color:#ce5c00;font-weight:700>){</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//左序列起始指针
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>j</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mid</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//右序列起始指针
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//临时数组指针
</span><span style=color:#8f5902;font-style:italic></span>
        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span><span style=color:#000>mid</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>j</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>end</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#8f5902;font-style:italic>//决定排序的方式
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]&lt;</span><span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>]){</span>
                <span style=color:#000>temp</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>++]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++];</span>
            <span style=color:#ce5c00;font-weight:700>}</span><span style=color:#204a87;font-weight:700>else</span><span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>temp</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>++]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>++];</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//处理剩下的
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>while</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>&lt;=</span><span style=color:#000>mid</span><span style=color:#ce5c00;font-weight:700>){</span><span style=color:#8f5902;font-style:italic>//将左边剩余元素填充进temp中
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>temp</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>++]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++];</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>while</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>&lt;=</span><span style=color:#000>end</span><span style=color:#ce5c00;font-weight:700>){</span><span style=color:#8f5902;font-style:italic>//将右序列剩余元素填充进temp中
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>temp</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>++]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>++];</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>//排序完成分段的数据
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>end</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>++]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>temp</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>++];</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>array</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>];</span>

        <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>random</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>20</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>mergeSort</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-2f05a743566e6c750d0be3cd5e0972fd>8.1.4 - 希尔排序</h1><h3 id=希尔排序shell-sort>希尔排序(Shell Sort)</h3><p><strong>希尔排序是把记录按下标的一定增量分组，对每组使用直接插入排序算法排序；随着增量逐渐减少，每组包含的关键词越来越多，当增量减至1时，整个文件恰被分成一组，算法便终止。</strong></p><ul><li><p><strong>算法描述</strong></p><p>先将整个待排序的记录序列分割成为若干子序列分别进行直接插入排序，具体算法描述：</p><ul><li>选择一个增量序列t1，t2，…，tk，其中ti>tj，tk=1</li><li>按增量序列个数k，对序列进行k 趟排序</li><li>每趟排序，根据对应的增量ti，将待排序列分割成若干长度为m 的子序列，分别对各子表进行直接插入排序。仅增量因子为1 时，整个序列作为一个表来处理，表长度即为整个序列的长度</li></ul></li><li><p><strong>动态演示</strong></p><p><img src="https://github.com/mxsm/document/blob/master/image/arithmetic/sort/%E5%B8%8C%E5%B0%94%E6%8E%92%E5%BA%8F%E5%8A%A8%E6%80%81%E5%9B%BE%E8%A7%A3.gif?raw=true" alt=图解></p><p><img src="https://github.com/mxsm/document/blob/master/image/arithmetic/sort/%E5%B8%8C%E5%B0%94%E6%8E%92%E5%BA%8F%E5%9B%BE%E8%A7%A3.png?raw=true" alt=图解></p></li><li><p><strong>Java代码实现</strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ShellSort</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>shellSort</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>){</span>

        <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>gap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>gap</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>gap</span> <span style=color:#ce5c00;font-weight:700>/=</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>gap</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>){</span>
                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>j</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>temp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>];</span>
                <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>gap</span><span style=color:#ce5c00;font-weight:700>]){</span>
                    <span style=color:#204a87;font-weight:700>while</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>gap</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>temp</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>gap</span><span style=color:#ce5c00;font-weight:700>]){</span>
                        <span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>gap</span><span style=color:#ce5c00;font-weight:700>];</span>
                        <span style=color:#000>j</span> <span style=color:#ce5c00;font-weight:700>-=</span> <span style=color:#000>gap</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>temp</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>array</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>];</span>

        <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>random</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>100</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>shellSort</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-1ad6d68c98ce88e48a6d6566c0d6edfe>8.1.5 - 快速排序</h1><h3 id=快速排序quick-sort>快速排序(Quick Sort)</h3><p>快速排序由C. A. R. Hoare在1962年提出。它的基本思想是：通过一趟排序将要排序的数据分割成独立的两部分，其中一部分的所有数据都比另外一部分的所有数据都要小，然后再按此方法对这两部分数据分别进行快速排序，整个排序过程可以递归进行，以此达到整个数据变成有序序列。</p><ul><li><p><strong>算法描述</strong></p><p>快速排序使用分治法来把一个串（list）分为两个子串（sub-lists）。具体算法描述如下：</p><ul><li>从数列中挑出一个元素，称为 “基准”（pivot）</li><li>重新排序数列，所有元素比基准值小的摆放在基准前面，所有元素比基准值大的摆在基准的后面（相同的数可以到任一边）。在这个分区退出之后，该基准就处于数列的中间位置。这个称为分区（partition）操作</li><li>递归地（recursive）把小于基准值元素的子数列和大于基准值元素的子数列排序</li></ul><p><img src="https://github.com/mxsm/document/blob/master/image/arithmetic/sort/%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F%E5%9B%BE%E7%A4%BA1.png?raw=true" alt=图解></p><p><img src="https://github.com/mxsm/document/blob/master/image/arithmetic/sort/%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F%E5%9B%BE%E7%A4%BA2.png?raw=true" alt=图解></p><p><img src="https://github.com/mxsm/document/blob/master/image/arithmetic/sort/%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F%E5%9B%BE%E7%A4%BA3.png?raw=true" alt=图解></p><p><img src="https://github.com/mxsm/document/blob/master/image/arithmetic/sort/%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F%E5%9B%BE%E7%A4%BA4.png?raw=true" alt=图解></p><p><img src="https://github.com/mxsm/document/blob/master/image/arithmetic/sort/%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F%E5%9B%BE%E7%A4%BA5.png?raw=true" alt=图解></p><p><img src="https://github.com/mxsm/document/blob/master/image/arithmetic/sort/%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F%E5%9B%BE%E7%A4%BA6.png?raw=true" alt=图解></p><p><img src="https://github.com/mxsm/document/blob/master/image/arithmetic/sort/%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F%E5%9B%BE%E7%A4%BA7.png?raw=true" alt=图解></p><p><img src="https://github.com/mxsm/document/blob/master/image/arithmetic/sort/%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F%E5%9B%BE%E7%A4%BA8.png?raw=true" alt=图解></p></li><li><p><strong>动态图演示</strong></p><p><img src="https://github.com/mxsm/document/blob/master/image/arithmetic/sort/%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F%E5%8A%A8%E6%80%81%E5%9B%BE%E6%BC%94%E7%A4%BA.gif?raw=true" alt=图解></p></li><li><p><strong>Java代码实现</strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>QuickSort</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>quickSort</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>){</span>
        <span style=color:#000>quickSort1</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>



    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>quickSort1</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>){</span>

        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>left</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>j</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>temp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#8f5902;font-style:italic>//从右往左找到小于6的
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>temp</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>){</span>
                <span style=color:#ce5c00;font-weight:700>--</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#8f5902;font-style:italic>//从左往右找到大于6的
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>temp</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>){</span>
                <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#8f5902;font-style:italic>//交换
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>){</span>
                <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>];</span>
                <span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>];</span>
                <span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>temp</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#000>quickSort1</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>quickSort1</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#ce5c00;font-weight:700>}</span>



    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>array</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>];</span>

        <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>random</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>100</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>quickSort</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-735b608d61481fddcb9e9ede7da09b05>8.1.6 - 选择排序</h1><h3 id=选择排序selection-sort>选择排序(Selection Sort)</h3><p>选择排序(Selection-sort)是一种简单直观的排序算法。它的工作原理：<strong>首先在未排序序列中找到最小（大）元素，存放到排序序列的起始位置，然后，再从剩余未排序元素中继续寻找最小（大）元素，然后放到已排序序列的末尾。以此类推，直到所有元素均排序完毕。</strong></p><ul><li><p><strong>算法描述</strong></p><p>n个记录的直接选择排序可经过n-1趟直接选择排序得到有序结果。具体算法描述如下：</p><ul><li>初始状态：无序区为R[1..n]，有序区为空；</li><li>第i趟排序(i=1,2,3…n-1)开始时，当前有序区和无序区分别为R[1..i-1]和R(i..n）。该趟排序从当前无序区中-选出关键字最小的记录 R[k]，将它与无序区的第1个记录R交换，使R[1..i]和R[i+1..n)分别变为记录个数增加1个的新有序区和记录个数减少1个的新无序区；</li><li>n-1趟结束，数组有序化了。</li></ul></li><li><p><strong>动态演示</strong></p><p><img src="https://github.com/mxsm/document/blob/master/image/arithmetic/sort/%E9%80%89%E6%8B%A9%E6%8E%92%E5%BA%8F%E5%8A%A8%E6%80%81%E5%9B%BE.gif?raw=true" alt=图解></p></li><li><p><strong>Java代码实现</strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SelectionSort</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span>  <span style=color:#000>selectionSortASC</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>){</span>

       <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>){</span>
           <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>];</span>
           <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>;</span>
           <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>j</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>j</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>){</span>
               <span style=color:#8f5902;font-style:italic>//升序条件判断
</span><span style=color:#8f5902;font-style:italic></span>               <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>current</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>]){</span>
                   <span style=color:#000>current</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>];</span>
                   <span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>;</span>
               <span style=color:#ce5c00;font-weight:700>}</span>
           <span style=color:#ce5c00;font-weight:700>}</span>
           <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>temp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>];</span>
           <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>];</span>
           <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>temp</span><span style=color:#ce5c00;font-weight:700>;</span>
       <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span>  <span style=color:#000>selectionSortDESC</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>){</span>

        <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>];</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>j</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>j</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>){</span>
               <span style=color:#8f5902;font-style:italic>////降序条件判断
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>current</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>]){</span>
                    <span style=color:#000>current</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>];</span>
                    <span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>temp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>];</span>
            <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>];</span>
            <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>temp</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>array</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>];</span>

        <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>random</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>20</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>selectionSortASC</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li></ul><h3 id=总结>总结</h3><ul><li>表现最稳定的排序算法之一，因为无论什么数据进去都是O(n2)的时间复杂度，所以用到它的时候，数据规模越小越好。唯一的好处可能就是不占用额外的内存空间了吧。理论上讲，选择排序可能也是平时排序一般人想到的最多的排序方法了吧。</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-f21220cdadaf1a797011cad847878ed7>8.1.7 - 插入排序</h1><h3 id=插入排序insertion-sort>插入排序(Insertion Sort)</h3><p>插入排序（Insertion-Sort）的算法描述是一种简单直观的排序算法。它的工作原理是通过构建有序序列，对于未排序数据，在已排序序列中从后向前扫描，找到相应位置并插入。</p><ul><li><p><strong>算法描述</strong></p><p>一般来说，插入排序都采用in-place在数组上实现。具体算法描述如下：</p><ul><li>从第一个元素开始，该元素可以认为已经被排序；</li><li>取出下一个元素，在已经排序的元素序列中从后向前扫描；</li><li>如果该元素（已排序）大于新元素，将该元素移到下一位置；</li><li>重复步骤3，直到找到已排序的元素小于或者等于新元素的位置；</li><li>将新元素插入到该位置后；</li><li>重复步骤2~5。</li></ul></li><li><p><strong>动态演示</strong></p><p><img src="https://github.com/mxsm/document/blob/master/image/arithmetic/sort/%E6%8F%92%E5%85%A5%E6%8E%92%E5%BA%8F%E5%8A%A8%E6%80%81%E5%9B%BE.gif?raw=true" alt=图解></p></li><li><p><strong>Java代码实现</strong></p><pre><code>public class InsertionSort {

  public static void insertionSort(int[] arrays){
        for(int i = 1; i &lt; arrays.length; ++i){
            int preIndex = i - 1;
            int current = arrays[i];
            while (preIndex &gt;= 0 &amp;&amp; arrays[preIndex] &gt; current){
                arrays[preIndex+1] = arrays[preIndex];
                preIndex--;
            }
            arrays[preIndex+1] = current;
        }
    }

    public static void main(String[] args) {
        int[] array = new int[10];

        for(int i = 0; i &lt; 10; ++i){
            array[i] = (int)(Math.random() * 20);
        }
        insertionSort(array);

        for(int item: array){
            System.out.println(item);
        }
    }
}
</code></pre></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-876b05e357fd8c99a0d1c64c94267c15>8.2 - 五大基本算法</h1><p><img src="https://github.com/mxsm/picture/blob/main/algorithm/%E4%BA%94%E5%A4%A7%E7%AE%97%E6%B3%95.png?raw=true" alt></p></div><div class=td-content><h1 id=pg-feca5839cfd8a5ba920967fc9e27ac76>8.2.1 - 五大基本算法之动态规划</h1><h3 id=1-动态规划是什么>1. 动态规划是什么？</h3><p>动态规划（Dynamic Programming，DP）是<a href="https://baike.sogou.com/lemma/ShowInnerLink.htm?lemmaId=168782&ss_c=ssc.citiao.link">运筹学</a>的一个分支，是求解决策过程最优化的过程。</p><p>20世纪50年代初，美国数学家贝尔曼（R.Bellman）等人在研究多阶段决策过程的优化问题时，提出了著名的<a href="https://baike.sogou.com/lemma/ShowInnerLink.htm?lemmaId=420583&ss_c=ssc.citiao.link">最优化原理</a>，从而创立了动态规划。动态规划的应用极其广泛，包括工程技术、经济、工业生产、军事以及自动化控制等领域，并在<a href="https://baike.sogou.com/lemma/ShowInnerLink.htm?lemmaId=7898479&ss_c=ssc.citiao.link">背包问题</a>、生产经营问题、资金管理问题、资源分配问题、<a href="https://baike.sogou.com/lemma/ShowInnerLink.htm?lemmaId=1951740&ss_c=ssc.citiao.link">最短路径问题</a>和复杂系统可靠性问题等中取得了显著的效果。</p><p>把多阶段过程转化为一系列单阶段问题，利用各阶段之间的关系，逐个求解，创立了解决这类过程优化问题的新方法——动态规划</p><blockquote><ol><li>动态规划是运筹学一个分支</li><li>将复杂问题简单化(化繁为简)</li><li>适应于多阶段最优化策略问题解决</li></ol></blockquote><p>动态规划过程是：每次决策依赖于当前状态，又随即引起状态的转移。一个决策序列就是在变化的状态中产生出来的，所以，这种多阶段最优化决策解决问题的过程就称为动态规划。</p><h3 id=2-动态规划与递归>2. 动态规划与递归</h3><p>动态规划是自底向上，递归树是自顶向下。为什么动态规划一般都脱离了递归，而是由循环迭代完成计算。</p><h4 id=21-什么叫自顶向下>2.1 什么叫自顶向下？</h4><p>用斐波那契数列来举例子，如果用递归来求解代码如下：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>fibonacci</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>){</span>
        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>//递归停止条件
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>fibonacci</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>fibonacci</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>递归这样的形式就是自顶向下。例如你输入n=8那么先算7和6，一直递归下去到n=1和n=2的情况。</p><h4 id=22-什么叫自底向上>2.2 什么叫自底向上？</h4><p>反过来，我们直接从最底下，最简单，问题规模最小的 f(1) 和 f(2) 开始往上推，直到推到我们想要的答案 f(20)，这就是动态规划的思路，这也是为什么动态规划一般都脱离了递归，而是由循环迭代完成计算。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>fibonacci</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>){</span>
        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>dp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#000>dp</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>dp</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#000>dp</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>dp</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>dp</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>dp</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>];</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=3-力扣例子解析>3. 力扣例子解析</h3><h4 id=31-最小路径和-力扣64>3.1 最小路径和-力扣64</h4><p><a href=https://leetcode-cn.com/problems/minimum-path-sum/>最小路径和-力扣64</a></p><p>状态方程如下：
$$
dp(i,j) = min(dp[i-1][j],dp[i,j-1])+grid[i][j]
$$
左上角到右下角的路径说明只能从上往下走或者从左往右走，
$$
dp[i-1][j]表示从左往右走
$$</p><p>$$
dp[i][j-1]表示从上往下走
$$</p><p>参考文献:</p><ul><li><a href=https://www.cxyxiaowu.com/8536.html>https://www.cxyxiaowu.com/8536.html</a></li><li><a href=https://houbb.github.io/2020/01/23/data-struct-learn-07-base-dp#dynamic-programming>https://houbb.github.io/2020/01/23/data-struct-learn-07-base-dp#dynamic-programming</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-f52df178d3d079d8fafa13604420162f>8.3 - 图遍历</h1><p>图遍历问题分为四类：</p><ul><li>遍历完所有的<a href=https://zh.wikipedia.org/wiki/%E9%82%8A_(%E5%9C%96%E8%AB%96)>边</a>而不能有重复，即所谓“<a href=https://zh.wikipedia.org/wiki/%E6%AC%A7%E6%8B%89%E8%B7%AF%E5%BE%84%E9%97%AE%E9%A2%98>欧拉路径问题</a>”（又名<a href=https://zh.wikipedia.org/wiki/%E4%B8%80%E7%AC%94%E7%94%BB%E9%97%AE%E9%A2%98>一笔画问题</a>）；</li><li>遍历完所有的<a href=https://zh.wikipedia.org/wiki/%E9%A1%B6%E7%82%B9_(%E5%9B%BE%E8%AE%BA)>顶点</a>而没有重复，即所谓“<a href=https://zh.wikipedia.org/wiki/%E5%93%88%E5%AF%86%E9%A0%93%E8%B7%AF%E5%BE%91%E5%95%8F%E9%A1%8C>哈密顿路径问题</a>”。</li><li>遍历完所有的边而可以有重复，即所谓“<a href=https://zh.wikipedia.org/wiki/%E4%B8%AD%E5%9B%BD%E9%82%AE%E9%80%92%E5%91%98%E9%97%AE%E9%A2%98>中国邮递员问题</a>”；</li><li>遍历完所有的顶点而可以重复，即所谓“<a href=https://zh.wikipedia.org/wiki/%E6%97%85%E8%A1%8C%E6%8E%A8%E9%94%80%E5%91%98%E9%97%AE%E9%A2%98>旅行推销员问题</a>”。</li></ul><p>图的遍历方法有<a href=https://zh.wikipedia.org/wiki/%E6%B7%B1%E5%BA%A6%E4%BC%98%E5%85%88%E6%90%9C%E7%B4%A2%E6%B3%95>深度优先搜索法</a>和<a href=https://zh.wikipedia.org/wiki/%E5%B9%BF%E5%BA%A6(%E5%AE%BD%E5%BA%A6)%E4%BC%98%E5%85%88%E6%90%9C%E7%B4%A2%E6%B3%95>广度(宽度)优先搜索法</a>。</p><p>参考资料:</p><ul><li><a href=https://zh.wikipedia.org/wiki/%E5%9B%BE%E7%9A%84%E9%81%8D%E5%8E%86>https://zh.wikipedia.org/wiki/%E5%9B%BE%E7%9A%84%E9%81%8D%E5%8E%86</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-28d7791bc2a0760bad8784aa4f2aa45c>8.3.1 - 深度优先搜索-DFS</h1><h3 id=1-深度优先搜索dfs是什么>1. 深度优先搜索(DFS)是什么？</h3><p>深度优先搜索算法（英语：Depth-First-Search，DFS）是一种用于遍历或搜索树或图的算法。这个算法会尽可能深的搜索树的分支。当节点v的所在边都己被探寻过，搜索将回溯到发现节点v的那条边的起始节点。这一过程一直进行到已发现从源节点可达的所有节点为止。如果还存在未被发现的节点，则选择其中一个作为源节点并重复以上过程，整个进程反复进行直到所有节点都被访问为止。这种算法不会根据图的结构等信息调整执行策略</p><h4 id=11-dfs解决的问题>1.1 DFS解决的问题</h4><p>深度优先搜索是图论中的经典算法，利用深度优先搜索算法可以产生目标图的<a href=https://zh.wikipedia.org/wiki/%E6%8B%93%E6%89%91%E6%8E%92%E5%BA%8F>拓扑排序</a>表，利用拓扑排序表可以方便的解决很多相关的<a href=https://zh.wikipedia.org/wiki/%E5%9B%BE%E8%AE%BA>图论</a>问题，如无权最长路径问题等等。</p><h3 id=2-深度优先搜索的代码实现>2. 深度优先搜索的代码实现</h3><p>用力扣的一道简单的题目<a href=https://leetcode-cn.com/problems/binary-tree-preorder-traversal/>二叉树的前序遍历</a>来说明实现。大家都知道对于二叉树的遍历有两种实现：</p><ul><li>递归实现</li><li>栈实现</li></ul><h4 id=21-深度优先搜索-递归>2.1 深度优先搜索-递归</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>preorderTraversal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TreeNode</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>

        <span style=color:#000>dfs</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>dfs</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TreeNode</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>val</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>dfs</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>dfs</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=22-深度优先搜索-栈>2.2 深度优先搜索-栈</h4><pre><code>    public List&lt;Integer&gt; preorderTraversal(TreeNode root) {
        List&lt;Integer&gt; result = new ArrayList&lt;&gt;();
        if(null == root){
            return result;
        }
        Stack&lt;TreeNode&gt; stack = new Stack&lt;&gt;();
        stack.push(root);
        while(!stack.isEmpty()){
            TreeNode pop = stack.pop();
            result.add(pop.val);
            if(pop.right != null){
                stack.add(pop.right);
            }
            if(pop.left != null){
                stack.add(pop.left);
            }
        }
        return result;
    }
</code></pre><p>参考文档:</p><ul><li><a href=https://zh.wikipedia.org/wiki/%E6%B7%B1%E5%BA%A6%E4%BC%98%E5%85%88%E6%90%9C%E7%B4%A2>https://zh.wikipedia.org/wiki/%E6%B7%B1%E5%BA%A6%E4%BC%98%E5%85%88%E6%90%9C%E7%B4%A2</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-36e33cd7ef4e80e065f355ebd2c5790d>8.3.2 - 广度优先搜索-BFS</h1><h3 id=1-广度优先搜索dfs是什么>1. 广度优先搜索(DFS)是什么？</h3><p>广度优先搜索算法（英语：Breadth-First Search，缩写为BFS），又译作宽度优先搜索，或横向优先搜索，是一种图形搜索算法。简单的说，BFS是从根节点开始，沿着树的宽度遍历树的节点。如果所有节点均被访问，则算法中止。广度优先搜索的实现一般采用open-closed表。</p><h3 id=2--广度优先搜索的代码实现>2. 广度优先搜索的代码实现</h3><p>从算法的观点，所有因为展开节点而得到的子节点都会被加进一个<a href=https://zh.wikipedia.org/wiki/%E5%85%88%E9%80%B2%E5%85%88%E5%87%BA>先进先出</a>的<a href=https://zh.wikipedia.org/wiki/%E9%98%9F%E5%88%97>队列</a>中。一般的实现里，其邻居节点尚未被检验过的节点会被放置在一个被称为 <em>open</em> 的容器中（例如队列或是<a href=https://zh.wikipedia.org/wiki/%E9%80%A3%E7%B5%90%E4%B8%B2%E5%88%97>链表</a>），而被检验过的节点则被放置在被称为 <em>closed</em> 的容器中。（open-closed表）</p><ol><li>首先将根节点放入队列中。</li><li>从队列中取出第一个节点，并检验它是否为目标。<ul><li>如果找到目标，则结束搜索并回传结果。</li><li>否则将它所有尚未检验过的直接子节点加入队列中。</li></ul></li><li>若队列为空，表示整张图都检查过了——亦即图中没有欲搜索的目标。结束搜索并回传“找不到目标”。</li><li>重复步骤2。</li></ol><p>以力扣的上面的 <a href=https://leetcode-cn.com/problems/binary-tree-level-order-traversal/>二叉树的层序遍历</a> 为例子：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>levelOrder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TreeNode</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
    <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>){</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>Queue</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>queue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
    <span style=color:#000>queue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>do</span><span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>it</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>currentLevelSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>queue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>currentLevelSize</span><span style=color:#ce5c00;font-weight:700>;++</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#000>TreeNode</span> <span style=color:#000>poll</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>queue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>poll</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>it</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>val</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>){</span>
                <span style=color:#000>queue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>){</span>
                <span style=color:#000>queue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span><span style=color:#ce5c00;font-weight:700>);</span>
             <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>it</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span><span style=color:#204a87;font-weight:700>while</span><span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>queue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>());</span>
    
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>参考文档:</p><ul><li><a href=https://zh.wikipedia.org/wiki/%E6%B7%B1%E5%BA%A6%E4%BC%98%E5%85%88%E6%90%9C%E7%B4%A2>https://zh.wikipedia.org/wiki/%E6%B7%B1%E5%BA%A6%E4%BC%98%E5%85%88%E6%90%9C%E7%B4%A2</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-cebc6b122c30d87786a63800a65ec6c4>9 - 设计模式</h1><h3 id=设计模式>设计模式</h3><p>参考资料：</p><ul><li><a href=https://refactoringguru.cn/>设计模式</a></li></ul></div><div class=td-content><h1 id=pg-376a1b92b0507ae2078343d7d408095b>9.1 - 创建模式</h1><p>创建型模式提供了创建对象的机制， 能够提升已有代码的灵活性和可复用性。</p><p><img src="https://github.com/mxsm/picture/blob/main/designmode/%E5%88%9B%E5%BB%BA%E8%80%85%E6%A8%A1%E5%BC%8F.png?raw=true" alt></p></div><div class=td-content><h1 id=pg-24b630be7e6d0a9add2d0b66fe64082c>9.1.1 - 抽象工厂模式</h1><h3 id=抽象工厂模式abstract-factory>抽象工厂模式(Abstract Factory)</h3><h4 id=模式动机>模式动机</h4><ul><li><p>在工厂方法模式中具体工厂负责生产具体的产品，每一个具体工厂对应一种具体产品，工厂方法也具有唯一性，一般情况下，一个具体工厂中只有一个工厂方法或者一组重载的工厂方法。但是有时候我们需要一个工厂可以提供多个产品对象，而不是单一的产品对象。</p><blockquote><p>为了更清晰地理解工厂方法模式，需要先引入两个概念：</p><ul><li><strong>产品等级结构</strong> ：产品等级结构即产品的继承结构，如一个抽象类是电视机，其子类有海尔电视机、海信电视机、TCL电视机，则抽象电视机与具体品牌的电视机之间构成了一个产品等级结构，抽象电视机是父类，而具体品牌的电视机是其子类。</li><li><strong>产品族</strong> ：在抽象工厂模式中，产品族是指由同一个工厂生产的，位于不同产品等级结构中的一组产品，如海尔电器工厂生产的海尔电视机、海尔电冰箱，海尔电视机位于电视机产品等级结构中，海尔电冰箱位于电冰箱产品等级结构中。</li></ul></blockquote></li><li><p>当系统所提供的工厂所需生产的具体产品并不是一个简单的对象，而是多个位于不同产品等级结构中属于不同类型的具体产品时需要使用抽象工厂模式。</p></li><li><p>抽象工厂模式是所有形式的工厂模式中最为抽象和最具一般性的一种形态。</p></li><li><p>抽象工厂模式与工厂方法模式最大的区别在于，工厂方法模式针对的是一个产品等级结构，而抽象工厂模式则需要面对多个产品等级结构，一个工厂等级结构可以负责多个不同产品等级结构中的产品对象的创建 。当一个工厂等级结构可以创建出分属于不同产品等级结构的一个产品族中的所有对象时，抽象工厂模式比工厂方法模式更为简单、有效率。</p></li></ul><h4 id=模式定义>模式定义</h4><p>抽象工厂模式(Abstract Factory Pattern)：提供一个创建一系列相关或相互依赖对象的接口，而无须指定它们具体的类。抽象工厂模式又称为Kit模式，属于对象创建型模式。</p><p><strong>抽象工厂是生产一整套有产品的（至少要生产两个产品)，这些产品必须相互是有关系或有依赖的，而工厂方法中的工厂是生产单一产品的工厂。</strong></p><p>抽象工厂模式包含如下角色：</p><ul><li>AbstractFactory：抽象工厂</li><li>ConcreteFactory：具体工厂</li><li>AbstractProduct：抽象产品</li><li>Product：具体产品</li></ul><p>UML类图：</p><p><img src="https://github.com/mxsm/document/blob/master/image/designmode/AbstractFactory.png?raw=true" alt=图></p><p>产品A和产品B之间还有关联</p></div><div class=td-content style=page-break-before:always><h1 id=pg-e759425ba3d122b481d9b50147a09d97>9.1.2 - 工厂方法模式</h1><h3 id=工厂方法模式factory-method-pattern>工厂方法模式(Factory Method Pattern)</h3><h4 id=模式动机>模式动机</h4><p>一类产品对应一类工厂</p><h4 id=模式定义>模式定义</h4><p>工厂方法模式(Factory Method Pattern)又称为工厂模式，也叫虚拟构造器(Virtual Constructor)模式或者多态工厂(Polymorphic Factory)模式，它属于类创建型模式。在工厂方法模式中，工厂父类负责定义创建产品对象的公共接口，而工厂子类则负责生成具体的产品对象，这样做的目的是将产品类的实例化操作延迟到工厂子类中完成，即通过工厂子类来确定究竟应该实例化哪一个具体产品类。</p><h4 id=模式结构>模式结构</h4><ul><li>Product：抽象产品</li><li>ConcreteProduct：具体产品</li><li>Factory：抽象工厂</li><li>ConcreteFactory：具体工厂</li></ul><p>类的UML图：</p><p><img src="https://github.com/mxsm/document/blob/master/image/designmode/FactoryMethodPattern.png?raw=true" alt=图></p></div><div class=td-content style=page-break-before:always><h1 id=pg-40f79de50d94dea1afc39110713e0025>9.1.3 - 建造者模式</h1><h3 id=建造者模式>建造者模式</h3><h4 id=模式定义>模式定义</h4><p>造者模式(Builder Pattern)：将一个复杂对象的构建与它的表示分离，使得同样的构建过程可以创建不同的表示。建造者模式是一步一步创建一个复杂的对象，它允许用户只通过指定复杂对象的类型和内容就可以构建它们，用户不需要知道内部的具体构建细节。建造者模式属于对象创建型模式。根据中文翻译的不同，建造者模式又可以称为生成器模式。</p><h4 id=代码参照>代码参照</h4><ul><li><p><strong>jetcd的Client</strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Client</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AutoCloseable</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#000>Auth</span> <span style=color:#000>getAuthClient</span><span style=color:#ce5c00;font-weight:700>();</span>

  <span style=color:#000>KV</span> <span style=color:#000>getKVClient</span><span style=color:#ce5c00;font-weight:700>();</span>

  <span style=color:#000>Cluster</span> <span style=color:#000>getClusterClient</span><span style=color:#ce5c00;font-weight:700>();</span>

  <span style=color:#000>Maintenance</span> <span style=color:#000>getMaintenanceClient</span><span style=color:#ce5c00;font-weight:700>();</span>

  <span style=color:#000>Lease</span> <span style=color:#000>getLeaseClient</span><span style=color:#ce5c00;font-weight:700>();</span>

  <span style=color:#000>Watch</span> <span style=color:#000>getWatchClient</span><span style=color:#ce5c00;font-weight:700>();</span>

  <span style=color:#000>Lock</span> <span style=color:#000>getLockClient</span><span style=color:#ce5c00;font-weight:700>();</span>

  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>();</span>

  <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>ClientBuilder</span> <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClientBuilder</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>看一下ClientBuilder的源代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ClientBuilder</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Cloneable</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>URI</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>endpoints</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ByteSequence</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ByteSequence</span> <span style=color:#000>password</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ExecutorService</span> <span style=color:#000>executorService</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>loadBalancerPolicy</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>SslContext</span> <span style=color:#000>sslContext</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>lazyInitialization</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>authority</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>URIResolverLoader</span> <span style=color:#000>uriResolverLoader</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Integer</span> <span style=color:#000>maxInboundMessageSize</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Metadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Key</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>headers</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ClientInterceptor</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>interceptors</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ByteSequence</span> <span style=color:#000>namespace</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ByteSequence</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>EMPTY</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>retryDelay</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>500</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>retryMaxDelay</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>2500</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ChronoUnit</span> <span style=color:#000>retryChronoUnit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ChronoUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MILLIS</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>retryMaxDuration</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#000>ClientBuilder</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * gets the endpoints for the builder.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @return the list of endpoints configured for the builder
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>URI</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>endpoints</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Collections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unmodifiableCollection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>endpoints</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * configure etcd server endpoints.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param  endpoints                etcd server endpoints, at least one
</span><span style=color:#8f5902;font-style:italic>     * @return                          this builder to train
</span><span style=color:#8f5902;font-style:italic>     * @throws NullPointerException     if endpoints is null or one of endpoint is null
</span><span style=color:#8f5902;font-style:italic>     * @throws IllegalArgumentException if some endpoint is invalid
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ClientBuilder</span> <span style=color:#000>endpoints</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>URI</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>endpoints</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>checkNotNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>endpoints</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;endpoints can&#39;t be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>URI</span> <span style=color:#000>endpoint</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>endpoints</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>checkNotNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>endpoint</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;endpoint can&#39;t be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>checkArgument</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>endpoint</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>trim</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;invalid endpoint: endpoint=&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>endpoint</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>endpoints</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>endpoint</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * configure etcd server endpoints.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param  endpoints                etcd server endpoints, at least one
</span><span style=color:#8f5902;font-style:italic>     * @return                          this builder to train
</span><span style=color:#8f5902;font-style:italic>     * @throws NullPointerException     if endpoints is null or one of endpoint is null
</span><span style=color:#8f5902;font-style:italic>     * @throws IllegalArgumentException if some endpoint is invalid
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ClientBuilder</span> <span style=color:#000>endpoints</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>URI</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>endpoints</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>checkNotNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>endpoints</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;endpoints can&#39;t be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>endpoints</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>asList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>endpoints</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ClientBuilder</span> <span style=color:#000>endpoints</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>endpoints</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>endpoints</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Util</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toURIs</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>asList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>endpoints</span><span style=color:#ce5c00;font-weight:700>)));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ByteSequence</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * config etcd auth user.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param  user                 etcd auth user
</span><span style=color:#8f5902;font-style:italic>     * @return                      this builder
</span><span style=color:#8f5902;font-style:italic>     * @throws NullPointerException if user is &lt;code&gt;null&lt;/code&gt;
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ClientBuilder</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ByteSequence</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>checkNotNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;user can&#39;t be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>user</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ByteSequence</span> <span style=color:#000>password</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>password</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * config etcd auth password.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param  password             etcd auth password
</span><span style=color:#8f5902;font-style:italic>     * @return                      this builder
</span><span style=color:#8f5902;font-style:italic>     * @throws NullPointerException if password is &lt;code&gt;null&lt;/code&gt;
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ClientBuilder</span> <span style=color:#000>password</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ByteSequence</span> <span style=color:#000>password</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>checkNotNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>password</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;password can&#39;t be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>password</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>password</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ByteSequence</span> <span style=color:#000>namespace</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>namespace</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * config the namespace of keys used in {@code KV}, {@code Txn}, {@code Lock} and {@code Watch}.
</span><span style=color:#8f5902;font-style:italic>     * &#34;/&#34; will be treated as no namespace.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param  namespace            the namespace of each key used
</span><span style=color:#8f5902;font-style:italic>     * @return                      this builder
</span><span style=color:#8f5902;font-style:italic>     * @throws NullPointerException if namespace is &lt;code&gt;null&lt;/code&gt;
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ClientBuilder</span> <span style=color:#000>namespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ByteSequence</span> <span style=color:#000>namespace</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>checkNotNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>namespace</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;namespace can&#39;t be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>namespace</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>namespace</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ExecutorService</span> <span style=color:#000>executorService</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>executorService</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * config executor service.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param  executorService      executor service
</span><span style=color:#8f5902;font-style:italic>     * @return                      this builder
</span><span style=color:#8f5902;font-style:italic>     * @throws NullPointerException if executorService is &lt;code&gt;null&lt;/code&gt;
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ClientBuilder</span> <span style=color:#000>executorService</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ExecutorService</span> <span style=color:#000>executorService</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>checkNotNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>executorService</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;executorService can&#39;t be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>executorService</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>executorService</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * config load balancer policy.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param  loadBalancerPolicy   etcd load balancer policy
</span><span style=color:#8f5902;font-style:italic>     * @return                      this builder
</span><span style=color:#8f5902;font-style:italic>     * @throws NullPointerException if loadBalancerPolicy is &lt;code&gt;null&lt;/code&gt;
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ClientBuilder</span> <span style=color:#000>loadBalancerPolicy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>loadBalancerPolicy</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>checkNotNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>loadBalancerPolicy</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;loadBalancerPolicy can&#39;t be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>loadBalancerPolicy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>loadBalancerPolicy</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * get the load balancer policy for etcd client.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @return loadBalancerFactory
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>loadBalancerPolicy</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>loadBalancerPolicy</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>lazyInitialization</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>lazyInitialization</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Define if the client has to initialize connectivity and authentication on client constructor
</span><span style=color:#8f5902;font-style:italic>     * or delay it to the first call to a client. Default is false.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param  lazyInitialization true if the client has to lazily perform
</span><span style=color:#8f5902;font-style:italic>     *                            connectivity/authentication.
</span><span style=color:#8f5902;font-style:italic>     * @return                    this builder
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ClientBuilder</span> <span style=color:#000>lazyInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>lazyInitialization</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lazyInitialization</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lazyInitialization</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>SslContext</span> <span style=color:#000>sslContext</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>sslContext</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * SSL/TLS context to use instead of the system default. It must have been configured with {@link
</span><span style=color:#8f5902;font-style:italic>     * GrpcSslContexts}, but options could have been overridden.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param  sslContext the ssl context
</span><span style=color:#8f5902;font-style:italic>     * @return            this builder
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ClientBuilder</span> <span style=color:#000>sslContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SslContext</span> <span style=color:#000>sslContext</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sslContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sslContext</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Configure SSL/TLS context create through {@link GrpcSslContexts#forClient} to use.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param  consumer the SslContextBuilder consumer
</span><span style=color:#8f5902;font-style:italic>     * @return          this builder
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ClientBuilder</span> <span style=color:#000>sslContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Consumer</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>SslContextBuilder</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>consumer</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SSLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>SslContextBuilder</span> <span style=color:#000>builder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>GrpcSslContexts</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forClient</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>consumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>accept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>sslContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>build</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>authority</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>authority</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * The authority used to authenticate connections to servers.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ClientBuilder</span> <span style=color:#000>authority</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>authority</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>authority</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>authority</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>URIResolverLoader</span> <span style=color:#000>uriResolverLoader</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>uriResolverLoader</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ClientBuilder</span> <span style=color:#000>uriResolverLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>URIResolverLoader</span> <span style=color:#000>loader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>uriResolverLoader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>loader</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Integer</span> <span style=color:#000>maxInboundMessageSize</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>maxInboundMessageSize</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Sets the maximum message size allowed for a single gRPC frame.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ClientBuilder</span> <span style=color:#000>maxInboundMessageSize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Integer</span> <span style=color:#000>maxInboundMessageSize</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>maxInboundMessageSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>maxInboundMessageSize</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Metadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Key</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>headers</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>headers</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Sets headers to be added to http request headers.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ClientBuilder</span> <span style=color:#000>headers</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Metadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Key</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>headers</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>headers</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>headers</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Sets an header to be added to http request headers.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ClientBuilder</span> <span style=color:#000>header</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>headers</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>headers</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>headers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Metadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>of</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Metadata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ASCII_STRING_MARSHALLER</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ClientInterceptor</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>interceptors</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>interceptors</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Set the interceptors.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ClientBuilder</span> <span style=color:#000>interceptors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ClientInterceptor</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>interceptors</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>interceptors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>interceptors</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Add interceptors.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ClientBuilder</span> <span style=color:#000>interceptor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClientInterceptor</span> <span style=color:#000>interceptor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ClientInterceptor</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>interceptors</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>interceptors</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>interceptors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>interceptors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>interceptor</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>interceptors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>asList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>interceptors</span><span style=color:#ce5c00;font-weight:700>));</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>retryDelay</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>retryDelay</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * The delay between retries.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ClientBuilder</span> <span style=color:#000>retryDelay</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>retryDelay</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>retryDelay</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>retryDelay</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>retryMaxDelay</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>retryMaxDelay</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * The max backing off delay between retries.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ClientBuilder</span> <span style=color:#000>retryMaxDelay</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>retryMaxDelay</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>retryMaxDelay</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>retryMaxDelay</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ChronoUnit</span> <span style=color:#000>retryChronoUnit</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>retryChronoUnit</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * the retries period unit.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ClientBuilder</span> <span style=color:#000>retryChronoUnit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ChronoUnit</span> <span style=color:#000>retryChronoUnit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>retryChronoUnit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>retryChronoUnit</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>retryMaxDuration</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>retryMaxDuration</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * the retries max duration.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ClientBuilder</span> <span style=color:#000>retryMaxDuration</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>retryMaxDuration</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>retryMaxDuration</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>retryMaxDuration</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * build a new Client.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @return               Client instance.
</span><span style=color:#8f5902;font-style:italic>     * @throws EtcdException if client experiences build error.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Client</span> <span style=color:#000>build</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>checkState</span><span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>endpoints</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#4e9a06>&#34;please configure etcd server endpoints before build.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClientImpl</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ClientBuilder</span> <span style=color:#000>copy</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClientBuilder</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clone</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CloneNotSupportedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>EtcdExceptionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toEtcdException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li><li><p><strong>protocol buffer生成的java文件</strong></p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-6f17de29496589b65379e33c7add2fa8>9.1.4 - 简单工厂模式</h1><h3 id=简单工厂模式simple-factory-pattern>简单工厂模式(Simple Factory Pattern)</h3><h4 id=模式的动机>模式的动机</h4><p>根据不同的参数获取不同的对象</p><h4 id=模式定义>模式定义</h4><p>简单工厂模式(Simple Factory Pattern)：又称为静态工厂方法(Static Factory Method)模式，它属于类创建型模式。在简单工厂模式中，可以根据参数的不同返回不同类的实例。简单工厂模式专门定义一个类来负责创建其他类的实例，被创建的实例通常都具有共同的父类。</p><h4 id=模式结构>模式结构</h4><p>包含的角色：</p><ul><li><strong>Factory:工厂角色</strong></li><li><strong>Product：抽象产品角色</strong></li><li><strong>ConcreteProduct：具体产品角色</strong></li></ul><p>类的UML图：</p><p><img src="https://github.com/mxsm/document/blob/master/image/designmode/SimpleFactory.png?raw=true" alt=图></p><p>这个模式适合：</p><ul><li>工厂模式负责创建的对象种类比较少</li><li>客户端只知道传入工厂类的参数不关心如何创建对象。</li></ul><p>JDK中的案例</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//获取字符集
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Charset</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;UTF-8&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>Charset</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;GBK&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  
<span style=color:#8f5902;font-style:italic>//日期
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>DateFormat</span> <span style=color:#000>getDateInstance</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>DateFormat</span> <span style=color:#000>getDateInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>style</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>DateFormat</span> <span style=color:#000>getDateInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>style</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>Locale</span> <span style=color:#000>locale</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#8f5902;font-style:italic>//java的加密技术
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>KeyGenerator</span> <span style=color:#000>keyGen</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>KeyGenerator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;DESede&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-2644f3f07de5207176e7ca9b73f957c0>9.1.5 - 单例模式</h1></div><div class=td-content style=page-break-before:always><h1 id=pg-50e096c6c8d0a3f281ccec816b8c9ea1>9.2 - 结构模式</h1><p>结构型模式介绍如何将对象和类组装成较大的结构， 并同时保持结构的灵活和高效。</p><p><img src="https://github.com/mxsm/picture/blob/main/designmode/%E7%BB%93%E6%9E%84%E6%A8%A1%E5%BC%8F.png?raw=true" alt></p></div><div class=td-content style=page-break-before:always><h1 id=pg-4eeec0bdc3a006fb0b6ac7419084e828>9.3 - 行为模式</h1><p>行为模式负责对象间的高效沟通和职责委派。</p><p><img src="https://github.com/mxsm/picture/blob/main/designmode/%E8%A1%8C%E4%B8%BA%E6%A8%A1%E5%BC%8F.png?raw=true" alt></p></div><div class=td-content><h1 id=pg-17f49ae48771b9df7cdead51dc753900>9.3.1 - 适配器模式</h1></div><div class=td-content style=page-break-before:always><h1 id=pg-05fecb92b9230fd54b405ee6b4a899d3>9.4 - 看懂UML图</h1><h3 id=1-类uml图>1. 类UML图</h3><p><img src="https://github.com/mxsm/document/blob/master/image/designmode/uml_class_struct.jpg?raw=true" alt=图></p><ul><li>车的类图结构为&#171;abstract&#187;(Java可以是interface)，表示车是一个抽象类；</li><li>它有两个继承类：小汽车和自行车；它们之间的关系为实现关系，使用带空心箭头的虚线表示；</li><li>小汽车为与SUV之间也是继承关系，它们之间的关系为泛化关系，使用带空心箭头的实线表示；</li><li>小汽车与发动机之间是组合关系，使用带实心箭头的实线表示；</li><li>学生与班级之间是聚合关系，使用带空心箭头的实线表示；</li><li>学生与身份证之间为关联关系，使用一根实线表示</li><li>学生上学需要用到自行车，与自行车是一种依赖关系，使用带箭头的虚线表示；</li></ul><h3 id=2-类与类之间关系的表示方式>2. 类与类之间关系的表示方式</h3><h4 id=21-关联关系>2.1 关联关系</h4><p>关联关系又可进一步分为单向关联、双向关联和自关联。</p><h5 id=1单向关联>（1）单向关联</h5><p><img src="https://github.com/mxsm/picture/blob/main/designmode/%E5%8D%95%E9%A1%B9%E5%85%B3%E8%81%94.png?raw=true" alt></p><h5 id=2-双向关联>(2) 双向关联</h5><p><img src="https://github.com/mxsm/picture/blob/main/designmode/%E5%8F%8C%E5%90%91%E5%85%B3%E8%81%94.png?raw=true" alt></p><h5 id=3-自关联>(3) 自关联</h5><p><img src="https://github.com/mxsm/picture/blob/main/designmode/%E8%87%AA%E5%85%B3%E8%81%94.png?raw=true" alt></p><h4 id=22-聚合关系>2.2 聚合关系</h4><p><img src="https://github.com/mxsm/picture/blob/main/designmode/%E8%81%9A%E5%90%88%E5%85%B3%E7%B3%BB.png?raw=true" alt></p><h4 id=23-组合关系>2.3 组合关系</h4><p><img src="https://github.com/mxsm/picture/blob/main/designmode/%E7%BB%84%E5%90%88%E5%85%B3%E7%B3%BB.png?raw=true" alt></p><blockquote><p>聚合关系强调是“整体”包含“部分”，但是“部分”可以脱离“整体”而单独存在。组合关系与聚合关系见得最大不同在于：这里的“部分”脱离了“整体”便不复存在。</p></blockquote><h4 id=24-依赖关系>2.4 依赖关系</h4><p><img src="https://github.com/mxsm/picture/blob/main/designmode/%E4%BE%9D%E8%B5%96.png?raw=true" alt></p><h4 id=25-继承关系>2.5 继承关系</h4><p><img src="https://github.com/mxsm/picture/blob/main/designmode/%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB.png?raw=true" alt></p><h4 id=26-接口实现关系>2.6 接口实现关系</h4><p><img src="https://github.com/mxsm/picture/blob/main/designmode/%E6%8E%A5%E5%8F%A3%E5%AE%9E%E7%8E%B0.png?raw=true" alt></p></div><div class=td-content style=page-break-before:always><h1 id=pg-1aca59aba33ca367ec7d4120a9ee45b1>10 - IntelliJ IDEA</h1></div><div class=td-content><h1 id=pg-0e1bd03bcd985b7f9bb31e27786cec42>10.1 - IntelliJ IDEA常用设置</h1><h3 id=1-设置代码的格式显示>1. 设置代码的格式显示</h3><p>idea 中 大于等于，不等于、小于等于等等这些符号发生了改变问题解决方法</p><p><img src="https://github.com/mxsm/picture/blob/main/idea/%E8%AE%BE%E7%BD%AE%E7%AC%A6%E5%8F%B7%E6%98%BE%E7%A4%BA%E6%A0%BC%E5%BC%8F1.png?raw=true" alt></p><h3 id=2-idea设置方法自动显示参数提示>2. IDEA设置方法自动显示参数提示</h3><p>增加构造函数的多个提示</p><p><img src="https://github.com/mxsm/picture/blob/main/idea/IDEA%E8%AE%BE%E7%BD%AE%E6%96%B9%E6%B3%95%E8%87%AA%E5%8A%A8%E6%98%BE%E7%A4%BA%E5%8F%82%E6%95%B0%E6%8F%90%E7%A4%BA.png?raw=true" alt></p><h3 id=3-自动导入包的设置>3. 自动导入包的设置</h3><p><img src="https://github.com/mxsm/picture/blob/main/idea/%E8%87%AA%E5%8A%A8%E5%AF%BC%E5%8C%85%E8%AE%BE%E7%BD%AE.png?raw=true" alt></p></div><div class=td-content style=page-break-before:always><h1 id=pg-3145767a18767487b291575dc4617873>10.2 - IntelliJ IDEA那些不常用但很有用技巧</h1><p>IntelliJ IDEA作为开发工具的一霸这个是没有争议的，作为一个Java开发者用习惯了这个软件就没办法用其他的了(正版有点小贵)，今天来说一下我自己在使用IntelliJ IDEA中一些小的功能和技巧，不常用但是很有用的技巧</p><h3 id=1-debug断点按条件过滤>1. Debug断点按条件过滤</h3><p>想必大家肯定会遇到这样的情况，例如：一个for循环从0到100，但是我观察的时候可能需要只需要观察30这个数值的后续操作。一般的人操作如下图：</p><p><img src=C:%5CUsers%5Cmxsm%5CDesktop%5Cpic%5Cdebug1.gif alt=debug1></p><p>就会不停的按F8进行下一步。但是在IDEA中有一个Debug的小技巧就是在断点处右键出现下图所示：</p><p><img src=C:%5CUsers%5Cmxsm%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220126170446784.png alt=image-20220126170446784></p><p>弹出标号1所示的弹窗，然后你在标号2处就可以增加条件来过滤不符合条件的数据。上图所示的条件表示：i等于30的时候匹配到断点。</p><p><img src=C:%5CUsers%5Cmxsm%5CDesktop%5Cpic%5Cdebug2.gif alt=debug1></p><blockquote><p>Tips: 这里只是一个简单的例子，条件可以根据自己的需要定。当为true的话就会匹配到</p></blockquote><h3 id=2-debug实时插入打印>2. Debug实时插入打印</h3><p>在开发过程Debug程序的时候需要打印一些列数据，但是引入的Jar包又不能修改源码的情况，在IDEA中有一个很好用的功能就能够解决，第一步在需要打印数据的地方右键鼠标：</p><p><img src=C:%5CUsers%5Cmxsm%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220126173648141.png alt=image-20220126173648141></p><p>然后点击 <strong>Add Inline Watch</strong>：</p><p><img src=C:%5CUsers%5Cmxsm%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220126173815363.png alt=image-20220126173815363></p><p>然后确定。接下来我new 一个Date试下</p><p><img src=C:%5CUsers%5Cmxsm%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220126173922182.png alt=image-20220126173922182></p><h3 id=3-一键去除无用导入类>3. 一键去除无用导入类</h3><p>在Java开发中有的时候在一个类中导入类，但是可能又没用到，如果没有良好的习惯一般情况下很多类中都会存在这个情况。一个个去检查渠道很是麻烦，哪怕用快捷键 <strong><code>Ctrl+alt+o</code></strong> （windows，别喷我没有Mac）。 我们可以使用鼠标左键选择要一键清除多余的类的项目或者包都可以。然后使用 <strong><code>Ctrl+alt+o</code></strong> 就可以一键清除下面所有的文件中导入的无用的类。</p><p><img src=C:%5CUsers%5Cmxsm%5CDesktop%5Cpic%5Cdebug3.gif alt=debug3></p><h3 id=4-类的使用处过滤>4. 类的使用处过滤</h3><p>在源码阅读的时候选择某个类然后 <strong><code>Ctrl+左键</code></strong> 就会有弹框出来，显示该类在哪些类中被应用引用了</p><p><img src=C:%5CUsers%5Cmxsm%5CDesktop%5Cpic%5C%E7%B1%BB%E5%BC%95%E7%94%A8.gif alt=类引用></p><p>这里出现了很多一些我们不希望看到的使用的地方，包括测试类等等。可以通过选择下拉来过滤自己的需要</p><p><img src=C:%5CUsers%5Cmxsm%5CDesktop%5Cpic%5C%E7%B1%BB%E5%BC%95%E7%94%A81.gif alt=类引用1></p></div><div class=td-content style=page-break-before:always><h1 id=pg-9366bab765273e7ef4ad0343ffc16a58>11 - 单点登录</h1></div><div class=td-content><h1 id=pg-7bbbadfdfaaf6b67c8838adcab09819e>11.1 - CAS Docker部署</h1><blockquote><p>CAS版本：6.4.5</p></blockquote><h3 id=1-cas-docker镜像拉取>1. CAS Docker镜像拉取</h3><p>Docker进行拉取有两种方式：</p><ul><li><p><strong>直接用命令拉取</strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>docker pull apereo/cas:6.4.5
</code></pre></div><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/other/sso/image-20220202175512114.png alt=image-20220202175512114></p></li><li><p><strong>通过Dockerfile构建</strong></p><ol><li><p>拉取<strong>cas-webapp-docker</strong> 项目</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell> git clone https://github.com/apereo/cas-webapp-docker.git
</code></pre></div><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/other/sso/image-20220202181238894.png alt=image-20220202181238894></p></li><li><p>本地构建镜像</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#204a87>cd</span> cas-webapp-docker
docker build --build-arg <span style=color:#000>cas_version</span><span style=color:#ce5c00;font-weight:700>=</span>6.4 . -t cas/local:6.4
</code></pre></div><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/other/sso/image-20220202185138205.png alt=image-20220202185138205></p><p>或者直接调用</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>./build.sh 6.4
</code></pre></div></li></ol></li></ul><h3 id=2-ssl配置>2. SSL配置</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>keytool -genkeypair -alias cas -keyalg RSA -keypass changeit <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>        -storepass changeit -keystore ./thekeystore <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>        -dname <span style=color:#4e9a06>&#34;CN=cas.ljbmxsm.com,OU=ljbmxsm,OU=com,C=AU&#34;</span> <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>        -ext <span style=color:#000>SAN</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;dns:cas.ljbmxsm.com,dns:localhost,ip:127.0.0.1&#34;</span>
</code></pre></div><h3 id=3-运行cas>3. 运行CAS</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>docker</span> <span style=color:#000>run</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>d</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>p</span> <span style=color:#000>8080</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>8080</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>p</span> <span style=color:#000>8443</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>8443</span> <span style=color:#ce5c00;font-weight:700>--</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;cas&#34;</span> <span style=color:#000>apereo</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>cas</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>v6</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>4</span>
</code></pre></div><p>由于没有在container中有private key所有会报错：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/other/sso/image-20220202204335527.png alt=image-20220202204335527></p><p>将生产的thekeystore复制到容器中</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>docker</span> <span style=color:#000>cp</span> <span style=color:#000>thekeystore</span> <span style=color:#000>cas</span><span style=color:#ce5c00;font-weight:700>:/</span><span style=color:#000>etc</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>cas</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>thekeystore</span>
</code></pre></div><p>然后重启</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>docker restart cas
</code></pre></div><p>查看日志：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>docker logs cas
</code></pre></div><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/other/sso/image-20220202204904231.png alt=image-20220202204904231></p><p>登录地址：https://172.24.174.149:8443/cas/login</p><p>默认登录名密码：casuser/Mellon</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/other/sso/cas%E7%99%BB%E5%BD%95.gif alt=cas登录></p><p>到这里基础环境已经搭建起来了</p></div><div class=td-content style=page-break-before:always><h1 id=pg-3b6fba77103ab4932e501dbb5b00ac81>12 - 开发工具</h1></div><div class=td-content><h1 id=pg-2125a657bd64dc63240a60bd728448d3>12.1 - Arthas使用实践-方法性能调优</h1><p>Arthas由阿里出品，是一个Java 应用诊断利器，功能很多。我们来看一下如何通过Arthas来实现方法的性能调优。</p><blockquote><p>Github地址：https://github.com/alibaba/arthas</p><p>官网地址：https://arthas.aliyun.com/zh-cn/</p></blockquote><h3 id=1-前言>1. 前言</h3><p>平时我们在开发的时候想要输出一个方法的执行时间一般都会有如下代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ArthasServiceImpl</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>testArthas</span><span style=color:#ce5c00;font-weight:700>(){</span>
        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>currentTimeMillis</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>doHandle1</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;方法doHandle1耗时：&#34;</span><span style=color:#ce5c00;font-weight:700>+(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>()-</span><span style=color:#000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>doHandle1</span><span style=color:#ce5c00;font-weight:700>(){</span>
        <span style=color:#000>StringBuilder</span> <span style=color:#000>builder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringBuilder</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>100000</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++){</span>
            <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>增加时间输出打印。这样缺点很明显：</p><ol><li>需要增加额外的代码来打印执行的时间，上线的时候有需要把这些无用的代码去掉</li><li>不同的方法需要多次编写时间打印的代码，繁琐</li></ol><p>下面来如何利用Arthas来实现监控每个方法的代码执行时间</p><h3 id=2-环境准备>2. 环境准备</h3><p>编写一个测试代码然后启动，我这里已Spring Boot的web项目为例</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//编写一个Controller
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#5c35cc;font-weight:700>@RestController</span>
<span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/arthas&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ArthasController</span> <span style=color:#ce5c00;font-weight:700>{</span>

     <span style=color:#5c35cc;font-weight:700>@Autowired</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ArthasServiceImpl</span> <span style=color:#000>arthasService</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@GetMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>arthas</span><span style=color:#ce5c00;font-weight:700>(){</span>
        <span style=color:#000>arthasService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>testArthas</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>//编写一个服务
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#5c35cc;font-weight:700>@Service</span>
<span style=color:#5c35cc;font-weight:700>@Service</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ArthasServiceImpl</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>testArthas</span><span style=color:#ce5c00;font-weight:700>(){</span>
        <span style=color:#000>doHandle1</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>doHandle1</span><span style=color:#ce5c00;font-weight:700>(){</span>
        <span style=color:#000>StringBuilder</span> <span style=color:#000>builder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringBuilder</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>1000000</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++){</span>
            <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div><p>然后启动服务</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/others/developtools/arthas%E6%B5%8B%E8%AF%95%E7%A8%8B%E5%BA%8F%E5%90%AF%E5%8A%A8%E9%AA%8C%E8%AF%81.gif alt=arthas测试程序启动验证></p><h3 id=3-启动arthas>3. 启动Arthas</h3><p>Linux启动方式：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl -O https://arthas.aliyun.com/arthas-boot.jar
java -jar arthas-boot.jar
</code></pre></div><p>Windows启动方式：</p><p>从Github Releases页下载</p><p><a href=https://github.com/alibaba/arthas/releases>https://github.com/alibaba/arthas/releases</a></p><p>在解压后，在文件夹里有<code>arthas-boot.jar</code>，直接用<code>java -jar</code>的方式启动：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>java -jar arthas-boot.jar
</code></pre></div><p>启动如下图：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/others/developtools/arthas%E5%90%AF%E5%8A%A8.gif alt=arthas启动></p><h3 id=4-如何监控方法的执行时间>4. 如何监控方法的执行时间</h3><p><strong>命令</strong>：<strong><code>trace</code></strong></p><p>详细的使用方式可以使用 <strong><code>trace --help</code></strong> 来获取</p><p>例如我需要看一下 <strong>com.github.mxsm.controllerArthasController#arthas</strong> 方法的执行调用链：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>trace com.github.mxsm.controller.ArthasController arthas
或者
trace com.github.mxsm.controller.* *
</code></pre></div><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/others/developtools/arthas-trace%E5%91%BD%E4%BB%A4.gif alt=arthas-trace命令></p><p>通过命令就可以监控到了方法花了多少时间。如果一个方法中调用了多个方法这样就可以对比每一个方法的占用时间。找出占用时间最长的方法。然后对方法进行优化。</p><blockquote><p>Tips: 如果耗时很长的方法中还调用多个方法，只需要监控对应的方法逐个进行分析即可。</p></blockquote><h3 id=5-总结>5. 总结</h3><p>使用Arthas的trace命令的好处：</p><ul><li>可以直接在线上进行方法耗时的测试无需要发版</li><li>能够灵活的观察需要观察的方法，而无效进行编码</li></ul><blockquote><p>文章对你有帮助可以点个赞关注我，你的点赞、关注是我前进的动力，文章有不正确的地方请您斧正留言评论~谢谢！</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-a3a86ab82262e21932a7d11397e80c8d>12.2 -</h1></div><div class=td-content style=page-break-before:always><h1 id=pg-5871a6806b962bc5d80731ad5f2ca911>13 - Windows WSL让你告别VMware</h1><h3 id=1-引言>1. 引言</h3><p>使用Linux几种方式：</p><ul><li><p>Mac</p><p>买一台mac电脑最直接的方式，大多数程序员的不二选择。价格劝退一部分人</p></li><li><p>安装Linux系统</p><p>自己在电脑上装一个Linux系统，像ubuntu这可能就变成了程序员专用了。其他的人用起来可能就不是那么的友好</p></li><li><p>Windows系统安装VMware</p><p>通过安装VMware，然后在VMware中安装Linux系统。(比较好的一种选择)</p></li><li><p>购买云Linux主机</p><p>在各种云大行其道的今天，购买云主机也是一种选择，还能随时随地有网有电脑就能使用</p></li><li><p>Windows WSL</p><p>这个是Windows 10 才有的功能全称：<em><code>Windows Subsystem for Linux</code></em> 。 在windows安装Linux的子系统</p></li></ul><p>下面介绍一下WSL的安装以及使用</p><h3 id=2-如何安装wsl>2. 如何安装WSL</h3><h4 id=21-开启windows的wsl相关设置>2.1 开启Windows的WSL相关设置</h4><p>进入启用或关闭Windows功能</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/java/concurrencemultithreading/image-20220218220155027.png alt=image-20220218220155027></p><p>然后勾选下图1,2两个功能确定：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/java/concurrencemultithreading/image-20220218220422072.png alt></p><h4 id=22-从windows应用商店获取>2.2 从Windows应用商店获取</h4><p>在Windows应用商店搜索WSL</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/java/concurrencemultithreading/%E5%BE%AE%E8%BD%AF%E5%95%86%E5%9F%8E%E6%90%9C%E7%B4%A2.gif alt=微软商城搜索></p><p>ubuntu和Debian都可以选择</p><blockquote><p>Tips： 在最近Oracle在Windows商店上线了Oracle Linux 8.5, 随着Centos8 的维护日期截止。Oracle Linux 也成了替代选择之一</p></blockquote><p>我这里以Oracle Linux 8.5为例子：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/java/concurrencemultithreading/OracleLinux%E4%BE%8B%E5%AD%90.gif alt=OracleLinux例子></p><blockquote><p>Tips: 运行WSL需要看一下对windows的系统要求</p></blockquote><p>等到获取完成然后运行</p><h4 id=23运行wsl>2.3运行WSL</h4><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/java/concurrencemultithreading/OracleLinux%E4%BE%8B%E5%AD%901.gif alt=OracleLinux例子1></p><p>整个就运行完成了。然后可以从Windows Terminal终端进入：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/java/concurrencemultithreading/OracleLinux%E4%BE%8B%E5%AD%902.gif alt=OracleLinux例子2></p><p>我电脑上之前已经安装过了Ubuntu</p><h3 id=3-wsl位置迁移>3. WSL位置迁移</h3><p>WSL在安装好以后，默认放在C盘，但是如果随着你使用的WSL越来越久会有很多文件什么的在系统中，这样会导致大量的C盘空间被占用。所以安装好以后把WSL的数据存放位置放在其他盘。</p><h4 id=31-查看系统中的wsl的版本>3.1 查看系统中的WSL的版本</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#000>wsl</span> <span style=color:#000>-l</span> <span style=color:#000>-v</span>
</code></pre></div><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/java/concurrencemultithreading/image-20220218222306752.png alt=image-20220218222306752></p><h4 id=32-导出对应的发行版本>3.2 导出对应的发行版本</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#000>wsl</span> <span style=color:#000;font-weight:700>-</span><span style=color:#000>-export</span> <span style=color:#000;font-weight:700>&lt;</span><span style=color:#000>分发版</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>&lt;</span><span style=color:#000>导出文件名</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>全路径最好</span><span style=color:#000;font-weight:700>)&gt;</span>

<span style=color:#8f5902;font-style:italic>#例子</span>
<span style=color:#000>wsl</span> <span style=color:#000;font-weight:700>-</span><span style=color:#000>-export</span> <span style=color:#000>OracleLinux_8_5</span> <span style=color:#000>D:</span><span style=color:#000;font-weight:700>\</span><span style=color:#000>OracleLinux_8_5</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tar</span>
</code></pre></div><p>导出的文件类型tar。 例如：D:\xxxx.tar</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/java/concurrencemultithreading/OracleLinux%E4%BE%8B%E5%AD%903.gif alt=OracleLinux例子3></p><h4 id=33-注销导出的分发版>3.3 注销导出的分发版</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#000>wsl</span>  <span style=color:#000;font-weight:700>-</span><span style=color:#000>-unregister</span> <span style=color:#000;font-weight:700>&lt;</span><span style=color:#000>分发版</span><span style=color:#000;font-weight:700>&gt;</span>

<span style=color:#8f5902;font-style:italic>#例子</span>
<span style=color:#000>wsl</span>  <span style=color:#000;font-weight:700>-</span><span style=color:#000>-unregister</span> <span style=color:#000>OracleLinux_8_5</span>
</code></pre></div><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/java/concurrencemultithreading/OracleLinux%E4%BE%8B%E5%AD%904.gif alt=OracleLinux例子4></p><h4 id=34-重新导入导出的分发版>3.4 重新导入导出的分发版</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#000>wsl</span> <span style=color:#000;font-weight:700>-</span><span style=color:#000>-import</span> <span style=color:#000;font-weight:700>&lt;</span><span style=color:#000>分发版</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>&lt;</span><span style=color:#000>安装位置</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>&lt;</span><span style=color:#000>文件名</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>全路径</span><span style=color:#000;font-weight:700>)&gt;</span>
<span style=color:#8f5902;font-style:italic>#例子</span>
<span style=color:#000>wsl</span> <span style=color:#000;font-weight:700>-</span><span style=color:#000>-import</span> <span style=color:#000>OracleLinux_8_5</span> <span style=color:#000>D:</span><span style=color:#000;font-weight:700>\</span><span style=color:#000>wsl</span><span style=color:#000;font-weight:700>\</span><span style=color:#000>OracleLinux_8_5</span> <span style=color:#000>D:</span><span style=color:#000;font-weight:700>\</span><span style=color:#000>OracleLinux_8_5</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tar</span> <span style=color:#000;font-weight:700>-</span><span style=color:#000>-version</span> <span style=color:#000>2</span>
</code></pre></div><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/java/concurrencemultithreading/OracleLinux%E4%BE%8B%E5%AD%905.gif alt=OracleLinux例子5></p><h4 id=35-删除导出版的文件>3.5 删除导出版的文件</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#204a87>del </span> <span style=color:#000>xxx</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tar</span>

<span style=color:#8f5902;font-style:italic>#例子</span>
<span style=color:#204a87>del </span><span style=color:#000>D:</span><span style=color:#000;font-weight:700>\</span><span style=color:#000>OracleLinux_8_5</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tar</span>
</code></pre></div><blockquote><p>Tips: 导入任何 Linux 分发版可以参照https://docs.microsoft.com/zh-cn/windows/wsl/use-custom-distro，这个讲述如何使用Docker来导入。我用了一下感觉不是很好用，大家各种体验。</p></blockquote><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/java/concurrencemultithreading/OracleLinux%E4%BE%8B%E5%AD%906.gif alt=OracleLinux例子6></p><h3 id=4-wsl使用>4. WSL使用</h3><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/java/concurrencemultithreading/OracleLinux%E4%BE%8B%E5%AD%907.gif alt=OracleLinux例子7></p><p>进入系统完美使用</p><h3 id=5-wsl使用技巧>5. WSL使用技巧</h3><p>在使用过程中，由于可以直接读取Windows下面的目录。这样就提供很大的方便。</p><ul><li><p>可以直接下载Linux上面运行的程序到Windows目录中，然后在Linux上运行</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/java/concurrencemultithreading/image-20220218225558289.png alt=image-20220218225558289></p><p>如上图下载了coredns的Linux的运行。然后就可以通过WSL来运行</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/java/concurrencemultithreading/OracleLinux%E4%BE%8B%E5%AD%908.gif alt=OracleLinux例子8></p><p>上面运行成功。</p></li><li><p>在WSL子系统中Maven可以和Windows使用同一个maven仓库。所以就不用在子系统和windows系统用两个不同的maven本地仓库。只需要将Linux系统中的maven配置文件maven仓库配置成一样的就可以了。</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/java/concurrencemultithreading/image-20220218230435445.png alt=image-20220218230435445></p><p>将磁盘都挂载了。能够直接访问Windows上面的资源</p></li></ul><h3 id=6-总结>6. 总结</h3><p>WSL解决了windows用户使用Linux的不方便。同时也给学习Linux开发提供方便。不需要装双系统或者VMware。</p><blockquote><p>我是蚂蚁背大象，文章对你有帮助点赞关注我，文章有不正确的地方请您斧正留言评论~谢谢</p></blockquote><p>参考文档：</p><ul><li><a href=https://docs.microsoft.com/zh-cn/windows/wsl/about>https://docs.microsoft.com/zh-cn/windows/wsl/about</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-ff23825a2db2dc09b20ea38c53e4d4c0>14 - 序列化</h1></div><div class=td-content><h1 id=pg-abae75c0fe02936f0701d52b0744822f>14.1 - fastjson序列化脱敏实现</h1><h3 id=1-背景>1. 背景</h3><p>平时开发过程中大家一定遇到过在Restful接口的数据给到前端某些字段需要进行脱敏，最笨的方式就是在需要脱敏的接口中对字段根据产品需求进行相关数据的脱敏工作。这种方式耦合很严重，哪天不需要脱敏了就需要直接修改每个脱敏接口中的代码。所以很容想到就是在序列化的时候对字段进行脱敏处理，这样做有这样几个好处：</p><ul><li>处理的地方统一，耦合性不是太高</li><li>开发起来比较友好，无需每个需要序列化的接口都要处理。</li></ul><p>平时开发Web项目的时候，除了默认的Spring自带的序列化工具，FastJson也是一个很常用的Spring web Restful接口序列化的工具。下面来基于FastJSON实现序列化指定脱敏的功能。</p><h3 id=2-脱敏实现>2. 脱敏实现</h3><p>FastJSON实现方式有两种：</p><ul><li>基于序列化过滤器</li><li>基于注解@JSONField实现</li></ul><p>下面基于这两种类型分别实现11位手机号码的脱敏</p><h4 id=21-基于注解jsonfield>2.1 基于注解@JSONField</h4><p>在@JSONField注解中有一个serializeUsing字段，这个字段可以让我们自定义序列化。</p><blockquote><p>Tips: fastjson 版本大于等于1.2.16</p></blockquote><p>首先定义一个自定义序列化的类：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PhoneDesensitization</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>ObjectSerializer</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>JSONSerializer</span> <span style=color:#000>serializer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>fieldName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Type</span> <span style=color:#000>fieldType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>features</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        
        <span style=color:#8f5902;font-style:italic>//这里只是做了一个简单
</span><span style=color:#8f5902;font-style:italic></span>        
        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fieldType</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#000>serializer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>StringBuilder</span> <span style=color:#000>phone</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringBuilder</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>phone</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>replace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>6</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;****&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>serializer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>phone</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>());</span>

    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>那么如何使用呢？只在需要序列化的类需要脱敏的手机号码上面进行如下设置：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Person</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>phone</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>phone</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>phone</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>phone</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>email</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>phone</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>phone</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>email</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>email</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@JSONField</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>serializeUsing</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PhoneDesensitization</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#000>String</span> <span style=color:#000>phone</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#000>String</span> <span style=color:#000>email</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getPhone</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>phone</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setPhone</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>phone</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>phone</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>phone</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getEmail</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>email</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setEmail</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>email</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>email</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>email</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>运行代码进行验证效果：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Test</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>String</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>JSON</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toJSONString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;131xxxx1552&#34;</span><span style=color:#ce5c00;font-weight:700>),</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>运行结果：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#4e9a06>&#34;phone&#34;</span>:<span style=color:#4e9a06>&#34;131****1552&#34;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=22-基于序列化过滤器>2.2 基于序列化过滤器</h4><p>FastJSON中有这样一个接口： SerializeFilter，这个接口没有任何方法，有很多继承了这个接口的接口：</p><ol><li>PropertyPreFilter 根据PropertyName判断是否序列化</li><li>PropertyFilter 根据PropertyName和PropertyValue来判断是否序列化</li><li>NameFilter 修改Key，如果需要修改Key,process返回值则可</li><li>ValueFilter 修改Value</li><li>BeforeFilter 序列化时在最前添加内容</li><li>AfterFilter 序列化时在最后添加内容</li></ol><p>针对不同的场景可以选择，例如我们这个脱敏的需求，这个其实就是修改Value,所以我们可以选择这个，但是这个Class级别的过滤器，也就是说类中的每一个属性的值都会执行一次这个ValueFilter #process方法，那么就需要用一个方法来标识那些字段是需要处理的，最好的办法就是在需要脱敏的属性上加上注解。</p><p>定义注解：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Target</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>FIELD</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Retention</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RetentionPolicy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RUNTIME</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Documented</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#5c35cc;font-weight:700>@interface</span> <span style=color:#000>PhoneDesensi</span> <span style=color:#ce5c00;font-weight:700>{</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>实现ValueFilter 过滤器：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PhoneSerializeFilter</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>ValueFilter</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>process</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//这里可以增加缓存
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>PhoneDesensi</span> <span style=color:#000>annotation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getDeclaredField</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getAnnotation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PhoneDesensi</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>annotation</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>){</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(!(</span><span style=color:#000>value</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>)){</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#000>StringBuilder</span> <span style=color:#000>phone</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringBuilder</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>phone</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>replace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>6</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;****&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>phone</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NoSuchFieldException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
           <span style=color:#8f5902;font-style:italic>//
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后使用配置：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Person</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>phone</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>phone</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>phone</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>phone</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>email</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>phone</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>phone</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>email</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>email</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@PhoneDesensi</span>
    <span style=color:#000>String</span> <span style=color:#000>phone</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#000>String</span> <span style=color:#000>email</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getPhone</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>phone</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setPhone</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>phone</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>phone</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>phone</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getEmail</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>email</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setEmail</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>email</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>email</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>email</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div><p>运行如下代码验证：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Test</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>String</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>JSON</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toJSONString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;131xxxx1552&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;123@163.com&#34;</span><span style=color:#ce5c00;font-weight:700>),</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PhoneSerializeFilter</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>运行结果：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;email&#34;</span>:<span style=color:#4e9a06>&#34;123@163.com&#34;</span>,<span style=color:#4e9a06>&#34;phone&#34;</span>:<span style=color:#4e9a06>&#34;131****1552&#34;</span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote><p>Tips: 上面的代码只是一个实现的思路，当中还有很多的地方需要完善。</p></blockquote><h4 id=23-两种方式的性能对比>2.3 两种方式的性能对比</h4><p>测试代码：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@BenchmarkMode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Mode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Throughput</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Warmup</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>iterations</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>time</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Measurement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>iterations</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>time</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>60</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Threads</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>16</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Fork</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@State</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Scope</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Benchmark</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@OutputTimeUnit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SECONDS</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>JmhTest</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Person</span> <span style=color:#000>person</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;131xxxx1552&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;123@163.com&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Person1</span> <span style=color:#000>person1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Person1</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;131xxxx1552&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;123@163.com&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>PhoneSerializeFilter</span> <span style=color:#000>filter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PhoneSerializeFilter</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#5c35cc;font-weight:700>@Benchmark</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>valueFilter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Blackhole</span> <span style=color:#000>blackhole</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>String</span> <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>JSON</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toJSONString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>person1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>filter</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>blackhole</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consume</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Benchmark</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>objectSerializer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Blackhole</span> <span style=color:#000>blackhole</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
       <span style=color:#000>String</span> <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>JSON</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toJSONString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>person</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>blackhole</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consume</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>RunnerException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Options</span> <span style=color:#000>opt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>OptionsBuilder</span><span style=color:#ce5c00;font-weight:700>()</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>include</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>JmhTest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSimpleName</span><span style=color:#ce5c00;font-weight:700>())</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>result</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;result.json&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resultFormat</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResultFormatType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>JSON</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>build</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Runner</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>opt</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>run</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>运行结果：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/others/serialize/image-20220223222349475.png alt=image-20220223222349475></p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/others/serialize/fastjson%E7%9A%84%E5%BA%8F%E5%88%97%E5%8C%96%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94.png alt=fastjson的序列化性能对比></p><p>从运行结果可以看出来大概使用 <strong>基于序列化过滤器</strong> 相比 <strong>基于注解@JSONField</strong> 损失了11%的性能。</p><h3 id=3-spring-boot集成>3. Spring Boot集成</h3><p>配置 Spring MVC 的话只需继承 <code>WebMvcConfigurer</code> 覆写 <code>configureMessageConverters</code> 方法即可,如下：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Configuration</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>WebMvcConfigurer</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>WebMvcConfigurer</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>configureMessageConverters</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>HttpMessageConverter</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>converters</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>FastJsonHttpMessageConverter</span> <span style=color:#000>converter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FastJsonHttpMessageConverter</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>//自定义配置...对于第二种方式
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>//FastJsonConfig config = new FastJsonConfig();
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// config.setSerializeFilters(new PhoneSerializeFilter()); --设置自定义的Filter
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>converters</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>converter</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote><p>Tips: Tips：fastjson网站这里使用的是WebMvcConfigurerAdapter,但是在Spring5.0后标记为过期了。</p></blockquote><h3 id=4-总结>4. 总结</h3><ul><li>两种实现方式各有千秋，基于第一种方式就是每一种需要脱敏的数据都需要编写一个自定义序列化类，但是性能强于第二种。第二种虽然性能比第一种稍弱。这里可以对代码进行优化增加缓存提高。然后就是可以用一个自定义注解来实现这个功能。同时用第二种方式使用自定义的注解还可以实现其他非FastJSON的脱敏</li><li>基于这两种方式实现数据脱敏能够降低和代码耦合。</li></ul><blockquote><p>我是蚂蚁背大象，文章对你有帮助点赞关注我，文章有不正确的地方请您斧正留言评论~谢谢</p></blockquote><p>参考资料：</p><ul><li><a href=https://github.com/alibaba/fastjson/wiki>https://github.com/alibaba/fastjson/wiki</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-afdf357f4372abfc47c4b3dbc42d5a79>15 - OAuth2</h1></div><div class=td-content><h1 id=pg-0b895f1aa34cce4d6e5b1806510f375c>15.1 - 从IETF规范理解OAuth 2.0</h1><h3 id=1什么是-oauth-20>1.什么是 OAuth 2.0？</h3><p>以下是 OAuth 2.0 IETF 规范中给出的 OAuth 2.0 定义：</p><p>OAuth 2.0授权框架支持第三方应用程序获取对HTTP服务的有限访问通过编排审批交互来代表资源所有者在资源所有者和HTTP服务之间，或者通过允许第三方应用程序以自己的名义获得访问权。</p><p>需要了解的一点是，OAuth 2.0 为应用提供了一种获取用户受保护资源（如支付宝账户或其他用户可能希望通过应用访问的敏感信息）有限访问权限的方法，而无需用户将其登录凭据(用户名、密码)透露给应用</p><blockquote><p>Tips: OAuth 2.0解决了一个什么问题？以网站的第三方登录为例子，网站A接入了微信、支付宝、微博的登录。你想要通过这三个网站的用户名登录接入的网站，正常情况下你需要输入你的用户名和密码在接入微信、支付宝、微博的登录网站A。但是这样你就需要向这网站A提供微信、支付宝、微博的账号密码。从根本上说，您要向应用提供这些敏感信息。您是否信任该网站A拥有你的密码和用户名这一行为？如果该应用遭到入侵，怎么办？如果这样，您必须要记得更改每个帐户的银行凭据。而OAuth 2.0就是为了解决这个问题</p></blockquote><h3 id=2-oauth-20角色>2. OAuth 2.0角色</h3><p>OAuth 2.0中定义了四个角色</p><ul><li><strong>资源拥有者(resource owner):</strong> 也称为<em>最终用户</em>。通常是指能够授权访问受保护资源的人员（或其他实体），例如：微信中的头像信息，这个资源的拥有者就是你。</li><li><strong>资源服务器 (resource server)：</strong> 托管受保护资源的服务器，能够使用访问令牌接受和响应受保护的资源请求,例如：你的微信头像信息存储在微信服务器</li><li><strong>客户端(Client)</strong>：代表资源所有者并经其授权发出受保护资源请求的应用程序。例如：桌面应用，手机应用，服务器应用等等</li><li><strong>授权服务器(authorization server):</strong> 服务器成功认证资源所有者并获得授权后，向客户端发出访问令牌。</li></ul><h3 id=3oauth-20协议流程>3.OAuth 2.0协议流程</h3><p>图片来自OAuth 2.0官方文档</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/other/oauth2/OAuth2.0%E6%B5%81%E7%A8%8B%E5%9B%BE.png alt=OAuth2.0流程图></p><p>了解相关术语：</p><ul><li><strong>授权许可</strong>：授予应用代表最终用户检索访问令牌的权限</li><li><strong>访问令牌（Access Token）</strong>：一条长字符串，用作访问受保护资源的凭据</li><li><strong>受保护的资源</strong>：资源所有者拥有的数据。例如：账号头像、姓名、手机号等其他的敏感信息</li></ul><p>OAuth 2.0协议流程说明：</p><ul><li>（A）用户打开客户端以后，客户端要求用户给予授权。例如：微信便捷登录弹窗获取用户的账号信息流程</li><li>（B）用户同意给予客户端授权。例如： 点击同意获取授权</li><li>（C）客户端使用上一步(B)获得的授权，向认证服务器申请令牌。</li><li>（D）认证服务器对客户端进行认证以后，确认无误，同意发放令牌。</li><li>（E）客户端使用令牌，向资源服务器申请获取资源。</li><li>（F）资源服务器确认令牌无误，同意向客户端开放资源。</li></ul><h3 id=4什么是-oauth-20-授权类型>4.什么是 OAuth 2.0 授权类型？</h3><p>授权授予是代表资源所有者授权(访问其受保护资源)的凭据，客户机使用该授权来获取访问令牌。该规范定义了四种授权类型——授权代码、隐式、资源所有者密码凭证和客户端凭证——以及用于定义其他类型的可扩展机制。一般来说，每种授权类型都各有利弊，您需要根据您的业务用例进行权衡。其中一个考核因素之一：<strong><code>即将访问您的数据的应用的可信度</code></strong> 。通常第三方的应用可信度不如企业自己开发和使用的。例如：你在支付宝开发的小程序比支付宝内置的小程序的可信度低很多。</p><p>OAuth 2.0 的四种授权类型：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/other/oauth2/OAuth%202.0%20%E6%8E%88%E6%9D%83%E7%B1%BB%E5%9E%8B.png alt="OAuth 2.0 授权类型"></p><blockquote><p>Tips: 后续会更新文章来详细讲解这四种授权类型</p></blockquote><h3 id=5-什么是访问令牌access-token>5. 什么是访问令牌(Access Token)</h3><p>访问令牌是一条长字符串，可用作访问受保护资源的凭据。资源令牌（也称为不记名令牌）在 Authorization 标头中传递，如下所示：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=color:#000>GET</span> <span style=color:#000>/resource</span> <span style=color:#204a87;font-weight:700>HTTP</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#0000cf;font-weight:700>1.1</span>
<span style=color:#000>Host</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>server.example.com</span>
<span style=color:#000>Authorization</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>Bearer mF_9.B5f-4.1JqM</span>
</code></pre></div><p>或者POST请求体中，如下所示：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=color:#000>POST</span> <span style=color:#000>/resource</span> <span style=color:#204a87;font-weight:700>HTTP</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#0000cf;font-weight:700>1.1</span>
<span style=color:#000>Host</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>server.example.com</span>
<span style=color:#000>Content-Type</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>application/x-www-form-urlencoded</span>

access_token=mF_9.B5f-4.1JqM
</code></pre></div><p>或者在URI请求参数中,如下所示：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=color:#000>GET</span> <span style=color:#000>/resource?access_token=mF_9.B5f-4.1JqM</span> <span style=color:#204a87;font-weight:700>HTTP</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#0000cf;font-weight:700>1.1</span>
<span style=color:#000>Host</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>server.example.com</span>
</code></pre></div><blockquote><p>Tips: 参考https://datatracker.ietf.org/doc/html/rfc6750</p></blockquote><p>访问令牌通常设有有效期（出于安全原因）。某些授权类型允许授权服务器发出刷新令牌，这允许应用在旧令牌到期时获取新的访问令牌。如需详细了解访问令牌和刷新令牌，请参阅 IETF OAuth 2.0 规范。例如时间的有效期时长等等在OAuth 2.0 规范中都给了建议以及相对应的说明</p><h3 id=6-通过范围限制访问权限>6. 通过范围限制访问权限</h3><p>通过范围机制，OAuth 2.0 可以向应用授予受保护资源的有限访问权限。例如我们在使用微信登录第三方网站的时候，第三方网站只能获取到微信用户的账号的基本信息，而不能在第三方网站对微信的账号进行改动。</p><h3 id=7-客户端注册>7. 客户端注册</h3><p>在OAuth中定义了两种客户端类型：</p><ul><li><strong>机密的（confidential）</strong></li><li><strong>公开的（public）</strong></li></ul><p>所有客户端（应用）都必须注册准备向其请求访问令牌的 OAuth 2.0 授权服务器。注册后会生成客户端的client_id和client_secret。</p><h3 id=8-总结>8. 总结</h3><p>通过对OAuth 2.0 规范的梳理，我们需要了解以下几点：</p><ul><li>OAuth 2.0中的四个角色类型</li><li>OAuth 2.0的运行流程图</li><li>OAuth 2.0的四个授权模式，以及授权模式在什么情况下使用以及安全性等等</li><li>OAuth 2.0中的一些常见的名词，例如Access Token、refresh Token等等。</li></ul><p>欲善其事，必先利其器。要想知道如何使用OAuth 2.0首先要了解其基础的知识。</p><blockquote><p>我是蚂蚁背大象，文章对你有帮助点赞关注我，文章有不正确的地方请您斧正留言评论~谢谢</p></blockquote><p>参考文档：</p><ul><li><a href="https://cloud.google.com/apigee/docs/api-platform/security/oauth/oauth-introduction?hl=zh-cn">https://cloud.google.com/apigee/docs/api-platform/security/oauth/oauth-introduction?hl=zh-cn</a></li><li><a href=https://datatracker.ietf.org/doc/html/rfc6749>https://datatracker.ietf.org/doc/html/rfc6749</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-151f08c12cb3b07b8a7b120b75f12cd0>15.2 - OAuth2-授权码模式图解(Authorization Code Grant)</h1><h3 id=1授权码模式>1.授权码模式</h3><p>授权码模式用来获取**<code>Access Token</code>** 以及 **<code>refresh Token</code>** 。这个模式是功能最完整，最严密的、安全性最高的授权模式。**<code>通过客户端的后台服务器与认证服务器进行交互。</code>**</p><h3 id=2-授权码流程图>2. 授权码流程图</h3><p>下面是官方给的授权流程图：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/other/oauth2/%E6%8E%88%E6%9D%83%E7%A0%81%E6%A8%A1%E5%BC%8F%E6%B5%81%E7%A8%8B.png alt=授权码模式流程></p><p>上图这个看起来有点懵，转换一下成详细时序图：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/other/oauth2/%E6%8E%88%E6%9D%83%E7%A0%81%E6%A8%A1%E5%BC%8F%E6%97%B6%E5%BA%8F%E5%9B%BE.png alt=授权码模式时序图></p><p>上图有几个重要的步骤下面根据图以及官方的文档进行详细分析。</p><blockquote><p>Tips: 上图的client其实是可以包含前端页面、后台的服务。</p></blockquote><h4 id=21-授权请求>2.1 授权请求</h4><p>官方的流程图中（A）步骤就是授权请求认证的URI，在时序图中就是步骤（2）。客户端构造的请求URI的格式如下：</p><p><strong><code>Context-Type: application/x-www-form-urlencoded</code></strong></p><p>HTTP请求方式： GET</p><p>请求参数：</p><table><thead><tr><th>参数</th><th>是否必须</th><th>说明</th></tr></thead><tbody><tr><td>response_type</td><td>必须</td><td>必须设置为<strong>code</strong></td></tr><tr><td>client_id</td><td>必须</td><td>客户端在授权服务注册的能够标识的唯一值，一般用应用的唯一ID</td></tr><tr><td>redirect_uri</td><td>可选</td><td>授权完成后的重定向地址，一般可以在授权服务后台进行设置</td></tr><tr><td>scope</td><td>可选</td><td>可选、表示授权范围</td></tr><tr><td>state</td><td>推荐使用</td><td>用来维护请求和回调状态的附加字符串，在授权完成回调时会附加此参数，应用可以根据此字符串来判断上下文关系</td></tr></tbody></table><p>例子如下：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=color:#a40000>GET /authorize?response_type=code&amp;client_id=s6BhdRkqt3&amp;state=xyz
</span><span style=color:#a40000>        &amp;redirect_uri=https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb HTTP/1.1
</span><span style=color:#a40000>Host: server.example.com
</span></code></pre></div><blockquote><p>Tips: URI要进行URIEncode的编码</p></blockquote><p>授权服务器对URI的请求参数进行验证，验证通过后就是响应返回</p><h4 id=22-授权响应>2.2 授权响应</h4><p>步骤（c）和时序图中的步骤（6）返回授权请求的响应。返回的格式：</p><p><strong><code>Context-Type: application/x-www-form-urlencoded</code></strong></p><p>返回的参数：</p><table><thead><tr><th>参数</th><th>是否必须</th><th>说明</th></tr></thead><tbody><tr><td>code</td><td>必须</td><td>授权码，授权码代表用户确认授权的暂时性凭证，<strong>只能使用一次</strong>，推荐最大生命周期不超过10分钟</td></tr><tr><td>state</td><td>可选</td><td>如果客户端传递了该参数，则必须原封不动返回</td></tr></tbody></table><p>例子如下：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=color:#204a87;font-weight:700>HTTP</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#0000cf;font-weight:700>1.1</span> <span style=color:#0000cf;font-weight:700>302</span> <span style=color:#c00;font-weight:700>Found</span>
<span style=color:#000>Location</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>https://client.example.com/cb?code=SplxlOBeZQQYbYS6WxSbIA&amp;state=xyz</span>
</code></pre></div><h4 id=23-access-token请求>2.3 Access Token请求</h4><p>（D）步骤和时序图中的（7）步骤，客户端向认证服务器申请令牌的HTTP请求，包含以下参数：</p><p><strong><code>Context-Type: application/x-www-form-urlencoded</code></strong></p><p>HTTP请求方式：POST</p><p>请求参数：</p><table><thead><tr><th>参数</th><th>是否必须</th><th>说明</th></tr></thead><tbody><tr><td>grant_type</td><td>必须</td><td>OAuth 2.0规定的授权类型，此处必须是 <strong>authorization_code</strong></td></tr><tr><td>client_id</td><td>必须</td><td>应用的唯一ID</td></tr><tr><td>redirect_uri</td><td>必须</td><td>授权回调地址</td></tr><tr><td>code</td><td>必须</td><td>授权码</td></tr></tbody></table><p>例子如下：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=color:#000>POST</span> <span style=color:#000>/token</span> <span style=color:#204a87;font-weight:700>HTTP</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#0000cf;font-weight:700>1.1</span>
<span style=color:#000>Host</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>server.example.com</span>
<span style=color:#000>Authorization</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW</span>
<span style=color:#000>Content-Type</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>application/x-www-form-urlencoded</span>

grant_type=authorization_code&amp;code=SplxlOBeZQQYbYS6WxSbIA
&amp;redirect_uri=https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb
</code></pre></div><p><strong>验证服务器需要做的：</strong></p><ul><li>验证客户端的凭证</li><li>如果包含客户端身份验证，则对客户端进行身份验证</li><li>校验客户端的client_id</li><li>校验授权码是否有效</li><li>确保redirect_uri是存在的，且和获取授权码请求的一样</li></ul><h4 id=24-access-token响应>2.4 Access Token响应</h4><p>（E）步骤和时序图（9）中，认证服务器发送的HTTP回复：</p><p>返回参数：</p><table><thead><tr><th>参数</th><th>是否必须</th><th>说明</th></tr></thead><tbody><tr><td>access_token</td><td>必须</td><td>授权服务器颁发的 <strong><code>Access Token</code></strong></td></tr><tr><td>token_type</td><td>必须</td><td><a href=https://datatracker.ietf.org/doc/html/rfc6749#section-7.1>OAuth 2.0协议规定的Token类型，固定为 <strong><code>Bearer</code></strong></a></td></tr><tr><td>expires_in</td><td>推荐</td><td>过期时间（秒）</td></tr><tr><td>refresh_token</td><td>可选</td><td>授权服务器颁发的**<code>refresh token</code>**</td></tr><tr><td>scope</td><td>可选</td><td>表示权限范围，如果与客户端申请的范围一致，此项可省略</td></tr></tbody></table><p>返回例子如下：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=color:#204a87;font-weight:700>HTTP</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#0000cf;font-weight:700>1.1</span> <span style=color:#0000cf;font-weight:700>200</span> <span style=color:#c00;font-weight:700>OK</span>
<span style=color:#000>Content-Type</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>application/json;charset=UTF-8</span>
<span style=color:#000>Cache-Control</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>no-store</span>
<span style=color:#000>Pragma</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>no-cache</span>

<span style=color:#000;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>&#34;access_token&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;2YotnFZFEjr1zCsicMWpAA&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>&#34;token_type&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;Bearer&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>&#34;expires_in&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>3600</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>&#34;refresh_token&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;tGzv3JOkF0XG5Qx2TlKWIA&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>&#34;example_parameter&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;example_value&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p><strong>说明：</strong></p><ul><li><code>Content-Type: application/json;charset=UTF-8</code></li><li>不能使用缓存</li></ul><h3 id=3-授权码模式应用-第三方登录>3. 授权码模式应用-第三方登录</h3><p>授权码模式使用的最多的应用就是第三方登录，我们以自己设计一个第三方登录为例子来进行说明。首先看一下登录时序图</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/other/oauth2/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%8E%88%E6%9D%83%E7%99%BB%E5%BD%95%E6%97%B6%E5%BA%8F%E5%9B%BE.png alt=第三方授权登录时序图></p><p>上述登录时序图说明：我们以加入你要接入微信登录为例子。那么授权服务就是微信的服务，资源拥有服务也是微信的服务。而第三方的面和第三方的后端服务就是需要接入微信登录的用户方。授权登录的页面是微信提供的。对应OAuth2的角色：</p><ul><li><strong>资源拥有者(resource owner):</strong> 微信。</li><li><strong>资源服务器 (resource server)：</strong> 资源拥有服务(微信)</li><li><strong>客户端(Client)</strong>：第三方页面、第三方后端服务</li><li><strong>授权服务器(authorization server):</strong> 授权服务（微信）</li></ul><p><strong>关键步骤说明：</strong></p><ul><li>(2)主要是为了去授权服务器验证当前接入的客户端是否合法，在验证合法的情况下返回授权登录页面，如果是微信登录获得的就是微信授权登录的页面，这个是由授权放提供。(这里大家可以找一个有接入微信或者其他的支持第三方登录的网站看一下)</li><li>(8)和(9)主要是生成授权码和将授权码通过重定向链接将数据发送到第三方后端服务(这个过程是一个自动的过程对web页面来说，这里返回的HTTP响应码是302)</li><li>(11)是由第三方后端服务调用授权服务去获取<code>Access Token</code> 。 OAuth 2.0协议规定redirect_uri是必填的。但是大多数的实现都没有这个必填的参数传入。后续就是授权服务校验提交的参数同时通过就返回 <strong><code>Access Token</code></strong></li></ul><h3 id=4-总结>4. 总结</h3><p>授权码模式作为最安全的模式，经常被用于用作实现第三方登录。但是对比OAuth 2.0的标准，不同的公司的实现有一定的差异。但是总体的思想都差不多。第三方的登录可以参考知乎的第三方登录页面。</p><blockquote><p>我是蚂蚁背大象，文章对你有帮助点赞关注我，文章有不正确的地方请您斧正留言评论~谢谢</p></blockquote><p>参考文档：</p><ul><li><a href=https://datatracker.ietf.org/doc/html/rfc6749#section-4.1>https://datatracker.ietf.org/doc/html/rfc6749#section-4.1</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-f84d73d54dd0f743c30df3592b14b6bb>15.3 - OAuth2-隐式授权详解(Implicit Grant)</h1><p>一起养成写作习惯！这是我参与「掘金日新计划 · 4 月更文挑战」的第2天，<a href=https://juejin.cn/post/7080800226365145118>点击查看活动详情</a>。</p><h3 id=1-隐式授权概述>1. 隐式授权概述</h3><p>隐式授予类型用于获取访问令牌(<strong><code>它不支持发布刷新令牌</code></strong>)，并针对已知操作特定重定向URI的公共客户端进行了优化。这些客户端通常使用JavaScript等脚本语言在浏览器中实现。(主要面向浏览器)。客户端必须能够与资源所有者的用户代理交互，并且能够接收来自授权服务器传入的请求(这个是通过重定向实现)。在授权码授予类型中，客户端分别请求授权和访问令牌，与此不同的是，客户端作为授权请求的结果接收访问令牌。隐式授权类型不包括客户端身份验证，它依赖于资源所有者的存在和重定向URI的注册。因为访问令牌被编码到重定向URI中，所以它可能被公开给资源所有者和驻留在同一设备上的其他应用程序。</p><p>上述的几个关键点：</p><ul><li>不用通过第三方应用后端服务</li><li>浏览器中直接向认证服务器申请访问令牌</li><li>相比授权码授权少了获取授权码的过程</li><li>客户端无需验证，且令牌对访问者可见</li><li>令牌是拼接在重定向URL的后面</li></ul><h3 id=2-隐式授权的流程>2. 隐式授权的流程</h3><p>看一下官方给的授权流程：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/other/oauth2/%E9%9A%90%E5%BC%8F%E6%8E%88%E6%9D%83%E6%B5%81%E7%A8%8B%E5%9B%BE.png alt=隐式授权流程图></p><p>对比 <strong><code>授权码模式</code></strong> ，少了获取授权码的获取，转换成详细的时序图如下：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/other/oauth2/%E9%9A%90%E5%BC%8F%E6%8E%88%E6%9D%83%E6%97%B6%E5%BA%8F%E5%9B%BE.png alt=隐式授权时序图></p><h4 id=21-授权请求>2.1 授权请求</h4><p>客户端构造的请求URI的格式如下：</p><p><strong><code>Context-Type: application/x-www-form-urlencoded</code></strong></p><p>HTTP请求方式： GET</p><p>请求参数：</p><table><thead><tr><th>参数</th><th>是否必须</th><th>说明</th></tr></thead><tbody><tr><td>response_type</td><td>必须</td><td>必须设置为 <strong>token</strong> (这个是OAuth2的规范)</td></tr><tr><td>client_id</td><td>必须</td><td>客户端在授权服务注册的能够标识的唯一值，一般用应用的唯一ID</td></tr><tr><td>redirect_uri</td><td>可选</td><td>授权完成后的重定向地址，一般可以在授权服务后台进行设置</td></tr><tr><td>scope</td><td>可选</td><td>可选、表示授权范围</td></tr><tr><td>state</td><td>推荐使用</td><td>用来维护请求和回调状态的附加字符串，在授权完成回调时会附加此参数，应用可以根据此字符串来判断上下文关系</td></tr></tbody></table><p>例子如下：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=color:#a40000>GET /authorize?response_type=token&amp;client_id=s6BhdRkqt3&amp;state=xyz
</span><span style=color:#a40000>        &amp;redirect_uri=https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb HTTP/1.1
</span><span style=color:#a40000>Host: server.example.com
</span></code></pre></div><blockquote><p>Tips: URI要进行URIEncode的编码</p></blockquote><p>授权服务器对URI的请求参数进行验证。就会返回一个授权的页面用户点击授权页面，授权页面点击授权后授权服务器就会返回一个访问令牌 Access Token。</p><h4 id=22-访问令牌返回>2.2 访问令牌返回</h4><p>隐式模式访问令牌的返回是将数据放在重定向URI的后面，格式如下：</p><p>返回参数：</p><table><thead><tr><th>参数</th><th>是否必须</th><th>说明</th></tr></thead><tbody><tr><td>access_token</td><td>必须</td><td>必须设置为 <strong>token</strong> (这个是OAuth2的规范)</td></tr><tr><td>token_type</td><td>必须</td><td>固定值bearer，<a href=https://datatracker.ietf.org/doc/html/rfc6749#section-7.1>参考OAuth2规范</a></td></tr><tr><td>expires_in</td><td>推荐使用</td><td>Access Token的有效时间</td></tr><tr><td>scope</td><td>可选</td><td>可选、表示授权范围</td></tr><tr><td>state</td><td>推荐使用</td><td>用来维护请求和回调状态的附加字符串，在授权完成回调时会附加此参数，应用可以根据此字符串来判断上下文关系</td></tr></tbody></table><p>例子：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=color:#204a87;font-weight:700>HTTP</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#0000cf;font-weight:700>1.1</span> <span style=color:#0000cf;font-weight:700>302</span> <span style=color:#c00;font-weight:700>Found</span>
<span style=color:#000>Location</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>http://example.com/cb#access_token=2YotnFZFEjr1zCsicMWpAA&amp;state=xyz&amp;token_type=example&amp;expires_in=3600</span>
</code></pre></div><h3 id=3-应用场景>3. 应用场景</h3><p>对于采用隐式授权（Implicit Grant）方式获取Access Token的授权验证流程，<strong><code>适用于无Server端配合的应用</code></strong> 。 这些应用往往位于一个用户代理（User Agent）里面。例如：<strong><code>手机/桌面客户端程序、浏览器插件等,</code></strong> 这一类应用无法妥善保管客户端在授权服务器注册时候颁发的客户端秘钥(App Secret Key)。</p><h3 id=4-总结>4. 总结</h3><p>隐式授权（Implicit Grant）是为了解决无Server后端配合的应用，而又防止客户端的在授权服务器的秘钥泄露对授权码模式的一种精简。相比授权码模式做了以下几个改动：</p><ul><li>少了获取授权码的步骤</li><li>少了验证客户端的有效性</li><li>隐式授权不支持刷新访问令牌(refresh Token)</li></ul><blockquote><p>我是蚂蚁背大象，文章对你有帮助点赞关注我，文章有不正确的地方请您斧正留言评论~谢谢</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-33d6b9722483b2dfb277435709dba898>16 - 分布式文件系统MinIO环境的搭建</h1><p>一起养成写作习惯！这是我参与「掘金日新计划 · 4 月更文挑战」的第3天，<a href=https://juejin.cn/post/7080800226365145118>点击查看活动详情</a>。</p><h3 id=1前言>1.前言</h3><p>公司开始使用的分布式文件系统是阿里云的OSS用来存储图片，出于安全的考虑和业务方的需求公司开始自建分布式文件系统，之前公司也有使用<a href=https://github.com/happyfish100/fastdfs>fastDNS</a> 。最近开始准备用<a href=https://github.com/minio/minio>MinIO</a> 来搭建一套公司使用的分布式文件系统。自己也来学习一下MinIO的使用。在本地搭建一套环境。</p><h3 id=2-minio有哪些优势>2. MinIO有哪些优势？</h3><h4 id=21-文档全面社区活跃>2.1 文档全面社区活跃</h4><p>MinIO作为一款基于Golang 编程语言开发的一款高性能的分布式式存储方案的开源项目，有十分完善的官方文档。同时通过Github的❤的数量可以知道社区是相当的活跃。</p><p>官方文档(英文)：https://docs.min.io/docs/</p><p>中文文档：http://docs.minio.org.cn/docs/</p><h4 id=22-对原生有良好的支持>2.2 对原生有良好的支持</h4><p>MinIO本身是用Golang编写，对于K8S等有着良好的支持。</p><h3 id=3环境搭建>3.环境搭建</h3><p>Linux本机环境和Docker容器两种方式分别搭建。</p><h4 id=31-linux本机搭建>3.1 Linux本机搭建</h4><blockquote><p>Tips:使用的Window的WSL作为本机环境</p></blockquote><p><strong>第一步：</strong> 下载MinIO的Server安装包</p><p>二进制安装包：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>wget https://dl.min.io/server/minio/release/linux-amd64/minio
chmod +x minio
</code></pre></div><p>rpm安装包：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>dnf install https://dl.min.io/server/minio/release/linux-amd64/minio-20220401034139.0.0.x86_64.rpm

</code></pre></div><p><strong>第二步：</strong> 启动服务</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#8f5902;font-style:italic>#二进制启动</span>
<span style=color:#204a87>export</span> <span style=color:#000>MINIO_ROOT_USER</span><span style=color:#ce5c00;font-weight:700>=</span>admin 
<span style=color:#204a87>export</span> <span style=color:#000>MINIO_ROOT_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span>password 
./minio server /mnt/data --console-address <span style=color:#4e9a06>&#34;:9001&#34;</span>

<span style=color:#8f5902;font-style:italic>#rpm包安装启动</span>
<span style=color:#204a87>export</span> <span style=color:#000>MINIO_ROOT_USER</span><span style=color:#ce5c00;font-weight:700>=</span>admin 
<span style=color:#204a87>export</span> <span style=color:#000>MINIO_ROOT_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span>password 
minio server /mnt/data --console-address <span style=color:#4e9a06>&#34;:9001&#34;</span>
</code></pre></div><blockquote><p>Tips: MINIO_ROOT_USER的最小长度至少未3，MINIO_ROOT_PASSWORD最小长度至少为8，如果小于就会报下面错误</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/other/minioMinIO%E5%90%AF%E5%8A%A8%E9%94%99%E8%AF%AF.png alt=MinIO启动错误></p></blockquote><p>启动后：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/other/minioimage-20220403143459778.png alt=image-20220403143459778></p><p><strong>第三步：</strong> 打开web界面</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/other/minioimage-20220403143707690.png alt=image-20220403143707690></p><p>搭建完成</p><h4 id=32-docker环境搭建>3.2 Docker环境搭建</h4><p><strong>第一步：</strong> 下载MinIO Docker镜像</p><p><img src=C:%5CUsers%5Cmxsm%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220403150809283.png alt=image-20220403150809283></p><p><strong>第二部：</strong> 启动minio</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>docker run -p 9000:9000 -p 9001:9001 --name mxsmMinIO -e <span style=color:#000>MINIO_ROOT_USER</span><span style=color:#ce5c00;font-weight:700>=</span>mxsm -e <span style=color:#000>MINIO_ROOT_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span>mxsm123456    minio/minio server /data --console-address <span style=color:#4e9a06>&#34;:9001&#34;</span>

<span style=color:#8f5902;font-style:italic>#例子：</span>
docker run -p 9000:9000 -p 9001:9001 --name mxsmMinIO -e <span style=color:#000>MINIO_ROOT_USER</span><span style=color:#ce5c00;font-weight:700>=</span>mxsm -e <span style=color:#000>MINIO_ROOT_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span>mxsm123456 -v /mnt/e/minio/data1:/data    minio/minio server /data --console-address <span style=color:#4e9a06>&#34;:9001&#34;</span>
</code></pre></div><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/other/minioimage-20220403152424899.png alt=image-20220403152424899></p><p><strong>第三步：</strong> 打开web页面</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/other/minioimage-20220403152503196.png alt=image-20220403152503196></p><p>到这里为止单机版搭建完成。</p><blockquote><p>我是蚂蚁背大象，文章对你有帮助点赞关注我，文章有不正确的地方请您斧正留言评论~谢谢</p></blockquote><p>参考文档：</p><ul><li><a href=https://docs.min.io/docs/>https://docs.min.io/docs/</a></li><li><a href=https://min.io/download#/kubernetes>https://min.io/download#/kubernetes</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-c6fb5a2738e2e578ffa268fc796aa8a9>17 - “如何快速搭建Java项目开发环境"</h1><p>环境搭建是每个开发人员必须的知道的，平时开发如何快速的搭建开发环境今天给大家分享一下。本人主要使用的是windows平台做开发Java。下面介绍的也是已windows平台Java开发作为分享。</p><h3 id=1-搭建linux环境>1. 搭建Linux环境</h3><p>在windows开发肯定需要搭建一个Linux的部署环境，这个环境有以下几个作用：</p><ul><li>安装开发所需要的存储例如MySQL、ES等等</li><li>作为项目的部署环境以及打包环境</li></ul><p>Linux的环境搭建有两种方式：</p><ul><li><p>通过VMware安装Linux系统</p><p>由于现在Centos已经停止维护，这里通过VMware建议安装Ubuntu</p></li><li><p>windows平台的WSL</p><p>wsl无需VMware，是基于Windows的子系统。这个的优势在于可以直接访问到windows磁盘的文件，wsl搭建可以参照<a href=https://juejin.cn/post/7066067971717726245>《Windows WSL让你告别VMware》</a></p></li></ul><p>Linux环境搭建是一个一次性的工作，搭建好以后再不重装系统的情况下可以一直使用</p><h3 id=2-开发环境搭建>2. 开发环境搭建</h3><p>作为Java开发，开发环境的搭建主要分为三个部分，分别是：</p><ul><li>Java开发环境搭建(JDK等等)</li><li>构建工具环境搭建(Maven,Gradle)</li><li>开发工具</li><li>版本管理工具Git</li><li>命令行工具Cmder</li></ul><h4 id=21-java开发环境搭建>2.1 Java开发环境搭建</h4><p>下载JDK,常用的JDK有Oracle的和OpenJDK两种(我用这两种比较多)，下载地址：</p><p><a href=https://www.oracle.com/java/technologies/downloads/><strong>Oracle JDK下载</strong></a></p><p><a href=https://jdk.java.net/18/><strong>OpenJDK 下载</strong></a></p><h4 id=22-构建工具环境搭建>2.2 构建工具环境搭建</h4><p>Java开发常用的构建工具Maven和Gradle，我自学一些技术和写一些项目的时候Maven用的比较多。Gradle使用看工作需要</p><p><a href=https://maven.apache.org/download.cgi><strong>Maven 下载</strong></a></p><p><a href=https://gradle.org/install/><strong>Gradle 下载</strong></a></p><p>maven和gradle的配置，可以根据官网以及网上的资料进行配置。这里不详细讲解</p><h4 id=23-开发工具>2.3 开发工具</h4><p>对于开发工具选择这个看个人的喜好，<strong>Eclipse、MyEclipse、VScode、IDEA</strong> 。其中Eclipse、VScode都是免费，MyEclipse和IDEA是付费。这里四个除了VsCode其他三个我都使用过。从感受来说IDEA是比较好用的。</p><h4 id=24-版本管理工具git>2.4 版本管理工具Git</h4><p>现在使用的最多的版本管理工具就是Git,在windows本地安装好Git。然后推荐两个界面的管理工具：</p><ul><li><a href=https://www.sourcetreeapp.com/><strong>SourceTree</strong></a></li><li><a href=https://tortoisegit.org/><strong>TortoiseGit</strong></a></li></ul><p>这两个都可以安装，<strong>TortoiseGit</strong> 可以用于平时的clone代码操作，而 <strong>SourceTree</strong> 提供非常友好的图形化合并操作界面，所以平时主要用来代码合并等。</p><h4 id=25-命令行工具cmder>2.5 命令行工具Cmder</h4><p>如果你对Windows的命令不是很熟悉，又想在windows命令行使用Linux的一些命令那么一点要安装 <strong><code>Cmder</code></strong> 工具。下载和安装可以参照Cmder官网：https://cmder.net/</p><h3 id=3-项目中间件的搭建>3. 项目中间件的搭建</h3><p>项目中间件搭建推荐使用Docker,可以把Docker安装在WSL系统中或者VMware的Linux系统中。把常见的你使用到的中间件和一些依赖的服务的Docker启动命令写下来。这样你就算换了环境，只需要搭建Docker然后执行命令即可。</p><h3 id=4-项目快速搭建>4. 项目快速搭建</h3><p>Maven项目的快速搭建可以平时编写一些Maven的脚手架(这个需要个人的平时积累)。Spring Boot项目的快速搭建推荐两个网站：</p><ul><li><a href=https://start.spring.io/>https://start.spring.io/</a></li><li><a href=https://start.aliyun.com/bootstrap.html>https://start.aliyun.com/bootstrap.html</a></li></ul><blockquote><p>Tips:Maven脚手架如何开发可以看一下<a href=https://juejin.cn/post/6844904160299581454>《Maven-自定义archetype》</a>，Spring Boot项目快速搭建参照<a href=https://juejin.cn/post/7063088234628120589>《如何快速创建Spring Boot项目？》</a></p></blockquote><h3 id=5-总结>5. 总结</h3><p>搭建Linux环境、开发环境搭建这个两个是搭建好了就能长久使用，项目中间件搭建的快慢是整个关键，容器化对于学习来说是不二的选择。SpringBoot项目的快速搭建通过Spring以及相关脚手架网站能够快速生成模板代码。从而达到快速搭建开发环境的目的。</p><blockquote><p>我是蚂蚁背大象，文章对你有帮助点赞关注我，文章有不正确的地方请您斧正留言评论~谢谢！</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-4d5e4bbfdc472bee3a77574339202d36>18 - JMeter+Faker让测试数据生成自动化</h1><p>Faker主要用来生成开发测试过程中的的模拟真实数据。JMeter主要用于测试，在测试的过程中造数据是一个很头疼的问题。今天笔者就来介绍一下如何将Faker和JMeter进行组合来实现。模拟数据创建，通过Faker创建的模拟数据更加真实。</p><h3 id=1-环境准备>1. 环境准备</h3><ul><li>JMeter， 版本：5.4.3</li><li>javafaker，版本：1.0.2</li></ul><p>下载javafaker的jar包，然后把jar包放到JMeter的lib目录中。</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/other/image-20220416155645007.png alt=image-20220416155645007></p><p>这里就已经准备好了。接下来就是启动JMeter服务。</p><blockquote><p>Tips: 由于javafaker还有依赖snakeyaml，所以这个jar包也需要引入</p></blockquote><h3 id=2-jmeterfaker案例>2. JMeter+Faker案例</h3><p>用一个简单的创建用户作为例子，首先创建用户需要的几个字段：名称、年龄、手机号码、电子邮件就用这几个字段。</p><h4 id=21-服务端接口编写>2.1 服务端接口编写</h4><p>在服务端编写一个简单的Spring Boot web项目的创建用户接口：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>User</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>age</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>mobile</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>email</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#8f5902;font-style:italic>//省略get set方法
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@RestController</span>
<span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/jmeter&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>JmeterController</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@PostMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/user&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>User</span> <span style=color:#000>getDistributedId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@RequestBody</span> <span style=color:#000>User</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>){</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这个就是一个简单的后台服务。</p><h4 id=21-jmeter脚本编写>2.1 JMeter脚本编写</h4><p><strong>创建线程组：</strong></p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/other/image-20220416104357292.png alt=image-20220416104357292></p><p>**添加BeanShell Sampler: **</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/other/image-20220416104454260.png alt=image-20220416104454260></p><p><strong>编写BeanShell Sampler的代码：</strong></p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/other/image-20220416155353708.png alt=image-20220416155353708></p><h4 id=23-增加-http-reqeust>2.3 增加 HTTP Reqeust</h4><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/other/image-20220416155417301.png alt=image-20220416155417301></p><h4 id=24-运行>2.4 运行</h4><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/other/image-20220416155455934.png alt=image-20220416155455934></p><p>每次运行生成的数据都不一样。</p><p>通过编写代码的方式将faker和JMeter整合到一起，可以用于测试接口或者通过接口造数据。造出来的数据更加的真实。</p><h3 id=3-jmeter的beanshell-sampler变量>3. JMeter的BeanShell Sampler变量</h3><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/other/image-20220416160308782.png alt=image-20220416160308782></p><p>通过官网可以知道有以上的变量可以使用。上面的例子就用到vars变量，后续的组件可以获取到里面的值。</p><blockquote><p>Tips:参照https://jmeter.apache.org/usermanual/component_reference.html#BeanShell_Sampler</p></blockquote><h3 id=4总结>4.总结</h3><p>JMeter+Faker的组合，在测试和造数据有这更加真实的可靠，同时生产的数据更加随机，比起手动和直接写生产数据的规则代码大大提高了效率。</p><blockquote><p>我是蚂蚁背大象，文章对你有帮助点赞关注我，文章有不正确的地方请您斧正留言评论~谢谢！</p></blockquote><p><strong>参考资料：</strong></p><ul><li><a href=https://jmeter.apache.org/usermanual/component_reference.html#BeanShell_Sampler>https://jmeter.apache.org/usermanual/component_reference.html#BeanShell_Sampler</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-b46e004c4cc4af43f4b8ecb55ca85470>19 - 开发中分布式锁和本地锁如何取舍</h1><h3 id=1背景>1.背景</h3><p>最近接手了一个提桶同事的项目，项目有对接钉钉的相关功能。看到项目中有获取钉钉Access Token的代码，但是代码并没有任何的并发处理。而钉钉获取AccessToken有次数限制。需要本地进行缓存。缓存失效后需要重新从钉钉获取Access Token。这里就会存在并发，处理并发就会用到锁。这里就来聊一下分布式系统中锁的使用，主要从以下几个方面聊：</p><ul><li><strong>什么情况下需要处理并发？</strong></li><li><strong>使用分布式锁还是本地锁?</strong></li></ul><h3 id=2-什么情况下需要处理并发>2. 什么情况下需要处理并发?</h3><p>已获取钉钉的Access Token为例，钉钉给出了Access Token的使用注意事项：</p><blockquote><p>在使用access_token时，请注意：</p><ul><li>access_token的有效期为7200秒（2小时），有效期内重复获取会返回相同结果并自动续期，过期后获取会返回新的access_token。</li><li>开发者需要缓存access_token，用于后续接口的调用。因为每个应用的access_token是彼此独立的，所以进行缓存时需要区分应用来进行存储。</li><li>不能频繁调用gettoken接口，否则会受到频率拦截。</li></ul></blockquote><p>从上面的说明可以看的出来：Access Token有有效期，获取的Access Token的接口不能频繁调用，Access Token需要应用进行缓存。这种情况下就需要处理并发。为什么这种情况下就需要处理并发？</p><p>首先假设你部署一个服务，那么获取Access Token的流程如下：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/other/%E6%B5%81%E7%A8%8B%E5%9B%BE1.png alt=流程图1></p><p>这样多个线程会同时向钉钉服务器发送请求Access Token。而钉钉规定获取Access Token不能频繁调用。所以去钉钉服务器发送请求Access Token需要加锁。只能让一个线程去服务器获取Access Token减少接口调用频次。</p><p>如果不是单服务部署而是部署多个服务，那么获取Access Token的流程如下：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/other/%E6%B5%81%E7%A8%8B%E5%9B%BE2.png alt=流程图2></p><p>在不加锁的情况所有的服务的说所有线程都会去获取Access Token，如果单个加锁，那么集群中每个服务就会有一个线程去钉钉获取Access Token。这个就是下面需要讨论的问题： <strong>使用分布式锁还是本地锁?</strong></p><h3 id=3-使用分布式锁还是本地锁>3. 使用分布式锁还是本地锁?</h3><p>对于使用分布式锁还是本地锁这个也是需要看具体的需求和部署。已上面的例子来说</p><p><strong>情况1：</strong> 部署一个服务</p><blockquote><p>部署一个服务，那么只需要使用本地的本地锁即可，只需要有一个线程去钉钉服务获取Access_token</p></blockquote><p><strong>情况2：</strong> 集群部署服务</p><blockquote><p>集群部署是否需要用到分布式锁也需要看情况：</p><ul><li>如果集群规模部署不是特别大，每个服务单独使用本地锁就会出现最多同一时刻有服务数量的线程去获取Access Token,但是只要一天获取次数和小于限制次数就能满足(使用本地锁的前提是，钉钉有说明：<strong>有效期内重复获取会返回相同结果并自动续期</strong>)。</li><li>如果集群部署特别大，每个服务单独去获取一次，一天的获取次数和大于了限制的次数那么这里就需要使用到分布式锁。让所有的机器只有一台去钉钉服务器获取Access Token（这里其实还可以本地锁+分布式锁的方式进一步降低分布式锁的并发）</li></ul></blockquote><p>所以从上面的例子分析可以知道，使用分布式锁还是本地锁需要根据具体情况进行分析，不是所有的集群部署都需要使用分布式锁，本地锁也可以解决问题。笔者接收的项目就是使用本地锁进行实现：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>getAccessTokenFromCacheOrElse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Supplier</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>supplier</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#000>String</span> <span style=color:#000>accessToken</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>redisTemplate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>opsForValue</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ACCESS_TOKEN_KEY</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>accessToken</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>supplier</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//并发控制
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>accessToken</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>redisTemplate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>opsForValue</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ACCESS_TOKEN_KEY</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>accessToken</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>//从钉钉服务器获取
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>accessToken</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>supplier</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#000>redisTemplate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>opsForValue</span><span style=color:#ce5c00;font-weight:700>()</span>
                        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ACCESS_TOKEN_KEY</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>accessToken</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ACCESS_TOKEN_VALID</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SECONDS</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;AccessToken:{}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>accessToken</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>accessToken</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这个服务生产的部署数量2个，所以本地锁就能满足。</p><h3 id=4-总结>4. 总结</h3><p>在现在微服务横行天下的时代，本地锁用的越来越少。但是不是说本地锁就不能解决分布式的问题。上面的代码就很好的解决了。分布式锁也可以解决。但是分布式锁的引入同样会增加系统的复杂程度。如果资源存在竞争关系就需要用到锁，但是是本地锁还是分布式锁就需要根据业务需求进行具体分析。找到解决问题的最佳方案。</p><blockquote><p>我是蚂蚁背大象，文章对你有帮助点赞关注我，文章有不正确的地方请您斧正留言评论~谢谢！</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-82d6bfc6323de0127e964f116bd2223f>20 - 理论实现</h1></div><div class=td-content><h1 id=pg-9f7f974253ec7fa2bab97d1478cc1eb0>20.1 - 时间轮-理论篇</h1><h3 id=1-引言>1. 引言</h3><p>定时任务再开发过程中无处不在，定时发送消息，定时更新数据库表的状态，Linux系统定时执行脚本等等。这些操作都离不开定时任务，那么这些定时任务是怎么实现的是否又去想过。如果让开发者自己去实现一个定时任务又该怎么实现？</p><p>最简单的方案：定义一个链表，将要执行的任务添加到链表中。然后用线程去遍历链表，找出需要执行的任务进行执行。通过反复遍历任务链表就能实现定时任务的执行功能。</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/docs/im/DistributedIDGenerator/%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0.png alt=定时任务简单实现></p><p>但是上述方案有一个很重要的缺陷：如果我的任务有上百万个甚至更多的情况下，可能光遍历整个链表找出需要执行的任务就要花费一定量的时间。如果此时刚好有一个任务添加到链表的Tail,但是任务扫描的指针此时刚好在第一个Head任务节点。此时添加的任务执行时间就在添加后的20ms后，这个时候线程扫描到最后一个需要执行的任务的耗时可能超过了20ms,那么这种情况下就会出现任务的延迟执行。</p><blockquote><p>Tips: 任务的延迟执行需要有一个合理的容忍范围。</p></blockquote><p>在论文<a href=http://www.cs.columbia.edu/~nahum/w6998/papers/sosp87-timing-wheels.pdf>《Hashed and Hierarchical Timing Wheels》</a> 提出了时间轮的概念来解决传统定时任务中的弊端</p><h3 id=2-时间轮简介>2. 时间轮简介</h3><p>在生活中大家肯定见过指针手表(非电子手表)这个就可以看做时间轮，山地自行车的前后齿轮、水表的齿轮、以及减速齿轮都可以看做是时间轮。以手表的刻度为例子，机械手表上最长的指针每条以下表示1秒，也就是将一分钟分成了60个1秒。 <strong><code>时间轮的核心思想：将单位时间分成若干个时间间隔，每个时间间隔包含了时间单位除以若干时间间隔的时间量，时间轮转动到对应的时间间隔就执行当前时间间隔对应的可执行的任务。</code></strong></p><p>下面用例子来说明：</p><p>1秒我们可以分成8个时间间隔，那么每个时间间隔就是125ms,如下图所示：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/others/theory/%E7%AE%80%E5%8D%95%E7%9A%84%E6%97%B6%E9%97%B4%E8%BD%AE%E5%AE%9A%E4%B9%89%E8%AF%B4%E6%98%8E.png alt=简单的时间轮定义说明></p><h4 id=21-简单的时间轮>2.1 简单的时间轮</h4><p>在论文<a href=http://www.cs.columbia.edu/~nahum/w6998/papers/sosp87-timing-wheels.pdf>《Hashed and Hierarchical Timing Wheels》</a> 中每一个时间间隔叫做 <strong><code>bucket</code></strong> 。 bucket的作用用于存放当前时间间隔内存在的需要执行的任务。例如现在有四个任务A、B、C、D分别要在一秒的三个不同的时间段执行，A、B在两个不同的时间段执行，C、D在同一个时间段执行。那么在时间轮上的示意图如下：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/docs/im/DistributedIDGenerator/%E7%AE%80%E5%8D%95%E6%97%B6%E9%97%B4%E8%BD%AE%E7%A4%BA%E6%84%8F%E5%9B%BE.png alt=简单时间轮示意图></p><p>当时间轮的指针从1Bucket的开始时间到结束时间段的过程中，会去遍历Bucket的链表中的任务，将需要执行的任务从链表中拿出来执行。已上图的例子每一秒时间轮的指针走一圈。</p><blockquote><p>Tips: bucket中存放的任务是时间轮一个时间间隔中的任务，也就是说这些任务是一个时间段里面的任务。例如：100ms和80ms需要执行的任务都说存在bucket1。</p></blockquote><p>进一步思考，如果你一分钟执行一次，那么时间轮的刻度就需要分成480个时间段，随着单位时间刻度的增加会让时间论的刻度越来越多。这样对于计算机来说就是消耗更多的内存。这种如何解决，在论文中提出另一个概念就是：<strong><code>分层时间轮</code></strong></p><h4 id=22-分层时间轮>2.2 分层时间轮</h4><p>在生活中分层时间轮也是比比皆是，例如在手表长最长的指针代表秒针，中间的代表分针，最短的代表时针。例如我有三个任务 A、B、C分别在以下时间执行：</p><ul><li>A六十秒的时候执行一次</li><li>B十五分钟的时候执行一次</li><li>C六点位置的时候执行一次</li></ul><p>如下图所示：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/docs/im/DistributedIDGenerator/%E5%88%86%E5%B1%82%E6%97%B6%E9%97%B4%E8%BD%AE%E6%89%A7%E8%A1%8C%E7%A4%BA%E6%84%8F%E5%9B%BE.png alt=分层时间轮执行示意图></p><p>秒时间轮完成一圈触发分时间轮刻度往下一个，分时间轮完成一周触发时时间轮往下一个刻度。分层时间轮之间的刻度关系可以自己定义。不需要和时间刻度表上一样的。具体取决于业务的需要。例如：Linux的Corntab只支持分钟，而Java的Quartz可以支持到秒。</p><h3 id=3总结>3.总结</h3><p>时间轮是一种高效来利用线程资源来进行批量化调度的一种调度模型。提高利用率，但是时间轮调度器的时间精度可能不是很高，对于精度要求特别高的调度任务可能不太适合。因为时间轮算法的精度取决于，也就是时间间隔，时间间隔越小精度越高。时间轮的使用在各大框架与中间件中有使用，netty，kafka,jraft（这个是fork netty的）。</p><blockquote><p>我是蚂蚁背大象，文章对你有帮助点赞关注我，文章有不正确的地方请您斧正留言评论~谢谢！</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-2bfcd508e672bb4651f09cc91104e418>20.2 - 时间轮-实现篇</h1><p>在前面的文章《<a href=https://juejin.cn/post/7092028178322948127>时间轮-理论篇</a>》讲了时间轮的一些理论知识，然后根据理论知识。我们自己来实现一个简单的时间轮。</p><h3 id=1-理论抽象>1. 理论抽象</h3><p>将时间轮的理论进行抽象，主要有两个方面：</p><ul><li>时间轮的转动</li><li>每一个时间间隔任务的处理，从时间间隔的Buket中取出要执行的任务，删除已经关闭的任务。将任务提交给线程池进行执行处理</li></ul><h3 id=2java实现>2.Java实现</h3><p>接口：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Timer</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>createTimerTask</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TimerTask</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>delay</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TimeUnit</span> <span style=color:#000>unit</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>TimerTask</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>();</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>实现类：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TimeWheel</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Timer</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ExecutorService</span> <span style=color:#000>service</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Executors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newFixedThreadPool</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Runtime</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRuntime</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>availableProcessors</span><span style=color:#ce5c00;font-weight:700>());</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>BlockingQueue</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>TimerTaskWrapper</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>addQueue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayBlockingQueue</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>128</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>//每一个tick时间间隔默认1毫秒
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>duration</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>//时间轮启动时间
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>startTime</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Thread</span> <span style=color:#000>timeWheelThread</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>CountDownLatch</span> <span style=color:#000>startLatch</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CountDownLatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>//时间轮的tick数量
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>tickNum</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>128</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Bucket</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>buckets</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>started</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>TimeWheel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>duration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TimeUnit</span> <span style=color:#000>unit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>nanos</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>unit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toNanos</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>duration</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MILLISECONDS</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toNanos</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>nanos</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>duration</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>duration</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>unit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toMillis</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>duration</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>timeWheelThread</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Worker</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>buckets</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Bucket</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>tickNum</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>tickNum</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>buckets</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Bucket</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>createTimerTask</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TimerTask</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>delay</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TimeUnit</span> <span style=color:#000>unit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>deadline</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>unit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toMillis</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delay</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>startTime</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;deadline=&#34;</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>deadline</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>addQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>offer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TimerTaskWrapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>deadline</span><span style=color:#ce5c00;font-weight:700>));</span>


    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>started</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>started</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>timeWheelThread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>startLatch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>await</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;启动完成&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>


    <span style=color:#8f5902;font-style:italic>//处理时间轮的转动
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Worker</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Runnable</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#8f5902;font-style:italic>//记录tick的次数
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>tick</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>

            <span style=color:#000>startTime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>startLatch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>countDown</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Worker 启动完成..........&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;</span> <span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>time</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nextTick</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>time</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>continue</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>bucketIndex</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tick</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tickNum</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>));</span>
                <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;bucketIndex=&#34;</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>bucketIndex</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>Bucket</span> <span style=color:#000>bucket</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>buckets</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>bucketIndex</span><span style=color:#ce5c00;font-weight:700>];</span>

                <span style=color:#8f5902;font-style:italic>//处理阻塞队列中的task
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>doHandleQueneTask</span><span style=color:#ce5c00;font-weight:700>();</span>

                <span style=color:#8f5902;font-style:italic>//处理过期数据
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>bucket</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>expire</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>time</span><span style=color:#ce5c00;font-weight:700>);</span>

                <span style=color:#000>tick</span><span style=color:#ce5c00;font-weight:700>++;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>


        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>doHandleQueneTask</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>

            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>1024</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>TimerTaskWrapper</span> <span style=color:#000>taskWrapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>addQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>poll</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#8f5902;font-style:italic>//队列为空
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>taskWrapper</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>taskTicks</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>taskWrapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>deadline</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>duration</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>taskWrapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rounds</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>taskTicks</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>tick</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>tickNum</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>ticks</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>max</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>taskTicks</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>tick</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>bucketIndex</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ticks</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tickNum</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>));</span>
                <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;inster bucketIndex = &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>bucketIndex</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>Bucket</span> <span style=color:#000>bucket</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>buckets</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>bucketIndex</span><span style=color:#ce5c00;font-weight:700>];</span>
                <span style=color:#000>bucket</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addTimerTask</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>taskWrapper</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#ce5c00;font-weight:700>}</span>


        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>nextTick</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>deadline</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>duration</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tick</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;</span> <span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>current</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>startTime</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>sleepTime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>deadline</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sleepTime</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sleepTime</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TimerTaskWrapper</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Runnable</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>TimerTask</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#8f5902;font-style:italic>//任务执行截止时间
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>deadline</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#8f5902;font-style:italic>//多少圈
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>rounds</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#000>TimerTaskWrapper</span> <span style=color:#000>prev</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#000>TimerTaskWrapper</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>TimerTaskWrapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TimerTask</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>deadline</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>task</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>deadline</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>deadline</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>run</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>expire</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>execute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Bucket</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#000>TimerTaskWrapper</span> <span style=color:#000>head</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#000>TimerTaskWrapper</span> <span style=color:#000>tail</span><span style=color:#ce5c00;font-weight:700>;</span>


        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>addTimerTask</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TimerTaskWrapper</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>head</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>tail</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>head</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tail</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>tail</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prev</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tail</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>tail</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>TimerTaskWrapper</span> <span style=color:#000>removeTimerTask</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TimerTaskWrapper</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

            <span style=color:#000>TimerTaskWrapper</span> <span style=color:#000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>;</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prev</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prev</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prev</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prev</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>head</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>tail</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>head</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#000>tail</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>head</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>tail</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>tail</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prev</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prev</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>

            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>


        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>expire</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>deadline</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

            <span style=color:#000>TimerTaskWrapper</span> <span style=color:#000>task</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>head</span><span style=color:#ce5c00;font-weight:700>;</span>

            <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>TimerTaskWrapper</span> <span style=color:#000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rounds</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>removeTimerTask</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>deadline</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>deadline</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>expire</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>//减少时间轮的圈数
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rounds</span><span style=color:#ce5c00;font-weight:700>--;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#000>task</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>编写一个测试案例来测试一下：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Test</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>TimeWheel</span> <span style=color:#000>wheel</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TimeWheel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SECONDS</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>wheel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createTimerTask</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TimerTask</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1111</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>wheel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createTimerTask</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SECONDS</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SECONDS</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>运行打印结果：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/docs/im/DistributedIDGenerator/timewheel-test.gif alt=timewheel-test></p><p>说明：从日志的打印可以发现，在延迟三秒的情况下你会发现打印了 <strong><code>bucketIndex=xxx</code></strong> 四次。为什么会这样打印四次呢？因为当时间轮的tick在当前的时间间隔内，这个时间是不算的，从下个开始的。所以打印了四次。</p><h3 id=3-总结>3. 总结</h3><p>从上面的实现可以看出来，时间间隔越长调用的就越不准确。例如刚开始的时候添加了任务到时间轮中，那么当前时间间隔就需要多消耗，实际的添加任务的执行时间为：当前时间轮剩下的时间+任务延迟执行的时间。所以如果对任务执行需要精确时间时间轮不适合。</p><blockquote><p>我是蚂蚁背大象，文章对你有帮助点赞关注我，文章有不正确的地方请您斧正留言评论~谢谢！</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-157758a244ffd7ac57dcef368f41f9d1>20.3 - 分布式一致性算法Raft-理论篇</h1><h3 id=1-什么是raft>1. 什么是Raft？</h3><p><a href=https://raft.github.io/>Raft</a>其实是一种分布式一致性算法(分布式共识算法)。核心还是和Paxos差不多但是更加便于理解和实现，Raft算法模块化的拆分以及相比Paxos更加简化的设计。实现Raft协议更加的简单，理解Raft算法也更加的容易(这一点可以参照<a href=https://raft.github.io/raft.pdf>Raft算法的论文</a>给出来的报告)。主要拆分成了多个模块：</p><ul><li><strong>领导人选举(Leader selection)：</strong> Raft集群启动，或者当存在的Leader节点发生故障，触发 <code>Leader selection</code> 。选举出来新的Leader</li><li><strong>日志复制(Log replication)：</strong> Leader必须从客户端接收日志条目(Log entry),然后复制的其他的节点。同时强制要求其他节点日志必须和Leader日志一致</li><li><strong>MemberShip变更：</strong> 在不停机整个Raft集群的情况做到变更集群的配置，替换宕机的机器或者改变复制集群。</li><li><strong>Snapshot：</strong> 快照功能是为了实现日志的压缩</li></ul><h4 id=11-强leader>1.1 强Leader</h4><ol><li>系统中必须存在且同一时刻只能有一个 leader，只有 leader 可以接受 clients 发过来的请求（读写请求，可优化）</li><li>Leader负责主动和所有的Follower进行通讯，负责分发Log Entry给Follower，同时统计Follower返回的ACK。</li><li>Leader通过向所有的Follower发送heartbeat维持Leader的地位</li></ol><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/others/theory/Strong%20Leader.png alt="Strong Leader"></p><h4 id=12-复制状态机>1.2 复制状态机</h4><p>一致性算法是从复制状态机的背景下提出的：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/others/theory/raft-%E5%9B%BE1.png alt></p><ol><li>Client向Leader发送append Log entry请求</li><li>Leader先写本地Log,然后将Log复制到所有的Follower</li><li>Leader收到多数Follower的应答(大于1/2),然后将Log entry对应的操作应用到状态机</li><li>Client收到Leader处理log entry结果</li></ol><h3 id=2raft的基本概念>2.Raft的基本概念</h3><h4 id=21raft的三种角色以及角色相互变动>2.1Raft的三种角色以及角色相互变动</h4><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/others/theory/raft-%E5%9B%BE4.png alt></p><p>将上面的图转换一下：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/others/theory/Raft%20role%20change.png alt="Raft role change"></p><ol><li>Follower：完全被动，不能发送任何请求，只接受并响应来自 leader 和 candidate 的 message，每个节点启动后的初始状态一定是 follower。<strong>具体实现不一定要是Follower,可以是Candidate这个看具体情况。</strong></li><li>Leader：处理所有来自Client请求，以及复制 log 到所有 followers。正常情况下所有的读写请求都经过Leader,但是这样会导致Leader的压力很大。同样这里也有优化的空间</li><li>Candidate：用来竞选一个新 leader （candidate 由 follower 触发超时而来）</li></ol><blockquote><p>服务器状态。跟随者只响应来自其他服务器的请求。如果跟随者接收不到消息，那么他就会变成候选人并发起一次选举。获得集群中大多数选票的候选人将成为领导人。在一个任期内，领导人一直都会是领导人，直到自己宕机了。</p></blockquote><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/others/theory/raft-%E5%9B%BE5.png alt></p><ul><li>Raft 把时间分割成任意长度的<strong>任期（Term）</strong>, 任期值按时间轴单调递增</li><li>每一个任期的开始都是 leader 选举，选举成功之后，leader 在任期内管理整个集群。也就是 <strong>election+normal operation</strong></li><li>每个任期最多一个Leader,也有可能没有Leader,如上图的 <strong>Term t3</strong></li></ul><h4 id=22-服务节点状态>2.2 服务节点状态</h4><p><strong>所有服务节点的持久性状态 (在响应 RPC 请求之前，已经更新到了稳定的存储设备)：</strong></p><table><thead><tr><th>参数</th><th>解释</th></tr></thead><tbody><tr><td><strong>currentTerm</strong></td><td>服务器已知最新的任期（在服务器首次启动时初始化为0，单调递增）</td></tr><tr><td><strong>votedFor</strong></td><td>当前任期内收到选票的 candidateId，如果没有投给任何候选人 则为空</td></tr><tr><td><strong>log[]</strong></td><td>日志条目；每个条目包含了用于状态机的命令，以及领导人接收到该条目时的任期（初始索引为1）</td></tr></tbody></table><p><strong>所有服务节点的易失性状态：</strong></p><table><thead><tr><th>参数</th><th>解释</th></tr></thead><tbody><tr><td>commitIndex</td><td>已知已提交的最高的日志条目的索引（初始值为0，单调递增）</td></tr><tr><td>lastApplied</td><td>已经被应用到状态机的最高的日志条目的索引（初始值为0，单调递增）</td></tr></tbody></table><p><strong>Leader上的易失性状态 (选举后已经重新初始化)：</strong></p><table><thead><tr><th>参数</th><th>解释</th></tr></thead><tbody><tr><td>nextIndex[]</td><td>对于每一台服务器，发送到该服务器的下一个日志条目的索引（初始值为领导人最后的日志条目的索引+1）</td></tr><tr><td>matchIndex[]</td><td>对于每一台服务器，已知的已经复制到该服务器的最高日志条目的索引（初始值为0，单调递增）</td></tr></tbody></table><h4 id=23-raft中三类rpc>2.3 Raft中三类RPC</h4><p><strong>RequestVote RPC(选举投票)：</strong> 由Candidate发出的用于选举投票Leader的RPC请求</p><p><strong>AppendEntries RPC(追加Log Entry)：</strong> 由领导人调用，用于日志追加。<strong>同时也可以当做心跳使用</strong>。</p><p><strong>InstallSnapshot RPC（安装快照）：</strong> 安装快照的新的 RPC 来发送快照给太落后的跟随者，由Leader发出。</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/others/theory/raft-%E5%9B%BE2.png alt></p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/others/theory/raft-%E5%9B%BE13.png alt></p><h4 id=24-raft算法特性总结>2.4 Raft算法特性总结</h4><table><thead><tr><th>特性</th><th>解释</th></tr></thead><tbody><tr><td>选举安全特性</td><td>对于一个给定的任期号，最多只会有一个领导人被选举出来</td></tr><tr><td>领导人只附加原则</td><td>领导人绝对不会删除或者覆盖自己的日志，只会增加</td></tr><tr><td>日志匹配原则</td><td>如果两个日志在某一相同索引位置日志条目的任期号相同，那么我们就认为这两个日志从头到该索引位置之间的内容完全一致</td></tr><tr><td>领导人完全特性</td><td>如果某个日志条目在某个任期号中已经被提交，那么这个条目必然出现在更大任期号的所有领导人中</td></tr><tr><td>状态机安全特性</td><td>如果某一服务器已将给定索引位置的日志条目应用至其状态机中，则其他任何服务器在该索引位置不会应用不同的日志条目</td></tr></tbody></table><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/others/theory/raft-%E5%9B%BE3.png alt></p><p><strong>说明：Raft 在任何时候都保证以上的各个特性</strong></p><h4 id=25-安全性说明>2.5 安全性说明</h4><ul><li><h4 id=选举限制><strong>选举限制</strong></h4><ul><li>选举的时候新的Leader拥有所有之前任期中已经提交的日志条目,也就是说如果前任Leader接收到日志请求后发生宕机，当前日志还没来得及通过PRC同步到Follower的情况下，整个Raft集群再次重新发起选举的时候。选举出来的Leader就是之前的Leader。因为之前的Leader包含了已经提交的全部日志条目。</li><li>Raft 通过比较两份日志中最后一条日志条目的索引值和任期号定义谁的日志比较新。如果两份日志最后的条目的任期号不同，那么任期号大的日志更加新。如果两份日志最后的条目任期号相同，那么日志比较长(last index更大)的那个就更加新。</li></ul></li><li><h4 id=提交之前任期内的日志条目>提交之前任期内的日志条目</h4><p>一条已经被存储到大多数节点上的老日志条目，也依然有可能会被未来的领导人覆盖掉。Raft 永远不会通过计算副本数目的方式去提交一个之前任期内的日志条目。只有领导人当前任期里的日志条目通过计算副本数目可以被提交；</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/others/theory/raft-%E5%9B%BE8.png alt></p><p>如图的时间序列展示了为什么领导人无法决定对老任期号的日志条目进行提交。在 (a) 中，S1 是领导人，部分的(跟随者)复制了索引位置 2 的日志条目。在 (b) 中，S1 崩溃了，然后 S5 在任期 3 里通过 S3、S4 和自己的选票赢得选举，然后从客户端接收了一条不一样的日志条目放在了索引 2 处。然后到 (c)，S5 又崩溃了；S1 重新启动，选举成功，开始复制日志。在这时，来自任期 2 的那条日志已经被复制到了集群中的大多数机器上，但是还没有被提交。如果 S1 在 (d) 中又崩溃了，S5 可以重新被选举成功（通过来自 S2，S3 和 S4 的选票），然后覆盖了他们在索引 2 处的日志。反之，如果在崩溃之前，S1 把自己主导的新任期里产生的日志条目复制到了大多数机器上，就如 (e) 中那样，那么在后面任期里面这些新的日志条目就会被提交（因为 S5 就不可能选举成功）。 这样在同一时刻就同时保证了，之前的所有老的日志条目就会被提交。</p></li></ul><h3 id=3-raft功能>3. Raft功能</h3><h4 id=31-领导人选举leader-election>3.1 领导人选举（Leader election）</h4><ul><li><p><strong>触发时机：</strong> Raft服务集群启动、Follower没有定时收到Leader heartbeat、Candidate选举超时都会触发。也就是<strong>选举超时</strong>触发</p></li><li><p><strong>随机选举超时时间：</strong> Raft 算法使用随机选举超时时间的方法来确保很少会发生选票瓜分的情况，就算发生也能很快的解决。为了阻止选票起初就被瓜分，选举超时时间是从一个固定的区间（例如 150-300 毫秒）随机选择。</p></li><li><p><strong>选举流程：</strong></p><ul><li>Follower &mdash;> Candidate（选举超时）<ul><li>Candidate&mdash;>Leader：当前节点赢得选举</li><li>Candidate&mdash;>Follower：非赢得选举节点的Candidate节点</li><li>选举Term内Candidate没有改变Candidate&mdash;>Candidate：没有任何一个Candidate节点赢得选举重新开始下一轮任期的选举</li></ul></li></ul><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/others/theory/%E9%80%89%E4%B8%BE%E6%B5%81%E7%A8%8B.png alt=选举流程></p></li><li><p><strong>选举的操作：</strong></p><ul><li>任期(Term)增加1</li><li>发送RequestVote RPC请求给Candidate</li></ul></li><li><p><strong>Leader选取原则：</strong></p><ul><li>针对同一个Term,Candidate赢得了多数选举(大于节点1/2)</li><li>Leader Term 不小于Candidate Term, Candidate承认Leader,角色转换为Follower</li><li>在选举的时候选择已提交Log Entry最多的Candidate</li><li>在选举中Leader拥有最完整的Log Entry记录</li></ul></li><li><p><strong>安全性：</strong></p><p>一个 term，最多选出一个 leader，可以没 leader，下一个 term 再选</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/others/theory/Raft%E9%80%89%E4%B8%BE.png alt=Raft选举></p><p>当一个集群中的节点是偶数个的时候，就有可能在某一轮选举投票过程中不能选举出Leader,因为可能会出现两个节点获得的投票一样。导致重新开始选举。如果没有特殊方式限制，理论上存在每次都出现投票获得情况一样。而奇数节点就能大大减少这种情况。</p></li><li><p>影响选举成功的时参数</p><ul><li>RTT(Round Trip Time)：网络延时</li><li>Heartbeat timeout：心跳间隔,目的是让 leader 能够持续发送心跳来阻止 followers 触发选举</li><li>Election timeout：Leader 与 followers 间通信超时触发选举的时间。Leader和Follower之间网络发生故障</li><li>MTBF(Meantime Between Failure)：Servers 连续常规故障时间间隔， <strong><code>RTT &lt;&lt; Heartbeat timeout &lt; Election timeout(ET) &lt;&lt; MTBF</code></strong></li><li>随机选主触发时间：150-300 毫秒选取。</li></ul></li></ul><h4 id=32-日志复制>3.2 日志复制</h4><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/others/theory/Log%20replication.png alt></p><p>Leader被选出后负责处理Client的请求， Append Log Entry请求只能通过Leader进行复制转发到Follower。</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/others/theory/raft-%E5%9B%BE6.png alt></p><p><strong>日志格式：</strong> <strong><code>logIndex+Term+log body</code></strong> ，条日志至少包含三个类型的的数据。<strong><code>logIndex+Term</code></strong> 确定一条日志。</p><p><strong>Log Replication 特点：</strong></p><ul><li><p>连续性，日志不允许出现断层。都是自然数递增的情况，例如：1、2、3&mldr;&mldr;n。</p></li><li><p>日志特性</p><ul><li>如果在不同的日志中的两个条目拥有相同的索引和任期号，那么他们存储了相同的日志</li><li>如果在不同的日志中的两个条目拥有相同的索引和任期号，那么他们之前的所有日志条目也全部相同</li><li>Leader上面的日志一定是有效的(强领导特性)，Follower的日志是否有效需要和Leader进行对比</li></ul></li><li><p>Follower日志恢复</p><p>Follower从对比Leader的lastIndex来判断Follower是否需要从Leader复制Log填充，或者truncate Follower 多余的日志。</p></li></ul><h4 id=33-committed-index>3.3 Committed Index</h4><ul><li><p>Committed Index<code>(TermId, LogIndex)</code>：本质上Log Index一样。都是Log的索引但是指向位置不同。</p><ul><li>Leader接收日志，先保存到Leader本地持久化。然后复制分发给Follower</li><li>日志复制到Followers后，先持久化，并不能马上应用到状态机</li><li>Leader收到大多数(大于1/2)Follower的返回的时候，Committed Index才能应用到状态机</li></ul></li><li><p>Committed Index推进</p><ul><li>Leader Committed Index推进：根据Leader分发日志Leader收到大多数(大于1/2)Follower的返回的时候，Committed Index才能应用到状态机</li><li>Follower Committed Index推进：Leader在下一个Append Entry或者 send Heartbeat的时候携带Leader当前Committed Index。然后Follower根据Leader 发送过来的Committed Index。把小于等于Committed Index日志应用到Follower状态机中</li></ul></li></ul><h4 id=33-日志压缩log-snapshot>3.3 日志压缩(Log Snapshot)</h4><p>Raft 的日志在正常操作中不断地增长，但是在实际的系统中，日志不能无限制地增长。随着日志不断增长，他会占用越来越多的空间，花费越来越多的时间来重置。如果没有一定的机制去清除日志里积累的陈旧的信息，那么会带来可用性问题。</p><p><strong>Snapshot</strong> 是最简单压缩方法。整个系统的状态都以快照的形式写入到稳定的持久化存储中，然后到那个时间点之前的日志全部丢弃。</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/others/theory/raft-%E5%9B%BE12.png alt></p><p>Raft 中快照的基础思想。每个服务器独立地创建快照，只包括已经被提交的日志。主要的工作包括将状态机的状态写入到快照中。Raft 也包含一些少量的元数据到快照中：<strong>最后被包含索引</strong>指的是被快照取代的最后的条目在日志中的索引值（状态机最后应用的日志），<strong>最后被包含的任期</strong>指的是该条目的任期号。保留这些数据是为了支持快照后紧接着的第一个条目的附加日志请求时的一致性检查，因为这个条目需要前一日志条目的索引值和任期号。</p><p>快照中包含的元数据：</p><table><thead><tr><th>参数</th><th>解释</th></tr></thead><tbody><tr><td>lastIncludedIndex</td><td>快照中包含的最后日志条目的索引值</td></tr><tr><td>lastIncludedTerm</td><td>快照中包含的最后日志条目的任期号</td></tr></tbody></table><p><strong>Install Snapshot（安装快照）RPC：</strong></p><p>由Leader以将快照的分块发送给跟随者。领导人总是按顺序发送分块。</p><table><thead><tr><th>参数</th><th>解释</th></tr></thead><tbody><tr><td>term</td><td>领导人的任期号</td></tr><tr><td>leaderId</td><td>领导人的 ID，以便于跟随者重定向请求</td></tr><tr><td>lastIncludedIndex</td><td>快照中包含的最后日志条目的索引值</td></tr><tr><td>lastIncludedTerm</td><td>快照中包含的最后日志条目的任期号</td></tr><tr><td>offset</td><td>分块在快照中的字节偏移量</td></tr><tr><td>data[]</td><td>从偏移量开始的快照分块的原始字节</td></tr><tr><td>done</td><td>如果这是最后一个分块则为 true</td></tr></tbody></table><table><thead><tr><th>结果</th><th>解释</th></tr></thead><tbody><tr><td>term</td><td>当前任期号（currentTerm），便于领导人更新自己</td></tr></tbody></table><p><strong>接收者实现</strong>：</p><ol><li>如果<code>term &lt; currentTerm</code>就立即回复</li><li>如果是第一个分块（offset 为 0）就创建一个新的快照</li><li>在指定偏移量写入数据</li><li>如果 done 是 false，则继续等待更多的数据</li><li>保存快照文件，丢弃具有较小索引的任何现有或部分快照</li><li>如果现存的日志条目与快照中最后包含的日志条目具有相同的索引值和任期号，则保留其后的日志条目并进行回复</li><li>丢弃整个日志</li><li>使用快照重置状态机（并加载快照的集群配置）</li></ol><h3 id=4-raft集群成员变化>4. Raft集群成员变化</h3><ul><li><strong>成员何时变化</strong><ul><li>替换宕机的机器</li><li>增加集群机器(扩容)</li><li>改变复制级别</li></ul></li><li><strong>解决方法</strong><ul><li>重启整个Raft集群</li><li>实现动态成员关系变化</li></ul></li></ul><p>首先任何集群中的Raft服务直接从旧的配置直接转换到新的配置的方案都是不安全的，不可能做到原子转换所有的集群服务。所以在转换期间整个集群存在划分成两个独立的大多数群体的可能性，需要在保证 <strong><code>安全性</code></strong> 的前提下完成：<strong>不能在同一 <code>term</code> 有多个 <code>leader</code>，否则可能存在 <code>term</code> 和 <code>index</code> 相同但内容不同的 <code>log entry</code>。</strong></p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/others/theory/raft-%E5%9B%BE10.png alt></p><blockquote><p>集群服务从 3变成了 5 。不幸的是，存在这样的一个时间点，两个不同的领导人在同一个任期里都可以被选举成功。一个是通过旧的配置，一个通过新的配置。</p></blockquote><p>Raft给出的解决方案是：Raft集群先切换到一个过度的配置也叫共同一致（<em>joint consensus</em>)，共同一致是新老配置的结合。一旦共同一致已经被提交，那么系统就切换新的配置。</p><ul><li>日志条目被复制给集群中新、老配置的所有服务。</li><li>新、旧配置的服务都可以成为领导人。</li><li>达成一致（针对选举和提交）需要分别在两种配置上获得大多数的支持。</li></ul><p><strong>好处：不影响安全的情况下，集群配置转换的过程依然可以响应客户端请求。</strong></p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/others/theory/raft-%E5%9B%BE11.png alt></p><h3 id=5-raft的优化>5. Raft的优化</h3><ul><li><strong>Log batch Append：</strong> 日志批量添加，增加Raft的写入速度</li><li><strong>ReadIndex/Lease Read：</strong> 允许Follower提供读</li></ul><p>后续会通过 <a href=https://github.com/openmessaging/dledger>DLedger</a>项目进行分析，这个项目首先比较简单整体实现起来比较清晰。同时代码量也不是很多理解更加容易。</p><blockquote><p>我是蚂蚁背大象，文章对你有帮助点赞关注我，文章有不正确的地方请您斧正留言评论~谢谢</p></blockquote><p>参考资料：</p><ul><li><p><a href=https://raft.github.io/raft.pdf>https://raft.github.io/raft.pdf</a></p></li><li><p><a href=https://github.com/maemual/raft-zh_cn/blob/master/raft-zh_cn.md>https://github.com/maemual/raft-zh_cn/blob/master/raft-zh_cn.md</a></p></li><li><p><a href=https://www.sofastack.tech/projects/sofa-jraft/consistency-raft-jraft/>https://www.sofastack.tech/projects/sofa-jraft/consistency-raft-jraft/</a></p></li><li><p><a href=https://raft.github.io/>https://raft.github.io/</a></p></li><li><p><a href=https://raft.github.io/slides/raftuserstudy2013.p>https://raft.github.io/slides/raftuserstudy2013.p</a></p></li><li><p><a href=https://github.com/openmessaging/dledger>https://github.com/openmessaging/dledger</a></p></li></ul><p>我正在参与掘金技术社区创作者签约计划招募活动，<a href=https://juejin.cn/post/7112770927082864653>点击链接报名投稿</a>。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-2fc91697d64acc0334143a3b414e7ba0>21 - “如何使用GitHub Actions自动发布JAR到Maven中央仓库"</h1><p>将Java项目的Jar包发送到Maven中央仓库基本上都是通过本地通过命令 <strong><code>mvn deploy</code></strong> 发布。平时很多Java开发者都会把项目放在GitHub上面，那么有没有一种方式在Github上面自动发布？ 这就是笔者今天要说的Github Actions自动发布JAR到Maven中央仓库。</p><blockquote><p>Tips: 想要了解正常情况下如何发布可以看一下笔者的这篇文章<a href=https://juejin.cn/post/7043398199217750030>《将Jar包发布Maven中央仓库》</a></p></blockquote><h3 id=1-前提条件>1. 前提条件</h3><ol><li>首先你之前通过正常的情况发布过Jar包到Maven中央仓库，这个是前提。</li><li>在Github创建一个Maven项目，笔者这里用 <a href=https://github.com/mxsm/rain><strong>rain</strong></a> 作为例子</li><li>OSSRH 账号、密码</li></ol><h3 id=2-发布配置>2. 发布配置</h3><h4 id=21-创建项目>2.1 创建项目</h4><p>首先在Github上面创建项目：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/docs/theory/image-20220527220609956.png alt=image-20220527220609956></p><p>然后需要注意增加两个Maven插件：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;plugin&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;groupId&gt;</span>org.apache.maven.plugins<span style=color:#204a87;font-weight:700>&lt;/groupId&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;artifactId&gt;</span>maven-gpg-plugin<span style=color:#204a87;font-weight:700>&lt;/artifactId&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;version&gt;</span>3.0.1<span style=color:#204a87;font-weight:700>&lt;/version&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;executions&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;execution&gt;</span>
            <span style=color:#204a87;font-weight:700>&lt;id&gt;</span>sign-artifacts<span style=color:#204a87;font-weight:700>&lt;/id&gt;</span>
            <span style=color:#204a87;font-weight:700>&lt;phase&gt;</span>verify<span style=color:#204a87;font-weight:700>&lt;/phase&gt;</span>
            <span style=color:#204a87;font-weight:700>&lt;goals&gt;</span>
                <span style=color:#204a87;font-weight:700>&lt;goal&gt;</span>sign<span style=color:#204a87;font-weight:700>&lt;/goal&gt;</span>
            <span style=color:#204a87;font-weight:700>&lt;/goals&gt;</span>
            <span style=color:#204a87;font-weight:700>&lt;configuration&gt;</span>
                <span style=color:#8f5902;font-style:italic>&lt;!-- Prevent `gpg` from using pinentry programs --&gt;</span>
                <span style=color:#204a87;font-weight:700>&lt;gpgArguments&gt;</span>
                    <span style=color:#204a87;font-weight:700>&lt;arg&gt;</span>--pinentry-mode<span style=color:#204a87;font-weight:700>&lt;/arg&gt;</span>
                    <span style=color:#204a87;font-weight:700>&lt;arg&gt;</span>loopback<span style=color:#204a87;font-weight:700>&lt;/arg&gt;</span>
                <span style=color:#204a87;font-weight:700>&lt;/gpgArguments&gt;</span>
            <span style=color:#204a87;font-weight:700>&lt;/configuration&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;/execution&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/executions&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/plugin&gt;</span>

<span style=color:#204a87;font-weight:700>&lt;plugin&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;groupId&gt;</span>org.sonatype.plugins<span style=color:#204a87;font-weight:700>&lt;/groupId&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;artifactId&gt;</span>nexus-staging-maven-plugin<span style=color:#204a87;font-weight:700>&lt;/artifactId&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;version&gt;</span>1.6.13<span style=color:#204a87;font-weight:700>&lt;/version&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;extensions&gt;</span>true<span style=color:#204a87;font-weight:700>&lt;/extensions&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;configuration&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;serverId&gt;</span>ossrh<span style=color:#204a87;font-weight:700>&lt;/serverId&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;nexusUrl&gt;</span>https://oss.sonatype.org/<span style=color:#204a87;font-weight:700>&lt;/nexusUrl&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;autoReleaseAfterClose&gt;</span>false<span style=color:#204a87;font-weight:700>&lt;/autoReleaseAfterClose&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/configuration&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/plugin&gt;</span>
</code></pre></div><p>具体可以参照<a href=https://github.com/mxsm/rain/blob/develop/pom.xml><strong><code>rain 项目的pom</code></strong></a> 。</p><h4 id=22-gpg信息获取>2.2 GPG信息获取</h4><p>对于GPG信息首先是你已经存在。信息查看命令：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>gpg --list-secret-keys
</code></pre></div><blockquote><p>Tips: 不存在参照文章<a href=https://juejin.cn/post/7043398199217750030>《将Jar包发布Maven中央仓库》</a>生成</p></blockquote><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/docs/theory/image-20220527221748757.png alt=image-20220527221748757></p><p>执行命令：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>gpg -a --export-secret-keys KEYID

<span style=color:#8f5902;font-style:italic>#例子</span>
gpg -a --export-secret-keys 00053070D457FA43EF20B208E9AD13776C3E943D
</code></pre></div><p>这里需要保护私钥的密码，然后回出现下面的密文:</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/docs/theory/image-20220527222222397.png alt=image-20220527222222397></p><p>上面笔者就截图了一部分，复制需要将BEGIN和END那一行全部复制后续需要配置。</p><h4 id=23-项目配置>2.3 项目配置</h4><p>配置路径： rain&ndash;>Settings&ndash;>Secrets&ndash;>Actions</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/docs/theory/image-20220527223045512.png alt=image-20220527223045512></p><h4 id=24-配置github-actions>2.4 配置Github Actions</h4><p>笔者这里使用的是 <a href=https://github.com/marketplace/actions/action-maven-publish>action-maven-publish</a> 这个Action，在项目下创建如下图文件：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/docs/theory/image-20220527223520078.png alt=image-20220527223520078></p><p>然后编写maven-publish.yml</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Publish package to the Maven Central Repository and GitHub Packages</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>on</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>push</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>branches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#000>main</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>jobs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>publish</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>runs-on</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ubuntu-latest</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>permissions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>contents</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>read</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>write</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>steps</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>uses</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>actions/checkout@v3</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Set up Java for publishing to GitHub Packages</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>uses</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>actions/setup-java@v3</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>with</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>java-version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;11&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>distribution</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;adopt&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Publish to GitHub Packages</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>run</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>mvn --batch-mode deploy -DskipTests -Prelease-github</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>env</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>GITHUB_TOKEN</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${{ secrets.GITHUB_TOKEN }}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>release</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>runs-on</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ubuntu-18.04</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>steps</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Check out Git repository</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>uses</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>actions/checkout@v2</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Install Java and Maven</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>uses</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>actions/setup-java@v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>with</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>java-version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>11</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Release Maven package</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>uses</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>samuelmeuli/action-maven-publish@v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>with</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>maven_profiles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;release-ossrh&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>maven_args</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;-DskipTests&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>gpg_private_key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${{ secrets.gpg_private_key }}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>gpg_passphrase</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${{ secrets.gpg_passphrase }}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>nexus_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${{ secrets.OSSRH_USERNAME }}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>nexus_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${{ secrets.OSSRH_TOKEN }}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>说明：我上面还增加了发布到Github的。然后保存就行了。action就会自动运行。看一下效果：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/docs/theory/image-20220527223750366.png alt=image-20220527223750366></p><p>执行完成发布后，需要登录到<a href=https://oss.sonatype.org/#welcome>OSSRH</a> close 发布的，然后就等待同步到Maven中央仓库。Maven中央仓库查询：</p><p><img src=https://raw.githubusercontent.com/mxsm/picture/main/docs/theory/image-20220527224301161.png alt=image-20220527224301161></p><p>到这里就完成了。 后续你每次提交push到对应的分支就会存在自动发布。</p><blockquote><p>我是蚂蚁背大象，文章对你有帮助点赞关注我，文章有不正确的地方请您斧正留言评论~谢谢！</p></blockquote><p>参考文档：</p><ul><li><a href=https://github.com/samuelmeuli/action-maven-publish/blob/master/docs/deployment-setup.md>https://github.com/samuelmeuli/action-maven-publish/blob/master/docs/deployment-setup.md</a></li><li><a href=https://github.com/marketplace/actions/action-maven-publish>https://github.com/marketplace/actions/action-maven-publish</a></li><li><a href=https://docs.github.com/cn/actions/publishing-packages/publishing-java-packages-with-maven>https://docs.github.com/cn/actions/publishing-packages/publishing-java-packages-with-maven</a></li></ul></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list"><a class=text-white target=_blank rel="noopener noreferrer" href=https://groups.google.com/u/1/g/ljbmxsm><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=个人掘金主页 aria-label=个人掘金主页><a class=text-white target=_blank rel="noopener noreferrer" href=https://juejin.cn/user/1151943918492855><i class="fab fa-twitter"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/mxsm><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2022 The Docsy Authors All Rights Reserved</small>
<small class=ml-1><a href=https://policies.google.com/privacy target=_blank>隐私政策</a></small><p class=mt-2><a href=/about/>Home</a></p></div></div></div></footer><div><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css><script src=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js></script><script>$("p img").wrap(function(){return'<a data-fancybox="gallery" href="'+$(this).attr('src')+'"></a>'})</script></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/mermaid@8.8.1/dist/mermaid.min.js integrity=sha384-to2w0I1OqmbJ9J6yTnIX+KYU8grNpZoD1dKPLjgEJvMe5L5+/7qvuNa2sQo8WAWj crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/raphael/2.3.0/raphael.min.js integrity="sha512-tBzZQxySO5q5lqwLWfu8Q+o4VkTcRGOeQGVQ0ueJga4A1RKuzmAu5HXDOXLEjpbKyV7ow9ympVoa6wZLEzRzDg==" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.15.0/flowchart.min.js integrity="sha512-6QsSiIybtf8tuZ6xfjRTr2tdtw3Gp4q5RSCh2b6q9seoKEQmhAG1RrCA8F0kXTwivVxRVbp/YF3zOh8rvEAU7Q==" crossorigin=anonymous></script><script src=/js/main.min.b541b310f01941a0abfd76b652b5fb60dac470573775bb5b31ff08fe3f6cea51.js integrity="sha256-tUGzEPAZQaCr/Xa2UrX7YNrEcFc3dbtbMf8I/j9s6lE=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.js></script><script type=text/javascript>docsearch({appId:'JO2SY3WDAC',apiKey:'324ddb3b679c1308e5aa8bf222e07f8b',indexName:'mxsm',inputSelector:'.td-search-input',debug:!1})</script></body></html>