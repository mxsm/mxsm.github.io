<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.83.1"><link rel=canonical type=text/html href=/other/db/elasticsearch/><link rel=alternate type=application/rss+xml href=/other/db/elasticsearch/index.xml><meta name=ROBOTS content="INDEX, FOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Elasticsearch | 蚂蚁背大象</title><meta property="og:title" content="Elasticsearch"><meta property="og:description" content="蚂蚁背大象博客"><meta property="og:type" content="website"><meta property="og:url" content="/other/db/elasticsearch/"><meta property="og:site_name" content="蚂蚁背大象"><meta itemprop=name content="Elasticsearch"><meta itemprop=description content="蚂蚁背大象博客"><meta name=twitter:card content="summary"><meta name=twitter:title content="Elasticsearch"><meta name=twitter:description content="蚂蚁背大象博客"><link rel=preload href=/scss/main.min.e09cb23c7dff3bf1285aa0294bcdc4ac8194fb3425a99c621e31e7b871315685.css as=style><link href=/scss/main.min.e09cb23c7dff3bf1285aa0294bcdc4ac8194fb3425a99c621e31e7b871315685.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 321.39 78.54"><title id="title19">DUBBO LOGO</title><path class="cls-1" d="M68.46 50.38c0 14.06 11.39 22.11 25.45 22.11s25.45-8.05 25.45-22.11V7.25H68.46zm21.24-28h8.6V31H89.7zm0 22.25h8.6v8.6H89.7zM33.24 7.25H4.06v64H33.24c10.95.0 19.3-7.18 23.29-17.15a45.12 45.12.0 002.38-14.87A45.12 45.12.0 0056.53 24.4C52.84 14.62 44.19 7.25 33.24 7.25zm.43 14.63H30.34a3.44 3.44.0 00-3.44 3.44V53.23a3.44 3.44.0 003.44 3.44h3.33v4.63h-8.3a6.87 6.87.0 01-6.87-6.87V24.12a6.87 6.87.0 016.87-6.87h8.3zM285.51 6.06c-17.05.0-30.88 10.28-30.88 33.21s13.83 33.21 30.88 33.21 30.88-10.28 30.88-33.21S302.56 6.06 285.51 6.06zm7.59 48.36a6.87 6.87.0 01-6.87 6.87h-8.3V56.67h3.33a3.44 3.44.0 003.44-3.44V25.31a3.44 3.44.0 00-3.44-3.44h-3.33V17.25h8.3a6.87 6.87.0 016.87 6.87zm-53.4-17.56A17.39 17.39.0 00227.31 7.25H195.1v64h32.21a19.44 19.44.0 0012.38-34.44zM211.63 61.29h-6.08l18.68-44h6.08zM177 36.85A17.39 17.39.0 00164.65 7.25H132.43v64h32.21A19.44 19.44.0 00177 36.85zM149 61.29h-6.08l18.68-44h6.08z" style="fill:#fff;fill-opacity:1"/></svg></span><span class="text-uppercase font-weight-bold">蚂蚁背大象</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/about/><span>Home</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog/><span>Java</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/spring/><span>Spring</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/middlewares/><span>Middleware</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/><span>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/other/><span class=active>Others</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community/><span>Community</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002 站内搜索…" aria-label=站内搜索… autocomplete=off></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/other/db/elasticsearch/>Return to the regular view of this page</a>.</p></div><h1 class=title>Elasticsearch</h1><ul><li>1: <a href=#pg-3ba9b40140caede44a523a63c07edd2a>Elasticsearch Mapping</a></li><ul><li>1.1: <a href=#pg-9c8e7b95edb840f027d21d643e447743>Elasticsearch-元数据</a></li></ul><li>2: <a href=#pg-c41f9e3d45e990c68edbb3c5f7588ccf>Elasticsearch 查询DSL</a></li><ul><li>2.1: <a href=#pg-1bec54c06fd5bfa70738192554abd0f6>复合查询</a></li><ul><li>2.1.1: <a href=#pg-5842184e8950bd6979597144c6d13ac8>Elasticsearch复合查询-boosting query查询</a></li><li>2.1.2: <a href=#pg-1f3ccaf409495f5a278314a1a9ecc794>Elasticsearch复合查询-Constant score query查询</a></li><li>2.1.3: <a href=#pg-abbbba3364147f531a55fc26401e66f1>Elasticsearch复合查询-Boolean查询</a></li><li>2.1.4: <a href=#pg-5562c7834eadd03c46f44be1321441d0>Elasticsearch复合查询-Disjunction max query</a></li></ul></ul><li>3: <a href=#pg-fcdebd986e21ba3e19eb2edbfe214887>Elasticsearch 索引</a></li><ul><li>3.1: <a href=#pg-2a343fe20075bfa2165e414ca1f82ae5>Elasticsearch-索引模式</a></li></ul><li>4: <a href=#pg-98885c5652d1ba82ef8776e8bf9533ae>elasticsearch基本概念</a></li></ul><div class=content></div></div><div class=td-content><h1 id=pg-3ba9b40140caede44a523a63c07edd2a>1 - Elasticsearch Mapping</h1></div><div class=td-content><h1 id=pg-9c8e7b95edb840f027d21d643e447743>1.1 - Elasticsearch-元数据</h1><blockquote><p>注意：以下语法都是基于Elasticsearch的7.6版本</p></blockquote><h3 id=元数据字段>元数据字段</h3><p>每个文档都有与之相关联的元数据，比如 _index、mapping _type和 _id元字段。在创建映射类型时，可以定制其中一些元字段的行为。</p><h4 id=身份元数据>身份元数据</h4><table><thead><tr><th>元数据</th><th>说明</th></tr></thead><tbody><tr><td><strong>_index</strong></td><td>文档属于那个索引</td></tr><tr><td><strong>_type</strong></td><td>文档所属类型</td></tr><tr><td><strong>_id</strong></td><td>文档的唯一标识</td></tr></tbody></table><h4 id=文档元数据>文档元数据</h4><table><thead><tr><th>元数据</th><th>说明</th></tr></thead><tbody><tr><td><strong>_source</strong></td><td>表示文档主体的原始JSON</td></tr><tr><td><strong>_size</strong></td><td>_source字段的大小</td></tr></tbody></table><h4 id=索引的元数据>索引的元数据</h4><table><thead><tr><th>元数据</th><th>说明</th></tr></thead><tbody><tr><td><strong>_field_names</strong></td><td>文档中包含非空值的所有字段</td></tr><tr><td><strong>_ignored</strong></td><td>在索引时被忽略的文档中的所有字段</td></tr></tbody></table><h4 id=路由元数据>路由元数据</h4><table><thead><tr><th>元数据</th><th>说明</th></tr></thead><tbody><tr><td><strong>_routing</strong></td><td>自定义路由值将文档路由到特定的分片</td></tr></tbody></table><h4 id=其他元数据>其他元数据</h4><table><thead><tr><th>元数据</th><th>说明</th></tr></thead><tbody><tr><td><strong>_meta</strong></td><td>应用程序的特定元数据。</td></tr></tbody></table><h3 id=元数据详解>元数据详解</h3><p>下面来一一说明这些元数据。</p><h4 id=_index元数据>_index元数据</h4><p>在跨多个索引执行查询时，有时需要添加仅与特定索引的文档相关联的查询子句。_index字段允许对索引到的文档的索引进行匹配。它的值可以在某些查询和聚合中访问，也可以在排序或编写脚本时访问：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#a40000>PUT</span> <span style=color:#a40000>index_</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#a40000>/_doc/</span><span style=color:#0000cf;font-weight:700>1</span>
<span style=color:#000;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>&#34;text&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Document in index 1&#34;</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#a40000>PUT</span> <span style=color:#a40000>index_</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#a40000>/_doc/</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#a40000>?refresh=</span><span style=color:#204a87;font-weight:700>true</span>
<span style=color:#000;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>&#34;text&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Document in index 2&#34;</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#a40000>GET</span> <span style=color:#a40000>index_</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#a40000>,index_</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#a40000>/_search</span>
<span style=color:#000;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>&#34;query&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;terms&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;_index&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;index_1&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;index_2&#34;</span><span style=color:#000;font-weight:700>]</span> 
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>},</span>
  <span style=color:#204a87;font-weight:700>&#34;aggs&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;indices&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;terms&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>&#34;field&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;_index&#34;</span><span style=color:#000;font-weight:700>,</span> 
        <span style=color:#204a87;font-weight:700>&#34;size&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>10</span>
      <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>},</span>
  <span style=color:#204a87;font-weight:700>&#34;sort&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
    <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;_index&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span> 
        <span style=color:#204a87;font-weight:700>&#34;order&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;asc&#34;</span>
      <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>],</span>
  <span style=color:#204a87;font-weight:700>&#34;script_fields&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;index_name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;script&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>&#34;lang&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;painless&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>&#34;source&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;doc[&#39;_index&#39;]&#34;</span> 
      <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>

</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-c41f9e3d45e990c68edbb3c5f7588ccf>2 - Elasticsearch 查询DSL</h1></div><div class=td-content><h1 id=pg-1bec54c06fd5bfa70738192554abd0f6>2.1 - 复合查询</h1></div><div class=td-content><h1 id=pg-5842184e8950bd6979597144c6d13ac8>2.1.1 - Elasticsearch复合查询-boosting query查询</h1><blockquote><p>注意：以下语法都是基于Elasticsearch的7.6版本</p></blockquote><h3 id=boosting-query>boosting query</h3><p>在前面的boolean的复合查询我们可以通过<code>must_not+must</code> 先剔除不想匹配的文档，再获取匹配的文档，但是有一种场景就是我并不需要完全剔除，而是把需要剔除的那部分文档的分数降低。这个时候就可以使用boosting query。下面会举例说明（官方例子）：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#a40000>GET</span> <span style=color:#a40000>/_search</span>
<span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;query&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>&#34;boosting&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>&#34;positive&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>&#34;term&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>&#34;text&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;apple&#34;</span>
                <span style=color:#000;font-weight:700>}</span>
            <span style=color:#000;font-weight:700>},</span>
            <span style=color:#204a87;font-weight:700>&#34;negative&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
                 <span style=color:#204a87;font-weight:700>&#34;term&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
                     <span style=color:#204a87;font-weight:700>&#34;text&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;pie tart fruit crumble tree&#34;</span>
                <span style=color:#000;font-weight:700>}</span>
            <span style=color:#000;font-weight:700>},</span>
            <span style=color:#204a87;font-weight:700>&#34;negative_boost&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>0.5</span>
        <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><pre><code>说明`boosting需要搭配三个关键字 `positive` , `negative` , `negative_boost
</code></pre><p>只有匹配了 <strong>positive查询</strong> 的文档才会被包含到结果集中，但是同时匹配了<strong>negative查询</strong> 的文档会被降低其相关度，通过将文档原本的<code>_score和negative_boost</code>参数进行</p><p>相乘来得到新的_score。因此，<code>negative_boost参数一般小于1.0</code>。在上面的例子中，任何包含了指定负面词条的文档的<code>_score</code>都会是其原本_score的一半。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-1f3ccaf409495f5a278314a1a9ecc794>2.1.2 - Elasticsearch复合查询-Constant score query查询</h1><blockquote><p>注意：以下语法都是基于Elasticsearch的7.6版本</p></blockquote><h3 id=constant-score-query>Constant score query</h3><p>包装筛选器查询，并返回每个匹配的文档，其相关性得分等于boost参数值。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#a40000>POST</span> <span style=color:#a40000>twitter/_search</span>
<span style=color:#000;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>&#34;query&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;constant_score&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;filter&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>&#34;match&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>&#34;content&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;apple&#34;</span>
        <span style=color:#000;font-weight:700>}</span>
      <span style=color:#000;font-weight:700>},</span>
      <span style=color:#204a87;font-weight:700>&#34;boost&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>100</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><ul><li><p><strong>filter</strong></p><p>(必选，查询对象)筛选您希望运行的查询。任何返回的文档都必须匹配此查询。过滤查询不计算相关分数。为了提高性能，Elasticsearch自动缓存常用的过滤查询。</p></li><li><p><strong>boost</strong></p><p>(可选，浮点数)浮点数用作与筛选器查询匹配的每个文档的常数相关分数。默认为1.0。</p></li></ul><p>结果：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>&#34;took&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>&#34;timed_out&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>&#34;_shards&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;total&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#204a87;font-weight:700>&#34;successful&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#204a87;font-weight:700>&#34;skipped&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#204a87;font-weight:700>&#34;failed&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>0</span>
  <span style=color:#000;font-weight:700>},</span>
  <span style=color:#204a87;font-weight:700>&#34;hits&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;total&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;value&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;relation&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;eq&#34;</span>
    <span style=color:#000;font-weight:700>},</span>
    <span style=color:#204a87;font-weight:700>&#34;max_score&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>100.0</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#204a87;font-weight:700>&#34;hits&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
      <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>&#34;_index&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;twitter&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>&#34;_type&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;_doc&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>&#34;_id&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;2&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>&#34;_score&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>100.0</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>&#34;_source&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>&#34;content&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Apple iPad&#34;</span>
        <span style=color:#000;font-weight:700>}</span>
      <span style=color:#000;font-weight:700>},</span>
      <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>&#34;_index&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;twitter&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>&#34;_type&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;_doc&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>&#34;_id&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;3&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>&#34;_score&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>100.0</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>&#34;_source&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>&#34;content&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Apple employee like Apple Pie and Apple Juice&#34;</span>
        <span style=color:#000;font-weight:700>}</span>
      <span style=color:#000;font-weight:700>},</span>
      <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>&#34;_index&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;twitter&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>&#34;_type&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;_doc&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>&#34;_id&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>&#34;_score&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>100.0</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>&#34;_source&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>&#34;content&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Apple Mac&#34;</span>
        <span style=color:#000;font-weight:700>}</span>
      <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>]</span>
  <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>

</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-abbbba3364147f531a55fc26401e66f1>2.1.3 - Elasticsearch复合查询-Boolean查询</h1><blockquote><p>注意：以下语法都是基于Elasticsearch的7.6版本</p></blockquote><h3 id=布尔查询>布尔查询</h3><p>Bool查询语法有以下特点</p><ol><li>子查询可以任意顺序出现</li><li>可以嵌套多个查询，包括bool查询</li><li>如果bool查询中没有must条件，should中必须至少满足一条才会返回结果。</li></ol><p>匹配文档与其他查询的布尔组合的查询。bool查询映射到Lucene BooleanQuery。它是使用一个或多个布尔子句构建的，每个子句都有一个类型化的出现，发生类型</p><table><thead><tr><th>发生类型</th><th>描述</th></tr></thead><tbody><tr><td><code>must</code></td><td>子句(查询)必须出现在匹配的文档中，并对分数有贡献(<strong>必须匹配。贡献算分</strong>)</td></tr><tr><td><code>filter</code></td><td>子句(查询)必须出现在匹配的文档中。但是与“必须”不同的是，查询的分数将被忽略。筛选器子句在筛选器上下文中执行，这意味着忽略评分，并考虑子句用于缓存。(<strong>过滤子句，必须匹配，但不贡献算分</strong>)</td></tr><tr><td><code>should</code></td><td>子句(查询)应该出现在匹配的文档中（<strong>选择性匹配，至少满足一条。贡献算分</strong>）</td></tr><tr><td><code>must_not</code></td><td>子句(查询)不能出现在匹配的文档中。子句在筛选器上下文中执行，这意味着忽略评分，而子句用于缓存。因为忽略了评分，所以返回所有文档的“0”评分。(<strong>过滤子句，必须不能匹配，但不贡献算分</strong>)</td></tr></tbody></table><p>bool查询采用的是“匹配越多越好”的方法，因此来自每个匹配的must或should子句的分数将被添加到一起，以提供每个文档的最终_score。例子：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#a40000>POST</span> <span style=color:#a40000>_search</span>
<span style=color:#000;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>&#34;query&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;bool&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;must&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>&#34;term&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>&#34;user&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;kimchy&#34;</span> <span style=color:#000;font-weight:700>}</span>
      <span style=color:#000;font-weight:700>},</span>
      <span style=color:#204a87;font-weight:700>&#34;filter&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>&#34;term&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>&#34;tag&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;tech&#34;</span> <span style=color:#000;font-weight:700>}</span>
      <span style=color:#000;font-weight:700>},</span>
      <span style=color:#204a87;font-weight:700>&#34;must_not&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>&#34;range&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>&#34;age&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>&#34;gte&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>&#34;lte&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>20</span> <span style=color:#000;font-weight:700>}</span>
        <span style=color:#000;font-weight:700>}</span>
      <span style=color:#000;font-weight:700>},</span>
      <span style=color:#204a87;font-weight:700>&#34;should&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
        <span style=color:#000;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>&#34;term&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>&#34;tag&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;wow&#34;</span> <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>},</span>
        <span style=color:#000;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>&#34;term&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>&#34;tag&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;elasticsearch&#34;</span> <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>}</span>
      <span style=color:#000;font-weight:700>],</span>
      <span style=color:#204a87;font-weight:700>&#34;minimum_should_match&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;boost&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>1.0</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><h4 id=使用minimum_should_match>使用minimum_should_match</h4><p>可以使用minimum_should_match参数指定返回的文档必须匹配的should子句的数量或百分比。如果bool查询包含至少一个should子句和没有 must或filter子句，则默认值为1。否则，默认值为0。其他的值<a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-minimum-should-match.html>minimum_should_match</a>。</p><h4 id=用boolfilter评分>用bool.filter评分</h4><p>在筛选器元素下指定的查询对评分没有影响—返回的分数为0。分数只受指定查询的影响。例如，以下三个查询都返回status字段中包含术语active的所有文档。第一个查询为所有文档赋值0分，因为没有指定打分查询：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#a40000>GET</span> <span style=color:#a40000>_search</span>
<span style=color:#000;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>&#34;query&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;bool&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;filter&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>&#34;term&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>&#34;status&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;active&#34;</span>
        <span style=color:#000;font-weight:700>}</span>
      <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>这个bool查询有一个match_all查询，它为所有文档赋值1.0</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#a40000>GET</span> <span style=color:#a40000>_search</span>
<span style=color:#000;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>&#34;query&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;bool&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;must&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>&#34;match_all&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{}</span>
      <span style=color:#000;font-weight:700>},</span>
      <span style=color:#204a87;font-weight:700>&#34;filter&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>&#34;term&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>&#34;status&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;active&#34;</span>
        <span style=color:#000;font-weight:700>}</span>
      <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>这个constant_score查询的行为与上面的第二个示例完全相同。constant_score查询为筛选器匹配的所有文档分配1.0分。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#a40000>GET</span> <span style=color:#a40000>_search</span>
<span style=color:#000;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>&#34;query&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;constant_score&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;filter&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>&#34;term&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>&#34;status&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;active&#34;</span>
        <span style=color:#000;font-weight:700>}</span>
      <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-5562c7834eadd03c46f44be1321441d0>2.1.4 - Elasticsearch复合查询-Disjunction max query</h1><blockquote><p>注意：以下语法都是基于Elasticsearch的7.6版本</p></blockquote><h3 id=disjunction-max-query最佳匹配查询>Disjunction max query(最佳匹配查询)</h3><p>返回与一个或多个包装查询(称为查询子句或子句)匹配的文档。</p><p>如果返回的文档匹配多个查询子句，dis_max查询将从任何匹配子句中为文档分配最高的相关性得分，并为任何其他匹配子查询分配一个打破平局的增量。</p><p>您可以使用dis_max在映射了不同boost因子的字段中搜索一个术语。下面看一下官方的例子：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#a40000>GET</span> <span style=color:#a40000>/_search</span>
<span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;query&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>&#34;dis_max&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>&#34;queries&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
                <span style=color:#000;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>&#34;term&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>&#34;title&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Quick pets&#34;</span> <span style=color:#000;font-weight:700>}},</span>
                <span style=color:#000;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>&#34;term&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>&#34;body&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Quick pets&#34;</span> <span style=color:#000;font-weight:700>}}</span>
            <span style=color:#000;font-weight:700>],</span>
            <span style=color:#204a87;font-weight:700>&#34;tie_breaker&#34;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>0.7</span>
        <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><ul><li><p><strong>queries</strong></p><p>(必须参数，查询对象数组)包含一个或多个查询子句。返回的文档必须匹配一个或多个这些查询。如果文档匹配多个查询，则Elasticsearch使用最高的相关性得分。</p></li><li><p><strong>tie_breaker</strong></p><p>0到1.0之间的浮点数，用于增加匹配多个查询子句的文档的相关性得分。默认为0.0。您可以使用tie_breaker值为在多个字段中包含相同术语的文档分配较高的相关性分数，而不是只在多个字段中包含该术语的文档中最好的一个，而不会将其与多个字段中两个不同术语的较好情况相混淆。如果一个文档匹配多个子句，dis_max查询将计算该文档的相关分数，如下所示:</p><ol><li>从具有最高分数的匹配子句中获取关联分数。</li><li>将任何其他匹配子句的得分乘以tie_breaker值。</li><li>把最高的分数加到相乘的分数上。</li></ol><p>如果tie_breaker值大于0.0，所有匹配的子句都算数，但是分数最高的子句算数最多。</p></li></ul><h3 id=例子>例子</h3><pre><code>#1、创建索引
PUT /dismaxmxsm
{
    &quot;settings&quot;: {
        &quot;number_of_shards&quot;: 1,
        &quot;number_of_replicas&quot;: 1
    },
    &quot;mappings&quot;: {
            &quot;properties&quot;: {
                &quot;title&quot;: {
                    &quot;type&quot;:&quot;text&quot;
                },
                &quot;content&quot;: {
                    &quot;type&quot;:&quot;text&quot;
                }
        }
    }
}

#2、创建数据
PUT  /dismaxmxsm/_doc/1 
{
  &quot;title&quot; : &quot;Java&quot;,  
  &quot;content&quot; : &quot;Javajava&quot; 
}
PUT  /dismaxmxsm/_doc/2
{
  &quot;title&quot; : &quot;GO&quot;, 
  &quot;content&quot; : &quot;Development GO&quot;
}
PUT  /dismaxmxsm/_doc/3
{
  &quot;title&quot; :&quot;python&quot;, 
  &quot;content&quot; :&quot;Python development beginner&quot;
}
</code></pre><h4 id=用should查询>用should查询</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#a40000>GET</span> <span style=color:#a40000>dismaxmxsm/_search</span>
<span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;query&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>&#34;bool&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>&#34;should&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
                <span style=color:#000;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>&#34;match&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>&#34;title&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;java &#34;</span> <span style=color:#000;font-weight:700>}},</span>
                <span style=color:#000;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>&#34;match&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>&#34;content&#34;</span><span style=color:#000;font-weight:700>:</span>  <span style=color:#4e9a06>&#34;java beginner&#34;</span> <span style=color:#000;font-weight:700>}}</span>
            <span style=color:#000;font-weight:700>]</span>
        <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>结果：</p><pre><code>{
  &quot;took&quot; : 0,
  &quot;timed_out&quot; : false,
  &quot;_shards&quot; : {
    &quot;total&quot; : 1,
    &quot;successful&quot; : 1,
    &quot;skipped&quot; : 0,
    &quot;failed&quot; : 0
  },
  &quot;hits&quot; : {
    &quot;total&quot; : {
      &quot;value&quot; : 2,
      &quot;relation&quot; : &quot;eq&quot;
    },
    &quot;max_score&quot; : 0.9808291,
    &quot;hits&quot; : [
      {
        &quot;_index&quot; : &quot;dismaxmxsm&quot;,
        &quot;_type&quot; : &quot;_doc&quot;,
        &quot;_id&quot; : &quot;1&quot;,
        &quot;_score&quot; : 0.9808291,
        &quot;_source&quot; : {
          &quot;title&quot; : &quot;Java&quot;,
          &quot;content&quot; : &quot;Javajava&quot;
        }
      },
      {
        &quot;_index&quot; : &quot;dismaxmxsm&quot;,
        &quot;_type&quot; : &quot;_doc&quot;,
        &quot;_id&quot; : &quot;3&quot;,
        &quot;_score&quot; : 0.81427324,
        &quot;_source&quot; : {
          &quot;title&quot; : &quot;python&quot;,
          &quot;content&quot; : &quot;Python development beginner&quot;
        }
      }
    ]
  }
}
</code></pre><h4 id=用dis_max查询>用dis_max查询</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#a40000>GET</span> <span style=color:#a40000>dismaxmxsm/_search</span>
<span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;query&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>&#34;dis_max&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>&#34;queries&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
                <span style=color:#000;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>&#34;match&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>&#34;title&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;java&#34;</span> <span style=color:#000;font-weight:700>}},</span>
                <span style=color:#000;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>&#34;match&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>&#34;content&#34;</span><span style=color:#000;font-weight:700>:</span>  <span style=color:#4e9a06>&#34;java beginner&#34;</span> <span style=color:#000;font-weight:700>}}</span>
            <span style=color:#000;font-weight:700>]</span>
            <span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>&#34;tie_breaker&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>0.7</span>
        <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>结果：</p><pre><code>{
  &quot;took&quot; : 1,
  &quot;timed_out&quot; : false,
  &quot;_shards&quot; : {
    &quot;total&quot; : 1,
    &quot;successful&quot; : 1,
    &quot;skipped&quot; : 0,
    &quot;failed&quot; : 0
  },
  &quot;hits&quot; : {
    &quot;total&quot; : {
      &quot;value&quot; : 2,
      &quot;relation&quot; : &quot;eq&quot;
    },
    &quot;max_score&quot; : 0.9808291,
    &quot;hits&quot; : [
      {
        &quot;_index&quot; : &quot;dismaxmxsm&quot;,
        &quot;_type&quot; : &quot;_doc&quot;,
        &quot;_id&quot; : &quot;1&quot;,
        &quot;_score&quot; : 0.9808291,
        &quot;_source&quot; : {
          &quot;title&quot; : &quot;Java&quot;,
          &quot;content&quot; : &quot;Javajava&quot;
        }
      },
      {
        &quot;_index&quot; : &quot;dismaxmxsm&quot;,
        &quot;_type&quot; : &quot;_doc&quot;,
        &quot;_id&quot; : &quot;3&quot;,
        &quot;_score&quot; : 0.81427324,
        &quot;_source&quot; : {
          &quot;title&quot; : &quot;python&quot;,
          &quot;content&quot; : &quot;Python development beginner&quot;
        }
      }
    ]
  }
}

</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-fcdebd986e21ba3e19eb2edbfe214887>3 - Elasticsearch 索引</h1></div><div class=td-content><h1 id=pg-2a343fe20075bfa2165e414ca1f82ae5>3.1 - Elasticsearch-索引模式</h1><blockquote><p>注意：以下语法都是基于Elasticsearch的7.6版本</p></blockquote><h3 id=索引模式>索引模式</h3><p>之前介绍过，在ES中index相当于关系数据库中的数据库实例。下面来看一下index的一些设置</p><h3 id=索引的设置>索引的设置</h3><p>可以为每一个索引设置级别，如下：</p><ul><li><p><em><strong>静态索引(static)</strong></em></p><p>只能在创建索引或者在关闭的索引上面设置</p></li><li><p><em><strong>动态索引dynamic</strong></em></p><p>可以使用<a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-update-settings.html>update-index-settings API</a>在活动索引上更改它们。</p></li></ul><blockquote><p>注意：更改关闭索引上的静态或动态索引设置可能导致错误的设置，如果不删除和重新创建索引，就无法纠正这些错误</p></blockquote><h4 id=静态索引设置>静态索引设置</h4><p>下面列举了所有的与任何特殊索引无关的静态索引的配置：</p><ul><li><p><strong>index.number_of_shards</strong></p><p>索引应该具有的主分片数量， <strong>默认值为：1，同时这个设置只能在索引创建的时候，不能再关闭了的索引上面进行修改。索引（index）分片的最大值为1024</strong> 。 这个设置以防止由于资源分配而意外创建可能破坏集群稳定的索引。通过 <strong>export ES_JAVA_OPTS="-Des.index.max_number_of_shards=128"</strong> 来设置。</p></li><li><p><strong>index.shard.check_on_startup</strong></p><p>是否应该在打开之前检查分片是否损坏。当检测到损坏时，它将阻止碎片被打开</p><ul><li><p><strong>false</strong></p><p>默认值</p></li><li><p><strong>checksum</strong></p><p>检查是否物理损坏</p></li><li><p><strong>true</strong></p><p>检查物理损坏和逻辑损坏</p></li></ul><blockquote><p>注意： 检查分片可能花费很多时间，在一个很大的索引上面</p></blockquote></li><li><p><strong>index.codec</strong></p><p>默认值使用LZ4压缩压缩存储的数据，但是可以将这个值设置为best_compression，它使用DEFLATE获得更高的压缩比，代价是降低存储字段的性能。如果您正在更新压缩类型，则新的压缩类型将在段合并后应用。段合并可以使用强制合并来强制执行。</p></li><li><p><strong>index.routing_partition_size</strong></p><p>自定义路由值可以转到的碎片数。默认值为1，只能在创建索引时设置。这个值必须小于索引。除非索引是number_of_shards。number_of_shards的值也是1。有关如何使用此设置的详细信息，<a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-routing-field.html#routing-index-partition>请参阅路由到索引分区</a>。</p></li><li><p><strong>index.load_fixed_bitset_filters_eagerly</strong></p><p>指示是否为嵌套查询预先加载缓存的筛选器。可能的值为true(默认值)和false。</p></li></ul><h4 id=动态索引设置>动态索引设置</h4><ul><li><p><strong>index.number_of_replicas</strong></p><p>每个主分片副本的数量，默认值：1</p></li><li><p><strong>index.auto_expand_replicas</strong></p><p>根据集群中数据节点的数量自动扩展副本的数量。设置为以破折号分隔的下界和上界(例如0-5)，或将all用于上界(例如0-all)。默认为false(即禁用)。注意auto-expanded数量的副本只需要配置过滤规则,但是忽略了其他的分配规则,如碎片分配每个节点感知和总碎片,这可能导致集群健康成为黄色如果适用的规则防止所有的副本分配。</p></li><li><p><strong>index.search.idle.after</strong></p><p>设置分片被认为搜索无效，不能接收搜索或获取请求的时间。（<strong>默认值30s</strong>）</p></li><li><p><strong>index.refresh_interval</strong></p><p>执行刷新操作的频率，使对索引的最新更改对搜索可见。默认为1。可以设置为-1以禁用刷新。如果没有显式设置此设置，则至少index.search.idle没有看到搜索流量的分片。秒后将不会收到背景刷新，直到他们收到一个搜索请求。在等待刷新的地方遇到空闲分片的搜索将等待下一次后台刷新(在1秒内)。此行为的目的是在不执行搜索的默认情况下自动优化批量索引。为了避免这种行为，应该将1s的显式值设置为刷新间隔。</p></li><li><p><strong><code>index.max_inner_result_window</code></strong></p><p>The maximum value of <code>from + size</code> for inner hits definition and top hits aggregations to this index. Defaults to <code>100</code>. Inner hits and top hits aggregation take heap memory and time proportional to <code>from + size</code> and this limits that memory.</p></li><li><p><strong><code>index.max_rescore_window</code></strong></p><p>The maximum value of <code>window_size</code> for <code>rescore</code> requests in searches of this index. Defaults to <code>index.max_result_window</code> which defaults to <code>10000</code>. Search requests take heap memory and time proportional to <code>max(window_size, from + size)</code> and this limits that memory.</p></li><li><p><strong><code>index.max_docvalue_fields_search</code></strong></p><p>The maximum number of <code>docvalue_fields</code> that are allowed in a query. Defaults to <code>100</code>. Doc-value fields are costly since they might incur a per-field per-document seek.</p></li><li><p><strong><code>index.max_script_fields</code></strong></p><p>The maximum number of <code>script_fields</code> that are allowed in a query. Defaults to <code>32</code>.</p></li><li><p><strong><code>index.max_ngram_diff</code></strong></p><p>The maximum allowed difference between min_gram and max_gram for NGramTokenizer and NGramTokenFilter. Defaults to <code>1</code>.</p></li><li><p><strong><code>index.max_shingle_diff</code></strong></p><p>The maximum allowed difference between max_shingle_size and min_shingle_size for ShingleTokenFilter. Defaults to <code>3</code>.</p></li><li><p><strong><code>index.blocks.read_only</code></strong></p><p>Set to <code>true</code> to make the index and index metadata read only, <code>false</code> to allow writes and metadata changes.</p></li><li><p><strong><code>index.blocks.read_only_allow_delete</code></strong></p><p>Similar to <code>index.blocks.read_only</code> but also allows deleting the index to free up resources. The <a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/disk-allocator.html>disk-based shard allocator</a> may add and remove this block automatically.</p></li><li><p><strong><code>index.blocks.read</code></strong></p><p>Set to <code>true</code> to disable read operations against the index.</p></li><li><p><strong><code>index.blocks.write</code></strong></p><p>Set to <code>true</code> to disable data write operations against the index. Unlike <code>read_only</code>, this setting does not affect metadata. For instance, you can close an index with a <code>write</code> block, but not an index with a <code>read_only</code> block.</p></li><li><p><strong><code>index.blocks.metadata</code></strong></p><p>Set to <code>true</code> to disable index metadata reads and writes.</p></li><li><p><strong><code>index.max_refresh_listeners</code></strong></p><p>Maximum number of refresh listeners available on each shard of the index. These listeners are used to implement <a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-refresh.html><code>refresh=wait_for</code></a>.</p></li><li><p><strong><code>index.analyze.max_token_count</code></strong></p><p>The maximum number of tokens that can be produced using _analyze API. Defaults to <code>10000</code>.</p></li><li><p><strong><code>index.highlight.max_analyzed_offset</code></strong></p><p>The maximum number of characters that will be analyzed for a highlight request. This setting is only applicable when highlighting is requested on a text that was indexed without offsets or term vectors. Defaults to <code>1000000</code>.</p></li><li><p><strong><code>index.max_terms_count</code></strong></p><p>The maximum number of terms that can be used in Terms Query. Defaults to <code>65536</code>.</p></li><li><p><strong><code>index.max_regex_length</code></strong></p><p>The maximum length of regex that can be used in Regexp Query. Defaults to <code>1000</code>.</p></li><li><p><strong><code>index.routing.allocation.enable</code></strong></p><p>Controls shard allocation for this index. It can be set to:<code>all</code> (default) - Allows shard allocation for all shards.<code>primaries</code> - Allows shard allocation only for primary shards.<code>new_primaries</code> - Allows shard allocation only for newly-created primary shards.<code>none</code> - No shard allocation is allowed.</p></li><li><p><strong><code>index.routing.rebalance.enable</code></strong></p><p>Enables shard rebalancing for this index. It can be set to:<code>all</code> (default) - Allows shard rebalancing for all shards.<code>primaries</code> - Allows shard rebalancing only for primary shards.<code>replicas</code> - Allows shard rebalancing only for replica shards.<code>none</code> - No shard rebalancing is allowed.</p></li><li><p><strong><code>index.gc_deletes</code></strong></p><p>The length of time that a <a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-delete.html#delete-versioning>deleted document’s version number</a> remains available for <a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-index_.html#index-versioning>further versioned operations</a>. Defaults to <code>60s</code>.</p></li><li><p><strong><code>index.default_pipeline</code></strong></p><p>The default <a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/ingest.html>ingest node</a> pipeline for this index. Index requests will fail if the default pipeline is set and the pipeline does not exist. The default may be overridden using the <code>pipeline</code> parameter. The special pipeline name <code>_none</code> indicates no ingest pipeline should be run.</p></li><li><p><strong><code>index.final_pipeline</code></strong></p><p>The final <a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/ingest.html>ingest node</a> pipeline for this index. Index requests will fail if the final pipeline is set and the pipeline does not exist. The final pipeline always runs after the request pipeline (if specified) and the default pipeline (if it exists). The special pipeline name <code>_none</code> indicates no ingest pipeline will run.</p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-98885c5652d1ba82ef8776e8bf9533ae>4 - elasticsearch基本概念</h1><h3 id=基本概念>基本概念</h3><p>首先了解一下ES的几个基本概念。</p><h4 id=索引index>索引(index)</h4><p>ElasticSearch把数据存放到一个或者多个索引(indices)中。如果用关系型数据库模型对比，索引(index)的地位与数据库实例(database)相当。索引存放和读取的基本单元是文档(Document)。我们也一再强调，ElasticSearch内部用Apache Lucene实现索引中数据的读写。读者应该清楚的是：在ElasticSearch中被视为单独的一个索引(index)，在Lucene中可能不止一个。这是因为在分布式体系中，ElasticSearch会用到分片(shards)和备份(replicas)机制将一个索引(index)存储多份。</p><h4 id=文档document>文档(Document)</h4><p>在ElasticSearch的世界中，文档(Document)是主要的存在实体(在Lucene中也是如此)。所有的ElasticSearch应用需求到最后都可以统一建模成一个检索模型：检索相关文档。文档(Document)由一个或者多个域(Field)组成，每个域(Field)由一个域名(此域名非彼域名)和一个或者多个值组成(有多个值的值称为多值域(multi-valued))。在ElasticSeach中，每个文档(Document)都可能会有不同的域(Field)集合；也就是说文档(Document)是没有固定的模式和统一的结构。文档(Document)之间保持结构的相似性即可(Lucene中的文档(Document)也秉持着相同的规定)。实际上，ElasticSearch中的文档(Document)就是Lucene中的文档(Document)。从客户端的角度来看，文档(Document)就是一个JSON对象(关于JSON格式的相关信息,请参看hhtp://en.wikipedia.org/wiki/JSON)。</p><h4 id=参数映射mapping>参数映射(Mapping)</h4><p>所有的文档(Document)在存储之前都必须经过分析(analyze)流程。用户可以配置输入文本分解成Token的方式；哪些Token应该被过滤掉；或者其它的的处理流程，比如去除HTML标签。此外，ElasticSearch提供的各种特性，比如排序的相关信息。保存上述的配置信息，这就是参数映射(Mapping)在ElasticSearch中扮演的角色。尽管ElasticSearch可以根据域的值自动识别域的类型(field type)，在生产应用中，都是需要自己配置这些信息以避免一些奇的问题发生。要保证应用的可控性。</p><h4 id=文档类型type>文档类型(Type)</h4><p>每个文档在ElasticSearch中都必须设定它的类型。文档类型使得同一个索引中在存储结构不同文档时，只需要依据文档类型就可以找到对应的参数映射(Mapping)信息，方便文档的存取。</p><h3 id=es和关系型数据库的比较>ES和关系型数据库的比较</h3><p>一个ES集群可以包含多个索引（数据库），每个索引又包含了很多类型（表），类型中包含了很多文档（行），每个文档使用 JSON 格式存储数据，包含了很多字段（列）。</p><table><thead><tr><th style=text-align:left>关系型数据库</th><th>数据库</th><th>表</th><th>行</th><th>列</th></tr></thead><tbody><tr><td style=text-align:left>ElasticSearch</td><td>索引(index)</td><td>类型(Types)</td><td>文档(Documents)</td><td>字段(Fields)</td></tr></tbody></table></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list"><a class=text-white target=_blank rel="noopener noreferrer" href=https://groups.google.com/u/1/g/ljbmxsm><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=个人掘金主页 aria-label=个人掘金主页><a class=text-white target=_blank rel="noopener noreferrer" href=https://juejin.cn/user/1151943918492855><i class="fab fa-twitter"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/mxsm><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2022 The Docsy Authors All Rights Reserved</small>
<small class=ml-1><a href=https://policies.google.com/privacy target=_blank>隐私政策</a></small><p class=mt-2><a href=/about/>Home</a></p></div></div></div></footer><div><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css><script src=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js></script><script>$("p img").wrap(function(){return'<a data-fancybox="gallery" href="'+$(this).attr('src')+'"></a>'})</script></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/mermaid@8.8.1/dist/mermaid.min.js integrity=sha384-to2w0I1OqmbJ9J6yTnIX+KYU8grNpZoD1dKPLjgEJvMe5L5+/7qvuNa2sQo8WAWj crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/raphael/2.3.0/raphael.min.js integrity="sha512-tBzZQxySO5q5lqwLWfu8Q+o4VkTcRGOeQGVQ0ueJga4A1RKuzmAu5HXDOXLEjpbKyV7ow9ympVoa6wZLEzRzDg==" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.15.0/flowchart.min.js integrity="sha512-6QsSiIybtf8tuZ6xfjRTr2tdtw3Gp4q5RSCh2b6q9seoKEQmhAG1RrCA8F0kXTwivVxRVbp/YF3zOh8rvEAU7Q==" crossorigin=anonymous></script><script src=/js/main.min.b541b310f01941a0abfd76b652b5fb60dac470573775bb5b31ff08fe3f6cea51.js integrity="sha256-tUGzEPAZQaCr/Xa2UrX7YNrEcFc3dbtbMf8I/j9s6lE=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.js></script><script type=text/javascript>docsearch({appId:'JO2SY3WDAC',apiKey:'324ddb3b679c1308e5aa8bf222e07f8b',indexName:'mxsm',inputSelector:'.td-search-input',debug:!1})</script></body></html>